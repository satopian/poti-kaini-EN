!function(){function e(e,t,i,n){Object.defineProperty(e,t,{get:i,set:n,enumerable:!0,configurable:!0})}function t(e){return e&&e.__esModule?e.default:e}function i(e){if(e=o.i?.[e]||e,!n)try{throw Error()}catch(i){var t=(""+i.stack).match(/(https?|file|ftp|(chrome|moz|safari-web)-extension):\/\/[^)\n]+/g);if(!t)return r+e;n=t[0]}return new URL(r+e,n).toString()}var n,r="./",o=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire94c2,s=o.register;s("6NgYC",function(t,i){e(t.exports,"Embed",function(){return v});var n=o("1LaJZ"),r=o("cx0mh"),s=o("7h4XF"),a=o("cL71g"),l=o("4EWN2"),h=o("2gUX3");o("15wZT");var c=o("3C7jC"),u=o("941rU"),p=o("1mH1z"),d=o("iVf04"),g=o("hAS38"),f=o("7jh4K"),v=function(){"use strict";function e(t){var i=this;(0,r._)(this,e),this.p=t,this.isInitialized=!1,this.psdQueue=[],this.openProject=function(e){i.onProjectReady(e)},this.loadingScreenEl=document.getElementById("loading-screen"),this.loadingScreenTextEl=document.getElementById("loading-screen-text"),this.loadingScreenTextEl&&(this.loadingScreenTextEl.textContent=(0,p.LANG)("embed-init-waiting")),t.disableAutoFit&&(g.KL_CONFIG.disableAutoFit=!0),t.project&&this.onProjectReady(t.project)}return(0,s._)(e,[{key:"onProjectReady",value:function(e){try{if(this.isInitialized)throw Error("Already called openProject");this.isInitialized=!0;var t,i,n=(0,l._)((0,a._)({},e),{projectId:null!=(i=e.projectId)?i:(0,f.randomUuid)()});this.klApp=new(0,c.KlApp)({project:n,bottomBar:this.p.bottomBar,aboutEl:this.p.aboutEl,embed:{url:this.p.embedUrl,enableImageDropperImport:!!this.p.enableImageDropperImport,onSubmit:this.p.onSubmit}}),null==(t=this.loadingScreenEl)||t.remove(),this.loadingScreenEl=null,this.loadingScreenTextEl=null,document.body.append(this.klApp.getElement())}catch(e){this.loadingScreenTextEl&&(this.loadingScreenTextEl.textContent="❌ "+e),this.loadingScreenEl&&(this.loadingScreenEl.className+="loading-screen-error"),console.error(e)}}},{key:"initError",value:function(e){this.loadingScreenTextEl&&(this.loadingScreenTextEl.textContent="❌ "+e),this.loadingScreenEl&&(this.loadingScreenEl.className+="loading-screen-error")}},{key:"getPNG",value:function(){return(0,n._)(function(){return(0,h.__generator)(this,function(e){switch(e.label){case 0:if(!this.klApp)throw Error("App not initialized");return[4,this.klApp.getPNG()];case 1:return[2,e.sent()]}})}).call(this)}},{key:"getPSD",value:function(){return(0,n._)(function(){return(0,h.__generator)(this,function(e){switch(e.label){case 0:if(!this.klApp)throw Error("App not initialized");return[4,this.klApp.getPSD()];case 1:return[2,e.sent()]}})}).call(this)}},{key:"readPSDs",value:function(e){var t=this;if(0!==e.length){var i=function(e){try{var i=t.agPsd.readPsd(e.blob),n=(0,u.klPsdToKlProject)((0,u.readPsd)(i));e.callback(n)}catch(t){console.error("failed to read psd",t),e.callback(null)}};this.agPsd?e.forEach(i):(0===this.psdQueue.length&&(0,n._)(function(){var e;return(0,h.__generator)(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),e=this,[4,(0,d.loadAgPsd)()];case 1:return e.agPsd=t.sent(),[3,3];case 2:return t.sent(),this.agPsd="error",[3,3];case 3:for(;this.psdQueue.length;)i(this.psdQueue.shift());return[2]}})}).call(t),e.forEach(function(e){t.psdQueue.push(e)}))}}}]),e}()}),s("15wZT",function(e,t){var i=o("8N5YG"),n=o("bX4ja");if(o("k3KW8"),"scrollTo"in Element.prototype||Object.defineProperty(Element.prototype,"scrollTo",{value:function(e,t){this.scrollLeft=e,this.scrollTop=t}}),"scrollBy"in Element.prototype||Object.defineProperty(Element.prototype,"scrollBy",{value:function(e,t){this.scrollLeft+=e,this.scrollTop+=t}}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function e(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];var r=isNaN(i[0])?1:Number(i[0]);return r?Array.prototype.reduce.call(this,function(t,i){return Array.isArray(i)?t.push.apply(t,e.call(i,r-1)):t.push(i),t},[]):Array.prototype.slice.call(this)},writable:!0}),Array.prototype.flatMap||Object.defineProperty(Array.prototype,"flatMap",{configurable:!0,writable:!0,value:function(e,t){if("function"!=typeof e)throw TypeError(e+" is not a function");for(var i=[],r=0;r<this.length;r++)if(r in this){var o=e.call(t,this[r],r,this);Array.isArray(o)?i.push.apply(i,(0,n._)(o)):i.push(o)}return i}}),String.prototype.replaceAll||Object.defineProperty(String.prototype,"replaceAll",{value:function(e,t){if("function"==typeof t)throw Error("replaceAll polyfill does not support replaceValue: function");return this.replace(RegExp(e,"g"),t)}}),"at"in Array.prototype||Object.defineProperty(Array.prototype,"at",{value:function(e){return e>0?this[e]:e<0?this[e+this.length]:void 0}}),Object.fromEntries||Object.defineProperty(Object,"fromEntries",{value(e){if(!e||!e[Symbol.iterator])throw Error("Object.fromEntries() requires a single iterable argument");var t={};return Object.keys(e).forEach(function(n){var r=(0,i._)(e[n],2),o=r[0],s=r[1];t[o]=s}),t}}),!("localStorage"in window))try{window.localStorage={getItem:function(){return null},setItem:function(){},removeItem:function(){}}}catch(e){}}),s("k3KW8",function(e,t){o("5dg4B"),o("izcMZ"),o("iD0Yt"),o("fIU0v")}),s("5dg4B",function(e,t){function i(){var e=Array.prototype.slice.call(arguments),t=document.createDocumentFragment();e.forEach(function(e){var i=e instanceof Node;t.appendChild(i?e:document.createTextNode(String(e)))}),this.appendChild(t)}[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach(function(e){e.hasOwnProperty("append")||Object.defineProperty(e,"append",{configurable:!0,enumerable:!0,writable:!0,value:i})})}),s("izcMZ",function(e,t){function i(){var e=Array.prototype.slice.call(arguments),t=document.createDocumentFragment();e.forEach(function(e){var i=e instanceof Node;t.appendChild(i?e:document.createTextNode(String(e)))}),this.insertBefore(t,this.firstChild)}[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach(function(e){e.hasOwnProperty("prepend")||Object.defineProperty(e,"prepend",{configurable:!0,enumerable:!0,writable:!0,value:i})})}),s("iD0Yt",function(e,t){String.prototype.padStart||(String.prototype.padStart=function(e,t){return e>>=0,t=String(t||" "),this.length>e?String(this):((e-=this.length)>t.length&&(t+=t.repeat(e/t.length)),t.slice(0,e)+String(this))})}),s("fIU0v",function(e,t){Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(e){if(null==this)throw TypeError('"this" is null or not defined');var t=Object(this),i=t.length>>>0;if("function"!=typeof e)throw TypeError("predicate must be a function");for(var n=arguments[1],r=0;r<i;){var o=t[r];if(e.call(n,o,r,t))return r;r++}return -1}})}),s("3C7jC",function(i,n){e(i.exports,"KlApp",function(){return ex});var r=o("1LaJZ"),s=o("cx0mh"),a=o("7h4XF"),l=o("cL71g"),h=o("4EWN2"),c=o("8N5YG"),u=o("bX4ja"),p=o("2gUX3"),d=o("hrnUX"),g=o("eWjiX"),f=o("h62LS"),v=o("jmL5A"),m=o("iUR3L"),y=o("3WOmu"),x=o("6mTnI"),b=o("5ngYX"),w=o("1mH1z"),B=o("6l0gQ"),k=o("iuTWx"),S=o("57YJz"),C=o("aId1u"),E=o("4hRms"),L=o("249G2"),I=o("kgQ1R"),T=o("M2Apn"),A=o("6hU8m"),M=o("aCkKZ"),R=o("ewCAh"),_=o("fRiur"),P=o("3yTCU"),D=o("4C8mG"),N=o("dvw1S"),O=o("qur3y"),G=o("hAS38"),H=o("8I3X7"),z=o("8TwnO"),j=o("8AUlO"),F=o("iXbuc"),V=o("63yUO"),U=o("4tNj6"),W=o("gAXzN"),X=o("9Q2gk"),K=o("15tXE"),Y=o("2jK1Y"),Z=o("3hiBf"),q=o("6dnxC"),$=o("kwvlO"),Q=o("age0w"),J=o("bB2ML"),ee=o("7JyFK"),et=o("c3rQS"),ei=o("gWfkn"),en=o("kuhHU"),er=o("92HSb"),eo=o("iYSxo"),es=o("eIcQa"),ea=o("dFQnh"),el=o("fohxs"),eh=o("aSJRf"),ec=o("7jh4K"),eu=o("49CPm"),ep=o("jTg9g"),ed=o("2MaaK"),eg=o("eM5pt"),ef=o("grPaH"),ev=o("3uJxV"),em=o("cFF2R"),ey=o("9b3eo");(0,m.importFilters)();var ex=function(){"use strict";function e(i){var n,o,a,m,es,ex,eb,ew=this,eB=this;(0,s._)(this,e),this.collapseThreshold=820,this.toolWidth=271,this.lastSavedHistoryIndex=0,this.getPSD=function(){return(0,r._)(function(){return(0,p.__generator)(this,function(e){switch(e.label){case 0:return[4,(0,y.klCanvasToPsdBlob)(this.klCanvas)];case 1:return[2,e.sent()]}})}).call(ew)},this.embed=i.embed;var ek=Math.min(4096,Math.max(2048,Math.max(window.screen.width,window.screen.height)));this.uiLayout=this.embed?"left":B.LocalStorage.getItem("uiState")?B.LocalStorage.getItem("uiState"):"right";var eS=ep.KL_INDEXED_DB.getIsAvailable()?new(0,x.ProjectStore):void 0;this.rootEl=g.BB.el({className:"g-root",css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}}),this.uiWidth=Math.max(0,window.innerWidth),this.uiHeight=Math.max(0,window.innerHeight);var eC="png",eE=Math.max(10,Math.min(ek,window.innerWidth<this.collapseThreshold?this.uiWidth:this.uiWidth-this.toolWidth)),eL=Math.max(10,Math.min(ek,this.uiHeight));this.klHistory=new(0,ei.KlHistory)({oldest:(0,ea.projectToComposed)(null!=(o=i.project)?o:{projectId:(0,ec.randomUuid)(),width:eE,height:eL,layers:[{name:(0,w.LANG)("layers-layer")+" 1",opacity:1,isVisible:!0,mixModeStr:"source-over",image:{fill:g.BB.ColorConverter.toRgbStr({r:el.ERASE_COLOR,g:el.ERASE_COLOR,b:el.ERASE_COLOR})}}]})});var eI=i.klRecoveryManager;eI&&(eI.setKlHistory(this.klHistory),eI.setGetThumbnail(function(e){return(0,eh.drawProject)(ew.klCanvas.getProject(),e)})),i.project&&i.project.layers.forEach(function(e){e.image instanceof HTMLCanvasElement&&g.BB.freeCanvas(e.image),e.image=null}),this.klCanvas=new d.KL.KlCanvas(this.klHistory,this.embed?-1:1);var eT=new(0,Q.KlTempHistory),eA=void 0,eM=function(e,t){ez();var i=e_.index;ew.klCanvas.eraseLayer({layerIndex:i,useAlphaLock:0===i&&!e$.eraserBrush.getIsTransparentBg(),useSelection:!t}),e&&ew.statusOverlay.out(ew.klCanvas.getSelection()?(0,w.LANG)("cleared-selected-area"):(0,w.LANG)("cleared-layer"),!0)},eR=new g.BB.RGB(0,0,0),e_=this.klCanvas.getLayer(this.klCanvas.getLayerCount()-1),eP=function(){if("eraserBrush"===m)return es;var e=Object.keys(e$).filter(function(e){return"eraserBrush"!==e}),t=e.findIndex(function(e){return e===m});return e[(t+1)%e.length]},eD=function(e){eN.emitSize(e),ew.easelBrush&&ew.easelBrush.setBrush({radius:e})},eN=new d.KL.BrushSettingService({onSetColor:function(e){ew.klColorSlider.setColor(e),a.setColor(e),ew.mobileColorUi.setColor(e),eR=g.BB.copyObj(e)},onSetSize:function(e){a.setSize(e),ew.easelBrush.setBrush({radius:e})},onSetOpacity:function(e){a.setOpacity(e)},onSetScatter:function(e){a.setScatter(e)},onGetColor:function(){return ew.klColorSlider.getColor()},onGetSize:function(){return e$[m].getSize()},onGetOpacity:function(){return e$[m].getOpacity()},onGetScatter:function(){return e$[m].getScatter()},onGetSliderConfig:function(){return{sizeSlider:d.KL.BRUSHES_UI[m].sizeSlider,opacitySlider:d.KL.BRUSHES_UI[m].opacitySlider,scatterSlider:d.KL.BRUSHES_UI[m].scatterSlider}}}),eO=new(0,k.LineSmoothing)({smoothing:(0,C.translateSmoothing)(1)});this.lineSanitizer=new(0,S.LineSanitizer);var eG=new g.BB.EventChain({chainArr:[this.lineSanitizer,eO]});eG.setChainOut(function(e){"down"===e.type&&(ew.toolspace.style.pointerEvents="none",a.startLine(e.x,e.y,e.pressure),ew.easelBrush.setLastDrawEvent({x:e.x,y:e.y}),ew.easel.requestRender()),"move"===e.type&&(a.goLine(e.x,e.y,e.pressure,e.isCoalesced),ew.easelBrush.setLastDrawEvent({x:e.x,y:e.y}),ew.easel.requestRender()),"up"===e.type&&(ew.toolspace.style.pointerEvents="",a.endLine(),ew.easel.requestRender()),"line"===e.type&&(a.getBrush().drawLineSegment(e.x0,e.y0,e.x1,e.y1),ew.easelBrush.setLastDrawEvent({x:e.x1,y:e.y1}),ew.easel.requestRender())});var eH={size:20,align:"left",isBold:!1,isItalic:!1,font:"sans-serif",letterSpacing:0,lineHeight:1,fill:{color:{r:0,g:0,b:0,a:1}}},ez=function(){var e=!1;return"select"===ew.easel.getTool()&&(e=eW.commitTransform()),e},ej=function(){return"select"===ew.easel.getTool()&&eW.discardTransform()},eF=function(e,t){if(["undo","redo"].includes(e)){var i=ew.klHistory.getComposed();ew.klCanvas.updateViaComposed(t,i),eJ(ew.klCanvas.getLayer(i.layerMap[i.activeLayerId].index)),ew.easelProjectUpdater.update(),(t.size.width!==i.size.width||t.size.height!==i.size.height)&&ew.easel.resetOrFitTransform(!0),ew.easelBrush.setLastDrawEvent(),ew.layersUi.update(e_.index)}eW.onHistory(e)},eV=function(e){eT.canDecreaseIndex()||ej();var t=ew.klHistory.getComposed(),i=ti.undo();i&&(eF(i.type,t),e&&ew.statusOverlay.out((0,w.LANG)("undo"),!0))},eU=function(e){var t=ew.klHistory.getComposed(),i=ti.redo();i&&(eF(i.type,t),e&&ew.statusOverlay.out((0,w.LANG)("redo"),!0))};this.statusOverlay=new d.KL.StatusOverlay;var eW=new(0,$.KlAppSelect)({klCanvas:this.klCanvas,getCurrentLayerCtx:function(){return e_.context},onUpdateProject:function(){return ew.easelProjectUpdater.update()},klHistory:this.klHistory,tempHistory:eT,statusOverlay:this.statusOverlay,onFill:function(){ew.klCanvas.layerFill(e_.index,ew.klColorSlider.getColor(),void 0,!0),ew.statusOverlay.out(ew.klCanvas.getSelection()?(0,w.LANG)("filled-selected-area"):(0,w.LANG)("filled"),!0)},onErase:function(){var e=e_.index;ew.klCanvas.eraseLayer({layerIndex:e,useAlphaLock:0===e&&!e$.eraserBrush.getIsTransparentBg(),useSelection:!0}),ew.statusOverlay.out(ew.klCanvas.getSelection()?(0,w.LANG)("cleared-selected-area"):(0,w.LANG)("cleared-layer"),!0)}});this.easelBrush=new(0,j.EaselBrush)({radius:5,onLineStart:function(e){eG.chainIn({type:"down",scale:ew.easel.getTransform().scale,shiftIsPressed:eq.isPressed("shift"),pressure:e.pressure,isCoalesced:e.isCoalesced,x:e.x,y:e.y})},onLineGo:function(e){eG.chainIn({type:"move",scale:ew.easel.getTransform().scale,shiftIsPressed:eq.isPressed("shift"),pressure:e.pressure,isCoalesced:e.isCoalesced,x:e.x,y:e.y})},onLineEnd:function(){eG.chainIn({type:"up",scale:ew.easel.getTransform().scale,shiftIsPressed:eq.isPressed("shift"),isCoalesced:!1})},onLine:function(e,t){eG.chainIn({type:"line",x0:e.x,y0:e.y,x1:t.x,y1:t.y,pressure0:1,pressure1:1})}});var eX=new(0,z.EaselHand)({}),eK=new(0,Y.EaselShape)({onDown:function(e,t){te.onDown(e.x,e.y,t)},onMove:function(e){te.onMove(e.x,e.y)},onUp:function(e){te.onUp(e.x,e.y)}}),eY=!0;this.easel=new(0,H.Easel)({width:Math.max(0,this.uiWidth-this.toolWidth),height:this.uiHeight,project:{width:this.klCanvas.getWidth(),height:this.klCanvas.getHeight(),layers:[]},tools:{brush:this.easelBrush,hand:eX,select:eW.getEaselSelect(),eyedropper:new(0,U.EaselEyedropper)({onPick:function(e){var t=ew.klCanvas.getColorAt(e.x,e.y);return eN.setColor(t),t},onPickEnd:function(){(ew.klColorSlider.getIsEyedropping()||ew.mobileColorUi.getIsEyedropping())&&(ew.klColorSlider.setIsEyedropping(!1),ew.mobileColorUi.setIsEyedropping(!1),ew.easel.setTool(ew.toolspaceToolRow.getActive()))}}),paintBucket:new(0,W.EaselPaintBucket)({onFill:function(e){ew.klCanvas.floodFill(e_.index,e.x,e.y,e4.getIsEraser()?null:ew.klColorSlider.getColor(),e4.getOpacity(),e4.getTolerance(),e4.getSample(),e4.getGrow(),e4.getContiguous()),ew.easel.requestRender()}}),gradient:new(0,X.EaselGradient)({onDown:function(e,t){e6.onDown(e.x,e.y,t)},onMove:function(e){e6.onMove(e.x,e.y)},onUp:function(e){e6.onUp(e.x,e.y)}}),text:new(0,K.EaselText)({onDown:function(e,t){d.KL.DIALOG_COUNTER.get()>0||d.KL.textToolDialog({klCanvas:ew.klCanvas,layerIndex:e_.index,primaryColor:ew.klColorSlider.getColor(),secondaryColor:ew.klColorSlider.getSecondaryRGB(),text:(0,h._)((0,l._)({},eH),{text:"",x:e.x,y:e.y,angleRad:t,fill:eH.fill?{color:(0,h._)((0,l._)({},ew.klColorSlider.getColor()),{a:eH.fill.color.a})}:void 0,stroke:eH.stroke?(0,h._)((0,l._)({},eH.stroke),{color:(0,h._)((0,l._)({},ew.klColorSlider.getSecondaryRGB()),{a:eH.stroke.color.a})}):void 0}),onConfirm:function(e){eH=(0,h._)((0,l._)({},e),{text:""}),ew.klCanvas.text(e_.index,e)}})}}),shape:eK,rotate:new(0,Z.EaselRotate)({}),zoom:new(0,q.EaselZoom)({})},tool:"brush",onChangeTool:function(e){ew.mobileBrushUi.setIsVisible("brush"===e),ew.mobileColorUi.setIsVisible("select"!==e)},onTransformChange:function(e,t){e5.update(e.scale,e.angleDeg),ew.toolspaceToolRow.setEnableZoomIn(e.scale!==ee.EASEL_MAX_SCALE),ew.toolspaceToolRow.setEnableZoomOut(e.scale!==ee.EASEL_MIN_SCALE),t&&!eY&&ew.statusOverlay.out({type:"transform",scale:e.scale,angleDeg:e.angleDeg}),eY&&(eY=!1)},onUndo:function(){eV(!0)},onRedo:function(){eU(!0)}}),(0,ec.css)(this.easel.getElement(),{position:"absolute",left:"0",top:"0"}),this.easelProjectUpdater=new(0,F.EaselProjectUpdater)({klCanvas:this.klCanvas,easel:this.easel}),this.klHistory.addListener(function(){ew.easelProjectUpdater.update()}),d.KL.DIALOG_COUNTER.subscribe(function(e){ew.easel.setIsFrozen(e>0)});var eZ=function(){if(eA)for(var e=ew.toolspaceToolRow.getActive(),t=eA.getOpenedTabId(),i=["brush","hand","paintBucket","gradient","text","shape","select"],n=0;n<i.length;n++)e===i[n]?eA.setIsVisible(i[n],!0):(eA.setIsVisible(i[n],!1),t===i[n]&&eA.open(e))},eq=new g.BB.KeyListener({onDown:function(e,t,i){if(!(d.KL.DIALOG_COUNTER.get()>0||g.BB.isInputFocused(!0))&&!(ew.lineSanitizer.getIsDrawing()||ew.easel.getIsLocked())){if("home"===i&&ew.easel.fitTransform(),"end"===i&&ew.easel.resetTransform(),["ctrl+z","cmd+z"].includes(i)&&(t.preventDefault(),eV()),(["ctrl+y","cmd+y"].includes(i)||(g.BB.sameKeys("ctrl+shift+z",i)||g.BB.sameKeys("cmd+shift+z",i))&&"z"===e)&&(t.preventDefault(),eU()),!ew.embed&&(["ctrl+s","cmd+s"].includes(i)&&(t.preventDefault(),ez(),ew.saveToComputer.save()),["ctrl+shift+s","cmd+shift+s"].includes(i)&&(t.preventDefault(),ez(),eS?(0,r._)(function(){var e,t,i,n;return(0,p.__generator)(this,function(o){switch(o.label){case 0:return[4,(0,ef.requestPersistentStorage)()];case 1:if(o.sent(),e=eS.getCurrentMeta(),t=this.getProject(),!(e&&e.projectId!==t.projectId))return[3,3];return[4,new Promise(function(e,t){(0,ed.showModal)({target:document.body,type:"warning",message:(0,w.LANG)("file-storage-overwrite-confirm"),buttons:[(0,w.LANG)("file-storage-overwrite"),"Cancel"],callback:function(t){return(0,r._)(function(){return(0,p.__generator)(this,function(i){return"Cancel"===t?e(!1):e(!0),[2]})})()}})})];case 2:if(!o.sent())return[2];o.label=3;case 3:i=!0,o.label=4;case 4:return o.trys.push([4,6,,7]),[4,eS.store(this.klCanvas.getProject())];case 5:return o.sent(),[3,7];case 6:return n=o.sent(),i=!1,setTimeout(function(){throw Error("keyboard-shortcut: failed to store browser storage, "+n)},0),this.statusOverlay.out("❌ "+(0,w.LANG)("file-storage-failed"),!0),[3,7];case 7:return i&&(this.updateLastSaved(),this.statusOverlay.out((0,w.LANG)("file-storage-stored"),!0)),[2]}})}).call(ew):ew.statusOverlay.out("❌ "+(0,w.LANG)("file-storage-failed"),!0)),["ctrl+c","cmd+c"].includes(i)&&(t.preventDefault(),ez(),to(!0))),["ctrl+a","cmd+a"].includes(i)&&t.preventDefault(),"sqbr_open"===i&&a.decreaseSize(Math.max(.005,.03/ew.easel.getTransform().scale)),"sqbr_close"===i&&a.increaseSize(Math.max(.005,.03/ew.easel.getTransform().scale)),"enter"!==i||ez()||(ew.klCanvas.layerFill(e_.index,ew.klColorSlider.getColor(),void 0,!0),ew.statusOverlay.out(ew.klCanvas.getSelection()?(0,w.LANG)("filled-selected-area"):(0,w.LANG)("filled"),!0)),"esc"===i&&ej()&&t.preventDefault(),["delete","backspace"].includes(i)&&eM(!0),"shift+e"===i?(t.preventDefault(),null==(n=a.toggleEraser)||n.call(a)):"e"===i&&(t.preventDefault(),ez(),ew.easel.setTool("brush"),ew.toolspaceToolRow.setActive("brush"),null==eA||eA.open("brush"),eZ(),e3.open("eraserBrush")),"b"===i){t.preventDefault(),ez();var n,o=ew.easel.getTool();ew.easel.setTool("brush"),ew.toolspaceToolRow.setActive("brush"),null==eA||eA.open("brush"),eZ(),e3.open("brush"===o?eP():m)}if("g"===i){t.preventDefault(),ez();var s="paintBucket"===ew.easel.getTool()?"gradient":"paintBucket";ew.easel.setTool(s),ew.toolspaceToolRow.setActive(s),null==eA||eA.open(s),eZ()}"t"===i&&(t.preventDefault(),ez(),ew.easel.setTool("text"),ew.toolspaceToolRow.setActive("text"),null==eA||eA.open("text"),eZ()),"u"===i&&(t.preventDefault(),ez(),ew.easel.setTool("shape"),ew.toolspaceToolRow.setActive("shape"),null==eA||eA.open("shape"),eZ()),"l"===i&&(t.preventDefault(),ez(),ew.easel.setTool("select"),ew.toolspaceToolRow.setActive("select"),null==eA||eA.open("select"),eZ()),"x"===i&&(t.preventDefault(),ew.klColorSlider.swapColors())}},onUp:function(e,t){}}),e$={};Object.entries(d.KL.BRUSHES_UI).forEach(function(e){var t=(0,c._)(e,2),i=t[0],n=new t[1].Ui({klHistory:ew.klHistory,onSizeChange:eD,onScatterChange:function(e){eN.emitScatter(e)},onOpacityChange:function(e){eN.emitOpacity(e)},onConfigChange:function(){eN.emitSliderConfig({sizeSlider:d.KL.BRUSHES_UI[m].sizeSlider,opacitySlider:d.KL.BRUSHES_UI[m].opacitySlider,scatterSlider:d.KL.BRUSHES_UI[m].scatterSlider})}});e$[i]=n,n.getElement().style.padding="10px"}),this.toolspace=g.BB.el({className:"kl-toolspace",css:{position:"absolute",right:"0",top:"0",bottom:"0",width:this.toolWidth+"px",overflow:"hidden",userSelect:"none",touchAction:"none"}}),this.toolspaceInner=g.BB.el({parent:this.toolspace}),this.toolspace.oncontextmenu=function(){return!1},this.toolspace.onclick=g.BB.handleClick,this.mobileBrushUi=new(0,eo.MobileBrushUi)({onBrush:function(){e3.open(es)},onEraser:function(){e3.open("eraserBrush")}}),this.mobileColorUi=new(0,em.MobileColorUi)({onEyedropper:function(e){e?(ew.klColorSlider.setIsEyedropping(!0),ew.easel.setTool("eyedropper")):(ew.klColorSlider.setIsEyedropping(!1),ew.easel.setTool(ew.toolspaceToolRow.getActive()))},color:eR,onColorChange:function(e){eN.setColor(e)}}),this.mobileUi=new(0,er.MobileUi)({onShowToolspace:function(e){ew.mobileColorUi.closeColorPicker(),ew.updateCollapse()},toolUis:[this.mobileBrushUi.getElement(),this.mobileColorUi.getElement()]}),this.updateCollapse(!0),setTimeout(function(){ex=new d.KL.OverlayToolspace({enabledTest:function(){return 0===d.KL.DIALOG_COUNTER.get()&&!ew.easel.getIsLocked()},brushSettingService:eN}),ew.rootEl.append(ex.getElement())},0),g.BB.append(this.rootEl,[this.easel.getElement(),this.toolspace,this.mobileUi.getElement()]),(eb=this.embed?new(0,v.EmbedToolspaceTopRow)({onHelp:function(){(0,f.showIframeModal)(ew.embed.url+"/help.html",!!ew.embed)},onSubmit:function(){ez();var e=function(){var e,t=g.BB.el({tagName:"button",textContent:(0,w.LANG)("save-reminder-save-psd"),css:{display:"block"}});t.onclick=function(){ew.saveAsPsd(),e()},d.KL.popup({target:ew.rootEl,message:"<b>"+(0,w.LANG)("upload-failed")+"</b>",div:g.BB.el({content:[g.BB.el({content:(0,w.LANG)("backup-drawing"),css:{marginBottom:"10px"}}),t]}),ignoreBackground:!0,closeFunc:function(t){e=t}})};d.KL.popup({target:ew.rootEl,message:(0,w.LANG)("submit-prompt"),buttons:[(0,w.LANG)("submit"),"Cancel"],callback:function(t){return(0,r._)(function(){var i,n;return(0,p.__generator)(this,function(r){return i=this,t!==(0,w.LANG)("submit")||(n=g.BB.el({parent:this.rootEl,className:"upload-overlay",content:'<div class="spinner"></div> '+(0,w.LANG)("submit-submitting")}),this.embed.onSubmit(function(){i.updateLastSaved(),n.remove()},function(){n.remove(),e()})),[2]})}).call(ew)}})},onLeftRight:function(){ew.uiLayout="left"===ew.uiLayout?"right":"left",ew.updateUi()}}):new d.KL.ToolspaceTopRow({logoImg:i.logoImg,onLogo:function(){(0,f.showIframeModal)("./home/",!!ew.embed)},onNew:function(){tn()},onImport:function(){ta.triggerImport()},onSave:function(){ew.saveToComputer.save()},onShare:function(){tr()},onHelp:function(){(0,f.showIframeModal)("./help/",!!ew.embed)}})).getElement().style.marginBottom="10px",this.toolspaceInner.append(eb.getElement()),this.toolspaceToolRow=new d.KL.ToolspaceToolRow({onActivate:function(e){if("hand"!==e&&ez(),"brush"===e)ew.easel.setTool("brush");else if("hand"===e)ew.easel.setTool("hand");else if("paintBucket"===e)ew.easel.setTool("paintBucket");else if("gradient"===e)ew.easel.setTool("gradient");else if("text"===e)ew.easel.setTool("text");else if("shape"===e)ew.easel.setTool("shape");else if("select"===e)ew.easel.setTool("select");else throw Error("unknown activeStr");null==eA||eA.open(e),eZ(),ew.klColorSlider.setIsEyedropping(!1),ew.mobileColorUi.setIsEyedropping(!1)},onZoomIn:function(){var e=ew.easel.getTransform().scale,t=(0,V.zoomByStep)(e,eq.isPressed("shift")?1/8:.5);ew.easel.scale(t/e)},onZoomOut:function(){var e=ew.easel.getTransform().scale,t=(0,V.zoomByStep)(e,eq.isPressed("shift")?-1/8:-.5);ew.easel.scale(t/e)},onUndo:function(){eV()},onRedo:function(){eU()}}),this.toolspaceToolRow.setIsSmall(this.uiHeight<540),this.toolspaceInner.append(this.toolspaceToolRow.getElement()),this.klColorSlider=new d.KL.KlColorSlider({width:250,height:30,svHeight:100,startValue:new g.BB.RGB(0,0,0),onPick:function(e){eR=e,a.setColor(e),eN.emitColor(e),ew.mobileColorUi.setColor(e),ew.klColorSlider.setIsEyedropping(!1),ew.mobileColorUi.setIsEyedropping(!1)},onEyedropper:function(e){e?(ew.mobileColorUi.setIsEyedropping(!0),ew.easel.setTool("eyedropper")):(ew.mobileColorUi.setIsEyedropping(!1),ew.easel.setTool(ew.toolspaceToolRow.getActive()))}}),this.klColorSlider.setHeight(Math.max(163,Math.min(400,this.uiHeight-505)));var eQ=function(e){"eraserBrush"!==e&&(es=e),ew.klColorSlider&&("eraserBrush"===e?ew.klColorSlider.enable(!1):ew.klColorSlider.enable(!0)),m=e,(a=e$[e]).setColor(eR),a.setLayer(e_),ew.easelBrush.setBrush({type:"pixelBrush"===m?"pixel-square":"round"}),ew.toolspaceToolRow.setActive("brush"),eZ()},eJ=function(e){e_=e,a.setLayer(e_),ew.layerPreview.setLayer(e_)},e0=g.BB.el(),e1=g.BB.el({css:{margin:"10px",display:"flex",flexWrap:"wrap",justifyContent:"space-between",alignItems:"flex-end"}}),e2=new d.KL.ToolspaceStabilizerRow({smoothing:1,onSelect:function(e){eO.setSmoothing((0,C.translateSmoothing)(e))}});e0.append(e1),g.BB.append(e1,[this.klColorSlider.getElement(),this.klColorSlider.getOutputElement(),e2.getElement()]);var e3=new d.KL.TabRow({initialId:"penBrush",useAccent:!0,tabArr:function(){for(var e=[],t=function(e){return{id:e,image:d.KL.BRUSHES_UI[e].image,title:d.KL.BRUSHES_UI[e].tooltip,onOpen:function(){e$[e].getElement().style.display="block",eQ(e),ew.klColorSlider.setIsEyedropping(!1),ew.mobileColorUi.setIsEyedropping(!1),eN.emitSliderConfig({sizeSlider:d.KL.BRUSHES_UI[e].sizeSlider,opacitySlider:d.KL.BRUSHES_UI[e].opacitySlider,scatterSlider:d.KL.BRUSHES_UI[e].scatterSlider}),eD(e$[e].getSize()),eN.emitOpacity(e$[e].getOpacity()),ew.mobileBrushUi.setType("eraserBrush"===e?"eraser":"brush")},onClose:function(){e$[e].getElement().style.display="none"}}},i=Object.keys(e$),n=0;n<i.length;n++)e.push(t(i[n]));return e}()});g.BB.append(e0,[e3.getElement()].concat((0,u._)(Object.entries(d.KL.BRUSHES_UI).map(function(e){return e$[(0,c._)(e,1)[0]].getElement()}))));var e5=new d.KL.HandUi({scale:this.easel.getTransform().scale,angleDeg:0,onReset:function(){ew.easel.resetTransform()},onFit:function(){ew.easel.fitTransform()},onAngleChange:function(e,t){ew.easel.setAngleDeg(e,t)},onChangeUseInertiaScrolling:function(e){eX.setUseInertiaScrolling(e)}}),e4=new d.KL.FillUi({colorSlider:this.klColorSlider}),e7=new d.KL.GradientUi({colorSlider:this.klColorSlider}),e9=new d.KL.TextUi({colorSlider:this.klColorSlider}),e8=new d.KL.ShapeUi({colorSlider:this.klColorSlider,onChangePanning:function(e){return eK.setPanning(e)}}),e6=new d.KL.GradientTool({onGradient:function(e,t,i,n,r,o){var s=e_.index,a=e7.getSettings(),l={type:a.type,color1:ew.klColorSlider.getColor(),isReversed:a.isReversed,opacity:a.opacity,doLockAlpha:a.doLockAlpha,isEraser:a.isEraser,doSnap:eq.isPressed("shift")||a.doSnap,x1:t,y1:i,x2:n,y2:r,angleRad:o};if(e)ew.klCanvas.setComposite(s,void 0),ew.klCanvas.drawGradient(s,l);else{var h=ew.klCanvas.getSelection(),c=h?new Path2D((0,ey.getSelectionPath2d)(h)):void 0;ew.klCanvas.setComposite(s,{draw:function(e){d.KL.drawGradient(e,l,c)}})}ew.easelProjectUpdater.update()}}),te=new d.KL.ShapeTool({onShape:function(e,t,i,n,r,o){var s=e_.index,a={type:e8.getShape(),x1:t,y1:i,x2:n,y2:r,angleRad:o,isOutwards:e8.getIsOutwards(),opacity:e8.getOpacity(),isEraser:e8.getIsEraser(),doLockAlpha:e8.getDoLockAlpha()};if("line"===e8.getShape()?(a.strokeRgb=ew.klColorSlider.getColor(),a.lineWidth=e8.getLineWidth(),a.isAngleSnap=e8.getIsSnap()||eq.isPressed("shift")):(a.isFixedRatio=e8.getIsFixed()||eq.isPressed("shift"),"stroke"===e8.getMode()?(a.strokeRgb=ew.klColorSlider.getColor(),a.lineWidth=e8.getLineWidth()):a.fillRgb=ew.klColorSlider.getColor()),e)ew.klCanvas.setComposite(s,void 0),ew.klCanvas.drawShape(s,a);else{var l=ew.klCanvas.getSelection(),h=l?new Path2D((0,ey.getSelectionPath2d)(l)):void 0;ew.klCanvas.setComposite(s,{draw:function(e){d.KL.drawShape(e,a,h)}})}ew.easelProjectUpdater.update()}});this.layersUi=new d.KL.LayersUi({klCanvas:this.klCanvas,onSelect:function(e,t){var i=ew.klCanvas.getLayer(e);if(eJ(i),t){var n=ew.klHistory.getEntries().at(-1).data,r=(0,en.isHistoryEntryActiveLayerChange)(n);ew.klHistory.push({activeLayerId:i.id},r)}},parentEl:this.rootEl,uiState:this.uiLayout,applyUncommitted:function(){return ez()},klHistory:this.klHistory,onUpdateProject:function(){return ew.easelProjectUpdater.update()},onClearLayer:function(){return eM(!1,!0)}}),this.layerPreview=new d.KL.LayerPreview({klRootEl:this.rootEl,onClick:function(){null==eA||eA.open("layers")},uiState:this.uiLayout,klHistory:this.klHistory}),this.layerPreview.setIsVisible(this.uiHeight>=579),this.layerPreview.setLayer(e_);var tt=new d.KL.EditUi({klRootEl:this.rootEl,klColorSlider:this.klColorSlider,layersUi:this.layersUi,getCurrentColor:function(){return eR},maxCanvasSize:ek,klCanvas:this.klCanvas,getCurrentLayer:function(){return e_},isEmbed:!!this.embed,statusOverlay:this.statusOverlay,onCanvasChanged:function(){ew.easelProjectUpdater.update(),ew.easel.resetOrFitTransform(!0)},applyUncommitted:function(){return ez()},klHistory:this.klHistory,onCopyToClipboard:function(){ez(),to(!1,!1)},onPaste:function(){return th.readClipboard()}}),ti=new(0,et.KlHistoryExecutor)({klHistory:this.klHistory,tempHistory:eT,onCanUndoRedoChange:function(e,t){ew.toolspaceToolRow.setEnableUndo(e),ew.toolspaceToolRow.setEnableRedo(t)}}),tn=function(){ez(),d.KL.newImageDialog({currentColor:eR,secondaryColor:ew.klColorSlider.getSecondaryRGB(),maxCanvasSize:ek,canvasWidth:ew.klCanvas.getWidth(),canvasHeight:ew.klCanvas.getHeight(),workspaceWidth:window.innerWidth<ew.collapseThreshold?ew.uiWidth:ew.uiWidth-ew.toolWidth,workspaceHeight:ew.uiHeight,onConfirm:function(e,t,i){ew.klCanvas.reset({width:e,height:t,color:1===i.a?i:void 0}),ew.layersUi.update(0),eJ(ew.klCanvas.getLayer(0)),ew.easelProjectUpdater.update(),ew.easel.resetOrFitTransform(!0)},onCancel:function(){}})},tr=function(e){ez(),g.BB.shareCanvas({canvas:ew.klCanvas.getCompleteCanvas(1),fileName:g.BB.getDate()+G.KL_CONFIG.filenameBase+".png",title:g.BB.getDate()+G.KL_CONFIG.filenameBase+".png",callback:e||function(){}})};this.saveToComputer=new d.KL.SaveToComputer(function(){return eC},this.klCanvas,function(){ew.updateLastSaved()});var to=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];d.KL.clipboardDialog(eB.rootEl,function(e){return eB.klCanvas.getCompleteCanvas(1,e)},function(e){(0!==e.left||0!==e.right||0!==e.top||0!==e.bottom)&&(d.KL.FILTER_LIB.cropExtend.apply({layer:e_,klCanvas:eB.klCanvas,input:e,klHistory:eB.klHistory}),eB.layersUi.update(),eB.easelProjectUpdater.update(),eB.easel.resetOrFitTransform(!0))},eB.statusOverlay,e||!1,t,eB.klCanvas.getSelection())},ts=function(){return(0,r._)(function(){var e,t,i,n,o,s,a,c,u,f,v;return(0,p.__generator)(this,function(m){switch(m.label){case 0:if(e=this,t=function(){d.KL.popup({target:e.rootEl,message:(0,w.LANG)("file-storage-open-failed"),type:"error"})},!eS)return t(),[2];if(!((i=eS.getCurrentMeta())&&this.klHistory.getComposed().projectId.value!==i.projectId))return[3,4];return n=!0,o=new(0,ev.CrossTabChannel)("kl-tab-communication"),s=[],a=function(e){"response-project-id"===e.type&&s.push(e.id)},o.subscribe(a),o.postMessage({type:"request-project-ids"}),[4,(0,ec.sleep)(100)];case 1:if(m.sent(),o.unsubscribe(a),!(i&&s.includes(i.projectId)))return[3,3];return[4,new Promise(function(e,t){(0,ed.showModal)({target:document.body,message:(0,w.LANG)("file-storage-open-confirmation"),buttons:[(0,w.LANG)("file-storage-open"),"Cancel"],callback:function(t){return(0,r._)(function(){return(0,p.__generator)(this,function(i){return"Cancel"===t?e(!1):e(!0),[2]})})()}})})];case 2:n=m.sent(),m.label=3;case 3:if(o.close(),!n)return[2];m.label=4;case 4:d.KL.popup({target:this.rootEl,message:(0,w.LANG)("loading"),callback:function(e){c=void 0},closeFunc:function(e){c=e}}),m.label=5;case 5:return m.trys.push([5,7,,8]),[4,null==eS?void 0:eS.read()];case 6:return u=m.sent(),[3,8];case 7:return f=m.sent(),setTimeout(function(){throw f}),[3,8];case 8:if(!u)return null==c||c(),t(),[2];return ez(),v=this.klCanvas.reset({projectId:u.project.projectId,width:u.project.width,height:u.project.height,layers:u.project.layers.map(function(e){var t,i=e.image;return!(i instanceof HTMLCanvasElement)&&(i=g.BB.canvas(u.project.width,u.project.height),e.image instanceof HTMLImageElement&&g.BB.ctx(i).drawImage(e.image,0,0)),(0,h._)((0,l._)({},e),{id:(0,ec.randomUuid)(),image:i,mixModeStr:null!=(t=e.mixModeStr)?t:"source-over"})})}),this.layersUi.update(v),eJ(this.klCanvas.getLayer(v)),this.easelProjectUpdater.update(),this.easel.resetOrFitTransform(!0),setTimeout(function(){e.statusOverlay.out((0,w.LANG)("file-storage-restored"))}),null==c||c(),[2]}})}).call(ew)},ta=this.embed?null:new d.KL.FileUi({klRootEl:this.rootEl,projectStore:eS,getProject:function(){return ew.klCanvas.getProject()},exportType:eC,onExportTypeChange:function(e){eC=e},onFileSelect:function(e,t){return th.handleFileSelect(e,t)},onSaveImageToComputer:function(){ez(),ew.saveToComputer.save()},onNewImage:tn,onShareImage:function(e){ez(),tr(e)},onUpload:function(){ez(),d.KL.imgurUpload(ew.klCanvas,ew.rootEl,i.app&&i.app.imgurKey?i.app.imgurKey:"",function(){return ew.updateLastSaved()})},applyUncommitted:function(){return ez()},onChangeShowSaveDialog:function(e){ew.saveToComputer.setShowSaveDialog(e)},klRecoveryManager:eI,onOpenBrowserStorage:ts,onStoredToBrowserStorage:function(){ew.updateLastSaved()}});!this.embed&&eS&&(this.saveReminder=new(0,b.SaveReminder)({onSaveAsPsd:function(){ew.embed||ew.saveAsPsd()},isDrawing:function(){return ew.isDrawing()},projectStore:eS,getProject:function(){return ew.getProject()},onStored:function(){ew.updateLastSaved()},applyUncommitted:ez,klHistory:this.klHistory}));var tl=new d.KL.SettingsUi({onLeftRight:function(){ew.uiLayout="left"===ew.uiLayout?"right":"left",ew.updateUi(),ew.embed||B.LocalStorage.setItem("uiState",ew.uiLayout)},saveReminder:this.saveReminder,customAbout:i.aboutEl});eA=new d.KL.TabRow({initialId:"brush",tabArr:[{id:"brush",title:(0,w.LANG)("tool-brush"),image:t(L),onOpen:function(){"eraserBrush"===m&&ew.klColorSlider.enable(!1),g.BB.append(e1,[ew.klColorSlider.getElement(),ew.klColorSlider.getOutputElement(),e2.getElement()]),e0.style.display="block"},onClose:function(){e0.style.display="none"},css:{minWidth:"45px"}},{id:"hand",title:(0,w.LANG)("tool-hand"),image:t(I),isVisible:!1,onOpen:function(){e5.setIsVisible(!0)},onClose:function(){e5.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"paintBucket",title:(0,w.LANG)("tool-paint-bucket"),image:t(T),isVisible:!1,onOpen:function(){ew.klColorSlider.enable(!0),e4.setIsVisible(!0)},onClose:function(){e4.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"gradient",title:(0,w.LANG)("tool-gradient"),image:t(A),isVisible:!1,onOpen:function(){ew.klColorSlider.enable(!0),e7.setIsVisible(!0)},onClose:function(){e7.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"text",title:(0,w.LANG)("tool-text"),image:t(M),isVisible:!1,onOpen:function(){ew.klColorSlider.enable(!0),e9.setIsVisible(!0)},onClose:function(){e9.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"shape",title:(0,w.LANG)("tool-shape"),image:t(R),isVisible:!1,onOpen:function(){ew.klColorSlider.enable(!0),e8.setIsVisible(!0)},onClose:function(){e8.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"select",title:(0,w.LANG)("tool-select"),image:t(_),isVisible:!1,onOpen:function(){eW.getSelectUi().setIsVisible(!0)},onClose:function(){eW.getSelectUi().setIsVisible(!1)},css:{minWidth:"45px"}},{id:"layers",title:(0,w.LANG)("layers"),image:t(D),onOpen:function(){ew.layersUi.update(),ew.layersUi.getElement().style.display="block"},onClose:function(){ew.layersUi.getElement().style.display="none"},css:{minWidth:"45px"}},{id:"edit",title:(0,w.LANG)("tab-edit"),image:t(N),onOpen:function(){tt.show()},onClose:function(){tt.hide()},css:{minWidth:"45px"}},{id:"file",label:(0,w.LANG)("tab-file"),isVisible:!!ta,onOpen:function(){ta&&(ta.getElement().style.display="block",ta.setIsVisible(!0))},onClose:function(){ta&&(ta.getElement().style.display="none",ta.setIsVisible(!1))},css:{padding:"0 7px"}},{id:"settings",title:(0,w.LANG)("tab-settings"),image:t(P),onOpen:function(){tl.getElement().style.display="block"},onClose:function(){tl.getElement().style.display="none"},css:{minWidth:"45px"}}]}),this.bottomBarWrapper=g.BB.el({css:{width:"270px",position:"absolute",bottom:"0",left:"0"}}),i.bottomBar&&(this.bottomBar=i.bottomBar,this.bottomBarWrapper.append(this.bottomBar),new MutationObserver(function(){return ew.updateBottomBar()}).observe(this.toolspaceInner,{attributes:!0,childList:!0,subtree:!0})),g.BB.append(this.toolspaceInner,[this.layerPreview.getElement(),eA.getElement(),e0,e5.getElement(),e4.getElement(),e7.getElement(),e9.getElement(),e8.getElement(),eW.getSelectUi().getElement(),this.layersUi.getElement(),tt.getElement(),ta?ta.getElement():void 0,tl.getElement(),g.BB.el({css:{height:"10px"}}),this.bottomBarWrapper?this.bottomBarWrapper:void 0]),this.toolspaceScroller=new d.KL.ToolspaceScroller({toolspace:this.toolspace,uiState:this.uiLayout}),this.embed||Object.defineProperty(window,"KL",{value:(0,O.createConsoleApi)({onDraw:function(e){e&&0!==e.length&&(e.forEach(function(e,t){0===t?a.startLine(e.x,e.y,1):a.goLine(e.x,e.y,1)}),a.endLine())}}),writable:!1}),this.resize(this.uiWidth,this.uiHeight),this.updateUi();var th=new(0,E.KlAppImportHandler)({klRootEl:this.rootEl,maxCanvasSize:ek,layersUi:this.layersUi,setCurrentLayer:eJ,klCanvas:this.klCanvas,onImportConfirm:function(){ew.easelProjectUpdater.update(),ew.easel.resetOrFitTransform(!0)},applyUncommitted:function(){return ez()}},{onColor:function(e){return eN.setColor(e)}});(!this.embed||this.embed.enableImageDropperImport)&&(new d.KL.KlImageDropper({target:document.body,onDrop:function(e,t){d.KL.DIALOG_COUNTER.get()>0||(ez(),th.handleFileSelect(e,t))},enabledTest:function(){return 0===d.KL.DIALOG_COUNTER.get()}}),window.document.addEventListener("paste",function(e){return th.onPaste(e)},!1)),this.unloadWarningTrigger=new(0,eu.UnloadWarningTrigger)({klHistory:this.klHistory,getLastSavedHistoryIndex:function(){return ew.lastSavedHistoryIndex}}),window.addEventListener("resize",function(){ew.resize(window.innerWidth,window.innerHeight)}),window.addEventListener("orientationchange",function(){ew.resize(window.innerWidth,window.innerHeight)}),"visualViewport"in window&&null!==visualViewport&&visualViewport.addEventListener("resize",function(){ew.resize(window.innerWidth,window.innerHeight)});var tc=g.BB.el({parent:document.body,css:{position:"fixed",left:"0",top:"0",right:"0",bottom:"0",pointerEvents:"none",zIndex:"-1",userSelect:"none"}});try{new ResizeObserver(function(){return ew.resize(window.innerWidth,window.innerHeight)}).observe(tc)}catch(e){tc.remove()}this.rootEl.addEventListener("wheel",function(e){eq.isPressed("ctrl")&&e.preventDefault()},{passive:!1});var tu=function(e){e.preventDefault()};window.addEventListener("gesturestart",tu,{passive:!1}),window.addEventListener("gesturechange",tu,{passive:!1}),window.addEventListener("gestureend",tu,{passive:!1}),new(0,J.PinchZoomWatcher),this.embed||setTimeout(function(){(0,eg.runBrowserStorageBanner)({projectStore:eS,klRecoveryManager:eI,onOpenBrowserStorage:ts,klHistory:ew.klHistory})}),null==(n=this.saveReminder)||n.init()}return(0,a._)(e,[{key:"updateLastSaved",value:function(){var e,t;this.lastSavedHistoryIndex=this.klHistory.getTotalIndex(),null==(e=this.saveReminder)||e.reset(),null==(t=this.unloadWarningTrigger)||t.update()}},{key:"updateCollapse",value:function(e){if(e){var t;null!=(t=B.LocalStorage.getItem("uiShowMobile"))&&t&&this.mobileUi.setToolspaceIsOpen(!1)}this.mobileUi.setOrientation(this.uiLayout),this.uiWidth<this.collapseThreshold?(this.mobileUi.setIsVisible(!0),this.mobileUi.getToolspaceIsOpen()?("left"===this.uiLayout?(0,ec.css)(this.easel.getElement(),{left:"271px"}):(0,ec.css)(this.easel.getElement(),{left:"0"}),this.toolspace.style.display="block",this.easel.setSize(Math.max(0,this.uiWidth-this.toolWidth),this.uiHeight),this.statusOverlay.setWide(!1)):(this.uiLayout,(0,ec.css)(this.easel.getElement(),{left:"0"}),this.toolspace.style.display="none",this.easel.setSize(Math.max(0,this.uiWidth),this.uiHeight),this.statusOverlay.setWide(!0))):(this.mobileColorUi.closeColorPicker(),this.mobileUi.setIsVisible(!1),"left"===this.uiLayout&&(0,ec.css)(this.easel.getElement(),{left:"271px"}),this.toolspace.style.display="block",this.easel.setSize(Math.max(0,this.uiWidth-this.toolWidth),this.uiHeight),this.statusOverlay.setWide(!1)),this.mobileUi.update()}},{key:"updateBottomBar",value:function(){if(this.bottomBar){var e=this.toolspaceInner.scrollHeight+40<window.innerHeight?"":"none";e!==this.bottomBarWrapper.style.display&&(this.bottomBarWrapper.style.display=e)}}},{key:"updateUi",value:function(){this.toolspace.classList.toggle("kl-toolspace--left","left"===this.uiLayout),this.toolspace.classList.toggle("kl-toolspace--right","right"===this.uiLayout),"left"===this.uiLayout?((0,ec.css)(this.toolspace,{left:"0",right:""}),(0,ec.css)(this.easel.getElement(),{left:"271px"})):((0,ec.css)(this.toolspace,{left:"",right:"0"}),(0,ec.css)(this.easel.getElement(),{left:"0"})),this.statusOverlay.setUiState(this.uiLayout),this.layerPreview.setUiState(this.uiLayout),this.layersUi.setUiState(this.uiLayout),this.updateCollapse(),this.toolspaceScroller.updateUiState(this.uiLayout)}},{key:"getElement",value:function(){return this.rootEl}},{key:"resize",value:function(e,t){window.scrollY>0&&window.scrollTo(0,0),(this.uiWidth!==Math.max(0,e)||this.uiHeight!==Math.max(0,t))&&(this.uiWidth=Math.max(0,e),this.uiHeight=Math.max(0,t),this.updateCollapse(),this.updateBottomBar(),this.layerPreview.setIsVisible(this.uiHeight>=579),this.klColorSlider.setHeight(Math.max(163,Math.min(400,this.uiHeight-505))),this.toolspaceToolRow.setIsSmall(this.uiHeight<540))}},{key:"out",value:function(e){this.statusOverlay.out(e)}},{key:"getPNG",value:function(){return(0,r._)(function(){return(0,p.__generator)(this,function(e){switch(e.label){case 0:return[4,(0,es.canvasToBlob)(this.klCanvas.getCompleteCanvas(1),"image/png")];case 1:return[2,e.sent()]}})}).call(this)}},{key:"getProject",value:function(){return this.klCanvas.getProject()}},{key:"swapUiLeftRight",value:function(){this.uiLayout="left"===this.uiLayout?"right":"left",this.embed||B.LocalStorage.setItem("uiState",this.uiLayout),this.updateUi()}},{key:"saveAsPsd",value:function(){this.saveToComputer.save("psd")}},{key:"isDrawing",value:function(){return this.lineSanitizer.getIsDrawing()||this.easel.getIsLocked()}}]),e}()}),s("hrnUX",function(t,i){e(t.exports,"KL",function(){return ed});var n=o("2MaaK"),r=o("dLlkc"),s=o("i8UFO"),a=o("7bWhB"),l=o("dJPtW"),h=o("eEL9N"),c=o("1kyaA"),u=o("4nUqS"),p=o("lCF5N"),d=o("aP0jf"),g=o("lfHl9"),f=o("fg9Sv"),v=o("gmji4"),m=o("j5jvd"),y=o("43qNf"),x=o("iFIyy"),b=o("bmB93"),w=o("hRdOL"),B=o("isYih"),k=o("b4yIv"),S=o("5UrL9"),C=o("cNhNm"),E=o("kEeSq"),L=o("32CBv"),I=o("kqmpc"),T=o("8ebuX"),A=o("13r5y"),M=o("9p4Zp"),R=o("8jqzp"),_=o("84zxV"),P=o("9Kxky"),D=o("1Ax5m"),N=o("e4sAN"),O=o("khi8I"),G=o("dJXmR"),H=o("iS9xS"),z=o("9J17G"),j=o("76Qvv"),F=o("uO7ai"),V=o("dHnZA"),U=o("kDGzx"),W=o("941rU"),X=o("3ujzu"),K=o("705qg"),Y=o("kyVjY"),Z=o("dAXbp"),q=o("3P46L"),$=o("h62LS"),Q=o("fRGIf"),J=o("9pcu9"),ee=o("6mTnI"),et=o("6LAlx"),ei=o("gHbQ1"),en=o("5ENro"),er=o("iVf04"),eo=o("5ngYX"),es=o("eyygR"),ea=o("7pyBK"),el=o("cmnov"),eh=o("byS9j"),ec=o("iVHpg"),eu=o("5Gc7M"),ep=o("7EG77"),ed={BRUSHES:Z.BRUSHES,BRUSHES_UI:q.BRUSHES_UI,BrushSettingService:ea.BrushSettingService,KlCanvas:K.KlCanvas,KlCanvasPreview:S.KlCanvasPreview,FILTER_LIB_STATUS:Y.FILTER_LIB_STATUS,FILTER_LIB:Y.FILTER_LIB,ShapeTool:X.ShapeTool,drawShape:X.drawShape,GradientTool:ep.GradientTool,drawGradient:ep.drawGradient,PSD:W,ProjectStore:ee.ProjectStore,loadAgPsd:er.loadAgPsd,SaveToComputer:es.SaveToComputer,Checkbox:a.Checkbox,input:l.input,Select:h.Select,ImageToggle:c.ImageToggle,ImageRadioList:u.ImageRadioList,RadioList:Q.RadioList,createPenPressureToggle:p.createPenPressureToggle,KlSlider:d.KlSlider,HexColorDialog:g.HexColorDialog,KlColorSlider:f.KlColorSlider,KlColorSliderSmall:v.KlColorSliderSmall,PointSlider:m.PointSlider,ColorOptions:y.ColorOptions,Options:x.Options,BoxToggle:el.BoxToggle,StatusOverlay:b.StatusOverlay,CropCopy:w.CropCopy,FreeTransform:C.FreeTransform,FreeTransformCanvas:E.FreeTransformCanvas,Cropper:L.Cropper,LayerPreview:I.LayerPreview,KlImageDropper:A.KlImageDropper,OverlayToolspace:M.OverlayToolspace,ToolspaceTopRow:R.ToolspaceTopRow,ToolDropdown:_.ToolDropdown,ToolspaceToolRow:P.ToolspaceToolRow,ToolspaceStabilizerRow:D.ToolspaceStabilizerRow,TabRow:N.TabRow,ToolspaceCollapser:F.ToolspaceCollapser,BrowserStorageUi:J.BrowserStorageUi,SaveReminder:eo.SaveReminder,ToolspaceScroller:ec.ToolspaceScroller,DIALOG_COUNTER:s.DIALOG_COUNTER,popup:n.showModal,Popup:r.DynamicModal,clipboardDialog:B.clipboardDialog,showImportAsLayerDialog:T.showImportAsLayerDialog,newImageDialog:j.newImageDialog,textToolDialog:V.textToolDialog,showImportImageDialog:U.showImportImageDialog,showIframePopup:$.showIframeModal,imgurUpload:en.imgurUpload,HandUi:O.HandUi,FillUi:G.FillUi,GradientUi:eu.GradientUi,TextUi:H.TextUi,ShapeUi:z.ShapeUi,FileUi:et.FileUi,EditUi:ei.EditUi,SettingsUi:eh.SettingsUi,LayersUi:k.LayersUi};Object.keys(ed)}),s("2MaaK",function(i,n){e(i.exports,"showModal",function(){return u});var r=o("i8UFO"),s=o("eWjiX"),a=o("1mH1z");o("8zjca");var l=o("jvBcx"),h=o("1rI75"),c=o("9N3Nv");function u(e){r.DIALOG_COUNTER.increase();var i,n,o=!1,u=!!e.ignoreBackground,p=s.BB.el({parent:document.body,css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",overflow:"hidden"}}),d=s.BB.el({parent:p,className:"kl-popup"}),g=s.BB.el({parent:d,css:{width:"100%",minHeight:"100%",position:"relative",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}}),f=s.BB.el({parent:g,onClick:function(){u||S("Cancel")},css:{position:"absolute",left:"0",top:"0",zIndex:"0",width:"100%",height:"100%"}}),v=s.BB.el({tagName:"button",className:"popup-x",content:`<img alt="${(0,a.LANG)("modal-close")}" height="20" src="${t(l)}">`,title:(0,a.LANG)("modal-close"),onClick:function(){S("Cancel")},css:{width:"40px",height:"40px",lineHeight:"40px",position:"absolute",right:"0",top:"0",background:"none",boxShadow:"none"}}),m=void 0;e.type&&(m=s.BB.el({className:{error:"kl-popup__icon-error",ok:"kl-popup__icon-ok",warning:"kl-popup__icon-warning",upload:"kl-popup__icon-upload"}[e.type]}));var y=["kl-popup-box"];y.push("kl-popup-box--sm");var x=s.BB.el({content:[v,m,s.BB.el({content:e.message,css:{marginRight:"15px",marginBottom:e.div?"10px":void 0}}),e.div],className:y.join(" "),css:e.style?e.style:void 0});g.append(s.BB.el({css:{flex:"0.5"}}),x,s.BB.el({css:{flex:"1"}}));var b=new s.BB.KeyListener({onDown:function(e,t,i){o||(n&&"enter"===i&&!s.BB.isInputFocused()&&(t.stopPropagation(),setTimeout(function(){n&&n.click()},10)),"esc"===i&&(t.stopPropagation(),t.preventDefault(),S("Cancel")))}}),w=function(e){b.isPressed("ctrl")&&e.preventDefault()};d.addEventListener("wheel",w,{passive:!1}),d.onclick=s.BB.handleClick,i=e.autoFocus?e.autoFocus:!1===e.autoFocus?void 0:"Ok";var B=e.buttons&&e.buttons.length>0?s.BB.el({parent:x,css:{display:"flex",flexWrap:"wrap",justifyContent:"flex-end",marginTop:"12px",marginLeft:"-8px"}}):void 0,k=[];function S(t){!o&&(o=!0,s.BB.clearSelection(),s.BB.unfocusAnyInput(),p.remove(),r.DIALOG_COUNTER.decrease(),s.BB.destroyEl(v),s.BB.destroyEl(f),b.destroy(),d.removeEventListener("wheel",w),d.onclick=null,k.forEach(function(e){return s.BB.destroyEl(e)}),k.splice(0,k.length),e.callback&&e.callback(t))}return e.buttons&&e.buttons.forEach(function(r){var o,u=["kl-popup__btn"];("Ok"===r||e.primaries&&e.primaries.includes(r))&&u.push("kl-button-primary"),r===e.deleteButtonName&&u.push("kl-button-delete");var p=r;"Ok"===r&&(p=(0,a.LANG)("modal-ok"),o=t(h)),"Cancel"===r&&(p=(0,a.LANG)("modal-cancel"),o=t(l),u.push("kl-button-cancel")),r===e.deleteButtonName&&(o=t(c));var g=void 0;o&&(g=s.BB.el({tagName:"img",custom:{src:o,height:"17"}}));var f=s.BB.el({parent:B,tagName:"button",className:u.join(" "),content:[g,s.BB.el({className:"kl-popup__btn__text",content:p})],onClick:function(){S(r)}});k.push(f),i===r&&(setTimeout(function(){f.focus(),d.scrollTo(0,0)},10),setTimeout(function(){d.scrollTo(0,0)},20)),r===e.clickOnEnter&&(n=f)}),e.closeFunc&&e.closeFunc(function(){S("Cancel")}),{setIgnoreBackground:function(e){u=e}}}}),s("i8UFO",function(t,i){e(t.exports,"DIALOG_COUNTER",function(){return s});var n=o("cx0mh"),r=o("7h4XF"),s=new(function(){"use strict";function e(){(0,n._)(this,e),this.listeners=[],this.count=0}return(0,r._)(e,[{key:"emit",value:function(){var e=this;this.listeners.forEach(function(t){t(e.count)})}},{key:"increase",value:function(e){void 0!==e?this.count+=e:this.count++,this.emit()}},{key:"decrease",value:function(e){void 0!==e?this.count-=e:this.count--,this.emit()}},{key:"get",value:function(){return this.count}},{key:"subscribe",value:function(e){this.listeners.push(e)}}]),e}())}),s("8zjca",function(e,t){window.onscroll=function(e){e.preventDefault()}}),s("jvBcx",function(e,t){e.exports=i("kbyFQ")}),s("1rI75",function(e,t){e.exports=i("l7FYj")}),s("9N3Nv",function(e,t){e.exports=i("kino6")}),s("dLlkc",function(i,n){e(i.exports,"DynamicModal",function(){return p});var r=o("cx0mh"),s=o("7h4XF"),a=o("i8UFO"),l=o("eWjiX"),h=o("1mH1z");o("8zjca");var c=o("jvBcx"),u=o("7jh4K"),p=function(){"use strict";function e(i){var n=this;(0,r._)(this,e),a.DIALOG_COUNTER.increase(),this.onClose=i.onClose,this.parent=document.body,this.rootEl=l.BB.el({parent:this.parent,className:"g-root kl-d-modal-root",css:{position:"fixed",left:"0",top:"0",bottom:"0",right:"0",overflow:"auto",animationName:"consoleIn",animationDuration:"0.3s",animationTimingFunction:"ease-out"},onClick:l.BB.handleClick}),this.bgEl=l.BB.el({parent:this.rootEl,css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"},onClick:function(){return n.close()}});var o=l.BB.el({parent:this.rootEl,className:"kl-d-modal",css:{position:"absolute",width:l.BB.isCssMinMaxSupported()?"min(calc(100% - 40px), "+(i.width?i.width:400)+"px)":(i.width?i.width:400)+"px",height:"calc(100% - 40px)",borderRadius:"10px",overflow:"hidden"}});this.updatePos=function(){var e=o.offsetWidth,t=o.offsetHeight;(0,u.css)(o,{left:Math.max(0,(window.innerWidth-e)/2)+"px",top:Math.max(20,(window.innerHeight-t)/2-.2*t)+"px"})},this.updatePos(),window.addEventListener("resize",this.updatePos);var s=l.BB.el({parent:o,css:{height:"40px",display:"flex",justifyContent:"space-between",alignItems:"center",paddingLeft:"20px"}});i.title&&s.append(i.title),this.xButton=l.BB.el({parent:s,tagName:"button",className:"popup-x",content:`<img alt="${(0,h.LANG)("modal-close")}" height="20" src="${t(c)}">`,title:(0,h.LANG)("modal-close"),onClick:function(){return n.close()},css:{width:"40px",height:"40px",lineHeight:"40px",background:"none",boxShadow:"none"},custom:{tabindex:"0"}});var p=l.BB.el({parent:o,css:{height:"calc(100% - 40px)"}});i.content&&p.append(i.content),this.keyListener=new l.BB.KeyListener({onDown:function(e,t){"esc"===e&&(t.stopPropagation(),t.preventDefault(),n.close())}})}return(0,s._)(e,[{key:"close",value:function(){a.DIALOG_COUNTER.decrease(),l.BB.destroyEl(this.rootEl),this.rootEl.remove(),window.removeEventListener("resize",this.updatePos),this.keyListener.destroy(),l.BB.destroyEl(this.xButton),l.BB.destroyEl(this.bgEl),this.onClose&&this.onClose()}}]),e}()}),s("7bWhB",function(t,i){e(t.exports,"Checkbox",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.doHighlight=!!t.doHighlight,this.rootEl=s.BB.el({className:"kl-checkbox"});var r=s.BB.el({parent:this.rootEl,tagName:"label",className:"kl-checkbox__inner",css:{display:"flex"}});this.check=s.BB.el({parent:r,tagName:"input",css:{margin:"0 5px 0 0"},custom:{type:"checkbox",name:t.name}}),this.check.checked=!!t.init,this.doHighlight&&this.check.checked&&this.rootEl.classList.add("kl-checkbox--highlight"),t.allowTab||(this.check.tabIndex=-1),t.title&&(r.title=t.title),s.BB.el({parent:r,content:t.label,css:{}}),this.check.onchange=function(){i.doHighlight&&i.rootEl.classList.toggle("kl-checkbox--highlight",i.check.checked),t.callback&&t.callback(i.check.checked),setTimeout(function(){i.check.blur()},0)},t.css&&(0,a.css)(this.rootEl,t.css)}return(0,r._)(e,[{key:"getValue",value:function(){return this.check.checked}},{key:"setValue",value:function(e){this.check.checked=e,this.doHighlight&&this.rootEl.classList.toggle("kl-checkbox--highlight",this.check.checked)}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.check.onchange=null}}]),e}()}),s("dJPtW",function(t,i){e(t.exports,"Input",function(){return l}),e(t.exports,"input",function(){return h});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){var i,r,o=this;(0,n._)(this,e),this.keyListener={destroy:function(){}},this.rootEl=s.BB.el({tagName:"label",content:t.label,css:{display:"flex",alignItems:"center",gap:"5px"}}),this.input=s.BB.el({tagName:"input",parent:this.rootEl,title:t.title,custom:{name:t.name}}),this.type=null!=(i=t.type)?i:"text";try{this.input.type=this.type}catch(e){}var l=null!=(r=t.step)?r:1;"number"===this.type&&(void 0!==t.min&&(this.input.min=""+t.min),void 0!==t.max&&(this.input.max=""+t.max),void 0!==t.step&&(this.input.step=""+l)),this.input.value=""+t.init;var h=this.input.value,c=function(){var e=h,i=o.input.value;if(t.doResetIfInvalid){var n=!1;""===i&&(i=h,n=!0),void 0!==t.min&&parseFloat(i)<t.min&&(i=""+t.min,n=!0),void 0!==t.max&&parseFloat(i)>t.max&&(i=""+t.max,n=!0),n&&(o.input.value=""+i)}return h=i,e!==i};if(t.onChange){var u=t.onChange;this.input.onchange=function(){c()&&u(o.input.value)}}if(t.css&&(0,a.css)(this.input,t.css),t.doScrollWithoutFocus&&"number"===t.type&&t.onChange){var p=t.onChange;this.keyListener=new s.BB.KeyListener({}),this.pointerListener=new s.BB.PointerListener({target:this.input,onWheel:function(e){var t=o.keyListener.isPressed("shift")?4:1;o.input.value=""+(parseFloat(o.input.value)-e.deltaY*l*t),c()&&p(o.input.value)}})}}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.input.value}},{key:"setValue",value:function(e){this.input.value=""+e}},{key:"destroy",value:function(){this.pointerListener&&this.pointerListener.destroy(),this.keyListener.destroy()}}]),e}(),h=function(e){var t=document.createElement("input");if(e.type)try{t.type=e.type}catch(e){}else t.type="text";return void 0!==e.min&&(t.min=""+e.min),void 0!==e.max&&(t.max=""+e.max),t.value=""+e.init,e.callback&&(t.onchange=function(){e.callback(t.value)}),e.css&&(0,a.css)(t,e.css),t}}),s("eEL9N",function(t,i){e(t.exports,"Select",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.optionArr=[],this.selectEl=s.BB.el({tagName:"select",title:t.title,className:"kl-select",css:{cursor:"pointer",fontSize:"15px",padding:"3px"},custom:{name:t.name}}),t.css&&(0,a.css)(this.selectEl,t.css);var r=t.isFocusable;r||(this.selectEl.tabIndex=-1),this.setOptionArr(t.optionArr),t.onChange&&(this.onChange=t.onChange),this.changeListener=function(){r||i.selectEl.blur(),i.onChange&&i.onChange(i.getValue())},this.selectEl.addEventListener("change",this.changeListener),this.selectEl.value=void 0!==t.initValue?t.initValue:""}return(0,r._)(e,[{key:"setValue",value:function(e){this.selectEl.value=void 0===e?"":e}},{key:"getValue",value:function(){return this.selectEl.value}},{key:"setDeltaValue",value:function(e){for(var t=0,i=0;i<this.optionArr.length;i++){var n=this.optionArr[i];if(n.item&&""+n.item[0]===this.selectEl.value){t=i;break}}t=Math.max(0,Math.min(this.optionArr.length-1,t+e));var r=this.optionArr[t];this.selectEl.value=r.item?r.item[0]:"",this.onChange&&this.onChange(this.getValue())}},{key:"getElement",value:function(){return this.selectEl}},{key:"updateLabel",value:function(e,t){this.optionArr.forEach(function(i){i.item&&i.item[0]===e&&i.el&&(i.item[1]=t,i.el.textContent=i.item[1])})}},{key:"setOptionArr",value:function(e){var t=this.selectEl.value;this.optionArr=[],this.selectEl.innerHTML="";for(var i=0;i<e.length;i++){var n=e[i];if(!n){this.optionArr.push({item:n});continue}var r=document.createElement("option");r.value=n[0],r.textContent=n[1],n[2]&&(0,a.css)(r,n[2].css),this.optionArr.push({item:n,el:r}),this.selectEl.append(r)}(""===t||e.findIndex(function(e){return e&&e[0]===t})>-1)&&this.setValue(t)}},{key:"destroy",value:function(){this.selectEl.removeEventListener("change",this.changeListener)}}]),e}()}),s("1kyaA",function(t,i){e(t.exports,"ImageToggle",function(){return a});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.isActive=t.initValue,this.rootEl=s.BB.el({className:"image-toggle",title:t.title,content:s.BB.el({className:"image-toggle__im"+(t.darkInvert?" dark-invert":""),css:{backgroundImage:"url('"+t.image+"')"}}),onClick:function(e){e.preventDefault(),t.isRadio&&i.isActive||(i.isActive=!i.isActive,i.update(),t.onChange(i.isActive))}}),this.update()}return(0,r._)(e,[{key:"update",value:function(){this.rootEl.classList.toggle("image-toggle-active",this.isActive)}},{key:"setValue",value:function(e){this.isActive=e,this.update()}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.isActive}},{key:"destroy",value:function(){s.BB.destroyEl(this.rootEl)}}]),e}()}),s("4nUqS",function(t,i){e(t.exports,"ImageRadioList",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("1kyaA"),l=function(){"use strict";function e(t){var i,r=this;(0,n._)(this,e),this.rootEl=s.BB.el({className:"image-radio-wrapper",css:{display:"flex"}}),this.optionArr=[];for(var o=function(e,i){r.activeIndex=e;for(var n=0;n<r.optionArr.length;n++)r.optionArr[n].radioEl.setValue(n===r.activeIndex);t.onChange(i)},l=function(e,n){n.id===t.initId&&(i=e);var s=new(0,a.ImageToggle)({image:n.image,title:n.title,initValue:n.id===t.initId,isRadio:!0,onChange:function(){o(e,n.id)},darkInvert:n.darkInvert});return r.rootEl.append(s.getElement()),{id:n.id,radioEl:s}},h=0;h<t.optionArr.length;h++)this.optionArr.push(l(h,t.optionArr[h]));if(void 0===i)throw Error("initId not in optionArr");this.activeIndex=i}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.optionArr[this.activeIndex].id}},{key:"destroy",value:function(){this.optionArr.forEach(function(e){e.radioEl.destroy()})}}]),e}()}),s("lCF5N",function(i,n){e(i.exports,"createPenPressureToggle",function(){return h});var r=o("eWjiX"),s=o("1mH1z"),a=o("d6rZL"),l=o("cmnov"),h=function(e,i){return new(0,l.BoxToggle)({label:r.BB.el({className:"dark-invert",css:{width:"17px",height:"17px",backgroundImage:'url("'+t(a)+'")',backgroundSize:"contain",backgroundRepeat:"no-repeat",margin:"1px",borderRadius:"3px"}}),title:(0,s.LANG)("brush-toggle-pressure"),init:e,onChange:function(e){i(e)}}).getElement()}}),s("d6rZL",function(e,t){e.exports=i("5H9IS")}),s("cmnov",function(t,i){e(t.exports,"BoxToggle",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.value=!!t.init,this.el=s.BB.el({content:t.label,title:t.title,className:"string"==typeof t.label?"kl-box-toggle":"kl-box-toggle kl-box-toggle--custom-el",onClick:function(){i.value=!i.value,i.update(),t.onChange(i.value)},css:{cursor:"pointer"}}),"string"!=typeof t.label&&(0,a.css)(t.label,{display:"block",pointerEvents:"none"}),this.update()}return(0,r._)(e,[{key:"update",value:function(){this.el.classList.toggle("kl-box-toggle--active",this.value)}},{key:"getValue",value:function(){return this.value}},{key:"setValue",value:function(e){this.value=e,this.update()}},{key:"getElement",value:function(){return this.el}},{key:"destroy",value:function(){s.BB.destroyEl(this.el)}}]),e}()}),s("aP0jf",function(t,i){e(t.exports,"KlSlider",function(){return u});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("11glk"),l=o("1mH1z"),h=o("869o9"),c=o("7jh4K"),u=function(){"use strict";function e(t){var i,r=this;if((0,n._)(this,e),this.isEnabled=!1!==t.isEnabled,this.manualInputRoundDigits=t.manualInputRoundDigits,this.useSpline=!!t.curve,!t.label)throw Error("KlSlider missing params");if(0!=t.min&&0!=t.max&&0!=t.value&&(!t.min||!t.max||!t.value)||t.min>=t.max)throw Error("KlSlider broken params");if(this.min=t.min,this.max=t.max,this.value=s.BB.clamp(t.value,this.min,this.max),this.elementWidth=t.width,this.elementHeight=t.height,this.resolution=t.resolution?t.resolution:2*this.elementWidth,this.onChange=t.onChange?t.onChange:function(){},!t.toValue!=!t.toDisplayValue)throw Error("both or neither have to be set, toValue and toDisplayValue");if(this.displayValueToValue=t.toValue?t.toValue:function(e){return e},this.valueToDisplayValue=t.toDisplayValue?t.toDisplayValue:function(e){return e},this.isChangeOnFinal=!!t.isChangeOnFinal,this.formatFunc=t.formatFunc,this.eventResMs=t.eventResMs,this.unit=t.unit,this.useSpline){if(!t.curve)throw Error("curve needs to be set if useSpline true");var o="quadratic"===t.curve?s.BB.powerSplineInput(this.min,this.max,.1):t.curve;this.splineInterpolator=new s.BB.SplineInterpolator(o)}this.rootEl=s.BB.el({css:{display:"flex"}}),this.sliderWrapperEl=s.BB.el({parent:this.rootEl,className:"slider-wrapper",css:{overflow:"hidden",position:"relative",width:this.elementWidth+"px",height:this.elementHeight+"px",userSelect:"none"}}),this.rootEl.oncontextmenu=function(){return!1},this.label=t.label;var l=this.elementHeight-14;this.labelValueEl=s.BB.el({css:{fontWeight:"bold"}}),this.textEl=s.BB.el({content:[s.BB.el({content:this.label,css:{overflow:"hidden",textOverflow:"ellipsis"}}),this.labelValueEl],css:{position:"absolute",display:"flex",alignItems:"center",padding:"0 7px",height:"100%",width:"100%",fontSize:l+"px",pointerEvents:"none",gap:"8px"}}),this.control=s.BB.el({className:"slider-inner",css:{position:"absolute",left:"0",top:"0",width:this.valueToSliderValue(this.value)*this.elementWidth+"px",height:this.elementHeight+"px"}});var h=document.createElement("div");this.sliderWrapperEl.append(this.control,this.textEl),this.control.append(h),this.updateEnable();var c=new s.BB.DoubleTapper({onDoubleTap:function(){r.showManualInput()}});c.setAllowedButtonArr(["left","right"]);var u=new s.BB.EventChain({chainArr:[c]}),p=function(e){if(e.eventPreventDefault(),r.isEnabled){if("pointerdown"===e.type){if(s.BB.unfocusAnyInput(),r.sliderWrapperEl.className="slider-wrapper slider-wrapper--active","left"===e.button){var t=e.relX/r.elementWidth;t=Math.max(0,Math.min(1,t)),r.value=r.sliderValueToValue(t),r.updateLabel(),r.emit(!1)}i=r.valueToSliderValue(r.value)}if("pointermove"===e.type&&["left","right"].includes(e.button||"")){var n=e.dX,o=Math.abs(e.pageY-(e.downPageY||0));n*=(0,a.calcSliderFalloffFactor)(o,"right"===e.button),n/=r.elementWidth;var l=Math.max(0,Math.min(1,i+=n));r.value=r.sliderValueToValue(l),r.updateLabel(),r.emit(!1)}"pointerup"===e.type&&(r.sliderWrapperEl.className="slider-wrapper",r.emit(!0))}};this.pointerListenerTimeout=setTimeout(function(){r.pointerListener=new s.BB.PointerListener({target:r.sliderWrapperEl,fixScribble:!0,onPointer:function(e){p(e),u.chainIn(e)},onWheel:function(e){var t=r.valueToSliderValue(r.value);t=s.BB.clamp(t-e.deltaY/40,0,1),r.value=r.sliderValueToValue(t),r.updateLabel(),r.onChange(r.value)}}),r.updateLabel()},1)}return(0,r._)(e,[{key:"valueToSliderValue",value:function(e){return this.useSpline&&this.splineInterpolator?this.splineInterpolator.findX(e,Math.floor(this.resolution))||0:(e-this.min)/(this.max-this.min)}},{key:"sliderValueToValue",value:function(e){var t=this.min+e*(this.max-this.min);return this.useSpline&&this.splineInterpolator&&(t=this.splineInterpolator.interpolate(e)||0),t}},{key:"updateLabel",value:function(){var e=this.valueToDisplayValue(this.value);e=(e=this.formatFunc?this.formatFunc(e):Math.round(e)).toLocaleString(l.LANGUAGE_STRINGS.getCode());var t=void 0!==this.unit?this.unit:"";this.labelValueEl.textContent=e+t;var i=this.valueToSliderValue(this.value);this.control.style.width=i*this.elementWidth+"px"}},{key:"emit",value:function(e){var t=this;if(e||!this.isChangeOnFinal){if(e||!this.eventResMs){this.onChange(this.value),this.emitInterval&&(clearInterval(this.emitInterval),this.emitInterval=void 0);return}this.emitInterval?this.emitValue=this.value:(this.onChange(this.value),this.emitInterval=setInterval(function(){void 0===t.emitValue?(clearInterval(t.emitInterval),t.emitInterval=void 0):(t.onChange(t.emitValue),t.emitValue=void 0)},this.eventResMs))}}},{key:"updateEnable",value:function(){this.sliderWrapperEl.classList.toggle("slider-wrapper--disabled",!this.isEnabled),(0,c.css)(this.sliderWrapperEl,{opacity:this.isEnabled?"":"0.5",pointerEvents:this.isEnabled?"":"none"}),this.manualInput&&this.manualInput.setIsEnabled(this.isEnabled)}},{key:"showManualInput",value:function(){var e=this;this.manualInput=new(0,h.KlSliderManualInput)(this.valueToDisplayValue(this.value),this.valueToDisplayValue(this.min),this.valueToDisplayValue(this.max),this.sliderWrapperEl.getBoundingClientRect(),function(t){t=e.displayValueToValue(t),e.setValue(s.BB.clamp(t,e.min,e.max)),e.onChange(e.value)},function(){(0,c.css)(e.sliderWrapperEl,{display:""}),e.manualInput&&(e.manualInput.getElement().remove(),e.manualInput.destroy()),e.manualInput=void 0},this.manualInputRoundDigits&&this.manualInputRoundDigits>0?this.manualInputRoundDigits:0),this.manualInput.setIsEnabled(this.isEnabled),this.rootEl.append(this.manualInput.getElement()),setTimeout(function(){e.manualInput&&e.manualInput.focus()}),(0,c.css)(this.sliderWrapperEl,{display:"none"})}},{key:"changeSliderValue",value:function(e){if(this.isEnabled){var t=this.valueToSliderValue(this.value);t=s.BB.clamp(t+e,0,1),this.value=this.sliderValueToValue(t),this.updateLabel(),this.onChange(this.value)}}},{key:"setValue",value:function(e){this.value=s.BB.clamp(e,this.min,this.max),this.updateLabel()}},{key:"getValue",value:function(){return this.value}},{key:"getDisplayValue",value:function(){return this.valueToDisplayValue(this.value)}},{key:"update",value:function(e){if(this.min=e.min,this.max=e.max,this.useSpline=!!e.curve,this.useSpline){if(!e.curve)throw Error("curve needs to be set if useSpline true");var t="quadratic"===e.curve?s.BB.powerSplineInput(this.min,this.max,.1):e.curve;this.splineInterpolator=new s.BB.SplineInterpolator(t)}else this.splineInterpolator=void 0;this.setIsEnabled(!e.isDisabled)}},{key:"setIsEnabled",value:function(e){this.isEnabled=e,this.updateEnable()}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){clearTimeout(this.pointerListenerTimeout),this.pointerListener&&this.pointerListener.destroy(),this.manualInput&&this.manualInput.destroy(),this.emitInterval&&clearInterval(this.emitInterval)}}]),e}()}),s("11glk",function(t,i){e(t.exports,"calcSliderFalloffFactor",function(){return n});function n(e,t){var i=Math.min(10,1+Math.pow(Math.floor(e/50),2));return t&&(i*=2),1/i}}),s("869o9",function(t,i){e(t.exports,"KlSliderManualInput",function(){return h});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("dJPtW"),l=o("7jh4K"),h=function(){"use strict";function e(t,i,r,o,h,c,u){var p,d=this;(0,n._)(this,e),this.onChange=h,this.onClose=c,this.isEnabled=!0,this.isClosed=!1,this.input=(0,a.input)({type:"number",init:t,min:i,max:r,callback:function(e){d.emit()}}),0!==u&&this.input.setAttribute("step","any"),this.input.onblur=function(){d.privateOnClose()},this.input.addEventListener("keyup",function(e){["Enter","Escape"].includes(e.key)?d.privateOnClose():d.emit()},{passive:!1}),this.input.addEventListener("wheel",function(){return d.emit()},{passive:!1}),this.scrollBefore={x:window.scrollX,y:window.scrollY},p=u||0===u?s.BB.round(t,u):t,this.lastValue=p,this.input.value=""+p,(0,l.css)(this.input,{width:o.width+"px",height:o.height+"px"})}return(0,r._)(e,[{key:"emit",value:function(){this.lastValue!==Number(this.input.value)&&(this.onChange(Number(this.input.value)),this.lastValue=Number(this.input.value))}},{key:"privateOnClose",value:function(){var e=this;this.isClosed||(this.isClosed=!0,this.emit(),this.onClose(),setTimeout(function(){e.scrollBefore&&window.scrollTo(e.scrollBefore.x,e.scrollBefore.y),e.scrollBefore=void 0}))}},{key:"getElement",value:function(){return this.input}},{key:"setIsEnabled",value:function(e){this.isEnabled=e}},{key:"focus",value:function(){this.input.focus(),this.input.select()}},{key:"destroy",value:function(){s.BB.destroyEl(this.input)}}]),e}()}),s("lfHl9",function(i,n){e(i.exports,"HexColorDialog",function(){return d});var r=o("cx0mh"),s=o("eWjiX"),a=o("dJPtW"),l=o("2MaaK"),h=o("1mH1z"),c=o("envwp"),u=o("amum4"),p=o("8TnVb"),d=function e(i){"use strict";(0,r._)(this,e);var n=function(e,t){var i=(0,a.input)({init:o[t],min:0,max:255,type:"number",css:{width:"80px"},callback:function(){if(""===i.value||0>parseFloat(i.value)||parseFloat(i.value)>255)return void n.update();i.value=""+Math.round(parseFloat(i.value)),o[t]=Number(i.value),d.style.background="#"+s.BB.ColorConverter.toHexString(o),f.value="#"+s.BB.ColorConverter.toHexString(o)}}),n={update:function(){i.value=""+o[t]},destroy:function(){s.BB.unsetEventHandler(i,"onchange")},element:(0,u.c)("tr",[(0,u.c)("td,pr-10",e),(0,u.c)("td",[i])])};return n},o=new s.BB.RGB(i.color.r,i.color.g,i.color.b),d=s.BB.el({css:{width:"20px",height:"20px",marginBottom:"10px",boxShadow:"inset 0 0 0 1px #fff, 0 0 0 1px #000",background:"#"+s.BB.ColorConverter.toHexString(o)}}),g=s.BB.el({content:(0,h.LANG)("mci-hex")}),f=(0,a.input)({init:"#"+s.BB.ColorConverter.toHexString(o),css:{width:"80px"},callback:function(){var e=s.BB.ColorConverter.hexToRGB(f.value);e?o=e:(e=o,f.value="#"+s.BB.ColorConverter.toHexString(o)),d.style.background="#"+s.BB.ColorConverter.toHexString(e);for(var t=0;t<y.length;t++)y[t].update()}}),v=s.BB.el({tagName:"button",content:'<img src="'+t(c)+'" height="20" alt=""/>',title:(0,h.LANG)("mci-copy"),onClick:function(){f.select(),navigator.clipboard.writeText(f.value).then().catch()}}),m=(0,u.c)({css:{display:"flex",alignItems:"center",marginBottom:"15px",flexWrap:"wrap",gap:"5px 10px",maxWidth:"250px"}},[g,(0,u.c)(",flex,items-center,gap-10",[f,v])]);setTimeout(function(){f.focus(),f.select()},0);var y=[n((0,h.LANG)("red"),"r"),n((0,h.LANG)("green"),"g"),n((0,h.LANG)("blue"),"b")],x=(0,u.c)("",[d,m,(0,u.c)("table."+p.table,[(0,u.c)("tbody",y.map(function(e){return e.element}))])]);(0,l.showModal)({target:document.body,message:`<b>${(0,h.LANG)("manual-color-input")}</b>`,div:x,autoFocus:!1,clickOnEnter:"Ok",buttons:["Ok","Cancel"],callback:function(e){s.BB.destroyEl(v),y.forEach(function(e){return e.destroy()}),y.splice(0,y.length),i.onClose("Ok"===e?s.BB.ColorConverter.hexToRGB(f.value):void 0)}})}}),s("envwp",function(e,t){e.exports=i("la7yv")}),s("amum4",function(t,i){e(t.exports,"c",function(){return a});var n=o("bX4ja"),r=o("72Jv0"),s=o("7jh4K");function a(e,t){if(void 0===e)return document.createElement("div");if("string"!=typeof e)return e instanceof HTMLElement||(e=(0,r.el)(e)),t&&("string"==typeof t?e.innerHTML=t:(h=e).append.apply(h,(0,n._)(t))),e;var i,o,a,l,h,c,u=function(e){if(""===e)return{};var t,i,n=[];1===(t=e.split(".")).length?i=(t=t[0].split(",")).shift():(i=t.shift(),t.forEach(function(e,i){if(i===t.length-1){var r=(t=e.split(",")).shift();void 0!==r&&n.push(r)}else n.push(e)}));var r={};return""!==i&&(r.tagName=i),n.length>0&&(r.classes=n),t.length>0&&(r.styles=t),r}(e),p=document.createElement(null!=(c=u.tagName)?c:"div");return u.classes&&(l=p.classList).add.apply(l,(0,n._)(u.classes)),u.styles&&(i=u.styles,o={},a={c:function(e){o.color=e[0]},bg:function(e){o.background=e[0]},p:function(e){o.padding=e[0]+"px"},py:function(e){o.paddingTop=e[0]+"px",o.paddingBottom=e[0]+"px"},pt:function(e){o.paddingTop=e[0]+"px"},pr:function(e){o.paddingRight=e[0]+"px"},pb:function(e){o.paddingBottom=e[0]+"px"},pl:function(e){o.paddingLeft=e[0]+"px"},mt:function(e){o.marginTop=e[0]+"px"},mr:function(e){o.marginRight=e[0]+"px"},mb:function(e){o.marginBottom=e[0]+"px"},ml:function(e){o.marginLeft=e[0]+"px"},flex:function(){o.display="flex"},flexCol:function(){o.flexDirection="column"},flexWrap:function(){o.flexWrap="wrap"},gap:function(e){o.gap=e.map(function(e){return e+"px"}).join(" ")},grow:function(){o.flexGrow="1"},justify:function(e){o.justifyContent=e[0]},items:function(e){o.alignItems=e[0]},hidden:function(){o.display="none"},nowrap:function(){o.whiteSpace="nowrap"},abs:function(e){o.position="absolute",o.left=e[0]+"px",o.top=e[1]+"px"},w:function(e){o.width="full"===e[0]?"100%":e[0]+"px"},h:function(e){o.height="full"===e[0]?"100%":e[0]+"px"},minh:function(e){o.minHeight=e[0]+"px"},z:function(e){o.zIndex=e[0]},overflow:function(e){o.overflow=e[0]},pos:function(e){o.position=e[0]},left:function(e){o.left="full"===e[0]?"100%":e[0]+"px"},top:function(e){o.top="full"===e[0]?"100%":e[0]+"px"},right:function(e){o.right="full"===e[0]?"100%":e[0]+"px"},bottom:function(e){o.bottom="full"===e[0]?"100%":e[0]+"px"},size:function(e){o.fontSize=e[0]+"px"},pointer:function(e){o.pointerEvents=e[0]}},i.forEach(function(e){var t=e.split("-");a[t.shift()](t)}),(0,s.css)(p,o)),t&&("string"==typeof t?p.innerHTML=t:p.append.apply(p,(0,n._)(t))),p}}),s("8TnVb",function(t,i){var n;e(t.exports,"table",function(){return n},function(e){return n=e}),n="_7-bVqq_table"}),s("fg9Sv",function(i,n){e(i.exports,"KlColorSlider",function(){return g});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("lfHl9"),h=o("11glk"),c=o("h37GB"),u=o("1mH1z"),p=o("fohxs"),d=o("7jh4K"),g=function(){"use strict";function e(i){var n=this;(0,r._)(this,e),this.rootEl=a.BB.el({className:"kl-color-picker",css:{position:"relative"}}),this.outputDiv=a.BB.el({css:{display:"flex",alignItems:"center"}}),this.width=i.width,this.svHeight=i.svHeight,this.height=i.height,this.emitColor=i.onPick,this.onEyedropper=i.onEyedropper,this.primaryColorRgb={r:parseInt(""+i.startValue.r),g:parseInt(""+i.startValue.g),b:parseInt(""+i.startValue.b)},this.primaryColorHsv=a.BB.ColorConverter.toHSV(i.startValue),this.secondaryColorRgb={r:p.ERASE_COLOR,g:p.ERASE_COLOR,b:p.ERASE_COLOR},this.secondaryColorHsv=a.BB.ColorConverter._RGBtoHSV(this.secondaryColorRgb);var o=a.BB.el();this.svGradient=a.BB.el({css:{background:"linear-gradient(0deg, #000 0%, rgba(255, 0, 0, 0) 100%), linear-gradient(-90deg, var(--kl-color-picker--hue) 0%, #fff 100%)",width:this.width+"px",height:this.svHeight+"px"}}),o.append(this.svGradient);var s=a.BB.el({className:"kl-color-picker__h",css:{overflow:"hidden",position:"relative",width:this.width+"px",height:this.height+"px",cursor:"ew-resize",marginTop:"1px",marginBottom:"1px"}});this.divPreview=a.BB.el({className:"kl-color-picker__preview",css:{display:"flex",justifyContent:"space-between",width:2.5*this.height+"px",height:this.height+"px"}}),this.controlH=a.BB.el();var g=function(e){var t=new Image;(0,d.css)(t,{position:"absolute",left:"0",top:"0",display:"none",pointerEvents:"none"});for(var i=a.BB.canvas(n.width,n.height),r=a.BB.ctx(i),o=r.createLinearGradient(0,0,n.width,0),s=0;s<1;s+=.01){var l=a.BB.ColorConverter.toRGB(new a.BB.HSV(360*s,100,100)),h=parseInt(""+l.r).toString(16),c=parseInt(""+l.g).toString(16),u=parseInt(""+l.b).toString(16);1===h.length&&(h="0"+h),1===c.length&&(c="0"+c),1===u.length&&(u="0"+u),o.addColorStop(s,"#"+h+c+u)}r.fillStyle=o,r.fillRect(0,0,n.width,n.height),e.append(t),t.alt="hue",t.src=i.toDataURL("image/png"),t.style.display="block"};this.updateSVCanvas(),this.rootEl.style.width=this.width+"px",this.rootEl.oncontextmenu=function(){return!1},this.SVContainer=a.BB.el({className:"kl-color-picker__sv",css:{width:this.width+"px",height:this.svHeight+"px",overflow:"hidden",display:"block",position:"relative",cursor:"crosshair"}}),this.pointerSV=a.BB.el({css:{width:"12px",height:"12px",borderRadius:"6px",position:"absolute",pointerEvents:"none",boxShadow:"0px 0px 0 1px #000, inset 0px 0px 0 1px #fff"}}),this.SVContainer.append(o,this.pointerSV),this.updateSVPointer(),this.rootEl.append(this.SVContainer,s),this.outputDiv.append(this.divPreview),(0,d.css)(this.controlH,{width:"2px",height:this.height+"px",background:"#000",borderLeft:"1px solid #fff",position:"absolute",top:"0",left:parseInt(""+(this.primaryColorHsv.h/360*this.width-1))+"px"});var f={h:0,s:0,v:0};this.pickerButton=a.BB.el({title:(0,u.LANG)("eyedropper")+" [Alt]",className:"color-picker-preview-button",css:{width:"30px",height:"30px",backgroundImage:"url("+t(c)+")",backgroundRepeat:"no-repeat",backgroundSize:"70%",backgroundPosition:"center"},onClick:function(){n.isPicking?n.setIsEyedropping(!1):(n.pickerButton.classList.remove("color-picker-preview-button-hover"),n.pickerButton.classList.add("color-picker-preview-button-active"),n.isPicking=!0,n.onEyedropper(!0))}}),this.isPicking=!1,new a.BB.PointerListener({target:this.pickerButton,onEnterLeave:function(e){n.isPicking||n.pickerButton.classList.toggle("color-picker-preview-button-hover",e)}}),this.divPreview.append(this.pickerButton),this.hexButton=a.BB.el({content:"#",className:"color-picker-preview-button",title:(0,u.LANG)("manual-color-input"),css:{height:"100%",width:this.height+"px",lineHeight:this.height+"px",fontSize:.65*this.height+"px"},onClick:function(){new(0,l.HexColorDialog)({color:new a.BB.RGB(n.primaryColorRgb.r,n.primaryColorRgb.g,n.primaryColorRgb.b),onClose:function(e){e&&(n.setColor(e),n.emitColor(new a.BB.RGB(n.primaryColorRgb.r,n.primaryColorRgb.g,n.primaryColorRgb.b)))}})}}),new a.BB.PointerListener({target:this.hexButton,onEnterLeave:function(e){n.hexButton.classList.toggle("color-picker-preview-button-hover",e)}}),this.divPreview.append(this.hexButton),this.setColPreview(),setTimeout(function(){g(s),s.append(n.controlH),new a.BB.PointerListener({target:o,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(a.BB.unfocusAnyInput(),n.SVContainer.classList.toggle("kl-color-picker--active",!0),"left"===e.button?(f.s=e.relX/n.width*100,f.v=100-e.relY/n.svHeight*100,n.primaryColorHsv=new a.BB.HSV(n.primaryColorHsv.h,f.s,f.v),n.primaryColorRgb=a.BB.ColorConverter.toRGB(n.primaryColorHsv),n.updateSVPointer(),n.setColPreview(),n.emitColor(a.BB.ColorConverter.toRGB(n.primaryColorHsv))):(f.s=n.primaryColorHsv.s,f.v=n.primaryColorHsv.v)),"pointermove"===e.type&&["left","right"].includes(e.button||"")){var t=1;"right"===e.button&&(t=.5),f.s+=e.dX/n.width*100*t,f.v-=e.dY/n.svHeight*100*t,n.primaryColorHsv=new a.BB.HSV(n.primaryColorHsv.h,f.s,f.v),n.primaryColorRgb=a.BB.ColorConverter.toRGB(n.primaryColorHsv),n.updateSVPointer(),n.setColPreview(),n.emitColor(a.BB.ColorConverter.toRGB(n.primaryColorHsv))}"pointerup"===e.type&&n.SVContainer.classList.toggle("kl-color-picker--active",!1)}}),new a.BB.PointerListener({target:s,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(a.BB.unfocusAnyInput(),s.classList.toggle("kl-color-picker--active",!0),"left"===e.button?(f.h=e.relX/n.width*359.99,n.primaryColorHsv=new a.BB.HSV(f.h,n.primaryColorHsv.s,n.primaryColorHsv.v),n.primaryColorRgb=a.BB.ColorConverter.toRGB(n.primaryColorHsv),n.controlH.style.left=Math.round(n.primaryColorHsv.h/359.99*n.width)-1+"px",n.updateSVCanvas(),n.setColPreview(),n.emitColor(a.BB.ColorConverter.toRGB(n.primaryColorHsv))):f.h=n.primaryColorHsv.h),"pointermove"===e.type&&["left","right"].includes(e.button||"")){var t=Math.abs(e.pageY-e.downPageY),i=(0,h.calcSliderFalloffFactor)(t,"right"===e.button);f.h+=e.dX/n.width*359.99*i,"right"===e.button&&(f.h=f.h%359.99,f.h<0&&(f.h+=359.99)),f.h=Math.min(359.99,f.h),n.primaryColorHsv=new a.BB.HSV(f.h,n.primaryColorHsv.s,n.primaryColorHsv.v),n.primaryColorRgb=a.BB.ColorConverter.toRGB(n.primaryColorHsv),n.controlH.style.left=Math.round(n.primaryColorHsv.h/359.99*n.width)-1+"px",n.updateSVCanvas(),n.setColPreview(),n.emitColor(a.BB.ColorConverter.toRGB(n.primaryColorHsv))}"pointerup"===e.type&&s.classList.toggle("kl-color-picker--active",!1)}})},1),this.secondaryColorBtn=a.BB.el({parent:this.outputDiv,title:(0,u.LANG)("secondary-color")+" [X]",className:"kl-color-picker__secondary",css:{cursor:"pointer",marginLeft:"5px",width:"22px",height:"22px"},onClick:function(e){e.preventDefault(),n.swapColors()}}),this.updateSecondaryColor()}return(0,s._)(e,[{key:"updatePrimaryHSV",value:function(e){0===e.s?this.primaryColorHsv=new a.BB.HSV(this.primaryColorHsv.h,e.s,e.v):this.primaryColorHsv=new a.BB.HSV(e.h,e.s,e.v)}},{key:"updateSVCanvas",value:function(){var e=a.BB.ColorConverter.toRGB(new a.BB.HSV(this.primaryColorHsv.h,100,100));this.svGradient.style.setProperty("--kl-color-picker--hue","#"+a.BB.ColorConverter.toHexString(e))}},{key:"updateSVPointer",value:function(){var e=this.primaryColorHsv.s/100*this.width-7,t=(1-this.primaryColorHsv.v/100)*this.svHeight-6;(0,d.css)(this.pointerSV,{left:e+"px",top:t+"px"})}},{key:"setColPreview",value:function(){this.divPreview.style.backgroundColor="rgb("+this.primaryColorRgb.r+","+this.primaryColorRgb.g+","+this.primaryColorRgb.b+")",a.BB.testIsWhiteBestContrast(this.primaryColorRgb)?((0,d.css)(this.pickerButton,{filter:"invert(1)"}),(0,d.css)(this.hexButton,{filter:"invert(1)"})):((0,d.css)(this.pickerButton,{filter:""}),(0,d.css)(this.hexButton,{filter:""}))}},{key:"updateSecondaryColor",value:function(){this.secondaryColorBtn.style.backgroundColor=a.BB.ColorConverter.toRgbStr(this.secondaryColorRgb)}},{key:"setColor",value:function(e){this.primaryColorRgb={r:parseInt(""+e.r),g:parseInt(""+e.g),b:parseInt(""+e.b)},this.updatePrimaryHSV(a.BB.ColorConverter.toHSV(e)),this.controlH.style.left=parseInt(""+(this.primaryColorHsv.h/359*this.width-1))+"px",this.updateSVCanvas(),this.updateSVPointer(),this.setColPreview()}},{key:"getColor",value:function(){return new a.BB.RGB(this.primaryColorRgb.r,this.primaryColorRgb.g,this.primaryColorRgb.b)}},{key:"getSecondaryRGB",value:function(){return new a.BB.RGB(this.secondaryColorRgb.r,this.secondaryColorRgb.g,this.secondaryColorRgb.b)}},{key:"getIsEyedropping",value:function(){return this.isPicking}},{key:"setIsEyedropping",value:function(e){e?(this.isPicking=!0,this.onEyedropper(!0),this.pickerButton.classList.add("color-picker-preview-button-active")):(this.isPicking=!1,this.onEyedropper(!1),this.pickerButton.classList.remove("color-picker-preview-button-active"))}},{key:"enable",value:function(e){var t={pointerEvents:e?"":"none",opacity:e?"1":"0.5"};(0,d.css)(this.rootEl,t),(0,d.css)(this.outputDiv,t)}},{key:"setHeight",value:function(e){(e=parseInt(""+(e-2*this.height-3),10))!==this.svHeight&&(this.svHeight=e,(0,d.css)(this.svGradient,{width:this.width+"px",height:this.svHeight+"px"}),this.SVContainer.style.height=this.svHeight+"px",this.updateSVPointer())}},{key:"swapColors",value:function(){var e=this.secondaryColorHsv;this.secondaryColorHsv=this.primaryColorHsv,this.updatePrimaryHSV(e),e=this.secondaryColorRgb,this.secondaryColorRgb=this.primaryColorRgb,this.primaryColorRgb=e,this.controlH.style.left=parseInt(""+(this.primaryColorHsv.h/359*this.width-1))+"px",this.updateSVCanvas(),this.updateSVPointer(),this.setColPreview(),this.updateSecondaryColor(),this.emitColor(new a.BB.RGB(this.primaryColorRgb.r,this.primaryColorRgb.g,this.primaryColorRgb.b))}},{key:"getElement",value:function(){return this.rootEl}},{key:"getOutputElement",value:function(){return this.outputDiv}}]),e}()}),s("h37GB",function(e,t){e.exports=i("cTtMO")}),s("fohxs",function(t,i){e(t.exports,"ERASE_COLOR",function(){return n}),e(t.exports,"getEraseColor",function(){return r});var n=(o("1C8RU").THEME.isDark(),255);function r(){return{r:n,g:n,b:n}}}),s("gmji4",function(t,i){e(t.exports,"KlColorSliderSmall",function(){return h});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("11glk"),l=o("7jh4K"),h=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.rootEl=s.BB.el({css:{width:t.width+"px",position:"relative",overflow:"hidden",userSelect:"none"}}),this.rootEl.oncontextmenu=function(e){e.preventDefault()},this.color=s.BB.ColorConverter.toHSV(new s.BB.RGB(t.color.r,t.color.g,t.color.b)),this.width=t.width,this.heightSV=t.heightSV,this.canvasSV=s.BB.canvas(10,10),(0,l.css)(this.canvasSV,{width:this.width+"px",height:this.heightSV+"px",cursor:"crosshair"}),this.updateSV();var r=s.BB.canvas(t.width,t.heightH);r.style.cursor="ew-resize";for(var o=s.BB.ctx(r),h=o.createLinearGradient(0,0,t.width,0),c=0;c<1;c+=.01){var u=s.BB.ColorConverter.toRGB(new s.BB.HSV(360*c,100,100));h.addColorStop(c,"rgba("+parseInt(""+u.r)+", "+parseInt(""+u.g)+", "+parseInt(""+u.b)+", 1)")}o.fillStyle=h,o.fillRect(0,0,t.width,t.heightH),(0,l.css)(this.canvasSV,{width:t.width+"px",height:t.heightSV+"px",overflow:"hidden",position:"relative"}),this.canvasSV.style.cssFloat="left",r.style.cssFloat="left",this.rootEl.append(this.canvasSV,r),this.pointerSV=s.BB.el({parent:this.rootEl,css:{width:"8px",height:"8px",borderRadius:"8px",position:"absolute",pointerEvents:"none",boxShadow:"0 0 0 1px #000, inset 0 0 0 1px #fff"}}),this.pointerH=s.BB.el({parent:this.rootEl,css:{width:"0",height:t.heightH+"px",borderLeft:"1px solid #fff",borderRight:"1px solid #000",position:"absolute",top:t.heightSV+"px",pointerEvents:"none"}}),this.updateSVPointer(),this.updateHPointer();var p={h:0,s:0,v:0};this.svPointerId=null,this.svPointerListener=new s.BB.PointerListener({target:this.canvasSV,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(s.BB.unfocusAnyInput(),i.svPointerId=e.pointerId,"left"===e.button?(p.s=e.relX/t.width*100,p.v=100-e.relY/t.heightSV*100,i.color=new s.BB.HSV(i.color.h,p.s,p.v),i.updateSVPointer(),t.callback(s.BB.ColorConverter.toRGB(i.color))):(p.s=i.color.s,p.v=i.color.v)),"pointermove"===e.type&&["left","right"].includes(""+e.button)&&i.svPointerId===e.pointerId){var n=1;"right"===e.button&&(n=.5),p.s+=e.dX/t.width*100*n,p.v-=e.dY/t.heightSV*100*n,i.color=new s.BB.HSV(i.color.h,p.s,p.v),i.updateSVPointer(),t.callback(s.BB.ColorConverter.toRGB(i.color))}"pointerup"===e.type&&(i.svPointerId=null)}}),this.hPointerId=null,this.hPointerListener=new s.BB.PointerListener({target:r,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(i.hPointerId=e.pointerId,"left"===e.button?(p.h=e.relX/t.width*359.99,i.color=new s.BB.HSV(p.h,i.color.s,i.color.v),i.updateSV(),i.updateHPointer(),t.callback(s.BB.ColorConverter.toRGB(i.color))):p.h=i.color.h),"pointermove"===e.type&&["left","right"].includes(""+e.button)&&i.hPointerId===e.pointerId){var n=Math.abs(e.pageY-e.downPageY),r=(0,a.calcSliderFalloffFactor)(n,"right"===e.button);p.h+=e.dX/t.width*359.99*r,"right"===e.button&&(p.h=p.h%359.99,p.h<0&&(p.h+=359.99)),p.h=Math.min(359.99,p.h),i.color=new s.BB.HSV(p.h,i.color.s,i.color.v),i.updateSV(),i.updateHPointer(),t.callback(s.BB.ColorConverter.toRGB(i.color))}"pointerup"===e.type&&(i.hPointerId=null)}}),s.BB.el({parent:this.rootEl,css:{clear:"both"}})}return(0,r._)(e,[{key:"updateSV",value:function(){var e=s.BB.ctx(this.canvasSV);if(!e)throw Error("couldn't create canvas");for(var t=0;t<this.canvasSV.height;t+=1){var i=e.createLinearGradient(0,0,this.canvasSV.width,0),n=s.BB.ColorConverter.toRGB(new s.BB.HSV(this.color.h,1,100-t/this.canvasSV.height*100)),r=s.BB.ColorConverter.toRGB(new s.BB.HSV(this.color.h,100,100-t/this.canvasSV.height*100));i.addColorStop(0,"#"+s.BB.ColorConverter.toHexString(n)),i.addColorStop(1,"#"+s.BB.ColorConverter.toHexString(r)),e.fillStyle="#ff0000",e.fillStyle=i,e.fillRect(0,t,this.canvasSV.width,1)}}},{key:"updateSVPointer",value:function(){var e=this.color.s/100*this.width-4,t=(1-this.color.v/100)*this.heightSV-4;(0,l.css)(this.pointerSV,{left:e+"px",top:t+"px"})}},{key:"updateHPointer",value:function(){this.pointerH.style.left=this.color.h/359.999*this.width-1+"px"}},{key:"setColor",value:function(e){null===this.hPointerId&&null===this.svPointerId&&(this.color=s.BB.ColorConverter.toHSV(new s.BB.RGB(e.r,e.g,e.b)),this.updateSV(),this.updateSVPointer(),this.updateHPointer())}},{key:"getColor",value:function(){return s.BB.ColorConverter.toRGB(this.color)}},{key:"getElement",value:function(){return this.rootEl}},{key:"end",value:function(){this.svPointerId=null,this.hPointerId=null}},{key:"destroy",value:function(){this.svPointerListener.destroy(),this.hPointerListener.destroy()}}]),e}()}),s("j5jvd",function(t,i){e(t.exports,"PointSlider",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){var i,r,o,l=this;(0,n._)(this,e),this.rootEl=s.BB.el({css:{position:"relative"}}),s.BB.el({parent:this.rootEl,className:"kl-point-slider__line",css:{marginTop:parseInt(""+(t.pointSize/2-1))+"px",width:t.width+"px"}}),this.sliderPoint=s.BB.el({parent:this.rootEl,className:"kl-point-slider__point"}),s.BB.el({parent:this.sliderPoint,css:{margin:"-7px 0 0 -7px",width:"calc(100% + 14px)",height:"calc(100% + 7px)"}});var h=function(){(0,a.css)(l.sliderPoint,{left:i+"px"})},c=function(){return i/(t.width-t.pointSize)};i=s.BB.clamp(t.init*(t.width-t.pointSize),0,t.width-t.pointSize),(0,a.css)(this.sliderPoint,{width:t.pointSize+"px",height:t.pointSize+"px",borderRadius:t.pointSize+"px"}),h(),this.pointerListener=new s.BB.PointerListener({target:this.sliderPoint,fixScribble:!0,onPointer:function(e){"pointerdown"===e.type&&"left"===e.button?(r=!0,o=i,h(),e.eventStopPropagation()):"pointermove"===e.type&&"left"===e.button&&(e.eventStopPropagation(),o+=e.dX,i=parseInt(""+s.BB.clamp(o,0,t.width-t.pointSize)),h(),t.callback(c(),r,!1),r=!1),"pointerup"===e.type&&(e.eventStopPropagation(),h(),t.callback(c(),!1,!0))}})}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setActive",value:function(e){this.sliderPoint.style.backgroundColor=e?"#fff":"#eaeaea"}},{key:"destroy",value:function(){this.pointerListener.destroy()}}]),e}()}),s("43qNf",function(t,i){e(t.exports,"ColorOptions",function(){return u});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("4EWN2"),l=o("eWjiX"),h=o("dJ1E2"),c=o("amum4"),u=function(){"use strict";function e(t){var i,r=this;(0,n._)(this,e),this.colorArr=[],this.selectedIndex=0,this.rootEl=l.BB.el({content:t.label?t.label:"",title:null!=(i=t.title)?i:void 0,css:(0,s._)({display:"flex",alignItems:"center",gap:"7px",position:"relative"},t.css)}),this.buttonArr=[],this.onColorInputChange=function(){var e=r.selectedIndex,i=r.colorArr[e];if(i&&!(i.a<1)){var n=r.colorInput.value;r.buttonArr[r.selectedIndex].el.style.backgroundColor=n,r.colorArr[e]=(0,a._)((0,s._)({},h.ColorConverter.hexToRGB(n)),{a:1}),t.onChange(r.colorArr[e])}},this.colorInput=l.BB.el({tagName:"input",custom:{type:"color",tabIndex:"-1"}}),this.colorInput.onchange=this.onColorInputChange,this.colorInput.oninput=this.onColorInputChange;for(var o=0;o<t.colorArr.length;o++){for(var u=t.colorArr[o],p=!1,d=0;d<this.colorArr.length;d++){var g=this.colorArr[d];if(g===u||null!==g&&null!==u&&g.r===u.r&&g.g===u.g&&g.b===u.b&&g.a===u.a){p=!0;break}}!p&&(this.colorArr.push(u),"initialIndex"in t&&t.initialIndex===o&&(this.selectedIndex=this.colorArr.length-1))}for(var f=0;f<this.colorArr.length;f++)!function(e){var i=r.colorArr[e],n=l.BB.el({parent:r.rootEl,content:i?"":"X",className:"kl-color-option",css:{width:"22px",height:"22px",backgroundColor:i?l.BB.ColorConverter.toRgbaStr(i):"transparent",lineHeight:"23px"},onClick:function(n){if(r.selectedIndex===e){i&&1===i.a&&(r.colorInput.showPicker?r.colorInput.showPicker():r.colorInput.click());return}n.preventDefault(),r.selectedIndex=e,v(),t.onChange(r.colorArr[e])}});i&&0===i.a&&(n.style.background="var(--kl-checkerboard-background)");var o=function(e){n.classList.toggle("kl-color-option--active",e)};r.buttonArr.push({el:n,setIsSelected:o})}(f);this.rootEl.append((0,c.c)(",w-0,h-0,overflow-hidden,abs-0-0",[this.colorInput]));var v=function(){for(var e=0;e<r.buttonArr.length;e++)r.buttonArr[e].setIsSelected(e===r.selectedIndex)};v()}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.colorArr[this.selectedIndex]}},{key:"destroy",value:function(){this.rootEl.remove(),this.buttonArr.forEach(function(e){l.BB.destroyEl(e.el)}),this.buttonArr.splice(0,this.buttonArr.length),this.colorInput.onchange=null,this.colorInput.oninput=null}}]),e}()}),s("iFIyy",function(t,i){e(t.exports,"Options",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.rootEl=s.BB.el({css:t.css});var r=s.BB.el({parent:this.rootEl,className:"kl-option-wrapper",css:{display:"flex",flexDirection:t.isColumn?"column":"row"}});t.onChange&&(this.onChange=t.onChange),this.optionArr=[],this.selectedId="initialId"in t&&void 0!==t.initId?t.initId:t.optionArr[0].id;for(var o=0;o<t.optionArr.length;o++)!function(e){var n=["kl-option"];t.isSmall&&n.push("kl-option--small"),"string"!=typeof e.label&&(n.push("kl-option--custom-el"),(0,a.css)(e.label,{display:"block",pointerEvents:"none"}));var o={id:e.id,el:s.BB.el({parent:r,content:e.label,className:n.join(" "),onClick:function(){i.selectedId!==o.id&&(!t.onBeforeChange||t.onBeforeChange(o.id))&&(i.selectedId=o.id,i.update(),i.onChange&&i.onChange(i.selectedId))},css:t.optionCss})};e.title&&(o.el.title=e.title),i.optionArr.push(o)}(t.optionArr[o]);this.update(),t.changeOnInit&&setTimeout(function(){i.onChange&&i.onChange(i.selectedId)},0)}return(0,r._)(e,[{key:"getIndex",value:function(){for(var e=0;e<this.optionArr.length;e++)if(this.optionArr[e].id===this.selectedId)return e;return -1}},{key:"update",value:function(){for(var e=0;e<this.optionArr.length;e++)this.optionArr[e].el.classList.toggle("kl-option-selected",this.optionArr[e].id===this.selectedId)}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.selectedId}},{key:"next",value:function(){this.selectedId=this.optionArr[(this.getIndex()+1)%this.optionArr.length].id,this.update(),this.onChange&&this.onChange(this.selectedId)}},{key:"setValue",value:function(e,t){this.selectedId!==e&&(this.selectedId=e,this.update(),!t&&this.onChange&&this.onChange(this.selectedId))}},{key:"previous",value:function(){this.selectedId=this.optionArr[(this.optionArr.length+this.getIndex()-1)%this.optionArr.length].id,this.update(),this.onChange&&this.onChange(this.selectedId)}},{key:"destroy",value:function(){this.rootEl.remove(),this.optionArr.forEach(function(e){s.BB.destroyEl(e.el)}),this.optionArr.splice(0,this.optionArr.length)}}]),e}()}),s("bmB93",function(i,n){e(i.exports,"StatusOverlay",function(){return c});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("eSmPZ"),h=o("7jh4K"),c=function(){"use strict";function e(){(0,r._)(this,e),this.isWide=!1,this.uiState="right",this.el=a.BB.el({className:"top-overlay g-root",onClick:a.BB.handleClick}),this.updateUiState(),this.innerEl=a.BB.el({className:"top-overlay--inner"}),this.angleIm=new Image,this.angleIm.src=t(l),(0,h.css)(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginLeft:"5px",borderRadius:"10px"}),this.innerInnerEl=document.createElement("div"),this.innerInnerEl.style.display="inline-block",this.innerEl.append(this.innerInnerEl,this.angleIm),this.el.append(this.innerEl),document.body.append(this.el),this.el.style.display="none"}return(0,s._)(e,[{key:"updateUiState",value:function(){"left"===this.uiState?this.el.style.left="271px":this.el.style.removeProperty("left")}},{key:"setWide",value:function(e){this.isWide=e,this.el&&(this.isWide?(this.el.style.width="100%",this.el.style.left=""):(this.el.style.removeProperty("width"),this.el.style.left="left"===this.uiState?"271px":""))}},{key:"setUiState",value:function(e){this.uiState=e,this.updateUiState()}},{key:"out",value:function(e,t){var i=this;"string"==typeof e?(this.angleIm.style.display="none",this.innerInnerEl.style.removeProperty("font-family"),this.innerInnerEl.innerHTML=e):"transform"===e.type?(this.angleIm.style.display="inline-block",this.angleIm.style.transform="rotate("+e.angleDeg+"deg)",e.angleDeg%90==0?this.angleIm.style.boxShadow="inset 0 0 0 1px rgba(255, 255, 255, 0.7)":this.angleIm.style.boxShadow="",this.innerInnerEl.style.fontFamily="monospace",this.innerInnerEl.innerHTML=Math.round(100*e.scale)+"%"):this.angleIm.style.display="none",t&&(this.innerEl.style.animation="",setTimeout(function(){return i.innerEl.style.animation="topOverlayPulse 0.5s ease-out"},20),clearTimeout(this.timeout3),this.timeout3=setTimeout(function(){return i.innerEl.style.animation=""},520)),clearTimeout(this.timeout),clearTimeout(this.timeout2),this.el.style.animationName=t?"consoleInFast":"consoleIn",this.el.style.opacity="1",this.timeout=setTimeout(function(){i.el.style.opacity="0",i.el.style.animationName="consoleOut",i.timeout2=setTimeout(function(){i.el.style.display="none"},450)},1200),this.el.style.display="flex"}}]),e}()}),s("eSmPZ",function(e,t){e.exports=i("iQ1f0")}),s("hRdOL",function(i,n){e(i.exports,"CropCopy",function(){return w});var r=o("1LaJZ"),s=o("cx0mh"),a=o("7h4XF"),l=o("2gUX3"),h=o("eWjiX"),c=o("jpkXO");o("ciAU9");var u=o("kDVZW"),p=o("cdZRx"),d=o("1GsyD"),g=o("eg83P"),f=o("1mH1z"),v=o("cWGub"),m=o("gCzYB"),y=o("635F6"),x=o("eIcQa"),b=o("7jh4K"),w=function(){"use strict";function e(i){var n,r,o=this;(0,s._)(this,e),this.cropRect={x:0,y:0,width:0,height:0},this.mode="edit",this.rootEl=h.BB.el({className:"kl-edit-crop-preview",css:{position:"relative",height:i.height+"px",width:i.width+"px",overflow:"hidden"}}),i.onChange&&(this.onChange=i.onChange),this.canvas=i.canvas,i.init?this.cropRect=i.init:this.resetCrop(),this.croppedCanvas=h.BB.canvas(),this.croppedBlob={},this.croppedObjectUrl="",this.eventTarget=this.croppedCanvas,i.enableRightClickCopy&&(this.croppedImageElement=new Image,this.eventTarget=this.croppedImageElement),(0,b.css)(this.eventTarget,{height:i.height+"px",width:i.width+"px"}),this.rootEl.append(this.eventTarget),this.updateCroppedCanvas(),this.previewLayer={image:i.canvas,opacity:1,isVisible:!0,mixModeStr:"source-over",hasClipping:!1},this.preview=new(0,c.Preview)({width:i.width,height:i.height-2,project:{width:i.canvas.width,height:i.canvas.height,layers:[this.previewLayer]},hasEditMode:!0,onModeChange:function(e){o.mode=e,o.preview.getElement().style.pointerEvents="edit"===e?"none":"",o.rootEl.title="edit"===e?(0,f.LANG)("crop-drag-to-crop"):""},onTransformChange:function(){return o.updateSelectionRect()},padding:20,hasBorder:!1,editIcon:t(v)}),(0,b.css)(this.preview.getElement(),{position:"absolute",left:"0",top:"0",overflow:"hidden",pointerEvents:"none"}),this.preview.render(),this.rootEl.append(this.preview.getElement()),this.selectionRectEl=h.BB.el({parent:this.preview.getElement(),className:"kl-edit-crop-preview__sel"}),this.updateSelectionRect();var a=function(e,t){var i=(0,d.createMatrixFromTransform)(o.preview.getTransform()),n=(0,u.inverse)(i),r={x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)},s={x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)},a=(0,p.applyToPoint)(n,r),l=(0,p.applyToPoint)(n,s);return a.x=(0,g.clamp)(Math.floor(a.x),0,o.canvas.width),a.y=(0,g.clamp)(Math.floor(a.y),0,o.canvas.height),l.x=(0,g.clamp)(Math.ceil(l.x),0,o.canvas.width),l.y=(0,g.clamp)(Math.ceil(l.y),0,o.canvas.height),{x:a.x,y:a.y,width:l.x-a.x,height:l.y-a.y}},l=null,x=!1,w=!1,B=new(0,m.EventChain)({chainArr:[new(0,y.OnePointerLimiter)]});B.setChainOut(function(e){if("pointerdown"===e.type&&"left"===e.button){var t;(e.eventPreventDefault(),x=!0,n={x:e.relX,y:e.relY},!o.isReset()&&(t=n,h.BB.isInsideRect(t,o.getViewportSelectionRect())))?l={x:o.cropRect.x,y:o.cropRect.y,width:o.cropRect.width,height:o.cropRect.height}:o.cropRect=a(n,n)}else if("pointermove"===e.type&&"left"===e.button){if(e.eventPreventDefault(),w=!0,l){var i=o.preview.getTransform();o.cropRect.x=l.x+Math.round((e.relX-n.x)/i.scale),o.cropRect.y=l.y+Math.round((e.relY-n.y)/i.scale),o.cropRect.x=h.BB.clamp(o.cropRect.x,0,o.canvas.width-o.cropRect.width),o.cropRect.y=h.BB.clamp(o.cropRect.y,0,o.canvas.height-o.cropRect.height)}else o.cropRect=a(n,{x:e.relX,y:e.relY});o.updateSelectionRect()}else"pointerup"===e.type&&n&&(e.eventPreventDefault(),x=!1,l=null,n=null,0!==o.cropRect.width&&0!==o.cropRect.height&&w||(o.resetCrop(),o.updateSelectionRect()),w=!1,r=setTimeout(function(){return o.updateCroppedCanvas()},1))}),this.pointerListener=new h.BB.PointerListener({target:this.eventTarget,fixScribble:!0,onWheel:function(e){o.preview.onWheel(e)},onPointer:function(e){if("hand"===o.mode){e.eventPreventDefault(),o.preview.onPointer(e);return}B.chainIn(e)},maxPointers:2}),this.keyListener=new h.BB.KeyListener({onDown:function(e,t){if(!x){var i=!1,n=Math.max(1,1/o.preview.getTransform().scale),s=o.keyListener.isPressed("shift");"left"===e&&(s?o.cropRect.width=h.BB.clamp(o.cropRect.width-n,1,o.canvas.width-o.cropRect.x):o.cropRect.x=h.BB.clamp(o.cropRect.x-n,0,o.canvas.width-o.cropRect.width),i=!0),"right"===e&&(s?o.cropRect.width=h.BB.clamp(o.cropRect.width+n,1,o.canvas.width-o.cropRect.x):o.cropRect.x=h.BB.clamp(o.cropRect.x+n,0,o.canvas.width-o.cropRect.width),i=!0),"up"===e&&(s?o.cropRect.height=h.BB.clamp(o.cropRect.height-n,1,o.canvas.height-o.cropRect.y):o.cropRect.y=h.BB.clamp(o.cropRect.y-n,0,o.canvas.height-o.cropRect.height),i=!0),"down"===e&&(s?o.cropRect.height=h.BB.clamp(o.cropRect.height+n,1,o.canvas.height-o.cropRect.y):o.cropRect.y=h.BB.clamp(o.cropRect.y+n,0,o.canvas.height-o.cropRect.height),i=!0),i&&(t.preventDefault(),o.updateSelectionRect(),clearTimeout(r),r=setTimeout(function(){return o.updateCroppedCanvas()},100))}}})}return(0,a._)(e,[{key:"resetCrop",value:function(){this.cropRect={x:0,y:0,width:this.canvas.width,height:this.canvas.height}}},{key:"getViewportSelectionRect",value:function(){var e=this.preview.getTransform(),t=(0,d.createMatrixFromTransform)(e),i=(0,p.applyToPoint)(t,this.cropRect);return{x:i.x,y:i.y,width:this.cropRect.width*e.scale,height:this.cropRect.height*e.scale}}},{key:"updateCroppedCanvas",value:function(){return(0,r._)(function(){var e,t,i;return(0,l.__generator)(this,function(n){switch(n.label){case 0:return this.croppedCanvas.width=Math.round(this.cropRect.width),this.croppedCanvas.height=Math.round(this.cropRect.height),h.BB.ctx(this.croppedCanvas).drawImage(this.canvas,Math.round(-this.cropRect.x),Math.round(-this.cropRect.y)),[4,(0,x.canvasToBlob)(this.croppedCanvas,"image/png")];case 1:return i=n.sent(),this.croppedBlob=i,""!==this.croppedObjectUrl&&URL.revokeObjectURL(this.croppedObjectUrl),this.croppedObjectUrl=URL.createObjectURL(i),this.croppedImageElement&&(this.croppedImageElement.src=this.croppedObjectUrl),null==(e=(t=this).onChange)||e.call(t,this.croppedCanvas.width,this.croppedCanvas.height),[2]}})}).call(this)}},{key:"updateSelectionRect",value:function(){var e,t=this.getViewportSelectionRect();(0,b.css)(this.selectionRectEl,{left:t.x+"px",top:t.y+"px",width:t.width+"px",height:t.height+"px",display:this.isReset()?"none":""}),null==(e=this.onChange)||e.call(this,Math.round(this.cropRect.width),Math.round(this.cropRect.height))}},{key:"isReset",value:function(){return 0===this.cropRect.x&&0===this.cropRect.y&&this.cropRect.width===this.canvas.width&&this.cropRect.height===this.canvas.height}},{key:"getElement",value:function(){return this.rootEl}},{key:"getCropRect",value:function(){return h.BB.copyObj(this.cropRect)}},{key:"getCroppedCanvas",value:function(){return this.croppedCanvas}},{key:"getCroppedBlob",value:function(){return this.croppedBlob}},{key:"setCanvas",value:function(e){this.canvas=e,this.previewLayer.image=e,this.updateCroppedCanvas(),this.preview.render()}},{key:"destroy",value:function(){this.croppedImageElement&&(this.croppedImageElement.src=""),URL.revokeObjectURL(this.croppedObjectUrl),this.rootEl.remove(),this.eventTarget.style.removeProperty("width"),this.eventTarget.style.removeProperty("height"),this.keyListener.destroy(),this.pointerListener.destroy(),this.preview.destroy()}}]),e}()}),s("jpkXO",function(i,n){e(i.exports,"Preview",function(){return _});var r=o("cx0mh"),s=o("7h4XF"),a=o("cL71g"),l=o("4EWN2"),h=o("bX4ja"),c=o("amum4"),u=o("bMICc"),p=o("eWjiX"),d=o("04lDo"),g=o("hdxwe"),f=o("jF2Bh"),v=o("kHxqJ"),m=o("kgQ1R"),y=o("Rurc4"),x=o("gCzYB"),b=o("c1lmK"),w=o("cbARd"),B=o("63yUO"),k=o("joplQ"),S=o("1mH1z");o("ciAU9");var C=o("cdZRx"),E=o("kDVZW"),L=o("8G4G9"),I=o("lUrXo"),T=o("iFIyy"),A=o("1GsyD"),M=o("b7Uwg"),R=o("7jh4K"),_=function(){"use strict";function e(i){var n,o=this;(0,r._)(this,e),this.isReset=!0,this.doRender=!1,this.lastEmittedTransform={x:0,y:0,scale:0,angleDeg:0},this.renderLoop=function(){if(o.animationFrameId=requestAnimationFrame(o.renderLoop),o.doRender){o.doRender=!1,o.viewport.render();var e,t=o.viewport.getTransform();null==(e=o.selectionRenderer)||e.setTransform(t),o.onTransformChange&&JSON.stringify(o.lastEmittedTransform)!==JSON.stringify(t)&&(o.onTransformChange(t),o.lastEmittedTransform=t)}},this.onWheel=function(e){var t=o.viewport.getElement().getBoundingClientRect(),i=e.pageX-t.x,n=e.pageY-t.y,r=o.viewport.getTransform().scale,s=(0,B.zoomByStep)(r,-e.deltaY/2);o.transformCanvas({type:"zoom",vX:i,vY:n,fac:s/r})},this.width=i.width,this.height=i.height,this.project=i.project,this.onTransformChange=i.onTransformChange,this.padding=null!=(n=i.padding)?n:10;var s=p.BB.fitInto(this.project.width,this.project.height,this.width-2*this.padding,this.height-2*this.padding).width/this.project.width;this.viewport=new(0,u.ProjectViewport)({width:this.width,height:this.height,transform:(0,L.createTransform)({x:this.width/2,y:this.height/2},{x:this.project.width/2,y:this.project.height/2},s,0),project:this.project,useNativeResolution:!1,drawBackground:!0});var a=new(0,b.DoubleTapper)({onDoubleTap:function(e){var t=(0,A.createMatrixFromTransform)(o.viewport.getTransform()),i=(0,C.applyToPoint)(t,{x:0,y:0}),n=(0,C.applyToPoint)(t,{x:o.project.width,y:o.project.height}),r=p.BB.isInsideRect({x:e.relX,y:e.relY},{x:i.x,y:i.y,width:n.x-i.x,height:n.y-i.y});(!o.isReset||r)&&o.resetOrZoom(e.relX,e.relY)},isInstant:!0}),l=void 0,E=new(0,k.PinchZoomer)({onPinch:function(e){if("move"===e.type){l||(l=o.viewport.getTransform());var t=(0,I.toMetaTransform)(l,{x:e.downRelX,y:e.downRelY});t.scale*=e.scale,t.viewportP.x+=e.relX-e.downRelX,t.viewportP.y+=e.relY-e.downRelY,o.viewport.setTransform((0,L.createTransform)(t.viewportP,t.canvasP,t.scale,t.angleDeg)),o.requestRerender(),o.isReset=!1}else"end"===e.type&&(l=void 0)}});this.pointerChain=new(0,x.EventChain)({chainArr:[E,a]}),this.pointerChain.setChainOut(function(e){e.button&&["left","middle"].includes(e.button)&&o.transformCanvas({type:"translate",x:e.dX,y:e.dY})}),this.viewport.getElement().classList.add(w.viewport),(0,R.css)(this.viewport.getElement(),{userSelect:"none",touchAction:"none"}),this.viewport.getElement().addEventListener("touchend",function(e){return e.preventDefault(),!1}),this.viewport.getElement().addEventListener("contextmenu",function(e){return e.preventDefault(),!1}),this.viewport.getElement().addEventListener("dragstart",function(e){return e.preventDefault(),!1}),this.viewportPointerListener=new(0,d.PointerListener)({target:this.viewport.getElement(),onPointer:function(e){o.pointerChain.chainIn(e)},onWheel:this.onWheel,maxPointers:2}),this.viewport.getElement().addEventListener("wheel",function(e){e.preventDefault()});var _=p.BB.createSvg({elementType:"svg"});(0,R.css)(_,{position:"absolute",left:"0",top:"0",width:"100%",height:"100%",pointerEvents:"none"}),i.selection&&(this.selectionRenderer=new(0,M.SelectionRenderer)({transform:this.lastEmittedTransform,selection:i.selection,width:this.width,height:this.height}),_.append(this.selectionRenderer.getElement())),i.hasEditMode&&(this.modeToggle=new(0,T.Options)({optionArr:["edit","hand"].map(function(e){var n,r=p.BB.el({className:"dark-invert",css:{width:"28px",height:"28px",backgroundSize:"contain",margin:"5px",backgroundImage:`url(${"edit"===e?null!=(n=i.editIcon)?n:t(y):t(m)})`,backgroundPosition:"center",backgroundRepeat:"no-repeat"}});return{id:e,label:r,title:"edit"===e?(0,S.LANG)("tab-edit"):(0,S.LANG)("tool-hand")}}),initId:"edit",onChange:function(e){i.onModeChange&&i.onModeChange(e)}})),this.rootEl=(0,c.c)({className:!1===i.hasBorder?void 0:w.preview,css:{position:"relative",zIndex:"0"}},[this.viewport.getElement(),_].concat((0,h._)(this.modeToggle?[(0,c.c)(",pos-absolute,left-5,top-5,z-1,pointer-auto",[this.modeToggle.getElement()])]:[]),[(0,c.c)(",pos-absolute,right-5,bottom-5,flex,flexCol,gap-5,z-1,pointer-auto",[(0,c.c)({tagName:"button",title:(0,S.LANG)("hand-reset"),onClick:function(){o.reset()},content:`<img alt="reset" height="20" src="${t(v)}">`,noRef:!0}),(0,c.c)({tagName:"button",title:(0,S.LANG)("zoom-in"),onClick:function(){var e=o.viewport.getTransform().scale,t=(0,B.zoomByStep)(e,1);o.transformCanvas({type:"zoom",fac:t/e})},content:`<img alt="zoom-in" height="20" src="${t(g)}">`,noRef:!0}),(0,c.c)({tagName:"button",title:(0,S.LANG)("zoom-out"),onClick:function(){var e=o.viewport.getTransform().scale,t=(0,B.zoomByStep)(e,-1);o.transformCanvas({type:"zoom",fac:t/e})},content:`<img alt="zoom-out" height="20" src="${t(f)}">`,noRef:!0})])])),this.renderLoop()}return(0,s._)(e,[{key:"requestRerender",value:function(){this.doRender=!0}},{key:"resetOrZoom",value:function(e,t){if(this.isReset){this.isReset=!1;var i=(0,C.applyToPoint)((0,E.inverse)((0,A.createMatrixFromTransform)(this.viewport.getTransform())),{x:e,y:t});this.viewport.setTransform((0,L.createTransform)({x:this.width/2,y:this.height/2},i,1,0)),this.requestRerender()}else this.reset()}},{key:"reset",value:function(){var e=p.BB.fitInto(this.project.width,this.project.height,this.width-2*this.padding,this.height-2*this.padding).width/this.project.width;this.viewport.setTransform((0,L.createTransform)({x:this.width/2,y:this.height/2},{x:this.project.width/2,y:this.project.height/2},e,0)),this.isReset=!0,this.requestRerender()}},{key:"transformCanvas",value:function(e){if("translate"===e.type){var t=this.viewport.getTransform();if(0===e.x&&0===e.y)return;this.viewport.setTransform((0,l._)((0,a._)({},t),{x:t.x+e.x,y:t.y+e.y}))}else if("zoom"===e.type){var i,n,r=this.viewport.getTransform(),o=this.viewport.getElement().getBoundingClientRect();e.vX=null!=(i=e.vX)?i:o.width/2,e.vY=null!=(n=e.vY)?n:o.height/2;var s=(0,I.toMetaTransform)(r,{x:e.vX,y:e.vY});s.scale*=e.fac,this.viewport.setTransform((0,L.createTransform)(s.viewportP,s.canvasP,s.scale,s.angleDeg))}this.isReset=!1,this.requestRerender()}},{key:"render",value:function(){this.requestRerender()}},{key:"setTransform",value:function(e){this.viewport.setTransform(e),this.requestRerender(),this.isReset=!1}},{key:"getTransform",value:function(){return this.viewport.getTransform()}},{key:"onPointer",value:function(e){this.pointerChain.chainIn(e)}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){var e;void 0!==this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.viewport.destroy(),this.viewportPointerListener.destroy(),this.rootEl.remove(),this.modeToggle&&this.modeToggle.destroy(),null==(e=this.selectionRenderer)||e.destroy()}}]),e}()}),s("bMICc",function(t,i){e(t.exports,"ProjectViewport",function(){return y});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("4EWN2"),l=o("bX4ja"),h=o("eWjiX"),c=o("7jh4K"),u=o("1C8RU");o("ciAU9");var p=o("kDVZW"),d=o("dZ59l"),g=o("1GsyD"),f=o("fzzhO"),v=o("cNUyQ");function m(e,t){return Math.round(t*e)/t}var y=function(){"use strict";function e(t){var i,r=this;(0,n._)(this,e),this.doResize=!0,this.onIsDark=function(){r.pattern=(0,c.throwIfNull)(r.ctx.createPattern(h.BB.createCheckerCanvas(10,u.THEME.isDark()),"repeat")),r.render()},this.oldDPR=devicePixelRatio,this.resizeListener=function(){devicePixelRatio!==r.oldDPR&&(r.canvas.style.imageRendering=Math.round(devicePixelRatio)!==devicePixelRatio?"":"pixelated",r.oldDPR=devicePixelRatio)},this.width=t.width,this.height=t.height,this.project=t.project,this.useNativeResolution=!!t.useNativeResolution,this.drawBackground=null==(i=t.drawBackground)||i,this.doFillParent=!!t.fillParent,this.renderAfter=t.renderAfter,this.transform=(0,s._)({},t.transform),this.resFactor=this.useNativeResolution?devicePixelRatio:1,this.canvas=h.BB.canvas(this.width*this.resFactor,this.height*this.resFactor),this.ctx=h.BB.ctx(this.canvas),(0,c.css)(this.canvas,{width:this.doFillParent?"100%":this.width+"px",height:this.doFillParent?"100%":this.height+"px",imageRendering:Math.round(devicePixelRatio)!==devicePixelRatio?void 0:"pixelated",display:"block"}),window.addEventListener("resize",this.resizeListener),this.pattern=(0,c.throwIfNull)(this.ctx.createPattern(h.BB.createCheckerCanvas(10,u.THEME.isDark()),"repeat")),u.THEME.addIsDarkListener(this.onIsDark)}return(0,r._)(e,[{key:"render",value:function(e){var t,i=this,n=u.THEME.isDark(),r=(0,a._)((0,s._)({},this.transform),{x:this.transform.x,y:this.transform.y,scale:this.transform.scale});this.doResize&&(this.doResize=!1,this.resFactor=this.useNativeResolution?devicePixelRatio:1,this.canvas.width=Math.round(this.width*this.resFactor),this.canvas.height=Math.round(this.height*this.resFactor));var o=e?{x:r.x,y:r.y,angleDeg:r.angleDeg,scaleX:r.scale,scaleY:r.scale}:{x:Math.round(r.x),y:Math.round(r.y),scaleX:m(r.scale,this.project.width),scaleY:m(r.scale,this.project.height),angleDeg:r.angleDeg},h=(0,g.createMatrixFromTransform)(o);if(this.ctx.save(),o.scaleX>=4||1===o.scaleX&&0===o.angleDeg?this.ctx.imageSmoothingEnabled=!1:(this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="low"),this.drawBackground?(this.ctx.fillStyle=n?"rgb(33, 33, 33)":"rgb(158,158,158)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)):(this.ctx.fillStyle=this.pattern,this.ctx.fillRect(0,0,this.width,this.height)),this.ctx.translate(o.x,o.y),this.ctx.scale(o.scaleX,o.scaleY),this.ctx.rotate(o.angleDeg/180*Math.PI),this.drawBackground){this.ctx.save(),this.ctx.fillStyle=u.THEME.isDark()?"rgba(255,255,255,0.25)":"rgba(0,0,0,0.2)";var c=1/o.scaleX,y=1/o.scaleY;this.ctx.fillRect(-c,-y,this.project.width+2*c,this.project.height+2*y),this.ctx.fillStyle=this.pattern;try{this.pattern.setTransform((0,p.inverse)(h))}catch(e){}this.ctx.fillRect(0,0,this.project.width,this.project.height),this.ctx.restore()}this.project.layers.forEach(function(e){if(e.isVisible&&e.opacity){if(i.ctx.save(),i.ctx.globalCompositeOperation=e.mixModeStr,i.ctx.globalAlpha=e.opacity,"function"==typeof e.image){var t,n,r=e.image(o,i.canvas.width,i.canvas.height);"image"in r&&"transform"in r?(t=r.image,(n=i.ctx).setTransform.apply(n,(0,l._)((0,f.matrixToTuple)((0,d.compose)(h,r.transform))))):t=r}else t=e.image;i.ctx.drawImage(t,0,0),i.ctx.restore()}}),null==(t=this.renderAfter)||t.call(this,this.ctx,o),v.DEBUG_RENDERER_ENABLED&&v.DEBUG_RENDER.render(this.ctx,this.project.width,this.project.height,o.scaleX),this.ctx.restore()}},{key:"setSize",value:function(e,t){this.doResize=!0,this.width=e,this.height=t,(0,c.css)(this.canvas,{width:this.doFillParent?"100%":this.width+"px",height:this.doFillParent?"100%":this.height+"px"})}},{key:"setTransform",value:function(e){this.transform=(0,s._)({},e)}},{key:"setProject",value:function(e){this.project=e}},{key:"getTransform",value:function(){return(0,s._)({},this.transform)}},{key:"setUseNativeResolution",value:function(e){this.useNativeResolution=e,this.doResize=!0}},{key:"getUseNativeResolution",value:function(){return this.useNativeResolution}},{key:"getElement",value:function(){return this.canvas}},{key:"destroy",value:function(){h.BB.freeCanvas(this.canvas),u.THEME.removeIsDarkListener(this.onIsDark),window.removeEventListener("resize",this.resizeListener)}}]),e}()}),s("ciAU9",function(t,i){e(t.exports,"applyToPoint",function(){return o("cdZRx").applyToPoint}),e(t.exports,"identity",function(){return o("83Kse").identity}),e(t.exports,"inverse",function(){return o("kDVZW").inverse}),e(t.exports,"rotate",function(){return o("1RMPr").rotate}),e(t.exports,"scale",function(){return o("kFecW").scale}),e(t.exports,"compose",function(){return o("dZ59l").compose}),e(t.exports,"translate",function(){return o("kr2fR").translate}),o("cdZRx"),o("3wE7v"),o("btdnM"),o("83Kse"),o("kDVZW"),o("lNvMw"),o("1RMPr"),o("kFecW"),o("8jtBQ"),o("ibhub"),o("2mZ9s"),o("dZ59l"),o("kr2fR"),o("5687o"),o("eP59S"),o("i0iB3"),o("ag5pW"),o("gvDD3"),o("4JElo"),o("90Qul")}),s("cdZRx",function(t,i){e(t.exports,"applyToPoint",function(){return n});function n(e,t){return Array.isArray(t)?[e.a*t[0]+e.c*t[1]+e.e,e.b*t[0]+e.d*t[1]+e.f]:{x:e.a*t.x+e.c*t.y+e.e,y:e.b*t.x+e.d*t.y+e.f}}}),s("3wE7v",function(t,i){e(t.exports,"fromObject",function(){return n});function n(e){return{a:parseFloat(e.a),b:parseFloat(e.b),c:parseFloat(e.c),d:parseFloat(e.d),e:parseFloat(e.e),f:parseFloat(e.f)}}}),s("btdnM",function(e,t){}),s("83Kse",function(t,i){e(t.exports,"identity",function(){return n});function n(){return{a:1,c:0,e:0,b:0,d:1,f:0}}}),s("kDVZW",function(t,i){e(t.exports,"inverse",function(){return n});function n(e){var t=e.a,i=e.b,n=e.c,r=e.d,o=e.e,s=e.f,a=t*r-i*n;return{a:r/a,b:-(i/a),c:-(n/a),d:t/a,e:-((r*o-n*s)/a),f:(i*o-t*s)/a}}}),s("lNvMw",function(e,t){o("9LyQ8")}),s("9LyQ8",function(t,i){function n(e){return void 0===e}function r(e){return"number"==typeof e&&!Number.isNaN(e)&&Number.isFinite(e)}function o(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}e(t.exports,"isUndefined",function(){return n}),e(t.exports,"isNumeric",function(){return r}),e(t.exports,"isObject",function(){return o})}),s("1RMPr",function(t,i){e(t.exports,"rotate",function(){return c}),e(t.exports,"rotateDEG",function(){return u});var n=o("9LyQ8"),r=o("kr2fR"),s=o("dZ59l"),a=Math.cos,l=Math.sin,h=Math.PI;function c(e,t,i){var o=a(e),h=l(e),c={a:o,c:-h,e:0,b:h,d:o,f:0};return(0,n.isUndefined)(t)||(0,n.isUndefined)(i)?c:(0,s.transform)([(0,r.translate)(t,i),c,(0,r.translate)(-t,-i)])}function u(e,t,i){return c(e*h/180,t,i)}}),s("kr2fR",function(t,i){e(t.exports,"translate",function(){return n});function n(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return{a:1,c:0,e:e,b:0,d:1,f:t}}}),s("dZ59l",function(t,i){e(t.exports,"transform",function(){return s}),e(t.exports,"compose",function(){return a});var n=o("lYyRs"),r=o("bX4ja");function s(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];t=Array.isArray(t[0])?t[0]:t;var o=function(e,t){return{a:e.a*t.a+e.c*t.b,c:e.a*t.c+e.c*t.d,e:e.a*t.e+e.c*t.f+e.e,b:e.b*t.a+e.d*t.b,d:e.b*t.c+e.d*t.d,f:e.b*t.e+e.d*t.f+e.f}};switch(t.length){case 0:throw Error("no matrices provided");case 1:return t[0];case 2:return o(t[0],t[1]);default:var a=(0,n._)(t),l=a[0],h=a[1],c=a.slice(2),u=o(l,h);return s.apply(void 0,[u].concat((0,r._)(c)))}}function a(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return s.apply(void 0,(0,r._)(t))}}),s("lYyRs",function(t,i){e(t.exports,"_",function(){return l});var n=o("vDBh4"),r=o("5mm0I"),s=o("keO5I"),a=o("kWe4k");function l(e){return(0,n._)(e)||(0,r._)(e)||(0,a._)(e)||(0,s._)()}}),s("kFecW",function(t,i){e(t.exports,"scale",function(){return a});var n=o("9LyQ8"),r=o("kr2fR"),s=o("dZ59l");function a(e,t,i,o){(0,n.isUndefined)(t)&&(t=e);var a={a:e,c:0,e:0,b:0,d:t,f:0};return(0,n.isUndefined)(i)||(0,n.isUndefined)(o)?a:(0,s.transform)([(0,r.translate)(i,o),a,(0,r.translate)(-i,-o)])}}),s("8jtBQ",function(t,i){e(t.exports,"shear",function(){return n});function n(e,t){return{a:1,c:e,e:0,b:t,d:1,f:0}}}),s("ibhub",function(t,i){e(t.exports,"skewDEG",function(){return r});var n=Math.tan;function r(e,t){var i,r;return i=e*Math.PI/180,r=t*Math.PI/180,{a:1,c:n(i),e:0,b:n(r),d:1,f:0}}}),s("2mZ9s",function(e,t){}),s("5687o",function(e,t){o("kDVZW"),o("dZ59l"),o("eP59S")}),s("eP59S",function(t,i){e(t.exports,"smoothMatrix",function(){return n});function n(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e10;return{a:Math.round(e.a*t)/t,b:Math.round(e.b*t)/t,c:Math.round(e.c*t)/t,d:Math.round(e.d*t)/t,e:Math.round(e.e*t)/t,f:Math.round(e.f*t)/t}}}),s("i0iB3",function(e,t){o("3wE7v"),o("kr2fR"),o("kFecW"),o("1RMPr"),o("ibhub"),o("8jtBQ")}),s("ag5pW",function(e,t){o("376sE")}),s("376sE",function(t,i){e(t.exports,"parse",function(){return h});var n=o("fFwUa"),r=o("cx0mh"),s=o("7h4XF"),a=o("9xmuV"),l=function(e){"use strict";function t(e,i,o,s){var a;return(0,r._)(this,t),(a=(0,n._)(this,t,[e])).expected=i,a.found=o,a.location=s,a.name="SyntaxError",a}return(0,a._)(t,e),(0,s._)(t,[{key:"format",value:function(e){var t=this,i="Error: "+this.message;if(this.location){var n=null,r=e.find(function(e){return e.source===t.location.source});r&&(n=r.text.split(/\r\n|\n|\r/g));var o=this.location.start,s=this.location.source&&"function"==typeof this.location.source.offset?this.location.source.offset(o):o,a=this.location.source+":"+s.line+":"+s.column;if(n){var l=this.location.end,h="".padEnd(s.line.toString().length," "),c=n[o.line-1],u=(o.line===l.line?l.column:c.length+1)-o.column||1;i+="\n --\x3e "+a+"\n"+h+" |\n"+s.line+" | "+c+"\n"+h+" | "+"".padEnd(o.column-1," ")+"".padEnd(u,"^")}else i+="\n at "+a}return i}}],[{key:"buildMessage",value:function(e,t){function i(e){return e.codePointAt(0).toString(16).toUpperCase()}var n=Object.prototype.hasOwnProperty.call(RegExp.prototype,"unicode")?RegExp("[\\p{C}\\p{Mn}\\p{Mc}]","gu"):null;function r(e){return n?e.replace(n,function(e){return"\\u{"+i(e)+"}"}):e}function o(e){return r(e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)}))}function s(e){return r(e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)}))}var a={literal:e=>'"'+o(e.text)+'"',class(e){var t=e.parts.map(function(e){return Array.isArray(e)?s(e[0])+"-"+s(e[1]):s(e)});return"["+(e.inverted?"^":"")+t.join("")+"]"+(e.unicode?"u":"")},any:()=>"any character",end:()=>"end of input",other:e=>e.description};function l(e){return a[e.type](e)}return"Expected "+function(e){var t=e.map(l);if(t.sort(),t.length>0){for(var i=1,n=1;n<t.length;n++)t[n-1]!==t[n]&&(t[i]=t[n],i++);t.length=i}switch(t.length){case 1:return t[0];case 2:return t[0]+" or "+t[1];default:return t.slice(0,-1).join(", ")+", or "+t[t.length-1]}}(e)+" but "+(t?'"'+o(t)+'"':"end of input")+" found."}}]),t}((0,o("9DtGe")._)(SyntaxError));function h(e,t){var i,n={},r=(t=void 0!==t?t:{}).grammarSource,o={transformList:V},s=V,a="matrix",h="translate",c="scale",u="rotate",p="skewX",d="skewY",g=/^[eE]/,f=/^[+\-]/,v=/^[0-9]/,m=/^[ \t\r\n]/,y=G("matrix",!1),x=G("(",!1),b=G(")",!1),w=G("translate",!1),B=G("scale",!1),k=G("rotate",!1),S=G("skewX",!1),C=G("skewY",!1),E=G(",",!1),L={type:"other",description:"fractionalConstant"},I=G(".",!1),T=H(["e","E"],!1,!1,!1),A=H(["+","-"],!1,!1,!1),M=H([["0","9"]],!1,!1,!1),R=H([" ","	","\r","\n"],!1,!1,!1),_=0|t.peg$currPos,P=[{line:1,column:1}],D=_,N=t.peg$maxFailExpected||[],O=0|t.peg$silentFails;if(t.startRule){if(!(t.startRule in o))throw Error("Can't start parsing from rule \""+t.startRule+'".');s=o[t.startRule]}function G(e,t){return{type:"literal",text:e,ignoreCase:t}}function H(e,t,i,n){return{type:"class",parts:e,inverted:t,ignoreCase:i,unicode:n}}function z(t){var i,n=P[t];if(n)return n;if(t>=P.length)i=P.length-1;else for(i=t;!P[--i];);for(n={line:(n=P[i]).line,column:n.column};i<t;)10===e.charCodeAt(i)?(n.line++,n.column=1):n.column++,i++;return P[t]=n,n}function j(e,t,i){var n=z(e),o=z(t),s={source:r,start:{offset:e,line:n.line,column:n.column},end:{offset:t,line:o.line,column:o.column}};return i&&r&&"function"==typeof r.offset&&(s.start=r.offset(s.start),s.end=r.offset(s.end)),s}function F(e){_<D||(_>D&&(D=_,N=[]),N.push(e))}function V(){var e,t,i,r;for(e=[],t=J();t!==n;)e.push(t),t=J();for((t=function e(){var t,i,r,o,s;if(t=_,(i=U())!==n){if(r=[],(o=K())!==n)for(;o!==n;)r.push(o),o=K();else r=n;r!==n&&(o=e())!==n?(s=o,t=i.concat(s)):(_=t,t=n)}else _=t,t=n;return t===n&&(t=U()),t}())===n&&(t=null),i=[],r=J();r!==n;)i.push(r),r=J();return t}function U(){var t;return(t=function(){var t,i,r,o,s,l,h,c,u,p,d,g,f;if(t=_,e.substr(_,6)===a?(i=a,_+=6):(i=n,0===O&&F(y)),i!==n){for(r=[],o=J();o!==n;)r.push(o),o=J();if(40===e.charCodeAt(_)?(o="(",_++):(o=n,0===O&&F(x)),o!==n){for(s=[],l=J();l!==n;)s.push(l),l=J();if((l=W())!==n)if(K()!==n)if((h=W())!==n)if(K()!==n)if((c=W())!==n)if(K()!==n)if((u=W())!==n)if(K()!==n)if((p=W())!==n)if(K()!==n)if((d=W())!==n){for(g=[],f=J();f!==n;)g.push(f),f=J();(41===e.charCodeAt(_)?(f=")",_++):(f=n,0===O&&F(b)),f!==n)?t=[{type:"matrix",a:l,b:h,c:c,d:u,e:p,f:d}]:(_=t,t=n)}else _=t,t=n;else _=t,t=n;else _=t,t=n;else _=t,t=n;else _=t,t=n;else _=t,t=n;else _=t,t=n;else _=t,t=n;else _=t,t=n;else _=t,t=n;else _=t,t=n}else _=t,t=n}else _=t,t=n;return t}())===n&&(t=function(){var t,i,r,o,s,a,l,c,u,p,d,g;if(t=_,e.substr(_,9)===h?(i=h,_+=9):(i=n,0===O&&F(w)),i!==n){for(r=[],o=J();o!==n;)r.push(o),o=J();if(40===e.charCodeAt(_)?(o="(",_++):(o=n,0===O&&F(x)),o!==n){for(s=[],a=J();a!==n;)s.push(a),a=J();if((a=W())!==n){for((l=X())===n&&(l=null),c=[],u=J();u!==n;)c.push(u),u=J();(41===e.charCodeAt(_)?(u=")",_++):(u=n,0===O&&F(b)),u!==n)?(p=a,d=l,g={type:"translate",tx:p},d&&(g.ty=d),t=[g]):(_=t,t=n)}else _=t,t=n}else _=t,t=n}else _=t,t=n;return t}())===n&&(t=function(){var t,i,r,o,s,a,l,h,u,p,d,g;if(t=_,e.substr(_,5)===c?(i=c,_+=5):(i=n,0===O&&F(B)),i!==n){for(r=[],o=J();o!==n;)r.push(o),o=J();if(40===e.charCodeAt(_)?(o="(",_++):(o=n,0===O&&F(x)),o!==n){for(s=[],a=J();a!==n;)s.push(a),a=J();if((a=W())!==n){for((l=X())===n&&(l=null),h=[],u=J();u!==n;)h.push(u),u=J();(41===e.charCodeAt(_)?(u=")",_++):(u=n,0===O&&F(b)),u!==n)?(p=a,d=l,g={type:"scale",sx:p},d&&(g.sy=d),t=[g]):(_=t,t=n)}else _=t,t=n}else _=t,t=n}else _=t,t=n;return t}())===n&&(t=function(){var t,i,r,o,s,a,l,h,c,p,d,g,f,v,m;if(t=_,e.substr(_,6)===u?(i=u,_+=6):(i=n,0===O&&F(k)),i!==n){for(r=[],o=J();o!==n;)r.push(o),o=J();if(40===e.charCodeAt(_)?(o="(",_++):(o=n,0===O&&F(x)),o!==n){for(s=[],a=J();a!==n;)s.push(a),a=J();if((a=W())!==n){for((f=_,K()!==n&&(v=W())!==n&&K()!==n&&(m=W())!==n)?f=[v,m]:(_=f,f=n),(l=f)===n&&(l=null),h=[],c=J();c!==n;)h.push(c),c=J();(41===e.charCodeAt(_)?(c=")",_++):(c=n,0===O&&F(b)),c!==n)?(p=a,d=l,g={type:"rotate",angle:p},d&&(g.cx=d[0],g.cy=d[1]),t=[g]):(_=t,t=n)}else _=t,t=n}else _=t,t=n}else _=t,t=n;return t}())===n&&(t=function(){var t,i,r,o,s,a,l,h;if(t=_,e.substr(_,5)===p?(i=p,_+=5):(i=n,0===O&&F(S)),i!==n){for(r=[],o=J();o!==n;)r.push(o),o=J();if(40===e.charCodeAt(_)?(o="(",_++):(o=n,0===O&&F(x)),o!==n){for(s=[],a=J();a!==n;)s.push(a),a=J();if((a=W())!==n){for(l=[],h=J();h!==n;)l.push(h),h=J();(41===e.charCodeAt(_)?(h=")",_++):(h=n,0===O&&F(b)),h!==n)?t=[{type:"skewX",angle:a}]:(_=t,t=n)}else _=t,t=n}else _=t,t=n}else _=t,t=n;return t}())===n&&(t=function(){var t,i,r,o,s,a,l,h;if(t=_,e.substr(_,5)===d?(i=d,_+=5):(i=n,0===O&&F(C)),i!==n){for(r=[],o=J();o!==n;)r.push(o),o=J();if(40===e.charCodeAt(_)?(o="(",_++):(o=n,0===O&&F(x)),o!==n){for(s=[],a=J();a!==n;)s.push(a),a=J();if((a=W())!==n){for(l=[],h=J();h!==n;)l.push(h),h=J();(41===e.charCodeAt(_)?(h=")",_++):(h=n,0===O&&F(b)),h!==n)?t=[{type:"skewY",angle:a}]:(_=t,t=n)}else _=t,t=n}else _=t,t=n}else _=t,t=n;return t}()),t}function W(){var t,i,r,o,s,a,l,h;return t=_,i=_,(r=q())===n&&(r=null),((s=_,(a=function(){var t,i,r,o,s;return(O++,t=_,(i=$())===n&&(i=null),46===e.charCodeAt(_)?(r=".",_++):(r=n,0===O&&F(I)),r!==n&&(o=$())!==n)?t=((s=i)?s.join(""):null)+"."+o.join(""):(_=t,t=n),t===n&&((t=_,(i=$())!==n&&(46===e.charCodeAt(_)?(r=".",_++):(r=n,0===O&&F(I)),r!==n))?t=i.join(""):(_=t,t=n)),O--,t===n&&(i=n,0===O&&F(L)),t}())!==n)?((l=Z())===n&&(l=null),s=[a,l||null].join("")):(_=s,s=n),s===n&&((s=_,(a=$())!==n&&(l=Z())!==n)?s=[a,l].join(""):(_=s,s=n)),(o=s)!==n)?i=r=[r,o]:(_=i,i=n),i!==n&&(i=parseFloat(i.join(""))),(t=i)===n&&(t=_,i=_,(r=q())===n&&(r=null),((h=$())!==n&&(h=h.join("")),(o=h)!==n)?i=r=[r,o]:(_=i,i=n),i!==n&&(i=parseInt(i.join(""))),t=i),t}function X(){var e,t;return(e=_,K()!==n&&(t=W())!==n)?e=t:(_=e,e=n),e}function K(){var e,t,i,r,o;if(e=_,t=[],(i=J())!==n)for(;i!==n;)t.push(i),i=J();else t=n;if(t!==n){for((i=Y())===n&&(i=null),r=[],o=J();o!==n;)r.push(o),o=J();e=t=[t,i,r]}else _=e,e=n;if(e===n)if(e=_,(t=Y())!==n){for(i=[],r=J();r!==n;)i.push(r),r=J();e=t=[t,i]}else _=e,e=n;return e}function Y(){var t;return 44===e.charCodeAt(_)?(t=",",_++):(t=n,0===O&&F(E)),t}function Z(){var t,i,r,o;return(t=_,i=e.charAt(_),g.test(i)?_++:(i=n,0===O&&F(T)),i!==n&&((r=q())===n&&(r=null),(o=$())!==n))?t="e"+r+o.join(""):(_=t,t=n),t}function q(){var t;return t=e.charAt(_),f.test(t)?_++:(t=n,0===O&&F(A)),t}function $(){var e,t;if(e=[],(t=Q())!==n)for(;t!==n;)e.push(t),t=Q();else e=n;return e}function Q(){var t;return t=e.charAt(_),v.test(t)?_++:(t=n,0===O&&F(M)),t}function J(){var t;return t=e.charAt(_),m.test(t)?_++:(t=n,0===O&&F(R)),t}var ee=(i=s())!==n&&_===e.length;function et(){var t,r,o;throw i!==n&&_<e.length&&F({type:"end"}),t=N,r=D<e.length?function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_,i=e.codePointAt(t);return void 0===i?"":String.fromCodePoint(i)}(D):null,o=D<e.length?j(D,D+1):j(D,D),new l(l.buildMessage(t,r),t,r,o)}return t.peg$library?{peg$result:i,peg$currPos:_,peg$FAILED:n,peg$maxFailExpected:N,peg$maxFailPos:D,peg$success:ee,peg$throw:ee?void 0:et}:ee?i:void et()}}),s("fFwUa",function(t,i){e(t.exports,"_",function(){return a});var n=o("2JCCy"),r=o("ff8rK"),s=o("5IlRA");function a(e,t,i){return t=(0,n._)(t),(0,s._)(e,(0,r._)()?Reflect.construct(t,i||[],(0,n._)(e).constructor):t.apply(e,i))}}),s("2JCCy",function(t,i){e(t.exports,"_",function(){return n});function n(e){return(n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}}),s("ff8rK",function(t,i){e(t.exports,"_",function(){return n});function n(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(n=function(){return!!e})()}}),s("5IlRA",function(t,i){e(t.exports,"_",function(){return s});var n=o("d6zUP"),r=o("8KHnw");function s(e,t){return t&&("object"===(0,r._)(t)||"function"==typeof t)?t:(0,n._)(e)}}),s("d6zUP",function(t,i){e(t.exports,"_",function(){return n});function n(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}}),s("8KHnw",function(t,i){e(t.exports,"_",function(){return n});function n(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}}),s("9xmuV",function(t,i){e(t.exports,"_",function(){return r});var n=o("5oklS");function r(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&(0,n._)(e,t)}}),s("5oklS",function(t,i){e(t.exports,"_",function(){return n});function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}}),s("9DtGe",function(t,i){e(t.exports,"_",function(){return l});var n=o("6J7qs"),r=o("2JCCy"),s=o("idL7u"),a=o("5oklS");function l(e){var t="function"==typeof Map?new Map:void 0;return(l=function(e){if(null===e||!(0,s._)(e))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return(0,n._)(e,arguments,(0,r._)(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),(0,a._)(i,e)})(e)}}),s("6J7qs",function(t,i){e(t.exports,"_",function(){return s});var n=o("ff8rK"),r=o("5oklS");function s(e,t,i){return(s=(0,n._)()?Reflect.construct:function(e,t,i){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return i&&(0,r._)(o,i.prototype),o}).apply(null,arguments)}}),s("idL7u",function(t,i){e(t.exports,"_",function(){return n});function n(e){return -1!==Function.toString.call(e).indexOf("[native code]")}}),s("gvDD3",function(e,t){o("kFecW"),o("dZ59l")}),s("4JElo",function(e,t){}),s("90Qul",function(e,t){o("kr2fR"),o("cdZRx"),o("1RMPr"),o("kFecW"),o("dZ59l")}),s("1GsyD",function(t,i){e(t.exports,"createMatrixFromTransform",function(){return l}),o("ciAU9");var n=o("dZ59l"),r=o("kr2fR"),s=o("1RMPr"),a=o("kFecW");function l(e){var t="scale"in e?e.scale:e.scaleX,i="scale"in e?e.scale:e.scaleY;return(0,n.compose)((0,r.translate)(e.x,e.y),(0,s.rotate)(e.angleDeg/180*Math.PI),(0,a.scale)(t,i))}}),s("fzzhO",function(t,i){e(t.exports,"matrixToTuple",function(){return n});function n(e){return[e.a,e.b,e.c,e.d,e.e,e.f]}}),s("cNUyQ",function(t,i){e(t.exports,"DEBUG_RENDERER_ENABLED",function(){return h}),e(t.exports,"DEBUG_RENDER",function(){return c});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=o("gWfkn"),h=!1,c=new(function(){"use strict";function e(){if((0,n._)(this,e),this.internalRenderFuncs=[],this.renderFuncs=[],h){var t=s.BB.createCheckerCanvas(256,!1),i=(0,a.throwIfNull)(s.BB.ctx(s.BB.canvas(l.HISTORY_TILE_SIZE,l.HISTORY_TILE_SIZE)).createPattern(t,"repeat"));this.internalRenderFuncs.push(function(e,t,n){e.fillStyle=i,e.globalAlpha=.2,e.fillRect(0,0,t,n)})}}return(0,r._)(e,[{key:"render",value:function(e,t,i,n){this.internalRenderFuncs.forEach(function(r){e.save(),r(e,t,i,n),e.restore()}),this.renderFuncs.forEach(function(r){e.save(),r(e,t,i,n),e.restore()})}},{key:"add",value:function(e){this.renderFuncs.push(e)}},{key:"remove",value:function(e){for(var t=0;t<this.renderFuncs.length;t++)if(this.renderFuncs[t]===e)return void this.renderFuncs.splice(t,1)}},{key:"clear",value:function(){this.renderFuncs=[]}}]),e}())}),s("gWfkn",function(t,i){e(t.exports,"HISTORY_TILE_SIZE",function(){return c}),e(t.exports,"KlHistory",function(){return u});var n=o("cx0mh"),r=o("7h4XF"),s=o("bX4ja"),a=o("e9flx"),l=o("c3MH7"),h=o("c0vOZ"),c=256,u=function(){"use strict";function e(t){(0,n._)(this,e),this.maxUndoSteps=20,this.totalThresholdBytes=1e9,this.isFreeThresholdBytes=2048,this.index=0,this.indexOffset=0,this.changeCount=0,this.pauseStack=0,this.listeners=[],this.entries=[{timestamp:new Date().getTime(),memoryEstimateBytes:(0,l.estimateBytes)(t.oldest),data:t.oldest}],this.composed=t.oldest}return(0,r._)(e,[{key:"broadcast",value:function(){var e=this;this.changeCount++,setTimeout(function(){for(var t=0;t<e.listeners.length;t++)e.listeners[t]()},1)}},{key:"updateComposed",value:function(){this.composed=(0,a.composeHistoryStateData)(this.entries.slice(0,this.index+1).map(function(e){return e.data}))}},{key:"pause",value:function(e){e?this.pauseStack++:this.pauseStack=Math.max(0,this.pauseStack-1)}},{key:"addListener",value:function(e){this.listeners.push(e)}},{key:"push",value:function(e,t){if(!(this.pauseStack>0)){var i={timestamp:new Date().getTime(),memoryEstimateBytes:(0,l.estimateBytes)(e),data:e};if(t&&this.index>0){for(this.index--;this.index<this.entries.length-1;)this.entries.pop();(0,h.entryCausesChange)(e,(0,a.composeHistoryStateData)(this.entries.slice(0,this.index+1).map(function(e){return e.data})))&&this.entries.push(i)}else{for(;this.index<this.entries.length-1;)this.entries.pop();this.entries.push(i)}for(var n=this.maxUndoSteps,r=this.entries.length-1,o=this.totalThresholdBytes-i.memoryEstimateBytes;r>0&&n>=0;){r--;var c=this.entries[r].memoryEstimateBytes;if(c<this.isFreeThresholdBytes){o-=c;continue}if(0===n||o-c<0){r++;break}o-=c,n--}for(;r>0;){var u=(0,a.composeHistoryStateData)(this.entries.slice(0,r+1).map(function(e){return e.data}),r),p=(0,l.estimateBytes)(u);this.entries=[{timestamp:this.entries[r].timestamp,memoryEstimateBytes:p,description:"oldest",data:u}].concat((0,s._)(this.entries.slice(r+1))),this.indexOffset+=r,r=0,this.entries.reduce(function(e,t){return e+t.memoryEstimateBytes},0)>this.totalThresholdBytes&&(r=1)}this.index=this.entries.length-1,this.updateComposed(),this.broadcast()}}},{key:"increaseIndex",value:function(){return this.canRedo()&&this.index++,this.updateComposed(),this.broadcast(),this.entries[this.index]}},{key:"decreaseIndex",value:function(){return this.canUndo()&&this.index--,this.updateComposed(),this.broadcast(),this.entries[this.index]}},{key:"canUndo",value:function(){return this.index>0}},{key:"canRedo",value:function(){return this.index<this.entries.length-1}},{key:"getEntries",value:function(){return this.entries.slice(0,this.index+1)}},{key:"getComposed",value:function(){return this.composed}},{key:"getChangeCount",value:function(){return this.changeCount}},{key:"getTotalIndex",value:function(){return this.indexOffset+this.index}},{key:"isPaused",value:function(){return this.pauseStack>0}}]),e}()}),s("e9flx",function(t,i){e(t.exports,"composeHistoryStateData",function(){return h});var n=o("cL71g"),r=o("8N5YG"),s=o("bX4ja");function a(e){for(var t=e.length-1;t>=0;t--){var i=e[t];if(void 0!==i)return i}throw Error("no defined entry found")}function l(e,t){for(var i=e.length-1;i>=0;i--)if(e[i]){var n=e[i][t];if(void 0!==n)return n}throw Error("no defined entry found")}function h(e,t){var i,o;return void 0===t&&(t=e.length-1),{projectId:l(e=e.slice(0,t+1),"projectId"),size:l(e,"size"),activeLayerId:l(e,"activeLayerId"),selection:l(e,"selection"),layerMap:(i=e.map(function(e){return e.layerMap}),Object.entries(o=(0,n._)({},a(i))).forEach(function(e){var t,n,h,c=(0,r._)(e,1)[0];o[c]={name:l(t=i.map(function(e){return e?e[c]:void 0}),"name"),opacity:l(t,"opacity"),isVisible:l(t,"isVisible"),mixModeStr:l(t,"mixModeStr"),index:l(t,"index"),tiles:(n=t.map(function(e){return e?e.tiles:void 0}),Object.entries(h=(0,s._)(a(n))).forEach(function(e){var t=(0,r._)(e,1)[0];h[+t]=l(n,t)}),h)}}),o)}}}),s("c3MH7",function(t,i){e(t.exports,"estimateBytes",function(){return s});var n=o("8N5YG"),r=o("esGm2");function s(e){var t,i,o=0;return null==(i=e.selection)||null==(t=i.value)||t.forEach(function(e){e.forEach(function(e){o+=2*e.length*8})}),e.layerMap&&Object.entries(e.layerMap).forEach(function(e){var t;null==(t=(0,n._)(e,2)[1].tiles)||t.forEach(function(e){void 0!==e&&((0,r.isLayerFill)(e)?o+=2*e.fill.length:o+=e.data.width*e.data.height*4)})}),o}}),s("esGm2",function(t,i){e(t.exports,"isLayerFill",function(){return n});function n(e){return"object"==typeof e&&null!==e&&"fill"in e&&"string"==typeof e.fill}}),s("c0vOZ",function(t,i){e(t.exports,"entryCausesChange",function(){return n});function n(e,t){if(void 0!==e.size&&(e.size.width!==t.size.width||e.size.height!==t.size.height)||void 0!==e.selection&&e.selection.value!==t.selection.value||void 0!==e.activeLayerId&&e.activeLayerId!==t.activeLayerId)return!0;if(void 0!==e.layerMap){var i=Object.keys(e.layerMap),n=!0,r=!1,o=void 0;try{for(var s,a=Object.keys(t.layerMap)[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var l=s.value;if(!i.includes(l))return!0}}catch(e){r=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(r)throw o}}var h=!0,c=!1,u=void 0;try{for(var p,d=i[Symbol.iterator]();!(h=(p=d.next()).done);h=!0){var g=p.value,f=t.layerMap[g];if(!f)return!0;var v=e.layerMap[g];if(void 0!==v.name&&v.name!==f.name||void 0!==v.opacity&&v.opacity!==f.opacity||void 0!==v.isVisible&&v.isVisible!==f.isVisible||void 0!==v.mixModeStr&&v.mixModeStr!==f.mixModeStr||void 0!==v.index&&v.index!==f.index||void 0!==v.tiles)return!0}}catch(e){c=!0,u=e}finally{try{h||null==d.return||d.return()}finally{if(c)throw u}}}return!1}}),s("hdxwe",function(e,t){e.exports=i("04ZZm")}),s("jF2Bh",function(e,t){e.exports=i("j9xio")}),s("kHxqJ",function(e,t){e.exports=i("fER1z")}),s("kgQ1R",function(e,t){e.exports=i("2gZH2")}),s("Rurc4",function(e,t){e.exports=i("ghFv7")}),s("cbARd",function(t,i){var n,r;e(t.exports,"preview",function(){return n},function(e){return n=e}),e(t.exports,"viewport",function(){return r},function(e){return r=e}),n="VFEAZq_preview",r="VFEAZq_viewport"}),s("63yUO",function(t,i){e(t.exports,"zoomByStep",function(){return n});function n(e,t){var i=Math.log2(e)/Math.abs(t);return i+=t>0?1:-1,Math.pow(2,i=Math.round(i)*Math.abs(t))}}),s("8G4G9",function(t,i){e(t.exports,"createTransform",function(){return l}),o("ciAU9");var n=o("dZ59l"),r=o("kFecW"),s=o("1RMPr"),a=o("cdZRx");function l(e,t,i,o){var l=(0,n.compose)((0,r.scale)(-i,-i),(0,s.rotate)(o/180*Math.PI)),h=(0,a.applyToPoint)(l,t);return h.x+=e.x,h.y+=e.y,{x:h.x,y:h.y,scale:i,angleDeg:o}}}),s("lUrXo",function(t,i){e(t.exports,"toMetaTransform",function(){return a});var n=o("1GsyD");o("ciAU9");var r=o("cdZRx"),s=o("kDVZW");function a(e,t){var i=(0,n.createMatrixFromTransform)(e),o=(0,r.applyToPoint)((0,s.inverse)(i),t);return{viewportP:t,canvasP:o,scale:e.scale,angleDeg:e.angleDeg}}}),s("b7Uwg",function(t,i){e(t.exports,"SelectionRenderer",function(){return p});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("gwUZZ"),l=o("1GsyD"),h=o("9b3eo"),c=o("bbA6w"),u=o("e4nYk"),p=function(){"use strict";function e(t){(0,n._)(this,e),this.renderedSelection=null,this.viewportTransform=t.transform,this.viewportMat=(0,l.createMatrixFromTransform)(this.viewportTransform),this.selection=t.selection,this.viewportWidth=t.width,this.viewportHeight=t.height,this.svgPath1=s.BB.createSvg({elementType:"path","vector-effect":"non-scaling-stroke"}),this.svgPath1.classList.add(a.whitePath),this.svgPath2=s.BB.createSvg({elementType:"path","vector-effect":"non-scaling-stroke"}),this.svgPath2.classList.add(a.blackPath),this.rootEl=s.BB.createSvg({elementType:"g"}),this.rootEl.append(this.svgPath1,this.svgPath2)}return(0,r._)(e,[{key:"update",value:function(){var e=null===this.renderedSelection?this.selection:this.renderedSelection;if(!e){this.svgPath1.setAttribute("d",""),this.svgPath2.setAttribute("d","");return}var t=(0,c.transformMultiPolygon)(e,this.viewportMat),i=(0,u.applyPolygonClipping)("intersection",t,[[[-10,-10],[this.viewportWidth+10,-10],[this.viewportWidth+10,this.viewportHeight+10],[-10,this.viewportHeight+10],[-10,-10]]]),n=(0,h.getSvgPathD)(i.map(function(e){return e.map(function(e){return e.map(function(e){return[Math.round(e[0]+.5)-.5,Math.round(e[1]+.5)-.5]})})}));this.svgPath1.setAttribute("d",n),this.svgPath2.setAttribute("d",n)}},{key:"setTransform",value:function(e){this.viewportTransform=e,this.viewportMat=(0,l.createMatrixFromTransform)(this.viewportTransform),this.update()}},{key:"setSelection",value:function(e){this.selection!==e&&(this.selection=e,null===this.renderedSelection&&this.update())}},{key:"setRenderedSelection",value:function(e,t){this.renderedSelection!==e&&(this.renderedSelection=e,this.update())}},{key:"clearRenderedSelection",value:function(e){this.renderedSelection=null,e&&this.update()}},{key:"setSize",value:function(e,t){this.viewportWidth=e,this.viewportHeight=t}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.rootEl.remove(),this.selection=void 0}}]),e}()}),s("gwUZZ",function(t,i){var n,r,o,s;e(t.exports,"blackAnim",function(){return n},function(e){return n=e}),e(t.exports,"blackPath",function(){return r},function(e){return r=e}),e(t.exports,"whiteAnim",function(){return o},function(e){return o=e}),e(t.exports,"whitePath",function(){return s},function(e){return s=e}),n="uIhb5a_blackAnim",r="uIhb5a_blackPath",o="uIhb5a_whiteAnim",s="uIhb5a_whitePath"}),s("bbA6w",function(t,i){e(t.exports,"transformMultiPolygon",function(){return r}),o("ciAU9");var n=o("cdZRx");function r(e,t){return e.map(function(e){return e.map(function(e){return e.map(function(e){return Object.values((0,n.applyToPoint)(t,{x:e[0],y:e[1]}))})})})}}),s("e4nYk",function(t,i){e(t.exports,"applyPolygonClipping",function(){return s});var n=o("bX4ja"),r=o("1TV6j");function s(e,t){for(var i=arguments.length,o=Array(i>2?i-2:0),s=2;s<i;s++)o[s-2]=arguments[s];var a=[];try{a=r[e].apply(r,[t].concat((0,n._)(o)))}catch(e){}return a}}),s("1TV6j",function(e,t){var i=o("cx0mh"),n=o("7h4XF");e.exports=function(){"use strict";var e=function(e,t){this.next=null,this.key=e,this.data=t,this.left=null,this.right=null};function t(e,t){return e>t?1:e<t?-1:0}function r(t,i,n){for(var r=new e(null,null),o=r,s=r;;){var a=n(t,i.key);if(a<0){if(null===i.left)break;if(0>n(t,i.left.key)){var l=i.left;if(i.left=l.right,l.right=i,null===(i=l).left)break}s.left=i,s=i,i=i.left}else if(a>0){if(null===i.right)break;if(n(t,i.right.key)>0){var l=i.right;if(i.right=l.left,l.left=i,null===(i=l).right)break}o.right=i,o=i,i=i.right}else break}return o.right=i.left,s.left=i.right,i.left=r.right,i.right=r.left,i}function o(t,i,n,o){var s=new e(t,i);if(null===n)return s.left=s.right=null,s;n=r(t,n,o);var a=o(t,n.key);return a<0?(s.left=n.left,s.right=n,n.left=null):a>=0&&(s.right=n.right,s.left=n,n.right=null),s}function s(e,t,i){var n=null,o=null;if(t){t=r(e,t,i);var s=i(t.key,e);0===s?(n=t.left,o=t.right):s<0?(o=t.right,t.right=null,n=t):(n=t.left,t.left=null,o=t)}return{left:n,right:o}}var a=function(){function i(e){void 0===e&&(e=t),this._root=null,this._size=0,this._comparator=e}return i.prototype.insert=function(e,t){return this._size++,this._root=o(e,t,this._root,this._comparator)},i.prototype.add=function(t,i){var n=new e(t,i);null===this._root&&(n.left=n.right=null,this._size++,this._root=n);var o=this._comparator,s=r(t,this._root,o),a=o(t,s.key);return 0===a?this._root=s:(a<0?(n.left=s.left,n.right=s,s.left=null):a>0&&(n.right=s.right,n.left=s,s.right=null),this._size++,this._root=n),this._root},i.prototype.remove=function(e){this._root=this._remove(e,this._root,this._comparator)},i.prototype._remove=function(e,t,i){var n;return null===t?null:(t=r(e,t,i),0===i(e,t.key))?(null===t.left?n=t.right:(n=r(e,t.left,i)).right=t.right,this._size--,n):t},i.prototype.pop=function(){var e=this._root;if(e){for(;e.left;)e=e.left;return this._root=r(e.key,this._root,this._comparator),this._root=this._remove(e.key,this._root,this._comparator),{key:e.key,data:e.data}}return null},i.prototype.findStatic=function(e){for(var t=this._root,i=this._comparator;t;){var n=i(e,t.key);if(0===n)return t;t=n<0?t.left:t.right}return null},i.prototype.find=function(e){return this._root&&(this._root=r(e,this._root,this._comparator),0!==this._comparator(e,this._root.key))?null:this._root},i.prototype.contains=function(e){for(var t=this._root,i=this._comparator;t;){var n=i(e,t.key);if(0===n)return!0;t=n<0?t.left:t.right}return!1},i.prototype.forEach=function(e,t){for(var i=this._root,n=[],r=!1;!r;)null!==i?(n.push(i),i=i.left):0!==n.length?(i=n.pop(),e.call(t,i),i=i.right):r=!0;return this},i.prototype.range=function(e,t,i,n){for(var r=[],o=this._comparator,s=this._root;0!==r.length||s;)if(s)r.push(s),s=s.left;else{if(o((s=r.pop()).key,t)>0)break;if(o(s.key,e)>=0&&i.call(n,s))return this;s=s.right}return this},i.prototype.keys=function(){var e=[];return this.forEach(function(t){var i=t.key;return e.push(i)}),e},i.prototype.values=function(){var e=[];return this.forEach(function(t){var i=t.data;return e.push(i)}),e},i.prototype.min=function(){return this._root?this.minNode(this._root).key:null},i.prototype.max=function(){return this._root?this.maxNode(this._root).key:null},i.prototype.minNode=function(e){if(void 0===e&&(e=this._root),e)for(;e.left;)e=e.left;return e},i.prototype.maxNode=function(e){if(void 0===e&&(e=this._root),e)for(;e.right;)e=e.right;return e},i.prototype.at=function(e){for(var t=this._root,i=!1,n=0,r=[];!i;)if(t)r.push(t),t=t.left;else if(r.length>0){if(t=r.pop(),n===e)return t;n++,t=t.right}else i=!0;return null},i.prototype.next=function(e){var t=this._root,i=null;if(e.right){for(i=e.right;i.left;)i=i.left;return i}for(var n=this._comparator;t;){var r=n(e.key,t.key);if(0===r)break;r<0?(i=t,t=t.left):t=t.right}return i},i.prototype.prev=function(e){var t=this._root,i=null;if(null!==e.left){for(i=e.left;i.right;)i=i.right;return i}for(var n=this._comparator;t;){var r=n(e.key,t.key);if(0===r)break;r<0?t=t.left:(i=t,t=t.right)}return i},i.prototype.clear=function(){return this._root=null,this._size=0,this},i.prototype.toList=function(){return function(t){for(var i=t,n=[],r=!1,o=new e(null,null),s=o;!r;)i?(n.push(i),i=i.left):n.length>0?i=(i=s=s.next=n.pop()).right:r=!0;return s.next=null,o.next}(this._root)},i.prototype.load=function(t,i,n){void 0===i&&(i=[]),void 0===n&&(n=!1);var r=t.length,o=this._comparator;if(n&&function e(t,i,n,r,o){if(!(n>=r)){for(var s=t[n+r>>1],a=n-1,l=r+1;;){do a++;while(0>o(t[a],s))do l--;while(o(t[l],s)>0)if(a>=l)break;var h=t[a];t[a]=t[l],t[l]=h,h=i[a],i[a]=i[l],i[l]=h}e(t,i,n,l,o),e(t,i,l+1,r,o)}}(t,i,0,r-1,o),null===this._root)this._root=function t(i,n,r,o){var s=o-r;if(s>0){var a=r+Math.floor(s/2),l=new e(i[a],n[a]);return l.left=t(i,n,r,a),l.right=t(i,n,a+1,o),l}return null}(t,i,0,r),this._size=r;else{var s=function(t,i,n){for(var r=new e(null,null),o=r,s=t,a=i;null!==s&&null!==a;)0>n(s.key,a.key)?(o.next=s,s=s.next):(o.next=a,a=a.next),o=o.next;return null!==s?o.next=s:null!==a&&(o.next=a),r.next}(this.toList(),function(t,i){for(var n=new e(null,null),r=n,o=0;o<t.length;o++)r=r.next=new e(t[o],i[o]);return r.next=null,n.next}(t,i),o);r=this._size+r,this._root=function e(t,i,n){var r=n-i;if(r>0){var o=i+Math.floor(r/2),s=e(t,i,o),a=t.head;return a.left=s,t.head=t.head.next,a.right=e(t,o+1,n),a}return null}({head:s},0,r)}return this},i.prototype.isEmpty=function(){return null===this._root},Object.defineProperty(i.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),i.prototype.toString=function(e){void 0===e&&(e=function(e){return String(e.key)});var t=[];return!function e(t,i,n,r,o){if(t){r(""+i+(n?"└── ":"├── ")+o(t)+"\n");var s=i+(n?"    ":"│   ");t.left&&e(t.left,s,!1,r,o),t.right&&e(t.right,s,!0,r,o)}}(this._root,"",!0,function(e){return t.push(e)},e),t.join("")},i.prototype.update=function(e,t,i){var n,a,l=this._comparator,h=s(e,this._root,l),c=h.left,u=h.right;0>l(e,t)?u=o(t,i,u,l):c=o(t,i,c,l),this._root=(n=c,null===(a=u)?n:(null===n||((a=r(n.key,a,l)).left=n),a))},i.prototype.split=function(e){return s(e,this._root,this._comparator)},i.prototype[Symbol.iterator]=function(){var e,t,i;return function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){var l=[o,a];if(i)throw TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&l[0]?n.return:l[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,l[1])).done)return r;switch(n=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return s.label++,{value:l[1],done:!1};case 5:s.label++,n=l[1],l=[0];continue;case 7:l=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===l[0]||2===l[0])){s=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){s.label=l[1];break}if(6===l[0]&&s.label<r[1]){s.label=r[1],r=l;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(l);break}r[2]&&s.ops.pop(),s.trys.pop();continue}l=t.call(e,s)}catch(e){l=[6,e],n=0}finally{i=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}}(this,function(n){switch(n.label){case 0:e=this._root,t=[],i=!1,n.label=1;case 1:if(i)return[3,6];if(null===e)return[3,2];return t.push(e),e=e.left,[3,5];case 2:if(0===t.length)return[3,4];return[4,e=t.pop()];case 3:return n.sent(),e=e.right,[3,5];case 4:i=!0,n.label=5;case 5:return[3,1];case 6:return[2]}})},i}(),l=function(e,t){return e.ll.x<=t.x&&t.x<=e.ur.x&&e.ll.y<=t.y&&t.y<=e.ur.y},h=function(e,t){if(t.ur.x<e.ll.x||e.ur.x<t.ll.x||t.ur.y<e.ll.y||e.ur.y<t.ll.y)return null;var i=e.ll.x<t.ll.x?t.ll.x:e.ll.x,n=e.ur.x<t.ur.x?e.ur.x:t.ur.x;return{ll:{x:i,y:e.ll.y<t.ll.y?t.ll.y:e.ll.y},ur:{x:n,y:e.ur.y<t.ur.y?e.ur.y:t.ur.y}}},c=Number.EPSILON;void 0===c&&(c=2220446049250313e-31);var u=c*c,p=function(e,t){if(-c<e&&e<c&&-c<t&&t<c)return 0;var i=e-t;return i*i<u*e*t?0:e<t?-1:1},d=function(){function e(){(0,i._)(this,e),this.reset()}return(0,n._)(e,[{key:"reset",value:function(){this.xRounder=new g,this.yRounder=new g}},{key:"round",value:function(e,t){return{x:this.xRounder.round(e),y:this.yRounder.round(t)}}}]),e}(),g=function(){function e(){(0,i._)(this,e),this.tree=new a,this.round(0)}return(0,n._)(e,[{key:"round",value:function(e){var t=this.tree.add(e),i=this.tree.prev(t);if(null!==i&&0===p(t.key,i.key))return this.tree.remove(e),i.key;var n=this.tree.next(t);return null!==n&&0===p(t.key,n.key)?(this.tree.remove(e),n.key):e}}]),e}(),f=new d,v=(3+8881784197001252e-31)*11102230246251565e-32;function m(e,t,i,n,r){var o,s,a,l,h=t[0],c=n[0],u=0,p=0;c>h==c>-h?(o=h,h=t[++u]):(o=c,c=n[++p]);var d=0;if(u<e&&p<i)for(c>h==c>-h?(s=h+o,a=o-(s-h),h=t[++u]):(s=c+o,a=o-(s-c),c=n[++p]),o=s,0!==a&&(r[d++]=a);u<e&&p<i;)c>h==c>-h?(l=(s=o+h)-o,a=o-(s-l)+(h-l),h=t[++u]):(l=(s=o+c)-o,a=o-(s-l)+(c-l),c=n[++p]),o=s,0!==a&&(r[d++]=a);for(;u<e;)l=(s=o+h)-o,a=o-(s-l)+(h-l),h=t[++u],o=s,0!==a&&(r[d++]=a);for(;p<i;)l=(s=o+c)-o,a=o-(s-l)+(c-l),c=n[++p],o=s,0!==a&&(r[d++]=a);return(0!==o||0===d)&&(r[d++]=o),d}function y(e){return new Float64Array(e)}var x=(3+17763568394002505e-31)*11102230246251565e-32,b=(2+13322676295501878e-31)*11102230246251565e-32,w=(9+7105427357601002e-30)*11102230246251565e-32*11102230246251565e-32,B=y(4),k=y(8),S=y(12),C=y(16),E=y(4),L=function(e,t){return e.x*t.y-e.y*t.x},I=function(e,t){return e.x*t.x+e.y*t.y},T=function(e,t,i){var n,r,o,s,a,l,h,c,u,p,d=(n=e.x,r=e.y,o=t.x,s=t.y,a=i.x,Math.abs(u=(h=(r-(l=i.y))*(o-a))-(c=(n-a)*(s-l)))>=x*(p=Math.abs(h+c))?u:-function(e,t,i,n,r,o,s){var a,l,h,c,u,p,d,g,f,y,x,L,I,T,A,M,R,_,P=e-r,D=i-r,N=t-o,O=n-o;T=P*O,d=(p=0x8000001*P)-(p-P),g=P-d,f=(p=0x8000001*O)-(p-O),A=g*(y=O-f)-(T-d*f-g*f-d*y),M=N*D,d=(p=0x8000001*N)-(p-N),g=N-d,f=(p=0x8000001*D)-(p-D),x=A-(R=g*(y=D-f)-(M-d*f-g*f-d*y)),u=A-x,B[0]=A-(x+u)+(u-R),u=(L=T+x)-T,x=(I=T-(L-u)+(x-u))-M,u=I-x,B[1]=I-(x+u)+(u-M),u=(_=L+x)-L,B[2]=L-(_-u)+(x-u),B[3]=_;var G=function(e,t){for(var i=t[0],n=1;n<4;n++)i+=t[n];return i}(0,B),H=b*s;if(G>=H||-G>=H||(u=e-P,a=e-(P+u)+(u-r),u=i-D,h=i-(D+u)+(u-r),u=t-N,l=t-(N+u)+(u-o),u=n-O,c=n-(O+u)+(u-o),0===a&&0===l&&0===h&&0===c)||(H=w*s+v*Math.abs(G),(G+=P*c+O*a-(N*h+D*l))>=H||-G>=H))return G;T=a*O,d=(p=0x8000001*a)-(p-a),g=a-d,f=(p=0x8000001*O)-(p-O),A=g*(y=O-f)-(T-d*f-g*f-d*y),M=l*D,d=(p=0x8000001*l)-(p-l),g=l-d,f=(p=0x8000001*D)-(p-D),x=A-(R=g*(y=D-f)-(M-d*f-g*f-d*y)),u=A-x,E[0]=A-(x+u)+(u-R),u=(L=T+x)-T,x=(I=T-(L-u)+(x-u))-M,u=I-x,E[1]=I-(x+u)+(u-M),u=(_=L+x)-L,E[2]=L-(_-u)+(x-u),E[3]=_;var z=m(4,B,4,E,k);T=P*c,d=(p=0x8000001*P)-(p-P),g=P-d,f=(p=0x8000001*c)-(p-c),A=g*(y=c-f)-(T-d*f-g*f-d*y),M=N*h,d=(p=0x8000001*N)-(p-N),g=N-d,f=(p=0x8000001*h)-(p-h),x=A-(R=g*(y=h-f)-(M-d*f-g*f-d*y)),u=A-x,E[0]=A-(x+u)+(u-R),u=(L=T+x)-T,x=(I=T-(L-u)+(x-u))-M,u=I-x,E[1]=I-(x+u)+(u-M),u=(_=L+x)-L,E[2]=L-(_-u)+(x-u),E[3]=_;var j=m(z,k,4,E,S);T=a*c,d=(p=0x8000001*a)-(p-a),g=a-d,f=(p=0x8000001*c)-(p-c),A=g*(y=c-f)-(T-d*f-g*f-d*y),M=l*h,d=(p=0x8000001*l)-(p-l),g=l-d,f=(p=0x8000001*h)-(p-h),x=A-(R=g*(y=h-f)-(M-d*f-g*f-d*y)),u=A-x,E[0]=A-(x+u)+(u-R),u=(L=T+x)-T,x=(I=T-(L-u)+(x-u))-M,u=I-x,E[1]=I-(x+u)+(u-M),u=(_=L+x)-L,E[2]=L-(_-u)+(x-u),E[3]=_;var F=m(j,S,4,E,C);return C[F-1]}(n,r,o,s,a,l,p));return d>0?-1:+(d<0)},A=function(e){return Math.sqrt(I(e,e))},M=function(e,t,i){var n={x:t.x-e.x,y:t.y-e.y},r={x:i.x-e.x,y:i.y-e.y};return L(r,n)/A(r)/A(n)},R=function(e,t,i){var n={x:t.x-e.x,y:t.y-e.y},r={x:i.x-e.x,y:i.y-e.y};return I(r,n)/A(r)/A(n)},_=function(e,t,i){return 0===t.y?null:{x:e.x+t.x/t.y*(i-e.y),y:i}},P=function(e,t,i){return 0===t.x?null:{x:i,y:e.y+t.y/t.x*(i-e.x)}},D=function(e,t,i,n){if(0===t.x)return P(i,n,e.x);if(0===n.x)return P(e,t,i.x);if(0===t.y)return _(i,n,e.y);if(0===n.y)return _(e,t,i.y);var r=L(t,n);if(0==r)return null;var o={x:i.x-e.x,y:i.y-e.y},s=L(o,t)/r,a=L(o,n)/r;return{x:(e.x+a*t.x+(i.x+s*n.x))/2,y:(e.y+a*t.y+(i.y+s*n.y))/2}},N=function(){function e(t,n){(0,i._)(this,e),void 0===t.events?t.events=[this]:t.events.push(this),this.point=t,this.isLeft=n}return(0,n._)(e,[{key:"link",value:function(e){if(e.point===this.point)throw Error("Tried to link already linked events");for(var t=e.point.events,i=0,n=t.length;i<n;i++){var r=t[i];this.point.events.push(r),r.point=this.point}this.checkForConsuming()}},{key:"checkForConsuming",value:function(){for(var e=this.point.events.length,t=0;t<e;t++){var i=this.point.events[t];if(void 0===i.segment.consumedBy)for(var n=t+1;n<e;n++){var r=this.point.events[n];void 0===r.consumedBy&&i.otherSE.point.events===r.otherSE.point.events&&i.segment.consume(r.segment)}}}},{key:"getAvailableLinkedEvents",value:function(){for(var e=[],t=0,i=this.point.events.length;t<i;t++){var n=this.point.events[t];n!==this&&!n.segment.ringOut&&n.segment.isInResult()&&e.push(n)}return e}},{key:"getLeftmostComparator",value:function(e){var t=this,i=new Map,n=function(n){var r=n.otherSE;i.set(n,{sine:M(t.point,e.point,r.point),cosine:R(t.point,e.point,r.point)})};return function(e,t){i.has(e)||n(e),i.has(t)||n(t);var r=i.get(e),o=r.sine,s=r.cosine,a=i.get(t),l=a.sine,h=a.cosine;return o>=0&&l>=0?s<h?1:s>h?-1:0:o<0&&l<0?s<h?-1:+(s>h):l<o?-1:+(l>o)}}}],[{key:"compare",value:function(t,i){var n=e.comparePoints(t.point,i.point);return 0!==n?n:(t.point!==i.point&&t.link(i),t.isLeft!==i.isLeft)?t.isLeft?1:-1:G.compare(t.segment,i.segment)}},{key:"comparePoints",value:function(e,t){return e.x<t.x?-1:e.x>t.x?1:e.y<t.y?-1:+(e.y>t.y)}}]),e}(),O=0,G=function(){function e(t,n,r,o){(0,i._)(this,e),this.id=++O,this.leftSE=t,t.segment=this,t.otherSE=n,this.rightSE=n,n.segment=this,n.otherSE=t,this.rings=r,this.windings=o}return(0,n._)(e,[{key:"replaceRightSE",value:function(e){this.rightSE=e,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}},{key:"bbox",value:function(){var e=this.leftSE.point.y,t=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:e<t?e:t},ur:{x:this.rightSE.point.x,y:e>t?e:t}}}},{key:"vector",value:function(){return{x:this.rightSE.point.x-this.leftSE.point.x,y:this.rightSE.point.y-this.leftSE.point.y}}},{key:"isAnEndpoint",value:function(e){return e.x===this.leftSE.point.x&&e.y===this.leftSE.point.y||e.x===this.rightSE.point.x&&e.y===this.rightSE.point.y}},{key:"comparePoint",value:function(e){if(this.isAnEndpoint(e))return 0;var t=this.leftSE.point,i=this.rightSE.point,n=this.vector();if(t.x===i.x)return e.x===t.x?0:e.x<t.x?1:-1;var r=(e.y-t.y)/n.y,o=t.x+r*n.x;if(e.x===o)return 0;var s=(e.x-t.x)/n.x,a=t.y+s*n.y;return e.y===a?0:e.y<a?-1:1}},{key:"getIntersection",value:function(e){var t=this.bbox(),i=e.bbox(),n=h(t,i);if(null===n)return null;var r=this.leftSE.point,o=this.rightSE.point,s=e.leftSE.point,a=e.rightSE.point,c=l(t,s)&&0===this.comparePoint(s),u=l(i,r)&&0===e.comparePoint(r),p=l(t,a)&&0===this.comparePoint(a),d=l(i,o)&&0===e.comparePoint(o);if(u&&c)return d&&!p?o:!d&&p?a:null;if(u)return p&&r.x===a.x&&r.y===a.y?null:r;if(c)return d&&o.x===s.x&&o.y===s.y?null:s;if(d&&p)return null;if(d)return o;if(p)return a;var g=D(r,this.vector(),s,e.vector());return null!==g&&l(n,g)?f.round(g.x,g.y):null}},{key:"split",value:function(t){var i=[],n=void 0!==t.events,r=new N(t,!0),o=new N(t,!1),s=this.rightSE;this.replaceRightSE(o),i.push(o),i.push(r);var a=new e(r,s,this.rings.slice(),this.windings.slice());return N.comparePoints(a.leftSE.point,a.rightSE.point)>0&&a.swapEvents(),N.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),n&&(r.checkForConsuming(),o.checkForConsuming()),i}},{key:"swapEvents",value:function(){var e=this.rightSE;this.rightSE=this.leftSE,this.leftSE=e,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(var t=0,i=this.windings.length;t<i;t++)this.windings[t]*=-1}},{key:"consume",value:function(t){for(var i=this,n=t;i.consumedBy;)i=i.consumedBy;for(;n.consumedBy;)n=n.consumedBy;var r=e.compare(i,n);if(0!==r){if(r>0){var o=i;i=n,n=o}if(i.prev===n){var s=i;i=n,n=s}for(var a=0,l=n.rings.length;a<l;a++){var h=n.rings[a],c=n.windings[a],u=i.rings.indexOf(h);-1===u?(i.rings.push(h),i.windings.push(c)):i.windings[u]+=c}n.rings=null,n.windings=null,n.consumedBy=i,n.leftSE.consumedBy=i.leftSE,n.rightSE.consumedBy=i.rightSE}}},{key:"prevInResult",value:function(){return void 0!==this._prevInResult||(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null),this._prevInResult}},{key:"beforeState",value:function(){if(void 0!==this._beforeState)return this._beforeState;if(this.prev){var e=this.prev.consumedBy||this.prev;this._beforeState=e.afterState()}else this._beforeState={rings:[],windings:[],multiPolys:[]};return this._beforeState}},{key:"afterState",value:function(){if(void 0!==this._afterState)return this._afterState;var e=this.beforeState();this._afterState={rings:e.rings.slice(0),windings:e.windings.slice(0),multiPolys:[]};for(var t=this._afterState.rings,i=this._afterState.windings,n=this._afterState.multiPolys,r=0,o=this.rings.length;r<o;r++){var s=this.rings[r],a=this.windings[r],l=t.indexOf(s);-1===l?(t.push(s),i.push(a)):i[l]+=a}for(var h=[],c=[],u=0,p=t.length;u<p;u++)if(0!==i[u]){var d=t[u],g=d.poly;if(-1===c.indexOf(g))if(d.isExterior)h.push(g);else{-1===c.indexOf(g)&&c.push(g);var f=h.indexOf(d.poly);-1!==f&&h.splice(f,1)}}for(var v=0,m=h.length;v<m;v++){var y=h[v].multiPoly;-1===n.indexOf(y)&&n.push(y)}return this._afterState}},{key:"isInResult",value:function(){if(this.consumedBy)return!1;if(void 0!==this._isInResult)return this._isInResult;var e,t,i=this.beforeState().multiPolys,n=this.afterState().multiPolys;switch(X.type){case"union":var r=0===i.length,o=0===n.length;this._isInResult=r!==o;break;case"intersection":i.length<n.length?(e=i.length,t=n.length):(e=n.length,t=i.length),this._isInResult=t===X.numMultiPolys&&e<t;break;case"xor":var s=Math.abs(i.length-n.length);this._isInResult=s%2==1;break;case"difference":var a=function(e){return 1===e.length&&e[0].isSubject};this._isInResult=a(i)!==a(n);break;default:throw Error(`Unrecognized operation type found ${X.type}`)}return this._isInResult}}],[{key:"compare",value:function(e,t){var i=e.leftSE.point.x,n=t.leftSE.point.x,r=e.rightSE.point.x,o=t.rightSE.point.x;if(o<i)return 1;if(r<n)return -1;var s=e.leftSE.point.y,a=t.leftSE.point.y,l=e.rightSE.point.y,h=t.rightSE.point.y;if(i<n){if(a<s&&a<l)return 1;if(a>s&&a>l)return -1;var c=e.comparePoint(t.leftSE.point);if(c<0)return 1;if(c>0)return -1;var u=t.comparePoint(e.rightSE.point);return 0!==u?u:-1}if(i>n){if(s<a&&s<h)return -1;if(s>a&&s>h)return 1;var p=t.comparePoint(e.leftSE.point);if(0!==p)return p;var d=e.comparePoint(t.rightSE.point);return d<0?1:d>0?-1:1}if(s<a)return -1;if(s>a)return 1;if(r<o){var g=t.comparePoint(e.rightSE.point);if(0!==g)return g}if(r>o){var f=e.comparePoint(t.rightSE.point);if(f<0)return 1;if(f>0)return -1}if(r!==o){var v=l-s,m=r-i,y=h-a,x=o-n;if(v>m&&y<x)return 1;if(v<m&&y>x)return -1}return r>o?1:r<o||l<h?-1:l>h?1:e.id<t.id?-1:+(e.id>t.id)}},{key:"fromRing",value:function(t,i,n){var r,o,s,a=N.comparePoints(t,i);if(a<0)r=t,o=i,s=1;else if(a>0)r=i,o=t,s=-1;else throw Error(`Tried to create degenerate segment at [${t.x}, ${t.y}]`);return new e(new N(r,!0),new N(o,!1),[n],[s])}}]),e}(),H=function(){function e(t,n,r){if((0,i._)(this,e),!Array.isArray(t)||0===t.length||(this.poly=n,this.isExterior=r,this.segments=[],"number"!=typeof t[0][0]||"number"!=typeof t[0][1]))throw Error("Input geometry is not a valid Polygon or MultiPolygon");var o=f.round(t[0][0],t[0][1]);this.bbox={ll:{x:o.x,y:o.y},ur:{x:o.x,y:o.y}};for(var s=o,a=1,l=t.length;a<l;a++){if("number"!=typeof t[a][0]||"number"!=typeof t[a][1])throw Error("Input geometry is not a valid Polygon or MultiPolygon");var h=f.round(t[a][0],t[a][1]);(h.x!==s.x||h.y!==s.y)&&(this.segments.push(G.fromRing(s,h,this)),h.x<this.bbox.ll.x&&(this.bbox.ll.x=h.x),h.y<this.bbox.ll.y&&(this.bbox.ll.y=h.y),h.x>this.bbox.ur.x&&(this.bbox.ur.x=h.x),h.y>this.bbox.ur.y&&(this.bbox.ur.y=h.y),s=h)}(o.x!==s.x||o.y!==s.y)&&this.segments.push(G.fromRing(s,o,this))}return(0,n._)(e,[{key:"getSweepEvents",value:function(){for(var e=[],t=0,i=this.segments.length;t<i;t++){var n=this.segments[t];e.push(n.leftSE),e.push(n.rightSE)}return e}}]),e}(),z=function(){function e(t,n){if((0,i._)(this,e),!Array.isArray(t))throw Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new H(t[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(var r=1,o=t.length;r<o;r++){var s=new H(t[r],this,!1);s.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=s.bbox.ll.x),s.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=s.bbox.ll.y),s.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=s.bbox.ur.x),s.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=s.bbox.ur.y),this.interiorRings.push(s)}this.multiPoly=n}return(0,n._)(e,[{key:"getSweepEvents",value:function(){for(var e=this.exteriorRing.getSweepEvents(),t=0,i=this.interiorRings.length;t<i;t++)for(var n=this.interiorRings[t].getSweepEvents(),r=0,o=n.length;r<o;r++)e.push(n[r]);return e}}]),e}(),j=function(){function e(t,n){if((0,i._)(this,e),!Array.isArray(t))throw Error("Input geometry is not a valid Polygon or MultiPolygon");try{"number"==typeof t[0][0][0]&&(t=[t])}catch(e){}this.polys=[],this.bbox={ll:{x:1/0,y:1/0},ur:{x:-1/0,y:-1/0}};for(var r=0,o=t.length;r<o;r++){var s=new z(t[r],this);s.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=s.bbox.ll.x),s.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=s.bbox.ll.y),s.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=s.bbox.ur.x),s.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=s.bbox.ur.y),this.polys.push(s)}this.isSubject=n}return(0,n._)(e,[{key:"getSweepEvents",value:function(){for(var e=[],t=0,i=this.polys.length;t<i;t++)for(var n=this.polys[t].getSweepEvents(),r=0,o=n.length;r<o;r++)e.push(n[r]);return e}}]),e}(),F=function(){function e(t){(0,i._)(this,e),this.events=t;for(var n=0,r=t.length;n<r;n++)t[n].segment.ringOut=this;this.poly=null}return(0,n._)(e,[{key:"getGeom",value:function(){for(var e=this.events[0].point,t=[e],i=1,n=this.events.length-1;i<n;i++){var r=this.events[i].point;0!==T(r,e,this.events[i+1].point)&&(t.push(r),e=r)}if(1===t.length)return null;0===T(t[0],e,t[1])&&t.shift(),t.push(t[0]);for(var o=this.isExteriorRing()?1:-1,s=this.isExteriorRing()?0:t.length-1,a=this.isExteriorRing()?t.length:-1,l=[],h=s;h!=a;h+=o)l.push([t[h].x,t[h].y]);return l}},{key:"isExteriorRing",value:function(){if(void 0===this._isExteriorRing){var e=this.enclosingRing();this._isExteriorRing=!e||!e.isExteriorRing()}return this._isExteriorRing}},{key:"enclosingRing",value:function(){return void 0===this._enclosingRing&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}},{key:"_calcEnclosingRing",value:function(){for(var e=this.events[0],t=1,i=this.events.length;t<i;t++){var n=this.events[t];N.compare(e,n)>0&&(e=n)}for(var r=e.segment.prevInResult(),o=r?r.prevInResult():null;;){if(!r)return null;if(!o)return r.ringOut;if(o.ringOut!==r.ringOut)if(o.ringOut.enclosingRing()!==r.ringOut)return r.ringOut;else return r.ringOut.enclosingRing();o=(r=o.prevInResult())?r.prevInResult():null}}}],[{key:"factory",value:function(t){for(var i=[],n=0,r=t.length;n<r;n++){var o=t[n];if(o.isInResult()&&!o.ringOut){for(var s=null,a=o.leftSE,l=o.rightSE,h=[a],c=a.point,u=[];s=a,a=l,h.push(a),a.point!==c;)for(;;){var p=a.getAvailableLinkedEvents();if(0===p.length){var d=h[0].point,g=h[h.length-1].point;throw Error(`Unable to complete output ring starting at [${d.x}, ${d.y}]. Last matching segment found ends at [${g.x}, ${g.y}].`)}if(1===p.length){l=p[0].otherSE;break}for(var f=null,v=0,m=u.length;v<m;v++)if(u[v].point===a.point){f=v;break}if(null!==f){var y=u.splice(f)[0],x=h.splice(y.index);x.unshift(x[0].otherSE),i.push(new e(x.reverse()));continue}u.push({index:h.length,point:a.point});var b=a.getLeftmostComparator(s);l=p.sort(b)[0].otherSE;break}i.push(new e(h))}}return i}}]),e}(),V=function(){function e(t){(0,i._)(this,e),this.exteriorRing=t,t.poly=this,this.interiorRings=[]}return(0,n._)(e,[{key:"addInterior",value:function(e){this.interiorRings.push(e),e.poly=this}},{key:"getGeom",value:function(){var e=[this.exteriorRing.getGeom()];if(null===e[0])return null;for(var t=0,i=this.interiorRings.length;t<i;t++){var n=this.interiorRings[t].getGeom();null!==n&&e.push(n)}return e}}]),e}(),U=function(){function e(t){(0,i._)(this,e),this.rings=t,this.polys=this._composePolys(t)}return(0,n._)(e,[{key:"getGeom",value:function(){for(var e=[],t=0,i=this.polys.length;t<i;t++){var n=this.polys[t].getGeom();null!==n&&e.push(n)}return e}},{key:"_composePolys",value:function(e){for(var t=[],i=0,n=e.length;i<n;i++){var r=e[i];if(!r.poly)if(r.isExteriorRing())t.push(new V(r));else{var o=r.enclosingRing();o.poly||t.push(new V(o)),o.poly.addInterior(r)}}return t}}]),e}(),W=function(){function e(t){(0,i._)(this,e);var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:G.compare;this.queue=t,this.tree=new a(n),this.segments=[]}return(0,n._)(e,[{key:"process",value:function(e){var t=e.segment,i=[];if(e.consumedBy)return e.isLeft?this.queue.remove(e.otherSE):this.tree.remove(t),i;var n=e.isLeft?this.tree.add(t):this.tree.find(t);if(!n)throw Error(`Unable to find segment #${t.id} [${t.leftSE.point.x}, ${t.leftSE.point.y}] -> [${t.rightSE.point.x}, ${t.rightSE.point.y}] in SweepLine tree.`);for(var r=n,o=n,s=void 0,a=void 0;void 0===s;)null===(r=this.tree.prev(r))?s=null:void 0===r.key.consumedBy&&(s=r.key);for(;void 0===a;)null===(o=this.tree.next(o))?a=null:void 0===o.key.consumedBy&&(a=o.key);if(e.isLeft){var l=null;if(s){var h=s.getIntersection(t);if(null!==h&&(t.isAnEndpoint(h)||(l=h),!s.isAnEndpoint(h)))for(var c=this._splitSafely(s,h),u=0,p=c.length;u<p;u++)i.push(c[u])}var d=null;if(a){var g=a.getIntersection(t);if(null!==g&&(t.isAnEndpoint(g)||(d=g),!a.isAnEndpoint(g)))for(var f=this._splitSafely(a,g),v=0,m=f.length;v<m;v++)i.push(f[v])}if(null!==l||null!==d){var y=null;y=null===l?d:null===d||0>=N.comparePoints(l,d)?l:d,this.queue.remove(t.rightSE),i.push(t.rightSE);for(var x=t.split(y),b=0,w=x.length;b<w;b++)i.push(x[b])}i.length>0?(this.tree.remove(t),i.push(e)):(this.segments.push(t),t.prev=s)}else{if(s&&a){var B=s.getIntersection(a);if(null!==B){if(!s.isAnEndpoint(B))for(var k=this._splitSafely(s,B),S=0,C=k.length;S<C;S++)i.push(k[S]);if(!a.isAnEndpoint(B))for(var E=this._splitSafely(a,B),L=0,I=E.length;L<I;L++)i.push(E[L])}}this.tree.remove(t)}return i}},{key:"_splitSafely",value:function(e,t){this.tree.remove(e);var i=e.rightSE;this.queue.remove(i);var n=e.split(t);return n.push(i),void 0===e.consumedBy&&this.tree.add(e),n}}]),e}(),X=new(function(){function e(){(0,i._)(this,e)}return(0,n._)(e,[{key:"run",value:function(e,t,i){X.type=e,f.reset();for(var n=[new j(t,!0)],r=0,o=i.length;r<o;r++)n.push(new j(i[r],!1));if(X.numMultiPolys=n.length,"difference"===X.type)for(var s=n[0],l=1;l<n.length;)null!==h(n[l].bbox,s.bbox)?l++:n.splice(l,1);if("intersection"===X.type){for(var c=0,u=n.length;c<u;c++)for(var p=n[c],d=c+1,g=n.length;d<g;d++)if(null===h(p.bbox,n[d].bbox))return[]}for(var v=new a(N.compare),m=0,y=n.length;m<y;m++)for(var x=n[m].getSweepEvents(),b=0,w=x.length;b<w;b++)if(v.insert(x[b]),v.size>1e6)throw Error("Infinite loop when putting segment endpoints in a priority queue (queue size too big).");for(var B=new W(v),k=v.size,S=v.pop();S;){var C=S.key;if(v.size===k){var E=C.segment;throw Error(`Unable to pop() ${C.isLeft?"left":"right"} SweepEvent [${C.point.x}, ${C.point.y}] from segment #${E.id} [${E.leftSE.point.x}, ${E.leftSE.point.y}] -> [${E.rightSE.point.x}, ${E.rightSE.point.y}] from queue.`)}if(v.size>1e6)throw Error("Infinite loop when passing sweep line over endpoints (queue size too big).");if(B.segments.length>1e6)throw Error("Infinite loop when passing sweep line over endpoints (too many sweep line segments).");for(var L=B.process(C),I=0,T=L.length;I<T;I++){var A=L[I];void 0===A.consumedBy&&v.insert(A)}k=v.size,S=v.pop()}return f.reset(),new U(F.factory(B.segments)).getGeom()}}]),e}());return{union:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return X.run("union",e,i)},intersection:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return X.run("intersection",e,i)},xor:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return X.run("xor",e,i)},difference:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return X.run("difference",e,i)}}}()}),s("cWGub",function(e,t){e.exports=i("cazOx")}),s("isYih",function(t,i){e(t.exports,"clipboardDialog",function(){return f});var n=o("1LaJZ"),r=o("2gUX3"),s=o("eWjiX"),a=o("2MaaK"),l=o("hRdOL"),h=o("1mH1z"),c=o("eg83P"),u=o("g03EN"),p=o("7bWhB"),d=o("7jh4K"),g=!1;function f(e,t,i,o,f){var v,m,y=!(arguments.length>5)||void 0===arguments[5]||arguments[5],x=arguments.length>6?arguments[6]:void 0,b=!1;try{b=!!ClipboardItem}catch(e){}var w=document.createElement("div"),B=window.innerWidth<550||window.innerHeight<550,k=x?new(0,p.Checkbox)({init:g,label:(0,h.LANG)("cropcopy-mask"),name:"check-mask-selection",css:{width:"fit-content"},callback:function(e){g=e,I.setCanvas(t(e))}}):void 0,S=s.BB.el({content:[null==k?void 0:k.getElement(),(0,h.LANG)("crop-drag-to-crop")+(b?"":"<br>"+(0,h.LANG)("cropcopy-click-hold"))],css:{textAlign:"center"}});w.append(S);var C=t(g);if(x){var E=(0,u.getMultiPolyBounds)(x),L=(0,c.intBoundsWithinArea)(E,C.width,C.height);v=L?(0,c.boundsToRect)(L):void 0}var I=new(0,l.CropCopy)({width:B?340:540,height:B?300:350,canvas:C,enableRightClickCopy:!0,init:v});function T(){return(0,n._)(function(){var e,t;return(0,r.__generator)(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),e=I.getCroppedBlob(),[4,navigator.clipboard.write([new ClipboardItem({[e.type]:e})])];case 1:return i.sent(),setTimeout(function(){o.out((0,h.LANG)("cropcopy-copied"),!0)},200),[3,3];case 2:return console.error((t=i.sent()).name,t.message),[2];case 3:return[2]}})})()}(0,d.css)(I.getElement(),{marginTop:"10px",marginLeft:"-20px"}),w.append(I.getElement());var A=new s.BB.KeyListener({onDown:function(e,t,i){["ctrl+c","cmd+c"].includes(i)&&(T(),m&&m())}});function M(){y&&(null==m||m())}window.addEventListener("blur",M);var R=[];b&&R.push((0,h.LANG)("cropcopy-btn-copy")),f&&R.push((0,h.LANG)("cropcopy-btn-crop")),R.push("Cancel"),(0,a.showModal)({target:e,message:"<b>"+(f?`${(0,h.LANG)("cropcopy-title-copy")} / ${(0,h.LANG)("cropcopy-title-crop")}`:`${(0,h.LANG)("cropcopy-title-copy")}`)+"</b>",div:w,style:B?{}:{width:"540px"},buttons:R,primaries:[(0,h.LANG)("cropcopy-btn-copy")],callback:function(e){if(e===(0,h.LANG)("cropcopy-btn-copy"))T();else if(e===(0,h.LANG)("cropcopy-btn-crop")){var t=I.getCropRect();i({left:Math.round(-t.x),right:Math.round(t.x+t.width-C.width),top:Math.round(-t.y),bottom:Math.round(t.y+t.height-C.height)})}window.removeEventListener("blur",M),s.BB.freeCanvas(I.getCroppedCanvas()),I.destroy(),A.destroy()},clickOnEnter:(0,h.LANG)("cropcopy-btn-copy"),closeFunc:function(e){m=e}})}}),s("g03EN",function(t,i){e(t.exports,"getMultiPolyBounds",function(){return n});function n(e){var t=void 0,i=void 0,n=void 0,r=void 0;if(e.forEach(function(e){e.forEach(function(e){e.forEach(function(e){t=void 0===t?e[0]:Math.min(t,e[0]),i=void 0===i?e[1]:Math.min(i,e[1]),n=void 0===n?e[0]:Math.max(n,e[0]),r=void 0===r?e[1]:Math.max(r,e[1])})})}),void 0===t||void 0===i||void 0===n||void 0===r)throw"empty poly";return{x1:t,y1:i,x2:n,y2:r}}}),s("b4yIv",function(i,n){e(i.exports,"LayersUi",function(){return I});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("eEL9N"),h=o("j5jvd"),c=o("705qg"),u=o("1mH1z"),p=o("bBcC4"),d=o("50Lcc"),g=o("dsnzg"),f=o("7jh4K"),v=o("6J2My"),m=o("amum4"),y=o("6vUjz"),x=o("647zh"),b=o("lVqup"),w=o("8o1rH"),B=o("9N3Nv"),k=o("2xdEb"),S=o("9Bdo6"),C=o("b4DnO"),E=o("72Jv0"),L=o("hrnUX"),I=function(){"use strict";function e(i){var n,o,s=this;(0,r._)(this,e),this.lastpos=0,this.layerHeight=35,this.layerSpacing=0,this.klCanvas=i.klCanvas,this.onSelect=i.onSelect,this.parentEl=i.parentEl,this.uiState=i.uiState,this.applyUncommitted=i.applyUncommitted,this.klHistory=i.klHistory,this.onUpdateProject=i.onUpdateProject,this.onClearLayer=i.onClearLayer,this.layerElArr=[],this.layerHeight=35,this.layerSpacing=0,this.largeThumbDiv=a.BB.el({onClick:a.BB.handleClick,css:{position:"absolute",top:"500px",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",pointerEvents:"none",padding:"0",border:"1px solid #aaa",transition:"opacity 0.3s ease-out",userSelect:"none",background:"var(--kl-checkerboard-background)"}}),this.setUiState(this.uiState),this.largeThumbCanvas=a.BB.canvas(200,200),this.largeThumbCanvas.style.display="block",this.largeThumbDiv.append(this.largeThumbCanvas),this.largeThumbInDocument=!1,this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=this.klCanvasLayerArr.length-1,this.rootEl=a.BB.el({css:{marginRight:"10px",marginBottom:"10px",marginLeft:"10px",marginTop:"10px",cursor:"default",position:"relative",zIndex:"0"}});var h=a.BB.el({css:{width:"270px",position:"relative",margin:"0 -10px",zIndex:"0"}});this.layerListEl=a.BB.el({parent:h}),this.addBtn=a.BB.el({tagName:"button"}),this.duplicateBtn=a.BB.el({tagName:"button"}),this.mergeBtn=a.BB.el({tagName:"button"}),this.removeBtn=a.BB.el({tagName:"button"});var c=a.BB.el({tagName:"button"});this.moreDropdown=new(0,y.DropdownMenu)({button:a.BB.el({content:`<img src="${t(S)}" width="13"/>`,css:{display:"flex",justifyContent:"center",opacity:"0.9"}}),buttonTitle:(0,u.LANG)("more"),items:[["clear-layer",(0,u.LANG)("layers-clear")],["advanced-merge",(0,u.LANG)("layers-merge-advanced")],["merge-all",(0,u.LANG)("layers-merge-all")]],onItemClick:function(e){if("clear-layer"===e&&(s.applyUncommitted(),s.onClearLayer()),"advanced-merge"===e){if(s.applyUncommitted(),s.selectedSpotIndex<=0)return;(0,g.mergeLayerDialog)(s.parentEl,{topCanvas:s.klCanvasLayerArr[s.selectedSpotIndex].context.canvas,bottomCanvas:s.klCanvasLayerArr[s.selectedSpotIndex-1].context.canvas,topOpacity:s.klCanvas.getLayerOld(s.selectedSpotIndex).opacity,mixModeStr:s.klCanvasLayerArr[s.selectedSpotIndex].mixModeStr,callback:function(e){s.klCanvas.mergeLayers(s.selectedSpotIndex,s.selectedSpotIndex-1,e),s.klCanvasLayerArr=s.klCanvas.getLayers(),s.selectedSpotIndex--,s.onSelect(s.selectedSpotIndex,!1),s.updateButtons()}})}if("merge-all"===e){s.applyUncommitted();var t=s.klCanvas.mergeAll();if(!1===t)return;s.klCanvasLayerArr=s.klCanvas.getLayers(),s.selectedSpotIndex=t,s.onSelect(s.selectedSpotIndex,!1),s.updateButtons()}}}),this.updateButtons(),this.rootEl.append((n=a.BB.el(),setTimeout(function(){(0,E.makeUnfocusable)(s.addBtn),(0,E.makeUnfocusable)(s.duplicateBtn),(0,E.makeUnfocusable)(s.mergeBtn),(0,E.makeUnfocusable)(s.removeBtn),(0,E.makeUnfocusable)(c);var e={cssFloat:"left",paddingLeft:"5px",paddingRight:"3px"};(0,f.css)(s.addBtn,e),(0,f.css)(s.duplicateBtn,e),(0,f.css)(s.mergeBtn,e),(0,f.css)(s.removeBtn,e),(0,f.css)(c,{cssFloat:"left",height:"30px",lineHeight:"20px"}),s.addBtn.title=(0,u.LANG)("layers-new"),s.duplicateBtn.title=(0,u.LANG)("layers-duplicate"),s.removeBtn.title=(0,u.LANG)("layers-remove"),s.mergeBtn.title=(0,u.LANG)("layers-merge"),c.title=(0,u.LANG)("layers-rename-title"),s.addBtn.innerHTML="<img src='"+t(x)+"' height='20'/>",s.duplicateBtn.innerHTML="<img src='"+t(b)+"' height='20'/>",s.mergeBtn.innerHTML="<img src='"+t(w)+"' height='20'/>",s.removeBtn.innerHTML="<img src='"+t(B)+"' height='20'/>",c.innerHTML="<img src='"+t(k)+"' height='20'/>",n.append((0,m.c)(",flex,gap-5,mb-10",[s.addBtn,s.removeBtn,s.duplicateBtn,s.mergeBtn,(0,m.c)({className:"kl-info-btn",onClick:function(){L.KL.popup({target:document.body,message:'Advanced merge dialog moved to: <br> More > Advanced Merge<br><br><img src="'+t(C)+'">'})},noRef:!0,css:{marginTop:"5px",fontWeight:"normal"}},"i"),c,(0,m.c)(",grow-1"),s.moreDropdown.getElement()])),s.addBtn.onclick=function(){s.applyUncommitted(),!1!==s.klCanvas.addLayer(s.selectedSpotIndex)&&(s.klCanvasLayerArr=s.klCanvas.getLayers(),s.selectedSpotIndex=s.selectedSpotIndex+1,s.onSelect(s.selectedSpotIndex,!1),s.updateButtons())},s.duplicateBtn.onclick=function(){s.applyUncommitted(),!1!==s.klCanvas.duplicateLayer(s.selectedSpotIndex)&&(s.klCanvasLayerArr=s.klCanvas.getLayers(),s.selectedSpotIndex++,s.onSelect(s.selectedSpotIndex,!1),s.updateButtons())},s.removeBtn.onclick=function(){s.applyUncommitted(),s.layerElArr.length<=1||(s.klCanvas.removeLayer(s.selectedSpotIndex),s.selectedSpotIndex>0&&s.selectedSpotIndex--,s.klCanvasLayerArr=s.klCanvas.getLayers(),s.onSelect(s.selectedSpotIndex,!1),s.updateButtons())},s.mergeBtn.onclick=function(){s.applyUncommitted(),s.selectedSpotIndex<=0||(s.klCanvas.mergeLayers(s.selectedSpotIndex,s.selectedSpotIndex-1),s.klCanvasLayerArr=s.klCanvas.getLayers(),s.selectedSpotIndex--,s.onSelect(s.selectedSpotIndex,!1),s.updateButtons())},c.onclick=function(){s.applyUncommitted(),s.renameLayer(s.selectedSpotIndex)}},1),n)),o=a.BB.el({content:(0,u.LANG)("layers-blending")+"&nbsp;",css:{fontSize:"15px"}}),this.modeSelect=new(0,l.Select)({optionArr:["source-over",void 0,"darken","multiply","color-burn",void 0,"lighten","screen","color-dodge",void 0,"overlay","soft-light","hard-light",void 0,"difference","exclusion",void 0,"hue","saturation","color","luminosity"].map(function(e){return e?[e,(0,p.translateBlending)(e)]:void 0}),onChange:function(e){s.klCanvas.setMixMode(s.selectedSpotIndex,e),s.update(s.selectedSpotIndex)},css:{marginBottom:"10px"},name:"layer-blend-mode"}),o.append(this.modeSelect.getElement()),this.rootEl.append(o),this.rootEl.append(h),this.klHistory.addListener(function(){"block"===s.rootEl.style.display&&s.createLayerList()}),this.createLayerList()}return(0,s._)(e,[{key:"move",value:function(e,t){var i=this;if(isNaN(e)||isNaN(t))throw"layers-ui - invalid move";for(var n=0;n<this.klCanvasLayerArr.length;n++)!function(n){var r=i.layerElArr[n].spot;i.layerElArr[n].spot===e?r=t:(i.layerElArr[n].spot>e&&r--,r>=t&&r++),i.layerElArr[n].spot=r,i.layerElArr[n].posY=(i.layerHeight+i.layerSpacing)*(i.klCanvasLayerArr.length-r-1),i.layerElArr[n].style.top=i.layerElArr[n].posY+"px"}(n);e!==t&&(this.applyUncommitted(),this.klCanvas.moveLayer(this.selectedSpotIndex,t-e),this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=t,this.mergeBtn.disabled=0===this.selectedSpotIndex)}},{key:"posToSpot",value:function(e){var t=parseInt(""+(e/(this.layerHeight+this.layerSpacing)+.5));return t=Math.min(this.klCanvasLayerArr.length-1,Math.max(0,t)),t=this.klCanvasLayerArr.length-t-1}},{key:"updateLayersVerticalPosition",value:function(e,t){if((t=Math.min(this.klCanvasLayerArr.length-1,Math.max(0,t)))!==this.lastpos){for(var i=0;i<this.klCanvasLayerArr.length;i++)if(this.layerElArr[i].spot!==e){var n=this.layerElArr[i].spot;this.layerElArr[i].spot>e&&n--,n>=t&&n++,this.layerElArr[i].posY=(this.layerHeight+this.layerSpacing)*(this.klCanvasLayerArr.length-n-1),this.layerElArr[i].style.top=this.layerElArr[i].posY+"px"}this.lastpos=t}}},{key:"renameLayer",value:function(e){var t=this;(0,d.renameLayerDialog)(this.parentEl,this.klCanvas.getLayerOld(e).name,function(i){void 0!==i&&i!==t.klCanvas.getLayerOld(e).name&&(t.klCanvas.renameLayer(e,i),t.onSelect(e,!1))})}},{key:"updateHeight",value:function(){this.layerListEl.style.height=35*this.layerElArr.length+"px"}},{key:"createLayerList",value:function(e){var t=this;if(this.klHistory.getChangeCount()!==this.oldHistoryState||e){for(this.oldHistoryState=this.klHistory.getChangeCount(),this.klCanvasLayerArr=this.klCanvas.getLayers(),this.layerElArr=[];this.layerListEl.firstChild;){var i=this.layerListEl.firstChild;i.pointerListener.destroy(),i.opacitySlider.destroy(),i.remove()}for(var n=0;n<this.klCanvasLayerArr.length;n++)!function(e){var i,n=(0,f.throwIfNull)(t.klCanvas.getLayerOld(e)),r=n.name,o=t.klCanvasLayerArr[e].opacity,s=n.isVisible,l=t.klCanvasLayerArr[e].context.canvas,c=a.BB.el({className:"kl-layer"});t.layerElArr[e]=c,c.posY=(t.klCanvasLayerArr.length-1)*35-35*e,(0,f.css)(c,{top:c.posY+"px"});var p=a.BB.el();(0,f.css)(p,{position:"relative"});var d=a.BB.el();(0,f.css)(d,{width:"270px",height:"34px"});var g=a.BB.el();c.append(p),p.append(d,g),c.spot=e;var m=a.BB.el({tagName:"label",parent:d,title:(0,u.LANG)("layers-visibility-toggle"),css:{display:"flex",width:"25px",height:"100%",justifyContent:"right",alignItems:"center",cursor:"pointer"}}),y=a.BB.el({tagName:"input",parent:m,custom:{type:"checkbox",tabindex:"-1",name:"layer-visibility"},css:{display:"block",cursor:"pointer",margin:"0",marginRight:"5px"}});y.checked=s,y.onchange=function(){t.klCanvas.setLayerIsVisible(c.spot,y.checked),c.spot===t.selectedSpotIndex&&t.onSelect(t.selectedSpotIndex,!1)};var x=function(e){e.preventDefault(),e.stopPropagation()};v.HAS_POINTER_EVENTS?m.onpointerdown=x:m.onmousedown=x;var b=a.BB.fitInto(l.width,l.height,30,30,1);c.thumb=a.BB.canvas(b.width,b.height);var w=a.BB.ctx(c.thumb);w.save(),c.thumb.width>l.width&&(w.imageSmoothingEnabled=!1),w.drawImage(l,0,0,c.thumb.width,c.thumb.height),w.restore(),(0,f.css)(c.thumb,{position:"absolute",left:(32-c.thumb.width)/2+25+"px",top:(32-c.thumb.height)/2+1+"px",background:"var(--kl-checkerboard-background)"}),c.label=a.BB.el({className:"kl-layer__label"}),c.layerName=r,c.label.append(c.layerName),(0,f.css)(c.label,{position:"absolute",left:"63px",top:"1px",fontSize:"13px",width:"165px",height:"20px",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),c.label.ondblclick=function(){t.applyUncommitted(),t.renameLayer(c.spot)},c.opacityLabel=a.BB.el({className:"kl-layer__opacity-label"}),c.opacity=o,c.opacityLabel.append(parseInt(""+100*c.opacity)+"%"),(0,f.css)(c.opacityLabel,{position:"absolute",left:"214px",top:"1px",fontSize:"13px",textAlign:"right",width:"50px",transition:"color 0.2s ease-in-out",textDecoration:s?void 0:"line-through"});var B=new(0,h.PointSlider)({init:c.opacity,width:200,pointSize:14,callback:function(e,n,r){if(n){i=t.klCanvas.getLayerOld(c.spot).opacity,t.klHistory.pause(!0);return}if(r){t.klHistory.pause(!1),i!==e&&t.klCanvas.setOpacity(c.spot,e);return}c.opacityLabel.innerHTML=Math.round(100*e)+"%",t.klCanvas.setOpacity(c.spot,e),t.onUpdateProject()}});(0,f.css)(B.getElement(),{position:"absolute",left:"64px",top:"17px"}),c.opacitySlider=B,c.thumb.onpointerover=function(e){if(0===e.buttons||e.pointerType&&"touch"===e.pointerType){var i=a.BB.fitInto(l.width,l.height,250,250,1);(t.largeThumbCanvas.width!==i.width||t.largeThumbCanvas.height!==i.height)&&(t.largeThumbCanvas.width=i.width,t.largeThumbCanvas.height=i.height);var n=a.BB.ctx(t.largeThumbCanvas);n.save(),t.largeThumbCanvas.width>l.width&&(n.imageSmoothingEnabled=!1),n.imageSmoothingQuality="high",n.clearRect(0,0,t.largeThumbCanvas.width,t.largeThumbCanvas.height),n.drawImage(l,0,0,t.largeThumbCanvas.width,t.largeThumbCanvas.height),n.restore(),(0,f.css)(t.largeThumbDiv,{top:e.clientY-t.largeThumbCanvas.height/2+"px",opacity:"0"}),t.largeThumbInDocument||(document.body.append(t.largeThumbDiv),t.largeThumbInDocument=!0),clearTimeout(t.largeThumbInTimeout),t.largeThumbInTimeout=setTimeout(function(){(0,f.css)(t.largeThumbDiv,{opacity:"1"})},20),clearTimeout(t.largeThumbTimeout)}},c.thumb.onpointerout=function(){clearTimeout(t.largeThumbInTimeout),(0,f.css)(t.largeThumbDiv,{opacity:"0"}),clearTimeout(t.largeThumbTimeout),t.largeThumbTimeout=setTimeout(function(){t.largeThumbInDocument&&(t.largeThumbDiv.remove(),t.largeThumbInDocument=!1)},300)},d.append(c.thumb,c.label,c.opacityLabel,B.getElement());var k=!1,S=!1;c.pointerListener=new a.BB.PointerListener({target:d,onPointer:function(e){if("pointerdown"===e.type&&"left"===e.button)(0,f.css)(c,{transition:"box-shadow 0.3s ease-in-out",zIndex:"1"}),t.lastpos=c.spot,S=!1,c.isSelected||(S=!0,t.activateLayer(c.spot)),k=!0;else if("pointermove"===e.type&&"left"===e.button){k&&(k=!1,(0,f.css)(c,{boxShadow:"1px 3px 5px rgba(0,0,0,0.4)"})),c.posY+=e.dY;var i=Math.max(0,Math.min((t.klCanvasLayerArr.length-1)*35,c.posY));c.style.top=i+"px",t.updateLayersVerticalPosition(c.spot,t.posToSpot(c.posY))}if("pointerup"===e.type){(0,f.css)(c,{transition:"all 0.1s linear"}),setTimeout(function(){(0,f.css)(c,{boxShadow:""})},20),c.posY=Math.max(0,Math.min((t.klCanvasLayerArr.length-1)*35,c.posY)),c.style.zIndex="";var n=t.posToSpot(c.posY),r=c.spot;t.move(c.spot,n),r!=n&&t.onSelect(t.selectedSpotIndex,!1),r===n&&S&&(t.applyUncommitted(),t.onSelect(t.selectedSpotIndex,!0)),S=!1}}}),t.layerListEl.append(c)}(n);this.activateLayer(this.selectedSpotIndex),this.updateHeight()}}},{key:"updateButtons",value:function(){var e=this.klCanvasLayerArr.length===c.MAX_LAYERS,t=1===this.klCanvasLayerArr.length;this.addBtn.disabled=e,this.removeBtn.disabled=t,this.duplicateBtn.disabled=e,this.mergeBtn.disabled=0===this.selectedSpotIndex,this.moreDropdown.setEnabled("advanced-merge",!t),this.moreDropdown.setEnabled("merge-all",!t)}},{key:"update",value:function(e){var t=this;this.klCanvasLayerArr=this.klCanvas.getLayers(),(e||0===e)&&(this.selectedSpotIndex=e),this.updateButtons(),setTimeout(function(){return t.createLayerList()},1)}},{key:"getSelected",value:function(){return this.selectedSpotIndex}},{key:"activateLayer",value:function(e){if(e<0||e>this.layerElArr.length-1)throw"invalid spotIndex "+e+", layerElArr.length "+this.layerElArr.length;this.selectedSpotIndex=e,this.modeSelect.setValue(this.klCanvasLayerArr[this.selectedSpotIndex].mixModeStr);for(var t=0;t<this.layerElArr.length;t++){var i=this.layerElArr[t],n=this.selectedSpotIndex===i.spot;(0,f.css)(i,{boxShadow:""}),i.classList.toggle("kl-layer--selected",n),i.opacitySlider.setActive(n),i.isSelected=n}this.mergeBtn.disabled=0===this.selectedSpotIndex}},{key:"setUiState",value:function(e){this.uiState=e,"left"===this.uiState?(0,f.css)(this.largeThumbDiv,{left:"280px",right:""}):(0,f.css)(this.largeThumbDiv,{left:"",right:"280px"})}},{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("705qg",function(t,i){e(t.exports,"MAX_LAYERS",function(){return j}),e(t.exports,"KlCanvas",function(){return F});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("bX4ja"),l=o("eWjiX"),h=o("30Cml"),c=o("3ujzu"),u=o("h20yl"),p=o("esGm2"),d=o("aSJRf"),g=o("1mH1z"),f=o("7EG77");o("ciAU9");var v=o("kFecW"),m=o("83Kse"),y=o("dZ59l"),x=o("kr2fR"),b=o("1RMPr"),w=o("9b3eo"),B=o("bbA6w"),k=o("g03EN"),S=o("eg83P"),C=o("fzzhO"),E=o("fohxs"),L=o("gWfkn"),I=o("dMsoA"),T=o("d9Aov"),A=o("aJgee"),M=o("dAhWm"),R=o("ho2Vj"),_=o("8Cx6U"),P=o("leY4D"),D=o("aiTHL"),N=o("2IBtS"),O=o("7jh4K"),G=o("6NxCO"),H=o("lDHUl"),z=o("gIIqd"),j=16,F=function(){"use strict";function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,n._)(this,e),this.layerNrOffset=i,this.isDestroyed=!1,this.selection=void 0,this.klHistory=t,this.layers=[],this.eyedropper=new(0,D.Eyedropper),this.width=0,this.height=0,this.updateViaComposed({projectId:{value:(0,O.randomUuid)()},size:{width:0,height:0},activeLayerId:"",selection:{value:[]},layerMap:{}},this.klHistory.getComposed())}return(0,r._)(e,[{key:"updateIndices",value:function(){this.layers.forEach(function(e,t){e.index=t})}},{key:"getSelectionOrFallback",value:function(){var e;return null!=(e=this.selection)?e:[[[[0,0],[this.width,0],[this.width,this.height],[0,this.height],[0,0]]]]}},{key:"reset",value:function(e){if(!e.width||!e.height||e.width<1||e.height<1||isNaN(e.width)||isNaN(e.height))throw Error("invalid canvas size");if(this.klHistory.pause(!0),this.width=e.width,this.height=e.height,this.selection=void 0,this.layers.splice(1,Math.max(0,this.layers.length-1)),e.layers)for(var t=0;t<e.layers.length;t++){var i=e.layers[t];this.layers[t]||this.addLayer();var n=this.layers[t];n.id=i.id,n.name=i.name,n.isVisible=i.isVisible,n.mixModeStr=i.mixModeStr?i.mixModeStr:"source-over",n.canvas.width=this.width,n.canvas.height=this.height,n.context.drawImage(i.image,0,0),this.setOpacity(t,i.opacity)}else{var r=this.layers[0];r.name=e.layerName?e.layerName:(0,g.LANG)("layers-layer")+" 1",r.isVisible=!0,r.canvas.width=this.width,r.canvas.height=this.height,r.mixModeStr="source-over",this.setOpacity(0,1),e.color?this.layerFill(0,e.color):e.image&&r.context.drawImage(e.image,0,0)}if(this.updateIndices(),this.klHistory.pause(!1),!this.klHistory.isPaused()){var o,s={projectId:{value:null!=(o=e.projectId)?o:(0,O.randomUuid)()},size:{width:this.width,height:this.height},selection:{value:this.selection},activeLayerId:this.layers[this.layers.length-1].id,layerMap:(0,P.createLayerMap)(this.layers,{attributes:"all"})};this.klHistory.push(s)}return this.layers.length-1}},{key:"isLayerLimitReached",value:function(){return this.layers.length>=j}},{key:"getWidth",value:function(){return this.width}},{key:"getHeight",value:function(){return this.height}},{key:"setSize",value:function(e,t){this.width=e,this.height=t}},{key:"getLayerCount",value:function(){return this.layers.length}},{key:"resize",value:function(e,t){var i,n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"smooth";if(!e||!t||e===this.width&&t===this.height||isNaN(e)||isNaN(t)||e<1||t<1)return!1;if(e=Math.max(e,1),t=Math.max(t,1),"pixelated"===r){i=l.BB.canvas(e,t);var o=l.BB.ctx(i);o.imageSmoothingEnabled=!1;for(var a=0;a<this.layers.length;a++){a>0&&o.clearRect(0,0,e,t);var h=this.layers[a];o.drawImage(h.canvas,0,0,e,t),h.canvas.width=e,h.canvas.height=t,h.context.drawImage(i,0,0)}}else if("smooth"===r){i=l.BB.canvas(),n=l.BB.canvas();for(var c=0;c<this.layers.length;c++)l.BB.resizeCanvas(this.layers[c].canvas,e,t,i,n)}else throw Error("unknown resize algorithm");return this.selection&&(this.selection=(0,B.transformMultiPolygon)(this.selection,(0,v.scale)(e/this.width,t/this.height))),this.width=e,this.height=t,this.klHistory.push((0,s._)({size:{width:this.width,height:this.height},layerMap:(0,P.createLayerMap)(this.layers,{attributes:["tiles"]})},this.selection?{selection:{value:this.selection}}:{})),!0}},{key:"resizeCanvas",value:function(e){var t=Math.round(e.left)+this.width+Math.round(e.right),i=Math.round(e.top)+this.height+Math.round(e.bottom),n=Math.round(e.left),r=Math.round(e.top);if(isNaN(t)||isNaN(i)||t<1||i<1)throw Error("KlCanvas.resizeCanvas - invalid canvas size");for(var o=0;o<this.layers.length;o++){var a=l.BB.canvas(this.width,this.height),h=this.layers[o];l.BB.ctx(a).drawImage(h.canvas,0,0),h.canvas.width=t,h.canvas.height=i,h.context.save(),0===o&&e.fillColor&&(h.context.fillStyle=l.BB.ColorConverter.toRgbStr(e.fillColor),h.context.fillRect(0,0,t,i),h.context.clearRect(n,r,this.width,this.height)),h.context.drawImage(a,n,r),h.context.restore()}this.width=t,this.height=i,this.selection&&(this.selection=(0,H.translateMultiPolygon)(this.selection,n,r)),this.klHistory.push((0,s._)({size:{width:this.width,height:this.height},layerMap:(0,P.createLayerMap)(this.layers,{attributes:["tiles"]})},this.selection?{selection:{value:this.selection}}:{}))}},{key:"addLayer",value:function(e,t){if(this.isLayerLimitReached())return!1;var i,n=void 0===e?this.layers.length:e+1,r=l.BB.canvas(this.width,this.height),o=l.BB.ctx(r);t&&("function"==typeof t.image?t.image(o):o.drawImage(t.image,0,0));var s=(0,I.getNextLayerId)(),a={id:s,index:n,name:t&&void 0!==t.name?t.name:(0,g.LANG)("layers-layer")+" "+(this.layers.length+this.layerNrOffset),mixModeStr:t&&null!=(i=t.mixModeStr)?i:"source-over",isVisible:!t||t.isVisible,opacity:t?t.opacity:1,canvas:r,context:o};return this.layers.splice(n,0,a),this.klHistory.pause(!0),this.setOpacity(n,1),this.klHistory.pause(!1),this.updateIndices(),this.klHistory.isPaused()||this.klHistory.push({activeLayerId:s,layerMap:(0,P.createLayerMap)(this.layers,{attributes:["index"]},{layerId:s,attributes:"all",tiles:t?void 0:(0,T.createFillColorTiles)(this.width,this.height,"transparent")})}),n}},{key:"duplicateLayer",value:function(e){if(!this.layers[e]||this.isLayerLimitReached())return!1;var t=this.layers[e],i=e+1,n=this.klHistory.getComposed().layerMap[t.id],r=l.BB.canvas(this.width,this.height),o=l.BB.ctx(r),a=(0,I.getNextLayerId)(),h={id:a,index:i,name:t.name+" "+(0,g.LANG)("layers-copy"),mixModeStr:t.mixModeStr,isVisible:t.isVisible,opacity:t.opacity,canvas:r,context:o};this.layers.splice(i,0,h);var c=Math.ceil(this.width/L.HISTORY_TILE_SIZE);return n.tiles.forEach(function(e,t){var i=t%c,n=Math.floor(t/c);o.save(),(0,p.isLayerFill)(e)?(o.fillStyle=e.fill,o.fillRect(i*L.HISTORY_TILE_SIZE,n*L.HISTORY_TILE_SIZE,L.HISTORY_TILE_SIZE,L.HISTORY_TILE_SIZE)):o.putImageData(e.data,i*L.HISTORY_TILE_SIZE,n*L.HISTORY_TILE_SIZE),o.restore()}),this.updateIndices(),this.klHistory.isPaused()||this.klHistory.push({activeLayerId:a,layerMap:(0,P.createLayerMap)(this.layers,{attributes:["index"]},{layerId:a,attributes:"all",tiles:n.tiles.map(function(e){return(0,p.isLayerFill)(e)?(0,s._)({},e):(0,N.copyImageDataTile)(e)})})}),e+1}},{key:"getLayerContext",value:function(e,t){if(this.layers[e])return this.layers[e].context;if(t)return null;throw Error("layer of index "+e+" not found (in "+this.layers.length+" layers)")}},{key:"removeLayer",value:function(e){var t=this.layers[e];if(!t)return!1;l.BB.freeCanvas(t.canvas),this.layers.splice(e,1),this.updateIndices();var i=Math.max(0,e-1),n=this.layers[i].id;return this.klHistory.isPaused()||this.klHistory.push({activeLayerId:n,layerMap:(0,P.createLayerMap)(this.layers,{attributes:["index"]})}),i}},{key:"renameLayer",value:function(e,t){var i=this.layers[e];return!!i&&(i.name=t,this.klHistory.isPaused()||this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:i.id,attributes:["name"]})}),!0)}},{key:"setOpacity",value:function(e,t){if(this.layers[e]&&(t=Math.max(0,Math.min(1,t)),this.layers[e].opacity=t,!this.klHistory.isPaused())){var i=this.layers[e].id,n=this.klHistory.getEntries().at(-1).data,r=(0,M.isHistoryEntryOpacityChange)(n,i);this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:i,attributes:["opacity"]})},r)}}},{key:"setLayerIsVisible",value:function(e,t){if(this.layers[e])this.layers[e].isVisible=t;else throw Error(`layer ${e} undefined`);if(!this.klHistory.isPaused()){var i=this.layers[e].id,n=this.klHistory.getEntries().at(-1).data,r=(0,R.isHistoryEntryVisibilityChange)(n,i);this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:i,attributes:["isVisible"]})},r)}}},{key:"moveLayer",value:function(e,t){if(0!==t&&this.layers[e]){var i=this.layers[e];this.layers.splice(e,1);var n=Math.max(0,Math.min(e+t,this.layers.length));return this.layers.splice(n,0,i),this.updateIndices(),this.klHistory.isPaused()||this.klHistory.push({activeLayerId:this.layers[n].id,layerMap:(0,P.createLayerMap)(this.layers,{attributes:["index"]})}),n}}},{key:"mergeLayers",value:function(e,t,i){if(this.layers[e]&&this.layers[t]&&e!==t){if(e>t){var n=e;e=t,t=n}var r=this.layers[t],o=this.layers[e];void 0===i&&(i=r.mixModeStr);var s=this.layers[t].opacity,a=r.opacity>0;if(a){var h=o.context;h.save(),"as-alpha"===i?(l.BB.convertToAlphaChannelCanvas(r.canvas),h.globalCompositeOperation="destination-in"):i&&(h.globalCompositeOperation=i),h.globalAlpha=s,h.drawImage(r.canvas,0,0),h.restore(),i&&(h.save(),h.fillStyle="rgba(0,0,0,0.01)",h.fillRect(-.9999999,-.9999999,1,1),h.restore())}return this.klHistory.pause(!0),this.removeLayer(t),this.klHistory.pause(!1),this.klHistory.isPaused()||this.klHistory.push({activeLayerId:o.id,layerMap:(0,P.createLayerMap)(this.layers,{attributes:["index"]},a?{layerId:o.id,attributes:"all"}:void 0)}),e}}},{key:"mergeAll",value:function(){if(1===this.layers.length)return!1;var e=this.layers[0];e.name=(0,g.LANG)("layers-layer")+" 1";for(var t=e.context,i=1;i<this.layers.length;i++){var n=this.layers[i];n.isVisible&&0!==n.opacity&&(t.save(),t.globalCompositeOperation=n.mixModeStr,t.globalAlpha=n.opacity,t.drawImage(n.canvas,0,0),t.restore())}this.klHistory.pause(!0);for(var r=this.layers.length-1;r>0;r--)this.removeLayer(r);if(this.klHistory.pause(!1),!this.klHistory.isPaused()){var o=e.id;this.klHistory.push({activeLayerId:o,layerMap:(0,P.createLayerMap)(this.layers,{attributes:["tiles"]})})}return 0}},{key:"rotate",value:function(e){for(;e<0;)e+=360;if(90==(e%=360)||180===e||270===e){var t=l.BB.canvas();180===e?(t.width=this.width,t.height=this.height):(90===e||270===e)&&(t.width=this.height,t.height=this.width);var i=(0,m.identity)();90===e?i=(0,y.compose)((0,x.translate)(this.height,0),(0,b.rotate)(Math.PI/2)):180===e?i=(0,y.compose)((0,x.translate)(this.width,this.height),(0,b.rotate)(Math.PI)):270===e&&(i=(0,y.compose)((0,x.translate)(0,this.width),(0,b.rotate)(3*Math.PI/2)));for(var n=l.BB.ctx(t),r=0;r<this.layers.length;r++)n.clearRect(0,0,t.width,t.height),n.save(),n.setTransform.apply(n,(0,a._)((0,C.matrixToTuple)(i))),n.drawImage(this.layers[r].canvas,0,0),n.restore(),this.layers[r].canvas.width=t.width,this.layers[r].canvas.height=t.height,this.layers[r].context.drawImage(t,0,0);this.width=t.width,this.height=t.height,this.selection&&(this.selection=(0,B.transformMultiPolygon)(this.selection,i)),this.klHistory.push((0,s._)({size:{width:this.width,height:this.height},layerMap:(0,P.createLayerMap)(this.layers,{attributes:["tiles"]})},this.selection?{selection:{value:this.selection}}:{}))}}},{key:"flip",value:function(e,t,i){if(e||t){var n=l.BB.canvas(this.width,this.height);n.width=this.width,n.height=this.height;for(var r=l.BB.ctx(n),o=(0,y.compose)((0,x.translate)(n.width/2,n.height/2),(0,v.scale)(e?-1:1,t?-1:1),(0,x.translate)(-n.width/2,-n.height/2)),h=0;h<this.layers.length;h++)(i||0===i)&&h!==i||(r.save(),r.clearRect(0,0,n.width,n.height),r.setTransform.apply(r,(0,a._)((0,C.matrixToTuple)(o))),r.drawImage(this.layers[h].canvas,0,0),r.restore(),this.layers[h].context.clearRect(0,0,this.layers[h].canvas.width,this.layers[h].canvas.height),this.layers[h].context.drawImage(n,0,0));this.selection&&(this.selection=(0,B.transformMultiPolygon)(this.selection,o));var c=void 0===i?void 0:this.layers[i];this.klHistory.push((0,s._)({layerMap:(0,P.createLayerMap)(this.layers,c?{layerId:c.id,attributes:["tiles"]}:{attributes:["tiles"]})},this.selection?{selection:{value:this.selection}}:{}))}}},{key:"drawOperation",value:function(e,t){var i=this.layers[e];t(i.context),this.klHistory.isPaused()||this.klHistory.push({activeLayerId:i.id,layerMap:(0,P.createLayerMap)(this.layers,{layerId:i.id,attributes:["tiles"]})})}},{key:"layerFill",value:function(e,t,i,n){var r,o=this.layers[e].context;o.save();var s=!(n&&this.selection)&&void 0===i;if(i&&(o.globalCompositeOperation=i),n&&this.selection){var a=(0,w.getSelectionPath2d)(this.selection);o.clip(a),r=(0,S.integerBounds)((0,k.getMultiPolyBounds)(this.selection))}var l="rgba("+t.r+","+t.g+","+t.b+",1)";if(o.fillStyle=l,o.fillRect(0,0,this.layers[e].canvas.width,this.layers[e].canvas.height),o.restore(),o.save(),o.fillStyle="rgba(0,0,0,0.01)",o.fillRect(-.9999999,-.9999999,1,1),o.restore(),!this.klHistory.isPaused()){var h=this.layers[e];this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:h.id,attributes:["tiles"],tiles:s?(0,T.createFillColorTiles)(this.width,this.height,l):void 0,bounds:r})})}}},{key:"floodFill",value:function(e,t,i,n,r,o,s,a,c){if(!(t<0)&&!(i<0)&&!(t>=this.width)&&!(i>=this.height)&&0!==r){if(o=Math.round(o),t=Math.round(t),i=Math.round(i),!["above","current","all"].includes(s))throw Error("invalid sampleStr");var u,p,d,g=this.selection?(0,z.getBinaryMask)(this.selection,this.width,this.height):void 0;if(!g||0!==g[i*this.width+t]){var f=this.layers[e];if("all"===s){var v=1===this.layers.length?this.layers[0].canvas:this.getCompleteCanvas(1),m=l.BB.ctx(v).getImageData(0,0,this.width,this.height).data;u=(0,h.floodFillBits)(m,g,this.width,this.height,t,i,o,Math.round(a),c),d=(p=f.context).getImageData(0,0,this.width,this.height)}else{var y="above"===s?e+1:e;if(y>=this.layers.length)return;var x=this.layers[y].context,b=x.getImageData(0,0,this.width,this.height),w=b.data;u=(0,h.floodFillBits)(w,g,this.width,this.height,t,i,o,Math.round(a),c),p=e===y?x:f.context,d=e===y?b:p.getImageData(0,0,this.width,this.height)}var B=d.data;if(n)if(1===r)for(var k=0;k<this.width*this.height;k++)255===u.data[k]&&(B[4*k]=n.r,B[4*k+1]=n.g,B[4*k+2]=n.b,B[4*k+3]=255);else for(var S=0;S<this.width*this.height;S++)255===u.data[S]&&(B[4*S]=l.BB.mix(B[4*S],n.r,r),B[4*S+1]=l.BB.mix(B[4*S+1],n.g,r),B[4*S+2]=l.BB.mix(B[4*S+2],n.b,r),B[4*S+3]=l.BB.mix(B[4*S+3],255,r));else if(1===r)for(var C=0;C<this.width*this.height;C++)255===u.data[C]&&(B[4*C+3]=0);else for(var E=0;E<this.width*this.height;E++)255===u.data[E]&&(B[4*E+3]=l.BB.mix(B[4*E+3],0,r));p.putImageData(d,0,0),this.klHistory.isPaused()||this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:f.id,attributes:["tiles"],bounds:u.bounds})})}}}},{key:"drawShape",value:function(e,t){if(t.x1!==t.x2||t.y1!==t.y2){var i=this.layers[e],n=this.selection?new Path2D((0,w.getSelectionPath2d)(this.selection)):void 0,r=(0,S.integerBounds)((0,c.drawShape)(i.context,t,n));this.klHistory.isPaused()||this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:i.id,attributes:["tiles"],bounds:r})})}}},{key:"drawGradient",value:function(e,t){var i=this.layers[e],n=this.selection?new Path2D((0,w.getSelectionPath2d)(this.selection)):void 0;(0,f.drawGradient)(i.context,t,n),this.klHistory.isPaused()||this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:i.id,attributes:["tiles"]})})}},{key:"text",value:function(e,t){var i=this.layers[e],n=(0,u.renderText)(i.canvas,l.BB.copyObj(t),this.selection?new Path2D((0,w.getSelectionPath2d)(this.selection)):void 0),r=2+(t.stroke?t.stroke.lineWidth/2:0),o=(0,_.transformBounds)({x1:n.x,y1:n.y,x2:n.x+n.width,y2:n.y+n.height},(0,y.compose)((0,x.translate)(t.x,t.y),(0,b.rotate)(-t.angleRad)));o=(0,S.integerBounds)({x1:o.x1-r,y1:o.y1-r,x2:o.x2+r,y2:o.y2+r}),this.klHistory.isPaused()||this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:i.id,attributes:["tiles"],bounds:o})})}},{key:"eraseLayer",value:function(e){var t,i=this.layers[e.layerIndex],n=i.context;if(n.save(),e.useSelection&&this.selection){var r=(0,w.getSelectionPath2d)(this.selection);n.clip(r),t=(0,S.integerBounds)((0,k.getMultiPolyBounds)(this.selection))}e.useAlphaLock?n.globalCompositeOperation="source-in":n.globalCompositeOperation="destination-out",n.fillStyle=l.BB.ColorConverter.toRgbStr((0,E.getEraseColor)()),n.fillRect(0,0,this.width,this.height),n.restore();var o=!e.useAlphaLock&&!(e.useSelection&&this.selection);this.klHistory.isPaused()||this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:i.id,attributes:["tiles"],tiles:o?(0,T.createFillColorTiles)(this.width,this.height,"transparent"):void 0,bounds:t})})}},{key:"getKlHistory",value:function(){return this.klHistory}},{key:"getLayersRaw",value:function(){return this.layers}},{key:"getLayers",value:function(){return this.layers.map(function(e){return{id:e.id,canvas:e.canvas,context:e.context,isVisible:e.isVisible,opacity:e.opacity,name:e.name,mixModeStr:e.mixModeStr}})}},{key:"getLayersFast",value:function(){return this.layers.map(function(e){return(0,s._)({canvas:e.canvas,isVisible:e.isVisible,opacity:e.opacity,name:e.name,mixModeStr:e.mixModeStr},e.compositeObj?{compositeObj:e.compositeObj}:{})})}},{key:"getLayerIndex",value:function(e,t){for(var i=0;i<this.layers.length;i++)if(this.layers[i].canvas===e)return i;if(!t)throw Error("layer not found (in "+this.layers.length+" layers)");return null}},{key:"getLayerOld",value:function(e,t){if(this.layers[e])return{context:this.layers[e].context,isVisible:this.layers[e].isVisible,opacity:this.layers[e].opacity,name:this.layers[e].name,id:e};if(!t)throw Error("layer of index "+e+" not found (in "+this.layers.length+" layers)");return null}},{key:"getLayer",value:function(e){return this.layers[e]}},{key:"getColorAt",value:function(e,t){return this.eyedropper.getColorAt(e,t,this.klHistory.getComposed())}},{key:"getCompleteCanvas",value:function(e,t){return(0,d.drawProject)(this.getProject(),e,t?this.selection:void 0)}},{key:"getProject",value:function(){return{projectId:this.klHistory.getComposed().projectId.value,width:this.width,height:this.height,layers:this.layers.map(function(e){return{name:e.name,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,image:e.canvas}})}}},{key:"setMixMode",value:function(e,t){var i=this.layers[e];i.mixModeStr=t,this.klHistory.isPaused()||this.klHistory.push({layerMap:(0,P.createLayerMap)(this.layers,{layerId:i.id,attributes:["mixModeStr"]})})}},{key:"setComposite",value:function(e,t){if(!this.layers[e])throw Error("invalid layer");this.layers[e].compositeObj=t}},{key:"setSelection",value:function(e){(this.selection||e)&&(this.selection=e,this.klHistory.push({selection:{value:e}}))}},{key:"getSelection",value:function(){return this.selection}},{key:"getSelectionArea",value:function(e){var t=this.layers[e],i=this.getSelectionOrFallback();return(0,G.getSelectionBounds)(i,t.context)}},{key:"updateViaComposed",value:function(e,t){this.width=t.size.width,this.height=t.size.height,this.selection=t.selection.value,this.layers=(0,A.updateLayersViaComposed)(this.layers,e,t)}},{key:"destroy",value:function(){this.isDestroyed||(this.layers.forEach(function(e){l.BB.freeCanvas(e.canvas),e.canvas={},e.context={}}),this.layers=[],this.isDestroyed=!0)}}]),e}()}),s("30Cml",function(t,i){function n(e,t,i,n,r,o,s){return Math.pow(e[4*s]-t,2)<=o&&Math.pow(e[4*s+1]-i,2)<=o&&Math.pow(e[4*s+2]-n,2)<=o&&Math.pow(e[4*s+3]-r,2)<=o}function r(e,t){return!e||!!e[t]}function o(e,t,i,o,s,a,l,h,c){s=Math.round(s),a=Math.round(a);var u=new Uint8Array(new ArrayBuffer(i*o)),p=function(e,t,i,o,s,a,l,h,c,u){var p,d,g,f,v,m,y,x,b,w,B,k,S=e[(l*o+a)*4],C=e[(l*o+a)*4+1],E=e[(l*o+a)*4+2],L=e[(l*o+a)*4+3],I=new DataView(e.buffer),T=I.getUint32((l*o+a)*4,!0),A=Math.pow(h,2),M={x1:a,y1:l,x2:a,y2:l};if(u){var R,_,P,D,N=[];for(N.push(l*o+a),i[l*o+a]=255;N.length;)D=Math.floor((R=N.pop())/o),(P=R%o)>0&&255!==i[_=R-1]&&r(t,_)&&(I.getUint32(4*_,!0)===T||h>0&&n(e,S,C,E,L,A,_))&&(M.x1=Math.min(M.x1,P-1),i[_]=255,N.push(_)),P<o-1&&255!==i[_=R+1]&&r(t,_)&&(I.getUint32(4*_,!0)===T||h>0&&n(e,S,C,E,L,A,_))&&(M.x2=Math.max(M.x2,P+1),i[_]=255,N.push(_)),D>0&&255!==i[_=R-o]&&r(t,_)&&(I.getUint32(4*_,!0)===T||h>0&&n(e,S,C,E,L,A,_))&&(M.y1=Math.min(M.y1,D-1),i[_]=255,N.push(_)),D<s-1&&255!==i[_=R+o]&&r(t,_)&&(I.getUint32(4*_,!0)===T||h>0&&n(e,S,C,E,L,A,_))&&(M.y2=Math.max(M.y2,D+1),i[_]=255,N.push(_))}else for(var O=0,G=0;O<s;O++)for(var H=0;H<o;H++,G++)r(t,G)&&(I.getUint32(4*G,!0)===T||h>0&&n(e,S,C,E,L,A,G))&&(i[G]=255,H<M.x1&&(M.x1=H),O<M.y1&&(M.y1=O),H>M.x2&&(M.x2=H),O>M.y2&&(M.y2=O));if(0===c)return M;for(var z=M.x1;z<=M.x2;z++)for(var j=M.y1;j<=M.y2;j++)255===i[j*o+z]&&(p=z,d=z,g=j,f=j,v=255!==i[j*o+z-1],m=255!==i[(j-1)*o+z-1],y=255!==i[(j-1)*o+z],x=255!==i[(j-1)*o+z+1],b=255!==i[j*o+z+1],w=255!==i[(j+1)*o+z+1],B=255!==i[(j+1)*o+z],k=255!==i[(j+1)*o+z-1],v&&(p=z-c),v&&m&&y&&(p=z-c,g=j-c),y&&(g=Math.min(g,j-c)),y&&x&&b&&(g=Math.min(g,j-c),d=z+c),b&&(d=Math.max(d,z+c)),b&&w&&B&&(d=Math.max(d,z+c),f=Math.max(f,j+c)),B&&(f=Math.max(f,j+c)),B&&k&&v&&(p=Math.min(p,z-c),f=Math.max(f,j+c)),(v||m||y||x||b||w||B||k)&&function(e,t,i,n,r,o){for(var s=i;s<=r;s++)for(var a=n;a<=o;a++)255!==e[a*t+s]&&(e[a*t+s]=254)}(i,o,Math.max(0,p),Math.max(0,g),Math.min(o-1,d),Math.min(s-1,f)));for(var F=0;F<o*s;F++)254===i[F]&&(i[F]=255);return M.x1-=c,M.y1-=c,M.x2+=c,M.y2+=c,M}(e,t,u,i,o,s,a,l,h,c);return{data:u,bounds:p}}e(t.exports,"floodFillBits",function(){return o})}),s("3ujzu",function(t,i){e(t.exports,"ShapeTool",function(){return d}),e(t.exports,"drawShape",function(){return g});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("bX4ja"),l=o("eWjiX"),h=o("8Cx6U");o("ciAU9");var c=o("dZ59l"),u=o("1RMPr"),p=o("fzzhO"),d=function(){"use strict";function e(t){(0,n._)(this,e),this.downX=0,this.downY=0,this.downAngleRad=0,this.onShape=t.onShape}return(0,r._)(e,[{key:"onDown",value:function(e,t,i){this.downX=e,this.downY=t,this.downAngleRad=i}},{key:"onMove",value:function(e,t){this.onShape(!1,this.downX,this.downY,e,t,this.downAngleRad)}},{key:"onUp",value:function(e,t){this.onShape(!0,this.downX,this.downY,e,t,this.downAngleRad)}}]),e}();function g(e,t,i){t=(0,s._)({angleRad:0,isOutwards:!1,opacity:1,isEraser:!1,doLockAlpha:!1},l.BB.copyObj(t));var n={x1:0,y1:0,x2:0,y2:0};if(["rect","ellipse","line"].includes(t.type)){if(void 0===t.angleRad)throw Error("angleRad undefined");var r,o,d=void 0===t.lineWidth?-1:Math.round(t.lineWidth),g=180*t.angleRad/Math.PI;if(!t.isEraser&&void 0===t.fillRgb&&void 0===t.strokeRgb)throw Error("fillRgb and strokeRgb undefined");var f=t.isEraser?{r:255,g:255,b:255}:t.fillRgb?t.fillRgb:t.strokeRgb;e.save(),i&&e.clip(i),t.opacity&&(e.globalAlpha=t.opacity),t.isEraser&&(e.globalCompositeOperation="destination-out"),t.doLockAlpha&&(e.globalCompositeOperation="source-atop");var v=(0,c.compose)((0,u.rotate)(-t.angleRad));e.setTransform.apply(e,(0,a._)((0,p.matrixToTuple)(v))),t.fillRgb?e.fillStyle=l.BB.ColorConverter.toRgbStr(f):t.strokeRgb&&(e.strokeStyle=l.BB.ColorConverter.toRgbStr(f),e.lineWidth=d);var m=t.x1,y=t.y1,x=t.x2,b=t.y2;if(t.isAngleSnap){var w=l.BB.rotate(m,y,t.angleRad/Math.PI*180),B=l.BB.rotate(x,b,t.angleRad/Math.PI*180),k=l.BB.pointsToAngleDeg(w,B)+90,S=45*Math.round(k/45),C=l.BB.rotateAround({x:m,y:y},{x:x,y:b},S-k);x=C.x,b=C.y,(g+S)%90==0&&(Math.round((g-S)/90)%2==0?x=m:b=y)}var E=m,L=y,I=x-m,T=b-y;if("line"!==t.type&&t.isFixedRatio){var A=l.BB.rotate(t.x1,t.y1,t.angleRad/Math.PI*180),M=l.BB.rotate(t.x2,t.y2,t.angleRad/Math.PI*180),R=A.x,_=A.y,P=M.x-A.x,D=M.y-A.y;Math.abs(P)<Math.abs(D)?D=Math.abs(P)*(D<0?-1:1):P=Math.abs(D)*(P<0?-1:1),M.x=R+P,M.y=_+D,A=l.BB.rotate(A.x,A.y,-t.angleRad/Math.PI*180),M=l.BB.rotate(M.x,M.y,-t.angleRad/Math.PI*180),m=A.x,y=A.y,x=M.x,b=M.y,E=m,L=y,I=x-m,T=b-y}if(t.isOutwards&&(E-=I,L-=T,I*=2,T*=2,m=E,y=L,x=E+I,b=L+T),"line"===t.type){var N=Math.round(m),O=Math.round(y),G=Math.round(x),H=Math.round(b),z=Math.floor(m),j=Math.floor(y),F=Math.floor(x),V=Math.floor(b);d%2==0?O===H?(r={x:z,y:O},o={x:F,y:H},z<F?o.x+=1:r.x+=1):N===G?(r={x:N,y:j},o={x:G,y:V},j<V?o.y+=1:r.y+=1):(r={x:m,y:y},o={x:x,y:b}):(r={x:z,y:j},o={x:F,y:V},j===V?(z<F?o.x+=1:r.x+=1,r.y+=.5,o.y+=.5):z===F?(j<V?o.y+=1:r.y+=1,r.x+=.5,o.x+=.5):(r.x=m,r.y=y,o.x=x,o.y=b)),n={x1:Math.min(r.x,o.x)-d/2,y1:Math.min(r.y,o.y)-d/2,x2:Math.max(r.x,o.x)+d/2,y2:Math.max(r.y,o.y)+d/2},r=l.BB.rotate(r.x,r.y,t.angleRad/Math.PI*180),o=l.BB.rotate(o.x,o.y,t.angleRad/Math.PI*180),e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(o.x,o.y),e.stroke()}else if("rect"===t.type){var U=Math.floor(m),W=Math.floor(y),X=Math.floor(x),K=Math.floor(b);g%90==0?t.fillRgb?(m%1==0&&(m+=1),y%1==0&&(y+=1),x%1==0&&(x+=1),b%1==0&&(b+=1),r={x:m<x?U:X,y:y<b?W:K},(o={x:Math.ceil((m<x?x:m)-r.x),y:Math.ceil((y<b?b:y)-r.y)}).x=r.x+o.x,o.y=r.y+o.y):d%2==0?(r={x:U,y:W},o={x:X,y:K}):(r={x:U+.5,y:W+.5},o={x:X+.5,y:K+.5}):(r={x:m,y:y},o={x:x,y:b}),r=l.BB.rotate(r.x,r.y,t.angleRad/Math.PI*180),o=l.BB.rotate(o.x,o.y,t.angleRad/Math.PI*180);var Y={x:r.x,y:r.y,width:o.x-r.x,height:o.y-r.y},Z=t.fillRgb?0:d/2;n=(0,h.transformBounds)({x1:Math.min(r.x,o.x)-Z,y1:Math.min(r.y,o.y)-Z,x2:Math.max(r.x,o.x)+Z,y2:Math.max(r.y,o.y)+Z},v),t.fillRgb?e.fillRect(Y.x,Y.y,Y.width,Y.height):e.strokeRect(Y.x,Y.y,Y.width,Y.height)}else{r=l.BB.rotate(m,y,t.angleRad/Math.PI*180),o=l.BB.rotate(x,b,t.angleRad/Math.PI*180),E=r.x,L=r.y;var q={x:E+(I=o.x-r.x)/2,y:L+(T=o.y-r.y)/2},$=Math.abs(I/2),Q=Math.abs(T/2);e.beginPath(),e.ellipse(q.x,q.y,$,Q,0,0,2*Math.PI),t.fillRgb?e.fill():e.stroke();var J=t.fillRgb?0:d/2;n=(0,h.transformBounds)({x1:q.x-$-J,y1:q.y-Q-J,x2:q.x+$+J,y2:q.y+Q+J},v)}e.restore()}else throw Error("unknown shape");return n}}),s("8Cx6U",function(t,i){e(t.exports,"transformBounds",function(){return r}),o("ciAU9");var n=o("cdZRx");function r(e,t){var i=(0,n.applyToPoint)(t,{x:e.x1,y:e.y1}),r=(0,n.applyToPoint)(t,{x:e.x2,y:e.y1}),o=(0,n.applyToPoint)(t,{x:e.x2,y:e.y2}),s=(0,n.applyToPoint)(t,{x:e.x1,y:e.y2});return{x1:Math.min(i.x,r.x,o.x,s.x),y1:Math.min(i.y,r.y,o.y,s.y),x2:Math.max(i.x,r.x,o.x,s.x),y2:Math.max(i.y,r.y,o.y,s.y)}}}),s("h20yl",function(t,i){e(t.exports,"renderText",function(){return r});var n=o("eWjiX");function r(e,t,i){t=n.BB.copyObj(t);var r=n.BB.ctx(e);r.save(),i&&r.clip(i),r.textAlign=t.align,r.letterSpacing=t.letterSpacing?t.letterSpacing+"px":"0";var o=[t.size+"px "+(t.font?t.font:"sans-serif")];t.isBold&&o.unshift("bold"),t.isItalic&&o.unshift("italic"),r.font=o.join(" "),r.fillStyle=t.fill?n.BB.ColorConverter.toRgbaStr(t.fill.color):"transparent",r.strokeStyle=t.stroke?n.BB.ColorConverter.toRgbaStr(t.stroke.color):"transparent",t.stroke&&(r.lineWidth=t.stroke.lineWidth,r.lineJoin="round"),r.translate(t.x,t.y),r.rotate(-t.angleRad);var s=t.text.split("\n").map(function(e){return e.replaceAll("	","    ")}),a={x1:0,y1:0,x2:0,y2:0},l=!0;return s.forEach(function(e,i){var n,o,s,h,c,u,p,d=r.measureText(e),g=t.size*(null!=(p=t.lineHeight)?p:1)*i,f=(n=t.align,o=d.actualBoundingBoxAscent,s=d.actualBoundingBoxDescent,h=d.actualBoundingBoxLeft,c=d.actualBoundingBoxRight+h,u=o+s,"left"===n?{x:-h,y:-o,width:c,height:u}:"right"===n?{x:-c,y:-o,width:c,height:u}:{x:-h,y:-o,width:c,height:u});l?(l=!1,a.x1=0+f.x,a.y1=g+f.y,a.x2=0+f.x+f.width,a.y2=g+f.y+f.height):(a.x1=Math.min(a.x1,0+f.x),a.y1=Math.min(a.y1,g+f.y),a.x2=Math.max(a.x2,0+f.x+f.width),a.y2=Math.max(a.y2,g+f.y+f.height))}),s.forEach(function(e,i){var n,o=t.size*(null!=(n=t.lineHeight)?n:1)*i;r.strokeText(e,0,o)}),s.forEach(function(e,i){var n,o=t.size*(null!=(n=t.lineHeight)?n:1)*i;r.fillText(e,0,o)}),r.restore(),{x:a.x1,y:a.y1,width:a.x2-a.x1,height:a.y2-a.y1}}}),s("aSJRf",function(t,i){e(t.exports,"drawProject",function(){return h});var n=o("eWjiX"),r=o("esGm2"),s=o("bbA6w");o("ciAU9");var a=o("kFecW"),l=o("9b3eo");function h(e,t,i){var o=n.BB.canvas(Math.max(1,Math.round(e.width*t)),Math.max(1,Math.round(e.height*t))),h=i?(0,s.transformMultiPolygon)(i,(0,a.scale)(o.width/e.width,o.height/e.height)):void 0,c=n.BB.ctx(o);c.save(),h&&c.clip((0,l.getSelectionPath2d)(h)),t>1&&(c.imageSmoothingEnabled=!1);for(var u=0;u<e.layers.length;u++){var p=e.layers[u];if(p.isVisible&&0!==p.opacity){c.globalAlpha=p.opacity;var d=p.mixModeStr;if(c.globalCompositeOperation=void 0!==d?d:"source-over",(0,r.isLayerFill)(p.image))c.fillStyle=p.image.fill,c.fillRect(0,0,o.width,o.height);else if(p.image instanceof Array)throw Error("not implemented");else c.drawImage(p.image,0,0,o.width,o.height)}}return c.restore(),o}}),s("7EG77",function(t,i){e(t.exports,"GradientTool",function(){return h}),e(t.exports,"drawGradient",function(){return c});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("4EWN2"),l=o("eWjiX"),h=function(){"use strict";function e(t){(0,n._)(this,e),this.downX=0,this.downY=0,this.downAngleRad=0,this.onGradient=t.onGradient}return(0,r._)(e,[{key:"onDown",value:function(e,t,i){this.downX=e,this.downY=t,this.downAngleRad=i}},{key:"onMove",value:function(e,t){this.onGradient(!1,this.downX,this.downY,e,t,this.downAngleRad)}},{key:"onUp",value:function(e,t){this.onGradient(!0,this.downX,this.downY,e,t,this.downAngleRad)}}]),e}();function c(e,t,i){e.save(),i&&e.clip(i);var n,r=t.x1,o=t.y1,h=t.x2,c=t.y2;if(t.doSnap){var u=180*t.angleRad/Math.PI,p=l.BB.rotate(r,o,t.angleRad/Math.PI*180),d=l.BB.rotate(h,c,t.angleRad/Math.PI*180),g=l.BB.pointsToAngleDeg(p,d)+90,f=45*Math.round(g/45),v=l.BB.rotateAround({x:r,y:o},{x:h,y:c},f-g);h=v.x,c=v.y,(u+f)%90==0&&(Math.round((u-f)/90)%2==0?h=r:c=o)}var m=t.color1;t.isEraser&&t.doLockAlpha&&(m={r:255,g:255,b:255});var y=(0,a._)((0,s._)({},m),{a:t.opacity}),x=(0,a._)((0,s._)({},m),{a:0});if(t.isReversed){var b=y;y=x,x=b}if("linear"===t.type)(n=e.createLinearGradient(r,o,h,c)).addColorStop(0,l.BB.ColorConverter.toRgbaStr(y)),n.addColorStop(1,l.BB.ColorConverter.toRgbaStr(x));else if("linear-mirror"===t.type){var w={x:h-r,y:c-o};(n=e.createLinearGradient(r-w.x,o-w.y,h,c)).addColorStop(0,l.BB.ColorConverter.toRgbaStr(x)),n.addColorStop(.5,l.BB.ColorConverter.toRgbaStr(y)),n.addColorStop(1,l.BB.ColorConverter.toRgbaStr(x))}else if("radial"===t.type){var B=l.BB.Vec2.dist({x:r,y:o},{x:h,y:c});(n=e.createRadialGradient(r,o,0,r,o,B)).addColorStop(0,l.BB.ColorConverter.toRgbaStr(y)),n.addColorStop(1,l.BB.ColorConverter.toRgbaStr(x))}e.fillStyle=n,t.isEraser&&(e.globalCompositeOperation="destination-out"),t.doLockAlpha&&(e.globalCompositeOperation="source-atop"),e.fillRect(0,0,e.canvas.width,e.canvas.height),e.restore()}}),s("dMsoA",function(t,i){e(t.exports,"getNextLayerId",function(){return r});var n=0;function r(){return""+n++}}),s("d9Aov",function(t,i){e(t.exports,"createFillColorTiles",function(){return r});var n=o("gWfkn");function r(e,t,i){for(var r=[],o=Math.ceil(e/n.HISTORY_TILE_SIZE),s=Math.ceil(t/n.HISTORY_TILE_SIZE),a=0;a<s;a++)for(var l=0;l<o;l++)r.push({fill:i});return r}}),s("aJgee",function(t,i){e(t.exports,"updateLayersViaComposed",function(){return h});var n=o("8N5YG"),r=o("gWfkn"),s=o("eWjiX"),a=o("7nLJW"),l=o("esGm2");function h(e,t,i){var o=t.size.width!==i.size.width||t.size.height!==i.size.height;return Object.entries(i.layerMap).map(function(a){var h=(0,n._)(a,2),c=h[0],u=h[1],p={},d={},g=t.layerMap[c],f=Math.ceil(i.size.width/r.HISTORY_TILE_SIZE);return o||!g?(p=s.BB.canvas(i.size.width,i.size.height),d=s.BB.ctx(p),u.tiles.forEach(function(e,t){var i=t%f,n=Math.floor(t/f);(0,l.isLayerFill)(e)?(d.save(),d.fillStyle=e.fill,d.fillRect(i*r.HISTORY_TILE_SIZE,n*r.HISTORY_TILE_SIZE,r.HISTORY_TILE_SIZE,r.HISTORY_TILE_SIZE),d.restore()):d.putImageData(e.data,i*r.HISTORY_TILE_SIZE,n*r.HISTORY_TILE_SIZE)})):(p=e[g.index].canvas,d=e[g.index].context,u.tiles.forEach(function(e,t){if(e!==g.tiles[t]){var i=t%f,n=Math.floor(t/f);(0,l.isLayerFill)(e)?(d.save(),d.fillStyle=e.fill,d.clearRect(i*r.HISTORY_TILE_SIZE,n*r.HISTORY_TILE_SIZE,r.HISTORY_TILE_SIZE,r.HISTORY_TILE_SIZE),d.fillRect(i*r.HISTORY_TILE_SIZE,n*r.HISTORY_TILE_SIZE,r.HISTORY_TILE_SIZE,r.HISTORY_TILE_SIZE),d.restore()):d.putImageData(e.data,i*r.HISTORY_TILE_SIZE,n*r.HISTORY_TILE_SIZE)}})),{id:c,index:u.index,name:u.name,mixModeStr:u.mixModeStr,isVisible:u.isVisible,opacity:u.opacity,canvas:p,context:d}}).sort(a.sortLayerMap)}}),s("7nLJW",function(t,i){e(t.exports,"sortLayerMap",function(){return n});function n(e,t){return e.index>t.index?1:e.index<t.index?-1:0}}),s("dAhWm",function(t,i){e(t.exports,"isHistoryEntryOpacityChange",function(){return n});function n(e,t){if(1!==Object.keys(e).length||!e.layerMap)return!1;for(var i=Object.keys(e.layerMap),n=0;n<i.length;n++){var r=i[n],o=e.layerMap[r];if(r===t){var s=Object.keys(o);if(1!==s.length||"opacity"!==s[0])return!1}else if(Object.keys(o).length>0)return!1}return!0}}),s("ho2Vj",function(t,i){e(t.exports,"isHistoryEntryVisibilityChange",function(){return n});function n(e,t){if(1!==Object.keys(e).length||!e.layerMap)return!1;for(var i=Object.keys(e.layerMap),n=0;n<i.length;n++){var r=i[n],o=e.layerMap[r];if(r===t){var s=Object.keys(o);if(1!==s.length||"isVisible"!==s[0])return!1}else if(Object.keys(o).length>0)return!1}return!0}}),s("leY4D",function(t,i){e(t.exports,"createLayerMap",function(){return s});var n=o("4sWjZ");function r(e,t,i,r){var o="all"===t,s={};return(o||t.includes("name"))&&(s.name=e.name),(o||t.includes("opacity"))&&(s.opacity=e.opacity),(o||t.includes("isVisible"))&&(s.isVisible=e.isVisible),(o||t.includes("mixModeStr"))&&(s.mixModeStr=e.mixModeStr),(o||t.includes("index"))&&(s.index=e.index),(o||t.includes("tiles"))&&(s.tiles=null!=r?r:(0,n.canvasToLayerTiles)(e.context.canvas,i)),s}function s(e){for(var t,i=arguments.length,n=Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];var s=null!=(t=n.find(function(e){return e&&!("layerId"in e)}))?t:{attributes:[]},a=n.filter(function(e){return!!e}).filter(function(e){return"layerId"in e});return Object.fromEntries(e.map(function(e,t){var i=!0,n=!1,o=void 0;try{for(var l,h=a[Symbol.iterator]();!(i=(l=h.next()).done);i=!0){var c=l.value;if(c.layerId===e.id)return[e.id,r(e,c.attributes,c.bounds,c.tiles)]}}catch(e){n=!0,o=e}finally{try{i||null==h.return||h.return()}finally{if(n)throw o}}return[e.id,r(e,s.attributes)]}))}}),s("4sWjZ",function(t,i){e(t.exports,"canvasAndChangedTilesToLayerTiles",function(){return l}),e(t.exports,"canvasToLayerTiles",function(){return h});var n=o("gWfkn"),r=o("5Q8fp"),s=o("69IwK"),a=o("2IBtS");function l(e,t){for(var i=[],o=Math.ceil(e.width/n.HISTORY_TILE_SIZE),s=Math.ceil(e.height/n.HISTORY_TILE_SIZE),l=0;l<s;l++)for(var h=0;h<o;h++)i.push(t[l*o+h]?(0,a.createImageDataTile)((0,r.getTileFromCanvas)(e,h,l,n.HISTORY_TILE_SIZE)):void 0);return i}function h(e,t){if(t){var i=(0,s.getChangedTiles)(t,e.width,e.height);return l(e,i)}for(var r=e.getContext("2d").getImageData(0,0,e.width,e.height),o=Math.ceil(e.width/n.HISTORY_TILE_SIZE),h=Math.ceil(e.height/n.HISTORY_TILE_SIZE),c=[],u=0;u<h;u++)for(var p=0;p<o;p++){for(var d=p*n.HISTORY_TILE_SIZE,g=u*n.HISTORY_TILE_SIZE,f=Math.min(n.HISTORY_TILE_SIZE,e.width-d),v=Math.min(n.HISTORY_TILE_SIZE,e.height-g),m=new ImageData(f,v),y=0;y<v;y++){var x=((g+y)*e.width+d)*4,b=y*f*4;m.data.set(r.data.subarray(x,x+4*f),b)}c.push((0,a.createImageDataTile)(m))}return c}}),s("5Q8fp",function(t,i){e(t.exports,"getTileFromCanvas",function(){return r});var n=o("eWjiX");function r(e,t,i,r){var o=n.BB.ctx(e),s=Math.min(e.width,(t+1)*r)-t*r,a=Math.min(e.height,(i+1)*r)-i*r;if(s<=0||a<=0)throw Error("invalid out-of-bounds tile");return o.getImageData(t*r,i*r,s,a)}}),s("69IwK",function(t,i){e(t.exports,"getChangedTiles",function(){return a}),e(t.exports,"updateChangedTiles",function(){return l});var n=o("gWfkn"),r=o("eg83P"),s=o("7jh4K");function a(e,t,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:n.HISTORY_TILE_SIZE;e={x1:Math.min(e.x1,e.x2),y1:Math.min(e.y1,e.y2),x2:Math.max(e.x1,e.x2),y2:Math.max(e.y1,e.y2)};var a=(0,r.boundsInArea)(e,t,i),l=Math.ceil(t/o),h=Math.ceil(i/o);if(!a)return(0,s.createArray)(l*h,!1);for(var c=(0,s.createArray)(l*h,!1),u={x1:(0,r.clamp)(Math.floor(e.x1/o),0,l-1),y1:(0,r.clamp)(Math.floor(e.y1/o),0,h-1),x2:(0,r.clamp)(Math.floor(e.x2/o),0,l-1),y2:(0,r.clamp)(Math.floor(e.y2/o),0,h-1)},p=u.x1;p<=u.x2;p++)for(var d=u.y1;d<=u.y2;d++)c[d*l+p]=!0;return c}function l(e,t){return t.map(function(t,i){return t||!!e[i]})}}),s("2IBtS",function(t,i){e(t.exports,"createImageDataTile",function(){return s}),e(t.exports,"copyImageDataTile",function(){return a});var n=o("9ubcA"),r=o("7jh4K");function s(e){return{id:(0,r.randomUuid)(),data:e}}function a(e){return{id:(0,r.randomUuid)(),data:(0,n.copyImageData)(e.data)}}}),s("9ubcA",function(t,i){e(t.exports,"copyImageData",function(){return n});var n=function(e){return new ImageData(new Uint8ClampedArray(e.data),e.width,e.height)}}),s("aiTHL",function(t,i){e(t.exports,"Eyedropper",function(){return c});var n=o("cx0mh"),r=o("7h4XF"),s=o("esGm2"),a=o("eWjiX"),l=o("gWfkn"),h=o("7nLJW"),c=function(){"use strict";function e(){(0,n._)(this,e)}return(0,r._)(e,[{key:"getColorAt",value:function(e,t,i){if(e=Math.floor(e),t=Math.floor(t),e<0||e>=i.size.width||t<0||t>=i.size.height)return new a.BB.RGB(0,0,0);var n=a.BB.canvas(1,1),r=a.BB.ctx(n);r.imageSmoothingEnabled=!1;var o=Math.ceil(i.size.width/l.HISTORY_TILE_SIZE),c=Math.floor(e/l.HISTORY_TILE_SIZE),u=Math.floor(t/l.HISTORY_TILE_SIZE)*o+c;Object.values(i.layerMap).sort(h.sortLayerMap).forEach(function(n){if(n.isVisible&&0!==n.opacity){var h=n.tiles[u],p="";if((0,s.isLayerFill)(h))p=h.fill;else{var d=l.HISTORY_TILE_SIZE;i.size.width%l.HISTORY_TILE_SIZE!=0&&c===o-1&&(d=i.size.width%l.HISTORY_TILE_SIZE);var g=t%l.HISTORY_TILE_SIZE*d+e%l.HISTORY_TILE_SIZE;if(0===h.data.data[4*g+3])return;p=a.BB.ColorConverter.toRgbaStr({r:h.data.data[4*g],g:h.data.data[4*g+1],b:h.data.data[4*g+2],a:h.data.data[4*g+3]/255})}r.fillStyle=p,r.globalAlpha=n.opacity,r.globalCompositeOperation=n.mixModeStr,r.fillRect(0,0,1,1)}});var p=r.getImageData(0,0,1,1);return new a.BB.RGB(p.data[0],p.data[1],p.data[2])}}]),e}()}),s("6NxCO",function(t,i){e(t.exports,"getSelectionBounds",function(){return a});var n=o("g03EN"),r=o("eg83P"),s=o("eIcQa");function a(e,t){var i=(0,n.getMultiPolyBounds)(e),o=(0,r.intBoundsWithinArea)(i,t.canvas.width,t.canvas.height,!0);if(o)return(0,s.canvasBounds)(t,o)}}),s("lDHUl",function(t,i){e(t.exports,"translateMultiPolygon",function(){return n});function n(e,t,i){return e.map(function(e){return e.map(function(e){return e.map(function(e){return[e[0]+t,e[1]+i]})})})}}),s("gIIqd",function(t,i){e(t.exports,"getBinaryMask",function(){return s});var n=o("eWjiX"),r=o("eIcQa");function s(e,t,i){var o=new Uint8Array(new ArrayBuffer(t*i)),s=n.BB.canvas(t,i),a=n.BB.ctx(s);(0,r.drawSelectionMask)(e,a);var l=a.getImageData(0,0,t,i);n.BB.freeCanvas(s);for(var h=t*i,c=0,u=0;c<h;c++,u+=4)o[c]=l.data[u]>>>7;return o}}),s("bBcC4",function(t,i){e(t.exports,"translateBlending",function(){return r});var n=o("1mH1z");function r(e){if(!e)return(0,n.LANG)("layers-blend-normal");var t={"source-over":"layers-blend-normal",darken:"layers-blend-darken",multiply:"layers-blend-multiply","color-burn":"layers-blend-color-burn",lighten:"layers-blend-lighten",screen:"layers-blend-screen","color-dodge":"layers-blend-color-dodge",overlay:"layers-blend-overlay","soft-light":"layers-blend-soft-light","hard-light":"layers-blend-hard-light",difference:"layers-blend-difference",exclusion:"layers-blend-exclusion",hue:"layers-blend-hue",saturation:"layers-blend-saturation",color:"layers-blend-color",luminosity:"layers-blend-luminosity"};if(!(e in t))throw Error("unknown blend mode");return(0,n.LANG)(t[e])}}),s("50Lcc",function(i,n){e(i.exports,"renameLayerDialog",function(){return h});var r=o("eWjiX"),s=o("1mH1z"),a=o("2MaaK"),l=o("9N3Nv");function h(e,i,n){var o=r.BB.el(),h=r.BB.el({content:(0,s.LANG)("layers-rename-name")+":",css:{marginRight:"5px"}}),c=r.BB.el({css:{display:"flex"}}),u=r.BB.el({tagName:"input"});u.value=i,u.setAttribute("data-ignore-focus","true"),u.style.flexGrow="1";var p=r.BB.el({tagName:"button",content:'<img src="'+t(l)+'" height="20"/>',title:(0,s.LANG)("layers-rename-clear"),css:{marginLeft:"10px"},onClick:function(){u.value="",u.focus()}}),d=[(0,s.LANG)("layers-rename-sketch"),(0,s.LANG)("layers-rename-colors"),(0,s.LANG)("layers-rename-shading"),(0,s.LANG)("layers-rename-lines"),(0,s.LANG)("layers-rename-effects"),(0,s.LANG)("background"),(0,s.LANG)("layers-rename-foreground")],g=[],f=r.BB.el({css:{display:"flex",flexWrap:"wrap",marginTop:"5px",marginLeft:"-5px"}});d.forEach(function(e){var t=r.BB.el({parent:f,tagName:"button",content:e,onClick:function(){u.value=""+t.textContent},css:{margin:"5px 0 0 5px"}});g.push(t)}),o.append(h),h.append(c,f),c.append(u,p),setTimeout(function(){u.focus(),u.select()},10),(0,a.showModal)({target:e,message:`<b>${(0,s.LANG)("layers-rename-title")}</b>`,div:o,buttons:[(0,s.LANG)("layers-rename"),"Cancel"],primaries:[(0,s.LANG)("layers-rename")],callback:function(e){r.BB.destroyEl(p),g.forEach(function(e){r.BB.destroyEl(e)}),g.splice(0,g.length),e===(0,s.LANG)("layers-rename")?n(u.value):n(void 0)},clickOnEnter:(0,s.LANG)("layers-rename")})}}),s("dsnzg",function(t,i){e(t.exports,"mergeLayerDialog",function(){return h});var n=o("eWjiX"),r=o("1mH1z"),s=o("iFIyy"),a=o("bBcC4"),l=o("2MaaK");function h(e,t){var i=n.BB.el();i.innerHTML=(0,r.LANG)("layers-merge-description");var o=new(0,s.Options)({optionArr:[{id:t.mixModeStr,label:(0,a.translateBlending)(t.mixModeStr)},{id:"source-in",label:"source-in"},{id:"source-out",label:"source-out"},{id:"source-atop",label:"source-atop"},{id:"destination-in",label:"destination-in"},{id:"destination-out",label:"destination-out"},{id:"destination-atop",label:"destination-atop"},{id:"xor",label:"xor"}],initId:t.mixModeStr,onChange:function(){d()},isSmall:!0,css:{marginTop:"5px"}});i.append(o.getElement());var h=n.BB.fitInto(t.topCanvas.width,t.topCanvas.height,200,200,1),c=n.BB.canvas(h.width,h.height);c.title=(0,r.LANG)("preview"),c.className="kl-merge-preview";var u=n.BB.el({content:"<br/>",css:{clear:"both"}});i.append(u,c);var p=n.BB.copyCanvas(c);n.BB.ctx(p).drawImage(t.topCanvas,0,0,p.width,p.height),n.BB.convertToAlphaChannelCanvas(p);var d=function(){var e=n.BB.ctx(c);e.save(),e.clearRect(0,0,c.width,c.height),c.width>t.topCanvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.bottomCanvas,0,0,c.width,c.height),"as-alpha"===o.getValue()?(e.globalCompositeOperation="destination-in",e.globalAlpha=t.topOpacity,e.drawImage(p,0,0,c.width,c.height)):(e.globalCompositeOperation=o.getValue(),e.globalAlpha=t.topOpacity,e.drawImage(t.topCanvas,0,0,c.width,c.height)),e.restore()};d();var g=new n.BB.KeyListener({onDown:function(e){"right"===e&&o.next(),"left"===e&&o.previous()}});(0,l.showModal)({target:e,message:`<b>${(0,r.LANG)("layers-merge-modal-title")}</b>`,div:i,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){g.destroy(),o.destroy(),"Ok"===e&&t.callback(o.getValue())}})}}),s("6vUjz",function(t,i){e(t.exports,"DropdownMenu",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("amum4"),a=o("72Jv0"),l=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.isExpanded=!1,this.onSetEnabled=function(){return 0};var r=(0,s.c)("button,w-full,h-full",[t.button]);r.onclick=function(){c(!i.isExpanded)},t.buttonTitle&&(r.title=t.buttonTitle),(0,a.makeUnfocusable)(r);var o=[],l={};t.items.forEach(function(e){var i=(0,s.c)("button",e[1]);(0,a.makeUnfocusable)(i),i.onclick=function(){c(!1),t.onItemClick(e[0])},o.push(i),l[e[0]]=i}),this.onSetEnabled=function(e,t){l[e].disabled=!t};var h=(0,s.c)(".kl-dropdown-menu,right-0,top-full,nowrap,hidden",o);this.rootElement=(0,s.c)(",pos-relative",[r,h]);var c=function(e){i.isExpanded=e,h.style.display=i.isExpanded?"":"none",i.isExpanded?(document.addEventListener("pointerdown",u,{passive:!1}),window.addEventListener("blur",p)):(document.removeEventListener("pointerdown",u),window.removeEventListener("blur",p))},u=function(e){var t=e.target;r.contains(t)||h.contains(t)||c(!1)},p=function(){return c(!1)}}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootElement}},{key:"setEnabled",value:function(e,t){this.onSetEnabled(e,t)}}]),e}()}),s("647zh",function(e,t){e.exports=i("1mb1v")}),s("lVqup",function(e,t){e.exports=i("11KJK")}),s("8o1rH",function(e,t){e.exports=i("floUo")}),s("2xdEb",function(e,t){e.exports=i("hhQeq")}),s("9Bdo6",function(e,t){e.exports=i("dz3mY")}),s("b4DnO",function(e,t){e.exports=i("iPQe1")}),s("5UrL9",function(t,i){e(t.exports,"KlCanvasPreview",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.layers=t.layers;var r=t.width/t.layers[0].image.width,o=r>1?t.layers[0].image.width:t.width,l=r>1?t.layers[0].image.height:t.height;this.canvas=s.BB.canvas(o,l),this.ctx=s.BB.ctx(this.canvas),(0,a.css)(this.canvas,{width:"100%",height:"100%",imageRendering:r>1?"pixelated":void 0,background:"var(--kl-checkerboard-background)",backgroundSize:"16px"}),setTimeout(function(){return i.render()},0)}return(0,r._)(e,[{key:"getElement",value:function(){return this.canvas}},{key:"render",value:function(){if(this.ctx){this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var e=0;e<this.layers.length;e++){var t=this.layers[e];t.isVisible&&0!==t.opacity&&(this.ctx.globalAlpha=this.layers[e].opacity,this.ctx.globalCompositeOperation=this.layers[e].mixModeStr,this.canvas.width>this.layers[e].image.width&&(this.ctx.imageSmoothingEnabled=!1),this.ctx.drawImage(this.layers[e].image,0,0,this.canvas.width,this.canvas.height))}this.ctx.restore()}}},{key:"destroy",value:function(){}}]),e}()}),s("cNhNm",function(i,n){e(i.exports,"FreeTransform",function(){return m});var r=o("cx0mh"),s=o("7h4XF"),a=o("cL71g"),l=o("eWjiX"),h=o("5C8t3"),c=o("lt7cS"),u=o("7jh4K"),p=o("1GsyD");o("ciAU9");var d=o("cdZRx"),g=o("kDVZW"),f=o("eg83P");function v(e){for(var t=["e","ne","n","nw","w","sw","s","se"];e<0;)e+=360;var i=Math.round(e/45)%t.length;return t[i]+"-resize"}var m=function(){"use strict";function e(i){var n,o=this;(0,r._)(this,e);var s=function(){y.x=0,y.y=0};this.rectInViewport={x:0,y:0,width:0,height:0,corners:[{x:0,y:0}]},this.minSnapDist=7,this.corners=[],this.edges=[],this.viewportTransform=(0,a._)({},i.viewportTransform),this.value={x:i.x,y:i.y,width:i.width,height:i.height,angleDeg:i.angleDeg},this.isConstrained=i.isConstrained,this.snapX=i.snapX,this.snapY=i.snapY,this.callback=i.callback,this.snappingEnabled=!0,this.ratio=this.value.width/this.value.height;var m=i.onWheel?function(e){if(i.onWheel&&i.wheelParent){var t=i.wheelParent.getBoundingClientRect();e.relX=e.pageX-t.left,e.relY=e.pageY-t.top,i.onWheel(e)}}:void 0;this.rootEl=l.BB.el({className:"kl-free-transform",css:{userSelect:"none"}}),this.transEl=l.BB.el({parent:this.rootEl,css:{position:"absolute"}}),this.boundsEl=l.BB.el({css:{position:"absolute",cursor:"move",boxShadow:"rgba(255, 255, 255, 0.5) 0 0 0 1px inset, rgba(0, 0, 0, 0.5) 0 0 0 1px"}});var y={x:0,y:0};this.keyListener=new l.BB.KeyListener({});var x={x:0,y:0};this.boundsPointerListener=new l.BB.PointerListener({target:this.boundsEl,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointerdown"===e.type&&(x={x:o.value.x,y:o.value.y}),"pointermove"===e.type&&"left"===e.button){var t=(0,p.createMatrixFromTransform)(o.viewportTransform),i=(0,d.applyToPoint)((0,g.inverse)(t),{x:e.downPageX,y:e.downPageY}),n=(0,d.applyToPoint)((0,g.inverse)(t),{x:e.pageX,y:e.pageY}),r={x:n.x-i.x,y:n.y-i.y};o.value.x=x.x+r.x,o.value.y=x.y+r.y;var s={distX:-1,distY:-1};if(o.snappingEnabled){for(h=0;h<o.snapX.length;h++)(a=Math.abs(o.value.x-o.snapX[h]))<o.minSnapDist/o.viewportTransform.scale&&(void 0===s.x||a<s.distX)&&(s.x=o.snapX[h],s.distX=a);for(h=0;h<o.snapY.length;h++)(a=Math.abs(o.value.y-o.snapY[h]))<o.minSnapDist/o.viewportTransform.scale&&(void 0===s.y||a<s.distY)&&(s.y=o.snapY[h],s.distY=a);for(h=0;h<4;h++){var a,h,u=(0,c.toImageSpace)(o.corners[h].x,o.corners[h].y,o.value),f=void 0;for(f=0;f<o.snapX.length;f++)(a=Math.abs(u.x-o.snapX[f]))<o.minSnapDist/o.viewportTransform.scale&&(void 0===s.x||a<s.distX)&&(s.x=o.snapX[f]-(u.x-o.value.x),s.distX=a);for(f=0;f<o.snapY.length;f++)(a=Math.abs(u.y-o.snapY[f]))<o.minSnapDist/o.viewportTransform.scale&&(void 0===s.y||a<s.distY)&&(s.y=o.snapY[f]-(u.y-o.value.y),s.distY=a)}}if("shift"===o.keyListener.getComboStr()){var v=l.BB.projectPointOnLine({x:0,y:x.y},{x:10,y:x.y},{x:o.value.x,y:o.value.y}),m=l.BB.dist(v.x,v.y,o.value.x,o.value.y);s={x:v.x,y:v.y,distX:m,distY:m},v=l.BB.projectPointOnLine({x:x.x,y:0},{x:x.x,y:10},{x:o.value.x,y:o.value.y}),(m=l.BB.dist(v.x,v.y,o.value.x,o.value.y))<s.distX&&(s={x:v.x,y:v.y,distX:m,distY:m}),v=l.BB.projectPointOnLine({x:x.x,y:x.y},{x:x.x+1,y:x.y+1},{x:o.value.x,y:o.value.y}),(m=l.BB.dist(v.x,v.y,o.value.x,o.value.y))<s.distX&&(s={x:v.x,y:v.y,distX:m,distY:m}),v=l.BB.projectPointOnLine({x:x.x,y:x.y},{x:x.x+1,y:x.y-1},{x:o.value.x,y:o.value.y}),(m=l.BB.dist(v.x,v.y,o.value.x,o.value.y))<s.distX&&(s={x:v.x,y:v.y,distX:m,distY:m})}void 0!=s.x&&(o.value.x=s.x),void 0!=s.y&&(o.value.y=s.y),Math.abs(o.value.angleDeg)%90==0&&((0,c.snapToPixel)(o.value),o.updateCornerPositions()),o.updateDOM()}},useDirtyWheel:!0,onWheel:m});for(var b=0;b<4;b++)!function(e){var t=o.corners[e]={i:e,el:l.BB.el({css:{width:"16px",height:"16px",background:"#fff",borderRadius:"16px",position:"absolute",border:"2px solid #000"}}),x:0,y:0,virtualPos:{x:0,y:0}};t.updateDOM=function(){var i=[[-1,-1],[1,-1],[1,1],[-1,1]].map(function(e){return e[0]*=o.value.width>0?1:-1,e[1]*=o.value.height>0?1:-1,e}),n=10*!!(20>Math.abs(o.rectInViewport.width)||20>Math.abs(o.rectInViewport.height));(0,u.css)(t.el,{left:o.rectInViewport.corners[t.i].x-8+i[e][0]*n+"px",top:o.rectInViewport.corners[t.i].y-8+i[e][1]*n+"px"});var r=o.value.width<0?-1:1,s=o.value.height<0?-1:1,a=[{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}],l={x:a[e].x*r,y:-(a[e].y*s*1)},h=(0,f.pointsToAngleDeg)({x:0,y:0},l)-o.value.angleDeg-o.viewportTransform.angleDeg;(0,u.css)(t.el,{cursor:v(h)})},t.pointerListener=new l.BB.PointerListener({target:o.corners[e].el,fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointerdown"===t.type&&"left"===t.button)o.corners[e].virtualPos=(0,c.toImageSpace)(o.corners[e].x,o.corners[e].y,o.value);else if("pointermove"===t.type&&"left"===t.button){var i=(0,p.createMatrixFromTransform)(o.viewportTransform),n=(0,d.applyToPoint)((0,g.inverse)(i),{x:0,y:0}),r=(0,d.applyToPoint)((0,g.inverse)(i),{x:t.dX,y:t.dY}),s={x:r.x-n.x,y:r.y-n.y};o.corners[e].virtualPos.x+=s.x,o.corners[e].virtualPos.y+=s.y;var a={x:o.corners[e].virtualPos.x,y:o.corners[e].virtualPos.y};a=o.constrainCorner(e,a.x,a.y),o.isConstrained||(a=o.snapCorner(a.x,a.y)),Math.abs(o.value.angleDeg)%90==0&&(a.x=Math.round(a.x),a.y=Math.round(a.y));var l=(0,c.toTransformSpace)(a.x,a.y,o.value),h=l.x-o.corners[e].x,u=l.y-o.corners[e].y;o.corners[e].x=l.x,o.corners[e].y=l.y;var f=[];0===e?f=[3,1,2]:1===e?f=[2,0,3]:2===e?f=[1,3,0]:3===e&&(f=[0,2,1]),o.corners[f[0]].x=o.corners[e].x,o.corners[f[1]].y=o.corners[e].y,o.keyListener.isPressed("shift")&&(o.corners[f[2]].x-=h,o.corners[f[2]].y-=u,o.corners[f[1]].x=o.corners[f[2]].x,o.corners[f[0]].y=o.corners[f[2]].y),o.updateTransformViaCorners()}},useDirtyWheel:!0,onWheel:m})}(b);this.updateCornerPositions(),this.updateScaled();for(var w=0;w<4;w++)!function(e){o.edges[e]={el:l.BB.el({css:{width:"10px",height:"10px",position:"absolute"}})};var t=o.edges[e];t.updateDOM=function(){0===e?(0,u.css)(t.el,{left:Math.min(o.rectInViewport.corners[0].x,o.rectInViewport.corners[1].x)+"px",top:Math.min(o.rectInViewport.corners[0].y,o.rectInViewport.corners[3].y)-10+"px",width:Math.abs(o.rectInViewport.width)+"px",height:"10px"}):1===e?(0,u.css)(t.el,{left:Math.max(o.rectInViewport.corners[0].x,o.rectInViewport.corners[1].x)+"px",top:Math.min(o.rectInViewport.corners[1].y,o.rectInViewport.corners[2].y)+"px",width:"10px",height:Math.abs(o.rectInViewport.height)+"px"}):2===e?(0,u.css)(t.el,{left:Math.min(o.rectInViewport.corners[3].x,o.rectInViewport.corners[2].x)+"px",top:Math.max(o.rectInViewport.corners[0].y,o.rectInViewport.corners[3].y)+"px",width:Math.abs(o.rectInViewport.width)+"px",height:"10px"}):3===e&&(0,u.css)(t.el,{left:Math.min(o.rectInViewport.corners[0].x,o.rectInViewport.corners[1].x)-10+"px",top:Math.min(o.rectInViewport.corners[0].y,o.rectInViewport.corners[3].y)+"px",width:"10px",height:Math.abs(o.rectInViewport.height)+"px"});var i=o.value.width<0,n=o.value.height<0,r=[n?-90:90,180*!!i,n?90:-90,180*!i][e]-o.value.angleDeg-o.viewportTransform.angleDeg;(0,u.css)(t.el,{cursor:v(r)})};var i=[0,2].includes(e);t.pointerListener=new l.BB.PointerListener({target:o.edges[e].el,fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointerdown"===t.type&&"left"===t.button&&(n=i?o.corners[0].y>=o.corners[3].y:o.corners[0].x>=o.corners[1].x,s()),"pointermove"===t.type&&"left"===t.button){var r=(0,p.createMatrixFromTransform)(o.viewportTransform),a=(0,d.applyToPoint)((0,g.inverse)(r),{x:0,y:0}),h=(0,d.applyToPoint)((0,g.inverse)(r),{x:t.dX,y:t.dY}),u=(0,c.toTransformSpace)(a.x,a.y,o.value),f=(0,c.toTransformSpace)(h.x,h.y,o.value),v={x:f.x-u.x,y:f.y-u.y},m={dX:v.x,dY:v.y};Math.abs(o.value.angleDeg)%90==0&&(m=l.BB.intDxy(y,v.x,v.y));var x=[];0===e?x=[2,3,0,1]:1===e?x=[0,3,1,2]:2===e?x=[0,1,2,3]:3===e&&(x=[1,2,0,3]);var b=i?"y":"x",w=i?m.dY:m.dX;n?(o.corners[x[0]][b]+=w,o.corners[x[1]][b]+=w):(o.corners[x[2]][b]+=w,o.corners[x[3]][b]+=w),o.keyListener.isPressed("shift")&&(n?(o.corners[x[2]][b]-=w,o.corners[x[3]][b]-=w):(o.corners[x[0]][b]-=w,o.corners[x[1]][b]-=w)),i?o.restoreRatio(!1,!0):o.restoreRatio(!0,!1),o.updateTransformViaCorners()}},useDirtyWheel:!0,onWheel:m})}(w);this.angleGrip={el:l.BB.el({css:{cursor:"url("+t(h)+") 10 10, move",width:"16px",height:"16px",background:"#0ff",borderRadius:"16px",position:"absolute",boxShadow:"inset 0 0 0 2px #000"}}),x:0,y:0,snap:!1,updateDOM:function(){(0,u.css)(o.angleGrip.el,{left:o.angleGrip.x-8+"px",top:o.angleGrip.y-8+"px"})}},l.BB.el({parent:this.angleGrip.el,css:{width:"2px",height:"13px",left:"7px",top:"16px",background:"#0ff",position:"absolute"}}),this.anglePointerListener=new l.BB.PointerListener({target:this.angleGrip.el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,p.createMatrixFromTransform)(o.viewportTransform),i=o.rootEl.getBoundingClientRect(),n={x:e.clientX-i.left,y:e.clientY-i.top},r=(0,d.applyToPoint)((0,g.inverse)(t),n),s=l.BB.pointsToAngleDeg({x:o.value.x,y:o.value.y},r)+90;o.value.angleDeg=s;var a=45*Math.round(s/360*8);"shift"===o.keyListener.getComboStr()?o.value.angleDeg=a:o.snappingEnabled&&8>Math.abs(a-s)&&(o.value.angleDeg=a),o.updateDOM()}"pointerup"===e.type&&Math.abs(o.value.angleDeg)%90==0&&((0,c.snapToPixel)(o.value),o.updateCornerPositions(),o.updateDOM())},useDirtyWheel:!0,onWheel:m}),(0,c.snapToPixel)(this.value),this.updateDOM(!0),l.BB.append(this.transEl,[this.boundsEl,this.edges[0].el,this.edges[1].el,this.edges[2].el,this.edges[3].el,this.corners[0].el,this.corners[1].el,this.corners[2].el,this.corners[3].el,this.angleGrip.el])}return(0,s._)(e,[{key:"updateScaled",value:function(){var e=this,t=(0,p.createMatrixFromTransform)(this.viewportTransform),i=(0,d.applyToPoint)(t,{x:this.value.x,y:this.value.y});this.rectInViewport.x=i.x,this.rectInViewport.y=i.y,this.rectInViewport.width=this.value.width*this.viewportTransform.scale,this.rectInViewport.height=this.value.height*this.viewportTransform.scale,this.rectInViewport.corners=this.corners.map(function(t){return{x:t.x*e.viewportTransform.scale,y:t.y*e.viewportTransform.scale}})}},{key:"snapCorner",value:function(e,t){if(!this.snappingEnabled)return{x:e,y:t};for(var i,n,r,o={x:void 0,y:void 0,dist:{x:void 0,y:void 0}},s=0;s<this.snapX.length;s++)(i=Math.abs(e-this.snapX[s]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===o.x||i<o.dist.x)&&(o.x=this.snapX[s],o.dist.x=i);for(var a=0;a<this.snapY.length;a++)(i=Math.abs(t-this.snapY[a]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===o.y||i<o.dist.y)&&(o.y=this.snapY[a],o.dist.y=i);return void 0===o.x&&void 0===o.y?{x:e,y:t}:{x:null!=(n=o.x)?n:e,y:null!=(r=o.y)?r:t}}},{key:"constrainCorner",value:function(e,t,i){if(!this.isConstrained)return{x:t,y:i};var n=this.value.width*this.value.height<0?-1:1;return l.BB.projectPointOnLine({x:this.value.x,y:this.value.y},(0,c.toImageSpace)(this.ratio,n*([0,2].includes(e)?1:-1),this.value),{x:t,y:i})}},{key:"updateCornerPositions",value:function(){this.corners[0].x=-this.value.width/2,this.corners[0].y=-this.value.height/2,this.corners[1].x=this.value.width/2,this.corners[1].y=-this.value.height/2,this.corners[2].x=this.value.width/2,this.corners[2].y=this.value.height/2,this.corners[3].x=-this.value.width/2,this.corners[3].y=this.value.height/2}},{key:"restoreRatio",value:function(e,t){if(this.isConstrained){var i=Math.abs(this.value.angleDeg)%90==0,n=Math.abs(this.value.angleDeg-90)%180==0;if(t&&!e){var r=Math.abs(this.corners[3].y-this.corners[0].y),o=this.ratio*r;i&&(o=(n?this.value.y%1:this.value.x%1)==0?l.BB.roundEven(o):l.BB.roundUneven(o)),this.corners[1].x-this.corners[0].x<0&&(o*=-1),this.corners[0].x=-o/2,this.corners[3].x=-o/2,this.corners[1].x=o/2,this.corners[2].x=o/2}if(!t&&e){var s=Math.abs(this.corners[0].x-this.corners[1].x)/this.ratio;i&&(s=(n?this.value.x%1:this.value.y%1)==0?l.BB.roundEven(s):l.BB.roundUneven(s)),this.corners[3].y-this.corners[0].y<0&&(s*=-1),this.corners[0].y=-s/2,this.corners[1].y=-s/2,this.corners[2].y=s/2,this.corners[3].y=s/2}}}},{key:"updateTransformViaCorners",value:function(){var e=l.BB.rotateAround({x:0,y:0},{x:(this.corners[0].x+this.corners[1].x)/2,y:(this.corners[0].y+this.corners[3].y)/2},this.value.angleDeg);this.value.x=e.x+this.value.x,this.value.y=e.y+this.value.y,this.value.width=this.corners[1].x-this.corners[0].x,this.value.height=this.corners[3].y-this.corners[0].y,this.updateCornerPositions(),this.updateDOM()}},{key:"updateDOM",value:function(e){this.updateScaled(),(0,u.css)(this.transEl,{left:this.rectInViewport.x+"px",top:this.rectInViewport.y+"px",transformOrigin:"0 0",transform:"rotate("+(this.value.angleDeg+this.viewportTransform.angleDeg)+"deg)"}),(0,u.css)(this.boundsEl,{width:Math.abs(this.rectInViewport.width)+"px",height:Math.abs(this.rectInViewport.height)+"px",left:Math.min(this.rectInViewport.corners[0].x,this.rectInViewport.corners[1].x)+"px",top:Math.min(this.rectInViewport.corners[0].y,this.rectInViewport.corners[3].y)+"px"}),this.corners[0].updateDOM(),this.corners[1].updateDOM(),this.corners[2].updateDOM(),this.corners[3].updateDOM(),this.edges[0].updateDOM(),this.edges[1].updateDOM(),this.edges[2].updateDOM(),this.edges[3].updateDOM(),this.angleGrip.x=0,this.angleGrip.y=-Math.abs(this.value.height*this.viewportTransform.scale)/2-20,this.angleGrip.updateDOM(),!e&&this.callback&&this.callback((0,a._)({},this.value))}},{key:"getValue",value:function(){return(0,a._)({},this.value)}},{key:"setIsConstrained",value:function(e){this.isConstrained=e,e&&0!==this.value.width&&0!==this.value.height&&(this.ratio=Math.abs(this.value.width/this.value.height))}},{key:"setSnapping",value:function(e){this.snappingEnabled=e}},{key:"setSnappingPoints",value:function(e,t){this.snapX=e,this.snapY=t}},{key:"setPos",value:function(e){this.value.x=e.x,this.value.y=e.y,this.updateDOM(!0)}},{key:"move",value:function(e,t){this.value.x+=e,this.value.y+=t,this.updateDOM(!1)}},{key:"setSize",value:function(e,t){this.value.width=e,this.value.height=t,Math.abs(this.value.angleDeg)%90==0&&(0,c.snapToPixel)(this.value),this.updateCornerPositions(),this.updateDOM(!1)}},{key:"initialise",value:function(e){this.value.x=e.x,this.value.y=e.y,this.value.width=e.width,this.value.height=e.height,this.value.angleDeg=e.angleDeg,this.ratio=Math.abs(e.width/e.height),this.updateCornerPositions(),this.updateDOM(!0)}},{key:"setAngleDeg",value:function(e){this.value.angleDeg=e,Math.abs(this.value.angleDeg)%90==0&&((0,c.snapToPixel)(this.value),this.updateCornerPositions()),this.updateDOM(!0)}},{key:"setViewportTransform",value:function(e){this.viewportTransform=(0,a._)({},e),this.updateScaled(),this.updateDOM()}},{key:"getElement",value:function(){return this.rootEl}},{key:"getRatio",value:function(){return this.ratio}},{key:"destroy",value:function(){this.keyListener.destroy(),this.boundsPointerListener.destroy(),this.corners.forEach(function(e){return e.pointerListener.destroy()}),this.edges.forEach(function(e){return e.pointerListener.destroy()}),this.anglePointerListener.destroy()}}]),e}()}),s("5C8t3",function(e,t){e.exports=i("045N6")}),s("lt7cS",function(t,i){e(t.exports,"snapToPixel",function(){return r}),e(t.exports,"toTransformSpace",function(){return s}),e(t.exports,"toImageSpace",function(){return a});var n=o("eWjiX");function r(e){if(Math.abs(e.angleDeg)%90==0){e.width=Math.round(e.width),e.height=Math.round(e.height);var t=Math.abs(e.angleDeg-90)%180==0;e.x=(t?e.height:e.width)%2==0?Math.round(e.x):Math.round(e.x-.5)+.5,e.y=(t?e.width:e.height)%2==0?Math.round(e.y):Math.round(e.y-.5)+.5}}function s(e,t,i){var r=e-i.x,o=t-i.y,s=n.BB.rotateAround({x:0,y:0},{x:r,y:o},-i.angleDeg);return{x:r=s.x,y:o=s.y}}function a(e,t,i){var r=n.BB.rotateAround({x:0,y:0},{x:e,y:t},i.angleDeg);return{x:r.x+i.x,y:r.y+i.y}}}),s("kEeSq",function(t,i){e(t.exports,"FreeTransformCanvas",function(){return c});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("cNhNm"),l=o("jpkXO"),h=o("7jh4K"),c=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.algorithm="smooth",this.imageWidth=t.imageWidth,this.imageHeight=t.imageHeight,this.rootEl=s.BB.el({className:"kl-preview-wrapper",css:{width:t.elementWidth+"px",height:t.elementHeight+"px"}}),this.rootEl.oncontextmenu=function(){return!1},this.layers=t.layers,this.transformIndex=t.transformIndex,this.previewLayerArr=this.layers.map(function(e){var t;return{image:e.image,isVisible:e.isVisible,mixModeStr:null!=(t=e.mixModeStr)?t:"source-over",opacity:e.opacity,hasClipping:!1}}),this.previewCanvas=s.BB.canvas(this.imageWidth,this.imageHeight),this.previewLayerArr[this.previewLayerArr.length-1].image=this.previewCanvas,this.preview=new(0,l.Preview)({width:t.elementWidth,height:t.elementHeight,project:{width:t.imageWidth,height:t.imageHeight,layers:this.previewLayerArr},hasEditMode:!0,onModeChange:function(e){(0,h.css)(i.freeTransform.getElement(),{pointerEvents:"edit"===e?"":"none",opacity:"edit"===e?"":"0.5"})},onTransformChange:function(e){i.freeTransform.setViewportTransform(e)},padding:30}),(0,h.css)(this.preview.getElement(),{overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"}),this.rootEl.append(this.preview.getElement()),this.initTransform={x:this.imageWidth/2,y:this.imageHeight/2,width:this.layers[this.transformIndex].image.width,height:this.layers[this.transformIndex].image.height},this.freeTransform=new(0,a.FreeTransform)({x:this.initTransform.x,y:this.initTransform.y,width:this.initTransform.width,height:this.initTransform.height,angleDeg:0,isConstrained:!0,snapX:[0,this.imageWidth],snapY:[0,this.imageHeight],viewportTransform:this.preview.getTransform(),callback:function(){i.updatePreview()}}),this.preview.getElement().append(this.freeTransform.getElement()),(0,h.css)(this.freeTransform.getElement(),{position:"absolute",left:"0",top:"0"}),setTimeout(function(){return i.updatePreview()},0)}return(0,r._)(e,[{key:"updatePreview",value:function(){var e=this.freeTransform.getValue(),t=s.BB.ctx(this.previewCanvas);t.save(),t.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height),s.BB.drawTransformedImageWithBounds(t,this.layers[this.transformIndex].image,e,void 0,"pixelated"===this.algorithm||s.BB.testShouldPixelate(e,e.width/this.initTransform.width,e.height/this.initTransform.height)),t.restore(),this.preview.render()}},{key:"move",value:function(e,t){this.freeTransform.move(e,t)}},{key:"reset",value:function(){var e=this.layers[this.transformIndex].image.width,t=this.layers[this.transformIndex].image.height;this.freeTransform.setSize(e,t),this.freeTransform.setPos({x:e/2,y:t/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}},{key:"setTransformFit",value:function(){var e=s.BB.fitInto(this.layers[this.transformIndex].image.width,this.layers[this.transformIndex].image.height,this.imageWidth,this.imageHeight,1);this.freeTransform.setSize(e.width,e.height),this.freeTransform.setPos({x:e.width/2,y:e.height/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}},{key:"setTransformCenter",value:function(){this.freeTransform.setPos({x:this.imageWidth/2,y:this.imageHeight/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}},{key:"setAlgorithm",value:function(e){this.algorithm=e,this.updatePreview()}},{key:"getTransformation",value:function(){return this.freeTransform.getValue()}},{key:"getIsPixelated",value:function(){var e=this.freeTransform.getValue();return"pixelated"===this.algorithm||s.BB.testShouldPixelate(e,e.width/this.initTransform.width,e.height/this.initTransform.height)}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.freeTransform.destroy(),this.preview.destroy(),s.BB.freeCanvas(this.previewCanvas)}}]),e}()}),s("32CBv",function(t,i){e(t.exports,"Cropper",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.scale=t.scale,this.callback=t.callback;var r=t.maxW,o=t.maxW;this.rootEl=s.BB.el();var l=["nw","n","ne","e","se","s","sw","w"];this.keyListener=new s.BB.KeyListener({}),(0,a.css)(this.rootEl,{position:"absolute",left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.outline={el:s.BB.el({css:{position:"absolute",border:"1px dashed #fff",cursor:"move"}}),update:function(){(0,a.css)(i.outline.el,{left:i.grips[0].x*i.scale-1+"px",top:i.grips[0].y*i.scale-1+"px",width:(i.grips[2].x-i.grips[0].x)*i.scale+"px",height:(i.grips[2].y-i.grips[0].y)*i.scale+"px"})}},this.pointerRemainder={x:0,y:0},this.outlinePointerListener=new s.BB.PointerListener({target:this.outline.el,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;i.grips[0].x+=n,i.grips[0].y+=r,i.grips[1].x+=n,i.grips[1].y+=r,i.grips[2].x+=n,i.grips[2].y+=r,i.grips[3].x+=n,i.grips[3].y+=r,i.update()}"pointerup"===e.type&&i.commit()}}),this.thirdsHorizontal={el:s.BB.el({css:{position:"absolute",borderTop:"1px solid #0ff",borderBottom:"1px solid #0ff"}}),update:function(){(0,a.css)(i.thirdsHorizontal.el,{left:i.grips[0].x*i.scale+"px",top:(i.grips[0].y+(i.grips[2].y-i.grips[0].y)/3)*i.scale+"px",width:(i.grips[2].x-i.grips[0].x)*i.scale+"px",height:(i.grips[2].y-i.grips[0].y)/3*i.scale+"px"})}},this.thirdsVertical={el:s.BB.el({css:{position:"absolute",borderLeft:"1px solid #0ff",borderRight:"1px solid #0ff"}}),update:function(){(0,a.css)(i.thirdsVertical.el,{left:(i.grips[0].x+(i.grips[2].x-i.grips[0].x)/3)*i.scale+"px",top:i.grips[0].y*i.scale+"px",width:(i.grips[2].x-i.grips[0].x)/3*i.scale+"px",height:(i.grips[2].y-i.grips[0].y)*i.scale+"px"})}},t.init?this.grips=[{x:t.init.x1,y:t.init.y1},{x:t.init.x2,y:t.init.y1},{x:t.init.x2,y:t.init.y2},{x:t.init.x1,y:t.init.y2}]:this.grips=[{x:0,y:0},{x:this.width,y:0},{x:this.width,y:this.height},{x:0,y:this.height}];var h=function(e){i.grips[0].y+=e,i.grips[0].y=s.BB.clamp(i.grips[0].y,i.grips[3].y-o,i.grips[3].y-1),i.grips[1].y=i.grips[0].y},c=function(e){i.grips[1].x+=e,i.grips[1].x=s.BB.clamp(i.grips[1].x,i.grips[0].x+1,i.grips[0].x+r),i.grips[2].x=i.grips[1].x},u=function(e){i.grips[2].y+=e,i.grips[2].y=s.BB.clamp(i.grips[2].y,i.grips[1].y+1,i.grips[1].y+o),i.grips[3].y=i.grips[2].y},p=function(e){i.grips[0].x+=e,i.grips[0].x=s.BB.clamp(i.grips[0].x,i.grips[1].x-r,i.grips[1].x-1),i.grips[3].x=i.grips[0].x};this.edges=[];for(var d=0;d<4;d++)!function(e){var t=s.BB.el({css:{width:"40px",height:"40px",position:"absolute"}}),n=function(){0===e?(0,a.css)(t,{left:i.grips[0].x*i.scale+10+"px",top:i.grips[0].y*i.scale-80+10+"px",width:(i.grips[1].x-i.grips[0].x)*i.scale-20+"px",height:"80px"}):1===e?(0,a.css)(t,{left:i.grips[1].x*i.scale-10+"px",top:i.grips[1].y*i.scale+10+"px",width:"80px",height:(i.grips[2].y-i.grips[1].y)*i.scale-20+"px"}):2===e?(0,a.css)(t,{left:i.grips[3].x*i.scale+10+"px",top:i.grips[3].y*i.scale-10+"px",width:(i.grips[2].x-i.grips[3].x)*i.scale-20+"px",height:"80px"}):3===e&&(0,a.css)(t,{left:i.grips[0].x*i.scale-80+10+"px",top:i.grips[0].y*i.scale+10+"px",width:"80px",height:(i.grips[3].y-i.grips[0].y)*i.scale-20+"px"});var n=2*e+1;t.style.cursor=l[n]+"-resize"};i.edges[e]={el:t,update:n}}(d);this.darken=[];for(var g=0;g<4;g++)!function(e){var t=s.BB.el({css:{position:"absolute",background:"#000",opacity:"0.5"}}),n=function(){0===e?(0,a.css)(t,{left:i.grips[0].x*i.scale+"px",top:i.grips[0].y*i.scale-8e3+"px",width:(i.grips[1].x-i.grips[0].x)*i.scale+"px",height:"8000px"}):1===e?(0,a.css)(t,{left:i.grips[1].x*i.scale+"px",top:i.grips[1].y*i.scale-8e3+"px",width:"8000px",height:"16000px"}):2===e?(0,a.css)(t,{left:i.grips[3].x*i.scale+"px",top:i.grips[3].y*i.scale+"px",width:(i.grips[2].x-i.grips[3].x)*i.scale+"px",height:"8000px"}):3===e&&(0,a.css)(t,{left:i.grips[0].x*i.scale-8e3+"px",top:i.grips[0].y*i.scale-8e3+"px",width:"8000px",height:"16000px"})};i.darken[e]={el:t,update:n}}(g);this.edge0PointerListener=new s.BB.PointerListener({target:this.edges[0].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale).dY;h(t),i.keyListener.isPressed("shift")&&u(-t),i.update()}"pointerup"===e.type&&i.commit()}}),this.edge1PointerListener=new s.BB.PointerListener({target:this.edges[1].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX;t.dY,c(n),i.keyListener.isPressed("shift")&&p(-n),i.update()}"pointerup"===e.type&&i.commit()}}),this.edge2PointerListener=new s.BB.PointerListener({target:this.edges[2].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=(t.dX,t.dY);u(n),i.keyListener.isPressed("shift")&&h(-n),i.update()}"pointerup"===e.type&&i.commit()}}),this.edge3PointerListener=new s.BB.PointerListener({target:this.edges[3].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX;t.dY,p(n),i.keyListener.isPressed("shift")&&c(-n),i.update()}"pointerup"===e.type&&i.commit()}}),this.cornerElArr=[];for(var f=0;f<4;f++)!function(e){var t=s.BB.el({css:{width:"80px",height:"80px",position:"absolute",cursor:["nwse-resize","nesw-resize"][e%2]}}),n=function(){0===e?(0,a.css)(t,{left:i.grips[0].x*i.scale-80+10+"px",top:i.grips[0].y*i.scale-80+10+"px"}):1===e?(0,a.css)(t,{left:i.grips[1].x*i.scale-10+"px",top:i.grips[1].y*i.scale-80+10+"px"}):2===e?(0,a.css)(t,{left:i.grips[1].x*i.scale-10+"px",top:i.grips[2].y*i.scale-10+"px"}):3===e&&(0,a.css)(t,{left:i.grips[0].x*i.scale-80+10+"px",top:i.grips[2].y*i.scale-10+"px"})};i.cornerElArr[e]={el:t,update:n}}(f);this.corner0PointerListener=new s.BB.PointerListener({target:this.cornerElArr[0].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;p(n),h(r),i.keyListener.isPressed("shift")&&(c(-n),u(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.corner1PointerListener=new s.BB.PointerListener({target:this.cornerElArr[1].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;c(n),h(r),i.keyListener.isPressed("shift")&&(p(-n),u(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.corner2PointerListener=new s.BB.PointerListener({target:this.cornerElArr[2].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;c(n),u(r),i.keyListener.isPressed("shift")&&(p(-n),h(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.corner3PointerListener=new s.BB.PointerListener({target:this.cornerElArr[3].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;p(n),u(r),i.keyListener.isPressed("shift")&&(c(-n),h(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.rootEl.append(this.darken[1].el,this.darken[0].el,this.darken[2].el,this.darken[3].el,this.thirdsHorizontal.el,this.thirdsVertical.el,this.outline.el,this.edges[1].el,this.edges[0].el,this.edges[2].el,this.edges[3].el,this.cornerElArr[0].el,this.cornerElArr[1].el,this.cornerElArr[2].el,this.cornerElArr[3].el),this.update()}return(0,r._)(e,[{key:"update",value:function(){this.edges[0].update(),this.edges[1].update(),this.edges[2].update(),this.edges[3].update(),this.cornerElArr[0].update(),this.cornerElArr[1].update(),this.cornerElArr[2].update(),this.cornerElArr[3].update(),this.darken[0].update(),this.darken[1].update(),this.darken[2].update(),this.darken[3].update(),this.outline.update(),this.thirdsHorizontal.update(),this.thirdsVertical.update()}},{key:"commit",value:function(){this.pointerRemainder.x=0,this.pointerRemainder.y=0,this.callback(this.getTransform())}},{key:"getTransform",value:function(){return this.grips[1].x-=this.grips[0].x,this.grips[1].y-=this.grips[0].y,this.grips[2].x-=this.grips[0].x,this.grips[2].y-=this.grips[0].y,this.grips[3].x-=this.grips[0].x,this.grips[3].y-=this.grips[0].y,this.x+=this.grips[0].x,this.y+=this.grips[0].y,this.grips[0].x=0,this.grips[0].y=0,{x:this.x,y:this.y,width:this.grips[1].x,height:this.grips[2].y}}},{key:"setTransform",value:function(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,(0,a.css)(this.rootEl,{left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.grips[0].x=0,this.grips[0].y=0,this.grips[1].x=this.width,this.grips[1].y=0,this.grips[2].x=this.width,this.grips[2].y=this.height,this.grips[3].x=0,this.grips[3].y=this.height,this.update(),this.commit()}},{key:"setScale",value:function(e){this.scale=e,(0,a.css)(this.rootEl,{left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.update()}},{key:"showThirds",value:function(e){this.thirdsHorizontal.el.style.display=e?"block":"none",this.thirdsVertical.el.style.display=e?"block":"none"}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.keyListener.destroy(),this.outlinePointerListener.destroy(),this.corner0PointerListener.destroy(),this.corner1PointerListener.destroy(),this.corner2PointerListener.destroy(),this.corner3PointerListener.destroy(),this.edge0PointerListener.destroy(),this.edge1PointerListener.destroy(),this.edge2PointerListener.destroy(),this.edge3PointerListener.destroy()}}]),e}()}),s("kqmpc",function(t,i){e(t.exports,"LayerPreview",function(){return c});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("1mH1z"),l=o("1C8RU"),h=o("7jh4K"),c=function(){"use strict";function e(t){var i,r=this;(0,n._)(this,e),this.animationCanvasCheckerPattern={},this.largeCanvasCheckerPattern={},this.rootEl=s.BB.el({className:"kl-layer-preview"}),this.klHistory=t.klHistory,this.isPreviewVisible=!0,this.height=40,this.canvasSize=this.height-10,this.largeCanvasSize=300,this.lastDrawnState=-2,this.lastDrawnSize={width:0,height:0},this.animationCanvas=s.BB.canvas(),this.animationCanvasCtx=s.BB.ctx(this.animationCanvas),this.animationLength=30,this.animationCount=0,this.largeCanvasIsVisible=!1,this.uiState=t.uiState,this.contentWrapperEl=s.BB.el({css:{display:"flex",alignItems:"center",height:this.height+"px"}});var o=s.BB.el({css:{display:"flex",justifyContent:"flex-end",alignItems:"center",width:"23px",flexShrink:"0"}});this.checkEl=s.BB.el({parent:o,tagName:"input",css:{pointerEvents:"none"},custom:{type:"checkbox",disabled:"true",name:"layer-visible"}});var c=s.BB.el({css:{minWidth:this.height+"px",height:this.height+"px",display:"flex",justifyContent:"center",alignItems:"center"}});this.canvas=s.BB.canvas(this.canvasSize,this.canvasSize),this.canvasCtx=s.BB.ctx(this.canvas),this.canvas.title=(0,a.LANG)("layers-active-layer");var u=s.BB.el({css:{flexGrow:"1",paddingLeft:"10px",fontSize:"13px",overflow:"hidden",position:"relative"}});this.nameLabelEl=s.BB.el({content:"",css:{cssFloat:"left",whiteSpace:"nowrap"}});var p=s.BB.el({css:{position:"absolute",left:"10px",top:"0",width:"90px",height:"100%"}});t.onClick&&(p.addEventListener("click",function(){return t.onClick()},{passive:!1}),this.canvas.addEventListener("click",function(){return t.onClick()},{passive:!1}),o.addEventListener("click",function(){return t.onClick()},{passive:!1})),this.opacityEl=s.BB.el({content:(0,a.LANG)("opacity")+"<br>100%",css:{minWidth:"60px",fontSize:"12px",textAlign:"center"}}),this.largeCanvasWrapper=s.BB.el({onClick:s.BB.handleClick,css:{pointerEvents:"none",background:"#fff",position:"absolute",right:"280px",top:"10px",border:"1px solid #aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",transition:"opacity 300ms ease-in-out",userSelect:"none",display:"block",webkitTouchCallout:"none"}}),this.largeCanvas=s.BB.canvas(this.largeCanvasSize,this.largeCanvasSize),this.largeCanvasWrapper.append(this.largeCanvas),this.largeCanvasCtx=s.BB.ctx(this.largeCanvas),(0,h.css)(this.largeCanvas,{display:"block"}),c.append(this.canvas),u.append(this.nameLabelEl,p),this.contentWrapperEl.append(o,c,u,this.opacityEl),this.rootEl.append(this.contentWrapperEl),this.updateCheckerPatterns(),l.THEME.addIsDarkListener(function(){r.updateCheckerPatterns(),r.draw(!0)}),this.klHistory.addListener(function(){r.updateLabel()}),setInterval(function(){r.layer&&r.klHistory.getChangeCount()!==r.lastDrawnState&&r.draw(!1)},2e3);var d=function(){r.largeCanvasWrapper.remove()},g=function(e){r.largeCanvasIsVisible!==e&&(clearTimeout(i),r.largeCanvasIsVisible=e,e?i=setTimeout(function(){r.drawLargeCanvas(),r.largeCanvasWrapper.style.opacity="0",t.klRootEl.append(r.largeCanvasWrapper),setTimeout(function(){r.largeCanvasWrapper.style.opacity="1"},20)},250):(r.largeCanvasWrapper.style.opacity="0",i=setTimeout(d,320)))};new s.BB.PointerListener({target:this.canvas,onEnterLeave:function(e){g(e)}})}return(0,r._)(e,[{key:"updateCheckerPatterns",value:function(){var e=s.BB.createCheckerCanvas(4,l.THEME.isDark());this.animationCanvasCheckerPattern=(0,h.throwIfNull)(this.animationCanvasCtx.createPattern(e,"repeat")),this.largeCanvasCheckerPattern=(0,h.throwIfNull)(this.canvasCtx.createPattern(e,"repeat"))}},{key:"animate",value:function(){var e=this;0!==this.animationCount&&(this.animationCount--,this.canvasCtx.save(),this.canvasCtx.globalAlpha=Math.pow((this.animationLength-this.animationCount)/this.animationLength,2),this.canvasCtx.drawImage(this.animationCanvas,0,0),this.canvasCtx.restore(),this.animationCount>0&&requestAnimationFrame(function(){return e.animate()}))}},{key:"drawLargeCanvas",value:function(){if(this.largeCanvasIsVisible&&this.layer){var e=this.layer.canvas,t=s.BB.fitInto(e.width,e.height,this.largeCanvasSize,this.largeCanvasSize,1);this.largeCanvas.width=Math.round(t.width),this.largeCanvas.height=Math.round(t.height),this.largeCanvasCtx.save(),this.largeCanvas.width>e.width?this.largeCanvasCtx.imageSmoothingEnabled=!1:(this.largeCanvasCtx.imageSmoothingEnabled=!0,this.largeCanvasCtx.imageSmoothingQuality="high"),this.largeCanvasCtx.fillStyle=this.largeCanvasCheckerPattern,this.largeCanvasCtx.fillRect(0,0,this.largeCanvas.width,this.largeCanvas.height),this.largeCanvasCtx.drawImage(e,0,0,this.largeCanvas.width,this.largeCanvas.height),this.largeCanvasCtx.restore();var i=this.rootEl.getBoundingClientRect();(0,h.css)(this.largeCanvasWrapper,{top:Math.max(10,i.top+this.height/2-this.largeCanvas.height/2)+"px"})}}},{key:"updateLabel",value:function(){if(this.isPreviewVisible&&this.layer){var e=this.layer.isVisible;this.checkEl.parentElement.title=e?(0,a.LANG)("layers-active-layer-visible"):(0,a.LANG)("layers-active-layer-hidden"),this.checkEl.checked=e,this.checkEl.style.boxShadow=e?"":"0 0 0 1px red",this.nameLabelEl.textContent=this.layer.name,this.layer.isVisible?this.opacityEl.innerHTML=(0,a.LANG)("opacity")+"<br>"+Math.round(100*this.layer.opacity)+"%":this.opacityEl.innerHTML=(0,a.LANG)("opacity")+"<br><s>"+Math.round(100*this.layer.opacity)+"%</s>"}}},{key:"draw",value:function(e){if(this.isPreviewVisible&&this.layer){this.updateLabel();var t=this.layer.canvas;if(t.width!==this.lastDrawnSize.width||t.height!==this.lastDrawnSize.height){var i=s.BB.fitInto(t.width,t.height,this.canvasSize,this.canvasSize,1);this.canvas.width=Math.round(i.width),this.canvas.height=Math.round(i.height),e=!0}this.animationCanvas.width=this.canvas.width,this.animationCanvas.height=this.canvas.height,this.animationCanvasCtx.save(),this.animationCanvasCtx.imageSmoothingEnabled=!1,this.animationCanvasCtx.fillStyle=this.animationCanvasCheckerPattern,this.animationCanvasCtx.fillRect(0,0,this.animationCanvas.width,this.animationCanvas.height),this.animationCanvasCtx.drawImage(t,0,0,this.animationCanvas.width,this.animationCanvas.height),this.animationCanvasCtx.restore(),e?(this.animationCount=0,this.canvasCtx.save(),this.canvasCtx.drawImage(this.animationCanvas,0,0),this.canvasCtx.restore()):(this.animationCount=this.animationLength,this.animate()),this.drawLargeCanvas(),this.lastDrawnState=this.klHistory.getChangeCount(),this.lastDrawnSize.width=t.width,this.lastDrawnSize.height=t.height}}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){if(this.isPreviewVisible!==e){this.isPreviewVisible=e,this.contentWrapperEl.style.display=this.isPreviewVisible?"flex":"none",this.rootEl.style.marginBottom=this.isPreviewVisible?"":"10px";var t=this.klHistory.getChangeCount();e&&this.lastDrawnState!==t&&this.draw(!0)}}},{key:"setLayer",value:function(e){this.layer=e,this.draw(!0)}},{key:"setUiState",value:function(e){this.uiState=e,"left"===this.uiState?(0,h.css)(this.largeCanvasWrapper,{left:"280px",right:""}):(0,h.css)(this.largeCanvasWrapper,{left:"",right:"280px"})}}]),e}()}),s("8ebuX",function(t,i){e(t.exports,"showImportAsLayerDialog",function(){return p});var n=o("eWjiX"),r=o("kEeSq"),s=o("2MaaK"),a=o("1mH1z"),l=o("bh77f"),h=o("ChldL"),c=o("eEL9N"),u=o("7jh4K");function p(e){var t=document.createElement("div");if(n.BB.appendTextDiv(t,(0,a.LANG)("import-as-layer-description")),e.klCanvas.isLayerLimitReached()){var i=n.BB.el({className:"kl-import-note",content:(0,a.LANG)("import-as-layer-limit-reached")});t.append(i)}var o=(0,l.testIsSmall)(),p=n.BB.el({css:{display:"flex"}}),d=n.BB.el({tagName:"button",content:"1:1",css:{marginRight:"10px"},onClick:function(){b.reset()}}),g=n.BB.el({tagName:"button",content:(0,a.LANG)("import-as-layer-fit"),css:{marginRight:"10px"},onClick:function(){b.setTransformFit()}}),f=n.BB.el({tagName:"button",content:(0,a.LANG)("center"),css:{marginRight:"10px"},onClick:function(){b.setTransformCenter()}}),v=new(0,c.Select)({isFocusable:!0,optionArr:[["smooth",(0,a.LANG)("algorithm-smooth")],["pixelated",(0,a.LANG)("algorithm-pixelated")]],initValue:"smooth",title:(0,a.LANG)("scaling-algorithm"),onChange:function(e){b.setAlgorithm(e)},name:"interpolation-algorithm"});p.append(d,g,f,n.BB.el({css:{flexGrow:"1"}}),v.getElement()),t.append(p);for(var m=[],y=e.klCanvas.getLayers(),x=0;x<y.length;x++)m.push({image:y[x].context.canvas,isVisible:y[x].isVisible,opacity:y[x].opacity,mixModeStr:y[x].mixModeStr});m.push({image:e.importImage,isVisible:!0,opacity:1,mixModeStr:"source-over"});var b=new(0,r.FreeTransformCanvas)({elementWidth:(0,h.getPreviewWidth)(o),elementHeight:(0,h.getPreviewHeight)(o)+50,imageWidth:e.klCanvas.getLayerContext(0).canvas.width,imageHeight:e.klCanvas.getLayerContext(0).canvas.height,layers:m,transformIndex:m.length-1});function w(e,t){b.move(e,t)}(0,u.css)(b.getElement(),{marginTop:"10px",marginLeft:"-20px"}),t.append(b.getElement());var B=new n.BB.KeyListener({onDown:function(e){"left"===e&&w(-1,0),"right"===e&&w(1,0),"up"===e&&w(0,-1),"down"===e&&w(0,1)}});(0,s.showModal)({target:e.target,message:`<b>${(0,a.LANG)("import-as-layer-title")}</b>`,div:t,style:o?void 0:{width:"540px"},buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(t){B.destroy(),b.destroy(),n.BB.destroyEl(d),n.BB.destroyEl(g),n.BB.destroyEl(f),"Ok"===t?e.callback(b.getTransformation(),b.getIsPixelated()):e.callback()}})}}),s("bh77f",function(t,i){e(t.exports,"testIsSmall",function(){return n});function n(){return window.innerWidth<550}}),s("ChldL",function(t,i){e(t.exports,"SMALL_PREVIEW",function(){return n}),e(t.exports,"MEDIUM_PREVIEW",function(){return r}),e(t.exports,"getPreviewWidth",function(){return o}),e(t.exports,"getPreviewHeight",function(){return s});var n={width:340,height:220},r={width:540,height:300};function o(e){return e?n.width:r.width}function s(e){return e?n.height:r.height}}),s("13r5y",function(t,i){e(t.exports,"KlImageDropper",function(){return a});var n=o("cx0mh"),r=o("eWjiX"),s=o("1mH1z"),a=function e(t){"use strict";var i=this;(0,n._)(this,e),this.rootEl=r.BB.el({content:(0,s.LANG)("dropper-drop"),css:{paddingTop:"100px",position:"fixed",left:"0",top:"0",width:"100%",height:"100%",background:"rgba(50, 50, 50, 0.7)",color:"#fff",textShadow:"2px 2px #000",textAlign:"center",fontSize:"25px"}});var o=r.BB.el({css:{marginTop:"50px",display:"flex",justifyContent:"center"}}),a={width:"200px",padding:"50px",margin:"10px",borderRadius:"20px",border:"1px dashed #fff",background:"#00aefe",fontWeight:"bold"},l=r.BB.el({content:(0,s.LANG)("dropper-as-layer"),css:a}),h=r.BB.el({content:(0,s.LANG)("dropper-as-image"),css:a});this.rootEl.append(o),o.append(l,h);var c=0,u=0,p=0,d=function(){c=0,u=0,p=0,i.rootEl.remove()},g=function(e){return!!e.dataTransfer&&!e.dataTransfer.types.includes("text/plain")},f=function(){var e="0 0 20px 4px #fff";u>0?(l.style.boxShadow=e,h.style.boxShadow=""):p>0?(l.style.boxShadow="",h.style.boxShadow=e):(l.style.boxShadow="",h.style.boxShadow="")};l.addEventListener("dragenter",function(){u++,f()},{passive:!1}),l.addEventListener("dragleave",function(){u--,f()},{passive:!1}),h.addEventListener("dragenter",function(){p++,f()},{passive:!1}),h.addEventListener("dragleave",function(){p--,f()},{passive:!1}),window.addEventListener("dragover",function(e){g(e)&&(e.stopPropagation(),e.preventDefault())},{passive:!1}),window.addEventListener("dragenter",function(e){t.enabledTest()&&g(e)&&(0===c&&t.target.append(i.rootEl),c++)},{passive:!1}),window.addEventListener("dragleave",function(e){g(e)&&0!==c&&0===(c=Math.max(0,c-1))&&i.rootEl.remove()},{passive:!1}),window.addEventListener("drop",function(e){if(!g(e)||!e.dataTransfer||0===e.dataTransfer.files.length)return void d();e.stopPropagation(),e.preventDefault();var n="default";u>0?n="layer":p>0&&(n="image"),t.onDrop(e.dataTransfer.files,n),c>0&&i.rootEl.remove(),c=0,u=0,p=0,f()},{passive:!1}),this.rootEl.addEventListener("pointerdown",function(){d()},{passive:!1}),new r.BB.KeyListener({onDown:function(e){c>0&&"esc"===e&&d()}})}}),s("9p4Zp",function(t,i){e(t.exports,"OverlayToolspace",function(){return u});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("gmji4"),l=o("aP0jf"),h=o("1mH1z"),c=o("7jh4K"),u=function(){"use strict";function e(t){var i=this;(0,n._)(this,e);var r=!1;this.rootEl=s.BB.el({className:"kl-overlay-toolspace"});var o={color:null,size:null,opacity:null},u=s.BB.el({parent:this.rootEl,className:"kl-overlay-toolspace__color"}),p=new(0,a.KlColorSliderSmall)({width:150,heightSV:90,heightH:20,color:t.brushSettingService.getColor(),callback:function(e){d.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")",t.brushSettingService.setColor(e,y)}}),d=s.BB.el({css:{width:"150px",height:"20px",pointerEvents:"none"}}),g=t.brushSettingService.getColor();d.style.backgroundColor="rgb("+g.r+","+g.g+","+g.b+")",u.append(d,p.getElement());var f=function(e){p.setColor(e),d.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")"},v=new(0,l.KlSlider)({label:(0,h.LANG)("brush-size"),width:150,height:25,min:0,max:500,value:50,resolution:225,eventResMs:1e3/30,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(e){t.brushSettingService.setSize(e)},formatFunc:function(e){return e<10?s.BB.round(e,1):Math.round(e)}});(0,c.css)(v.getElement(),{marginTop:"2px"});var m=new(0,l.KlSlider)({label:(0,h.LANG)("opacity"),width:150,height:25,min:0,max:1,value:1,resolution:225,eventResMs:1e3/30,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(e){t.brushSettingService.setOpacity(e)}});(0,c.css)(m.getElement(),{margin:"2px 0"}),this.rootEl.append(v.getElement(),m.getElement());var y=function(e){"color"===e.type&&(r?f(e.value):o.color=e.value),"size"===e.type&&(r?v.setValue(e.value):o.size=e.value),"opacity"===e.type&&(r?m.setValue(e.value):o.opacity=e.value),"sliderConfig"===e.type&&(v.update(e.value.sizeSlider),m.update(e.value.opacitySlider))};t.brushSettingService.subscribe(y);var x=t.brushSettingService.getSliderConfig();v.update(x.sizeSlider),m.update(x.opacitySlider),v.setValue(t.brushSettingService.getSize()),m.setValue(t.brushSettingService.getOpacity());var b=function(){s.BB.unfocusAnyInput(),i.rootEl.style.display=r?"block":"none",r&&w&&(0,c.css)(i.rootEl,{left:w.x-Math.round(75)+"px",top:w.y-Math.round(120)+"px"})},w=null;document.addEventListener("pointermove",function(e){w={x:e.pageX,y:e.pageY}},{passive:!1}),new s.BB.KeyListener({onDown:function(e,i,n,s){if(!s){if(r){r=!1,b();return}t.enabledTest()&&w&&["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(n)&&(i.preventDefault(),r=!0,null!==o.color&&(f(o.color),o.color=null),null!==o.size&&(v.setValue(o.size),o.size=null),null!==o.opacity&&(m.setValue(o.opacity),o.opacity=null),b())}},onUp:function(e,t,i){["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(i)&&r&&(r=!1,p.end(),b())},onBlur:function(){r&&(r=!1,p.end(),b())}})}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("8jqzp",function(i,n){e(i.exports,"ToolspaceTopRow",function(){return v});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("ci8rB"),h=o("a1LdA"),c=o("k5MuS"),u=o("aCdZo"),p=o("8VP9O"),d=o("8ae5f"),g=o("1mH1z"),f=o("7jh4K"),v=function(){"use strict";function e(i){(0,r._)(this,e);var n=function(e){var t=6+(e.extraPadding?e.extraPadding:0),i=a.BB.el({className:"toolspace-row-button nohighlight",title:e.title,onClick:e.onClick,css:{padding:e.contain?t+"px 0":""}}),n=a.BB.el({className:e.darkInvert?"dark-invert":void 0,css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%"}});n.style.pointerEvents="none",i.append(n);var r=new a.BB.PointerListener({target:i,onEnterLeave:function(e){i.classList.toggle("toolspace-row-button-hover",e)}});return{el:i,pointerListener:r}};this.rootEl=a.BB.el({className:"kl-toolspace-row",css:{height:"36px",display:"flex"}});var o=n({onClick:i.onLogo,title:(0,g.LANG)("home"),image:i.logoImg?i.logoImg:t(l),contain:!0,darkInvert:!0});o.el.classList.add("kl-tool-row-border-right"),(0,f.css)(o.el,{width:"46px"});var s=n({onClick:i.onNew,title:(0,g.LANG)("file-new"),image:t(h),extraPadding:1,contain:!0}),v=n({onClick:i.onImport,title:(0,g.LANG)("file-import"),image:t(c),extraPadding:1,contain:!0}),m=n({onClick:i.onSave,title:(0,g.LANG)("file-save"),image:t(u),extraPadding:1,contain:!0}),y=null;a.BB.canShareFiles()&&(y=n({onClick:i.onShare,title:(0,g.LANG)("file-share"),image:t(p),contain:!0,darkInvert:!0}));var x=n({onClick:i.onHelp,title:(0,g.LANG)("help"),image:t(d),contain:!0,darkInvert:!0});a.BB.append(this.rootEl,[o.el,s.el,v.el,m.el,y?y.el:void 0,x.el])}return(0,s._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("ci8rB",function(e,t){e.exports=i("eHdqz")}),s("a1LdA",function(e,t){e.exports=i("3x5dR")}),s("k5MuS",function(e,t){e.exports=i("hbDTd")}),s("aCdZo",function(e,t){e.exports=i("16iGk")}),s("8VP9O",function(e,t){e.exports=i("2ME3z")}),s("8ae5f",function(e,t){e.exports=i("hZnSk")}),s("84zxV",function(i,n){e(i.exports,"ToolDropdown",function(){return x});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("i8UFO"),h=o("249G2"),c=o("M2Apn"),u=o("6hU8m"),p=o("aCkKZ"),d=o("ewCAh"),g=o("fRiur"),f=o("1mH1z"),v=o("04lDo"),m=o("amum4"),y=o("7jh4K"),x=function(){"use strict";function e(i){var n,o,s,y=this;(0,r._)(this,e),this.smallMargin="6px 0",this.optionArr=["brush","paintBucket","gradient","text","shape","select"],this.imArr=[t(h),t(c),t(u),t(p),t(d),t(g)],this.titleArr=[`${(0,f.LANG)("tool-brush")} [B]`,`${(0,f.LANG)("tool-paint-bucket")} [G]`,`${(0,f.LANG)("tool-gradient")} [G]`,`${(0,f.LANG)("tool-text")} [T]`,`${(0,f.LANG)("tool-shape")} [U]`,`${(0,f.LANG)("tool-select")} [L]`],this.currentActiveIndex=0,this.isActive=!0;var x=!1;setTimeout(function(){for(var e=1;e<y.imArr.length;e++)new Image().src=y.imArr[e]},100),this.rootEl=a.BB.el({css:{position:"relative",flexGrow:"1"}});var b=!1;a.BB.hasPointerEvents&&new a.BB.PointerListener({target:this.rootEl,onPointer:function(e){if("pointerdown"===e.type)x||(n=setTimeout(function(){E()},400),b=!0,o=e.pageX,s=e.pageY);else if("pointermove"===e.type&&b)!x&&a.BB.dist(o,s,e.pageX,e.pageY)>5&&(clearTimeout(n),E());else if("pointerup"===e.type&&b&&(clearTimeout(n),b=!1,x)){for(var t=document.elementFromPoint(e.pageX,e.pageY),r=0;r<y.dropdownBtnArr.length;r++)if(t===y.dropdownBtnArr[r].wrapper){L(),y.isActive=!0,y.currentActiveIndex=r,y.updateButton(),i.onChange(y.optionArr[y.currentActiveIndex]);break}}}}),this.activeButton=a.BB.el({parent:this.rootEl,className:"toolspace-row-button nohighlight toolspace-row-button-activated",title:this.titleArr[this.currentActiveIndex],onClick:function(e){if(y.isActive&&!x){e.preventDefault(),e.stopPropagation(),E();return}y.isActive=!0,i.onChange(y.optionArr[y.currentActiveIndex]),x&&L()},css:{padding:"10px 0",pointerEvents:"auto",height:"100%",boxSizing:"border-box",zIndex:"1"}}),new(0,v.PointerListener)({target:this.activeButton,onEnterLeave:function(e){y.activeButton.classList.toggle("kl-tool-button--hover",e)}}),this.activeButtonIm=a.BB.el({parent:this.activeButton,className:"dark-invert",css:{backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",width:"calc(100% - 7px)",height:"100%",pointerEvents:"none",opacity:"0.75"}}),this.arrowButton=a.BB.el({parent:this.activeButton,className:"kl-tooldropdown-caret",content:(0,m.c)(".dark-invert"),title:(0,f.LANG)("tool-more-tools"),onClick:function(e){e.preventDefault(),e.stopPropagation(),E()}});var w=a.BB.el({css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}});new a.BB.PointerListener({target:w,onPointer:function(e){"pointerdown"===e.type&&(e.eventPreventDefault(),L())}});var B=a.BB.el({className:"tool-dropdown-wrapper",css:{position:"absolute",width:"100%",height:100*(this.optionArr.length-1)+"%",top:"100%",left:"0",zIndex:"-1",boxSizing:"border-box",cursor:"pointer",transition:"height 0.1s ease-in-out, opacity 0.1s ease-in-out",borderBottomLeftRadius:"5px",borderBottomRightRadius:"5px",overflow:"hidden"}});this.dropdownBtnArr=[];for(var k=function(e){var t=a.BB.el({parent:B,className:"tool-dropdown-button",title:e.title,css:{padding:"10px 0",height:100/(y.optionArr.length-1)+"%",boxSizing:"border-box"},onClick:function(t){t.preventDefault(),t.stopPropagation(),e.onClick(e.index)}});return a.BB.el({parent:t,className:"dark-invert",css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",height:"100%",pointerEvents:"none",opacity:"0.75"}}),{wrapper:t,show:function(e){t.style.display=e?"block":"none"},setIsSmall:function(e){t.style.padding=e?y.smallMargin:"10px 0"}}},S=function(e){L(),y.isActive=!0,y.currentActiveIndex=e,y.updateButton(),i.onChange(y.optionArr[y.currentActiveIndex])},C=0;C<this.optionArr.length;C++)this.dropdownBtnArr.push(k({index:C,id:this.optionArr[C],image:this.imArr[C],title:this.titleArr[C],onClick:S}));var E=function(){if(!(l.DIALOG_COUNTER.get()>0)){l.DIALOG_COUNTER.increase(.5),x=!0;for(var e=0;e<y.optionArr.length;e++)y.dropdownBtnArr[e].show(y.currentActiveIndex!==e);y.arrowButton.style.setProperty("opacity","0"),y.arrowButton.style.setProperty("pointer-events","none"),y.rootEl.style.zIndex="1",document.body.append(w),y.rootEl.append(B)}},L=function(){l.DIALOG_COUNTER.decrease(.5),x=!1,y.arrowButton.style.removeProperty("opacity"),y.arrowButton.style.removeProperty("pointer-events"),y.rootEl.style.removeProperty("z-index"),w.remove(),B.remove()};this.updateButton()}return(0,s._)(e,[{key:"updateButton",value:function(){this.activeButton.title=this.titleArr[this.currentActiveIndex]+(this.isActive?" ("+(0,f.LANG)("tool-more-tools-click-again")+")":""),this.activeButtonIm.style.backgroundImage="url('"+this.imArr[this.currentActiveIndex]+"')"}},{key:"setIsSmall",value:function(e){this.activeButton.style.padding=e?this.smallMargin:"10px 0";for(var t=0;t<this.optionArr.length;t++)this.dropdownBtnArr[t].setIsSmall(e);(0,y.css)(this.arrowButton,{width:e?"14px":"18px",height:e?"14px":"18px"})}},{key:"setActive",value:function(e){if(this.optionArr.includes(e)){this.isActive=!0;for(var t=0;t<this.optionArr.length;t++)if(this.optionArr[t]===e){this.currentActiveIndex=t;break}this.activeButton.classList.add("toolspace-row-button-activated"),this.updateButton()}else this.isActive=!1,this.activeButton.classList.remove("toolspace-row-button-activated"),this.updateButton()}},{key:"getActive",value:function(){return this.optionArr[this.currentActiveIndex]}},{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("249G2",function(e,t){e.exports=i("6mHrC")}),s("M2Apn",function(e,t){e.exports=i("hS5Hj")}),s("6hU8m",function(e,t){e.exports=i("4KGfM")}),s("aCkKZ",function(e,t){e.exports=i("doX4v")}),s("ewCAh",function(e,t){e.exports=i("7NqHO")}),s("fRiur",function(e,t){e.exports=i("kOuYd")}),s("9Kxky",function(i,n){e(i.exports,"ToolspaceToolRow",function(){return f});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("84zxV"),h=o("kgQ1R"),c=o("hdxwe"),u=o("jF2Bh"),p=o("4rWYn"),d=o("1mH1z"),g=o("7jh4K"),f=function(){"use strict";function e(i){var n=this;(0,r._)(this,e),this.rootEl=a.BB.el({className:"kl-toolspace-row",css:{height:"54px",display:"flex"}}),this.onActivate=i.onActivate,this.currentActiveStr="brush";var o=function(e){var t=e.doLighten?"6px 0":"8px 0",i=a.BB.el({className:"toolspace-row-button nohighlight",onClick:e.onClick,css:{padding:e.contain?"10px 0":""}}),n=a.BB.el({className:"dark-invert",css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%",transform:e.doMirror?"scale(-1, 1)":"",pointerEvents:"none",opacity:e.doLighten?"0.75":"1"}});i.append(n);var r=new a.BB.PointerListener({target:i,onEnterLeave:function(e){i.classList.toggle("toolspace-row-button-hover",e)}});return{el:i,pointerListener:r,setIsSmall:function(n){i.style.padding=e.contain?n?t:"10px 0":""}}},s=function(e){var t=a.BB.el({css:{flexGrow:"1",position:"relative"}}),i=a.BB.createSvg({elementType:"svg",width:"67px",height:"54px",viewBox:"0 0 100 100",preserveAspectRatio:"none"});(0,g.css)(i,{position:"absolute",left:"0",top:"0"});var n=a.BB.createSvg({elementType:"defs",childrenArr:[{elementType:"filter",id:"innershadow",x0:"-50%",y0:"-50%",width:"200%",height:"200%",childrenArr:[{elementType:"feGaussianBlur",in:"SourceAlpha",stdDeviation:"10",result:"blur"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"SourceAlpha",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"SourceGraphic",operator:"over",result:"firstfilter"},{elementType:"feGaussianBlur",in:"firstfilter",stdDeviation:"10",result:"blur2"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"firstfilter",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"firstfilter",operator:"over"}]}]}),r=a.BB.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M0,0 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});r.onclick=function(){e.onLeft(),r.classList.remove("toolspace-svg-triangle-button-hover")};var o=a.BB.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M100,100 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});o.onclick=function(){e.onRight(),o.classList.remove("toolspace-svg-triangle-button-hover")};var s=new a.BB.PointerListener({target:r,onEnterLeave:function(e){r.classList.toggle("toolspace-svg-triangle-button-hover",e)}}),l=new a.BB.PointerListener({target:o,onEnterLeave:function(e){o.classList.toggle("toolspace-svg-triangle-button-hover",e)}});i.append(n,r,o),t.append(i);var h=a.BB.el({parent:t,className:"dark-invert",css:{backgroundImage:"url('"+e.leftImage+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",left:"10px",top:"8px",pointerEvents:"none"}});t.append(h);var c=a.BB.el({parent:t,className:"dark-invert",css:{backgroundImage:"url('"+(e.rightImage?e.rightImage:e.leftImage)+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",right:"10px",bottom:"8px",transform:e.rightImage?"":"scale(-1, 1)",pointerEvents:"none"}});return{el:t,setIsEnabledLeft:function(e){r.classList.toggle("toolspace-row-button-disabled",!e),h.classList.toggle("toolspace-row-button-disabled",!e)},setIsEnabledRight:function(e){o.classList.toggle("toolspace-row-button-disabled",!e),c.classList.toggle("toolspace-row-button-disabled",!e)},leftPointerListener:s,rightPointerListener:l}};this.toolDropdown=new(0,l.ToolDropdown)({onChange:function(e){n.setActive(e,!0)}}),this.rootEl.append(this.toolDropdown.getElement()),this.handButton=o({onClick:function(){n.setActive("hand",!0)},image:t(h),contain:!0,doLighten:!0}),this.handButton.el.classList.add("kl-tool-row-border-right"),this.handButton.el.title=(0,d.LANG)("tool-hand"),this.rootEl.append(this.handButton.el),this.zoomInNOutButton=s({onLeft:i.onZoomIn,onRight:i.onZoomOut,leftImage:t(c),rightImage:t(u)}),this.zoomInNOutButton.el.title=(0,d.LANG)("tool-zoom"),this.rootEl.append(this.zoomInNOutButton.el),this.zoomInButton=o({onClick:i.onZoomIn,image:t(c),contain:!0}),this.zoomInButton.el.title=(0,d.LANG)("zoom-in"),this.rootEl.append(this.zoomInButton.el),this.zoomOutButton=o({onClick:i.onZoomOut,image:t(u),contain:!0}),this.zoomOutButton.el.title=(0,d.LANG)("zoom-out"),this.rootEl.append(this.zoomOutButton.el),this.undoNRedoButton=s({onLeft:i.onUndo,onRight:i.onRedo,leftImage:t(p),rightImage:null}),this.undoNRedoButton.el.title=(0,d.LANG)("undo")+"/"+(0,d.LANG)("redo"),this.undoNRedoButton.setIsEnabledLeft(!1),this.undoNRedoButton.setIsEnabledRight(!1),this.rootEl.append(this.undoNRedoButton.el),this.undoButton=o({onClick:i.onUndo,image:t(p),contain:!0}),this.undoButton.el.title=(0,d.LANG)("undo"),this.undoButton.el.classList.add("toolspace-row-button-disabled"),this.rootEl.append(this.undoButton.el),this.redoButton=o({onClick:i.onRedo,image:t(p),contain:!0,doMirror:!0}),this.redoButton.el.title=(0,d.LANG)("redo"),this.redoButton.el.classList.add("toolspace-row-button-disabled"),this.rootEl.append(this.redoButton.el),this.zoomInButton.el.style.display="none",this.zoomOutButton.el.style.display="none",this.undoButton.el.style.display="none",this.redoButton.el.style.display="none"}return(0,s._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsSmall",value:function(e){(0,g.css)(this.rootEl,{height:e?"36px":"54px"}),this.toolDropdown.setIsSmall(e),this.handButton.setIsSmall(e),this.zoomInButton.setIsSmall(e),this.zoomOutButton.setIsSmall(e),this.undoButton.setIsSmall(e),this.redoButton.setIsSmall(e),e?(this.zoomInNOutButton.el.style.display="none",this.undoNRedoButton.el.style.display="none",this.zoomInButton.el.style.display="block",this.zoomOutButton.el.style.display="block",this.undoButton.el.style.display="block",this.redoButton.el.style.display="block"):(this.zoomInNOutButton.el.style.display="block",this.undoNRedoButton.el.style.display="block",this.zoomInButton.el.style.display="none",this.zoomOutButton.el.style.display="none",this.undoButton.el.style.display="none",this.redoButton.el.style.display="none")}},{key:"setEnableZoomIn",value:function(e){this.zoomInButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.zoomInNOutButton.setIsEnabledLeft(e)}},{key:"setEnableZoomOut",value:function(e){this.zoomOutButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.zoomInNOutButton.setIsEnabledRight(e)}},{key:"setEnableUndo",value:function(e){this.undoButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.undoNRedoButton.setIsEnabledLeft(e)}},{key:"setEnableRedo",value:function(e){this.redoButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.undoNRedoButton.setIsEnabledRight(e)}},{key:"setActive",value:function(e,t){this.currentActiveStr!==e&&(this.currentActiveStr=e,this.toolDropdown.setActive(this.currentActiveStr),this.handButton.el.classList.toggle("toolspace-row-button-activated","hand"===this.currentActiveStr),t&&this.onActivate(this.currentActiveStr))}},{key:"getActive",value:function(){return this.currentActiveStr}}]),e}()}),s("4rWYn",function(e,t){e.exports=i("AnO0a")}),s("1Ax5m",function(t,i){e(t.exports,"ToolspaceStabilizerRow",function(){return h});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("eEL9N"),l=o("1mH1z"),h=function(){"use strict";function e(t){(0,n._)(this,e),this.rootEl=s.BB.el({tagName:"label",className:"kl-stabilizer",content:(0,l.LANG)("stabilizer")+"&nbsp;",title:(0,l.LANG)("stabilizer-title")});var i=new(0,a.Select)({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]],initValue:""+t.smoothing,onChange:function(e){t.onSelect(parseInt(e))},name:"stabilizer-strength"});this.rootEl.append(i.getElement()),this.pointerListener=new s.BB.PointerListener({target:this.rootEl,onWheel:function(e){i.setDeltaValue(e.deltaY)}})}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("e4sAN",function(t,i){e(t.exports,"TabRow",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){var i,r=this;(0,n._)(this,e);var o=null!=(i=t.height)?i:35;this.rootEl=s.BB.el({className:"tabrow",css:{height:o+1+"px"}}),this.tabArr=[],this.roundRight=s.BB.el({className:"tabrow__tab__rounding-left"}),this.roundLeft=s.BB.el({className:"tabrow__tab__rounding-right"});for(var l=function(e,t,i){var n=!("isVisible"in e)||void 0===e.isVisible||e.isVisible,l={id:e.id,isVisible:n,onOpen:e.onOpen,onClose:e.onClose,update:function(e){l.el.className=e===l?i?"tabrow__tab tabrow__tab--opened-accented":"tabrow__tab tabrow__tab--opened":"tabrow__tab",l.el.style.display=l.isVisible?"block":"none"},el:s.BB.el({parent:r.rootEl,content:"label"in e?e.label:"",title:"title"in e?e.title:void 0,className:t===e.id?i?"tabrow__tab tabrow__tab--opened-accented":"tabrow__tab tabrow__tab--opened":"tabrow__tab",css:{lineHeight:o+"px",display:n?"block":"none"},onClick:function(){r.activeTab!==l&&r.open(l.id)}}),pointerListener:{}};return"image"in e&&s.BB.el({tagName:"span",parent:l.el,className:"dark-invert",css:{backgroundImage:`url("${e.image}")`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",display:"flex",height:o-7+"px",justifyContent:"center",margin:"4px auto"}}),"css"in e&&void 0!==e.css&&(0,a.css)(l.el,e.css),l.pointerListener=new s.BB.PointerListener({target:l.el,onEnterLeave:function(e){l.el.classList.toggle("tabrow__tab-hover",e)}}),t===l.id?(l.onOpen(),l.el.append(r.roundRight,r.roundLeft)):l.onClose(),l},h=null,c=0;c<t.tabArr.length;c++){var u=l(t.tabArr[c],t.initialId,t.useAccent||!1);u.id===t.initialId&&(h=u),this.tabArr.push(u)}if(!h)throw"invalid initialId";this.activeTab=h}return(0,r._)(e,[{key:"update",value:function(){for(var e=0;e<this.tabArr.length;e++)this.tabArr[e].update(this.activeTab)}},{key:"getElement",value:function(){return this.rootEl}},{key:"open",value:function(e){for(var t=0;t<this.tabArr.length;t++)if(this.tabArr[t].id===e){if(this.activeTab===this.tabArr[t])return;this.activeTab.onClose(),this.activeTab=this.tabArr[t],this.activeTab.onOpen(),this.activeTab.el.append(this.roundRight,this.roundLeft),this.update();return}throw"TabRow.open - invalid tabId"}},{key:"getOpenedTabId",value:function(){return""+this.activeTab.id}},{key:"setIsVisible",value:function(e,t){for(var i=0;i<this.tabArr.length;i++)if(this.tabArr[i].id===e){this.tabArr[i].isVisible=t,this.update();return}throw"TabRow.setIsVisible - invalid tabId"}},{key:"destroy",value:function(){this.tabArr.forEach(function(e){s.BB.destroyEl(e.el),e.pointerListener.destroy()})}}]),e}()}),s("khi8I",function(i,n){e(i.exports,"HandUi",function(){return v});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("eSmPZ"),h=o("6q83x"),c=o("1mH1z"),u=o("7bWhB"),p=o("6l0gQ"),d=o("7jh4K"),g=o("72Jv0"),f="kl-inertia-scroll",v=function(){"use strict";function e(i){(0,r._)(this,e),this.isVisible=!0,this.rootEl=a.BB.el({css:{margin:"10px"}}),this.scale=i.scale,this.angleDeg=i.angleDeg,this.onAngleChange=i.onAngleChange;var n=a.BB.el({css:{marginBottom:"10px",display:"flex"}}),o=a.BB.el({css:{display:"flex",marginBottom:"10px"}}),s=a.BB.el({css:{display:"flex"}});this.rootEl.append(n,o,s),this.scaleEl=a.BB.el({css:{width:"65px",userSelect:"none",fontFamily:"monospace"}}),n.append(this.scaleEl),this.angleIm=new Image,this.angleIm.src=t(l),(0,d.css)(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginRight:"5px",borderRadius:"10px",background:"rgba(0,0,0,0.2)",userSelect:"none"}),n.append(this.angleIm),this.angleEl=a.BB.el({parent:n,css:{userSelect:"none"}}),this.updateUi();var v=a.BB.el({tagName:"button",content:(0,c.LANG)("hand-reset"),onClick:i.onReset});(0,g.makeUnfocusable)(v);var m=a.BB.el({tagName:"button",content:(0,c.LANG)("hand-fit"),css:{marginLeft:"10px"},onClick:i.onFit});(0,g.makeUnfocusable)(m),o.append(v,m);var y=new Image;y.height=20,y.src=t(h),y.alt="Rotate",(0,d.css)(y,{transform:"scale(-1, 1)"});var x=a.BB.el({tagName:"button",content:y,onClick:function(){i.onAngleChange(-15,!0)}});(0,g.makeUnfocusable)(x);var b=a.BB.el({tagName:"button",content:"0°",css:{marginLeft:"10px"},onClick:function(){i.onAngleChange(0)}});(0,g.makeUnfocusable)(b);var w=a.BB.el({tagName:"button",content:'<img height="20" src="'+t(h)+'" alt="Rotate"/>',css:{marginLeft:"10px"},onClick:function(){i.onAngleChange(15,!0)}});(0,g.makeUnfocusable)(w),s.append(x,b,w);var B=new(0,u.Checkbox)({label:(0,c.LANG)("hand-inertia-scrolling"),init:"true"===p.LocalStorage.getItem(f),callback:function(e){p.LocalStorage.setItem(f,""+e),i.onChangeUseInertiaScrolling(e)},name:"enable-inertia-scrolling"});setTimeout(function(){i.onChangeUseInertiaScrolling(B.getValue())},500),(0,d.css)(B.getElement(),{marginTop:"10px",display:"inline-block"}),this.rootEl.append(B.getElement())}return(0,s._)(e,[{key:"updateUi",value:function(){this.scaleEl.innerHTML=Math.round(100*this.scale)+"%",this.angleEl.innerHTML=Math.round(this.angleDeg)+"°",(0,d.css)(this.angleIm,{transform:"rotate("+this.angleDeg+"deg)",boxShadow:this.angleDeg%90==0?"inset 0 0 0 1px rgba(255,255,255, 1), 0 0 0 1px rgba(0, 0, 0, 0.3)":""})}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.updateUi()}},{key:"update",value:function(e,t){this.scale=e,this.angleDeg=t,this.isVisible&&this.updateUi()}}]),e}()}),s("6q83x",function(e,t){e.exports=i("6toXQ")}),s("dJXmR",function(t,i){e(t.exports,"FillUi",function(){return p});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("aP0jf"),l=o("eEL9N"),h=o("7bWhB"),c=o("1mH1z"),u=o("7jh4K"),p=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.rootEl=s.BB.el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=s.BB.el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.colorSlider=t.colorSlider,this.opacitySlider=new(0,a.KlSlider)({label:(0,c.LANG)("opacity"),width:250,height:30,min:.01,max:1,value:1,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e}}),this.rootEl.append(this.opacitySlider.getElement()),this.toleranceSlider=new(0,a.KlSlider)({label:(0,c.LANG)("bucket-tolerance"),width:250,height:30,min:0,max:255,value:51,toValue:function(e){return 2.55*e},toDisplayValue:function(e){return e/2.55}}),(0,u.css)(this.toleranceSlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.toleranceSlider.getElement());var r=s.BB.el({parent:this.rootEl,css:{display:"flex",marginTop:"10px"}}),o=s.BB.el({content:(0,c.LANG)("bucket-sample")+"&nbsp;",title:(0,c.LANG)("bucket-sample-title"),css:{fontSize:"15px"}});this.modeSelect=new(0,l.Select)({optionArr:[["all",(0,c.LANG)("bucket-sample-all")],["current",(0,c.LANG)("bucket-sample-active")],["above",(0,c.LANG)("bucket-sample-above")]],initValue:"all",name:"sampling-mode"}),new s.BB.PointerListener({target:this.modeSelect.getElement(),onWheel:function(e){i.modeSelect.setDeltaValue(e.deltaY)}}),o.append(this.modeSelect.getElement()),r.append(o);var p=s.BB.el({content:(0,c.LANG)("bucket-grow")+"&nbsp;",title:(0,c.LANG)("bucket-grow-title"),css:{fontSize:"15px",marginLeft:"10px"}});this.growSelect=new(0,l.Select)({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"]],initValue:"0",name:"fill-growth"}),new s.BB.PointerListener({target:this.growSelect.getElement(),onWheel:function(e){i.growSelect.setDeltaValue(e.deltaY)}}),p.append(this.growSelect.getElement()),r.append(p),this.isContiguous=!0;var d=new(0,h.Checkbox)({init:!0,label:(0,c.LANG)("bucket-contiguous"),title:(0,c.LANG)("bucket-contiguous-title"),callback:function(e){i.isContiguous=e},name:"is-contiguous"});this.eraserToggle=new(0,h.Checkbox)({init:!1,label:(0,c.LANG)("eraser"),name:"eraser-toggle"}),this.rootEl.append(s.BB.el({content:[d.getElement(),this.eraserToggle.getElement()],css:{display:"flex",marginTop:"10px",gap:"10px"}}))}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}},{key:"getTolerance",value:function(){return 0===Math.round(this.toleranceSlider.getDisplayValue())?0:this.toleranceSlider.getValue()}},{key:"getOpacity",value:function(){return this.opacitySlider.getValue()}},{key:"getSample",value:function(){return this.modeSelect.getValue()}},{key:"getGrow",value:function(){return parseInt(this.growSelect.getValue(),10)}},{key:"getContiguous",value:function(){return this.isContiguous}},{key:"getIsEraser",value:function(){return this.eraserToggle.getValue()}}]),e}()}),s("iS9xS",function(t,i){e(t.exports,"TextUi",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("1mH1z"),l=function(){"use strict";function e(t){(0,n._)(this,e),this.isVisible=!0,this.rootEl=s.BB.el({css:{margin:"10px"}}),this.colorSlider=t.colorSlider,this.colorDiv=s.BB.el({parent:this.rootEl,css:{marginBottom:"10px"}}),s.BB.el({parent:this.rootEl,content:(0,a.LANG)("text-instruction")})}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}}]),e}()}),s("9J17G",function(t,i){e(t.exports,"ShapeUi",function(){return p});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("iFIyy"),l=o("7bWhB"),h=o("aP0jf"),c=o("1mH1z"),u=o("7jh4K"),p=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.shape="rect",this.mode="stroke",this.rootEl=s.BB.el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=s.BB.el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.colorSlider=t.colorSlider;var r=s.BB.createSvg({elementType:"rect",x:"8",width:"19"}),o=s.BB.createSvg({elementType:"svg",width:"35",height:"35"});o.classList.add("dark-invert"),o.append(r),(0,u.css)(o,{display:"block"});var p=s.BB.createSvg({elementType:"rect",x:"8",width:"19"}),d=s.BB.createSvg({elementType:"svg",width:"35",height:"35"});d.classList.add("dark-invert"),d.append(p),(0,u.css)(d,{display:"block"});var g=s.BB.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),f=s.BB.createSvg({elementType:"svg",width:"35",height:"35"});f.classList.add("dark-invert"),f.append(g),(0,u.css)(f,{display:"block"});var v=s.BB.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),m=s.BB.createSvg({elementType:"svg",width:"35",height:"35"});m.classList.add("dark-invert"),m.append(v),(0,u.css)(m,{display:"block"});var y=s.BB.createSvg({elementType:"line",x1:"8",x2:"27"}),x=s.BB.createSvg({elementType:"svg",width:"35",height:"35"});x.classList.add("dark-invert"),x.append(y),(0,u.css)(x,{display:"block"});var b=function(){var e=s.BB.clamp(Math.round(i.lineWidthSlider.getValue()/10),1,10)+"px";(0,u.css)(r,{fill:"none",stroke:"black",strokeWidth:e}),(0,u.css)(p,{fill:"black",stroke:"none"}),(0,u.css)(g,{fill:"none",stroke:"black",strokeWidth:e}),(0,u.css)(v,{fill:"black",stroke:"none"}),(0,u.css)(y,{fill:"none",stroke:"black",strokeWidth:e}),i.fixedToggle.getValue()?(r.setAttribute("y","8"),r.setAttribute("height","19"),p.setAttribute("y","8"),p.setAttribute("height","19"),g.setAttribute("ry","9.5"),v.setAttribute("ry","9.5")):(r.setAttribute("y","10.8"),r.setAttribute("height","13.399999999999999"),p.setAttribute("y","10.8"),p.setAttribute("height","13.399999999999999"),g.setAttribute("ry","6.699999999999999"),v.setAttribute("ry","6.699999999999999")),i.snapToggle.getValue()?(y.setAttribute("y1","27"),y.setAttribute("y2","8")):(y.setAttribute("y1","24.2"),y.setAttribute("y2","10.8"))},w=s.BB.el({parent:this.rootEl,css:{display:"flex",justifyContent:"space-between",alignItems:"start"}}),B=new(0,a.Options)({optionArr:[{id:"rect-stroke",label:o,title:(0,c.LANG)("shape-rect")+" "+(0,c.LANG)("shape-stroke")},{id:"ellipse-stroke",label:f,title:(0,c.LANG)("shape-ellipse")+" "+(0,c.LANG)("shape-stroke")},{id:"line",label:x,title:(0,c.LANG)("shape-line")},{id:"rect-fill",label:d,title:(0,c.LANG)("shape-rect")+" "+(0,c.LANG)("shape-fill")},{id:"ellipse-fill",label:m,title:(0,c.LANG)("shape-ellipse")+" "+(0,c.LANG)("shape-fill")}],initId:this.shape+" "+this.mode,onChange:function(e){var t=e.split("-");i.shape=t[0],i.mode=t[1],(0,u.css)(i.fixedToggle.getElement(),{display:"line"===i.shape?"none":""}),(0,u.css)(i.snapToggle.getElement(),{display:"line"===i.shape?"":"none"}),(0,u.css)(i.lineWidthSlider.getElement(),{display:"line"!==i.shape&&"fill"===i.mode?"none":""})},changeOnInit:!0,css:{width:"120px"}});w.append(B.getElement()),this.eraserToggle=new(0,l.Checkbox)({init:!1,label:(0,c.LANG)("eraser"),callback:function(){b()},name:"enable-eraser"}),this.lockAlphaToggle=new(0,l.Checkbox)({init:!1,label:(0,c.LANG)("lock-alpha"),title:(0,c.LANG)("lock-alpha-title"),doHighlight:!0,name:"enable-alpha-lock"}),this.lockAlphaToggle.getElement().style.marginTop="10px",this.panningToggle=new(0,l.Checkbox)({init:!1,label:(0,c.LANG)("shape-auto-pan"),title:(0,c.LANG)("shape-auto-pan-title"),callback:function(e){return t.onChangePanning(e)},name:"enable-auto-pan"}),this.panningToggle.getElement().style.marginTop="10px",w.append(s.BB.el({content:[this.eraserToggle.getElement(),this.lockAlphaToggle.getElement(),this.panningToggle.getElement()]})),this.lineWidthSlider=new(0,h.KlSlider)({label:(0,c.LANG)("shape-line-width"),width:250,height:30,min:1,max:200,value:4,curve:"quadratic",onChange:function(){b()}}),(0,u.css)(this.lineWidthSlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.lineWidthSlider.getElement()),this.opacitySlider=new(0,h.KlSlider)({label:(0,c.LANG)("opacity"),width:250,height:30,min:.01,max:1,value:1,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e}}),(0,u.css)(this.opacitySlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.opacitySlider.getElement());var k=s.BB.el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px",gap:"10px"}});this.outwardsToggle=new(0,l.Checkbox)({init:!1,label:(0,c.LANG)("shape-outwards"),name:"enable-outwards"}),k.append(this.outwardsToggle.getElement()),this.fixedToggle=new(0,l.Checkbox)({init:!1,label:(0,c.LANG)("shape-fixed"),callback:function(){b()},name:"enable-fixed-proportions"}),k.append(this.fixedToggle.getElement()),this.snapToggle=new(0,l.Checkbox)({init:!1,label:(0,c.LANG)("angle-snap"),title:(0,c.LANG)("angle-snap-title"),callback:function(){b()},name:"enable-angle-snapping"}),k.append(this.snapToggle.getElement()),b()}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&(this.colorDiv.append(this.colorSlider.getElement()),this.colorDiv.append(this.colorSlider.getOutputElement()))}},{key:"getShape",value:function(){return this.shape}},{key:"getMode",value:function(){return this.mode}},{key:"getIsEraser",value:function(){return this.eraserToggle.getValue()}},{key:"getOpacity",value:function(){return this.opacitySlider.getValue()}},{key:"getLineWidth",value:function(){return this.lineWidthSlider.getValue()}},{key:"getIsOutwards",value:function(){return this.outwardsToggle.getValue()}},{key:"getIsFixed",value:function(){return this.fixedToggle.getValue()}},{key:"getIsSnap",value:function(){return this.snapToggle.getValue()}},{key:"getDoLockAlpha",value:function(){return this.lockAlphaToggle.getValue()}}]),e}()}),s("76Qvv",function(t,i){e(t.exports,"newImageDialog",function(){return u});var n=o("eWjiX"),r=o("eEL9N"),s=o("43qNf"),a=o("2MaaK"),l=o("1mH1z"),h=o("cNr8p"),c=o("7jh4K");function u(e){var t=e.currentColor,i=e.secondaryColor,o=e.maxCanvasSize,u=e.canvasWidth,p=e.canvasHeight,d=e.workspaceWidth,g=e.workspaceHeight,f=e.onConfirm,v=e.onCancel;function m(e,t,i,r,s){return n.BB.fitInto(e,t,Math.min(o,i-s),Math.min(o,r-s),1)}var y=n.BB.el(),x=n.BB.el({tagName:"input",custom:{name:"image-width"}}),b={color:"#888",fontSize:"12px",marginLeft:"5px"},w=n.BB.el({textContent:(0,l.LANG)("new-px"),css:b}),B=n.BB.el({tagName:"input",custom:{name:"image-height"}}),k=n.BB.el({textContent:(0,l.LANG)("new-px"),css:b});x.setAttribute("data-ignore-focus","true"),B.setAttribute("data-ignore-focus","true"),x.type="number",x.min="1",x.max=""+o,(0,c.css)(x,{width:"70px"}),B.type="number",B.min="1",B.max=""+o,B.style.width="70px",x.value=""+u,B.value=""+p,x.onclick=function(){x.focus(),z()},B.onclick=function(){B.focus(),z()};var S=(0,h.table)([[(0,l.LANG)("width")+":&nbsp;",x,w],[n.BB.el({css:{height:"5px"}}),"",""],[(0,l.LANG)("height")+":&nbsp;",B,k]]);(0,c.css)(S,{marginBottom:"10px"});var C=n.BB.el({css:{marginTop:"5px",color:"#888"}}),E=n.BB.el({css:{display:"flex",flexWrap:"wrap",gap:"5px",marginBottom:"10px"}}),L={tagName:"button",css:{flexGrow:"1"}},I=n.BB.el(L),T=n.BB.el(L),A=n.BB.el(L),M=n.BB.el(L),R=n.BB.el(L),_=n.BB.el(L);T.textContent=(0,l.LANG)("new-current"),I.textContent=(0,l.LANG)("new-fit"),_.textContent=(0,l.LANG)("new-oversize"),M.textContent=(0,l.LANG)("new-landscape"),R.textContent=(0,l.LANG)("new-portrait"),A.textContent=(0,l.LANG)("new-square"),E.append(T,I,_,A,M,R),T.onclick=function(){x.value=""+u,B.value=""+p,z()},I.onclick=function(){x.value=""+d,B.value=""+g,z()},_.onclick=function(){x.value=""+(d+500),B.value=""+(g+500),z()},A.onclick=function(){var e=m(1,1,d,g,0);x.value=""+Math.round(e.width),B.value=""+Math.round(e.height),z()},M.onclick=function(){var e=m(4,3,d,g,0);x.value=""+Math.round(e.width),B.value=""+Math.round(e.height),z()},R.onclick=function(){var e=m(3,4,d,g,0);x.value=""+Math.round(e.width),B.value=""+Math.round(e.height),z()};var P=new(0,r.Select)({isFocusable:!0,optionArr:[["screen",(0,l.LANG)("new-screen")],["16 9",(0,l.LANG)("new-video")+" 16:9"],["3 2","3:2"],["5 3","5:3"],["2 1","2:1"],["paper",(0,l.LANG)("new-din-paper")+" √2:1"],["9 16","9:16"],["2 3","2:3"],["3 5","3:5"],["1 2","1:2"],["1 1.4142135623730951","1:√2"]],onChange:function(e){if("screen"===e)x.value=""+window.screen.width,B.value=""+window.screen.height;else if("paper"===e){var t=m(Math.sqrt(2),1,d,g,0);x.value=""+Math.round(t.width),B.value=""+Math.round(t.height)}else{var i=e.split(" "),n=m(parseFloat(i[0]),parseFloat(i[1]),d,g,0);x.value=""+Math.round(n.width),B.value=""+Math.round(n.height)}z(),P.setValue(void 0)},name:"image-format"});setTimeout(function(){P.setValue(void 0)},0),(0,c.css)(P.getElement(),{width:"80px",flexGrow:"1"}),E.append(P.getElement());var D={r:255,g:255,b:255,a:1},N=[{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1},{r:0,g:0,b:0,a:0},{r:t.r,g:t.g,b:t.b,a:1},{r:i.r,g:i.g,b:i.b,a:1}],O=new(0,s.ColorOptions)({colorArr:N,initialIndex:0,onChange:function(e){D=e,H.style.backgroundColor="rgba("+e.r+","+e.g+","+e.b+", "+e.a+")"}}),G=n.BB.el({className:"kl-transparent-preview",css:{boxSizing:"border-box",width:"340px",height:"140px",display:"table",padding:"10px",marginTop:"10px",marginLeft:"-20px",background:"var(--kl-checkerboard-background)"}}),H=n.BB.el({className:"kl-transparent-preview__canvas",css:{width:"200px",height:"100px",backgroundColor:"rgba("+D.r+","+D.g+","+D.b+", "+D.a+")",marginLeft:"auto",marginRight:"auto",color:"#aaa",fontSize:"16px",fontWeight:"bold",textAlign:"center",verticalAlign:"center",display:"table",overflow:"hidden"}});function z(){x.value=""+Math.min(o,parseInt(x.value)),B.value=""+Math.min(o,parseInt(B.value));var e=parseInt(x.value),t=parseInt(B.value);(e<1||e>o||t<1||t>o)&&(e>o?e=o:t>o&&(t=o),x.value=""+e,B.value=""+t);for(var i=[[1,2],[2,1],[2,3],[3,2],[3,4],[4,3],[4,5],[5,4],[16,9],[9,16],[3,2],[2,3],[5,3],[3,5],[2,1],[1,2],[1.414,1],[1,1.414]],r=n.BB.reduce(e,t),s=i[0],a=Math.abs(i[0][0]/i[0][1]-r[0]/r[1]),h=0;h<i.length;h++)Math.abs(i[h][0]/i[h][1]-r[0]/r[1])<a&&(s=i[h],a=Math.abs(i[h][0]/i[h][1]-r[0]/r[1]));a>0&&a<.005?C.innerText=(0,l.LANG)("new-ratio")+": ~"+s[0]+":"+s[1]:C.innerText=(0,l.LANG)("new-ratio")+": "+r[0]+":"+r[1];var c=e,u=function(e,t){for(var i=e,n=t;;){if(!(i%=n))return n;if(!(n%=i))return i}}(e,t);e/=u,t/=u,t*=260,(e*=260)>260&&(t=260/e*t,e=260),t>100&&(e=100/t*e,t=100),H.style.width=e+"px",H.style.height=t+"px",G.style.backgroundSize=Math.round(Math.max(4,e/c*60))+"px"}n.BB.el({parent:G,content:H,css:{display:"table-cell",verticalAlign:"middle"}}),n.BB.el({parent:H,css:{display:"table-cell",verticalAlign:"middle"}}),x.onchange=function(){(""===x.value||0>parseInt(x.value))&&(x.value="1"),z()},x.onkeyup=function(){z()},B.onchange=function(){(""===B.value||0>parseFloat(B.value))&&(B.value="1"),z()},B.onkeyup=function(){z()},z(),y.append(E);var j=n.BB.el({parent:y,css:{display:"flex",justifyContent:"space-between",alignItems:"flex-end"}});n.BB.el({parent:j}).append(S,C),j.append(O.getElement()),y.append(G),(0,a.showModal)({target:document.body,message:`<b>${(0,l.LANG)("new-title")}</b>`,div:y,buttons:["Ok","Cancel"],callback:function(e){if(n.BB.unsetEventHandler(x,"onclick","onchange","onkeyup"),n.BB.unsetEventHandler(x,"onclick","onchange","onkeyup"),n.BB.unsetEventHandler(T,"onclick"),n.BB.unsetEventHandler(I,"onclick"),n.BB.unsetEventHandler(_,"onclick"),n.BB.unsetEventHandler(A,"onclick"),n.BB.unsetEventHandler(M,"onclick"),n.BB.unsetEventHandler(R,"onclick"),P.destroy(),O.destroy(),"Cancel"===e||0>=parseInt(x.value)||0>=parseInt(B.value)||isNaN(parseInt(x.value))||isNaN(parseInt(B.value)))return void v();f(parseInt(x.value),parseInt(B.value),D)},clickOnEnter:"Ok"})}}),s("cNr8p",function(t,i){e(t.exports,"table",function(){return s});var n=o("bX4ja"),r=o("eWjiX");function s(e,t){var i=r.BB.el({tagName:"table",className:"kl-table"});return e.forEach(function(e,o){var s=r.BB.el({tagName:"tr"});s.append.apply(s,(0,n._)(e.map(function(e,i){var n=r.BB.el({tagName:"td",content:e}),s=o+"."+i;return void 0!==t&&s in t&&(n.rowSpan=t[s].rowspan),n}))),i.append(s)}),i}}),s("uO7ai",function(i,n){e(i.exports,"ToolspaceCollapser",function(){return c});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("3t5jC"),h=o("1mH1z"),c=function(){"use strict";function e(i){var n=this;(0,r._)(this,e),this.stateIsOpen=!0,this.orientation="right",this.rootEl=a.BB.el({className:"kl-toolspace-toggle",css:{width:"36px",height:"36px",background:"rgba(100, 100, 100, 0.9)",color:"#fff",textAlign:"center",lineHeight:"36px",cursor:"pointer",userSelect:"none",padding:"6px",boxSizing:"border-box"},title:(0,h.LANG)("toggle-show-tools"),onClick:function(e){e.preventDefault(),n.stateIsOpen=!n.stateIsOpen,n.update(),i.onChange()}}),this.icon=a.BB.el({parent:this.rootEl,css:{backgroundImage:`url(${t(l)})`,width:"100%",height:"100%",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",userSelect:"none"}}),this.update(),this.rootEl.oncontextmenu=function(){return!1}}return(0,s._)(e,[{key:"update",value:function(){"left"===this.orientation?this.icon.style.transform=this.stateIsOpen?"rotate(180deg)":"":this.icon.style.transform=this.stateIsOpen?"":"rotate(180deg)"}},{key:"isOpen",value:function(){return this.stateIsOpen}},{key:"setIsOpen",value:function(e){this.stateIsOpen=e,this.update()}},{key:"setOrientation",value:function(e){this.orientation=e,this.update()}},{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("3t5jC",function(e,t){e.exports=i("b1UMP")}),s("dHnZA",function(t,i){e(t.exports,"textToolDialog",function(){return m});var n=o("cL71g"),r=o("4EWN2"),s=o("eWjiX"),a=o("2MaaK"),l=o("1mH1z"),h=o("2NQHg"),c=o("4aPno"),u=o("l2lnZ"),p=o("7xBn4"),d=o("MbxPB"),g=o("6Tfl8"),f=o("amum4"),v=o("e4sAN");function m(e){var t=s.BB.el({}),i=s.BB.copyObj(e.text),o=s.BB.el({className:g.viewportWrapper}),m=new(0,d.TextToolViewportUI)({text:i,klCanvas:e.klCanvas,layerIndex:e.layerIndex,onDragEnd:function(){return"text"===S.getOpenedTabId()?k.focus():0}});function y(e){i=(0,n._)({},i,e),m.setText(i)}m.render();var x=new(0,c.TextToolFontUI)((0,r._)((0,n._)({},i),{onUpdate:function(e){y(e)}})),b=s.BB.el({css:{display:"flex",gap:"10px",flexDirection:"column"}}),w=new(0,h.TextToolFillUI)({fill:i.fill,primaryColor:e.primaryColor,secondaryColor:e.secondaryColor,onUpdate:function(e){y(e)}}),B=new(0,u.TextToolStrokeUI)({stroke:i.stroke,primaryColor:e.primaryColor,secondaryColor:e.secondaryColor,onUpdate:function(e){y(e)}}),k=new(0,p.TextToolTextUI)({text:i.text,onUpdate:function(e){void 0!==e.text&&L.setIgnoreBackground(e.text.length>0),y(e)}}),S=new(0,v.TabRow)({initialId:"text",height:40,tabArr:[{id:"text",label:(0,l.LANG)("text-text"),onOpen:function(){k.getElement().style.display="",k.focus()},onClose:function(){k.getElement().style.display="none"}},{id:"font",label:(0,l.LANG)("text-font"),onOpen:function(){x.getElement().style.display="flex"},onClose:function(){x.getElement().style.display="none"}},{id:"color",label:(0,l.LANG)("text-color"),onOpen:function(){b.style.display="flex"},onClose:function(){b.style.display="none"}}]});S.getElement().classList.add(g.tab),t.append((0,f.c)("",[(0,f.c)(o,[m.getElement()]),(0,f.c)("."+g.viewportInputs,[m.getInputsElement()]),(0,f.c)(".tabrow."+g.tabWrapper,[(0,f.c)(",w-240,h-40"),S.getElement()]),(0,f.c)("."+g.inputs,[(0,f.c)(b,[w.getElement(),B.getElement()]),x.getElement(),k.getElement()])]));var C=function(){var e=o.getBoundingClientRect(),t=Math.ceil(e.width),i=Math.ceil(e.height);m.setSize(t,i)};function E(){window.scrollTo(0,0)}window.addEventListener("resize",C),setTimeout(function(){C()}),setTimeout(function(){k.focus()},100),window.addEventListener("scroll",E,{passive:!1});var L=(0,a.showModal)({target:document.body,message:`<b>${(0,l.LANG)("text-title")}</b>`,div:t,buttons:["Ok","Cancel"],ignoreBackground:e.text.text.length>0,callback:function(t){window.removeEventListener("resize",C),window.removeEventListener("scroll",E),m.destroy(),x.destroy(),w.destroy(),B.destroy(),k.destroy(),S.destroy(),"Ok"===t&&e.onConfirm((0,n._)({},m.getValues(),x.getValues(),w.getValues(),B.getValues(),k.getValues()))},style:{width:"calc(100% - 50px)",maxWidth:"1000px",minWidth:"300px",boxSizing:"border-box"},clickOnEnter:"Ok"})}}),s("2NQHg",function(t,i){e(t.exports,"TextToolFillUI",function(){return d});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("4EWN2"),l=o("43qNf"),h=o("aP0jf"),c=o("1mH1z"),u=o("amum4"),p=o("7jh4K"),d=function(){"use strict";function e(t){var i=this;(0,n._)(this,e);var r=function(){t.onUpdate(i.getValues())},o=[null,t.fill?(0,a._)((0,s._)({},t.fill.color),{a:1}):null,(0,a._)((0,s._)({},t.primaryColor),{a:1}),(0,a._)((0,s._)({},t.secondaryColor),{a:1}),{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];this.colorOptions=new(0,l.ColorOptions)({colorArr:o,initialIndex:+!!t.fill,title:(0,c.LANG)("shape-fill"),onChange:function(e){i.opacitySlider.getElement().style.display=null!==e?"":"none",r()}}),this.opacitySlider=new(0,h.KlSlider)({label:(0,c.LANG)("opacity"),width:150,height:30,min:.01,max:1,value:t.fill?t.fill.color.a:1,resolution:225,eventResMs:1e3/30,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(){return r()}}),this.opacitySlider.getElement().style.display=t.fill?"":"none";var d=(0,p.createSvg)({elementType:"svg",class:"dark-invert",width:"25px",height:"25px",viewBox:"0 0 30 30",childrenArr:[{elementType:"polyline",points:"0,0 30,0 30,8 19,8 19,30 11,30 11,8 0,8 0,0 1,0","transform-origin":"15px 15px",transform:"scale(0.8)",fill:"#000c"}]});this.rootEl=(0,u.c)(",flex,gap-10,items-center,flexWrap,minh-30",[d,this.colorOptions.getElement(),this.opacitySlider.getElement()])}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValues",value:function(){var e=this.colorOptions.getValue();return null===e||(null==e?void 0:e.a)===0?{fill:void 0}:{fill:{color:(0,a._)((0,s._)({},e),{a:this.opacitySlider.getValue()})}}}},{key:"destroy",value:function(){this.colorOptions.destroy(),this.opacitySlider.destroy()}}]),e}()}),s("4aPno",function(i,n){e(i.exports,"TextToolFontUI",function(){return E});var r=o("1LaJZ"),s=o("cx0mh"),a=o("7h4XF"),l=o("bX4ja"),h=o("2gUX3"),c=o("eWjiX"),u=o("dJPtW"),p=o("1mH1z"),d=o("4nUqS"),g=o("jBDJE"),f=o("bZiKn"),v=o("kbW9s"),m=o("7YJHi"),y=o("55sGW"),x=o("1kyaA"),b=o("eEL9N"),w=o("amum4"),B=o("gE7dS"),k=o("2MaaK"),S=[{fontFamily:"sans-serif",fontName:"Sans-serif"},{fontFamily:"serif",fontName:"Serif"},{fontFamily:"monospace",fontName:"Monospace"},{fontFamily:"cursive",fontName:"Cursive"},{fontFamily:"fantasy",fontName:"Fantasy"}].concat((0,l._)(B.FONTS.map(function(e){return{fontFamily:e.name,fontName:e.name}}))),C=!1,E=function(){"use strict";function e(i){var n,r,o=this;(0,s._)(this,e),this.onUpdate=i.onUpdate,this.fontSelect=new(0,b.Select)({initValue:i.font,optionArr:S.map(function(e){return[e.fontFamily,e.fontName,{css:{fontFamily:e.fontFamily,fontSize:"1.2em"}}]}),isFocusable:!0,css:{width:"180px"},onChange:function(e){o.loadBundledFonts(),i.onUpdate({font:e})},name:"font"}),this.onFocus=function(){return o.loadBundledFonts()},this.fontSelect.getElement().addEventListener("focus",this.onFocus),this.fontPointerListener=new c.BB.PointerListener({target:this.fontSelect.getElement(),onWheel:function(e){return o.fontSelect.setDeltaValue(e.deltaY)}}),this.importButton=c.BB.el({tagName:"button",content:(0,p.LANG)("file-import"),onClick:function(){o.importFont()}});var a=c.BB.el({content:[c.BB.el({tagName:"span",content:"A",css:{fontSize:"0.6em"}}),"A"],css:{width:"25px",height:"25px",display:"flex",justifyContent:"center",alignItems:"center",fontSize:"1.2em",userSelect:"none"}});this.sizeInput=new(0,u.Input)({title:(0,p.LANG)("text-size"),type:"number",min:0,max:1e3,init:i.size,onChange:function(e){i.onUpdate({size:parseFloat(e)})},doResetIfInvalid:!0,doScrollWithoutFocus:!0,css:{width:"70px"},name:"font-size"}),this.lineHeightInput=new(0,u.Input)({label:(0,p.LANG)("text-line-height"),type:"number",min:0,max:10,step:.1,init:null!=(n=i.lineHeight)?n:1,onChange:function(e){i.onUpdate({lineHeight:parseFloat(e)})},doResetIfInvalid:!0,doScrollWithoutFocus:!0,css:{width:"60px"},name:"line-height"}),this.letterSpacingInput=new(0,u.Input)({label:(0,p.LANG)("text-letter-spacing"),type:"number",min:-100,max:100,init:null!=(r=i.letterSpacing)?r:0,onChange:function(e){i.onUpdate({letterSpacing:parseFloat(e)})},doResetIfInvalid:!0,doScrollWithoutFocus:!0,css:{width:"60px"},name:"letter-spacing"}),this.alignRadioList=new(0,d.ImageRadioList)({optionArr:[{id:"left",title:(0,p.LANG)("text-left"),image:t(g),darkInvert:!0},{id:"center",title:(0,p.LANG)("text-center"),image:t(f),darkInvert:!0},{id:"right",title:(0,p.LANG)("text-right"),image:t(v),darkInvert:!0}],initId:i.align,onChange:function(e){return i.onUpdate({align:e})}}),this.italicToggle=new(0,x.ImageToggle)({image:t(m),title:(0,p.LANG)("text-italic"),initValue:i.isItalic,onChange:function(e){return i.onUpdate({isItalic:e})},darkInvert:!0}),this.boldToggle=new(0,x.ImageToggle)({image:t(y),title:(0,p.LANG)("text-bold"),initValue:i.isBold,onChange:function(e){return i.onUpdate({isBold:e})},darkInvert:!0}),this.rootEl=(0,w.c)(",flex,flexWrap,gap-10-15,items-center",[(0,w.c)(",flex,gap-5,items-center",[a,this.sizeInput.getElement()]),(0,w.c)(",flex,gap-5",[this.fontSelect.getElement(),this.importButton]),(0,w.c)(",flex,gap-7",[this.alignRadioList.getElement(),this.italicToggle.getElement(),this.boldToggle.getElement()]),this.letterSpacingInput.getElement(),this.lineHeightInput.getElement()])}return(0,a._)(e,[{key:"loadBundledFonts",value:function(){var e=this;C||(0,r._)(function(){return(0,h.__generator)(this,function(e){switch(e.label){case 0:if(C)return[2];return C=!0,[4,Promise.all(B.FONTS.map(function(e){return(0,r._)(function(){var t,i;return(0,h.__generator)(this,function(n){switch(n.label){case 0:return[4,fetch(e.url)];case 1:return[4,n.sent().arrayBuffer()];case 2:return t=n.sent(),i=new FontFace(e.name,t),document.fonts.add(i),[2]}})})()}))];case 1:return e.sent(),[2]}})})().then(function(){e.onUpdate({font:e.fontSelect.getValue()})})}},{key:"importFont",value:function(){var e=this,t=["ttf","otf","woff","woff2","eot"],i=document.createElement("input");i.type="file",i.multiple=!0,i.accept=t.map(function(e){return"."+e}).join(", "),i.focus(),i.click(),i.onchange=function(){return(0,r._)(function(){var e,n,r,o,s,a,l,u,d,g,f,v;return(0,h.__generator)(this,function(h){switch(h.label){case 0:if(e=this,!i.files||0===i.files.length)return[2];n=void 0,r=[],o=!1,s=S.map(function(e){return e.fontFamily}),a=0,h.label=1;case 1:if(!(a<i.files.length))return[3,7];if(l=i.files[a],u="kl-"+S.length,s.includes(u))return[3,6];return n||(n=u,this.importButton.disabled=!0,this.importButton.innerText=(0,p.LANG)("loading")),(d=l.name.split(".")).pop(),S.push({fontFamily:u,fontName:d.join(".")}),f=FontFace.bind,v=[void 0,u],[4,l.arrayBuffer()];case 2:g=new(f.apply(FontFace,v.concat([h.sent()]))),h.label=3;case 3:return h.trys.push([3,5,,6]),[4,g.load()];case 4:return h.sent(),document.fonts.add(g),o=!0,[3,6];case 5:return h.sent(),r.push(l.name),[3,6];case 6:return a++,[3,1];case 7:if(r.length>0&&(0,k.showModal)({target:document.body,message:c.BB.el({content:[(0,p.LANG)("text-failed-import"),(0,w.c)("br"),r.join(", "),(0,w.c)("br"),(0,w.c)("br"),(0,p.LANG)("text-supported-formats"),(0,w.c)("br"),t.join(", ")]}),type:"error"}),!o)return this.importButton.disabled=!1,this.importButton.innerText=(0,p.LANG)("file-import"),[2];return setTimeout(function(){e.fontSelect.setOptionArr(S.map(function(e){return[e.fontFamily,e.fontName,{css:{fontFamily:e.fontFamily,fontSize:"1.2em"}}]})),e.fontSelect.setValue(n),e.onUpdate({font:n}),e.importButton.disabled=!1,e.importButton.innerText=(0,p.LANG)("file-import")}),[2]}})}).call(e)}}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValues",value:function(){return{font:this.fontSelect.getValue(),size:+this.sizeInput.getValue(),letterSpacing:+this.letterSpacingInput.getValue(),lineHeight:+this.lineHeightInput.getValue(),align:this.alignRadioList.getValue(),isItalic:this.italicToggle.getValue(),isBold:this.boldToggle.getValue()}}},{key:"destroy",value:function(){this.fontPointerListener.destroy(),this.fontSelect.getElement().removeEventListener("focus",this.onFocus),this.fontSelect.destroy(),c.BB.destroyEl(this.importButton),this.sizeInput.destroy(),this.lineHeightInput.destroy(),this.letterSpacingInput.destroy(),this.alignRadioList.destroy(),this.italicToggle.destroy(),this.boldToggle.destroy()}}]),e}()}),s("jBDJE",function(e,t){e.exports=i("lvwQ5")}),s("bZiKn",function(e,t){e.exports=i("imAvm")}),s("kbW9s",function(e,t){e.exports=i("dC0sF")}),s("7YJHi",function(e,t){e.exports=i("h3hPo")}),s("55sGW",function(e,t){e.exports=i("1pAeY")}),s("gE7dS",function(i,n){e(i.exports,"FONTS",function(){return w});var r=o("ch0Mn"),s=o("jNATf"),a=o("huLy8"),l=o("2iwhr"),h=o("lINwV"),c=o("jS4Pk"),u=o("8EsI7"),p=o("kq5Ij"),d=o("4XS6F"),g=o("jAmxY"),f=o("bakyS"),v=o("kae9I"),m=o("eZP0P"),y=o("4KeL8"),x=o("j3uqT"),b=o("9TCEV"),w=[{name:"Caveat",url:t(r)},{name:"ClimateCrisis",url:t(s)},{name:"CorrectionBrush",url:t(a)},{name:"DancingScript",url:t(l)},{name:"Diabolik",url:t(h)},{name:"FreckleFace",url:t(c)},{name:"Gloock",url:t(u)},{name:"GochiHand",url:t(d)},{name:"Pacha",url:t(p)},{name:"PassionOne",url:t(g)},{name:"PixeloidSans",url:t(f)},{name:"PlaypenSans",url:t(v)},{name:"Quicksand",url:t(m)},{name:"Silkscreen",url:t(y)},{name:"Tehroc",url:t(x)},{name:"YUNGA",url:t(b)}]}),s("ch0Mn",function(e,t){e.exports=i("hapKl")}),s("jNATf",function(e,t){e.exports=i("dqzux")}),s("huLy8",function(e,t){e.exports=i("l7VGL")}),s("2iwhr",function(e,t){e.exports=i("dm0T7")}),s("lINwV",function(e,t){e.exports=i("2U3dq")}),s("jS4Pk",function(e,t){e.exports=i("axzlU")}),s("8EsI7",function(e,t){e.exports=i("avgh6")}),s("kq5Ij",function(e,t){e.exports=i("H9bSu")}),s("4XS6F",function(e,t){e.exports=i("emBfm")}),s("jAmxY",function(e,t){e.exports=i("kjRvm")}),s("bakyS",function(e,t){e.exports=i("c79R0")}),s("kae9I",function(e,t){e.exports=i("fndWQ")}),s("eZP0P",function(e,t){e.exports=i("iAFmc")}),s("4KeL8",function(e,t){e.exports=i("2Bq6W")}),s("j3uqT",function(e,t){e.exports=i("hmfbp")}),s("9TCEV",function(e,t){e.exports=i("iItsG")}),s("l2lnZ",function(t,i){e(t.exports,"TextToolStrokeUI",function(){return g});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("4EWN2"),l=o("eWjiX"),h=o("43qNf"),c=o("aP0jf"),u=o("1mH1z"),p=o("amum4"),d=o("7jh4K"),g=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.rootEl=l.BB.el({css:{boxShadow:"0 0 0 1px #aaa"}});var r=function(){t.onUpdate(i.getValues())},o=[null,t.stroke?(0,a._)((0,s._)({},t.stroke.color),{a:1}):null,(0,a._)((0,s._)({},t.secondaryColor),{a:1}),(0,a._)((0,s._)({},t.primaryColor),{a:1}),{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1}];this.colorOptions=new(0,h.ColorOptions)({colorArr:o,initialIndex:+!!t.stroke,title:(0,u.LANG)("shape-stroke"),onChange:function(e){i.opacitySlider.getElement().style.display=null!==e?"":"none",i.lineWidthSlider.getElement().style.display=null!==e?"":"none",r()}}),this.opacitySlider=new(0,c.KlSlider)({label:(0,u.LANG)("opacity"),width:150,height:30,min:.01,max:1,value:t.stroke?t.stroke.color.a:1,resolution:225,eventResMs:1e3/30,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(){return r()}}),this.lineWidthSlider=new(0,c.KlSlider)({label:(0,u.LANG)("shape-line-width"),width:150,height:30,min:.5,max:100,value:t.stroke?t.stroke.lineWidth:2,eventResMs:1e3/30,curve:"quadratic",onChange:function(){return r()}}),this.opacitySlider.getElement().style.display=t.stroke?"":"none",this.lineWidthSlider.getElement().style.display=t.stroke?"":"none";var g=(0,d.createSvg)({elementType:"svg",class:"dark-invert",width:"25px",height:"25px",viewBox:"0 0 30 30",childrenArr:[{elementType:"polyline",points:"0,0 30,0 30,8 19,8 19,30 11,30 11,8 0,8 0,0 1,0",fill:"none",stroke:"#000c","stroke-width":"3","transform-origin":"15px 15px",transform:"scale(0.8)"}]});this.rootEl=(0,p.c)(",flex,gap-10,items-center,flexWrap,minh-30",[g,this.colorOptions.getElement(),this.opacitySlider.getElement(),this.lineWidthSlider.getElement()])}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValues",value:function(){var e=this.colorOptions.getValue();return null===e||(null==e?void 0:e.a)===0?{stroke:void 0}:{stroke:{color:(0,a._)((0,s._)({},e),{a:this.opacitySlider.getValue()}),lineWidth:this.lineWidthSlider.getValue()}}}},{key:"destroy",value:function(){this.colorOptions.destroy(),this.opacitySlider.destroy(),this.lineWidthSlider.destroy()}}]),e}()}),s("7xBn4",function(t,i){e(t.exports,"TextToolTextUI",function(){return h});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("1mH1z"),l=o("amum4"),h=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.onInput=function(){i.emit()},this.lastEmittedText=t.text,this.onUpdate=t.onUpdate,this.rootEl=(0,l.c)(""),this.textInput=s.BB.el({tagName:"textarea",parent:this.rootEl,content:t.text,custom:{placeholder:(0,a.LANG)("text-placeholder")},css:{whiteSpace:"pre",overflow:"auto",width:"100%",height:"70px",resize:"vertical"},onChange:function(){i.emit()}}),this.textInput.addEventListener("input",this.onInput)}return(0,r._)(e,[{key:"emit",value:function(){var e=this.textInput.value;e!==this.lastEmittedText&&(this.lastEmittedText=e,this.onUpdate({text:e}))}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValues",value:function(){return{text:this.textInput.value}}},{key:"focus",value:function(){this.textInput.focus()}},{key:"destroy",value:function(){s.BB.destroyEl(this.textInput),this.textInput.removeEventListener("input",this.onInput)}}]),e}()}),s("MbxPB",function(i,n){e(i.exports,"TextToolViewportUI",function(){return x});var r=o("cx0mh"),s=o("7h4XF"),a=o("cL71g"),l=o("4EWN2"),h=o("eWjiX"),c=o("7jh4K"),u=o("1C8RU"),p=o("h20yl"),d=o("aP0jf"),g=o("1mH1z"),f=o("hdxwe"),v=o("jF2Bh"),m=o("amum4"),y=o("9b3eo"),x=function(){"use strict";function e(i){var n=this;(0,r._)(this,e),this.offset={x:0,y:0},this.zoomFac=0,this.scale=1,this.layerArr=[],this.onDarkChange=function(){n.checkerPattern=(0,c.throwIfNull)(n.previewCtx.createPattern(h.BB.createCheckerCanvas(8,u.THEME.isDark()),"repeat")),n.render()},this.rootEl=(0,m.c)(),this.text=i.text,this.layerIndex=i.layerIndex;var o=i.klCanvas.getSelection();this.selectionPath=o?new Path2D((0,y.getSelectionPath2d)(o)):void 0;var s=window.innerWidth<550,a=window.innerHeight<630;this.width=s?340:540,this.height=s?a?210:260:a?230:350,this.layerArr=i.klCanvas.getLayersFast(),this.textCanvas=h.BB.canvas(i.klCanvas.getWidth(),i.klCanvas.getHeight()),this.textCtx=h.BB.ctx(this.textCanvas),this.targetCanvas=h.BB.canvas(this.width,this.height),this.targetCtx=h.BB.ctx(this.targetCanvas),this.layersCanvas=h.BB.canvas(this.width,this.height),this.layersCtx=h.BB.ctx(this.layersCanvas),this.previewCanvas=h.BB.canvas(this.width,this.height),this.previewCtx=h.BB.ctx(this.previewCanvas),(0,c.css)(this.previewCanvas,{display:"block"}),this.previewWrapper=h.BB.el({parent:this.rootEl,css:{position:"relative",width:this.width+"px",cursor:"move",touchAction:"none"}}),h.BB.el({parent:this.previewWrapper,className:"kl-text-preview-wrapper"}),this.previewWrapper.append(this.previewCanvas),this.checkerPattern=(0,c.throwIfNull)(this.previewCtx.createPattern(h.BB.createCheckerCanvas(8,u.THEME.isDark()),"repeat")),this.emptyCanvas=h.BB.canvas(1,1),this.emptyCanvasLight=h.BB.canvas(1,1);var l=h.BB.ctx(this.emptyCanvas);l.fillRect(0,0,1,1),(l=h.BB.ctx(this.emptyCanvasLight)).fillStyle="#fff",l.fillRect(0,0,1,1),u.THEME.addIsDarkListener(this.onDarkChange),this.previewCanvas.oncontextmenu=function(e){return e.preventDefault()};var p=!1,x=!1,b=!1;this.previewPointerListener=new h.BB.PointerListener({target:this.previewCanvas,onPointer:function(e){if("pointerdown"===e.type&&(p=!1,x=!0),"pointermove"===e.type&&x&&(p=!0),"pointerup"===e.type&&(x&&p&&"mouse"===e.pointerType&&i.onDragEnd(),p=!1,x=!1),"pointermove"===e.type&&"left"===e.button&&(e.eventPreventDefault(),n.offset={x:0,y:0},n.move(-e.dX,-e.dY)),"pointerdown"===e.type&&"right"===e.button&&document.body.append(n.eventCapture),"pointerup"===e.type&&setTimeout(function(){return n.eventCapture.remove()},20),"pointermove"===e.type&&"right"===e.button&&(b=!0,e.eventPreventDefault(),n.offset.x-=e.dX,n.offset.y-=e.dY,n.render()),"pointerup"===e.type&&b){var t=0;n.interval=setInterval(function(){t>8&&(clearInterval(n.interval),n.offset={x:0,y:0},n.render()),n.offset={x:.6*n.offset.x,y:.6*n.offset.y},n.render(),t++},10),n.offset={x:.6*n.offset.x,y:.6*n.offset.y},n.render()}},onWheel:function(e){n.changeZoomFac(-e.deltaY)}}),this.previewCanvas.addEventListener("wheel",function(e){return e.preventDefault()},{passive:!1}),this.rotationSlider=new(0,d.KlSlider)({label:(0,g.LANG)("filter-transform-rotation"),width:150,height:30,min:-Math.PI,max:Math.PI,value:i.text.angleRad,resolution:225,toValue:function(e){return e*Math.PI/180},toDisplayValue:function(e){return e/Math.PI*180},onChange:function(){n.offset={x:0,y:0},n.render()},unit:"°"}),this.zoomInBtn=h.BB.el({tagName:"button",content:`<img height="20" src="${t(f)}">`,title:(0,g.LANG)("zoom-in"),onClick:function(){return n.changeZoomFac(1)},css:{fontWeight:"bold"}}),this.zoomOutBtn=h.BB.el({tagName:"button",content:`<img height="20" src="${t(v)}">`,title:(0,g.LANG)("zoom-out"),onClick:function(){return n.changeZoomFac(-1)},css:{fontWeight:"bold"}}),this.eventCapture=h.BB.el({css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",zIndex:"999",cursor:"move"}}),this.eventCapture.oncontextmenu=function(e){return e.preventDefault()},this.keyListener=new h.BB.KeyListener({onDown:function(e){if(!h.BB.isInputFocused(!0)){var t=n.keyListener.isPressed("shift")?4:1;"left"===e&&n.move(-t,0),"right"===e&&n.move(t,0),"up"===e&&n.move(0,-t),"down"===e&&n.move(0,t)}}}),this.inputsRootEl=(0,m.c)(",flex,gap-5",[this.rotationSlider.getElement(),(0,m.c)(),this.zoomInBtn,this.zoomOutBtn])}return(0,s._)(e,[{key:"canZoom",value:function(e){return this.zoomFac!==Math.min(2,Math.max(-2,this.zoomFac+e))}},{key:"changeZoomFac",value:function(e){this.zoomFac=Math.min(2,Math.max(-2,this.zoomFac+e)),this.render(),this.zoomInBtn.disabled=!this.canZoom(1),this.zoomOutBtn.disabled=!this.canZoom(-1)}},{key:"move",value:function(e,t){var i=h.BB.rotate(e,t,-this.rotationSlider.getValue()/Math.PI*180);this.text.x+=i.x/this.scale,this.text.y+=i.y/this.scale,this.render()}},{key:"render",value:function(){var e=this.rotationSlider.getValue();this.textCtx.clearRect(0,0,this.textCanvas.width,this.textCanvas.height);var t=(0,p.renderText)(this.textCanvas,(0,l._)((0,a._)({},this.text),{x:this.text.x,y:this.text.y,angleRad:this.rotationSlider.getValue()}),this.selectionPath);this.selectionPath&&(this.textCtx.save(),this.textCtx.setLineDash([4]),this.textCtx.strokeStyle="#000",this.textCtx.stroke(this.selectionPath),this.textCtx.lineDashOffset=4,this.textCtx.strokeStyle="#fff",this.textCtx.stroke(this.selectionPath),this.textCtx.restore());var i=h.BB.Vec2.mul(h.BB.rotate(this.offset.x,this.offset.y,-e/Math.PI*180),1/this.scale);t.x-=3,t.y-=3,t.width+=6,t.height+=6;var n=h.BB.rotate(t.x,t.y,-e/Math.PI*180),r=h.BB.rotate(t.width,t.height,-e/Math.PI*180),o=this.text.x+n.x+r.x/2+i.x,s=this.text.y+n.y+r.y/2+i.y,c=h.BB.fitInto(t.width,t.height,this.width-100,this.height-100);this.scale=Math.min(1,c.width/t.width),this.scale=Math.min(4,this.scale*Math.pow(2,this.zoomFac)),this.targetCtx.save(),this.scale>=4?this.targetCtx.imageSmoothingEnabled=!1:(this.targetCtx.imageSmoothingEnabled=!0,this.targetCtx.imageSmoothingQuality=this.scale>=1?"low":"medium"),this.targetCtx.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height),this.targetCtx.translate(this.width/2,this.height/2),this.targetCtx.scale(this.scale,this.scale),this.targetCtx.rotate(e),this.targetCtx.drawImage(this.layerArr[this.layerIndex].canvas,-o,-s),this.targetCtx.drawImage(this.textCanvas,-o,-s),this.targetCtx.restore();var d=u.THEME.isDark();this.layersCtx.save(),this.layersCtx.fillStyle=d?"rgb(33,33,33)":"rgb(158,158,158)",this.layersCtx.fillRect(0,0,this.width,this.height),this.layersCtx.save(),this.layersCtx.translate(this.width/2,this.height/2),this.layersCtx.scale(this.scale,this.scale),this.layersCtx.rotate(e),this.layersCtx.imageSmoothingEnabled=!1;var g=1/this.scale;this.layersCtx.globalAlpha=d?.25:.2,this.layersCtx.drawImage(d?this.emptyCanvasLight:this.emptyCanvas,-o-g,-s-g,this.textCanvas.width+2*g,this.textCanvas.height+2*g),this.layersCtx.globalAlpha=1,this.layersCtx.globalCompositeOperation="destination-out",this.layersCtx.drawImage(this.emptyCanvas,-o,-s,this.textCanvas.width,this.textCanvas.height),this.layersCtx.restore(),this.scale>=4?this.layersCtx.imageSmoothingEnabled=!1:(this.layersCtx.imageSmoothingEnabled=!0,this.layersCtx.imageSmoothingQuality=this.scale>=1?"low":"medium"),this.layersCtx.save(),this.layersCtx.translate(this.width/2,this.height/2),this.layersCtx.scale(this.scale,this.scale),this.layersCtx.rotate(e);for(var f=0;f<this.layerIndex;f++)this.layerArr[f].isVisible&&this.layerArr[f].opacity>0&&(this.layersCtx.globalAlpha=this.layerArr[f].opacity,this.layersCtx.globalCompositeOperation=this.layerArr[f].mixModeStr,this.layersCtx.drawImage(this.layerArr[f].canvas,-o,-s));this.layersCtx.restore(),this.layersCtx.globalAlpha=!!this.layerArr[this.layerIndex].isVisible*this.layerArr[this.layerIndex].opacity,this.layersCtx.globalCompositeOperation=this.layerArr[this.layerIndex].mixModeStr,this.layersCtx.drawImage(this.targetCanvas,0,0),this.layersCtx.save(),this.layersCtx.translate(this.width/2,this.height/2),this.layersCtx.scale(this.scale,this.scale),this.layersCtx.rotate(e);for(var v=this.layerIndex+1;v<this.layerArr.length;v++)this.layerArr[v].isVisible&&this.layerArr[v].opacity>0&&(this.layersCtx.globalAlpha=this.layerArr[v].opacity,this.layersCtx.globalCompositeOperation=this.layerArr[v].mixModeStr,this.layersCtx.drawImage(this.layerArr[v].canvas,-o,-s));this.layersCtx.restore(),this.layersCtx.restore(),this.previewCtx.save(),this.previewCtx.fillStyle=this.checkerPattern,this.previewCtx.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height),this.previewCtx.drawImage(this.layersCanvas,0,0),this.previewCtx.restore(),this.previewCtx.save(),this.previewCtx.globalCompositeOperation="difference",this.previewCtx.strokeStyle="#fff",this.previewCtx.lineWidth=.5,this.previewCtx.translate(-this.offset.x,-this.offset.y),this.previewCtx.strokeRect(Math.round(this.width/2-t.width/2*this.scale)+.5,Math.round(this.height/2-t.height/2*this.scale)+.5,Math.round(t.width*this.scale),Math.round(t.height*this.scale)),this.previewCtx.restore()}},{key:"getElement",value:function(){return this.rootEl}},{key:"getInputsElement",value:function(){return this.inputsRootEl}},{key:"getValues",value:function(){return{x:this.text.x,y:this.text.y,angleRad:this.rotationSlider.getValue()}}},{key:"setText",value:function(e){var t=this.text.x,i=this.text.y,n=this.text.angleRad;this.text=(0,l._)((0,a._)({},e),{x:t,y:i,angleRad:n}),this.render()}},{key:"setSize",value:function(e,t){e=Math.max(1,e),t=Math.max(1,t),(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.targetCanvas.width=this.width,this.targetCanvas.height=this.height,this.layersCanvas.width=this.width,this.layersCanvas.height=this.height,this.previewCanvas.width=this.width,this.previewCanvas.height=this.height,this.previewWrapper.style.width=this.width+"px",this.render())}},{key:"destroy",value:function(){h.BB.destroyEl(this.rootEl),h.BB.destroyEl(this.inputsRootEl),h.BB.destroyEl(this.previewWrapper),clearInterval(this.interval),this.rotationSlider.destroy(),h.BB.destroyEl(this.zoomInBtn),h.BB.destroyEl(this.zoomOutBtn),this.eventCapture.remove(),this.previewPointerListener.destroy(),this.keyListener.destroy(),u.THEME.removeIsDarkListener(this.onDarkChange)}}]),e}()}),s("6Tfl8",function(t,i){var n,r,o,s,a;e(t.exports,"inputs",function(){return n},function(e){return n=e}),e(t.exports,"tab",function(){return r},function(e){return r=e}),e(t.exports,"tabWrapper",function(){return o},function(e){return o=e}),e(t.exports,"viewportInputs",function(){return s},function(e){return s=e}),e(t.exports,"viewportWrapper",function(){return a},function(e){return a=e}),n="_5vlQAW_inputs",r="_5vlQAW_tab",o="_5vlQAW_tabWrapper",s="_5vlQAW_viewportInputs",a="_5vlQAW_viewportWrapper"}),s("kDGzx",function(t,i){e(t.exports,"showImportImageDialog",function(){return c});var n=o("eWjiX"),r=o("hRdOL"),s=o("7bWhB"),a=o("2MaaK"),l=o("1mH1z"),h=o("7jh4K");function c(e){var t,i,o=n.BB.el(),c=window.innerWidth<550||window.innerHeight<550,u=n.BB.el({css:{marginTop:"10px",textAlign:"center",color:"#888",lineHeight:"20px"}}),p=new(0,r.CropCopy)({width:c?340:540,height:c?300:400,canvas:e.image.canvas,enableRightClickCopy:!1,onChange:function(e,t){u&&d(e,t)}});function d(t,i){var r=n.BB.fitInto(t,i,e.maxSize,e.maxSize);r.width<t?(u.innerHTML=`<span class="kl-text-error">${t} X ${i}</span> \u{27F6} ${Math.round(r.width)} X ${Math.round(r.height)}`,u.title=(0,l.LANG)("import-too-large")):(u.innerHTML=`${t} X ${i}`,u.title="")}(0,h.css)(p.getElement(),{marginLeft:"-20px"}),p.getElement().title=(0,l.LANG)("crop-drag-to-crop"),o.append(p.getElement(),u),d(e.image.width,e.image.height);var g=!1;if("psd"===e.image.type)if(e.image.layers){if(t=new(0,s.Checkbox)({init:g,label:(0,l.LANG)("import-flatten"),callback:function(e){g=e},name:"flatten-image"}),o.append(t.getElement()),e.image.warningArr){var f=n.BB.el({className:"kl-import-note",content:(0,l.LANG)("import-psd-limited-support")}),v=e.image.warningArr;i=n.BB.el({parent:f,tagName:"a",content:"Details",css:{marginLeft:"5px"},onClick:function(){for(var e=[],t={mask:"Masks not supported. Mask was applied.",clipping:"Clipping not supported. Clipping layers were merged.",group:"Groups not supported. Layers were ungrouped.",adjustment:"Adjustment layers not supported.","layer-effect":"Layer effects not supported.","smart-object":"Smart objects not supported.","blend-mode":"Unsupported layer blend mode.","bits-per-channel":"Unsupported color depth. Only 8bit per channel supported."},i=0;i<v.length;i++)e.push("- "+t[v[i]]);alert(e.join("\n"))}}),o.append(f)}}else{var m=n.BB.el({className:"kl-import-note",content:(0,l.LANG)("import-psd-unsupported")});o.append(m)}(0,a.showModal)({target:e.target,message:`<b>${(0,l.LANG)("import-title")}</b>`,div:o,style:c?{}:{width:"540px"},buttons:[(0,l.LANG)("import-btn-as-layer"),(0,l.LANG)("import-btn-as-image"),"Cancel"],primaries:[(0,l.LANG)("import-btn-as-layer"),(0,l.LANG)("import-btn-as-image")],callback:function(r){var o=p.getCroppedCanvas(),s=p.getCropRect(),a=e.image.width!==s.width||e.image.height!==s.height;p.destroy(),n.BB.destroyEl(i),t&&t.destroy(),r===(0,l.LANG)("import-btn-as-layer")?(e.callback({type:"as-layer",image:a?o:e.image.canvas}),a||n.BB.freeCanvas(o)):r===(0,l.LANG)("import-btn-as-image")?"psd"===e.image.type?(g&&delete e.image.layers,e.callback({type:"as-image-psd",image:e.image,cropObj:s}),n.BB.freeCanvas(o)):"image"===e.image.type&&e.callback({type:"as-image",image:o}):(e.callback({type:"cancel"}),n.BB.freeCanvas(o))},autoFocus:"As Image"})}}),s("941rU",function(t,i){e(t.exports,"blendPsdToKl",function(){return p}),e(t.exports,"blendKlToPsd",function(){return d}),e(t.exports,"readPsd",function(){return g}),e(t.exports,"klPsdToKlProject",function(){return f});var n,r,s=o("eelgW"),a=o("1mH1z"),l=o("705qg"),h=o("eWjiX"),c=o("7jh4K");function u(){n||(r=Object.fromEntries(Object.entries(n={"source-over":"normal",darken:"darken",multiply:"multiply","color-burn":"color burn",lighten:"lighten",screen:"screen","color-dodge":"color dodge",overlay:"overlay","soft-light":"soft light","hard-light":"hard light",difference:"difference",exclusion:"exclusion",hue:"hue",saturation:"saturation",color:"color",luminosity:"luminosity"}).map(function(e){return e.reverse()})))}function p(e){return u(),r[e]}function d(e){return u(),n[e]}function g(e){if(!e.canvas)throw Error("psdObj.canvas undefined");var t={type:"psd",canvas:e.canvas,width:e.width,height:e.height};function i(e){t.warningArr||(t.warningArr=[]),t.warningArr.includes(e)||t.warningArr.push(e)}function n(e){var t=p(e);return t||(i("blend-mode"),t="source-over"),t}if(8!==e.bitsPerChannel&&i("bits-per-channel"),!e.children)return t.error=!0,t;var r,o=l.MAX_LAYERS;if((r=0+function e(t){var n=0;if(t.blendMode){var r=p(t.blendMode);if(r&&"source-over"!==r)return 1}if(t.children)for(var o=0;o<t.children.length;o++){var s=t.children[o];!s.clipping&&!s.adjustment&&(s.children?(i("group"),n+=e(s)):n++)}return n}(e))>o)return t.error=!0,t;function a(e,t){var i=h.BB.ctx(e),n=i.getImageData(0,0,e.width,e.height);if(0===t)for(var r=0;r<n.data.length;r+=4)n.data[r+3]=n.data[r];else for(var o=0;o<n.data.length;o+=4)n.data[o+3]=255-n.data[o];i.putImageData(n,0,0)}return t.layers=[],t.layers=function e(r){var o,l,u=[],p=!r.hidden,d=(0,c.throwIfUndefined)(r.opacity,"groupOpacity is undefined"),g=n(r.blendMode);if("source-over"!==g&&(o=(0,s.createCanvas)(t.width,t.height),l=h.BB.ctx(o)),r.mask&&(i("mask"),a(r.mask.canvas,r.mask.defaultColor)),r.children)for(var f=0;f<r.children.length;f++){var v=r.children[f];if(!v.clipping){if(v.adjustment){i("adjustment");continue}var m=(v.children||v.canvas)&&r.children[f+1]&&r.children[f+1].clipping;if(m&&i("clipping"),v.children){for(var y=e(v),x=0;x<y.length;x++){var b=y[x],w=h.BB.ctx(b.image);if(m){var B=(0,s.createCanvas)(t.width,t.height),k=h.BB.ctx(B);k.drawImage(b.image,0,0);for(var S=f+1;S<r.children.length&&r.children[S].clipping;S++){var C=r.children[S];if(0!==C.opacity&&!C.hidden){if(void 0===C.blendMode)throw Error("clippingItem.blendMode undefined");if(void 0===C.opacity)throw Error("clippingItem.opacity undefined");if(void 0===C.canvas)throw Error("clippingItem.canvas undefined");if(void 0===C.left)throw Error("clippingItem.left undefined");if(void 0===C.top)throw Error("clippingItem.top undefined");k.globalCompositeOperation=n(C.blendMode),k.globalAlpha=C.opacity,k.drawImage(C.canvas,C.left,C.top)}}w.globalCompositeOperation="source-atop",w.drawImage(B,0,0)}if(r.mask){if(w.globalCompositeOperation=0===r.mask.defaultColor?"destination-in":"destination-out",void 0===r.mask.canvas)throw Error("psdGroupObj.mask.canvas undefined");if(void 0===r.mask.left)throw Error("psdGroupObj.mask.left undefined");if(void 0===r.mask.top)throw Error("psdGroupObj.mask.top undefined");w.drawImage(r.mask.canvas,r.mask.left,r.mask.top)}if(o){if(void 0===l)throw Error("groupCtx undefined");l.globalCompositeOperation=b.mixModeStr,l.globalAlpha=b.opacity,l.drawImage(b.image,0,0)}else b.opacity=b.opacity*d,u.push(b)}continue}var E=(0,s.createCanvas)(t.width,t.height),L=h.BB.ctx(E);if(v.canvas){if(void 0===v.top)throw Error("item.top undefined");if(void 0===v.left)throw Error("item.left undefined");L.drawImage(v.canvas,v.left,v.top)}if(v.effects&&i("layer-effect"),v.mask){if(i("mask"),void 0===v.mask.canvas)throw Error("item.mask.canvas undefined");if(void 0===v.mask.defaultColor)throw Error("item.mask.defaultColor undefined");if(void 0===v.mask.left)throw Error("item.mask.left undefined");if(void 0===v.mask.top)throw Error("item.mask.top undefined");a(v.mask.canvas,v.mask.defaultColor),L.globalCompositeOperation=0===v.mask.defaultColor?"destination-in":"destination-out",L.drawImage(v.mask.canvas,v.mask.left,v.mask.top)}if(m){if(void 0===v.right)throw Error("item.right undefined");if(void 0===v.left)throw Error("item.left undefined");if(void 0===v.bottom)throw Error("item.bottom undefined");if(void 0===v.top)throw Error("item.top undefined");if(void 0===v.canvas)throw Error("item.canvas undefined");var I=(0,s.createCanvas)(v.right-v.left,v.bottom-v.top),T=h.BB.ctx(I);T.drawImage(v.canvas,0,0);for(var A=f+1;A<r.children.length&&r.children[A].clipping;A++){var M=r.children[A];if(0!==M.opacity&&!M.hidden){if(void 0===M.blendMode)throw Error("clippingItem.blendMode undefined");if(void 0===M.opacity)throw Error("clippingItem.opacity undefined");if(void 0===M.canvas)throw Error("clippingItem.canvas undefined");if(void 0===M.left)throw Error("clippingItem.left undefined");if(void 0===M.top)throw Error("clippingItem.top undefined");T.globalCompositeOperation=n(M.blendMode),T.globalAlpha=M.opacity,T.drawImage(M.canvas,M.left-v.left,M.top-v.top)}}L.globalCompositeOperation="source-atop",L.drawImage(I,v.left,v.top)}if(r.mask){if(L.globalCompositeOperation=0===r.mask.defaultColor?"destination-in":"destination-out",void 0===r.mask.canvas)throw Error("psdGroupObj.mask.canvas undefined");if(void 0===r.mask.left)throw Error("psdGroupObj.mask.left undefined");if(void 0===r.mask.top)throw Error("psdGroupObj.mask.top undefined");L.drawImage(r.mask.canvas,r.mask.left,r.mask.top)}if(void 0===v.blendMode)throw Error("item.blendMode undefined");if(void 0===v.hidden)throw Error("item.hidden  undefined");if(void 0===v.opacity)throw Error("item.opacity undefined");if(o&&l)d>0&&(l.globalCompositeOperation=n(v.blendMode),l.globalAlpha=v.hidden?0:v.opacity,l.drawImage(E,0,0));else{if(void 0===v.name)throw Error("item.name undefined");u.push({name:v.name,isVisible:!v.hidden&&p,opacity:v.opacity*d,mixModeStr:n(v.blendMode),image:E})}}}if(o){if(void 0===r.name)throw Error("psdGroupObj.name undefined");u=[{name:r.name,isVisible:p,opacity:d,mixModeStr:g,image:o}]}return u}({name:"root",opacity:1,blendMode:"normal",children:e.children}),t}function f(e){var t={projectId:(0,c.randomUuid)(),width:e.width,height:e.height,layers:[]};return e.layers?t.layers=e.layers.map(function(e){return{name:e.name,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,image:e.image}}):t.layers=[{name:(0,a.LANG)("background"),isVisible:!0,opacity:1,mixModeStr:"source-over",image:e.canvas}],t}}),s("kyVjY",function(i,n){e(i.exports,"FILTER_LIB_STATUS",function(){return S}),e(i.exports,"FILTER_LIB",function(){return C});var r=o("3ifgi"),s=o("cWGub"),a=o("65DP8"),l=o("4eHZI"),h=o("bTeaG"),c=o("7Es5s"),u=o("kNgqO"),p=o("7SY73"),d=o("6q83x"),g=o("86Orm"),f=o("kHkbx"),v=o("7Cf9u"),m=o("7wJZ6"),y=o("1tiac"),x=o("3R6AS"),b=o("aEEsj"),w=o("7gHJg"),B=o("jMOPf"),k=o("740HI"),S={isLoaded:!1},C={brightnessContrast:{lang:{name:"filter-bright-contrast-title",button:"filter-bright-contrast",description:"filter-bright-contrast-description"},icon:t(r),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},cropExtend:{lang:{name:"filter-crop-title",button:"filter-crop-extend",description:"filter-crop-description"},icon:t(s),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},curves:{lang:{name:"filter-curves-title",button:"filter-curves",description:"filter-curves-description"},icon:t(a),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},distort:{lang:{name:"filter-distort",button:"filter-distort",description:"filter-distort-description"},icon:t(k),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},flip:{lang:{name:"filter-flip-title",button:"filter-flip",description:"filter-flip-description"},icon:t(l),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},hueSaturation:{lang:{name:"filter-hue-sat-title",button:"filter-hue-sat",description:"filter-hue-sat-description"},icon:t(h),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},invert:{lang:{name:"filter-invert",button:"filter-invert"},icon:t(c),updatePos:!1,isInstant:!0,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},perspective:{lang:{name:"filter-perspective-title",button:"filter-perspective",description:"filter-perspective-description"},icon:t(u),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},resize:{lang:{name:"filter-resize-title",button:"filter-resize",description:"filter-resize-description"},icon:t(p),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},rotate:{lang:{name:"filter-rotate-title",button:"filter-rotate",description:"filter-rotate-description"},icon:t(d),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},tiltShift:{lang:{name:"filter-tilt-shift-title",button:"filter-tilt-shift",description:"filter-tilt-shift-description"},icon:t(g),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},toAlpha:{lang:{name:"filter-to-alpha-title",button:"filter-to-alpha",description:"filter-to-alpha-description"},icon:t(f),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},transform:{lang:{name:"filter-transform-title",button:"filter-transform",description:"filter-transform-description"},icon:t(v),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},blur:{lang:{name:"filter-triangle-blur-title",button:"filter-triangle-blur",description:"filter-triangle-blur-description"},icon:t(m),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},unsharpMask:{lang:{name:"filter-unsharp-mask-title",button:"filter-unsharp-mask",description:"filter-unsharp-mask-description"},icon:t(y),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},grid:{lang:{name:"filter-grid",button:"filter-grid",description:"filter-grid-description"},icon:t(x),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},noise:{lang:{name:"filter-noise",button:"filter-noise",description:"filter-noise-description"},icon:t(b),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},pattern:{lang:{name:"filter-pattern",button:"filter-pattern",description:"filter-pattern-description"},icon:t(w),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},vanishPoint:{lang:{name:"filter-vanish-point-title",button:"filter-vanish-point",description:"filter-vanish-point-description"},icon:t(B),updatePos:!1,getDialog:null,apply:null,inEmbed:!0}}}),s("3ifgi",function(e,t){e.exports=i("5tPq3")}),s("65DP8",function(e,t){e.exports=i("245NA")}),s("4eHZI",function(e,t){e.exports=i("1hkCG")}),s("bTeaG",function(e,t){e.exports=i("k2eFf")}),s("7Es5s",function(e,t){e.exports=i("krKGd")}),s("kNgqO",function(e,t){e.exports=i("ehfxY")}),s("7SY73",function(e,t){e.exports=i("beOjS")}),s("86Orm",function(e,t){e.exports=i("Gk9bV")}),s("kHkbx",function(e,t){e.exports=i("csed7")}),s("7Cf9u",function(e,t){e.exports=i("equSE")}),s("7wJZ6",function(e,t){e.exports=i("h1dN3")}),s("1tiac",function(e,t){e.exports=i("LfAXI")}),s("3R6AS",function(e,t){e.exports=i("cB6q6")}),s("aEEsj",function(e,t){e.exports=i("S9ano")}),s("7gHJg",function(e,t){e.exports=i("4eqRj")}),s("jMOPf",function(e,t){e.exports=i("8mvSV")}),s("740HI",function(e,t){e.exports=i("kbc0v")}),s("dAXbp",function(t,i){e(t.exports,"BRUSHES",function(){return u});var n=o("68QTJ"),r=o("5PSXS"),s=o("ewgr9"),a=o("kic4a"),l=o("7cUpm"),h=o("ltaBP"),c=o("6Nq1H"),u={PenBrush:n.PenBrush,BlendBrush:r.BlendBrush,SketchyBrush:s.SketchyBrush,PixelBrush:a.PixelBrush,ChemyBrush:c.ChemyBrush,SmudgeBrush:h.SmudgeBrush,EraserBrush:l.EraserBrush}}),s("68QTJ",function(t,i){e(t.exports,"PenBrush",function(){return f});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("5CF7D"),l=o("3Fob6"),h=o("4sWjZ"),c=o("69IwK"),u=o("9b3eo"),p=o("eg83P"),d=o("g03EN"),g=2*Math.PI,f=function(){"use strict";function e(){(0,n._)(this,e),this.context={},this.klHistory={},this.settingHasOpacityPressure=!1,this.settingHasScatterPressure=!1,this.settingHasSizePressure=!0,this.settingSize=2,this.settingSpacing=.8489,this.settingOpacity=1,this.settingScatter=0,this.settingColor={},this.settingColorStr="",this.settingAlphaId=0,this.settingLockLayerAlpha=!1,this.hasDrawnDot=!1,this.lineToolLastDot=0,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.inputArr=[],this.inputIsDrawing=!1,this.bezierLine=null,this.alphaCanvas128=s.BB.canvas(128,128),this.alphaCanvas64=s.BB.canvas(64,64),this.alphaCanvas32=s.BB.canvas(32,32),this.alphaOpacityArr=[1,.9,1,1],this.changedTiles=[]}return(0,r._)(e,[{key:"updateChangedTiles",value:function(e){var t=(0,p.boundsOverlap)(e,this.selectionBounds);t&&(this.changedTiles=(0,c.updateChangedTiles)(this.changedTiles,(0,c.getChangedTiles)(t,this.context.canvas.width,this.context.canvas.height)))}},{key:"updateAlphaCanvas",value:function(){if(0!==this.settingAlphaId&&3!==this.settingAlphaId)for(var e,t=[[this.alphaCanvas128,128],[this.alphaCanvas64,64],[this.alphaCanvas32,32]],i=0;i<t.length;i++)(e=s.BB.ctx(t[i][0])).save(),e.clearRect(0,0,t[i][1],t[i][1]),e.fillStyle="rgba("+this.settingColor.r+", "+this.settingColor.g+", "+this.settingColor.b+", "+this.alphaOpacityArr[this.settingAlphaId]+")",e.fillRect(0,0,t[i][1],t[i][1]),e.globalCompositeOperation="destination-in",e.imageSmoothingQuality="high",e.drawImage(a.ALPHA_IM_ARR[this.settingAlphaId],0,0,t[i][1],t[i][1]),e.restore()}},{key:"calcOpacity",value:function(e){return this.settingOpacity*(this.settingHasOpacityPressure?e*e:1)}},{key:"calcScatter",value:function(e){return this.settingScatter*this.settingSize*(this.settingHasScatterPressure?e:1)}},{key:"drawDot",value:function(e,t,i,n,r,o,s){if(!(i<=0)){if(this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),s&&s[3]===n||(this.context.globalAlpha=n),s||0!==this.settingAlphaId&&3!==this.settingAlphaId||(this.context.fillStyle=this.settingColorStr),r>0){var a=2*Math.random()*Math.PI,l=Math.sqrt(Math.random())*r;e+=Math.cos(a)*l,t+=Math.sin(a)*l}var h=0===this.settingAlphaId||2===this.settingAlphaId?i:i*Math.sqrt(2);if(this.updateChangedTiles({x1:Math.floor(e-h),y1:Math.floor(t-h),x2:Math.ceil(e+h),y2:Math.ceil(t+h)}),0===this.settingAlphaId)this.context.beginPath(),this.context.arc(e,t,i,0,g),this.context.closePath(),this.context.fill(),this.hasDrawnDot=!0;else if(3===this.settingAlphaId)void 0!==o&&(this.context.save(),this.context.translate(e,t),this.context.rotate(o/180*Math.PI),this.context.fillRect(-i,-i,2*i,2*i),this.context.restore(),this.hasDrawnDot=!0);else{this.context.save(),this.context.translate(e,t);var c=this.alphaCanvas128;i<=32&&i>16?c=this.alphaCanvas64:i<=16&&(c=this.alphaCanvas32),this.context.scale(i,i),1===this.settingAlphaId&&this.context.rotate((e+t)*53123%g),this.context.drawImage(c,-1,-1,2,2),this.context.restore(),this.hasDrawnDot=!0}}}},{key:"continueLine",value:function(e,t,i,n){var r=this;null===this.bezierLine&&(this.bezierLine=new s.BB.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,function(){}));var o=[],a=function(e){var t=s.BB.mix(r.lastInput2.pressure,n,e.t),i=r.calcOpacity(t),a=Math.max(.1,r.settingSize*(r.settingHasSizePressure?t:1)),l=r.calcScatter(t);o.push([e.x,e.y,a,i,l,e.angle])},l=i*this.settingSpacing;null===e||null===t?this.bezierLine.addFinal(l,a):this.bezierLine.add(e,t,l,a),this.context.save();for(var h=void 0,c=0;c<o.length;c++){var u=o[c];this.drawDot(u[0],u[1],u[2],u[3],u[4],u[5],h),h=u}this.context.restore()}},{key:"startLine",value:function(e,t,i){this.selection=this.klHistory.getComposed().selection.value,this.selectionPath=this.selection?(0,u.getSelectionPath2d)(this.selection):void 0,this.selectionBounds=this.selection?(0,p.integerBounds)((0,d.getMultiPolyBounds)(this.selection)):void 0,this.changedTiles=[],i=s.BB.clamp(i,0,1);var n=this.calcOpacity(i),r=this.settingHasSizePressure?Math.max(.1,i*this.settingSize):Math.max(.1,this.settingSize),o=this.calcScatter(i);this.hasDrawnDot=!1,this.inputIsDrawing=!0,this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath),this.drawDot(e,t,r,n,o),this.context.restore(),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2.pressure=i,this.inputArr=[{x:e,y:t,pressure:i}]}},{key:"goLine",value:function(e,t,i){if(this.inputIsDrawing){var n=s.BB.clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath),this.continueLine(e,t,r,this.lastInput.pressure),this.context.restore(),this.lastInput.x=e,this.lastInput.y=t,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=n,this.inputArr.push({x:e,y:t,pressure:i})}}},{key:"endLine",value:function(){var e=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);if(this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath),this.continueLine(null,null,e,this.lastInput.pressure),this.context.restore(),this.inputIsDrawing=!1,3===this.settingAlphaId&&!this.hasDrawnDot){var t=this.inputArr[0];this.inputArr.forEach(function(e){e.pressure>t.pressure&&(t=e)}),this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath);var i=s.BB.clamp(t.pressure,0,1),n=this.calcOpacity(i),r=this.calcScatter(i);this.drawDot(t.x,t.y,e,n,r,0),this.context.restore()}this.bezierLine=null,this.changedTiles.some(function(e){return e})&&this.klHistory.push((0,l.getPushableLayerChange)(this.klHistory.getComposed(),(0,h.canvasAndChangedTilesToLayerTiles)(this.context.canvas,this.changedTiles))),this.hasDrawnDot=!1,this.inputArr=[]}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.selection=this.klHistory.getComposed().selection.value,this.selectionPath=this.selection?(0,u.getSelectionPath2d)(this.selection):void 0,this.selectionBounds=this.selection?(0,p.integerBounds)((0,d.getMultiPolyBounds)(this.selection)):void 0,this.changedTiles=[],this.lastInput.x=i,this.lastInput.y=n,this.lastInput.pressure=1,!this.inputIsDrawing&&void 0!==e){var r,o=s.BB.pointsToAngleDeg({x:e,y:t},{x:i,y:n}),a=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),c=(i-e)/a,g=(n-t)/a,f=this.settingSize*this.settingSpacing;this.lineToolLastDot=this.settingSize*this.settingSpacing,this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath);var v=this.calcScatter(1);for(r=this.lineToolLastDot;r<=a;r+=f)this.drawDot(e+c*r,t+g*r,this.settingSize,this.settingOpacity,v,o);this.context.restore(),this.changedTiles.some(function(e){return e})&&this.klHistory.push((0,l.getPushableLayerChange)(this.klHistory.getComposed(),(0,h.canvasAndChangedTilesToLayerTiles)(this.context.canvas,this.changedTiles)))}}},{key:"isDrawing",value:function(){return this.inputIsDrawing}},{key:"setAlpha",value:function(e){this.settingAlphaId!==e&&(this.settingAlphaId=e,this.updateAlphaCanvas())}},{key:"setColor",value:function(e){this.settingColor!==e&&(this.settingColor={r:e.r,g:e.g,b:e.b},this.settingColorStr="rgb("+this.settingColor.r+","+this.settingColor.g+","+this.settingColor.b+")",this.updateAlphaCanvas())}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.klHistory=e}},{key:"setSize",value:function(e){this.settingSize=e}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setScatter",value:function(e){this.settingScatter=e}},{key:"setSpacing",value:function(e){this.settingSpacing=e}},{key:"sizePressure",value:function(e){this.settingHasSizePressure=e}},{key:"opacityPressure",value:function(e){this.settingHasOpacityPressure=e}},{key:"scatterPressure",value:function(e){this.settingHasScatterPressure=e}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"getSpacing",value:function(){return this.settingSpacing}},{key:"getSize",value:function(){return this.settingSize}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"getScatter",value:function(){return this.settingScatter}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}}]),e}()}),s("5CF7D",function(t,i){e(t.exports,"ALPHA_IM_ARR",function(){return r});var n=o("74D3O"),r=[];r[1]=(0,n.genBrushAlpha01)(128),r[2]=(0,n.genBrushAlpha02)(128)}),s("74D3O",function(t,i){e(t.exports,"genBrushAlpha01",function(){return s}),e(t.exports,"genBrushAlpha02",function(){return a});var n=o("eWjiX"),r=o("gZSR2");function s(e){for(var t=e/500,i=n.BB.canvas(e,e),o=n.BB.ctx(i),s=o.createImageData(e,e),a=0;a<e;a++)for(var l=0;l<e;l++){var h=(l*e+a)*4,c=t+.04*r.noise.simplex2(a/50/t,l/50/t),u=100+(r.noise.simplex2(a/50/c,l/50/c)+1)/2*100;u-=(r.noise.simplex2(a/10/t,l/10/t)+1)/2*100;var p=n.BB.dist(e/2,e/2,a,l);u*=n.BB.clamp(1-((p-e/2.5)/(e/14)+r.noise.simplex2(a/22/c,l/22/c)),0,1)*(2*n.BB.clamp(1-p/e,0,1)),s.data[h]=0,s.data[h+1]=0,s.data[h+2]=0,s.data[h+3]=n.BB.clamp(u,0,255)}return o.putImageData(s,0,0),i}function a(e){var t,i;t=2/3*(1/4),i=1/3*(1/4);for(var r={x:1/4*e,y:e-1/4*e},o={x:e-1/4*e,y:1/4*e},s=n.BB.canvas(e,e),a=n.BB.ctx(s),l=a.createImageData(e,e),h=0;h<e;h++)for(var c=0;c<e;c++){var u=(c*e+h)*4,p=function(e,t,i){var r=n.BB.Vec2.sub(i,t),o=n.BB.Vec2.sub(e,t),s=n.BB.clamp(n.BB.Vec2.dot(o,r)/n.BB.Vec2.dot(r,r),0,1);return n.BB.Vec2.len(n.BB.Vec2.sub(o,n.BB.Vec2.mul(r,s)))}({x:h,y:c},r,o);p=n.BB.clamp(255-(p-e*t)/(e*i)*255,0,255),l.data[u]=0,l.data[u+1]=0,l.data[u+2]=0,l.data[u+3]=p}return a.putImageData(l,0,0),s}}),s("gZSR2",function(t,i){e(t.exports,"noise",function(){return g});var n=o("cx0mh"),r=o("7h4XF"),s={},a=function(){"use strict";function e(t,i,r){(0,n._)(this,e),this.x=t,this.y=i,this.z=r}return(0,r._)(e,[{key:"dot2",value:function(e,t){return this.x*e+this.y*t}}]),e}(),l=[new a(1,1,0),new a(-1,1,0),new a(1,-1,0),new a(-1,-1,0),new a(1,0,1),new a(-1,0,1),new a(1,0,-1),new a(-1,0,-1),new a(0,1,1),new a(0,-1,1),new a(0,1,-1),new a(0,-1,-1)],h=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],c=Array(512),u=Array(512);s.seed=function(e){e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8);for(var t=0;t<256;t++){var i=void 0;i=1&t?h[t]^255&e:h[t]^e>>8&255,c[t]=c[t+256]=i,u[t]=u[t+256]=l[i%12]}},s.seed(0);var p=.5*(Math.sqrt(3)-1),d=(3-Math.sqrt(3))/6;s.simplex2=function(e,t){var i,n,r,o,s,a=(e+t)*p,l=Math.floor(e+a),h=Math.floor(t+a),g=(l+h)*d,f=e-l+g,v=t-h+g;f>v?(o=1,s=0):(o=0,s=1);var m=f-o+d,y=v-s+d,x=f-1+2*d,b=v-1+2*d,w=u[(l&=255)+c[h&=255]],B=u[l+o+c[h+s]],k=u[l+1+c[h+1]],S=.5-f*f-v*v;S<0?i=0:(S*=S,i=S*S*w.dot2(f,v));var C=.5-m*m-y*y;C<0?n=0:(C*=C,n=C*C*B.dot2(m,y));var E=.5-x*x-b*b;return E<0?r=0:(E*=E,r=E*E*k.dot2(x,b)),70*(i+n+r)};var g=s}),s("3Fob6",function(t,i){e(t.exports,"getPushableLayerChange",function(){return a});var n=o("8N5YG"),r=o("bX4ja"),s=o("4sWjZ");function a(e,t){var i=e.activeLayerId;return{layerMap:Object.fromEntries(Object.entries(e.layerMap).map(function(e){var o=(0,n._)(e,2),a=o[0];return(o[1],a===i)?[a,{tiles:t instanceof HTMLCanvasElement?(0,s.canvasToLayerTiles)(t):(0,r._)(t)}]:[a,{}]}))}}}),s("5PSXS",function(t,i){e(t.exports,"BlendBrush",function(){return m});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("esGm2"),l=o("eg83P"),h=o("gWfkn"),c=o("3Fob6"),u=o("9ubcA"),p=o("7jh4K"),d=o("2IBtS"),g=o("gIIqd"),f=o("g03EN"),v=o("69IwK"),m=function(){"use strict";function e(){(0,n._)(this,e),this.isTesting=!1,this.context={},this.layerId="NOT_SET",this.color={},this.size=29,this.opacity=.6,this.blending=.65,this.settingLockLayerAlpha=!1,this.settingSizePressure=!0,this.settingOpacityPressure=!1,this.blendCol={r:0,g:0,b:0,a:1},this.blendMix=.45,this.mixCol={r:0,g:0,b:0},this.localColOld={},this.isDrawing=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.klHistory={},this.cells=[],this.drawBuffer=[]}return(0,r._)(e,[{key:"updateRedrawBounds",value:function(e){var t=(0,l.boundsOverlap)(e,this.selectionBounds);t&&(this.redrawBounds=s.BB.updateBounds(this.redrawBounds,t))}},{key:"getCellsWidth",value:function(){return Math.ceil(this.context.canvas.width/h.HISTORY_TILE_SIZE)}},{key:"drawCells",value:function(e){var t=this,i=this.getCellsWidth();e.forEach(function(e,n){if(e){var r=n%i*h.HISTORY_TILE_SIZE,o=Math.floor(n/i)*h.HISTORY_TILE_SIZE;t.context.putImageData(e,r,o)}})}},{key:"drawChangedCells",value:function(){var e=this;if(this.redrawBounds){var t=this.cells.map(function(){});this.getTouchedCells(this.redrawBounds).forEach(function(i,n){i&&(t[n]=e.cells[n])}),this.drawCells(t),this.redrawBounds=void 0}}},{key:"getTouchedCells",value:function(e){var t=this.cells.map(function(){return!1}),i=this.getCellsWidth();e={x1:Math.floor(e.x1/h.HISTORY_TILE_SIZE),y1:Math.floor(e.y1/h.HISTORY_TILE_SIZE),x2:Math.floor(e.x2/h.HISTORY_TILE_SIZE),y2:Math.floor(e.y2/h.HISTORY_TILE_SIZE)};for(var n=e.x1;n<=e.x2;n++)for(var r=e.y1;r<=e.y2;r++)t[r*i+n]=!0;return t}},{key:"sliceBounds",value:function(e){var t=this,i=(0,l.boundsOverlap)(e,this.selectionBounds);if(!i)return[];var n=this.getCellsWidth(),r=[];return this.getTouchedCells(i).forEach(function(e,o){if(e){var s=o%n*h.HISTORY_TILE_SIZE,a=Math.floor(o/n)*h.HISTORY_TILE_SIZE,l=t.cells[o].width,c=t.cells[o].height,u={x1:Math.max(0,i.x1-s),y1:Math.max(0,i.y1-a),x2:Math.min(l-1,i.x2-s),y2:Math.min(c-1,i.y2-a)};u.x1>u.x2||u.y1>u.y2||r.push({index:o,bounds:u})}}),r}},{key:"copyFromCanvas",value:function(e){var t=this;if(e){var i=this.getTouchedCells(e),n=this.klHistory.getComposed().layerMap[this.layerId];i.forEach(function(e,i){if(e&&!t.cells[i]){var r=n.tiles[i];if((0,a.isLayerFill)(r)){var o=s.BB.canvas(h.HISTORY_TILE_SIZE,h.HISTORY_TILE_SIZE),l=s.BB.ctx(o);l.fillStyle=r.fill,l.fillRect(0,0,h.HISTORY_TILE_SIZE,h.HISTORY_TILE_SIZE),t.cells[i]=l.getImageData(0,0,h.HISTORY_TILE_SIZE,h.HISTORY_TILE_SIZE)}else t.cells[i]=(0,u.copyImageData)(r.data)}})}}},{key:"getAverage",value:function(e,t,i){var n=this,r=Math.max(0,Math.floor(e-(i=Math.max(.5,.75*i)))),o=Math.max(0,Math.floor(t-i)),s=Math.min(this.context.canvas.width-1,Math.ceil(e+i)),a=Math.min(this.context.canvas.height-1,Math.ceil(t+i));if(r>s||o>a)return{r:0,g:0,b:0,a:0};var l=0,c=0,u=0,p=0,d=this.sliceBounds({x1:r,y1:o,x2:s,y2:a}),g=this.getCellsWidth();return d.forEach(function(e){for(var t=e.index%g*h.HISTORY_TILE_SIZE,i=Math.floor(e.index/g)*h.HISTORY_TILE_SIZE,r=n.cells[e.index].width,o=n.cells[e.index].data,s=e.bounds,a=s.y1,d=a+i;a<=s.y2;a++,d++)for(var f=s.x1,v=f+t,m=(a*r+s.x1)*4;f<=s.x2;f++,v++,m+=4)if(!n.mask||0!==n.mask[d*n.context.canvas.width+v]){var y=o[m+3]/255;0!==y&&(l+=o[m]*y,c+=o[m+1]*y,u+=o[m+2]*y,p+=y)}}),0!==p&&(l/=p,c/=p,u/=p,p=Math.min(1,p)),{r:l,g:c,b:u,a:p}}},{key:"getDotBounds",value:function(e,t,i){var n=Math.max(0,Math.floor(e-(i=Math.max(.5,i)))),r=Math.max(0,Math.floor(t-i)),o=Math.min(this.context.canvas.width-1,Math.ceil(e+i)),s=Math.min(this.context.canvas.height-1,Math.ceil(t+i));if(!(n>o)&&!(r>s))return{x1:n,y1:r,x2:o,y2:s}}},{key:"drawDot",value:function(e){for(var t=this,i=0,n=e.size>30?1024:512,r=[],o=0;o<n;o++)r[o]=(Math.random()-.5)/1.001+.5;var a=[8,4,4,4,2,2,2,2,2,2][Math.floor(2*e.size)],c=a?a*a:0,u=[];if(a)for(var p=0,d=0;d<a;d++)for(var g=0;g<a;g++,p+=2)u[p]=(d+1)/a,u[p+1]=(g+1)/a;var f=.8*Math.pow(e.opacity,2),v=1-f,m=e.size*e.size,y=m*v/e.opacity,x=(1+f/v)*e.opacity,b=this.sliceBounds({x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2}),w=this.getCellsWidth();b.forEach(function(o){for(var a=o.index%w*h.HISTORY_TILE_SIZE,p=Math.floor(o.index/w)*h.HISTORY_TILE_SIZE,d=t.cells[o.index].width,g=t.cells[o.index].data,f=o.bounds.y1,v=f+p-e.y;f<=o.bounds.y2;f++,v++)for(var b=o.bounds.x1,B=(f+p)*t.context.canvas.width+(o.bounds.x1+a),k=(f*d+o.bounds.x1)*4,S=b+a-e.x;b<=o.bounds.x2;b++,B++,k+=4,S++)if(!t.mask||0!==t.mask[B]){var C=0;if(c){for(var E=0;E<u.length;E+=2){var L=s.BB.lenSquared(S+u[E],v+u[E+1]);L>=m||(C+=(0,l.clamp)(x-L/y,0,e.opacity))}if(!C)continue;C/=c}else{var I=Math.pow(S,2)+Math.pow(v,2);if(I>=m)continue;C=(0,l.clamp)(x-I/y,0,e.opacity)}var T=1-C,A=g[k+3]/255;if(t.settingLockLayerAlpha){var M=e.r*C+g[k]*T,R=e.g*C+g[k+1]*T,_=e.b*C+g[k+2]*T;A&&(g[k]=Math.floor(M+r[i]),g[k+1]=Math.floor(R+r[i]),g[k+2]=Math.floor(_+r[i]))}else{var P=e.r*C+g[k]*A*T,D=e.g*C+g[k+1]*A*T,N=e.b*C+g[k+2]*A*T,O=1-T*(1-A);g[k+3]=Math.floor(Math.min(255,255*O)+.5),O&&(g[k]=Math.floor(P/O+r[i]),g[k+1]=Math.floor(D/O+r[i]),g[k+2]=Math.floor(N/O+r[i]))}i=(i+1)%n}})}},{key:"calcSpacing",value:function(e){return s.BB.mix(2*e/2,2*e/9,(0,l.clamp)((e-2.7)/9.3,0,1))}},{key:"continueLine",value:function(e,t,i,n){var r,o,a,l,h=this;this.drawBuffer=[];var c=this.settingSizePressure?Math.max(1,i*this.size):Math.max(1,this.size),u=this.calcSpacing(c),p=void 0===e?this.lastInput.x:e,d=void 0===t?this.lastInput.y:t;if(0===this.blending)this.mixCol.r=this.color.r,this.mixCol.g=this.color.g,this.mixCol.b=this.color.b;else{if(n)l={r:this.localColOld.r,g:this.localColOld.g,b:this.localColOld.b,a:0};else{var g=[p,d,this.settingSizePressure?Math.max(.5,i*this.size):Math.max(.5,this.size)],f=this.getDotBounds(g[0],g[1],g[2]);f&&this.copyFromCanvas(f),l=this.getAverage(g[0],g[1],g[2])}a={r:0,g:0,b:0,a:0},l.a>0&&0===this.blendCol.a?(this.blendCol.r=l.r,this.blendCol.g=l.g,this.blendCol.b=l.b,this.blendCol.a=l.a):(0===l.a&&(l.r=this.color.r,l.g=this.color.g,l.b=this.color.b,l.a=1-this.blending),this.blendCol.r=s.BB.mix(this.blendCol.r,s.BB.mix(this.blendCol.r,l.r,this.blendMix),l.a),this.blendCol.g=s.BB.mix(this.blendCol.g,s.BB.mix(this.blendCol.g,l.g,this.blendMix),l.a),this.blendCol.b=s.BB.mix(this.blendCol.b,s.BB.mix(this.blendCol.b,l.b,this.blendMix),l.a),this.blendCol.a=Math.min(1,this.blendCol.a+l.a)),a.r=this.blendCol.r,a.g=this.blendCol.g,a.b=this.blendCol.b,a.a=this.blendCol.a}var v=function(e){if(!(h.blending>=1)||!(h.blendCol.a<=0)){var t=e.t;r=h.lastInput2.pressure*(1-t)+i*t,o=h.settingOpacityPressure?h.opacity*r*r:h.opacity,c=h.settingSizePressure?Math.max(.1,r*h.size):Math.max(.1,h.size),0!=h.blending&&(h.mixCol.r=s.BB.mix(h.localColOld.r,a.r,t),h.mixCol.g=s.BB.mix(h.localColOld.g,a.g,t),h.mixCol.b=s.BB.mix(h.localColOld.b,a.b,t)),1===h.blending&&0===h.localColOld.a&&(h.mixCol.r=a.r,h.mixCol.g=a.g,h.mixCol.b=a.b);var n=h.getDotBounds(e.x,e.y,c);n&&(h.updateRedrawBounds(n),h.drawBuffer.push({x:e.x,y:e.y,size:c,opacity:o,x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y2,r:s.BB.mix(h.color.r,h.mixCol.r,h.blending),g:s.BB.mix(h.color.g,h.mixCol.g,h.blending),b:s.BB.mix(h.color.b,h.mixCol.b,h.blending)}))}};void 0===e||void 0===t?this.bezierLine.addFinal(u,v):this.bezierLine.add(e,t,u,v),this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach(function(e){h.drawDot(e)}),this.drawBuffer=[],this.localColOld=a}},{key:"setHistory",value:function(e){this.klHistory=e}},{key:"getSize",value:function(){return this.size}},{key:"setSize",value:function(e){this.size=e}},{key:"getOpacity",value:function(){return this.opacity}},{key:"setOpacity",value:function(e){this.opacity=e}},{key:"getBlending",value:function(){return this.blending}},{key:"setBlending",value:function(e){this.blending=e}},{key:"setColor",value:function(e){this.color=s.BB.copyObj(e)}},{key:"setContext",value:function(e,t){this.context=e,this.layerId=t}},{key:"setSizePressure",value:function(e){this.settingSizePressure=e}},{key:"setOpacityPressure",value:function(e){this.settingOpacityPressure=e}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"setIsTesting",value:function(e){this.isTesting=e}},{key:"startLine",value:function(e,t,i){var n=this,r=this.klHistory.getComposed().selection.value;this.selectionBounds=r?(0,l.integerBounds)((0,f.getMultiPolyBounds)(r)):void 0,this.mask=r?(0,g.getBinaryMask)(r,this.context.canvas.width,this.context.canvas.height):void 0;var o=Math.ceil(this.context.canvas.width/h.HISTORY_TILE_SIZE)*Math.ceil(this.context.canvas.height/h.HISTORY_TILE_SIZE);this.cells=(0,p.createArray)(o,void 0),this.isDrawing=!0,i=Math.max(0,Math.min(1,i));var a=this.settingOpacityPressure?this.opacity*i*i:this.opacity,c=this.settingSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size);if(0===this.blending)this.mixCol.r=this.color.r,this.mixCol.g=this.color.g,this.mixCol.b=this.color.b;else{this.copyFromCanvas(this.getDotBounds(e,t,c));var u=this.getAverage(e,t,this.settingSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size));0===u.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:u.r,g:u.g,b:u.b,a:u.a},this.mixCol.r=this.blendCol.r,this.mixCol.g=this.blendCol.g,this.mixCol.b=this.blendCol.b}if(this.localColOld={r:this.mixCol.r,g:this.mixCol.g,b:this.mixCol.b,a:this.blendCol.a},this.redrawBounds=void 0,this.drawBuffer=[],this.blending<1||this.blendCol.a>0){var d=this.getDotBounds(e,t,c);d&&(this.updateRedrawBounds(d),this.drawBuffer.push({x:e,y:t,size:c,opacity:a,x1:d.x1,y1:d.y1,x2:d.x2,y2:d.y2,r:s.BB.mix(this.color.r,this.mixCol.r,this.blending),g:s.BB.mix(this.color.g,this.mixCol.g,this.blending),b:s.BB.mix(this.color.b,this.mixCol.b,this.blending)}))}this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach(function(e){n.drawDot(e)}),this.drawBuffer=[],this.bezierLine=new s.BB.BezierLine,this.bezierLine.add(e,t,0,function(){}),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2=s.BB.copyObj(this.lastInput),this.isTesting||this.drawChangedCells()}},{key:"goLine",value:function(e,t,i,n){this.isDrawing&&(this.continueLine(e,t,this.lastInput.pressure,n),this.lastInput2=s.BB.copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.isTesting||this.drawChangedCells())}},{key:"endLine",value:function(){if(this.bezierLine&&this.continueLine(void 0,void 0,this.lastInput.pressure,!1),this.isDrawing=!1,this.bezierLine=void 0,this.drawChangedCells(),this.cells.some(function(e){return e})){var e=this.cells;if(this.selectionBounds){var t=(0,v.getChangedTiles)(this.selectionBounds,this.context.canvas.width,this.context.canvas.height);e=e.map(function(e,i){return t[i]?e:void 0})}this.klHistory.push((0,c.getPushableLayerChange)(this.klHistory.getComposed(),e.map(function(e){return e?(0,d.createImageDataTile)(e):void 0})))}this.cells=[]}},{key:"drawLineSegment",value:function(e,t,i,n){var r=i-e,o=n-t,s=Math.ceil(Math.sqrt(r*r+o*o)/10);this.startLine(e,t,1);for(var a=1;a<=s;a++){var l=a/s,h=e+r*l,c=t+o*l;this.goLine(h,c,1,!1)}this.endLine()}}]),e}()}),s("ewgr9",function(t,i){e(t.exports,"SketchyBrush",function(){return g});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("3Fob6"),l=o("4sWjZ"),h=o("9b3eo"),c=o("eg83P"),u=o("g03EN"),p=s.BB.canvas(32,32),d=s.BB.ctx(p),g=function(){"use strict";function e(){(0,n._)(this,e),this.context={},this.settingColor={},this.settingSize=1,this.settingOpacity=.2,this.settingBlending=.5,this.settingScale=1,this.lastX=0,this.lastY=0,this.inputIsDrawing=!1,this.lastInput={x:0,y:0,pressure:0},this.klHistory={},this.sketchySeed=0,this.points=[],this.count=0,this.mixMode=[function(e){return e},function(e,t){var i=new s.BB.RGB(e.r,e.g,e.b);return i.r*=t.r/255,i.g*=t.g/255,i.b*=t.b/255,i}]}return(0,r._)(e,[{key:"rand",value:function(){return this.sketchySeed++,.5*Math.sin(6324634.2345*Math.cos(5342.3423*this.sketchySeed))+.5}},{key:"setHistory",value:function(e){this.klHistory=e}},{key:"setSeed",value:function(e){this.sketchySeed=parseInt(""+e)}},{key:"getSeed",value:function(){return parseInt(""+this.sketchySeed)}},{key:"getSize",value:function(){return this.settingSize/2}},{key:"setColor",value:function(e){this.settingColor=e}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"getBlending",value:function(){return this.settingBlending}},{key:"setBlending",value:function(e){this.settingBlending=e}},{key:"setSize",value:function(e){this.settingSize=2*e}},{key:"getScale",value:function(){return this.settingScale}},{key:"setScale",value:function(e){this.settingScale=e}},{key:"setContext",value:function(e){this.context=e}},{key:"startLine",value:function(e,t,i,n){this.selection=this.klHistory.getComposed().selection.value,this.selectionPath=this.selection?(0,h.getSelectionPath2d)(this.selection):void 0,this.selectionBounds=this.selection?(0,c.integerBounds)((0,u.getMultiPolyBounds)(this.selection)):void 0,this.changedBounds=void 0,n&&this.lastInput.x?(this.inputIsDrawing=!0,this.endLine()):(this.inputIsDrawing=!0,this.lastX=e,this.lastY=t,this.lastInput.x=e,this.lastInput.y=t)}},{key:"goLine",value:function(e,t,i,n){if(this.inputIsDrawing&&(e!==this.lastInput.x||t!==this.lastInput.y)){var r,o,a,l,h=parseInt(""+e),c=parseInt(""+t);this.points.push([h,c]);var u=this.settingColor.r,p=this.settingColor.g,d=this.settingColor.b;if(n)u=n.r,p=n.g,d=n.b;else if(0!==this.settingBlending&&h+5>=0&&c+5>=0&&h-5<this.context.canvas.width-1&&c-5<this.context.canvas.height-1){u=0,p=0,d=0;var g=Math.min(this.context.canvas.width-1,Math.max(0,h-5)),f=Math.min(this.context.canvas.height-1,Math.max(0,c-5)),v=Math.min(this.context.canvas.width-1,Math.max(0,h+5)),m=Math.min(this.context.canvas.height-1,Math.max(0,c+5));if(v-=g,m-=f,v>0&&m>0){for(var y=this.context.getImageData(g,f,v,m),x=0,b=0;b<y.data.length;b+=4)u+=y.data[b+0],p+=y.data[b+1],d+=y.data[b+2],x++;u/=x,p/=x,d/=x}var w=this.mixMode[0](new s.BB.RGB(u,p,d),this.settingColor);u=parseInt(""+s.BB.mix(this.settingColor.r,w.r,this.settingBlending)),p=parseInt(""+s.BB.mix(this.settingColor.g,w.g,this.settingBlending)),d=parseInt(""+s.BB.mix(this.settingColor.b,w.b,this.settingBlending))}for(this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath),this.context.strokeStyle="rgba("+u+", "+p+", "+d+", "+this.settingOpacity+")",this.context.lineWidth=this.settingSize,this.context.beginPath(),this.context.moveTo(this.lastX,this.lastY),this.context.lineTo(h,c),r=0;r<this.points.length;r++)(l=(o=this.points[r][0]-this.points[this.count][0])*o+(a=this.points[r][1]-this.points[this.count][1])*a)<4e3*this.settingScale*this.settingScale&&this.rand()>l/2e3/this.settingScale/this.settingScale&&(this.context.moveTo(this.points[this.count][0]+.3*o,this.points[this.count][1]+.3*a),this.context.lineTo(this.points[r][0]-.3*o,this.points[r][1]-.3*a));this.context.stroke(),this.context.restore(),this.count++,this.lastX=h,this.lastY=c,this.lastInput.x=h,this.lastInput.y=c,this.changedBounds=s.BB.updateBounds(this.changedBounds,{x1:Math.floor(h-this.settingSize/2),y1:Math.floor(c-this.settingSize/2),x2:Math.ceil(h+this.settingSize/2),y2:Math.ceil(c+this.settingSize/2)})}}},{key:"endLine",value:function(){if(this.inputIsDrawing=!1,this.count=0,this.points=[],this.changedBounds){var e=(0,c.boundsOverlap)(this.changedBounds,this.selectionBounds),t=(0,l.canvasToLayerTiles)(this.context.canvas,e);t.some(function(e){return e})&&this.klHistory.push((0,a.getPushableLayerChange)(this.klHistory.getComposed(),t))}}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.changedBounds=void 0,this.lastInput.x=i,this.lastInput.y=n,!this.inputIsDrawing&&void 0!==e){this.selection=this.klHistory.getComposed().selection.value,this.selectionPath=this.selection?(0,h.getSelectionPath2d)(this.selection):void 0,this.selectionBounds=this.selection?(0,c.integerBounds)((0,u.getMultiPolyBounds)(this.selection)):void 0,this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath),this.context.lineWidth=this.settingSize;var r={r:this.settingColor.r,g:this.settingColor.g,b:this.settingColor.b};if(e+5>=0&&t+5>=0&&e-5<this.context.canvas.width-1&&t-5<this.context.canvas.height-1){r.r=0,r.g=0,r.b=0;var o=Math.min(this.context.canvas.width-1,Math.max(0,e-5)),g=Math.min(this.context.canvas.height-1,Math.max(0,t-5)),f=Math.min(this.context.canvas.width-1,Math.max(0,e+5)),v=Math.min(this.context.canvas.height-1,Math.max(0,t+5));if(f-=o,v-=g,f>0&&v>0){var m=Math.min(p.width,f),y=Math.min(p.height,v);d.save(),d.globalCompositeOperation="copy",d.drawImage(this.context.canvas,o,g,f,v,0,0,m,y),d.restore();for(var x=d.getImageData(o,g,f,v),b=0,w=0;w<x.data.length;w+=4)r.r+=x.data[w+0],r.g+=x.data[w+1],r.b+=x.data[w+2],b++;r.r/=b,r.g/=b,r.b/=b}}var B=this.mixMode[0](new s.BB.RGB(r.r,r.g,r.b),this.settingColor);if(r.r=parseInt(""+(this.settingBlending*B.r+this.settingColor.r*(1-this.settingBlending))),r.g=parseInt(""+(this.settingBlending*B.g+this.settingColor.g*(1-this.settingBlending))),r.b=parseInt(""+(this.settingBlending*B.b+this.settingColor.b*(1-this.settingBlending))),this.context.strokeStyle="rgba("+r.r+", "+r.g+", "+r.b+", "+this.settingOpacity+")",this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(i,n),this.context.stroke(),this.context.strokeStyle="rgba("+r.r+", "+r.g+", "+r.b+", "+this.settingOpacity+")",this.context.restore(),this.changedBounds=s.BB.updateBounds(this.changedBounds,{x1:Math.floor(e-this.settingSize/2),y1:Math.floor(t-this.settingSize/2),x2:Math.ceil(e+this.settingSize/2),y2:Math.ceil(t+this.settingSize/2)}),this.changedBounds=s.BB.updateBounds(this.changedBounds,{x1:Math.floor(i-this.settingSize/2),y1:Math.floor(n-this.settingSize/2),x2:Math.ceil(i+this.settingSize/2),y2:Math.ceil(n+this.settingSize/2)}),this.changedBounds){var k=(0,c.boundsOverlap)(this.changedBounds,this.selectionBounds),S=(0,l.canvasToLayerTiles)(this.context.canvas,k);S.some(function(e){return e})&&this.klHistory.push((0,a.getPushableLayerChange)(this.klHistory.getComposed(),S))}}}},{key:"isDrawing",value:function(){return this.inputIsDrawing}}]),e}()}),s("kic4a",function(t,i){e(t.exports,"PixelBrush",function(){return f});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("fohxs"),l=o("7jh4K"),h=o("3Fob6"),c=o("69IwK"),u=o("4sWjZ"),p=o("9b3eo"),d=o("eg83P"),g=o("g03EN"),f=function(){"use strict";function e(){(0,n._)(this,e),this.klHistory={},this.context={},this.settingHasSizePressure=!0,this.settingHasOpacityPressure=!1,this.settingSize=.5,this.settingSpacing=.9,this.settingOpacity=1,this.settingColor={},this.settingColorStr="",this.settingLockLayerAlpha=!1,this.settingIsEraser=!1,this.settingUseDither=!0,this.inputIsDrawing=!1,this.lineToolLastDot=0,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.bezierLine=null,this.ditherArr=[[3,2],[1,0],[3,0],[1,2],[2,1],[0,3],[0,1],[2,3],[2,0],[0,2],[0,0],[2,2],[1,1],[3,3],[3,1],[1,3]],this.ditherPattern={},this.canvasClone={},this.ctxClone={},this.historyTiles=[],this.ditherCanvas=s.BB.canvas(4,4),this.ditherCtx=s.BB.ctx(this.ditherCanvas)}return(0,r._)(e,[{key:"updateChangedTiles",value:function(e){e={x1:Math.min(e.x1,e.x2),y1:Math.min(e.y1,e.y2),x2:Math.max(e.x1,e.x2),y2:Math.max(e.y1,e.y2)};var t=(0,d.boundsOverlap)(e,this.selectionBounds);if(t){var i=(0,c.getChangedTiles)(t,this.context.canvas.width,this.context.canvas.height);this.redrawBounds=this.redrawBounds?(0,d.updateBounds)(this.redrawBounds,t):t,this.historyTiles=(0,c.updateChangedTiles)(this.historyTiles,i)}}},{key:"initClone",value:function(){this.canvasClone=s.BB.canvas(this.context.canvas.width,this.context.canvas.height),this.ctxClone=s.BB.ctx(this.canvasClone),this.ctxClone.drawImage(this.context.canvas,0,0)}},{key:"freeClone",value:function(){s.BB.freeCanvas(this.canvasClone),this.ctxClone={}}},{key:"redrawToCanvas",value:function(){if(this.redrawBounds){var e=(0,d.boundsToRect)(this.redrawBounds,!0);this.context.save(),this.context.clearRect(e.x,e.y,e.width,e.height),this.context.drawImage(this.canvasClone,e.x,e.y,e.width,e.height,e.x,e.y,e.width,e.height),this.context.restore(),this.redrawBounds=void 0}}},{key:"updateDither",value:function(){this.ditherCtx.clearRect(0,0,4,4),this.ditherCtx.fillStyle=this.settingIsEraser?`rgb(${a.ERASE_COLOR},${a.ERASE_COLOR},${a.ERASE_COLOR})`:this.settingColorStr;for(var e=0;e<Math.max(1,Math.round(this.settingOpacity*this.ditherArr.length));e++)this.ditherCtx.fillRect(this.ditherArr[e][0],this.ditherArr[e][1],1,1);this.ditherPattern=(0,l.throwIfNull)(this.context.createPattern(this.ditherCanvas,"repeat"))}},{key:"cubicCurveOverThreshold",value:function(e,t,i,n,r){var o=s.BB.Vec2.nor({x:n.x-e.x,y:n.y-e.y}),a=s.BB.Vec2.nor({x:t.x-e.x,y:t.y-e.y}),l=s.BB.Vec2.nor({x:n.x-i.x,y:n.y-i.y});return Math.max(s.BB.Vec2.dist(o,a),s.BB.Vec2.dist(o,l))>r}},{key:"plotCubicBezierLine",value:function(e,t,i,n){var r=this.cubicCurveOverThreshold(e,t,i,n,.1);e.x=Math.floor(e.x),e.y=Math.floor(e.y),n.x=Math.floor(n.x),n.y=Math.floor(n.y);var o=s.BB.dist(e.x,e.y,n.x,n.y);if(!r||o<7){this.updateChangedTiles({x1:e.x,y1:e.y,x2:n.x,y2:n.y}),this.plotLine(e.x,e.y,n.x,n.y,!0);return}for(var a=Math.max(2,Math.round(o/4)),l=[],h=0;h<=a;h++){var c=h/a,u=Math.pow(1-c,3),p=3*c*Math.pow(1-c,2),d=3*Math.pow(c,2)*(1-c),g=Math.pow(c,3);l.push({x:u*e.x+p*t.x+d*i.x+g*n.x,y:u*e.y+p*t.y+d*i.y+g*n.y})}for(var f=0;f<a;f++)this.updateChangedTiles({x1:Math.round(l[f].x),y1:Math.round(l[f].y),x2:Math.round(l[f+1].x),y2:Math.round(l[f+1].y)}),this.plotLine(Math.round(l[f].x),Math.round(l[f].y),Math.round(l[f+1].x),Math.round(l[f+1].y),!0)}},{key:"drawDot",value:function(e,t,i,n){var r={x:Math.round(e+-i),y:Math.round(t+-i),width:Math.round(2*i),height:Math.round(2*i)};this.updateChangedTiles({x1:r.x,y1:r.y,x2:r.x+r.width,y2:r.y+r.height}),this.ctxClone.save(),this.settingIsEraser?(this.ctxClone.fillStyle=this.settingUseDither?this.ditherPattern:"#fff",this.settingLockLayerAlpha?this.ctxClone.globalCompositeOperation="source-atop":this.ctxClone.globalCompositeOperation="destination-out"):(this.ctxClone.fillStyle=this.settingUseDither?this.ditherPattern:this.settingColorStr,this.settingLockLayerAlpha&&(this.ctxClone.globalCompositeOperation="source-atop")),this.ctxClone.globalAlpha=this.settingUseDither?1:n,this.ctxClone.fillRect(r.x,r.y,r.width,r.height),this.ctxClone.restore()}},{key:"continueLine",value:function(e,t,i,n){var r=this;null===this.bezierLine&&(this.bezierLine=new s.BB.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,function(){})),this.ctxClone.save(),this.selectionPath&&this.ctxClone.clip(this.selectionPath);var o=function(e){var t=s.BB.mix(r.lastInput2.pressure,n,e.t),i=r.settingOpacity*(r.settingHasOpacityPressure?t*t:1),o=Math.max(.5,r.settingSize*(r.settingHasSizePressure?t:1));r.drawDot(e.x,e.y,o,i)},a=function(e){r.plotCubicBezierLine(e.p1,e.p2,e.p3,e.p4)};if(1===Math.round(2*this.settingSize))this.bresenheimPath=new Path2D,null===e||null===t?this.bezierLine.addFinal(4,void 0,a):this.bezierLine.add(e,t,4,void 0,a),this.settingIsEraser?(this.ctxClone.fillStyle=this.settingUseDither?this.ditherPattern:"#fff",this.settingLockLayerAlpha?this.ctxClone.globalCompositeOperation="source-atop":this.ctxClone.globalCompositeOperation="destination-out"):(this.ctxClone.fillStyle=this.settingUseDither?this.ditherPattern:this.settingColorStr,this.settingLockLayerAlpha&&(this.ctxClone.globalCompositeOperation="source-atop")),this.ctxClone.globalAlpha=this.settingUseDither?1:this.settingOpacity,this.ctxClone.fill(this.bresenheimPath),this.bresenheimPath=void 0;else{var l=i*this.settingSpacing;null===e||null===t?this.bezierLine.addFinal(l,o):this.bezierLine.add(e,t,l,o)}this.ctxClone.restore()}},{key:"plotLine",value:function(e,t,i,n,r){e=Math.floor(e),t=Math.floor(t);for(var o=Math.abs((i=Math.floor(i))-e),s=e<i?1:-1,a=-Math.abs((n=Math.floor(n))-t),l=t<n?1:-1,h=o+a;r?r=!1:null==(c=this.bresenheimPath)||c.rect(e,t,1,1),e!==i||t!==n;){var c,u=2*h;u>=a&&(h+=a,e+=s),u<=o&&(h+=o,t+=l)}}},{key:"startLine",value:function(e,t,i){this.selection=this.klHistory.getComposed().selection.value,this.selectionPath=this.selection?(0,p.getSelectionPath2d)(this.selection):void 0,this.selectionBounds=this.selection?(0,d.integerBounds)((0,g.getMultiPolyBounds)(this.selection)):void 0,this.historyTiles=[],this.redrawBounds=void 0,this.settingUseDither&&this.updateDither(),this.initClone(),i=Math.max(0,Math.min(1,i));var n=this.settingHasOpacityPressure?this.settingOpacity*i*i:this.settingOpacity,r=this.settingHasSizePressure?Math.max(.5,i*this.settingSize):Math.max(.5,this.settingSize);this.inputIsDrawing=!0,this.ctxClone.save(),this.selectionPath&&this.ctxClone.clip(this.selectionPath),this.drawDot(e,t,r,n),this.ctxClone.restore(),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2=s.BB.copyObj(this.lastInput),this.redrawToCanvas()}},{key:"goLine",value:function(e,t,i){if(this.inputIsDrawing){var n=s.BB.clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(e,t,r,this.lastInput.pressure),this.lastInput2=s.BB.copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=n,this.redrawToCanvas()}}},{key:"endLine",value:function(){this.selection=this.klHistory.getComposed().selection.value,this.selectionPath=this.selection?(0,p.getSelectionPath2d)(this.selection):void 0;var e=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(null,null,e,this.lastInput.pressure),this.inputIsDrawing=!1,this.bezierLine=null,this.redrawToCanvas(),this.historyTiles.some(function(e){return e})&&this.klHistory.push((0,h.getPushableLayerChange)(this.klHistory.getComposed(),(0,u.canvasAndChangedTilesToLayerTiles)(this.canvasClone,this.historyTiles))),this.freeClone()}},{key:"drawLineSegment",value:function(e,t,i,n){this.startLine(e,t,1),this.goLine(i,n,1),this.endLine()}},{key:"isDrawing",value:function(){return this.inputIsDrawing}},{key:"setColor",value:function(e){this.settingColor!==e&&(this.settingColor=e,this.settingColorStr="rgb("+this.settingColor.r+","+this.settingColor.g+","+this.settingColor.b+")")}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.klHistory=e}},{key:"setSize",value:function(e){this.settingSize=Math.round(2*e)/2}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setSpacing",value:function(e){this.settingSpacing=e}},{key:"sizePressure",value:function(e){this.settingHasSizePressure=e}},{key:"opacityPressure",value:function(e){this.settingHasOpacityPressure=e}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"setIsEraser",value:function(e){this.settingIsEraser=e}},{key:"setUseDither",value:function(e){this.settingUseDither=e}},{key:"getSpacing",value:function(){return this.settingSpacing}},{key:"getSize",value:function(){return this.settingSize}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}},{key:"getIsEraser",value:function(){return this.settingIsEraser}},{key:"getUseDither",value:function(){return this.settingUseDither}}]),e}()}),s("7cUpm",function(t,i){e(t.exports,"EraserBrush",function(){return g});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("fohxs"),l=o("3Fob6"),h=o("4sWjZ"),c=o("69IwK"),u=o("9b3eo"),p=o("eg83P"),d=o("g03EN"),g=function(){"use strict";function e(){(0,n._)(this,e),this.size=30,this.spacing=.4,this.opacity=1,this.useSizePressure=!0,this.useOpacityPressure=!1,this.isTransparentBG=!1,this.klHistory={},this.isBaseLayer=!1,this.layer={},this.context={},this.started=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.changedTiles=[]}return(0,r._)(e,[{key:"updateChangedTiles",value:function(e){(0,p.boundsOverlap)(e,this.selectionBounds)&&(this.changedTiles=(0,c.updateChangedTiles)(this.changedTiles,(0,c.getChangedTiles)(e,this.context.canvas.width,this.context.canvas.height)))}},{key:"drawDot",value:function(e,t,i,n){this.context.save(),this.isBaseLayer?this.isTransparentBG?this.context.globalCompositeOperation="destination-out":this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out";var r=this.context.createRadialGradient(i,i,0,i,i,i),o=Math.pow(n,2);o=Math.max(0,Math.min((i-1)/i,o));var s=Math.max(0,Math.min(1,n));r.addColorStop(o,`rgba(${a.ERASE_COLOR}, ${a.ERASE_COLOR}, ${a.ERASE_COLOR}, `+(2*s-s*s)+")"),r.addColorStop(1,`rgba(${a.ERASE_COLOR}, ${a.ERASE_COLOR}, ${a.ERASE_COLOR}, 0)`),this.context.fillStyle=r,this.context.translate(e-i,t-i),this.context.fillRect(0,0,2*i,2*i),this.context.restore(),this.updateChangedTiles({x1:Math.floor(e-i),y1:Math.floor(t-i),x2:Math.ceil(e+i),y2:Math.ceil(t+i)})}},{key:"continueLine",value:function(e,t,i){var n,r,o=this;i=Math.max(0,Math.min(1,i));var s=this.useSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size),a=Math.max(1,Math.max(.5,1-this.opacity)*s*this.spacing),l=function(e){var t=e.t;n=o.lastInput2.pressure*(1-t)+i*t,r=o.useOpacityPressure?o.opacity*n*n:o.opacity,s=o.useSizePressure?Math.max(.1,n*o.size):Math.max(.1,o.size),o.drawDot(e.x,e.y,s,r)};this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath),void 0===e||void 0===t?this.bezierLine.addFinal(a,l):this.bezierLine.add(e,t,a,l),this.context.restore()}},{key:"startLine",value:function(e,t,i){this.selection=this.klHistory.getComposed().selection.value,this.selectionPath=this.selection?(0,u.getSelectionPath2d)(this.selection):void 0,this.selectionBounds=this.selection?(0,p.integerBounds)((0,d.getMultiPolyBounds)(this.selection)):void 0,this.changedTiles=[],this.isBaseLayer=0===this.layer.index,i=Math.max(0,Math.min(1,i));var n=this.useOpacityPressure?this.opacity*i*i:this.opacity,r=this.useSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size);this.started=!0,r>1&&(this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath),this.drawDot(e,t,r,n),this.context.restore()),this.lastDot=r*this.spacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2=s.BB.copyObj(this.lastInput),this.bezierLine=new s.BB.BezierLine,this.bezierLine.add(e,t,0,function(){})}},{key:"goLine",value:function(e,t,i){this.started&&(this.continueLine(e,t,this.lastInput.pressure),this.lastInput2=s.BB.copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i)}},{key:"endLine",value:function(){this.bezierLine&&this.continueLine(void 0,void 0,this.lastInput.pressure),this.started=!1,this.bezierLine=void 0,this.changedTiles.some(function(e){return e})&&this.klHistory.push((0,l.getPushableLayerChange)(this.klHistory.getComposed(),(0,h.canvasAndChangedTilesToLayerTiles)(this.context.canvas,this.changedTiles)))}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.selection=this.klHistory.getComposed().selection.value,this.selectionPath=this.selection?(0,u.getSelectionPath2d)(this.selection):void 0,this.selectionBounds=this.selection?(0,p.integerBounds)((0,d.getMultiPolyBounds)(this.selection)):void 0,this.changedTiles=[],this.isBaseLayer=0===this.layer.index,this.lastInput.x=i,this.lastInput.y=n,!this.started&&void 0!==e){var r,o=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),s=(i-e)/o,a=(n-t)/o,c=Math.max(1,Math.max(.5,1-this.opacity)*this.size*this.spacing);for(this.lastDot=0,this.context.save(),this.selectionPath&&this.context.clip(this.selectionPath),r=this.lastDot;r<=o;r+=c)this.drawDot(e+s*r,t+a*r,this.size,this.opacity);this.context.restore(),this.changedTiles.some(function(e){return e})&&this.klHistory.push((0,l.getPushableLayerChange)(this.klHistory.getComposed(),(0,h.canvasAndChangedTilesToLayerTiles)(this.context.canvas,this.changedTiles)))}}},{key:"isDrawing",value:function(){return this.started}},{key:"setLayer",value:function(e){this.layer=e,this.context=e.context}},{key:"setHistory",value:function(e){this.klHistory=e}},{key:"setSize",value:function(e){this.size=e}},{key:"setOpacity",value:function(e){this.opacity=e}},{key:"sizePressure",value:function(e){this.useSizePressure=e}},{key:"opacityPressure",value:function(e){this.useOpacityPressure=e}},{key:"setTransparentBG",value:function(e){this.isTransparentBG=e}},{key:"getSize",value:function(){return this.size}},{key:"getOpacity",value:function(){return this.opacity}}]),e}()}),s("ltaBP",function(t,i){e(t.exports,"SmudgeBrush",function(){return d});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("eg83P"),l=o("3Fob6"),h=o("4sWjZ"),c=o("7jh4K"),u=o("gIIqd"),p=o("g03EN"),d=function(){"use strict";function e(){(0,n._)(this,e),this.context={},this.klHistory={},this.settingColor={r:0,g:0,b:0},this.settingSize=35,this.settingSpacing=.20446882736951905,this.settingOpacity=.8,this.settingHasSizePressure=!1,this.settingHasOpacityPressure=!1,this.settingLockLayerAlpha=!1,this.lineToolLastDot=0,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.isDrawing=!1,this.copyImageData={},this.drawBuffer=[],this.copiedCells=[]}return(0,r._)(e,[{key:"resetRedrawBounds",value:function(){this.redrawBounds=void 0}},{key:"updateRedrawBounds",value:function(e){var t=(0,a.boundsOverlap)(e,this.selectionBounds);t&&(this.redrawBounds=s.BB.updateBounds(this.redrawBounds,t))}},{key:"updateCompleteRedrawBounds",value:function(e,t,i,n){this.completeRedrawBounds=s.BB.updateBounds(this.completeRedrawBounds,{x1:e,y1:t,x2:i,y2:n})}},{key:"copyFromCanvas",value:function(){var e=this,t=this.copiedCells.map(function(){return!1}),i=[],n=Math.ceil(this.copyImageData.width/256);this.redrawBounds&&(i.push({x1:Math.floor(this.redrawBounds.x1/256),y1:Math.floor(this.redrawBounds.y1/256),x2:Math.floor(this.redrawBounds.x2/256),y2:Math.floor(this.redrawBounds.y2/256)}),i.forEach(function(e){for(var i=e.x1;i<=e.x2;i++)for(var r=e.y1;r<=e.y2;r++)t[r*n+i]=!0}),t.forEach(function(t,i){if(t&&!e.copiedCells[i]){e.copiedCells[i]=!0;var r=i%n,o=Math.floor(i/n),a=(Math.min(256*r+256,e.copyImageData.width)-1)%256+1,l=(Math.min(256*o+256,e.copyImageData.height)-1)%256+1,h=s.BB.canvas(a,l),c=s.BB.ctx(h);c.drawImage(e.context.canvas,-(256*r),-(256*o));for(var u=c.getImageData(0,0,a,l),p=0;p<l;p++)for(var d=0,g=p*a*4,f=((256*o+p)*e.copyImageData.width+256*r)*4;d<a;d++,g+=4,f+=4)e.copyImageData.data[f]=u.data[g],e.copyImageData.data[f+1]=u.data[g+1],e.copyImageData.data[f+2]=u.data[g+2],e.copyImageData.data[f+3]=u.data[g+3]}}))}},{key:"prepDot",value:function(e,t,i,n){if(!this.lastDot){this.lastDot={x:e,y:t};return}var r=Math.round(2*(i=Math.round(i))),o=Math.round(2*i),a=function(e,t,i,n,r){if(i.x===n.x&&i.y===n.y)return null;i=s.BB.copyObj(i),n=s.BB.copyObj(n),r=s.BB.copyObj(r);var o=0,a=0,l=0,h=0;return(i.x<0&&(h=-i.x),i.y<0&&(o=-i.y),n.x<0&&(h=Math.max(h,-n.x)),n.y<0&&(o=Math.max(o,-n.y)),i.x+r.w>e&&(a=i.x+r.w-e),i.y+r.h>t&&(l=i.y+r.h-t),n.x+r.w>e&&(a=Math.max(a,n.x+r.w-e)),n.y+r.h>t&&(l=Math.max(l,n.y+r.h-t)),i.x+=h,n.x+=h,i.y+=o,n.y+=o,r.w=r.w-h-a,r.h=r.h-o-l,r.w<=0||r.h<=0)?null:{aP:{x:i.x,y:i.y},bP:{x:n.x,y:n.y},size:{w:r.w,h:r.h}}}(this.copyImageData.width,this.copyImageData.height,{x:Math.round(this.lastDot.x-i),y:Math.round(this.lastDot.y-i)},{x:Math.round(e-i),y:Math.round(t-i)},{w:r,h:o});if(a){var l={aP:a.aP,bP:a.bP,size:a.size,brush:{center:{x:e,y:t},size:i,opacity:n,alphaLock:this.settingLockLayerAlpha}};this.updateRedrawBounds({x1:l.bP.x,y1:l.bP.y,x2:l.bP.x+2*l.brush.size,y2:l.bP.y+2*l.brush.size}),this.drawBuffer.push(l)}this.lastDot={x:e,y:t}}},{key:"continueLine",value:function(e,t,i,n){var r=this;this.drawBuffer=[],this.bezierLine||(this.bezierLine=new s.BB.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,function(){}));var o=[],l=function(e){var t=s.BB.mix(r.lastInput2.pressure,n,e.t),i=r.settingOpacity*(r.settingHasOpacityPressure?t*t:1),a=Math.max(.1,r.settingSize*(r.settingHasSizePressure?t:1));o.push([e.x,e.y,a,i])},h=i*this.settingSpacing/3;void 0===e||void 0===t?this.bezierLine.addFinal(h,l):this.bezierLine.add(e,t,h,l);for(var c=0;c<o.length;c++){var u=o[c];this.prepDot(u[0],u[1],u[2],u[3])}this.copyFromCanvas();for(var p=0;p<this.drawBuffer.length;p++)!function(e,t,i){for(var n=(i=s.BB.copyObj(i)).brush.size,r=i.brush.center.x,o=i.brush.center.y,l=i.aP.y*e.width+i.aP.x,h=(i.bP.y*e.width+i.bP.x-l)*4,c=0,u=n>30?1024:512,p=[],d=0;d<u;d++)p[d]=(Math.random()-.5)/1.001+.5;var g=Math.max(3,Math.min(8,i.brush.size-8)),f=function(l,h,d,f){var v,m=s.BB.dist(r,o,d,f),y=1-i.brush.opacity*(1-(0,a.clamp)((m-(n-g))/g,0,1));1!==y&&(!t||0!==t[l/4]&&0!==t[h/4])&&(e.data[l+3]&&(e.data[h+3]?(v=e.data[l+3]<e.data[h+3]?1-e.data[l+3]/e.data[h+3]*(1-y):e.data[h+3]/e.data[l+3]*y,e.data[h]=Math.floor(s.BB.mix(e.data[l],e.data[h+0],v)+p[c]),e.data[h+1]=Math.floor(s.BB.mix(e.data[l+1],e.data[h+1],v)+p[c]),e.data[h+2]=Math.floor(s.BB.mix(e.data[l+2],e.data[h+2],v)+p[c]),c=(c+1)%u):(e.data[h]=e.data[l],e.data[h+1]=e.data[l+1],e.data[h+2]=e.data[l+2])),i.brush.alphaLock||(e.data[h+3]=Math.floor(s.BB.mix(e.data[l+3],e.data[h+3],y)+.5)))},v=4*i.bP.x,m=v+(i.size.w-1)*4;if(i.aP.y<i.bP.y)for(var y=i.size.h-1,x=i.bP.y+i.size.h-1;y>=0;y--,x--)for(var b=(y+i.bP.y)*e.width*4,w=m+b,B=m+b-h,k=i.bP.x+i.size.w-1;w>=v+b;w-=4,B-=4,k--)f(B,w,k,x);else if(i.aP.y>i.bP.y)for(var S=0,C=i.bP.y;S<i.size.h;S++,C++)for(var E=(S+i.bP.y)*e.width*4,L=m+E,I=m+E-h,T=i.bP.x+i.size.w-1;L>=v+E;L-=4,I-=4,T--)f(I,L,T,C);else if(i.aP.x<i.bP.x)for(var A=i.size.h-1,M=i.bP.y+i.size.h-1;A>=0;A--,M--)for(var R=(A+i.bP.y)*e.width*4,_=m+R,P=m+R-h,D=i.bP.x+i.size.w-1;_>=v+R;_-=4,P-=4,D--)f(P,_,D,M);else for(var N=0,O=i.bP.y;N<i.size.h;N++,O++)for(var G=(N+i.bP.y)*e.width*4,H=v+G,z=v+G-h,j=i.bP.x;H<m+G;H+=4,z+=4,j++)f(z,H,j,O)}(this.copyImageData,this.mask,this.drawBuffer[p])}},{key:"startLine",value:function(e,t,i){var n=this.klHistory.getComposed().selection.value;this.selectionBounds=n?(0,a.integerBounds)((0,p.getMultiPolyBounds)(n)):void 0,this.mask=n?(0,u.getBinaryMask)(n,this.context.canvas.width,this.context.canvas.height):void 0,i=s.BB.clamp(i,0,1);var r=this.settingHasOpacityPressure?this.settingOpacity*i*i:this.settingOpacity,o=this.settingHasSizePressure?Math.max(.1,i*this.settingSize):Math.max(.1,this.settingSize);this.lastDot=void 0,this.isDrawing=!0,this.copyImageData=new ImageData(this.context.canvas.width,this.context.canvas.height);var l=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.copiedCells=(0,c.createArray)(l,!1),this.prepDot(e,t,o,r),this.lineToolLastDot=o*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2.pressure=i,this.completeRedrawBounds=void 0}},{key:"goLine",value:function(e,t,i){if(this.isDrawing){this.resetRedrawBounds();var n=s.BB.clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(e,t,r,this.lastInput.pressure),this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1,this.redrawBounds.y2-this.redrawBounds.y1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.lastInput.x=e,this.lastInput.y=t,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=n}}},{key:"endLine",value:function(){this.resetRedrawBounds();var e=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.context.save(),this.continueLine(void 0,void 0,e,this.lastInput.pressure),this.context.restore(),this.isDrawing=!1,this.bezierLine=void 0,this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1,this.redrawBounds.y2-this.redrawBounds.y1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.completeRedrawBounds&&this.klHistory.push((0,l.getPushableLayerChange)(this.klHistory.getComposed(),(0,h.canvasToLayerTiles)(this.context.canvas,this.completeRedrawBounds))),this.copyImageData={}}},{key:"drawImage",value:function(e,t,i){e instanceof ImageData?this.context.putImageData(e,t,i):(this.context.clearRect(t,i,e.width,e.height),this.context.drawImage(e,t,i))}},{key:"drawLineSegment",value:function(e,t,i,n){}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"setColor",value:function(e){(this.settingColor.r!==e.r||this.settingColor.g!==e.g||this.settingColor.b!==e.b)&&(this.settingColor={r:e.r,g:e.g,b:e.b})}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.klHistory=e}},{key:"setSize",value:function(e){this.settingSize=e}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setSpacing",value:function(e){this.settingSpacing=e}},{key:"sizePressure",value:function(e){this.settingHasSizePressure=e}},{key:"opacityPressure",value:function(e){this.settingHasOpacityPressure=e}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"getSpacing",value:function(){return this.settingSpacing}},{key:"getSize",value:function(){return this.settingSize}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}}]),e}()}),s("6Nq1H",function(t,i){e(t.exports,"ChemyBrush",function(){return g});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("eWjiX"),l=o("fohxs"),h=o("3Fob6"),c=o("4sWjZ"),u=o("9b3eo"),p=o("eg83P"),d=o("g03EN"),g=function(){"use strict";function e(){(0,n._)(this,e),this.context={},this.settingColor={},this.settingSize=.25,this.settingOpacity=1,this.settingLockLayerAlpha=!1,this.settingIsEraser=!1,this.settingMode="fill",this.settingDistort=0,this.settingXSymmetry=!1,this.settingYSymmetry=!1,this.settingGradient=!1,this.isDrawing=!1,this.klHistory={},this.copyCanvas={},this.path=[],this.minY=0,this.maxY=0}return(0,r._)(e,[{key:"updateCompleteRedrawBounds",value:function(e,t){var i={x1:e,y1:t,x2:e,y2:t};this.settingXSymmetry&&(i=a.BB.updateBounds(i,{x1:-e+this.copyCanvas.width,y1:t,x2:-e+this.copyCanvas.width,y2:t})),this.settingYSymmetry&&(i=a.BB.updateBounds(i,{x1:e,y1:-t+this.copyCanvas.height,x2:e,y2:-t+this.copyCanvas.height}));var n="stroke"===this.settingMode?this.settingSize+1:1;i.x1=Math.floor(i.x1-n),i.y1=Math.floor(i.y1-n),i.x2=Math.ceil(i.x2+n),i.y2=Math.ceil(i.y2+n),this.completeRedrawBounds=a.BB.updateBounds(this.completeRedrawBounds,i)}},{key:"drawShape",value:function(){var e=this;this.context.save(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.drawImage(this.copyCanvas,0,0),this.selectionPath&&this.context.clip(this.selectionPath);var t=(0,s._)({},this.settingColor);if(this.settingIsEraser?(t.r=l.ERASE_COLOR,t.g=l.ERASE_COLOR,t.b=l.ERASE_COLOR,this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),this.path.length>1){var i=new Path2D;this.path.forEach(function(e,t){0===t?i.moveTo(e.x,e.y):i.lineTo(e.x,e.y)});var n=a.BB.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity});if(this.settingGradient){var r=this.path[0].x>this.path[this.path.length-1].x,o=this.context.createLinearGradient(0,r?this.minY:this.maxY,0,r?this.maxY:this.minY);o.addColorStop(0,a.BB.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity})),o.addColorStop(1,a.BB.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:0})),n=o}"fill"===this.settingMode?this.context.fillStyle=n:(this.context.lineWidth=2*this.settingSize,this.context.lineJoin="bevel",this.context.strokeStyle=n);var h=function(){"fill"===e.settingMode?e.context.fill(i):e.context.stroke(i)};h(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,0),this.context.scale(-1,1),this.context.translate(-this.context.canvas.width/2,0),h(),this.context.restore()),this.settingYSymmetry&&(this.context.save(),this.context.translate(0,this.context.canvas.height/2),this.context.scale(1,-1),this.context.translate(0,-this.context.canvas.height/2),h(),this.context.restore(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,this.context.canvas.height/2),this.context.scale(-1,-1),this.context.translate(-this.context.canvas.width/2,-this.context.canvas.height/2),h(),this.context.restore()))}this.context.restore()}},{key:"setHistory",value:function(e){this.klHistory=e}},{key:"getSize",value:function(){return"stroke"===this.settingMode?this.settingSize:0}},{key:"setSize",value:function(e){this.settingSize=e}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setColor",value:function(e){this.settingColor=a.BB.copyObj(e)}},{key:"setContext",value:function(e){this.context=e}},{key:"setMode",value:function(e){this.settingMode=e}},{key:"getMode",value:function(){return this.settingMode}},{key:"setDistort",value:function(e){this.settingDistort=a.BB.clamp(e,0,1)}},{key:"getDistort",value:function(){return this.settingDistort}},{key:"setXSymmetry",value:function(e){this.settingXSymmetry=e}},{key:"getXSymmetry",value:function(){return this.settingXSymmetry}},{key:"setYSymmetry",value:function(e){this.settingYSymmetry=e}},{key:"getYSymmetry",value:function(){return this.settingYSymmetry}},{key:"setGradient",value:function(e){this.settingGradient=e}},{key:"getGradient",value:function(){return this.settingGradient}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"getIsEraser",value:function(){return this.settingIsEraser}},{key:"setIsEraser",value:function(e){this.settingIsEraser=e}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"startLine",value:function(e,t){this.selection=this.klHistory.getComposed().selection.value,this.selectionPath=this.selection?(0,u.getSelectionPath2d)(this.selection):void 0,this.selectionBounds=this.selection?(0,p.integerBounds)((0,d.getMultiPolyBounds)(this.selection)):void 0,this.isDrawing=!0,this.path=[{x:e,y:t}],this.minY=t,this.maxY=t,this.copyCanvas=a.BB.canvas(this.context.canvas.width,this.context.canvas.height),a.BB.ctx(this.copyCanvas).drawImage(this.context.canvas,0,0),this.completeRedrawBounds=void 0,this.updateCompleteRedrawBounds(e,t)}},{key:"goLine",value:function(e,t){if(this.isDrawing){var i={x:e,y:t};this.settingDistort>0&&(i.x+=(Math.random()-.5)*this.settingDistort*80,i.y+=(Math.random()-.5)*this.settingDistort*80),this.minY=Math.min(this.minY,i.y),this.maxY=Math.max(this.maxY,i.y),this.path.push(i),this.updateCompleteRedrawBounds(e,t),this.drawShape()}}},{key:"endLine",value:function(){if(this.isDrawing=!1,this.completeRedrawBounds=a.BB.boundsInArea(this.completeRedrawBounds,this.copyCanvas.width,this.copyCanvas.height),this.selectionBounds&&(this.completeRedrawBounds=(0,p.boundsOverlap)(this.completeRedrawBounds,this.selectionBounds)),this.path.length>1&&this.completeRedrawBounds){var e=(0,c.canvasToLayerTiles)(this.context.canvas,this.completeRedrawBounds);this.klHistory.push((0,h.getPushableLayerChange)(this.klHistory.getComposed(),e))}this.path=[],this.copyCanvas={}}},{key:"drawLineSegment",value:function(e,t,i,n){}}]),e}()}),s("3P46L",function(t,i){e(t.exports,"BRUSHES_UI",function(){return u});var n=o("cVFne"),r=o("9mjXI"),s=o("iYbUv"),a=o("brjBD"),l=o("9rc5F"),h=o("dS2qM"),c=o("vCnsd"),u={penBrush:n.penBrushUi,blendBrush:r.blendBrushUi,sketchyBrush:s.sketchyBrushUi,pixelBrush:a.pixelBrushUi,chemyBrush:c.chemyBrushUi,smudgeBrush:h.smudgeBrushUi,eraserBrush:l.eraserBrushUi}}),s("cVFne",function(i,n){e(i.exports,"penBrushUi",function(){return m});var r,s,a=o("eWjiX"),l=o("dAXbp"),h=o("7NTKy"),c=o("7bWhB"),u=o("aP0jf"),p=o("lCF5N"),d=o("4UMi7"),g=o("74D3O"),f=o("1mH1z"),v=o("iFIyy"),m=(r={image:t(d),tooltip:(0,f.LANG)("brush-pen"),sizeSlider:{min:.5,max:100,curve:a.BB.powerSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]},scatterSlider:{min:0,max:100,curve:a.BB.powerSplineInput(0,100,.1,2.5)}},s=[(0,f.LANG)("brush-pen-circle"),(0,f.LANG)("brush-pen-chalk"),(0,f.LANG)("brush-pen-calligraphy"),(0,f.LANG)("brush-pen-square")],f.LANGUAGE_STRINGS.subscribe(function(){r.tooltip=(0,f.LANG)("brush-pen"),s=[(0,f.LANG)("brush-pen-circle"),(0,f.LANG)("brush-pen-chalk"),(0,f.LANG)("brush-pen-calligraphy"),(0,f.LANG)("brush-pen-square")]}),r.Ui=function(e){var t,i,n,o,d,m,y=document.createElement("div"),x=new l.BRUSHES.PenBrush;x.setHistory(e.klHistory),e.onSizeChange(x.getSize());var b=new(0,v.Options)({optionArr:[0,1,2,3].map(function(e){var t=a.BB.el({className:"dark-invert",css:{width:"31px",height:"31px",backgroundSize:"contain",margin:"2px"}}),i=a.BB.canvas(70,70),n=a.BB.ctx(i);return 0===e||3===e?0===e?(n.beginPath(),n.arc(35,35,30,0,2*Math.PI),n.closePath(),n.fill()):n.fillRect(5,5,60,60):1===e?n.drawImage((0,g.genBrushAlpha01)(60),5,5):2===e&&n.drawImage((0,g.genBrushAlpha02)(60),5,5),t.style.backgroundImage="url("+i.toDataURL("image/png")+")",{id:e,label:t,title:s[e]}}),initId:0,onChange:function(e){x.setAlpha(e)}}),w=new(0,c.Checkbox)({init:x.getLockAlpha(),label:(0,f.LANG)("lock-alpha"),callback:function(e){x.setLockAlpha(e)},doHighlight:!0,title:(0,f.LANG)("lock-alpha-title"),css:{display:"inline-block"},name:"lock-alpha-toggle"}),B=new a.BB.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function k(e){x.setSize(e),x.setSpacing(Math.max(2,B.interpolate(e))/15)}o=new(0,u.KlSlider)({label:(0,f.LANG)("brush-size"),width:225,height:30,min:r.sizeSlider.min,max:r.sizeSlider.max,value:x.getSize(),curve:r.sizeSlider.curve,eventResMs:h.EVENT_RES_MS,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){k(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?a.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),d=new(0,u.KlSlider)({label:(0,f.LANG)("opacity"),width:225,height:30,min:r.opacitySlider.min,max:r.opacitySlider.max,value:r.opacitySlider.max,curve:r.opacitySlider.curve,eventResMs:h.EVENT_RES_MS,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){x.setOpacity(t),e.onOpacityChange(t)}}),m=new(0,u.KlSlider)({label:(0,f.LANG)("scatter"),width:225,height:30,min:r.scatterSlider.min,max:r.scatterSlider.max,value:r.scatterSlider.min,curve:r.scatterSlider.curve,eventResMs:h.EVENT_RES_MS,onChange:function(t){x.setScatter(t),e.onScatterChange(t)},formatFunc:function(e){return e<10?a.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),t=(0,p.createPenPressureToggle)(!0,function(e){x.sizePressure(e)}),i=(0,p.createPenPressureToggle)(!1,function(e){x.opacityPressure(e)}),n=(0,p.createPenPressureToggle)(!1,function(e){x.scatterPressure(e)}),y.append(a.BB.el({content:[o.getElement(),t],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),a.BB.el({content:[d.getElement(),i],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),a.BB.el({content:[m.getElement(),n],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),a.BB.el({content:b.getElement(),css:{marginTop:"10px"}}),a.BB.el({content:w.getElement(),css:{marginTop:"10px"}})),this.increaseSize=function(e){x.isDrawing()||o.changeSliderValue(e)},this.decreaseSize=function(e){x.isDrawing()||o.changeSliderValue(-e)},this.getSize=function(){return x.getSize()},this.setSize=function(e){k(e),o.setValue(e)},this.getOpacity=function(){return x.getOpacity()},this.setOpacity=function(e){x.setOpacity(e),d.setValue(e)},this.getScatter=function(){return x.getScatter()},this.setScatter=function(e){x.setScatter(e),m.setValue(e)},this.setColor=function(e){x.setColor(e)},this.setLayer=function(e){x.setContext(e.context)},this.startLine=function(e,t,i){x.startLine(e,t,i)},this.goLine=function(e,t,i){x.goLine(e,t,i)},this.endLine=function(){x.endLine()},this.getBrush=function(){return x},this.isDrawing=function(){return x.isDrawing()},this.getElement=function(){return y}},r)}),s("7NTKy",function(t,i){e(t.exports,"EVENT_RES_MS",function(){return n});var n=20}),s("4UMi7",function(e,t){e.exports=i("iiCd6")}),s("9mjXI",function(i,n){e(i.exports,"blendBrushUi",function(){return g});var r,s=o("eWjiX"),a=o("lCF5N"),l=o("7NTKy"),h=o("7bWhB"),c=o("dAXbp"),u=o("aP0jf"),p=o("7s7KR"),d=o("1mH1z"),g=(r={image:t(p),tooltip:(0,d.LANG)("brush-blend"),sizeSlider:{min:.5,max:100,curve:s.BB.powerSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1}},d.LANGUAGE_STRINGS.subscribe(function(){r.tooltip=(0,d.LANG)("brush-blend")}),r.Ui=function(e){var t,i,n,o,p,g,f=document.createElement("div"),v=new c.BRUSHES.BlendBrush;function m(e){v.setSize(e)}v.setHistory(e.klHistory),e.onSizeChange(v.getSize()),p=new(0,u.KlSlider)({label:(0,d.LANG)("brush-size"),width:225,height:30,min:r.sizeSlider.min,max:r.sizeSlider.max,value:58,curve:r.sizeSlider.curve,eventResMs:l.EVENT_RES_MS,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){m(t),e.onSizeChange(t)}}),g=new(0,u.KlSlider)({label:(0,d.LANG)("opacity"),width:225,height:30,min:r.opacitySlider.min,max:r.opacitySlider.max,value:v.getOpacity(),curve:r.opacitySlider.curve,eventResMs:l.EVENT_RES_MS,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){v.setOpacity(t),e.onOpacityChange(t)}}),(t=new(0,u.KlSlider)({label:(0,d.LANG)("brush-blending"),width:225,height:30,min:0,max:1,value:v.getBlending(),eventResMs:l.EVENT_RES_MS,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(e){v.setBlending(e)}})).getElement().style.marginTop="10px",i=(0,a.createPenPressureToggle)(!0,function(e){v.setSizePressure(e)}),n=(0,a.createPenPressureToggle)(!1,function(e){v.setOpacityPressure(e)}),o=new(0,h.Checkbox)({init:v.getLockAlpha(),label:(0,d.LANG)("lock-alpha"),callback:function(e){v.setLockAlpha(e)},doHighlight:!0,title:(0,d.LANG)("lock-alpha-title"),css:{marginTop:"10px",display:"inline-block"},name:"lock-alpha"}),f.append(s.BB.el({content:[p.getElement(),i],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),s.BB.el({content:[g.getElement(),n],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),t.getElement(),o.getElement()),this.increaseSize=function(e){v.getIsDrawing()||p.changeSliderValue(e)},this.decreaseSize=function(e){v.getIsDrawing()||p.changeSliderValue(-e)},this.getSize=function(){return v.getSize()},this.setSize=function(e){m(e),p.setValue(e)},this.getOpacity=function(){return v.getOpacity()},this.setOpacity=function(e){v.setOpacity(e),g.setValue(e)},this.setColor=function(e){v.setColor(e)},this.setLayer=function(e){v.setContext(e.context,e.id)},this.startLine=function(e,t,i){v.startLine(e,t,i)},this.goLine=function(e,t,i,n){v.goLine(e,t,i,!1)},this.endLine=function(){v.endLine()},this.getBrush=function(){return v},this.isDrawing=function(){return v.getIsDrawing()},this.getElement=function(){return f}},r)}),s("7s7KR",function(e,t){e.exports=i("6fRlX")}),s("iYbUv",function(i,n){e(i.exports,"sketchyBrushUi",function(){return p});var r,s=o("dAXbp"),a=o("7NTKy"),l=o("aP0jf"),h=o("3vgDV"),c=o("1mH1z"),u=o("eWjiX"),p=(r={image:t(h),tooltip:(0,c.LANG)("brush-sketchy"),sizeSlider:{min:.5,max:10},opacitySlider:{min:.01,max:1}},c.LANGUAGE_STRINGS.subscribe(function(){r.tooltip=(0,c.LANG)("brush-sketchy")}),r.Ui=function(e){var t,i,n,o,h=document.createElement("div"),p=new s.BRUSHES.SketchyBrush;p.setHistory(e.klHistory),e.onSizeChange(p.getSize()),n=new(0,l.KlSlider)({label:(0,c.LANG)("brush-size"),width:250,height:30,min:r.sizeSlider.min,max:r.sizeSlider.max,value:2*p.getSize(),eventResMs:a.EVENT_RES_MS,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){p.setSize(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?u.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),o=new(0,l.KlSlider)({label:(0,c.LANG)("opacity"),width:250,height:30,min:r.opacitySlider.min,max:r.opacitySlider.max,value:p.getOpacity(),eventResMs:a.EVENT_RES_MS,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){p.setOpacity(t),e.onOpacityChange(t)}}),t=new(0,l.KlSlider)({label:(0,c.LANG)("brush-blending"),width:250,height:30,min:0,max:1,value:p.getBlending(),eventResMs:a.EVENT_RES_MS,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(e){p.setBlending(e)}}),i=new(0,l.KlSlider)({label:(0,c.LANG)("brush-sketchy-scale"),width:250,height:30,min:1,max:20,value:p.getScale(),eventResMs:a.EVENT_RES_MS,onChange:function(e){p.setScale(e)}}),o.getElement().style.marginTop="10px",t.getElement().style.marginTop="10px",i.getElement().style.marginTop="10px",h.append(n.getElement(),o.getElement(),t.getElement(),i.getElement()),this.increaseSize=function(e){p.isDrawing()||n.changeSliderValue(e)},this.decreaseSize=function(e){p.isDrawing()||n.changeSliderValue(-e)},this.getSize=function(){return p.getSize()},this.setSize=function(e){p.setSize(e),n.setValue(e)},this.getOpacity=function(){return p.getOpacity()},this.setOpacity=function(e){p.setOpacity(e),o.setValue(e)},this.setColor=function(e){p.setColor(e)},this.setLayer=function(e){p.setContext(e.context)},this.startLine=function(e,t,i){p.startLine(e,t,i)},this.goLine=function(e,t,i){p.goLine(e,t,i,void 0)},this.endLine=function(){p.endLine()},this.getSeed=function(){return parseInt(""+p.getSeed())},this.setSeed=function(e){p.setSeed(parseInt(""+e))},this.getBrush=function(){return p},this.isDrawing=function(){return p.isDrawing()},this.getElement=function(){return h}},r)}),s("3vgDV",function(e,t){e.exports=i("hC7PC")}),s("brjBD",function(i,n){e(i.exports,"pixelBrushUi",function(){return g});var r,s=o("eWjiX"),a=o("dAXbp"),l=o("7NTKy"),h=o("7bWhB"),c=o("aP0jf"),u=o("lCF5N"),p=o("P8X5d"),d=o("1mH1z"),g=(r={image:t(p),tooltip:(0,d.LANG)("brush-pixel"),sizeSlider:{min:.5,max:100,curve:s.BB.powerSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]}},d.LANGUAGE_STRINGS.subscribe(function(){r.tooltip=(0,d.LANG)("brush-pixel")}),r.Ui=function(e){var t,i,n,o=document.createElement("div"),p=new a.BRUSHES.PixelBrush;p.setHistory(e.klHistory),e.onSizeChange(p.getSize());var g=new(0,h.Checkbox)({init:p.getLockAlpha(),label:(0,d.LANG)("lock-alpha"),callback:function(e){p.setLockAlpha(e)},doHighlight:!0,title:(0,d.LANG)("lock-alpha-title"),name:"lock-alpha-toggle"}),f=new(0,h.Checkbox)({init:p.getIsEraser(),label:(0,d.LANG)("eraser"),callback:function(e){p.setIsEraser(e)},name:"eraser-toggle"}),v=new(0,h.Checkbox)({init:p.getUseDither(),label:(0,d.LANG)("brush-pixel-dither"),callback:function(e){p.setUseDither(e)},name:"dither-toggle"}),m=new s.BB.SplineInterpolator([[.5,.45],[100,4]]);function y(e){p.setSize(e),p.setSpacing(m.interpolate(e)/e)}i=new(0,c.KlSlider)({label:(0,d.LANG)("brush-size"),width:225,height:30,min:r.sizeSlider.min,max:r.sizeSlider.max,value:p.getSize(),curve:r.sizeSlider.curve,eventResMs:l.EVENT_RES_MS,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){y(t),e.onSizeChange(t)}}),n=new(0,c.KlSlider)({label:(0,d.LANG)("opacity"),width:225,height:30,min:r.opacitySlider.min,max:r.opacitySlider.max,value:r.opacitySlider.max,eventResMs:l.EVENT_RES_MS,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){p.setOpacity(t),e.onOpacityChange(t)}}),t=(0,u.createPenPressureToggle)(!0,function(e){p.sizePressure(e)}),o.append(s.BB.el({content:[i.getElement(),t],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),n.getElement()),s.BB.el({parent:o,css:{display:"flex",marginTop:"10px",gap:"10px",flexWrap:"wrap"}}).append(g.getElement(),f.getElement(),v.getElement()),this.increaseSize=function(e){p.isDrawing()||i.changeSliderValue(e)},this.decreaseSize=function(e){p.isDrawing()||i.changeSliderValue(-e)},this.getSize=function(){return p.getSize()},this.setSize=function(e){y(e),i.setValue(2*e)},this.getOpacity=function(){return p.getOpacity()},this.setOpacity=function(e){p.setOpacity(e),n.setValue(100*e)},this.setColor=function(e){p.setColor(e)},this.setLayer=function(e){p.setContext(e.context)},this.startLine=function(e,t,i){p.startLine(e,t,i)},this.goLine=function(e,t,i){p.goLine(e,t,i)},this.endLine=function(){p.endLine()},this.getBrush=function(){return p},this.isDrawing=function(){return p.isDrawing()},this.toggleEraser=function(){f.setValue(!f.getValue()),p.setIsEraser(f.getValue())},this.getElement=function(){return o}},r)}),s("P8X5d",function(e,t){e.exports=i("eZgVv")}),s("9rc5F",function(i,n){e(i.exports,"eraserBrushUi",function(){return g});var r,s=o("eWjiX"),a=o("dAXbp"),l=o("7NTKy"),h=o("aP0jf"),c=o("lCF5N"),u=o("7bWhB"),p=o("a0L4S"),d=o("1mH1z"),g=(r={image:t(p),tooltip:(0,d.LANG)("eraser")+" [E]",sizeSlider:{min:.5,max:200,curve:s.BB.powerSplineInput(.5,200,.1)},opacitySlider:{min:.01,max:1}},d.LANGUAGE_STRINGS.subscribe(function(){r.tooltip=(0,d.LANG)("eraser")+" [E]"}),r.Ui=function(e){var t,i,n,o,p,g=document.createElement("div"),f=new a.BRUSHES.EraserBrush;f.setHistory(e.klHistory),e.onSizeChange(f.getSize());var v=!1;function m(e){f.setSize(e)}o=new(0,h.KlSlider)({label:(0,d.LANG)("brush-size"),width:225,height:30,min:r.sizeSlider.min,max:r.sizeSlider.max,value:30,curve:r.sizeSlider.curve,eventResMs:l.EVENT_RES_MS,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){m(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?s.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),p=new(0,h.KlSlider)({label:(0,d.LANG)("opacity"),width:225,height:30,min:r.opacitySlider.min,max:r.opacitySlider.max,value:r.opacitySlider.max,eventResMs:l.EVENT_RES_MS,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){f.setOpacity(t),e.onOpacityChange(t)}}),t=(0,c.createPenPressureToggle)(!0,function(e){f.sizePressure(e)}),i=(0,c.createPenPressureToggle)(!1,function(e){f.opacityPressure(e)}),g.append(s.BB.el({content:[o.getElement(),t],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),s.BB.el({content:[p.getElement(),i],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}})),n=new(0,u.Checkbox)({init:!1,label:(0,d.LANG)("brush-eraser-transparent-bg"),callback:function(e){v=e,f.setTransparentBG(e)},css:{marginTop:"10px"},name:"transparency-toggle"}),g.append(n.getElement()),this.increaseSize=function(e){f.isDrawing()||o.changeSliderValue(e)},this.decreaseSize=function(e){f.isDrawing()||o.changeSliderValue(-e)},this.getSize=function(){return f.getSize()},this.setSize=function(e){m(e),o.setValue(e)},this.getOpacity=function(){return f.getOpacity()},this.setOpacity=function(e){f.setOpacity(e),p.setValue(e)},this.setColor=function(){},this.setLayer=function(e){f.setLayer(e)},this.startLine=function(e,t,i){f.startLine(e,t,i)},this.goLine=function(e,t,i){f.goLine(e,t,i)},this.endLine=function(){f.endLine()},this.getBrush=function(){return f},this.getIsTransparentBg=function(){return v},this.isDrawing=function(){return f.isDrawing()},this.getElement=function(){return g}},r)}),s("a0L4S",function(e,t){e.exports=i("fPZin")}),s("dS2qM",function(i,n){e(i.exports,"smudgeBrushUi",function(){return g});var r,s=o("eWjiX"),a=o("dAXbp"),l=o("7NTKy"),h=o("7bWhB"),c=o("aP0jf"),u=o("lCF5N"),p=o("jlrk1"),d=o("1mH1z"),g=(r={image:t(p),tooltip:(0,d.LANG)("brush-smudge"),sizeSlider:{min:.5,max:100,curve:s.BB.powerSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]}},d.LANGUAGE_STRINGS.subscribe(function(){r.tooltip=(0,d.LANG)("brush-smudge")}),r.Ui=function(e){var t,i,n,o,p=document.createElement("div"),g=new a.BRUSHES.SmudgeBrush;g.setHistory(e.klHistory),e.onSizeChange(g.getSize());var f=new(0,h.Checkbox)({init:g.getLockAlpha(),label:(0,d.LANG)("lock-alpha"),callback:function(e){g.setLockAlpha(e)},doHighlight:!0,title:(0,d.LANG)("lock-alpha-title"),css:{display:"inline-block"},name:"lock-alpha-toggle"}),v=new s.BB.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function m(e){g.setSize(e),g.setSpacing(Math.max(2,v.interpolate(e))/15)}n=new(0,c.KlSlider)({label:(0,d.LANG)("brush-size"),width:225,height:30,min:r.sizeSlider.min,max:r.sizeSlider.max,value:g.getSize(),curve:r.sizeSlider.curve,eventResMs:l.EVENT_RES_MS,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){m(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?s.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),o=new(0,c.KlSlider)({label:(0,d.LANG)("opacity"),width:225,height:30,min:r.opacitySlider.min,max:r.opacitySlider.max,value:g.getOpacity(),curve:r.opacitySlider.curve,eventResMs:l.EVENT_RES_MS,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){g.setOpacity(t),e.onOpacityChange(t)}}),t=(0,u.createPenPressureToggle)(!1,function(e){g.sizePressure(e)}),i=(0,u.createPenPressureToggle)(!1,function(e){g.opacityPressure(e)}),p.append(s.BB.el({content:[n.getElement(),t],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),s.BB.el({content:[o.getElement(),i],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}})),s.BB.el({parent:p,css:{marginTop:"10px"}}).append(f.getElement()),this.increaseSize=function(e){g.getIsDrawing()||n.changeSliderValue(e)},this.decreaseSize=function(e){g.getIsDrawing()||n.changeSliderValue(-e)},this.getSize=function(){return g.getSize()},this.setSize=function(e){m(e),n.setValue(e)},this.getOpacity=function(){return g.getOpacity()},this.setOpacity=function(e){g.setOpacity(e),o.setValue(e)},this.setColor=function(e){g.setColor(e)},this.setLayer=function(e){g.setContext(e.context)},this.startLine=function(e,t,i){g.startLine(e,t,i)},this.goLine=function(e,t,i){g.goLine(e,t,i)},this.endLine=function(){g.endLine()},this.getBrush=function(){return g},this.isDrawing=function(){return g.getIsDrawing()},this.getElement=function(){return p}},r)}),s("jlrk1",function(e,t){e.exports=i("fp7H1")}),s("vCnsd",function(i,n){e(i.exports,"chemyBrushUi",function(){return v});var r,s=o("eWjiX"),a=o("7NTKy"),l=o("7bWhB"),h=o("dAXbp"),c=o("aP0jf"),u=o("5XUTp"),p=o("iFIyy"),d=o("cmnov"),g=o("1mH1z"),f=o("7jh4K"),v=(r={image:t(u),tooltip:(0,g.LANG)("brush-chemy"),sizeSlider:{min:.25,max:25,curve:s.BB.powerSplineInput(.25,25,.1),isDisabled:!0},opacitySlider:{min:.01,max:1}},g.LANGUAGE_STRINGS.subscribe(function(){r.tooltip=(0,g.LANG)("brush-chemy")}),r.Ui=function(e){var t,i,n,o,u,v,m,y,x,b,w=document.createElement("div"),B=new h.BRUSHES.ChemyBrush;function k(e){B.setSize(e)}B.setHistory(e.klHistory),e.onSizeChange(B.getSize()),y=new(0,c.KlSlider)({label:(0,g.LANG)("brush-size"),width:250,height:30,min:r.sizeSlider.min,max:r.sizeSlider.max,value:B.getSize(),curve:r.sizeSlider.curve,eventResMs:a.EVENT_RES_MS,isEnabled:"stroke"===B.getMode(),toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){k(t),e.onSizeChange(t)},formatFunc:function(e){return e<5?s.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),x=new(0,c.KlSlider)({label:(0,g.LANG)("opacity"),width:250,height:30,min:r.opacitySlider.min,max:r.opacitySlider.max,value:B.getOpacity(),eventResMs:a.EVENT_RES_MS,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){B.setOpacity(t),e.onOpacityChange(t)}}),(0,f.css)(x.getElement(),{marginTop:"10px"}),b=new(0,l.Checkbox)({init:B.getIsEraser(),label:(0,g.LANG)("eraser"),callback:function(e){B.setIsEraser(e)},css:{marginTop:"10px",marginLeft:"10px"},name:"eraser-toggle"}),t=new(0,l.Checkbox)({init:B.getLockAlpha(),label:(0,g.LANG)("lock-alpha"),callback:function(e){B.setLockAlpha(e)},doHighlight:!0,title:(0,g.LANG)("lock-alpha-title"),css:{marginTop:"10px"},name:"lock-alpha-toggle"}),i=s.BB.el({css:{display:"flex",marginTop:"10px"}}),n=new(0,p.Options)({optionArr:[{id:"fill",label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"#000",css:{transformOrigin:"0 0",transform:"translate(-0.5px, -0.5px) scale(19, 19) translate(0.5px, 0.5px)"},d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:(0,g.LANG)("brush-chemy-fill")},{id:"stroke",label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",css:{strokeWidth:"0.12px",transformOrigin:"0 0",transform:"translate(-0.5px, -0.5px) scale(19, 19) translate(0.5px, 0.5px)"},d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:(0,g.LANG)("brush-chemy-stroke")}],initId:B.getMode(),onChange:function(t){B.setMode(t),r.sizeSlider.isDisabled="fill"===B.getMode(),y.setIsEnabled(!r.sizeSlider.isDisabled);var i=B.getSize();y.setValue(i),e.onSizeChange(i),e.onConfigChange()}}),o=new(0,d.BoxToggle)({label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",css:{strokeWidth:"1px"},d:`M ${17.5},8 ${17.5},${27}`}]}),title:(0,g.LANG)("brush-chemy-mirror-x"),init:B.getXSymmetry(),onChange:function(e){B.setXSymmetry(e)}}),u=new(0,d.BoxToggle)({label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",css:{strokeWidth:"1px"},d:`M 8,${17.5} ${27},${17.5}`}]}),title:(0,g.LANG)("brush-chemy-mirror-y"),init:B.getYSymmetry(),onChange:function(e){B.setYSymmetry(e)}}),v=new(0,d.BoxToggle)({label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"defs",childrenArr:[{elementType:"linearGradient",id:"gradient",x1:"0",y1:"0",x2:"0",y2:"1",childrenArr:[{elementType:"stop",offset:"0%","stop-color":"rgba(0,0,0,0)"},{elementType:"stop",offset:"100%","stop-color":"rgba(0,0,0,1)"}]}]},{elementType:"rect",fill:"url('#gradient')",x:"8",y:"8",width:"19",height:"19"}]}),title:(0,g.LANG)("brush-chemy-gradient"),init:B.getGradient(),onChange:function(e){B.setGradient(e)}}),(0,f.css)(o.getElement(),{marginLeft:"10px"}),m={marginLeft:"4px"},(0,f.css)(u.getElement(),m),(0,f.css)(v.getElement(),m),i.append(n.getElement(),o.getElement(),u.getElement(),v.getElement()),w.append(y.getElement(),x.getElement(),i,s.BB.el({content:[t.getElement(),b.getElement()],css:{display:"flex"}})),this.increaseSize=function(e){B.getIsDrawing()||"stroke"!==B.getMode()||y.changeSliderValue(e)},this.decreaseSize=function(e){B.getIsDrawing()||"stroke"!==B.getMode()||y.changeSliderValue(-e)},this.getSize=function(){return B.getSize()},this.setSize=function(e){k(e),y.setValue(e)},this.getOpacity=function(){return B.getOpacity()},this.setOpacity=function(e){B.setOpacity(e),x.setValue(e)},this.setColor=function(e){B.setColor(e)},this.setLayer=function(e){B.setContext(e.context)},this.startLine=function(e,t,i){B.startLine(e,t)},this.goLine=function(e,t,i,n){B.goLine(e,t)},this.endLine=function(){B.endLine()},this.getBrush=function(){return B},this.isDrawing=function(){return B.getIsDrawing()},this.toggleEraser=function(){b.setValue(!b.getValue()),B.setIsEraser(b.getValue())},this.getElement=function(){return w}},r)}),s("5XUTp",function(e,t){e.exports=i("eX098")}),s("h62LS",function(t,i){e(t.exports,"showIframeModal",function(){return a});var n=o("eWjiX"),r=o("dLlkc"),s=o("1mH1z");function a(e,t){if(!t&&(window.innerHeight<500||window.innerWidth<700))return void window.open(e);var i,o=n.BB.el({tagName:"iframe",custom:{src:e},css:{width:"100%",height:"100%",opacity:"0"}});setTimeout(function(){o.style.opacity=""},500);var a=n.BB.el();t||(i=n.BB.el({tagName:"a",parent:a,content:(0,s.LANG)("modal-new-tab"),custom:{href:"help",target:"_blank"},onClick:function(){l.close()}}),o.onload=function(){if(i&&o.contentWindow)try{n.BB.setAttributes(i,{href:""+o.contentWindow.location})}catch(e){}o.style.opacity=""});var l=new(0,r.DynamicModal)({title:a,content:o,width:880,isMaxHeight:!0,onClose:function(){i&&(o.src="about:blank",n.BB.destroyEl(i),i=void 0)}})}}),s("fRGIf",function(t,i){e(t.exports,"RadioList",function(){return a});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=function(){"use strict";function e(t){var i=this,r=t.name,o=t.init,a=t.items,l=t.ignoreFocus;(0,n._)(this,e),this.inputs=[],this.el=s.BB.el({className:"kl-radio"}),a.forEach(function(e){var t=s.BB.el({tagName:"label"}),n=s.BB.el({tagName:"input",parent:t,custom:{name:r,value:e.value,type:"radio"}});l&&n.setAttribute("data-ignore-focus","true"),o===e.value&&(n.checked=!0),t.append(e.label),i.el.append(t),i.inputs.push(n)})}return(0,r._)(e,[{key:"getValue",value:function(){for(var e=0;e<this.inputs.length;e++)if(this.inputs[e].checked)return this.inputs[e].value;return null}},{key:"getElement",value:function(){return this.el}}]),e}()}),s("9pcu9",function(i,n){e(i.exports,"BrowserStorageUi",function(){return b});var r=o("1LaJZ"),s=o("cx0mh"),a=o("7h4XF"),l=o("2gUX3"),h=o("eWjiX"),c=o("9N3Nv"),u=o("hrnUX"),p=o("1mH1z"),d=o("2MaaK"),g=o("8mtWV"),f=o("a1hpg"),v=o("kTLdr"),m=o("72Jv0"),y=o("grPaH"),x=o("eIcQa"),b=function(){"use strict";function e(i){var n,r,o=this;if((0,s._)(this,e),this.previewEl={},this.ageEl={},this.emptyEl={},this.storeButtonEl={},this.clearButtonEl={},this.storeListener={},this.isFirst=!0,this.updateAgeInterval=setInterval(function(){return o.updateAge()},6e4),this.projectStore=i.projectStore,this.getProject=i.getProject,this.onStored=i.onStored,this.klRootEl=i.klRootEl,this.applyUncommitted=i.applyUncommitted,this.options=i.options,this.onOpen=i.onOpen,this.rootEl=h.BB.el({}),this.header=new(0,f.BrowserStorageHeaderUi),this.rootEl.append(this.header.getElement()),this.contentEl=h.BB.el({parent:this.rootEl}),!this.projectStore.getIsAvailable())return void this.showError();this.previewEl=h.BB.el({className:"kl-storage-preview",onClick:function(){var e;return null==(e=o.onOpen)?void 0:e.call(o)},title:(0,p.LANG)("file-storage-open"),noRef:!0}),this.emptyEl=h.BB.el({content:(0,p.LANG)("file-storage-empty")}),this.ageEl=h.BB.el({css:{position:"absolute",right:"0",bottom:"0",width:"100%",textAlign:"center",background:"rgba(0,0,0,0.7)",color:"#fff",fontSize:"13px"}}),this.onOpen&&(this.openButtonEl=h.BB.el({tagName:"button",className:"grid-button",content:(0,p.LANG)("file-storage-open"),css:{margin:"0"},onClick:function(){var e;return null==(e=o.onOpen)?void 0:e.call(o)},noRef:!0})),this.storeButtonEl=h.BB.el({tagName:"button",className:"grid-button",content:(0,p.LANG)("file-storage-store"),css:{margin:"0"},onClick:function(){return o.store()},noRef:!0}),this.clearButtonEl=h.BB.el({tagName:"button",className:"grid-button kl-button-delete",content:'<img src="'+t(c)+'" height="20"/> '+(0,p.LANG)("file-storage-clear"),css:{margin:"0"},onClick:function(){return o.clear()},noRef:!0}),(null==(n=this.options)?void 0:n.isFocusable)||(this.openButtonEl&&(0,m.makeUnfocusable)(this.openButtonEl),(0,m.makeUnfocusable)(this.storeButtonEl),(0,m.makeUnfocusable)(this.clearButtonEl)),(null==(r=this.options)?void 0:r.hideClearButton)&&(this.clearButtonEl.style.visibility="hidden"),this.contentEl.append(h.BB.el({content:[h.BB.el({content:this.previewEl,css:{alignSelf:"stretch",flexGrow:"1"}}),h.BB.el({content:[this.openButtonEl,this.storeButtonEl,this.clearButtonEl],css:{display:"flex",gap:"10px",flexDirection:"column"}})],css:{marginTop:"10px",display:"flex",gap:"10px"}})),this.storeListener={onUpdate:function(e){o.updateThumb(null==e?void 0:e.timestamp,null==e?void 0:e.thumbnail)}},this.projectStore.subscribe(this.storeListener),this.updateThumb()}return(0,a._)(e,[{key:"updateAge",value:function(){this.timestamp&&(this.ageEl.textContent=(0,g.timestampToAge)(this.timestamp))}},{key:"resetButtons",value:function(){this.previewEl.classList.remove("kl-storage-preview--disabled"),this.timestamp?(this.openButtonEl&&(this.openButtonEl.disabled=!1),this.storeButtonEl.textContent=(0,p.LANG)("file-storage-overwrite"),this.storeButtonEl.disabled=!1,this.clearButtonEl.disabled=!1):(this.openButtonEl&&(this.openButtonEl.disabled=!0),this.storeButtonEl.textContent=(0,p.LANG)("file-storage-store"),this.storeButtonEl.disabled=!1,this.clearButtonEl.disabled=!0)}},{key:"updateThumb",value:function(e,t){this.timestamp=e,null==(i=this.thumbnail)||i.remove(),this.thumbnail=t?(0,x.copyCanvas)(t):void 0;var i,n=this.thumbnail;if(n&&e){if(n.classList.add("kl-storage-preview__im"),this.ageEl.remove(),this.emptyEl.remove(),this.updateAge(),this.previewEl.append(n,this.ageEl),this.previewEl.style.pointerEvents=this.onOpen?"":"none","undefined"!=typeof performance&&e>performance.timeOrigin){var r=h.BB.el({parent:this.previewEl,className:v.animEl});setTimeout(function(){r.remove()},500)}}else this.ageEl.remove(),this.previewEl.append(this.emptyEl),this.previewEl.style.pointerEvents="none";this.resetButtons()}},{key:"store",value:function(){return(0,r._)(function(){var e,t,i;return(0,l.__generator)(this,function(n){switch(n.label){case 0:if(e=this.projectStore.getCurrentMeta(),t=this.getProject(),!(e&&e.projectId!==t.projectId))return[3,2];return[4,new Promise(function(e,t){(0,d.showModal)({target:document.body,type:"warning",message:(0,p.LANG)("file-storage-overwrite-confirm"),buttons:[(0,p.LANG)("file-storage-overwrite"),"Cancel"],callback:function(t){return(0,r._)(function(){return(0,l.__generator)(this,function(i){return"Cancel"===t?e(!1):e(!0),[2]})})()}})})];case 1:if(!n.sent())return[2];n.label=2;case 2:return this.applyUncommitted(),[4,(0,y.requestPersistentStorage)()];case 3:return n.sent(),this.openButtonEl&&(this.openButtonEl.disabled=!0),this.storeButtonEl.textContent=(0,p.LANG)("file-storage-storing"),this.storeButtonEl.disabled=!0,this.clearButtonEl.disabled=!0,this.previewEl.classList.add("kl-storage-preview--disabled"),[4,new Promise(function(e){setTimeout(function(){return e(null)},20)})];case 4:n.sent(),n.label=5;case 5:return n.trys.push([5,7,,8]),[4,this.projectStore.store(t)];case 6:return n.sent(),this.onStored(),[3,8];case 7:return i=n.sent(),this.resetButtons(),u.KL.popup({target:this.klRootEl,type:"error",message:`${(0,p.LANG)("file-storage-failed-1")}<ul><li>${(0,p.LANG)("file-storage-failed-2")}</li><li>${(0,p.LANG)("file-storage-failed-3")}</li><li>${(0,p.LANG)("file-storage-failed-4")}</li></ul>`,buttons:["Ok"]}),setTimeout(function(){throw Error("storage-ui: failed to store browser storage, "+i)},0),[3,8];case 8:return[2]}})}).call(this)}},{key:"clear",value:function(){return(0,r._)(function(){var e;return(0,l.__generator)(this,function(t){return e=this,(0,d.showModal)({target:document.body,type:"warning",message:(0,p.LANG)("file-storage-clear-prompt"),buttons:[(0,p.LANG)("file-storage-clear"),"Cancel"],deleteButtonName:(0,p.LANG)("file-storage-clear"),callback:function(t){return(0,r._)(function(){var e;return(0,l.__generator)(this,function(i){switch(i.label){case 0:if("Cancel"===t)return[2];this.openButtonEl&&(this.openButtonEl.disabled=!0),this.storeButtonEl.disabled=!0,this.clearButtonEl.disabled=!0,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.projectStore.clear()];case 2:return i.sent(),[3,4];case 3:return e=i.sent(),this.resetButtons(),u.KL.popup({target:this.klRootEl,type:"error",message:(0,p.LANG)("file-storage-failed-clear"),buttons:["Ok"]}),setTimeout(function(){throw Error("storage-ui: failed to clear browser storage, "+e)},0),[3,4];case 4:return[2]}})}).call(e)}}),[2]})}).call(this)}},{key:"showError",value:function(){this.contentEl.innerHTML="",h.BB.el({parent:this.contentEl,content:"\uD83D\uDD34 "+(0,p.LANG)("file-storage-cant-access"),css:{marginTop:"10px"}})}},{key:"getElement",value:function(){return this.rootEl}},{key:"show",value:function(){this.isFirst&&(this.isFirst=!1,this.projectStore.getIsAvailable()?(0,r._)(function(){var e,t;return(0,l.__generator)(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this.projectStore.update()];case 1:return i.sent(),(e=this.projectStore.getCurrentMeta())?this.updateThumb(e.timestamp,e.thumbnail):this.updateThumb(),[3,3];case 2:throw t=i.sent(),this.showError(),Error("browser-storage-ui: failed initial read browser storage, "+t);case 3:return[2]}})}).call(this):this.showError())}},{key:"hide",value:function(){}},{key:"destroy",value:function(){this.header.destroy(),h.BB.destroyEl(this.storeButtonEl),h.BB.destroyEl(this.clearButtonEl),clearInterval(this.updateAgeInterval),this.projectStore.unsubscribe(this.storeListener)}}]),e}()}),s("8mtWV",function(t,i){e(t.exports,"timestampToAge",function(){return r});var n=o("1mH1z");function r(e){var t,i=new Date().getTime()-e;return i=Math.floor(i/1e3/60),t=(0,n.LANG)("file-storage-min-ago").replace("{x}",""+i),i>60&&(i=Math.floor(i/60),t=(0,n.LANG)("file-storage-hours-ago").replace("{x}",""+i),i>24&&(i=Math.floor(i/24),t=(0,n.LANG)("file-storage-days-ago").replace("{x}",""+i),i>31&&(t=(0,n.LANG)("file-storage-month-ago")))),t}}),s("a1hpg",function(t,i){e(t.exports,"BrowserStorageHeaderUi",function(){return h});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("1mH1z"),l=o("h62LS"),h=function(){"use strict";function e(){(0,n._)(this,e),this.infoButton=s.BB.el({content:"?",className:"kl-info-btn",title:(0,a.LANG)("file-storage-about"),onClick:function(){(0,l.showIframeModal)("./help/#help-browser-storage",!1)}}),this.rootEl=s.BB.el({content:(0,a.LANG)("file-storage"),css:{display:"flex",margin:"-5px 0",gap:"6px"}}),this.rootEl.append(this.infoButton)}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"show",value:function(){}},{key:"destroy",value:function(){s.BB.destroyEl(this.infoButton)}}]),e}()}),s("kTLdr",function(t,i){var n,r;e(t.exports,"anim",function(){return n},function(e){return n=e}),e(t.exports,"animEl",function(){return r},function(e){return r=e}),n="a9LdEW_anim",r="a9LdEW_animEl"}),s("grPaH",function(t,i){e(t.exports,"requestPersistentStorage",function(){return s});var n=o("1LaJZ"),r=o("2gUX3");function s(){return(0,n._)(function(){return(0,r.__generator)(this,function(e){switch(e.label){case 0:if(!("storage"in navigator&&"persist"in navigator.storage))return[3,2];return[4,navigator.storage.persist()];case 1:e.sent(),e.label=2;case 2:return[2]}})})()}}),s("6mTnI",function(t,i){e(t.exports,"isTImageDataReference",function(){return v}),e(t.exports,"ProjectStore",function(){return y});var n=o("1LaJZ"),r=o("cx0mh"),s=o("7h4XF"),a=o("cL71g"),l=o("4EWN2"),h=o("2gUX3"),c=o("3hwQ7"),u=o("6l0gQ"),p=o("jTg9g"),d=o("7jh4K"),g=o("eWjiX"),f=o("eIcQa");function v(e){return"object"==typeof e&&null!==e&&"id"in e&&"string"==typeof e.id}function m(){return(0,n._)(function(){return(0,h.__generator)(this,function(e){switch(e.label){case 0:return[4,(0,f.canvasToBlob)(g.BB.canvas(c.PROJECT_STORE_THUMBNAIL_SIZE_PX,c.PROJECT_STORE_THUMBNAIL_SIZE_PX),"image/png")];case 1:return[2,e.sent()]}})})()}var y=function(){"use strict";function e(){var t=this;if((0,r._)(this,e),this.listeners=[],this.isAvailable=!0,!p.KL_INDEXED_DB.getIsAvailable()){this.isAvailable=!1;return}window.addEventListener("storage",function(e){return(0,n._)(function(){return(0,h.__generator)(this,function(t){switch(t.label){case 0:if("indexedDbUpdatedAt"!==e.key||0===this.listeners.length)return[2];return[4,this.update()];case 1:return t.sent(),[2]}})}).call(t)})}return(0,s._)(e,[{key:"lowLevelStore",value:function(e){return(0,n._)(function(){var t,i,n,r,o,s,c,u,g,f,m,y,x,b,w,B,k,S,C,E,L,I,T,A,M,R,_,P,D,N,O,G;return(0,h.__generator)(this,function(h){switch(h.label){case 0:return[4,p.KL_INDEXED_DB.get(p.BROWSER_STORAGE_STORE,1)];case 1:if(t=h.sent(),i=[],t){v(t.thumbnail)&&i.push(t.thumbnail.id),n=!0,r=!1,o=void 0;try{for(s=t.layers[Symbol.iterator]();!(n=(c=s.next()).done);n=!0)u=c.value,v(u.blob)&&i.push(u.blob.id)}catch(e){r=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw o}}}g=[],f={id:(0,d.randomUuid)()},g.push({id:f.id,data:e.thumbnail}),m=[],y=!0,x=!1,b=void 0;try{for(w=e.layers[Symbol.iterator]();!(y=(B=w.next()).done);y=!0)k=B.value,S={id:(0,d.randomUuid)()},g.push({id:S.id,data:k.blob}),m.push((0,l._)((0,a._)({},k),{blob:S}))}catch(e){x=!0,b=e}finally{try{y||null==w.return||w.return()}finally{if(x)throw b}}C=(0,l._)((0,a._)({},e),{thumbnail:f,layers:m}),E=!0,L=!1,I=void 0,h.label=2;case 2:h.trys.push([2,7,8,9]),T=g[Symbol.iterator](),h.label=3;case 3:if(E=(A=T.next()).done)return[3,6];return M=A.value,[4,p.KL_INDEXED_DB.set(p.IMAGE_DATA_STORE,M.id,M.data)];case 4:h.sent(),h.label=5;case 5:return E=!0,[3,3];case 6:return[3,9];case 7:return R=h.sent(),L=!0,I=R,[3,9];case 8:try{E||null==T.return||T.return()}finally{if(L)throw I}return[7];case 9:return[4,p.KL_INDEXED_DB.set(p.BROWSER_STORAGE_STORE,void 0,C)];case 10:h.sent(),_=!0,P=!1,D=void 0,h.label=11;case 11:h.trys.push([11,16,17,18]),N=i[Symbol.iterator](),h.label=12;case 12:if(_=(O=N.next()).done)return[3,15];return G=O.value,[4,p.KL_INDEXED_DB.remove(p.IMAGE_DATA_STORE,G)];case 13:h.sent(),h.label=14;case 14:return _=!0,[3,12];case 15:return[3,18];case 16:return R=h.sent(),P=!0,D=R,[3,18];case 17:try{_||null==N.return||N.return()}finally{if(P)throw D}return[7];case 18:return[2]}})})()}},{key:"lowLevelReadMeta",value:function(){return(0,n._)(function(){var e,t,i,n,r;return(0,h.__generator)(this,function(o){switch(o.label){case 0:return[4,p.KL_INDEXED_DB.get(p.BROWSER_STORAGE_STORE,1)];case 1:if(!(e=o.sent()))return[2,void 0];if(!v(e.thumbnail))return[3,3];return[4,p.KL_INDEXED_DB.get(p.IMAGE_DATA_STORE,e.thumbnail.id)];case 2:return i=o.sent(),(0,d.isBlob)(i)&&(t=i),[3,4];case 3:t=e.thumbnail,o.label=4;case 4:if(null==t)return[3,5];return n=t,[3,7];case 5:return[4,m()];case 6:n=o.sent(),o.label=7;case 7:return t=n,[2,{projectId:null!=(r=e.projectId)?r:(0,d.randomUuid)(),timestamp:e.timestamp,thumbnail:t}]}})})()}},{key:"lowLevelRead",value:function(){return(0,n._)(function(){var e,t,i,n,r,o,s,c,u,g,f,y,x,b,w,B,k;return(0,h.__generator)(this,function(h){switch(h.label){case 0:return[4,p.KL_INDEXED_DB.get(p.BROWSER_STORAGE_STORE,1)];case 1:if(!(e=h.sent()))return[2,void 0];if(!v(e.thumbnail))return[3,3];return[4,p.KL_INDEXED_DB.get(p.IMAGE_DATA_STORE,e.thumbnail.id)];case 2:return i=h.sent(),(0,d.isBlob)(i)&&(t=i),[3,4];case 3:t=e.thumbnail,h.label=4;case 4:if(null==t)return[3,5];return n=t,[3,7];case 5:return[4,m()];case 6:n=h.sent(),h.label=7;case 7:t=n,r=[],o=!0,s=!1,c=void 0,h.label=8;case 8:h.trys.push([8,15,16,17]),u=e.layers[Symbol.iterator](),h.label=9;case 9:if(o=(g=u.next()).done)return[3,14];if(f=g.value,y=void 0,!v(f.blob))return[3,11];return[4,p.KL_INDEXED_DB.get(p.IMAGE_DATA_STORE,f.blob.id)];case 10:return x=h.sent(),(0,d.isBlob)(x)&&(y=x),[3,12];case 11:y=f.blob,h.label=12;case 12:r.push((0,l._)((0,a._)({},f),{isVisible:null==(b=f.isVisible)||b,mixModeStr:null!=(w=f.mixModeStr)?w:"source-over",blob:y})),h.label=13;case 13:return o=!0,[3,9];case 14:return[3,17];case 15:return B=h.sent(),s=!0,c=B,[3,17];case 16:try{o||null==u.return||u.return()}finally{if(s)throw c}return[7];case 17:return[2,(0,l._)((0,a._)({},e),{projectId:null!=(k=e.projectId)?k:(0,d.randomUuid)(),thumbnail:t,layers:r})]}})})()}},{key:"lowLevelClear",value:function(){return(0,n._)(function(){var e,t,i,n,r,o,s,a,l,c,u,d,g,f,m;return(0,h.__generator)(this,function(h){switch(h.label){case 0:return[4,p.KL_INDEXED_DB.get(p.BROWSER_STORAGE_STORE,1)];case 1:if(e=h.sent(),t=[],e){v(e.thumbnail)&&t.push(e.thumbnail.id),i=!0,n=!1,r=void 0;try{for(o=e.layers[Symbol.iterator]();!(i=(s=o.next()).done);i=!0)a=s.value,v(a.blob)&&t.push(a.blob.id)}catch(e){n=!0,r=e}finally{try{i||null==o.return||o.return()}finally{if(n)throw r}}}return[4,p.KL_INDEXED_DB.remove(p.BROWSER_STORAGE_STORE,1)];case 2:h.sent(),l=!0,c=!1,u=void 0,h.label=3;case 3:h.trys.push([3,8,9,10]),d=t[Symbol.iterator](),h.label=4;case 4:if(l=(g=d.next()).done)return[3,7];return f=g.value,[4,p.KL_INDEXED_DB.remove(p.IMAGE_DATA_STORE,f)];case 5:h.sent(),h.label=6;case 6:return l=!0,[3,4];case 7:return[3,10];case 8:return m=h.sent(),c=!0,u=m,[3,10];case 9:try{l||null==d.return||d.return()}finally{if(c)throw u}return[7];case 10:return[2]}})})()}},{key:"emit",value:function(e){this.currentMeta=e?(0,a._)({},e):void 0,this.listeners.forEach(function(t){t.onUpdate(e)})}},{key:"updateTimestamp",value:function(){u.LocalStorage.setItem("indexedDbUpdatedAt",""+new Date().getTime())}},{key:"update",value:function(){return(0,n._)(function(){var e,t,i;return(0,h.__generator)(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),t=(e=this).emit,[4,this.readMeta()];case 1:return t.apply(e,[n.sent()]),[3,3];case 2:return(i=n.sent())instanceof Error&&0===i.message.indexOf("db-error")&&(this.isAvailable=!1),[3,3];case 3:return[2]}})}).call(this)}},{key:"read",value:function(){return(0,n._)(function(){var e,t,i;return(0,h.__generator)(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.lowLevelRead()];case 1:return e=n.sent(),[3,3];case 2:throw t=n.sent(),this.isAvailable=!1,Error("db-error: "+t);case 3:if(!e)return[2,void 0];n.label=4;case 4:return n.trys.push([4,6,,7]),[4,c.ProjectConverter.readStorageProject(e)];case 5:return i=n.sent(),[3,7];case 6:throw Error("format-error: "+n.sent());case 7:return[2,i]}})}).call(this)}},{key:"readMeta",value:function(){return(0,n._)(function(){var e,t,i;return(0,h.__generator)(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.lowLevelReadMeta()];case 1:return e=n.sent(),[3,3];case 2:throw t=n.sent(),this.isAvailable=!1,Error("db-error: "+t);case 3:if(!e)return[2,void 0];n.label=4;case 4:return n.trys.push([4,6,,7]),[4,c.ProjectConverter.readStorageMeta(e)];case 5:return i=n.sent(),[3,7];case 6:throw Error("format-error: "+n.sent());case 7:return[2,i]}})}).call(this)}},{key:"store",value:function(e){return(0,n._)(function(){var t,i,r;return(0,h.__generator)(this,function(o){switch(o.label){case 0:t=this,o.label=1;case 1:return o.trys.push([1,4,,5]),[4,c.ProjectConverter.createStorageProject(e)];case 2:return i=o.sent(),[4,this.lowLevelStore(i)];case 3:return o.sent(),[3,5];case 4:throw r=o.sent(),this.isAvailable=!1,Error("db-error: "+r);case 5:return this.updateTimestamp(),setTimeout(function(){return(0,n._)(function(){var e;return(0,h.__generator)(this,function(t){switch(t.label){case 0:return[4,this.readMeta()];case 1:return e=t.sent(),this.emit(e),[2]}})}).call(t)}),[2]}})}).call(this)}},{key:"clear",value:function(){return(0,n._)(function(){var e;return(0,h.__generator)(this,function(t){switch(t.label){case 0:return e=this,[4,this.lowLevelClear()];case 1:return t.sent(),this.updateTimestamp(),setTimeout(function(){return e.emit()},0),[2]}})}).call(this)}},{key:"subscribe",value:function(e){this.listeners.includes(e)||this.listeners.push(e)}},{key:"unsubscribe",value:function(e){for(var t=0;t<this.listeners.length;t++)if(e===this.listeners[t])return void this.listeners.splice(t,1)}},{key:"getIsAvailable",value:function(){return this.isAvailable=this.isAvailable&&p.KL_INDEXED_DB.getIsAvailable(),this.isAvailable}},{key:"getCurrentMeta",value:function(){return this.currentMeta}}]),e}()}),s("3hwQ7",function(t,i){e(t.exports,"PROJECT_STORE_THUMBNAIL_SIZE_PX",function(){return u}),e(t.exports,"loadImage",function(){return p}),e(t.exports,"ProjectConverter",function(){return d});var n=o("1LaJZ"),r=o("cx0mh"),s=o("7h4XF"),a=o("2gUX3"),l=o("eWjiX"),h=o("aSJRf"),c=o("eIcQa"),u=240;function p(e){return new Promise(function(t,i){var n=new Image;try{n.src=l.BB.imageBlobToUrl(e)}catch(e){i("imageBlobToUrl, "+(e instanceof Error?e.message:""));return}n.onload=function(){URL.revokeObjectURL(n.src),t(n)},n.onabort=function(){URL.revokeObjectURL(n.src),i("layer image failed loading (abort)")},n.onerror=function(){URL.revokeObjectURL(n.src),i("layer image failed loading (error)")}})}var d=function(){"use strict";function e(){(0,r._)(this,e)}return(0,s._)(e,null,[{key:"createThumbnail",value:function(e){var t=l.BB.fitInto(e.width,e.height,u,u).width/e.width;return(0,h.drawProject)(e,t)}},{key:"createStorageProject",value:function(t){return(0,n._)(function(){var i,n,r,o,s,l,h,u,p,d,g;return(0,a.__generator)(this,function(a){switch(a.label){case 0:i=[],n=!0,r=!1,o=void 0,a.label=1;case 1:a.trys.push([1,8,9,10]),s=t.layers[Symbol.iterator](),a.label=2;case 2:if(n=(l=s.next()).done)return[3,7];if(h=l.value,u=void 0,!(h.image instanceof HTMLCanvasElement))return[3,4];return[4,(0,c.canvasToBlob)(h.image,"image/png")];case 3:return u=a.sent(),[3,5];case 4:throw Error("Not implemented");case 5:i.push({name:h.name,isVisible:h.isVisible,opacity:h.opacity,mixModeStr:null!=(p=h.mixModeStr)?p:"source-over",blob:u}),a.label=6;case 6:return n=!0,[3,2];case 7:return[3,10];case 8:return d=a.sent(),r=!0,o=d,[3,10];case 9:try{n||null==s.return||s.return()}finally{if(r)throw o}return[7];case 10:return g={id:1,projectId:t.projectId,timestamp:new Date().getTime()},[4,(0,c.canvasToBlob)(e.createThumbnail(t),"image/png")];case 11:return[2,(g.thumbnail=a.sent(),g.width=t.width,g.height=t.height,g.layers=i,g)]}})})()}},{key:"readStorageProject",value:function(e){return(0,n._)(function(){var t,i;return(0,a.__generator)(this,function(n){switch(n.label){case 0:if(!e.width||!e.height||isNaN(e.width)||isNaN(e.height)||e.width<1||e.height<1)throw Error("readStorageProject invalid canvas size: "+e.width+", "+e.height);return t={projectId:e.projectId,width:e.width,height:e.height},[4,Promise.all(e.layers.map(function(t){return t.blob?p(t.blob).catch(function(){return new Image(e.width,e.height)}):new Image(e.width,e.height)}))];case 1:return t.layers=n.sent().map(function(t,i){var n=e.layers[i];return{name:n.name,isVisible:n.isVisible,opacity:n.opacity,mixModeStr:n.mixModeStr,image:t}}),i={project:t,timestamp:e.timestamp},[4,p(e.thumbnail).catch(function(){return new Image(u,u)})];case 2:return[2,(i.thumbnail=n.sent(),i)]}})})()}},{key:"readStorageMeta",value:function(e){return(0,n._)(function(){var t,i;return(0,a.__generator)(this,function(n){switch(n.label){case 0:if(t={projectId:e.projectId,timestamp:e.timestamp},!e.thumbnail)return[3,2];return[4,p(e.thumbnail).catch(function(){return new Image(u,u)})];case 1:return i=n.sent(),[3,3];case 2:i=l.BB.canvas(10,10),n.label=3;case 3:return[2,(t.thumbnail=i,t)]}})})()}}]),e}()}),s("jTg9g",function(t,i){e(t.exports,"RECOVERY_STORE",function(){return r}),e(t.exports,"IMAGE_DATA_STORE",function(){return s}),e(t.exports,"BROWSER_STORAGE_STORE",function(){return a}),e(t.exports,"KL_INDEXED_DB",function(){return l});var n=o("hzsIx"),r="RecoveryStore",s="ImageDataStore",a="ProjectStore",l=new(0,n.IndexedDb)({})}),s("hzsIx",function(t,i){e(t.exports,"IndexedDb",function(){return c});var n=o("1LaJZ"),r=o("cx0mh"),s=o("7h4XF"),a=o("bX4ja"),l=o("2gUX3"),h=o("7jh4K"),c=function(){"use strict";function e(t){(0,r._)(this,e),this.dbVersion=-1,this.dbName="",this.storeNames=[],this.upgrader=function(){},this.isAvailable=!0,this.openTransactionCount=0}return(0,s._)(e,[{key:"disconnect",value:function(){var e;null==(e=this.db)||e.close(),this.db=void 0}},{key:"autoDisconnectWrapper",value:function(e){return(0,n._)(function(){var t;return(0,l.__generator)(this,function(i){switch(i.label){case 0:t=this,i.label=1;case 1:return i.trys.push([1,,3,4]),this.openTransactionCount++,clearTimeout(this.disconnectTimeout),[4,e()];case 2:return[2,i.sent()];case 3:return this.openTransactionCount--,0===this.openTransactionCount&&(clearTimeout(this.disconnectTimeout),this.disconnectTimeout=setTimeout(function(){return t.disconnect()},1e3)),[7];case 4:return[2]}})}).call(this)}},{key:"openDb",value:function(){return(0,n._)(function(){var e;return(0,l.__generator)(this,function(t){return(e=this,this.db)?[2]:[2,new Promise(function(t,i){var n=indexedDB.open(e.dbName,e.dbVersion);n.onupgradeneeded=function(t){e.upgrader(t)},n.onsuccess=function(i){e.db=i.target.result,e.db.onversionchange=function(){throw e.isAvailable=!1,e.disconnect(),Error("idb onversionchange")},t()},n.onerror=function(t){e.isAvailable=!1,i(t.target.error)}})]})}).call(this)}},{key:"getTransaction",value:function(e,t){if(!this.storeNames.includes(e))throw Error(`indexedDb store "${e}" not found in "${this.dbName}"`);var i=this.db.transaction(e,t);return{transaction:i,objectStore:i.objectStore(e)}}},{key:"init",value:function(e,t,i,n){if(""!==this.dbName)throw Error("IndexedDb already initialized");this.dbName=e,this.storeNames=(0,a._)(t),this.dbVersion=i,this.upgrader=n}},{key:"testConnection",value:function(){return(0,n._)(function(){var e,t,i,r,o,s,a,c,u;return(0,l.__generator)(this,function(p){switch(p.label){case 0:if(e=this,!(t=this.isAvailable))return[3,2];return[4,(0,n._)(function(){var e,t,i,n;return(0,l.__generator)(this,function(r){switch(r.label){case 0:e=!0,t="kl-blob-url-test",r.label=1;case 1:return r.trys.push([1,4,,5]),i=new Blob(["test"],{type:"text/plain"}),[4,(0,h.timeoutWrapper)(new Promise(function(e,i){var n=indexedDB.open(t,1);n.onerror=function(){return i(n.error)},n.onsuccess=function(){return e(n.result)},n.onupgradeneeded=function(e){e.target.result.createObjectStore("testStore")}}),"areBlobUrlsSupported.createDb")];case 2:return n=r.sent(),[4,(0,h.timeoutWrapper)(new Promise(function(e,t){var r=n.transaction("testStore","readwrite"),o=r.objectStore("testStore").put(i,"testStore");r.onabort=function(){return e()},o.onsuccess=function(){return e()},o.onerror=function(){return t(o.error)}}),"areBlobUrlsSupported.storeBlob")];case 3:return r.sent(),n.close(),[3,5];case 4:return r.sent(),e=!1,[3,5];case 5:try{indexedDB.deleteDatabase(t)}catch(e){}return[2,e]}})})()];case 1:t=p.sent(),p.label=2;case 2:if(e.isAvailable=t,!this.isAvailable)return[2,this.isAvailable];p.label=3;case 3:p.trys.push([3,12,,13]),i=!0,r=!1,o=void 0,p.label=4;case 4:p.trys.push([4,9,10,11]),s=this.storeNames[Symbol.iterator](),p.label=5;case 5:if(i=(a=s.next()).done)return[3,8];return c=a.value,[4,(0,h.timeoutWrapper)(this.openDb(),"indexed-db.testConnection.openDb")];case 6:p.sent(),this.getTransaction(c,"readonly").transaction.abort(),p.label=7;case 7:return i=!0,[3,5];case 8:return[3,11];case 9:return u=p.sent(),r=!0,o=u,[3,11];case 10:try{i||null==s.return||s.return()}finally{if(r)throw o}return[7];case 11:return[3,13];case 12:return p.sent(),this.isAvailable=!1,[3,13];case 13:return[2,this.isAvailable]}})}).call(this)}},{key:"set",value:function(e,t,i){return(0,n._)(function(){var r;return(0,l.__generator)(this,function(o){return r=this,[2,this.autoDisconnectWrapper(function(){return(0,n._)(function(){var n;return(0,l.__generator)(this,function(r){switch(r.label){case 0:return n=this,[4,this.openDb()];case 1:return r.sent(),[4,new Promise(function(r,o){var s=n.getTransaction(e,"readwrite"),a=s.transaction,l=s.objectStore;a.onabort=function(){return o(a.error)};var h=l.put(i,t);h.onsuccess=function(){r()},h.onerror=function(){return o(h.error)}})];case 2:return[2,r.sent()]}})}).call(r)})]})}).call(this)}},{key:"get",value:function(e,t){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(r){return i=this,[2,this.autoDisconnectWrapper(function(){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(n){switch(n.label){case 0:return i=this,[4,this.openDb()];case 1:return n.sent(),[4,new Promise(function(n,r){var o=i.getTransaction(e,"readonly"),s=o.transaction,a=o.objectStore;s.onabort=function(){return r(s.error)};var l=a.get(t);l.onsuccess=function(){return n(l.result)},l.onerror=function(){return r(l.error)}})];case 2:return[2,n.sent()]}})}).call(i)})]})}).call(this)}},{key:"has",value:function(e,t){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(r){return i=this,[2,this.autoDisconnectWrapper(function(){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(n){switch(n.label){case 0:return i=this,[4,this.openDb()];case 1:return n.sent(),[4,new Promise(function(n,r){var o=i.getTransaction(e,"readonly"),s=o.transaction,a=o.objectStore;s.onabort=function(){return r(s.error)};var l=a.getKey(t);l.onsuccess=function(){return n(!!l.result)},l.onerror=function(){return r(l.error)}})];case 2:return[2,n.sent()]}})}).call(i)})]})}).call(this)}},{key:"getKeys",value:function(e){return(0,n._)(function(){var t;return(0,l.__generator)(this,function(i){return t=this,[2,this.autoDisconnectWrapper(function(){return(0,n._)(function(){var t;return(0,l.__generator)(this,function(i){switch(i.label){case 0:return t=this,[4,this.openDb()];case 1:return i.sent(),[4,new Promise(function(i,n){var r=t.getTransaction(e,"readonly"),o=r.transaction,s=r.objectStore;o.onabort=function(){return n(o.error)};var a=s.getAllKeys();a.onsuccess=function(){return i(a.result.map(function(e){return e.toString()}))},a.onerror=function(){return n(a.error)}})];case 2:return[2,i.sent()]}})}).call(t)})]})}).call(this)}},{key:"remove",value:function(e,t){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(r){return i=this,[2,this.autoDisconnectWrapper(function(){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(n){switch(n.label){case 0:return i=this,[4,this.openDb()];case 1:return n.sent(),[4,new Promise(function(n,r){var o=i.getTransaction(e,"readwrite"),s=o.transaction,a=o.objectStore;s.onabort=function(){return r(s.error)};var l=a.delete(t);l.onsuccess=function(){n()},l.onerror=function(){return r(l.error)}})];case 2:return[2,n.sent()]}})}).call(i)})]})}).call(this)}},{key:"bulkSet",value:function(e,t){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(r){return i=this,[2,this.autoDisconnectWrapper(function(){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(n){switch(n.label){case 0:return i=this,[4,this.openDb()];case 1:return n.sent(),[2,new Promise(function(n,r){var o=i.getTransaction(e,"readwrite"),s=o.transaction,a=o.objectStore;s.onabort=function(){return r(s.error)},s.onerror=function(){return r(s.error)},s.oncomplete=function(){return n()};var l=!0,h=!1,c=void 0;try{for(var u,p=t[Symbol.iterator]();!(l=(u=p.next()).done);l=!0)!function(){var e=u.value,t=e.key,i=e.value,n=a.put(i,t);n.onerror=function(){return r(n.error)}}()}catch(e){h=!0,c=e}finally{try{l||null==p.return||p.return()}finally{if(h)throw c}}})]}})}).call(i)})]})}).call(this)}},{key:"bulkGet",value:function(e,t){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(r){return i=this,[2,this.autoDisconnectWrapper(function(){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(n){switch(n.label){case 0:return i=this,[4,this.openDb()];case 1:return n.sent(),[2,new Promise(function(n,r){var o={},s=i.getTransaction(e,"readonly"),a=s.transaction,l=s.objectStore;a.onabort=function(){return r(a.error)},a.onerror=function(){return r(a.error)},a.oncomplete=function(){return n(o)},t.forEach(function(e,t){var i=l.get(e);i.onsuccess=function(){return o[""+e]=i.result},i.onerror=function(){return r(i.error)}})})]}})}).call(i)})]})}).call(this)}},{key:"bulkRemove",value:function(e,t){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(r){return i=this,[2,this.autoDisconnectWrapper(function(){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(n){switch(n.label){case 0:return i=this,[4,this.openDb()];case 1:return n.sent(),[2,new Promise(function(n,r){var o=i.getTransaction(e,"readwrite"),s=o.transaction,a=o.objectStore;s.onabort=function(){return r(s.error)},s.onerror=function(){return r(s.error)},s.oncomplete=function(){return n()};var l=!0,h=!1,c=void 0;try{for(var u,p=t[Symbol.iterator]();!(l=(u=p.next()).done);l=!0)!function(){var e=u.value,t=a.delete(e);t.onerror=function(){return r(t.error)}}()}catch(e){h=!0,c=e}finally{try{l||null==p.return||p.return()}finally{if(h)throw c}}})]}})}).call(i)})]})}).call(this)}},{key:"getIsAvailable",value:function(){return this.isAvailable}},{key:"destroy",value:function(){this.disconnect()}}]),e}()}),s("6LAlx",function(i,n){e(i.exports,"FileUi",function(){return I});var r=o("1LaJZ"),s=o("cx0mh"),a=o("7h4XF"),l=o("bX4ja"),h=o("2gUX3"),c=o("eWjiX"),u=o("hrnUX"),p=o("9pcu9"),d=o("1mH1z"),g=o("a1LdA"),f=o("aCdZo"),v=o("8VP9O"),m=o("l5goW"),y=o("k5MuS"),x=o("7bWhB"),b=o("6l0gQ"),w=o("beXZZ"),B=o("4x7Mh"),k=o("a1hpg"),S=o("7jh4K"),C="kl-save-dialog",E=function(){var e=document.createElement("div"),t=document.createElement("div"),i=c.BB.el({className:"grid-hr"});return e.append(t,i),(0,S.css)(t,{clear:"both"}),e},L=function(e,t,i){return`<img ${i?'class="dark-no-invert"':""} src='${t}' alt='icon' height='20'/>${e}`},I=function(){"use strict";function e(i){var n=this;(0,s._)(this,e),this.recoveryListener=function(e){if(n.recoveryCountBubble){var t=e.length;0===t?n.recoveryCountBubble.style.display="none":(n.recoveryCountBubble.textContent=""+t,n.recoveryCountBubble.style.display="inline-block")}},this.exportType=i.exportType,this.applyUncommitted=i.applyUncommitted,this.rootEl=document.createElement("div"),setTimeout(function(){var e,o,s=c.BB.el({className:"kl-toolspace-note",textContent:(0,d.LANG)("file-no-autosave"),css:{margin:"10px 10px 0 10px"}}),a=c.BB.el({tagName:"button",className:"grid-button",content:L((0,d.LANG)("file-new"),t(g),!0),custom:{tabIndex:"-1"},css:{cssFloat:"left"},onClick:function(){return i.onNewImage()}}),I=c.BB.el({tagName:"button",className:"grid-button",content:L((0,d.LANG)("file-import"),t(y),!0),css:{position:"relative",cursor:"pointer",cssFloat:"left"},custom:{tabIndex:"-1"},onClick:function(){return n.importInput.click()}});n.importInput=c.BB.el({tagName:"input",css:{display:"none"},onChange:function(){n.applyUncommitted(),n.importInput.files&&i.onFileSelect(n.importInput.files,"default"),n.importInput.value=""},custom:{tabIndex:"-1"}}),n.importInput.type="file",n.importInput.multiple=!0,n.importInput.accept="image/*,.psd";var T=c.BB.el({tagName:"button",className:"grid-button grid-button--filter",content:L((0,d.LANG)("file-save"),t(f)),custom:{tabIndex:"-1"},css:{cssFloat:"left",flex:"1 0 0",margin:"0"},onClick:function(){return i.onSaveImageToComputer()}}),A="showSaveFilePicker"in window,M=b.LocalStorage.getItem(C),R=null!==M&&"true"===M,_=new(0,x.Checkbox)({init:R,label:(0,d.LANG)("file-show-save-dialog"),callback:function(e){e?b.LocalStorage.setItem(C,"true"):b.LocalStorage.removeItem(C),i.onChangeShowSaveDialog(e)},css:{maxWidth:"fit-content"},name:"show-save-dialog"});i.onChangeShowSaveDialog(R);var P=new u.KL.Select({optionArr:[["png","PNG"],["psd","PSD"],["layers",(0,d.LANG)("layers")+" (PNG)"]],initValue:n.exportType,onChange:function(e){n.exportType=e,i.onExportTypeChange(n.exportType),i.onSaveImageToComputer()},title:(0,d.LANG)("file-format"),name:"export-type"});if((0,S.css)(P.getElement(),{height:"30px",width:"calc(50% - 10px)",flex:"1 0 0"}),i.projectStore)n.browserStorageUi=new(0,p.BrowserStorageUi)({projectStore:i.projectStore,getProject:i.getProject,klRootEl:i.klRootEl,applyUncommitted:n.applyUncommitted,onOpen:i.onOpenBrowserStorage,onStored:function(){return i.onStoredToBrowserStorage()}}),(0,S.css)(n.browserStorageUi.getElement(),{margin:"10px"});else{var D=new(0,k.BrowserStorageHeaderUi);o=c.BB.el({content:[D.getElement(),c.BB.el({content:"\uD83D\uDD34 "+(0,d.LANG)("file-storage-cant-access"),css:{marginTop:"10px"}})],css:{margin:"10px 10px 0 10px"}})}var N=c.BB.el({content:[c.BB.el({content:[T,P.getElement()],css:{display:"flex",gap:"10px"}})].concat((0,l._)(A?[_.getElement()]:[])),css:{display:"flex",flexDirection:"column",gap:"10px",margin:"10px 10px 0 10px"}});n.klRecoveryManager=i.klRecoveryManager;var O=c.BB.el({});n.recoveryCountBubble=c.BB.el({className:B.recoveryBubble});var G=c.BB.el({tagName:"button",content:[(0,d.LANG)("tab-recovery-recover-tabs"),n.recoveryCountBubble],onClick:function(){return(0,w.showRecoveryManagerPanel)(n.klRecoveryManager)},custom:{tabIndex:"-1"},css:{margin:"10px 0 0 10px",width:"calc(100% - 20px)"}});O.append(G,E()),(0,r._)(function(){return(0,h.__generator)(this,function(e){switch(e.label){case 0:if(!this.klRecoveryManager)return[2];return this.klRecoveryManager.subscribe(this.recoveryListener),[4,this.klRecoveryManager.update()];case 1:return e.sent(),this.klRecoveryManager.unsubscribe(this.recoveryListener),[2]}})}).call(n);var H=c.BB.el({tagName:"button",className:"grid-button",content:L((0,d.LANG)("file-share"),t(v)),custom:{tabIndex:"-1"},css:{cssFloat:"left"},onClick:function(){H.disabled=!0,i.onShareImage(function(){H.disabled=!1})}}),z=c.BB.el({tagName:"button",className:"grid-button",content:L((0,d.LANG)("file-upload"),t(m)),custom:{tabIndex:"-1"},css:{cssFloat:"left"},onClick:function(){i.onUpload()}});c.BB.append(n.rootEl,[s,a,I,c.BB.el({css:{clear:"both"}}),N,E(),null==(e=n.browserStorageUi)?void 0:e.getElement(),o,E(),O,z,c.BB.canShareFiles()?H:void 0,c.BB.el({css:{clear:"both"}})])},1)}return(0,a._)(e,[{key:"refresh",value:function(){}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){if(e){var t;this.refresh(),null==(t=this.browserStorageUi)||t.show(),this.klRecoveryManager&&(this.klRecoveryManager.subscribe(this.recoveryListener),this.klRecoveryManager.update())}else this.klRecoveryManager&&this.klRecoveryManager.unsubscribe(this.recoveryListener)}},{key:"triggerImport",value:function(){this.importInput&&this.importInput.click()}}]),e}()}),s("l5goW",function(e,t){e.exports=i("2oHM2")}),s("beXZZ",function(t,i){e(t.exports,"showRecoveryManagerPanel",function(){return c});var n=o("2MaaK"),r=o("eWjiX"),s=o("kWsEz"),a=o("jTg9g"),l=o("hrnUX"),h=o("1mH1z");function c(e){if(!e||!a.KL_INDEXED_DB.getIsAvailable())return void l.KL.popup({target:document.body,type:"error",message:(0,h.LANG)("file-storage-cant-access"),buttons:["Ok"]});var t=new(0,s.RecoveryManagerPanel)({klRecoveryManager:e}),i=r.BB.el({content:[t.getElement()]});(0,n.showModal)({target:document.body,message:`<b>${(0,h.LANG)("tab-recovery-recover-tabs")}</b>`,div:i,buttons:[(0,h.LANG)("modal-close")],callback:function(e){t.destroy()},style:{width:"calc(100% - 50px)",maxWidth:"1000px",minWidth:"300px",boxSizing:"border-box"},clickOnEnter:"Ok"})}}),s("kWsEz",function(i,n){e(i.exports,"RecoveryManagerPanel",function(){return x});var r=o("1LaJZ"),s=o("cx0mh"),a=o("7h4XF"),l=o("bX4ja"),h=o("2gUX3"),c=o("eWjiX"),u=o("6otAp"),p=o("8mtWV"),d=o("2MaaK"),g=o("eIcQa"),f=o("jXA9u"),v=o("1mH1z"),m=o("9N3Nv"),y=o("7jh4K"),x=function(){"use strict";function e(t){var i=this;(0,s._)(this,e),this.recoveryListener=function(e,t){i.update(e,t)},this.klRecoveryManager=t.klRecoveryManager,this.rootEl=c.BB.el({content:(0,v.LANG)("loading")}),this.klRecoveryManager.subscribe(this.recoveryListener),setTimeout(function(){return(0,r._)(function(){var e;return(0,h.__generator)(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.klRecoveryManager.update()];case 1:return t.sent(),[3,3];case 2:return e=t.sent(),setTimeout(function(){throw e}),this.rootEl.innerHTML="error",[3,3];case 3:return[2]}})}).call(i)})}return(0,a._)(e,[{key:"update",value:function(e,i){return(0,r._)(function(){var n,o;return(0,h.__generator)(this,function(s){return n=this,o=[],e.sort(function(e,t){return e.timestamp>t.timestamp?-1:+(e.timestamp<t.timestamp)}).forEach(function(e){var i=c.BB.el({tagName:"a",className:"kl-button kl-button-link",content:(0,v.LANG)("tab-recovery-recover"),custom:{href:"#"+e.id,target:"_blank"}}),s=c.BB.el({tagName:"button",className:"kl-button-delete",content:`<img src="${t(m)}" height="20"/>${(0,v.LANG)("tab-recovery-delete")}`,onClick:function(){s.blur();var t=(0,g.copyCanvas)(e.thumbnail);(0,y.css)(t,{alignSelf:"start",background:"var(--kl-checkerboard-background)",maxWidth:"100%"}),(0,d.showModal)({target:document.body,type:"warning",message:c.BB.el({content:[(0,v.LANG)("tab-recovery-delete-confirmation"),t],css:{display:"flex",flexDirection:"column",gap:"10px"}}),buttons:[(0,v.LANG)("tab-recovery-delete"),"Cancel"],deleteButtonName:(0,v.LANG)("tab-recovery-delete"),callback:function(t){return(0,r._)(function(){return(0,h.__generator)(this,function(i){switch(i.label){case 0:if("Cancel"===t)return[2];return[4,this.klRecoveryManager.remove(+e.id)];case 1:return i.sent(),[2]}})}).call(n)}})},noRef:!0}),a=e.thumbnail,l=c.BB.el({tagName:"a",content:a,className:f.preview,title:(0,v.LANG)("tab-recovery-recover"),css:{minHeight:u.RECOVERY_THUMB_HEIGHT_PX+"px"},custom:{href:"#"+e.id,target:"_blank"}}),x=c.BB.el({content:[(0,p.timestampToAge)(e.timestamp),", "+c.BB.round(e.memoryEstimateBytes/1e6,1)+" MB"],css:{textAlign:"center"}});o.push(c.BB.el({content:[l,x,i,s],css:{display:"flex",flexDirection:"column",gap:"5px",maxWidth:"100%"}}))}),this.rootEl.innerHTML="",u.DEBUG_RETURN_ALL_RECOVERIES&&this.rootEl.append(c.BB.el({content:"Debug On - SHOWING ALL TABS",css:{background:"red"}})),this.rootEl.append(c.BB.el({content:(0,v.LANG)("tab-recovery-explanation"),className:"kl-toolspace-note"}),c.BB.el({content:(0,v.LANG)("tab-recovery-total-quota-label")+" "+c.BB.round(i/1e6,1)+" MB / "+c.BB.round(u.RECOVERY_MEMORY_LIMIT_BYTES/1e6,1)+" MB",css:{margin:"10px 0"}}),c.BB.el({content:(0,l._)(o),css:{display:"flex",flexWrap:"wrap",gap:"20px 10px",justifyContent:"space-evenly"}})),0===o.length&&this.rootEl.append((0,v.LANG)("tab-recovery-empty")),[2]})}).call(this)}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.klRecoveryManager.unsubscribe(this.recoveryListener)}}]),e}()}),s("6otAp",function(t,i){e(t.exports,"RECOVERY_THUMB_WIDTH_PX",function(){return n}),e(t.exports,"RECOVERY_THUMB_HEIGHT_PX",function(){return r}),e(t.exports,"RECOVERY_AGE_LIMIT_MS",function(){return s}),e(t.exports,"RECOVERY_MEMORY_LIMIT_BYTES",function(){return a}),e(t.exports,"DEBUG_RETURN_ALL_RECOVERIES",function(){return l}),o("1LaJZ"),o("cx0mh"),o("7h4XF"),o("2gUX3"),o("gDbpE"),o("7jh4K"),o("3uJxV"),o("jTg9g");var n=300,r=180,s=6048e5,a=1e9,l=!1}),s("gDbpE",function(t,i){e(t.exports,"getIdsFromRecoveryStore",function(){return y}),e(t.exports,"clearOldRecoveries",function(){return x}),e(t.exports,"deleteRecovery",function(){return L}),e(t.exports,"removeOrphans",function(){return B}),e(t.exports,"getRecovery",function(){return k}),e(t.exports,"changeRecoveryId",function(){return C}),e(t.exports,"storeRecovery",function(){return E}),e(t.exports,"getMetadata",function(){return I});var n=o("1LaJZ"),r=o("cL71g"),s=o("4EWN2"),a=o("bX4ja"),l=(o("2gUX3"),o("2gUX3")),h=o("jTg9g"),c=o("3hwQ7"),u=o("esGm2"),p=o("eWjiX"),d=o("gWfkn"),g=o("7nLJW"),f=o("7jh4K"),v=o("6otAp"),m=o("6mTnI");function y(){return(0,n._)(function(){return(0,l.__generator)(this,function(e){switch(e.label){case 0:return[4,h.KL_INDEXED_DB.getKeys(h.RECOVERY_STORE)];case 1:return[2,e.sent().map(function(e){return+e})]}})})()}function x(){return(0,n._)(function(){var e;return(0,l.__generator)(this,function(t){switch(t.label){case 0:return[4,h.KL_INDEXED_DB.getKeys(h.RECOVERY_STORE)];case 1:return[4,Promise.all((e=t.sent()).map(function(e){return h.KL_INDEXED_DB.get(h.RECOVERY_STORE,e)}))];case 2:return[4,Promise.all(t.sent().map(function(t,i){return t.timestamp<new Date().getTime()-v.RECOVERY_AGE_LIMIT_MS?L(e[i]):Promise.resolve()}))];case 3:return t.sent(),[2]}})})()}function b(e,t){return(0,n._)(function(){var i,n,r,o;return(0,l.__generator)(this,function(s){switch(s.label){case 0:return[4,h.KL_INDEXED_DB.get(h.IMAGE_DATA_STORE,e)];case 1:if(!(i=s.sent()))return t.clearRect(0,0,d.HISTORY_TILE_SIZE,d.HISTORY_TILE_SIZE),[2,t.getImageData(0,0,d.HISTORY_TILE_SIZE,d.HISTORY_TILE_SIZE)];if(!(0,f.isBlob)(i))return[3,6];s.label=2;case 2:return s.trys.push([2,4,,5]),[4,(0,c.loadImage)(i)];case 3:return n=s.sent(),[3,5];case 4:return s.sent(),[3,5];case 5:return t.canvas.width=null!=(r=null==n?void 0:n.width)?r:t.canvas.width,t.canvas.height=null!=(o=null==n?void 0:n.height)?o:t.canvas.height,n&&t.drawImage(n,0,0),[2,t.getImageData(0,0,t.canvas.width,t.canvas.height)];case 6:return[2,i]}})})()}function w(e){return(0,n._)(function(){return(0,l.__generator)(this,function(t){switch(t.label){case 0:return[4,h.KL_INDEXED_DB.get(h.RECOVERY_STORE,""+e)];case 1:return[2,t.sent()]}})})()}function B(e){return(0,n._)(function(){var t,i,r,o,s,a,c,p,d,g,f,v,x,b,w,B,k,S,C,E,L,I,T,A,M,R,_,P,D,N,O;return(0,l.__generator)(this,function(G){switch(G.label){case 0:if(null==e)return[3,1];return i=e,[3,3];case 1:return[4,(0,n._)(function(){return(0,l.__generator)(this,function(e){switch(e.label){case 0:return[4,h.KL_INDEXED_DB.getKeys(h.IMAGE_DATA_STORE)];case 1:return[2,e.sent()]}})})()];case 2:i=G.sent(),G.label=3;case 3:return t=i,r=new Set,[4,y()];case 4:o=G.sent(),s=!0,a=!1,c=void 0,G.label=5;case 5:G.trys.push([5,10,11,12]),p=o[Symbol.iterator](),G.label=6;case 6:if(s=(d=p.next()).done)return[3,9];return g=d.value,[4,h.KL_INDEXED_DB.get(h.RECOVERY_STORE,""+g)];case 7:if(!(f=G.sent()))return[3,8];v=!0,x=!1,b=void 0;try{for(w=f.layers[Symbol.iterator]();!(v=(B=w.next()).done);v=!0){k=B.value,S=!0,C=!1,E=void 0;try{for(L=k.image[Symbol.iterator]();!(S=(I=L.next()).done);S=!0)T=I.value,(0,u.isLayerFill)(T)||r.add(T.id)}catch(e){C=!0,E=e}finally{try{S||null==L.return||L.return()}finally{if(C)throw E}}}}catch(e){x=!0,b=e}finally{try{v||null==w.return||w.return()}finally{if(x)throw b}}r.add(f.thumbnail),G.label=8;case 8:return s=!0,[3,6];case 9:return[3,12];case 10:return A=G.sent(),a=!0,c=A,[3,12];case 11:try{s||null==p.return||p.return()}finally{if(a)throw c}return[7];case 12:return[4,h.KL_INDEXED_DB.get(h.BROWSER_STORAGE_STORE,1)];case 13:if(M=G.sent()){(0,m.isTImageDataReference)(M.thumbnail)&&r.add(M.thumbnail.id),R=!0,_=!1,P=void 0;try{for(D=M.layers[Symbol.iterator]();!(R=(N=D.next()).done);R=!0)O=N.value,(0,m.isTImageDataReference)(O.blob)&&r.add(O.blob.id)}catch(e){_=!0,P=e}finally{try{R||null==D.return||D.return()}finally{if(_)throw P}}}return[4,h.KL_INDEXED_DB.bulkRemove(h.IMAGE_DATA_STORE,t.filter(function(e){return!r.has(e)}))];case 14:return G.sent(),[2]}})})()}function k(e){return(0,n._)(function(){var t,i,o,a,c,g;return(0,l.__generator)(this,function(v){switch(v.label){case 0:return[4,h.KL_INDEXED_DB.get(h.RECOVERY_STORE,""+e)];case 1:if(void 0===(t=v.sent()))return[2,void 0];return i=p.BB.canvas(d.HISTORY_TILE_SIZE,d.HISTORY_TILE_SIZE),o=p.BB.ctx(i),a=[],[4,Promise.all(t.layers.map(function(e,t){return(0,n._)(function(){var i,n,h,c,p;return(0,l.__generator)(this,function(l){switch(l.label){case 0:i=[],n=0,l.label=1;case 1:if(!(n<e.image.length))return[3,5];if(h=e.image[n],!(0,u.isLayerFill)(h))return[3,2];return i.push(h),[3,4];case 2:return c=i.push,p={id:h.id},[4,b(h.id,o)];case 3:c.apply(i,[(p.data=l.sent(),p)]),l.label=4;case 4:return n++,[3,1];case 5:return a[t]=(0,s._)((0,r._)({},e),{image:i}),[2]}})})()}))];case 2:return v.sent(),g={project:{projectId:null!=(c=t.projectId)?c:(0,f.randomUuid)(),width:t.width,height:t.height,layers:a},timestamp:0},[4,S(t.thumbnail)];case 3:return[2,(g.thumbnail=v.sent(),g)]}})})()}function S(e){return(0,n._)(function(){var t,i,n;return(0,l.__generator)(this,function(r){switch(r.label){case 0:return t=p.BB.canvas(d.HISTORY_TILE_SIZE,d.HISTORY_TILE_SIZE),[4,b(e,i=p.BB.ctx(t))];case 1:return n=r.sent(),t.width=n.width,t.height=n.height,i.putImageData(n,0,0),[2,t]}})})()}function C(e,t){return(0,n._)(function(){var i;return(0,l.__generator)(this,function(n){switch(n.label){case 0:return[4,w(e)];case 1:if(!(i=n.sent()))return[2,!1];return i.timestamp=new Date().getTime(),[4,h.KL_INDEXED_DB.set(h.RECOVERY_STORE,""+t,i)];case 2:return n.sent(),[4,h.KL_INDEXED_DB.remove(h.RECOVERY_STORE,""+e)];case 3:return n.sent(),[2,!0]}})})()}function E(e,t,i){return(0,n._)(function(){var r,o,s,c,d,m,x,b,k,S,C,E,T,A,M,R,_,P,D,N,O,G,H,z,j,F,V,U;return(0,l.__generator)(this,function(W){switch(W.label){case 0:return W.trys.push([0,,22,24]),o=i((0,f.fitInto)(t.size.width,t.size.height,v.RECOVERY_THUMB_WIDTH_PX,v.RECOVERY_THUMB_HEIGHT_PX).width/t.size.width),s=Object.values(t.layerMap).sort(g.sortLayerMap),[4,(0,f.timeoutWrapper)(w(e),"storeRecovery.getRawRecoveryProject")];case 1:d=new Set(null==(c=W.sent())?void 0:c.layers.flatMap(function(e){return e.image.map(function(e){return(0,u.isLayerFill)(e)?void 0:e.id}).filter(function(e){return void 0!==e})})),c&&d.add(c.thumbnail),m={},c&&c.layers.forEach(function(e){e.image.forEach(function(e){(0,u.isLayerFill)(e)||(m[e.id]=e.sizeBytes||0)})}),x=new Set(s.flatMap(function(e){return e.tiles.flatMap(function(e){return(0,u.isLayerFill)(e)?[]:[e.id]})})),r=(0,a._)(d).filter(function(e){return!x.has(e)}),b=[],k=[],S=0,C=!0,E=!1,T=void 0,W.label=2;case 2:W.trys.push([2,7,8,9]),A=function(){var e,t,i;return(0,l.__generator)(this,function(r){switch(r.label){case 0:return e=R.value,t=b.push,i={name:e.name,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr},[4,(0,n._)(function(){var t,i,n,r,o,s,a,h;return(0,l.__generator)(this,function(l){t=[],i=!0,n=!1,r=void 0;try{for(o=e.tiles[Symbol.iterator]();!(i=(s=o.next()).done);i=!0)a=s.value,(0,u.isLayerFill)(a)?(t.push(a),S+=a.fill.length):(h=0,d.has(a.id)?h=m[a.id]:(k.push({id:a.id,data:a.data}),h=a.data.width*a.data.height*4),S+=h,t.push({id:a.id,sizeBytes:h}))}catch(e){n=!0,r=e}finally{try{i||null==o.return||o.return()}finally{if(n)throw r}}return[2,t]})})()];case 1:return t.apply(b,[(i.image=r.sent(),i)]),[2]}})},M=s[Symbol.iterator](),W.label=3;case 3:if(C=(R=M.next()).done)return[3,6];return[5,(0,l.__values)(A())];case 4:W.sent(),W.label=5;case 5:return C=!0,[3,3];case 6:return[3,9];case 7:return _=W.sent(),E=!0,T=_,[3,9];case 8:try{C||null==M.return||M.return()}finally{if(E)throw T}return[7];case 9:var X;return P={id:(0,f.randomUuid)(),data:p.BB.ctx(o).getImageData(0,0,o.width,o.height)},k.push(P),S+=P.data.width*P.data.height*4,D={projectId:t.projectId.value,width:t.size.width,height:t.size.height,timestamp:new Date().getTime(),thumbnail:P.id,layers:b,memoryEstimateBytes:S},[4,(0,f.timeoutWrapper)((X=e,(0,n._)(function(){var e,t,i,n,r,o,s,a,h,c;return(0,l.__generator)(this,function(l){switch(l.label){case 0:return[4,y()];case 1:e=l.sent(),t=0,i=!0,n=!1,r=void 0,l.label=2;case 2:l.trys.push([2,7,8,9]),o=e[Symbol.iterator](),l.label=3;case 3:if(i=(s=o.next()).done)return[3,6];if((a=s.value)===X)return[3,5];return[4,I(""+a)];case 4:h=l.sent(),t+=h.memoryEstimateBytes,l.label=5;case 5:return i=!0,[3,3];case 6:return[3,9];case 7:return c=l.sent(),n=!0,r=c,[3,9];case 8:try{i||null==o.return||o.return()}finally{if(n)throw r}return[7];case 9:return[2,t]}})})()),"storeRecovery.getTotalMemory")];case 10:if(!((N=W.sent())+S>v.RECOVERY_MEMORY_LIMIT_BYTES))return[3,19];return O=N+S-v.RECOVERY_MEMORY_LIMIT_BYTES,G=0,H=[],[4,(0,n._)(function(){var e,t,i,n,r,o,s,a,h,c;return(0,l.__generator)(this,function(l){switch(l.label){case 0:return[4,y()];case 1:e=l.sent(),t=[],i=!0,n=!1,r=void 0,l.label=2;case 2:l.trys.push([2,7,8,9]),o=e[Symbol.iterator](),l.label=3;case 3:if(i=(s=o.next()).done)return[3,6];return a=s.value,h=t.push,[4,I(""+a)];case 4:h.apply(t,[l.sent()]),l.label=5;case 5:return i=!0,[3,3];case 6:return[3,9];case 7:return c=l.sent(),n=!0,r=c,[3,9];case 8:try{i||null==o.return||o.return()}finally{if(n)throw r}return[7];case 9:return[2,t]}})})()];case 11:W.sent().sort(function(e,t){return e.timestamp>t.timestamp?1:e.timestamp<t.timestamp?-1:0}).forEach(function(e){G>=O||(H.push(e.id),G+=e.memoryEstimateBytes)}),z=!0,j=!1,F=void 0,W.label=12;case 12:W.trys.push([12,17,18,19]),V=H[Symbol.iterator](),W.label=13;case 13:if(z=(U=V.next()).done)return[3,16];return[4,L(U.value)];case 14:W.sent(),W.label=15;case 15:return z=!0,[3,13];case 16:return[3,19];case 17:return _=W.sent(),j=!0,F=_,[3,19];case 18:try{z||null==V.return||V.return()}finally{if(j)throw F}return[7];case 19:return[4,(0,f.timeoutWrapper)(h.KL_INDEXED_DB.bulkSet(h.IMAGE_DATA_STORE,k.map(function(e){return{key:e.id,value:e.data}})),"storeRecovery.storeTile",3e4)];case 20:return W.sent(),[4,(0,f.timeoutWrapper)(h.KL_INDEXED_DB.set(h.RECOVERY_STORE,""+e,D),"storeRecovery.storeRecovery")];case 21:return W.sent(),[3,24];case 22:return[4,(0,f.timeoutWrapper)(B(r),"storeRecovery.removeOrphans",8e3)];case 23:return W.sent(),[7];case 24:return[2]}})})()}function L(e){return(0,n._)(function(){var t,i,n,r,o,s,a,c,p,d,g,f,v,m;return(0,l.__generator)(this,function(l){switch(l.label){case 0:return[4,h.KL_INDEXED_DB.get(h.RECOVERY_STORE,e)];case 1:if(!(t=l.sent()))return[2];return[4,h.KL_INDEXED_DB.remove(h.RECOVERY_STORE,e)];case 2:l.sent(),i=[t.thumbnail],n=!0,r=!1,o=void 0;try{for(s=t.layers[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){c=a.value,p=!0,d=!1,g=void 0;try{for(f=c.image[Symbol.iterator]();!(p=(v=f.next()).done);p=!0)m=v.value,(0,u.isLayerFill)(m)||i.push(m.id)}catch(e){d=!0,g=e}finally{try{p||null==f.return||f.return()}finally{if(d)throw g}}}}catch(e){r=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw o}}return[4,B(i)];case 3:return l.sent(),[2]}})})()}function I(e,t){return(0,n._)(function(){var i,n,r,o;return(0,l.__generator)(this,function(s){switch(s.label){case 0:return[4,h.KL_INDEXED_DB.get(h.RECOVERY_STORE,e)];case 1:if(void 0===(i=s.sent()))throw Error("drawing not found");if(r={id:e,width:(n=i).width,height:n.height},!t)return[3,3];return[4,S(n.thumbnail)];case 2:return o=s.sent(),[3,4];case 3:o=void 0,s.label=4;case 4:return[2,(r.thumbnail=o,r.timestamp=n.timestamp,r.memoryEstimateBytes=n.memoryEstimateBytes,r)]}})})()}}),s("3uJxV",function(t,i){e(t.exports,"CrossTabChannel",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("6l0gQ"),a=(0,o("7jh4K").randomUuid)(),l=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.name=t,this.broadcastChannelListeners=[],this.lastReadTimestamp=new Date().getTime(),this.maxAgeMs=1e4,this.localStoragePrefix="cross-tab-channel--",this.localStorageListeners=new Set,this.onLocalStorageChange=function(e){if(e.key===i.getLsKey()&&null!==e.newValue)try{JSON.parse(e.newValue).forEach(function(e){e.originId===a||e.timestamp<=i.lastReadTimestamp||(i.lastReadTimestamp=e.timestamp,i.localStorageListeners.forEach(function(t){return t(e.message)}))})}catch(e){s.LocalStorage.removeItem(i.getLsKey())}},"undefined"!=typeof BroadcastChannel&&(this.broadcastChannel=new BroadcastChannel(t))}return(0,r._)(e,[{key:"getLsKey",value:function(){return this.localStoragePrefix+this.name}},{key:"postMessage",value:function(e){var t=this;if(this.broadcastChannel)this.broadcastChannel.postMessage(e);else{var i=new Date().getTime(),n=null;try{n=s.LocalStorage.getItem(this.getLsKey())}catch(e){}var r=null===n?[]:JSON.parse(n);(r=r.filter(function(e){return e.timestamp>i-t.maxAgeMs})).push({timestamp:i,originId:a,message:e}),s.LocalStorage.setItem(this.getLsKey(),JSON.stringify(r))}}},{key:"subscribe",value:function(e){if(this.broadcastChannel){var t=function(t){return e(t.data)};this.broadcastChannelListeners.push({preListener:t,listener:e}),this.broadcastChannel.addEventListener("message",t)}else 0===this.localStorageListeners.size&&window.addEventListener("storage",this.onLocalStorageChange),this.localStorageListeners.add(e)}},{key:"unsubscribe",value:function(e){if(this.broadcastChannel){var t=this.broadcastChannelListeners.find(function(t){return t.listener===e});t&&this.broadcastChannel.removeEventListener("message",t.preListener)}else this.localStorageListeners.delete(e),0===this.localStorageListeners.size&&window.removeEventListener("storage",this.onLocalStorageChange)}},{key:"close",value:function(){this.broadcastChannel&&this.broadcastChannel.close()}}]),e}()}),s("jXA9u",function(t,i){var n;e(t.exports,"preview",function(){return n},function(e){return n=e}),n="-c3MRW_preview"}),s("4x7Mh",function(t,i){var n;e(t.exports,"recoveryBubble",function(){return n},function(e){return n=e}),n="Tt6aiG_recoveryBubble"}),s("gHbQ1",function(i,n){e(i.exports,"EditUi",function(){return f});var r=o("cx0mh"),s=o("7h4XF"),a=o("8N5YG"),l=o("eWjiX"),h=o("hrnUX"),c=o("1mH1z"),u=o("a5EFw"),p=o("amum4"),d=o("envwp"),g=o("72Jv0"),f=function(){"use strict";function e(t){(0,r._)(this,e),this.isInit=!1,this.klRootEl=t.klRootEl,this.klColorSlider=t.klColorSlider,this.layersUi=t.layersUi,this.getCurrentColor=t.getCurrentColor,this.maxCanvasSize=t.maxCanvasSize,this.klCanvas=t.klCanvas,this.getCurrentLayer=t.getCurrentLayer,this.isEmbed=t.isEmbed,this.statusOverlay=t.statusOverlay,this.onCanvasChanged=t.onCanvasChanged,this.applyUncommitted=t.applyUncommitted,this.klHistory=t.klHistory,this.onCopyToClipboard=t.onCopyToClipboard,this.onPaste=t.onPaste,this.rootEl=l.BB.el()}return(0,s._)(e,[{key:"testHasWebGL",value:function(){return!!(0,u.getSharedFx)()}},{key:"init",value:function(){var e=this,i=h.KL.FILTER_LIB,n=[];if(!h.KL.FILTER_LIB_STATUS.isLoaded)throw Error("filters not loaded");var r=this.testHasWebGL();if(!r){var o=l.BB.el({parent:this.rootEl,className:"kl-toolspace-note",content:"Features disabled because WebGL is failing.",css:{margin:"10px",marginBottom:"0"}});l.BB.el({parent:o,tagName:"button",textContent:"Learn More",css:{marginLeft:"5px"}}).onclick=function(){h.KL.popup({target:e.klRootEl,message:"<b>WebGL is not working</b>",div:l.BB.el({content:`
See if your browser supports WebGL and has it enabled: <a href="https://get.webgl.org" target="_blank" rel="noopener noreferrer">get.webgl.org</a><br>
<br>
Recently (2023-05) a number of Chrome users on Chrome OS reported that WebGL fails, although it is enabled & supported.
This has been reported to Google.
`}),buttons:["Ok"],clickOnEnter:"Ok"})}}var s=function(t){var o=i[t],s=l.BB.el({tagName:"button",className:"grid-button grid-button--filter",content:[(0,g.createImage)({alt:"icon",src:o.icon,width:18,height:20,className:o.darkNoInvert?"dark-no-invert":"",css:{marginRight:"3px"}}),(0,c.LANG)(o.lang.button)],css:{lineHeight:"20px",fontSize:"12px"},custom:{tabIndex:"-1"}}),a=(0,c.LANG)(o.lang.name),u=!0;return o.webGL&&!r&&(u=!1),u?s.onclick=function(){e.applyUncommitted();var n=function(e,t){var i;if(!("error"in t)){if("Cancel"==e){t.destroy&&t.destroy();return}try{i=t.getInput()}catch(e){if(-1!==e.message.indexOf(".getInput is not a function"))throw"filterDialog.getInput is not a function, filter: "+a;throw e}r(i)}};if(!("apply"in i[t]))return void h.KL.popup({target:e.klRootEl,message:"Application not fully loaded",type:"error"});var r=function(n){i[t].apply({layer:e.getCurrentLayer(),klCanvas:e.klCanvas,klHistory:e.klHistory,input:n})||h.KL.popup({target:e.klRootEl,message:"Couldn't apply the edit action",type:"error"}),i[t].updatePos&&e.onCanvasChanged(),e.layersUi.update()};if(i[t].isInstant)s.blur(),r(null),e.statusOverlay.out('"'+a+'" '+(0,c.LANG)("filter-applied"),!0);else{var l,u,d=e.klColorSlider.getSecondaryRGB(),g=void 0;try{g=i[t].getDialog({context:e.getCurrentLayer().context,klCanvas:e.klCanvas,maxWidth:e.maxCanvasSize,maxHeight:e.maxCanvasSize,currentColorRgb:{r:e.getCurrentColor().r,g:e.getCurrentColor().g,b:e.getCurrentColor().b},secondaryColorRgb:{r:d.r,g:d.g,b:d.b},composed:e.klHistory.getComposed()})}catch(e){setTimeout(function(){throw e})}if(!g||"error"in g)return void h.KL.popup({target:e.klRootEl,message:g?g.error:"Error: Could not perform action.",type:"error"});g.errorCallback=function(t){h.KL.popup({target:e.klRootEl,message:"Error: Could not perform action.",type:"error"}),setTimeout(function(){throw t},0),l()};var f={};"width"in g&&(f.width=g.width+"px");var v=[(0,p.c)("b",a)];void 0!==o.lang.description&&v.push((0,p.c)({className:"kl-info-btn",onClick:function(){h.KL.popup({target:e.klRootEl,message:(0,c.LANG)(o.lang.description)})},title:(0,c.LANG)(o.lang.description),noRef:!0},"?")),u=(0,p.c)(",flex,gap-5",v),h.KL.popup({target:e.klRootEl,message:u,div:g.element,style:f,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){n(e,g)},closeFunc:function(e){l=e}})}}:s.disabled=!0,n.push(s),s},u=function(t){Object.entries(i).forEach(function(i){var n=(0,a._)(i,2),r=n[0],o=n[1];t.includes(r)&&(!e.isEmbed||o.inEmbed)&&e.rootEl.append(s(r))})};if(!this.isEmbed){var f=l.BB.el({tagName:"button",className:"grid-button grid-button--filter",content:[(0,g.createImage)({alt:"icon",src:t(d),width:18,height:20,css:{marginRight:"3px"}}),(0,c.LANG)("file-copy")],onClick:function(){return e.onCopyToClipboard()},title:(0,c.LANG)("file-copy-title"),custom:{tabIndex:"-1"},css:{lineHeight:"20px"}}),v=l.BB.el({tagName:"button",className:"grid-button grid-button--filter",content:[l.BB.el({css:{height:"20px",cssFloat:"left"}}),(0,c.LANG)("file-paste")],custom:{tabIndex:"-1"},css:{lineHeight:"20px"},onClick:function(){return e.onPaste()}});this.rootEl.append(f,v,l.BB.el({className:"grid-hr"}))}u(["cropExtend","flip","perspective","resize","rotate","transform"]),this.rootEl.append(l.BB.el({className:"grid-hr"})),u(["brightnessContrast","curves","distort","hueSaturation","invert","tiltShift","toAlpha","blur","unsharpMask"]),this.rootEl.append(l.BB.el({className:"grid-hr"})),u(["grid","noise","pattern","vanishPoint"]),this.isInit=!0}},{key:"getElement",value:function(){return this.rootEl}},{key:"show",value:function(){this.isInit||this.init(),this.rootEl.style.display="block"}},{key:"hide",value:function(){this.rootEl.style.display="none"}}]),e}()}),s("a5EFw",function(t,i){e(t.exports,"getSharedFx",function(){return a});var n=o("6N0h0"),r=!1,s=null;function a(){if(r)return s;if(!s||s._.gl.isContextLost())try{s=(0,n.fxCanvas)()}catch(e){r=!0,s=null,setTimeout(function(){throw e})}return s}}),s("6N0h0",function(t,i){e(t.exports,"fxCanvas",function(){return k});var n=o("76shC"),r=o("fvBHO"),s=o("7dEWP"),a=o("8dg54"),l=o("1Vq1u"),h=o("h6IOH"),c=o("9uhWc"),u=o("e0olz"),p=o("2myDH"),d=o("44j8K"),g=o("kSoEy"),f=o("9WU1L"),v=o("bJIp5"),m=o("fkecp"),y=o("3u9Uu"),x=o("6lIef"),b=o("lwXVT"),w=o("eWjiX"),B=o("jF5JO"),k=function(){function e(e){return{_:e,loadContentsOf:function(e){(0,s.setGl)(this._.gl),this._.loadContentsOf(e)},destroy:function(){(0,s.setGl)(this._.gl),this._.destroy()}}}function t(t){return e(a.FxTexture.fromElement(t))}function i(e,t){var i=function(){var e=s.gl.UNSIGNED_BYTE;if(s.gl.getExtension("WEBGL_color_buffer_float")&&s.gl.getExtension("OES_texture_float")&&s.gl.getExtension("OES_texture_float_linear")){var t=new(0,a.FxTexture)(100,100,s.gl.RGBA,s.gl.FLOAT);try{t.drawTo(function(){e=s.gl.FLOAT})}catch(e){}t.destroy()}return e}();this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=e,this.height=t,this._.texture=new(0,a.FxTexture)(e,t,s.gl.RGBA,i),this._.spareTexture=new(0,a.FxTexture)(e,t,s.gl.RGBA,i),this._.extraTexture=this._.extraTexture||new(0,a.FxTexture)(0,0,s.gl.RGBA,i),this._.flippedShader=this._.flippedShader||new(0,r.FxShader)(null,`
uniform sampler2D texture;
varying vec2 texCoord;
void main() {
    gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));
}
        `,"flippedShader"),this._.isInitialized=!0}function o(e,t,n){return this._.isInitialized&&e._.width==this.width&&e._.height==this.height||i.call(this,t||e._.width,n||e._.height),e._.use(),this._.texture.drawTo(function(){r.FxShader.getDefaultShader().drawRect()}),this}function k(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function S(){var t=new(0,a.FxTexture)(this._.texture.width,this._.texture.height,s.gl.RGBA,s.gl.UNSIGNED_BYTE);return this._.texture.use(),t.drawTo(function(){r.FxShader.getDefaultShader().drawRect()}),e(t)}function C(){var e=this._.texture.width,t=this._.texture.height,i=new Uint8Array(e*t*4);return this._.texture.drawTo(function(){s.gl.readPixels(0,0,e,t,s.gl.RGBA,s.gl.UNSIGNED_BYTE,i)}),i}function E(e){return function(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];return(0,s.setGl)(this._.gl),e.apply(this,i)}}return function(){if(!window.WebGLRenderingContext)throw"WebGLRenderingContext not set. Browser does not support WebGL.";var e,r,a=w.BB.canvas(1,1),L=(e={premultipliedAlpha:!1},r=null,["webgl","experimental-webgl","webgl2"].forEach(function(t){if(!r)try{r=a.getContext(t,e)}catch(e){}}),r);if(!L)throw"This browser does not support WebGL";return(0,s.setGl)(L),a._={gl:s.gl,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},a.texture=E(t),a.initialize=E(i),a.draw=E(o),a.update=E(k),a.contents=E(S),a.getPixelArray=E(C),a.brightnessContrast=E(n.brightnessContrast),a.hueSaturation=E(h.hueSaturation),a.triangleBlur=E(u.triangleBlur),a.unsharpMask=E(g.unsharpMask),a.perspective=E(m.perspective),a.matrixWarp=E(d.matrixWarp),a.tiltShift=E(p.tiltShift),a.noise=E(c.noise),a.curves=E(l.curves),a.invert=E(v.invert),a.multiplyAlpha=E(b.multiplyAlpha),a.unmultiplyAlpha=E(y.unmultiplyAlpha),a.toAlpha=E(f.toAlpha),a.distort=E(x.distort),a.mask=E(B.mask),a}}()}),s("76shC",function(t,i){e(t.exports,"brightnessContrast",function(){return l});var n=o("eWjiX"),r=o("jrAes"),s=o("fvBHO"),a=o("7dEWP"),l=function(e,t){return a.gl.brightnessContrast=a.gl.brightnessContrast||new(0,s.FxShader)(null,"        uniform sampler2D texture;        uniform float brightness;        uniform float contrast;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.rgb += brightness;            if (contrast > 0.0) {                color.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;            } else {                color.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;            }            gl_FragColor = clamp(color, 0.0, 1.0);        }    ","brightnessContrast"),r.simpleShader.call(this,a.gl.brightnessContrast,{brightness:n.BB.clamp(e,-1,1),contrast:n.BB.clamp(t,-1,1)}),this}}),s("jrAes",function(t,i){e(t.exports,"simpleShader",function(){return n});function n(e,t,i,n){(i||this._.texture).use(),this._.spareTexture.drawTo(function(){e.uniforms(t).drawRect()}),this._.spareTexture.swapWith(n||this._.texture)}}),s("fvBHO",function(t,i){e(t.exports,"FxShader",function(){return c});var n,r=o("cx0mh"),s=o("7h4XF"),a=o("8N5YG"),l=o("7dEWP"),h=o("eWjiX"),c=function(){"use strict";function e(t,i,o){if((0,r._)(this,e),this.vertexAttribute=null,this.texCoordAttribute=null,this.program=h.BB.throwIfNull(l.gl.createProgram()),t=t||"    attribute vec2 vertex;    attribute vec2 _texCoord;    varying vec2 texCoord;    void main() {        texCoord = _texCoord;        gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);    }",i=i||"    uniform sampler2D texture;    varying vec2 texCoord;    void main() {        gl_FragColor = texture2D(texture, texCoord);    }",n||(n=this.testPrecisionSupport(l.gl.HIGH_FLOAT)?"highp":this.testPrecisionSupport(l.gl.MEDIUM_FLOAT)?"mediump":"lowp"),i="precision "+n+" float;"+i,l.gl.attachShader(this.program,this.compileSource(l.gl.VERTEX_SHADER,t,o+"(vertex)")),l.gl.attachShader(this.program,this.compileSource(l.gl.FRAGMENT_SHADER,i,o+"(fragment)")),l.gl.linkProgram(this.program),!l.gl.getProgramParameter(this.program,l.gl.LINK_STATUS))throw"link error: "+l.gl.getProgramInfoLog(this.program)}return(0,s._)(e,[{key:"compileSource",value:function(e,t,i){var n=h.BB.throwIfNull(l.gl.createShader(e));if(l.gl.shaderSource(n,t.replace(/#define.*/,"")),l.gl.compileShader(n),!l.gl.getShaderParameter(n,l.gl.COMPILE_STATUS))throw"compile error: "+i+" - "+l.gl.getShaderInfoLog(n);return n}},{key:"testPrecisionSupport",value:function(e){var t=l.gl.getShaderPrecisionFormat(l.gl.FRAGMENT_SHADER,e);return null!==t&&0!==t.precision}},{key:"destroy",value:function(){l.gl.deleteProgram(this.program),this.program=null}},{key:"uniforms",value:function(e){var t=this;return l.gl.useProgram(this.program),Object.entries(e).forEach(function(e){var i=(0,a._)(e,2),n=i[0],r=i[1],o=l.gl.getUniformLocation(t.program,n);if(null!==o)if("[object Array]"==Object.prototype.toString.call(r))switch(r.length){case 1:l.gl.uniform1fv(o,new Float32Array(r));break;case 2:l.gl.uniform2fv(o,new Float32Array(r));break;case 3:l.gl.uniform3fv(o,new Float32Array(r));break;case 4:l.gl.uniform4fv(o,new Float32Array(r));break;case 9:l.gl.uniformMatrix3fv(o,!1,new Float32Array(r));break;case 16:l.gl.uniformMatrix4fv(o,!1,new Float32Array(r));break;default:throw"dont't know how to load uniform \""+n+'" of length '+r.length}else if("[object Number]"==Object.prototype.toString.call(r))l.gl.uniform1f(o,r);else throw'attempted to set uniform "'+n+'" to invalid value '+(r||"undefined").toString()}),this}},{key:"textures",value:function(e){var t=this;return l.gl.useProgram(this.program),Object.entries(e).forEach(function(e){var i=(0,a._)(e,2),n=i[0],r=i[1];l.gl.uniform1i(l.gl.getUniformLocation(t.program,n),r)}),this}},{key:"drawRect",value:function(e,t,i,n){var r,o=l.gl.getParameter(l.gl.VIEWPORT);t=t!==r?(t-o[1])/o[3]:0,e=e!==r?(e-o[0])/o[2]:0,i=i!==r?(i-o[0])/o[2]:1,n=n!==r?(n-o[1])/o[3]:1,(l.gl.vertexBuffer===r||null===l.gl.vertexBuffer)&&(l.gl.vertexBuffer=h.BB.throwIfNull(l.gl.createBuffer())),l.gl.bindBuffer(l.gl.ARRAY_BUFFER,l.gl.vertexBuffer),l.gl.bufferData(l.gl.ARRAY_BUFFER,new Float32Array([e,t,e,n,i,t,i,n]),l.gl.STATIC_DRAW),null==l.gl.texCoordBuffer&&(l.gl.texCoordBuffer=h.BB.throwIfNull(l.gl.createBuffer()),l.gl.bindBuffer(l.gl.ARRAY_BUFFER,l.gl.texCoordBuffer),l.gl.bufferData(l.gl.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),l.gl.STATIC_DRAW)),null==this.vertexAttribute&&(this.vertexAttribute=l.gl.getAttribLocation(this.program,"vertex"),l.gl.enableVertexAttribArray(this.vertexAttribute)),null==this.texCoordAttribute&&(this.texCoordAttribute=l.gl.getAttribLocation(this.program,"_texCoord"),l.gl.enableVertexAttribArray(this.texCoordAttribute)),l.gl.useProgram(this.program),l.gl.bindBuffer(l.gl.ARRAY_BUFFER,l.gl.vertexBuffer),l.gl.vertexAttribPointer(this.vertexAttribute,2,l.gl.FLOAT,!1,0,0),l.gl.bindBuffer(l.gl.ARRAY_BUFFER,l.gl.texCoordBuffer),l.gl.vertexAttribPointer(this.texCoordAttribute,2,l.gl.FLOAT,!1,0,0),l.gl.drawArrays(l.gl.TRIANGLE_STRIP,0,4)}}],[{key:"getDefaultShader",value:function(){return l.gl.defaultShader=l.gl.defaultShader||new e,l.gl.defaultShader}}]),e}()}),s("7dEWP",function(t,i){var n;function r(e){n=e}e(t.exports,"gl",function(){return n}),e(t.exports,"setGl",function(){return r})}),s("8dg54",function(t,i){e(t.exports,"FxTexture",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("7dEWP"),a=o("eWjiX"),l=function(){"use strict";function e(t,i,r,o){(0,n._)(this,e),this.gl=s.gl,this.id=a.BB.throwIfNull(s.gl.createTexture()),this.width=t,this.height=i,this.format=r,this.type=o,this.canvas=null,s.gl.bindTexture(s.gl.TEXTURE_2D,this.id),s.gl.texParameteri(s.gl.TEXTURE_2D,s.gl.TEXTURE_MAG_FILTER,s.gl.LINEAR),s.gl.texParameteri(s.gl.TEXTURE_2D,s.gl.TEXTURE_MIN_FILTER,s.gl.LINEAR),s.gl.texParameteri(s.gl.TEXTURE_2D,s.gl.TEXTURE_WRAP_S,s.gl.CLAMP_TO_EDGE),s.gl.texParameteri(s.gl.TEXTURE_2D,s.gl.TEXTURE_WRAP_T,s.gl.CLAMP_TO_EDGE),t&&i&&s.gl.texImage2D(s.gl.TEXTURE_2D,0,this.format,t,i,0,this.format,this.type,null)}return(0,r._)(e,[{key:"loadContentsOf",value:function(e){this.width=e.width||e.videoWidth,this.height=e.height||e.videoHeight,s.gl.bindTexture(s.gl.TEXTURE_2D,this.id),s.gl.texImage2D(s.gl.TEXTURE_2D,0,this.format,this.format,this.type,e)}},{key:"initFromBytes",value:function(e,t,i){this.width=e,this.height=t,this.format=s.gl.RGBA,this.type=s.gl.UNSIGNED_BYTE,s.gl.bindTexture(s.gl.TEXTURE_2D,this.id),s.gl.texImage2D(s.gl.TEXTURE_2D,0,s.gl.RGBA,e,t,0,s.gl.RGBA,this.type,new Uint8Array(i))}},{key:"destroy",value:function(){s.gl.deleteTexture(this.id),this.id=null}},{key:"use",value:function(e){s.gl.activeTexture(s.gl.TEXTURE0+(e||0)),s.gl.bindTexture(s.gl.TEXTURE_2D,this.id)}},{key:"unuse",value:function(e){s.gl.activeTexture(s.gl.TEXTURE0+(e||0)),s.gl.bindTexture(s.gl.TEXTURE_2D,null)}},{key:"ensureFormat",value:function(e,t,i,n){(e!=this.width||t!=this.height||i!=this.format||n!=this.type)&&(this.width=e,this.height=t,this.format=i,this.type=n,s.gl.bindTexture(s.gl.TEXTURE_2D,this.id),s.gl.texImage2D(s.gl.TEXTURE_2D,0,this.format,e,t,0,this.format,this.type,null))}},{key:"ensureFormatViaTexture",value:function(e){this.ensureFormat(e.width,e.height,e.format,e.type)}},{key:"drawTo",value:function(e){if(s.gl.framebuffer=s.gl.framebuffer||s.gl.createFramebuffer(),s.gl.bindFramebuffer(s.gl.FRAMEBUFFER,s.gl.framebuffer),s.gl.framebufferTexture2D(s.gl.FRAMEBUFFER,s.gl.COLOR_ATTACHMENT0,s.gl.TEXTURE_2D,this.id,0),s.gl.checkFramebufferStatus(s.gl.FRAMEBUFFER)!==s.gl.FRAMEBUFFER_COMPLETE)throw Error("incomplete framebuffer");s.gl.viewport(0,0,this.width,this.height),e(),s.gl.bindFramebuffer(s.gl.FRAMEBUFFER,null)}},{key:"swapWith",value:function(e){var t;t=e.id,e.id=this.id,this.id=t,t=e.width,e.width=this.width,this.width=t,t=e.height,e.height=this.height,this.height=t,t=e.format,e.format=this.format,this.format=t}}],[{key:"fromElement",value:function(t){var i=new e(0,0,s.gl.RGBA,s.gl.UNSIGNED_BYTE);return i.loadContentsOf(t),i}}]),e}()}),s("1Vq1u",function(t,i){e(t.exports,"curves",function(){return l});var n=o("fRyi0"),r=o("7dEWP"),s=o("fvBHO"),a=o("jrAes"),l=function(e,t,i){for(var o=(0,n.splineInterpolate)(e),l=(0,n.splineInterpolate)(t),h=(0,n.splineInterpolate)(i),c=[],u=0;u<256;u++)c.splice(c.length,0,o[u],l[u],h[u],255);return this._.extraTexture.initFromBytes(256,1,c),this._.extraTexture.use(1),r.gl.curves=r.gl.curves||new(0,s.FxShader)(null,"        uniform sampler2D texture;        uniform sampler2D map;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.r = texture2D(map, vec2(color.r)).r;            color.g = texture2D(map, vec2(color.g)).g;            color.b = texture2D(map, vec2(color.b)).b;            gl_FragColor = color;        }    ","curves"),r.gl.curves.textures({map:1}),a.simpleShader.call(this,r.gl.curves,{}),this}}),s("fRyi0",function(t,i){e(t.exports,"splineInterpolate",function(){return r});var n=o("eWjiX");function r(e){for(var t=new n.BB.SplineInterpolator(e),i=[],r=0;r<256;r++)i.push(n.BB.clamp(Math.floor(256*t.interpolate(r/255)),0,255));return i}}),s("h6IOH",function(t,i){e(t.exports,"hueSaturation",function(){return l});var n=o("7dEWP"),r=o("fvBHO"),s=o("jrAes"),a=o("eWjiX"),l=function(e,t){return n.gl.hueSaturation=n.gl.hueSaturation||new(0,r.FxShader)(null,"        uniform sampler2D texture;        uniform float hue;        uniform float saturation;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);                        /* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */            float angle = hue * 3.14159265;            float s = sin(angle), c = cos(angle);            vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;            float len = length(color.rgb);            color.rgb = vec3(                dot(color.rgb, weights.xyz),                dot(color.rgb, weights.zxy),                dot(color.rgb, weights.yzx)            );                        /* saturation adjustment */            float average = (color.r + color.g + color.b) / 3.0;            if (saturation > 0.0) {                color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));            } else {                color.rgb += (average - color.rgb) * (-saturation);            }                        gl_FragColor = color;        }    ","hueSaturation"),s.simpleShader.call(this,n.gl.hueSaturation,{hue:a.BB.clamp(e,-1,1),saturation:a.BB.clamp(t,-1,1)}),this}}),s("9uhWc",function(i,n){e(i.exports,"noise",function(){return h});var r=o("7dEWP"),s=o("fvBHO"),a=o("jrAes"),l=o("3TO8L"),h=function(e,i,n,o,h,c,u,p,d,g,f,v,m){return r.gl.noise=r.gl.noise||new(0,s.FxShader)(null,t(l).replace(/#define.*/,""),"noise"),a.simpleShader.call(this,r.gl.noise,{seed:e||0,type:i,scale:[n[0],n[1]],offset:o,octaves:h,samples:c,texSize:[this.width,this.height],peaks:u,brightness:p,contrast:d,isReversed:+!!g,colA:f?[f.r/255,f.g/255,f.b/255]:[0,0,0],colB:v?[v.r/255,v.g/255,v.b/255]:[1,1,1],channels:+("rgb"!==m)}),this}}),s("3TO8L",function(e,t){e.exports="#define GLSLIFY 1\nuniform sampler2D texture;\nvarying vec2 texCoord;\nuniform vec2 texSize;\n\nuniform float seed;\nuniform float type;\nuniform vec2 scale;\nuniform vec2 offset;\nuniform float octaves;\nuniform float samples;\n\nuniform float peaks;\nuniform float contrast;\nuniform float brightness;\nuniform float isReversed;\n\nuniform vec3 colA;\nuniform vec3 colB;\n\nuniform float channels; // 0 - rgb, 1 - alpha\n\n// fbm, cellular_noise based on\n// https://github.com/Gonkee/Gonkees-Shaders\n// MIT, Copyright © Gonkee\n\n// hash & simplex based on\n// https://www.shadertoy.com/view/Msf3WH\n// MIT, Copyright © 2013 Inigo Quilez\n// https://www.youtube.com/c/InigoQuilez\n// https://iquilezles.org\n\nfloat rand(vec2 co) {\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nfloat value_noise(vec2 coord){\n    return rand(floor(coord) / 100.0);\n}\n\nfloat cellular_noise(vec2 coord) {\n    vec2 i = floor(coord);\n    vec2 f = fract(coord);\n\n    float min_dist = 99999.0;\n    for (float x = -1.0; x <= 1.0; x++) {\n        for (float y = -1.0; y <= 1.0; y++) {\n            vec2 node = rand(i + vec2(x, y)) + vec2(x, y);\n            float dist = sqrt((f - node).x * (f - node).x + (f - node).y * (f - node).y);\n            min_dist = min(min_dist, dist);\n        }\n    }\n    return min_dist;\n}\n\n// ---------- Simplex Alternative ---------------------\n\nvec3 hash(vec3 p)\n{ p=vec3(dot(p, vec3(127.1, 311.7, 74.7))\n, dot(p, vec3(269.5, 183.3, 246.1))\n, dot(p, vec3(113.5, 271.9, 124.6)))\n;return fract(sin(p)*43758.5453123)*2.-1.; }\n\nmat3 hash(mat3 p)\n{ return mat3(hash(p[0]), hash(p[1]), hash(p[2])); }\n\nvec3 dots(mat3 a, vec3 w, mat3 b){ return vec3\n(dot(a[0], w-b[0]), dot(a[1], w-b[1]), dot(a[2], w-b[2])); }\n\n//return noiseGra13dx as .x, and its derivatives as .yzw\n// https://www.shadertoy.com/view/llByD1\nvec3 noiseGra13dx(in vec3 x) {\n    vec3 p=floor(x), w=fract(x)\n    #if 1\n    , u=w*w*w*(w*(w*6.-15.)+10.), v=30.*w*w*(w*(w-2.)+1.)//quintic hermite\n    #else\n    , u=w*w*(3.-2.*w), v=6.*w*(1.-w)//cubic hermite\n    #endif\n    //gradients\n    , G=hash(p+vec3(0)), F=hash(p+vec3(1))\n    ;mat3 D=hash(mat3(p, p, p)+mat3(1)), E=hash(mat3(p, p, p)+1.-mat3(1));\n    //projections\n    vec3 d=dots(D, w, mat3(1)), e=dots(E, w, 1.-mat3(1));\n    //interpolations\n    float g=dot(G, w), f=dot(F, w-vec3(1));\n    vec3 h=u.yzx*(g-d.xyx-d.yzz+e.zxy)+d-g, U=u*h, a=d-e;\n    mat3 S=D-mat3(G, G, G), W=D-E;\n    a.x=(a.x+a.y+a.z)+f-g;\n    ;float b=u.x*u.y*u.z;\n\n    vec4 result = vec4(g+U.x+U.y+U.z+a.x*b// value\n    , G*(1.-b)+b*(W[0]+W[1]+W[2]+F)//https://www.shadertoy.com/view/llByD1\n    +u.x*(S[0]+u.y*(G-D[0]-D[1]+E[2]))// derivatives\n    +u.y*(S[1]+u.z*(G-D[1]-D[2]+E[0]))\n    +u.z*(S[2]+u.x*(G-D[0]-D[2]+E[1]))\n    +v*(u.zxy*(g-d.xxy-d.zyz+e.yzx)+h+u.yzx*u.zxy*a.x));\n    return 0.5 + 0.5 * result.xxx;\n}\n\nfloat fbm(vec2 coord) {\n    float normalize_factor = 0.0;\n    float value = 0.0;\n    float scale = 0.5;\n\n    for (float i = 0.0; i < 7.0; i++){\n        if (i < octaves) {\n            if (type == 0.0) {\n                value += value_noise(coord) * scale;\n            } else if (type == 1.0) {\n                value += noiseGra13dx(vec3(coord.x, coord.y, 0.0)).r * scale;\n            } else if (type == 2.0) {\n                value += cellular_noise(coord) * scale;\n            }\n            normalize_factor += scale;\n            coord *= 2.0;\n            scale *= 0.5;\n        }\n    }\n    return value / normalize_factor;\n}\n\nfloat render (vec2 pos) {\n    float result = fbm(pos);\n    //\n\n    if (peaks > 0.0) {\n        result = abs(mod(result * peaks - 0.5, 1.0) - 0.5) * 2.0;// triangle\n        //result = mod(result * (peaks + 1.0), 1.0); // sawtooth\n    }\n\n    result += brightness;\n    if (contrast > 0.0) {\n        result = clamp((result - 0.5) / (1.0 - contrast) + 0.5, 0.0, 1.0);\n    } else if (contrast < 0.0) {\n        result = clamp((result - 0.5) * (1.0 + contrast) + 0.5, 0.0, 1.0);\n    }\n\n    if (isReversed == 1.0) {\n        result = 1.0 - result;\n    }\n    return result;\n}\n\nvoid main() {\n    vec4 color;\n\n    vec2 seedOffset;\n    seedOffset.x = (rand(vec2(seed, 0.0)) * 100.0 - 50.0);\n    seedOffset.y = (rand(vec2(0.0, seed)) * 100.0 - 50.0);\n\n    float val = 0.0;\n    vec2 basePos = texCoord * texSize / scale - offset / scale + seedOffset;\n\n    if (samples == 1.0) {\n        val = render(basePos);\n\n    }/* else if (samples == 4.0) {\n        for (float i = 0.0; i < 2.0; i++) {\n            for (float e = 0.0; e < 2.0; e++) {\n                val += render(basePos + (vec2(i, e) - 0.5) * 0.5 / scale);\n            }\n        }\n        val /= 4.0;\n\n    }*/ else if (samples == 16.0) {\n        for (float i = 0.0; i < 4.0; i++) {\n            for (float e = 0.0; e < 4.0; e++) {\n                val += render(basePos + (vec2(i, e) - 0.25) * 0.25 / scale);\n            }\n        }\n        val /= 16.0;\n    }\n\n    if (channels == 0.0) {\n        gl_FragColor = vec4(vec3(mix(colA, colB, val)), 1.0);\n    } else {\n        gl_FragColor = vec4(vec3(1.0), val);\n    }\n}"}),s("e0olz",function(t,i){e(t.exports,"triangleBlur",function(){return l});var n=o("7dEWP"),r=o("fvBHO"),s=o("4urfK"),a=o("jrAes"),l=function(e){return n.gl.triangleBlur=n.gl.triangleBlur||new(0,r.FxShader)(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+s.randomShaderFunc+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta * percent);                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;        }    ","triangleBlur"),a.simpleShader.call(this,n.gl.triangleBlur,{delta:[e/this.width,0]}),a.simpleShader.call(this,n.gl.triangleBlur,{delta:[0,e/this.height]}),this}}),s("4urfK",function(t,i){e(t.exports,"randomShaderFunc",function(){return n});var n="    float random(vec3 scale, float seed) {        /* use the fragment position for a different seed per-pixel */        return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);    }"}),s("2myDH",function(t,i){e(t.exports,"tiltShift",function(){return l});var n=o("7dEWP"),r=o("fvBHO"),s=o("4urfK"),a=o("jrAes"),l=function(e,t,i,o,l,h){n.gl.tiltShift=n.gl.tiltShift||new(0,r.FxShader)(null,"        uniform sampler2D texture;        uniform float blurRadius;        uniform float gradientRadius;        uniform vec2 start;        uniform vec2 end;        uniform vec2 delta;        uniform vec2 texSize;        varying vec2 texCoord;        "+s.randomShaderFunc+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));            float radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;            for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;        }    ","tiltShift");var c=i-e,u=o-t,p=Math.sqrt(c*c+u*u);return a.simpleShader.call(this,n.gl.tiltShift,{blurRadius:l,gradientRadius:h,start:[e,t],end:[i,o],delta:[c/p,u/p],texSize:[this.width,this.height]}),a.simpleShader.call(this,n.gl.tiltShift,{blurRadius:l,gradientRadius:h,start:[e,t],end:[i,o],delta:[-u/p,c/p],texSize:[this.width,this.height]}),this}}),s("44j8K",function(t,i){e(t.exports,"matrixWarp",function(){return l});var n=o("7dEWP"),r=o("gDZ5A"),s=o("jrAes"),a=o("5taNf"),l=function(e,t,i){if(n.gl.matrixWarp=n.gl.matrixWarp||(0,r.warpShader)("        uniform mat3 matrix;        uniform bool useTextureSpace;    ","        if (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;        vec3 warp = matrix * vec3(coord, 1.0);        coord = warp.xy / warp.z;        if (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;    "),4==(e=e.flat()).length)e=[e[0],e[1],0,e[2],e[3],0,0,0,1];else if(9!=e.length)throw"can only warp with 2x2 or 3x3 matrix";return s.simpleShader.call(this,n.gl.matrixWarp,{matrix:t?(0,a.getInverse)(e):e,texSize:[this.width,this.height],useTextureSpace:+!!i}),this}}),s("gDZ5A",function(t,i){e(t.exports,"warpShader",function(){return r});var n=o("fvBHO");function r(e,t){return new(0,n.FxShader)(null,e+"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {        vec2 coord = texCoord * texSize;        "+t+"        gl_FragColor = texture2D(texture, coord / texSize);        vec2 clampedCoord = clamp(coord, vec2(0.0), texSize);        if (coord != clampedCoord) {            /* fade to transparent if we are outside the image */            gl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));        }    }","warp")}}),s("5taNf",function(t,i){function n(e,t,i,n,r,o,s,a){var l=i-r,h=n-o,c=s-r,u=a-o,p=e-i+r-s,d=t-n+o-a,g=l*u-c*h,f=(p*u-c*d)/g,v=(l*d-p*h)/g;return[i-e+f*i,n-t+f*n,f,s-e+v*s,a-t+v*a,v,e,t,1]}function r(e){var t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],s=e[5],a=e[6],l=e[7],h=e[8],c=t*o*h-t*s*l-i*r*h+i*s*a+n*r*l-n*o*a;return[(o*h-s*l)/c,(n*l-i*h)/c,(i*s-n*o)/c,(s*a-r*h)/c,(t*h-n*a)/c,(n*r-t*s)/c,(r*l-o*a)/c,(i*a-t*l)/c,(t*o-i*r)/c]}function o(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}e(t.exports,"getSquareToQuad",function(){return n}),e(t.exports,"getInverse",function(){return r}),e(t.exports,"multiply",function(){return o})}),s("kSoEy",function(t,i){e(t.exports,"unsharpMask",function(){return a});var n=o("7dEWP"),r=o("fvBHO"),s=o("jrAes"),a=function(e,t){return n.gl.unsharpMask=n.gl.unsharpMask||new(0,r.FxShader)(null,"        uniform sampler2D blurredTexture;        uniform sampler2D originalTexture;        uniform float strength;        uniform float threshold;        varying vec2 texCoord;        void main() {            vec4 blurred = texture2D(blurredTexture, texCoord);            vec4 original = texture2D(originalTexture, texCoord);            gl_FragColor = mix(blurred, original, 1.0 + strength);        }    ","unsharpMask"),this._.extraTexture.ensureFormatViaTexture(this._.texture),this._.texture.use(),this._.extraTexture.drawTo(function(){r.FxShader.getDefaultShader().drawRect()}),this._.extraTexture.use(1),this.triangleBlur(e),n.gl.unsharpMask.textures({originalTexture:1}),s.simpleShader.call(this,n.gl.unsharpMask,{strength:t}),this._.extraTexture.unuse(1),this}}),s("9WU1L",function(t,i){e(t.exports,"toAlpha",function(){return a});var n=o("7dEWP"),r=o("fvBHO"),s=o("jrAes"),a=function(e,t){return n.gl.toAlpha=n.gl.toAlpha||new(0,r.FxShader)(null,"    uniform bool isInverted;    uniform vec4 replace;    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        float alpha = (color.r + color.g + color.b) / 3.0;        if (isInverted) alpha = 1.0 - alpha;        alpha = min(color.a, alpha);        if (replace.a > 0.0) color = replace;        gl_FragColor = vec4(color.r, color.g, color.b, alpha);    }","toAlpha"),s.simpleShader.call(this,n.gl.toAlpha,{isInverted:+!!e,replace:t?[t.r/255,t.g/255,t.b/255,t.a]:[0,0,0,0],texSize:[this.width,this.height]}),this}}),s("bJIp5",function(t,i){e(t.exports,"invert",function(){return a});var n=o("7dEWP"),r=o("fvBHO"),s=o("jrAes"),a=function(){return n.gl.invert=n.gl.invert||new(0,r.FxShader)(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        color.rgb = 1.0 - color.rgb;        gl_FragColor = color;    }","invert"),s.simpleShader.call(this,n.gl.invert,{texSize:[this.width,this.height]}),this}}),s("fkecp",function(t,i){e(t.exports,"perspective",function(){return s});var n=o("bX4ja"),r=o("5taNf"),s=function(e,t){var i=r.getSquareToQuad.apply(void 0,(0,n._)(t)),o=r.getSquareToQuad.apply(void 0,(0,n._)(e)),s=(0,r.multiply)((0,r.getInverse)(i),o);return this.matrixWarp(s)}}),s("3u9Uu",function(t,i){e(t.exports,"unmultiplyAlpha",function(){return a});var n=o("7dEWP"),r=o("fvBHO"),s=o("jrAes"),a=function(){return n.gl.unmultiplyAlpha=n.gl.unmultiplyAlpha||new(0,r.FxShader)(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        if(color.a > 0.0) {            color.rgb /= color.a;        }        gl_FragColor = color;    }","unmultiplyAlpha"),s.simpleShader.call(this,n.gl.unmultiplyAlpha,{texSize:[this.width,this.height]}),this}}),s("6lIef",function(t,i){e(t.exports,"distort",function(){return a});var n=o("7dEWP"),r=o("gDZ5A"),s=o("jrAes"),a=function(e){return n.gl.distort=n.gl.distort||(0,r.warpShader)(`
    uniform float stepSize;
    uniform vec2 scale;
    uniform vec2 strength;
    uniform vec2 phase;
    uniform float type;
    uniform vec2 offset;
`,`
    const float PI = 3.14159265;
    float x = coord.x + offset.x;
    float y = coord.y + offset.y;
    if (stepSize > 1.0) {
        x = floor(x / stepSize) * stepSize;
        y = floor(y / stepSize) * stepSize;
    }
    float distortX = sin((x/scale.x + phase.x) * PI * 2.0) * strength.x;
    float distortY = sin((y/scale.y + phase.y) * PI * 2.0) * strength.y;
    if (type == 0.0) {
        coord.y += distortX;
        coord.x += distortY;
    } else if (type == 1.0) {
        coord.x += distortX;
        coord.y += distortY;
    } else if (type == 2.0) {
        x -= offset.x;
        y -= offset.y;
        gl_FragColor = texture2D(texture, vec2(x, y) / texSize);
        coord.y += sin(gl_FragColor.r/scale.x*200.0 + phase.x * PI * 2.0) * strength.x;
        coord.x += cos(gl_FragColor.g/scale.y*200.0 + phase.y * PI * 2.0) * strength.y;
    }
    coord.x = mod(coord.x, texSize.x);
    coord.y = mod(coord.y, texSize.y);
`),s.simpleShader.call(this,n.gl.distort,{stepSize:e.stepSize,type:e.distortType,scale:[e.scale.x,e.scale.y],strength:[e.strength.x,e.strength.y],phase:[e.phase.x,e.phase.y],offset:[e.offset.x,e.offset.y],texSize:[this.width,this.height]}),this}}),s("lwXVT",function(t,i){e(t.exports,"multiplyAlpha",function(){return a});var n=o("7dEWP"),r=o("fvBHO"),s=o("jrAes"),a=function(){return n.gl.multiplyAlpha=n.gl.multiplyAlpha||new(0,r.FxShader)(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        color.rgb *= color.a;        gl_FragColor = color;    }","multiplyAlpha"),s.simpleShader.call(this,n.gl.multiplyAlpha,{texSize:[this.width,this.height]}),this}}),s("jF5JO",function(t,i){e(t.exports,"mask",function(){return a});var n=o("7dEWP"),r=o("fvBHO"),s=o("jrAes"),a=function(e,t){return e._.use(1),t?t._.use(2):(this._.extraTexture.use(2),this._.extraTexture.initFromBytes(1,1,[0,0,0,0])),n.gl.mask=n.gl.mask||new(0,r.FxShader)(null,`
        uniform sampler2D texture;
        uniform sampler2D mask;
        uniform sampler2D original;
        varying vec2 texCoord;

        void main() {
            vec4 filteredCol = texture2D(texture, texCoord);
            vec4 originalCol = texture2D(original, texCoord);
            float maskStrength = texture2D(mask, texCoord).r;
            gl_FragColor = mix(originalCol, filteredCol, maskStrength);
        }
        `,"mask"),n.gl.mask.textures({mask:1,original:2}),s.simpleShader.call(this,n.gl.mask,{}),this}}),s("5ENro",function(i,n){e(i.exports,"imgurUpload",function(){return d});var r=o("1LaJZ"),s=o("2gUX3"),a=o("eWjiX"),l=o("hrnUX"),h=o("1mH1z"),c=o("haR48"),u=o("eIcQa"),p=o("7jh4K");function d(e,i,n,o){if(!n)throw Error("imgur key missing");var d=a.BB.el({tagName:"input",custom:{name:"image-title"}});d.type="text",d.value=(0,h.LANG)("upload-title-untitled");var g=a.BB.el({tagName:"textarea",custom:{rows:"2",name:"image-description"},css:{width:"100%",maxWidth:"100%"}}),f=a.BB.el({textContent:(0,h.LANG)("upload-name")+":"}),v=a.BB.el({textContent:(0,h.LANG)("upload-caption")+":",css:{marginTop:"10px"}}),m=a.BB.el({content:`<br/><a href="https://imgur.com/tos" target="_blank" rel="noopener noreferrer">${(0,h.LANG)("terms-of-service")}</a>`}),y=new l.KL.RadioList({name:"filetype",init:"jpeg",items:[{label:"JPG",value:"jpeg"},{label:"PNG",value:"png"}],ignoreFocus:!0});(0,p.css)(y.getElement(),{marginBottom:"10px"});var x=a.BB.el(),b=a.BB.el({className:"info-hint",textContent:(0,h.LANG)("upload-link-notice")});x.append(b,y.getElement(),f,d,v,g,m),l.KL.popup({target:i,message:`<b>${(0,h.LANG)("upload-title")}</b>`,type:"upload",div:x,buttons:[(0,h.LANG)("upload-submit"),"Cancel"],clickOnEnter:(0,h.LANG)("upload-submit"),primaries:[(0,h.LANG)("upload-submit")],autoFocus:(0,h.LANG)("upload-submit"),callback:function(a){return(0,r._)(function(){var f;return(0,s.__generator)(this,function(v){switch(v.label){case 0:if(a!==(0,h.LANG)("upload-submit")&&"Yes"!==a&&"Ok"!==a)return[3,4];v.label=1;case 1:var m,x,b,w;return v.trys.push([1,3,,4]),[4,(m=e.getCompleteCanvas(1),x=d.value,b=g.value,w=y.getValue(),(0,r._)(function(){var e,i,r,o,a,l,d,g,f;return(0,s.__generator)(this,function(s){switch(s.label){case 0:return[4,(0,u.canvasToBlob)(m,"image/"+w)];case 1:if(e=s.sent(),!(i=window.open()))throw Error("could not create new tab");r=i.document.createElement("div"),(o=i.document.createElement("img")).src=t(c),r.append(o),(0,p.css)(o,{filter:"invert(1)"}),(0,p.css)(i.document.body,{backgroundColor:"#121211",backgroundImage:"linear-gradient(#2b2b2b 0%, #121211 50%)",backgroundRepeat:"no-repeat"}),(a=i.document.createElement("div")).style.marginTop="10px",r.append(a),a.textContent=(0,h.LANG)("upload-uploading"),i.document.body.append(r),(0,p.css)(r,{marginLeft:"auto",marginRight:"auto",marginTop:"100px",fontFamily:"system-ui, sans-serif",fontSize:"20px",textAlign:"center",transition:"opacity 0.3s ease-in-out",opacity:"0",color:"#ccc"}),setTimeout(function(){r.style.opacity="1"},20),s.label=2;case 2:return s.trys.push([2,4,,5]),(d=new FormData).append("title",x),d.append("description",b),d.append("image",e),[4,fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID "+n},body:d})];case 3:return l=s.sent(),[3,5];case 4:throw g=s.sent(),i.close(),g;case 5:if(!l.ok)throw i.close(),Error();return[4,l.json()];case 6:return f=s.sent().data,i.location.href=f.link.replace(/\.(jpg|png)/,""),[2,f]}})})())];case 2:return f=v.sent(),l.KL.popup({target:i,type:"ok",message:`<h3>${(0,h.LANG)("upload-success")}</h3><br>${(0,h.LANG)("upload-delete")}<br><a target='_blank' rel="noopener noreferrer" href='https://imgur.com/delete/${f.deletehash}'>imgur.com/delete/${f.deletehash}</a><br><br>`,buttons:["Ok"]}),o(),[3,4];case 3:return v.sent(),l.KL.popup({target:i,type:"error",message:(0,h.LANG)("upload-failed"),buttons:["Ok"]}),[3,4];case 4:return[2]}})})()}})}}),s("haR48",function(e,t){e.exports=i("iGeXe")}),s("5ngYX",function(t,i){e(t.exports,"SaveReminder",function(){return v});var n=o("cx0mh"),r=o("7h4XF"),s=o("hrnUX"),a=o("eWjiX"),l=o("1mH1z"),h=o("6l0gQ"),c=o("aCVlD"),u=o("9pcu9"),p=void 0,d=void 0,g=null!=d?d:100,f="kl-save-reminder",v=function(){"use strict";function e(t){var i;(0,n._)(this,e),this.klHistory={},this.lastSavedAt=0,this.lastReminderShownAt=0,this.onSaveAsPsd=t.onSaveAsPsd,this.isDrawing=t.isDrawing,this.projectStore=t.projectStore,this.getProject=t.getProject,this.onStored=t.onStored,this.applyUncommitted=t.applyUncommitted,this.klHistory=t.klHistory,this.setting=null!=(i=h.LocalStorage.getItem(f))?i:"40min"}return(0,r._)(e,[{key:"showPopup",value:function(){var e=this,t=Math.round((performance.now()-this.lastSavedAt)/1e3/60),i=a.BB.el();i.append(a.BB.el({content:(0,l.LANG)("save-reminder-text",{a:"<strong>"+t,b:"</strong>"}),css:{marginBottom:"20px"}}));var n=a.BB.el({className:c.psdWrapper}),r=a.BB.el({css:{margin:"0 -20px",padding:"20px",paddingBottom:"0"}});i.append(n,r);var o=a.BB.el({tagName:"button",className:"kl-button kl-button-primary kl-button--extra-focus",content:(0,l.LANG)("save-reminder-save-psd"),onClick:function(){e.applyUncommitted(),e.onSaveAsPsd()},css:{padding:"14px"},noRef:!0});n.append(o,a.BB.el({content:"✔ "+(0,l.LANG)("save-reminder-psd-layers"),css:{marginTop:"10px"}}));var h=new(0,u.BrowserStorageUi)({projectStore:this.projectStore,getProject:this.getProject,klRootEl:document.body,applyUncommitted:this.applyUncommitted,options:{hideClearButton:!0,isFocusable:!0},onStored:function(){return e.onStored()}});h.show(),r.append(h.getElement()),s.KL.popup({type:"warning",target:document.body,message:`<b>${(0,l.LANG)("save-reminder-title")}</b>`,div:i,ignoreBackground:!0,callback:function(){h.destroy(),a.BB.destroyEl(o),e.closeFunc=void 0,e.lastReminderShownAt=performance.now()},closeFunc:function(t){e.closeFunc=t}}),setTimeout(function(){o.focus()},40)}},{key:"init",value:function(){var e=this;void 0===this.lastSavedHistoryIndex&&(this.lastSavedHistoryIndex=this.klHistory.getTotalIndex(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),setInterval(function(){if("visible"===document.visibilityState){var t=Math.abs(e.klHistory.getTotalIndex()-e.lastSavedHistoryIndex),i=null!=p?p:6e4*({"20min":20,"40min":40,disabled:0})[e.setting];i>0&&0===s.KL.DIALOG_COUNTER.get()&&!e.isDrawing()&&e.lastReminderShownAt+i<performance.now()&&t>=g&&e.showPopup()}},5e3))}},{key:"reset",value:function(){void 0!==this.lastSavedHistoryIndex&&(this.lastSavedHistoryIndex=this.klHistory.getTotalIndex(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),window.onbeforeunload=null,this.closeFunc&&this.closeFunc())}},{key:"getSetting",value:function(){return this.setting}},{key:"setSetting",value:function(e){this.setting=e,h.LocalStorage.setItem(f,this.setting)}}]),e}()}),s("aCVlD",function(t,i){var n;e(t.exports,"psdWrapper",function(){return n},function(e){return n=e}),n="WKn-vG_psdWrapper"}),s("eyygR",function(t,i){e(t.exports,"SaveToComputer",function(){return d});var n=o("1LaJZ"),r=o("cx0mh"),s=o("7h4XF"),a=o("2gUX3"),l=o("eWjiX"),h=o("hrnUX"),c=o("6hBII"),u=o("hAS38"),p=o("eIcQa"),d=function(){"use strict";function e(t,i,n){(0,r._)(this,e),this.getExportType=t,this.klCanvas=i,this.onSaved=n,this.showSaveDialog=!0}return(0,s._)(e,[{key:"saveImage",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return(0,n._)(function(){var n;return(0,a.__generator)(this,function(o){switch(o.label){case 0:return[4,(0,p.canvasToBlob)(e,i)];case 1:return n=o.sent(),[4,(0,c.saveAs)(n,t,r)];case 2:return o.sent(),[2]}})})()}},{key:"save",value:function(e){return(0,n._)(function(){var t,i,n,r,o,s,p,d,g,f,v,m,y,x,b;return(0,a.__generator)(this,function(a){switch(a.label){case 0:if(t=this,e||(e=this.getExportType()),"png"!==e)return[3,5];i="image/png",n=l.BB.getDate()+u.KL_CONFIG.filenameBase+".png",r=this.klCanvas.getCompleteCanvas(1),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.saveImage(r,n,i,this.showSaveDialog)];case 2:return a.sent(),[3,4];case 3:throw a.sent(),alert("could not save"),Error("failed png export");case 4:return[3,11];case 5:if("layers"!==e)return[3,10];o="png",s="image/png",p=l.BB.getDate()+u.KL_CONFIG.filenameBase,d=this.klCanvas.getLayersFast(),g=0,a.label=6;case 6:if(!(g<d.length))return[3,9];return f=d[g],v=[p,"_",(""+(g+1)).padStart(2,"0"),"_",f.name,".",o],[4,this.saveImage(f.canvas,v.join(""),s)];case 7:a.sent(),a.label=8;case 8:return g++,[3,6];case 9:return[3,11];case 10:if("psd"===e){for(x=0,m=this.klCanvas.getLayersFast(),y={width:this.klCanvas.getWidth(),height:this.klCanvas.getHeight(),children:[],canvas:this.klCanvas.getCompleteCanvas(1)};x<m.length;x++)b=m[x],y.children.push({name:b.name,hidden:!b.isVisible,opacity:b.opacity,canvas:b.canvas,blendMode:h.KL.PSD.blendKlToPsd(b.mixModeStr),left:0,top:0});h.KL.loadAgPsd().then(function(e){var i=new Blob([e.writePsdBuffer(y)],{type:"image/vnd.adobe.photoshop"});(0,c.saveAs)(i,l.BB.getDate()+u.KL_CONFIG.filenameBase+".psd",t.showSaveDialog)}).catch(function(){alert("Error: failed to load PSD library")})}a.label=11;case 11:return this.onSaved(),[2]}})}).call(this)}},{key:"setShowSaveDialog",value:function(e){this.showSaveDialog=e}}]),e}()}),s("6hBII",function(t,i){e(t.exports,"saveAs",function(){return a});var n=o("1LaJZ"),r=o("2gUX3"),s={"image/png":{description:"PNG Image",accept:{"image/png":[".png"]}},"image/vnd.adobe.photoshop":{description:"Adobe Photoshop Document",accept:{"image/vnd.adobe.photoshop":[".psd"]}}};function a(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,n._)(function(){var o,a,l;return(0,r.__generator)(this,function(h){switch(h.label){case 0:if(!(o=i))return[3,2];return[4,(0,n._)(function(){var i,n,o,a;return(0,r.__generator)(this,function(r){switch(r.label){case 0:if(i=e.type,!("showSaveFilePicker"in window))return[3,8];if(!s[i])return console.error("unknown mime type:",i),[2,!1];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,window.showSaveFilePicker({suggestedName:t,types:[s[i]]})];case 2:return n=r.sent(),[3,4];case 3:if((o=r.sent())instanceof Error&&"AbortError"===o.name)return[2,!0];return console.log("unpredicted error",o),[2,!1];case 4:if(!n)return[2,!1];return[4,n.createWritable()];case 5:return[4,(a=r.sent()).write(e)];case 6:return r.sent(),[4,a.close()];case 7:return r.sent(),[2,!0];case 8:return[2,!1];case 9:return[2]}})})()];case 1:o=h.sent(),h.label=2;case 2:if(o)return[2];return(a=document.createElementNS("http://www.w3.org/1999/xhtml","a")).download=t,a.rel="noopener",a.href=l=URL.createObjectURL(e),setTimeout(function(){return URL.revokeObjectURL(l)},4e4),setTimeout(function(){document.body.appendChild(a),a.click(),document.body.removeChild(a)},1),[2]}})})()}}),s("hAS38",function(t,i){e(t.exports,"KL_CONFIG",function(){return n});var n={filenameBase:"Klecks"}}),s("7pyBK",function(t,i){e(t.exports,"BrushSettingService",function(){return s});var n=o("cx0mh"),r=o("7h4XF"),s=function(){"use strict";function e(t){if((0,n._)(this,e),this.subscriberArr=[],this.onSetColor=t.onSetColor,this.onSetSize=t.onSetSize,this.onSetOpacity=t.onSetOpacity,this.onSetScatter=t.onSetScatter,this.onGetColor=t.onGetColor,this.onGetSize=t.onGetSize,this.onGetOpacity=t.onGetOpacity,this.onGetScatter=t.onGetScatter,this.onGetSliderConfig=t.onGetSliderConfig,e.instance)throw Error("BrushSettingService already instantiated");e.instance=this}return(0,r._)(e,[{key:"emit",value:function(e,t){for(var i=0;i<this.subscriberArr.length;i++)this.subscriberArr[i]!==t&&this.subscriberArr[i](e)}},{key:"emitColor",value:function(e,t){this.emit({type:"color",value:e},t)}},{key:"emitSize",value:function(e,t){this.emit({type:"size",value:e},t)}},{key:"emitOpacity",value:function(e,t){this.emit({type:"opacity",value:e},t)}},{key:"emitScatter",value:function(e,t){this.emit({type:"scatter",value:e},t)}},{key:"emitSliderConfig",value:function(e,t){this.emit({type:"sliderConfig",value:e},t)}},{key:"setColor",value:function(e,t){this.onSetColor(e),this.emitColor(e,t)}},{key:"setSize",value:function(e,t){this.onSetSize(e)}},{key:"setOpacity",value:function(e,t){this.onSetOpacity(e)}},{key:"setScatter",value:function(e,t){this.onSetScatter(e)}},{key:"getColor",value:function(){return this.onGetColor()}},{key:"getSize",value:function(){return this.onGetSize()}},{key:"getOpacity",value:function(){return this.onGetOpacity()}},{key:"getScatter",value:function(){return this.onGetScatter()}},{key:"getSliderConfig",value:function(){return this.onGetSliderConfig()}},{key:"subscribe",value:function(e){this.subscriberArr.includes(e)||this.subscriberArr.push(e)}},{key:"unsubscribe",value:function(e){for(var t=0;t<this.subscriberArr.length;t++)e===this.subscriberArr[t]&&(this.subscriberArr.splice(t,1),t--)}}]),e}()}),s("byS9j",function(i,n){e(i.exports,"SettingsUi",function(){return B});var r=o("cx0mh"),s=o("7h4XF"),a=o("bX4ja"),l=o("eWjiX"),h=o("1mH1z"),c=o("hrnUX"),u=o("fgfvl"),p=o("bus7s"),d=o("ci8rB"),g=o("8IS1J"),f=o("6l0gQ"),v=o("1C8RU"),m=o("7jh4K"),y=o("2H29m"),x=o("amum4"),b=o("2MaaK"),w=o("72Jv0"),B=function(){"use strict";function e(i){var n=i.onLeftRight,o=i.saveReminder,s=i.customAbout;(0,r._)(this,e);var B=function(e){return"dark"===e?"⬛ "+(0,h.LANG)("theme-dark"):"⬜ "+(0,h.LANG)("theme-light")},k=function(){return l.BB.el({tagName:"a",content:(0,h.LANG)("licenses"),onClick:function(){return(0,y.showLicensesDialog)()}})};this.rootEl=l.BB.el({css:{margin:"10px"}});var S=h.LANGUAGE_STRINGS.getAutoLanguage(),C=l.BB.el({parent:this.rootEl,content:l.BB.el({content:(0,h.LANG)("settings-language")+":",css:{marginRight:"5px",marginBottom:"2px"}}),css:{display:"flex",alignItems:"center",flexWrap:"wrap"}}),E=[["auto",(0,h.LANG)("auto")+` \u{2192} ${S.name} (${S.code})`]].concat((0,a._)(u.languages.map(function(e){return[e.code,e.name+` (${e.code})`]}))),L=new c.KL.Select({initValue:(0,m.nullToUndefined)(f.LocalStorage.getItem(h.LS_LANGUAGE_KEY)?f.LocalStorage.getItem(h.LS_LANGUAGE_KEY):"auto"),optionArr:E,onChange:function(e){"auto"===e?f.LocalStorage.removeItem(h.LS_LANGUAGE_KEY):f.LocalStorage.setItem(h.LS_LANGUAGE_KEY,e),I.style.display="block"},name:"language"});(0,m.css)(L.getElement(),{flexGrow:"1"});var I=l.BB.el({className:"kl-toolspace-note",content:(0,h.LANG)("settings-language-reload"),css:{display:"none",marginTop:"5px",flexGrow:"1"}});C.append(L.getElement(),I);var T=new c.KL.Select({optionArr:[["auto",(0,h.LANG)("auto")+" → "+B(v.THEME.getMediaQueryTheme())],["light",B("light")],["dark",B("dark")]],initValue:v.THEME.getStoredTheme()||"auto",onChange:function(e){v.THEME.setStoredTheme("auto"===e?void 0:e)},name:"ui-theme"});if((0,m.css)(T.getElement(),{flexGrow:"1"}),(0,m.addIsDarkListener)(function(){T.updateLabel("auto",(0,h.LANG)("auto")+" → "+B(v.THEME.getMediaQueryTheme()))}),l.BB.el({parent:this.rootEl,content:[l.BB.el({content:(0,h.LANG)("settings-theme")+":",css:{marginRight:"5px",marginBottom:"2px"}}),T.getElement()],css:{marginTop:"15px",display:"flex",alignItems:"center",flexWrap:"wrap"}}),o){var A=new c.KL.Select({optionArr:[["20min",(0,h.LANG)("x-minutes",{x:"20"})],["40min",(0,h.LANG)("x-minutes",{x:"40"})],["disabled","⚠️ "+(0,h.LANG)("settings-save-reminder-disabled")]],initValue:o.getSetting(),onChange:function(e){if("disabled"!==e)return void o.setSetting(e);var t=(0,h.LANG)("settings-save-reminder-confirm-disable");(0,b.showModal)({target:document.body,message:"⚠️"+(0,h.LANG)("settings-save-reminder-confirm-title"),div:(0,x.c)("",[(0,x.c)(".info-hint",(0,h.LANG)("settings-save-reminder-confirm-a")),(0,h.LANG)("settings-save-reminder-confirm-b")]),buttons:[t,"Cancel"],callback:function(i){i===t?o.setSetting(e):A.setValue(o.getSetting())}})},name:"save-reminder-interval"});A.getElement().style.flexGrow="1",this.rootEl.append((0,x.c)(",flex,items-center,gap-5,mt-15,flexWrap",[(0,h.LANG)("settings-save-reminder-label")+":",A.getElement()]))}l.BB.el({tagName:"button",parent:this.rootEl,content:[(0,w.createImage)({alt:"icon",src:t(g),width:18,height:20,css:{marginRight:"5px"}}),(0,h.LANG)("switch-ui-left-right")],onClick:function(){return n()},css:{marginTop:"15px"},custom:{tabIndex:"-1"}}),this.rootEl.append(l.BB.el({className:"grid-hr",css:{margin:"10px 0"}})),s?(this.rootEl.append(s),s.innerHTML||l.BB.el({parent:s,css:{textAlign:"center"}}).append(l.BB.el({content:[(0,w.createImage)({alt:"icon",height:20,src:t(p),css:{verticalAlign:"middle"}})," ",l.BB.el({tagName:"a",content:"bitbof",custom:{href:"https://bitbof.com",target:"_blank",tabIndex:"-1"}})," © 2025",l.BB.el({tagName:"br"})]}),k())):l.BB.el({parent:this.rootEl,css:{textAlign:"center"},content:[(0,w.createImage)({alt:"Klecks",className:"dark-invert",height:25,src:t(d)}),l.BB.el({tagName:"br"}),(0,w.createImage)({alt:"icon",height:20,src:t(p),css:{verticalAlign:"middle"}})," ",l.BB.el({tagName:"a",content:"bitbof",custom:{href:"https://bitbof.com",target:"_blank",tabIndex:"-1"}})," © 2025",l.BB.el({tagName:"br"})]}).append(k(),document.createTextNode(" | "),l.BB.el({tagName:"a",content:(0,h.LANG)("donate"),custom:{href:"https://kleki.com/donate/",target:"_blank"}}),document.createTextNode(" | "),l.BB.el({tagName:"a",content:(0,h.LANG)("source-code"),custom:{href:"https://klecks.org",target:"_blank"}})),window.addEventListener("storage",function(e){e.key===h.LS_LANGUAGE_KEY&&L.setValue((0,m.nullToUndefined)(f.LocalStorage.getItem(h.LS_LANGUAGE_KEY)?f.LocalStorage.getItem(h.LS_LANGUAGE_KEY):"auto"))})}return(0,s._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("bus7s",function(e,t){e.exports=i("kSWIa")}),s("8IS1J",function(e,t){e.exports=i("4FMUg")}),s("2H29m",function(t,i){e(t.exports,"showLicensesDialog",function(){return h});var n=o("amum4"),r=o("c4qtG"),s=o("dLlkc"),a=o("eWjiX"),l=o("1mH1z");function h(){var e=(0,n.c)("."+r.licenses,(0,l.LANG)("loading")),t=(0,n.c)("."+r.licenses,(0,l.LANG)("loading")),i=(0,n.c)(",flex,flexCol,gap-10",[e,t]);new(0,s.DynamicModal)({title:a.BB.el({content:(0,l.LANG)("licenses")}),content:a.BB.el({content:i,css:{height:"100%",overflowY:"auto",padding:"10px",boxSizing:"border-box"}}),width:800,isMaxHeight:!0,onClose:function(){"#licenses"===window.location.hash&&history.replaceState("",document.title,window.location.pathname+window.location.search)}}),o("kUTcy").then(function(t){e.innerHTML="",t.LICENSES.forEach(function(t){e.append((0,n.c)("details",[(0,n.c)("summary",t.title),(0,n.c)("",t.full.replace(/\n/g,"<br>"))]))})}),o("6rG3P").then(function(e){t.innerHTML="",e.FONT_LICENSES.forEach(function(e){t.append((0,n.c)("details",[(0,n.c)("summary","Font: "+e.title),(0,n.c)("",e.full.replace(/\n/g,"<br>"))]))})})}}),s("c4qtG",function(t,i){var n;e(t.exports,"licenses",function(){return n},function(e){return n=e}),n="ttl1Ia_licenses"}),s("kUTcy",function(e,t){e.exports=o("ih7W4")(i("62mlz")).then(function(){return o("17YSH")})}),s("6rG3P",function(e,t){e.exports=o("ih7W4")(i("76QQo")).then(function(){return o("evhrb")})}),s("iVHpg",function(t,i){e(t.exports,"ToolspaceScroller",function(){return c});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("1mH1z"),l=o("i8UFO"),h=o("7jh4K"),c=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.toolspace=t.toolspace,this.upBtn=s.BB.el({parent:this.toolspace,title:(0,a.LANG)("scroll"),className:"kl-scroller",css:{top:"0",transform:"rotate(180deg)"}}),this.downBtn=s.BB.el({parent:this.toolspace,title:(0,a.LANG)("scroll"),className:"kl-scroller",css:{bottom:"0"}}),this.updateUiState(t.uiState),new s.BB.PointerListener({target:this.upBtn,onPointer:function(e){"pointerdown"===e.type&&(i.upInterval=setInterval(function(){i.toolspace.scrollBy(0,-13),i.update()},20)),"pointerup"===e.type&&(clearInterval(i.upInterval),setTimeout(function(){i.upInterval=null,i.update()},50))}}),new s.BB.PointerListener({target:this.downBtn,onPointer:function(e){"pointerdown"===e.type&&(i.downInterval=setInterval(function(){i.toolspace.scrollBy(0,13),i.update()},20)),"pointerup"===e.type&&(clearInterval(i.downInterval),setTimeout(function(){i.downInterval=null,i.update()},50))}});var r=function(e){i.toolspace.scrollBy(0,Math.round(.7*e.deltaY)),i.update()};this.upBtn.addEventListener("wheel",r,{passive:!1}),this.downBtn.addEventListener("wheel",r,{passive:!1}),this.update(),new MutationObserver(function(){return i.update()}).observe(this.toolspace,{attributes:!0,childList:!0,subtree:!0}),window.addEventListener("resize",function(){return i.update()}),l.DIALOG_COUNTER.subscribe(function(e){i.upBtn.style.opacity=e>=1?"0":"",i.downBtn.style.opacity=e>=1?"0":""})}return(0,r._)(e,[{key:"update",value:function(){var e=this.upBtn.style.display,t=this.downBtn.style.display;this.toolspace.scrollHeight>this.toolspace.offsetHeight+3?(this.upInterval||(e=0===this.toolspace.scrollTop?"none":"block"),this.downInterval||(t=this.toolspace.scrollTop+this.toolspace.offsetHeight+1>=this.toolspace.scrollHeight?"none":"block")):(e="none",t="none"),e!==this.upBtn.style.display&&(this.upBtn.style.display=e),t!==this.downBtn.style.display&&(this.downBtn.style.display=t)}},{key:"updateUiState",value:function(e){(0,h.css)(this.upBtn,{left:"left"===e?"0":"",right:"right"===e?"0":""}),(0,h.css)(this.downBtn,{left:"left"===e?"0":"",right:"right"===e?"0":""})}}]),e}()}),s("5Gc7M",function(t,i){e(t.exports,"GradientUi",function(){return p});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("aP0jf"),l=o("1mH1z"),h=o("7bWhB"),c=o("iFIyy"),u=o("7jh4K"),p=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.settings={opacity:1,type:"linear",doLockAlpha:!1,doSnap:!1,isReversed:!1,isEraser:!1},this.colorSlider=t.colorSlider,this.rootEl=s.BB.el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=s.BB.el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.iconArr=[],[0,1,2].forEach(function(){var e=s.BB.el({className:"dark-invert",css:{width:"33px",height:"33px",borderRadius:"3px",margin:"1px"}});i.iconArr.push(e)}),this.updateIcons();var r=new(0,c.Options)({optionArr:[{id:"linear",label:this.iconArr[0],title:(0,l.LANG)("gradient-linear")},{id:"linear-mirror",label:this.iconArr[1],title:(0,l.LANG)("gradient-linear-mirror")},{id:"radial",label:this.iconArr[2],title:(0,l.LANG)("gradient-radial")}],initId:"linear",onChange:function(e){i.settings.type=e}});this.rootEl.append(r.getElement());var o=new(0,a.KlSlider)({label:(0,l.LANG)("opacity"),width:250,height:30,min:.01,max:1,value:this.settings.opacity,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(e){i.settings.opacity=e}});(0,u.css)(o.getElement(),{marginTop:"10px"}),this.rootEl.append(o.getElement());var p=s.BB.el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),d=new(0,h.Checkbox)({init:!1,label:(0,l.LANG)("reverse"),callback:function(e){i.settings.isReversed=e,i.updateIcons()},css:{width:"50%"},name:"reverse-gradient"}),g=new(0,h.Checkbox)({init:!1,label:(0,l.LANG)("angle-snap"),title:(0,l.LANG)("angle-snap-title"),callback:function(e){i.settings.doSnap=e},css:{width:"50%"},name:"enable-snapping"});p.append(d.getElement(),g.getElement());var f=s.BB.el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),v=new(0,h.Checkbox)({init:this.settings.isEraser,label:(0,l.LANG)("eraser"),callback:function(e){i.settings.isEraser=e},css:{width:"50%"},name:"enable-eraser"}),m=new(0,h.Checkbox)({init:!1,label:(0,l.LANG)("lock-alpha"),title:(0,l.LANG)("lock-alpha-title"),callback:function(e){i.settings.doLockAlpha=e},doHighlight:!0,css:{width:"50%"},name:"enable-alpha-lock"});f.append(v.getElement(),m.getElement())}return(0,r._)(e,[{key:"updateIcons",value:function(){var e=this.settings.isReversed?"#0000":"#000",t=this.settings.isReversed?"#000":"#0000";this.iconArr[0].style.background=`linear-gradient(${e}, ${t})`,this.iconArr[1].style.background=`linear-gradient(${t}, ${e}, ${t})`,this.iconArr[2].style.background=`radial-gradient(${e}, ${t})`}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=e,this.rootEl.style.display=e?"block":"none",e&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}},{key:"getSettings",value:function(){return s.BB.copyObj(this.settings)}}]),e}()}),s("jmL5A",function(i,n){e(i.exports,"EmbedToolspaceTopRow",function(){return u});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("8IS1J"),h=o("8ae5f"),c=o("1mH1z"),u=function(){"use strict";function e(i){(0,r._)(this,e);var n=function(e){var t=6+(e.extraPadding?e.extraPadding:0),i=a.BB.el({className:"toolspace-row-button nohighlight",title:e.title,onClick:e.onClick,css:{padding:e.content?"":e.contain?t+"px 0":""}});if(e.content)i.append(e.content);else{var n=a.BB.el({className:"dark-invert",css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%"}});n.style.pointerEvents="none",i.append(n)}var r=new a.BB.PointerListener({target:i,onEnterLeave:function(e){i.classList.toggle("toolspace-row-button-hover",e)}});return{el:i,pointerListener:r}};this.rootEl=a.BB.el({className:"kl-toolspace-row",css:{height:"36px",display:"flex"}});var o=n({onClick:i.onSubmit,title:(0,c.LANG)("submit-title"),content:a.BB.el({content:(0,c.LANG)("submit"),className:"toolspace-row-button__submit",css:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%"}}),contain:!0});o.el.style.width="45px";var s=n({onClick:i.onHelp,title:(0,c.LANG)("help"),image:t(h),contain:!0}),u=n({onClick:i.onLeftRight,title:(0,c.LANG)("switch-ui-left-right"),image:t(l),contain:!0});this.rootEl.append(o.el,u.el,s.el)}return(0,s._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("iUR3L",function(t,i){e(t.exports,"importFilters",function(){return C});var n=o("kyVjY"),r=o("iiVKq"),s=o("lorQQ"),a=o("8Ri8I"),l=o("fADXF"),h=o("bIns5"),c=o("30jcG"),u=o("cCks8"),p=o("huXOx"),d=o("dsRff"),g=o("lhchB"),f=o("lXpcU"),v=o("1CjeM"),m=o("dNWKZ"),y=o("94Tq7"),x=o("d8Fqy"),b=o("gtdB1"),w=o("lQzx7"),B=o("10iZP"),k=o("dteOZ");function S(e,t){t.getDialog&&(e.getDialog=t.getDialog),e.apply=t.apply}function C(){n.FILTER_LIB_STATUS.isLoaded||(S(n.FILTER_LIB.brightnessContrast,r.filterBrightnessContrast),S(n.FILTER_LIB.cropExtend,s.filterCropExtend),S(n.FILTER_LIB.curves,a.filterCurves),S(n.FILTER_LIB.flip,l.filterFlip),S(n.FILTER_LIB.hueSaturation,h.filterHueSaturation),S(n.FILTER_LIB.invert,c.filterInvert),S(n.FILTER_LIB.perspective,u.filterPerspective),S(n.FILTER_LIB.resize,p.filterResize),S(n.FILTER_LIB.rotate,d.filterRotate),S(n.FILTER_LIB.tiltShift,g.filterTiltShift),S(n.FILTER_LIB.transform,f.filterTransform),S(n.FILTER_LIB.blur,v.filterBlur),S(n.FILTER_LIB.unsharpMask,m.filterUnsharpMask),S(n.FILTER_LIB.toAlpha,y.filterToAlpha),S(n.FILTER_LIB.grid,x.filterGrid),S(n.FILTER_LIB.noise,b.filterNoise),S(n.FILTER_LIB.pattern,w.filterPattern),S(n.FILTER_LIB.distort,B.filterDistort),S(n.FILTER_LIB.vanishPoint,k.filterVanishPoint),n.FILTER_LIB_STATUS.isLoaded=!0)}}),s("iiVKq",function(t,i){e(t.exports,"filterBrightnessContrast",function(){return g});var n=o("aP0jf"),r=o("cH2YE"),s=o("1mH1z"),a=o("9tQ35"),l=o("jpkXO"),h=o("eWjiX"),c=o("bh77f"),u=o("ChldL"),p=o("g6KQ0"),d=o("7jh4K"),g={getDialog(e){var t=h.BB.el(),i={element:t},o=(0,c.testIsSmall)();o||(i.width=(0,u.getPreviewWidth)(o));var p=e.context,g=e.klCanvas;if(!p||!g)return!1;var f=g.getLayers(),v=g.getLayerIndex(p.canvas),m=0,y=0,x=new(0,a.FxPreviewRenderer)({original:p.canvas,onUpdate:function(e){return e.brightnessContrast(m,y)},selection:g.getSelection()}),b=new(0,n.KlSlider)({label:(0,s.LANG)("filter-bright-contrast-brightness"),width:300,height:30,min:0,max:100,value:(m+1)*50,eventResMs:r.EVENT_RES_MS,onChange:function(e){m=e/50-1,S.render()}}),w=new(0,n.KlSlider)({label:(0,s.LANG)("filter-bright-contrast-contrast"),width:300,height:30,min:0,max:100,value:(y+1)*50,eventResMs:r.EVENT_RES_MS,onChange:function(e){y=e/50-1,S.render()}});b.getElement().style.marginBottom="10px",w.getElement().style.marginBottom="10px",t.append(b.getElement(),w.getElement());for(var B=[],k=0;k<f.length;k++)B.push({image:k===v?x.render:f[k].context.canvas,isVisible:f[k].isVisible,opacity:f[k].opacity,mixModeStr:f[k].mixModeStr,hasClipping:!1});var S=new(0,l.Preview)({width:(0,u.getPreviewWidth)(o),height:(0,u.getPreviewHeight)(o),project:{width:p.canvas.width,height:p.canvas.height,layers:B},selection:g.getSelection()});return S.render(),(0,d.css)(S.getElement(),{marginLeft:"-20px",marginRight:"-20px"}),t.append(S.getElement()),i.destroy=function(){b.destroy(),w.destroy(),x.destroy(),S.destroy()},i.getInput=function(){return i.destroy(),{brightness:m,contrast:y}},i},apply(e){var t=e.layer.context,i=e.input.brightness,n=e.input.contrast,r=e.klHistory;return!!t&&(0,p.applyFxFilter)(t,e.klCanvas.getSelection(),function(e){e.brightnessContrast(i,n)},r)}}}),s("cH2YE",function(t,i){e(t.exports,"EVENT_RES_MS",function(){return n});var n=60}),s("9tQ35",function(t,i){e(t.exports,"FxPreviewRenderer",function(){return b});var n=o("cx0mh"),r=o("7h4XF"),s=o("bX4ja"),a=o("eWjiX"),l=o("a5EFw"),h=o("7jh4K");o("ciAU9");var c=o("83Kse"),u=o("cdZRx"),p=o("dZ59l"),d=o("kDVZW"),g=o("kr2fR"),f=o("kFecW"),v=o("1GsyD"),m=o("fzzhO"),y=o("eIcQa"),x=o("bbA6w"),b=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.texture=void 0,this.maskCanvas=void 0,this.maskTexture=void 0,this.oldOnUpdateProps={textureWidth:0,textureHeight:0,transform:{scaleX:0,scaleY:0,angleDeg:0,x:0,y:0}},this.render=function(e,t,n){var r=(0,v.createMatrixFromTransform)(e),o=(0,c.identity)(),l=(0,u.applyToPoint)(r,{x:0,y:0}),h=(0,u.applyToPoint)(r,{x:i.original.width,y:i.original.height});h.x=Math.round(h.x),h.y=Math.round(h.y);var b={x:Math.max(0,l.x),y:Math.max(0,l.y)},w={x:Math.min(t-0,h.x),y:Math.min(n-0,h.y)};if((A={x:b.x,y:b.y,width:w.x-b.x,height:w.y-b.y}).width<=0||A.height<=0)return i.textureSource.width=1,i.textureSource.height=1,i.textureSource;var B=(0,p.compose)((0,d.inverse)(r),(0,g.translate)(0,0),(0,g.translate)(A.x-0,A.y-0)),k={textureWidth:Math.ceil(A.width),textureHeight:Math.ceil(A.height),transform:{scaleX:e.scaleX,scaleY:e.scaleY,angleDeg:e.angleDeg,x:e.x-A.x,y:e.y-A.y}},S=0,C=0;if(e.scaleX>1){var E=(0,u.applyToPoint)(B,{x:0,y:0});S=-E.x,C=-E.y,E.x=Math.max(0,Math.floor(E.x)),E.y=Math.max(0,Math.floor(E.y)),S+=E.x,C+=E.y;var L=(0,u.applyToPoint)(B,{x:A.width,y:A.height});L.x=Math.min(i.original.width,Math.ceil(L.x)),L.y=Math.min(i.original.height,Math.ceil(L.y));var I=L.x-E.x,T=L.y-E.y;k.textureWidth=I,k.textureHeight=T,k.transform={scaleX:1,scaleY:1,angleDeg:0,x:-E.x,y:-E.y},B=(0,p.compose)(B,(0,f.scale)(e.scaleX,e.scaleY),(0,g.translate)(S,C))}if(!i.texture||JSON.stringify(k)!==JSON.stringify(i.oldOnUpdateProps)||i.postMix){i.textureSource.width=k.textureWidth,i.textureSource.height=k.textureHeight,i.ctx.save(),i.ctx.imageSmoothingEnabled=!1,e.scaleX>1?(o=(0,v.createMatrixFromTransform)(k.transform),(M=i.ctx).setTransform.apply(M,(0,s._)((0,m.matrixToTuple)(o)))):(o=(0,d.inverse)(B),(R=i.ctx).setTransform.apply(R,(0,s._)((0,m.matrixToTuple)(o)))),i.ctx.drawImage(i.original,0,0),i.ctx.restore();var A,M,R,_=JSON.stringify(k)!==JSON.stringify(i.oldOnUpdateProps);if((!i.texture||_)&&(i.texture?i.texture.loadContentsOf(i.textureSource):i.texture=i.fxCanvas.texture(i.textureSource)),i.selection&&(!i.maskTexture||_)){i.maskCanvas?(i.maskCanvas.width=k.textureWidth,i.maskCanvas.height=k.textureHeight):i.maskCanvas=a.BB.canvas(k.textureWidth,k.textureHeight);var P=a.BB.ctx(i.maskCanvas),D=(0,x.transformMultiPolygon)(i.selection,o);(0,y.drawSelectionMask)(D,P),i.maskTexture?i.maskTexture.loadContentsOf(i.maskCanvas):i.maskTexture=i.fxCanvas.texture(i.maskCanvas)}i.postMix||(i.textureSource.width=1,i.textureSource.height=1)}return(i.oldOnUpdateProps=k,i.onUpdate(i.fxCanvas.draw(i.texture),k.transform),i.maskTexture&&i.fxCanvas.multiplyAlpha().mask(i.maskTexture,i.isMaskingWithEmptyOriginal?void 0:i.texture).unmultiplyAlpha(),i.fxCanvas.update(),i.postMix)?(i.ctx.save(),i.ctx.globalAlpha=i.postMix.opacity,i.ctx.globalCompositeOperation=i.postMix.operation,i.ctx.drawImage(i.fxCanvas,0,0),i.ctx.restore(),{image:i.textureSource,transform:B}):{image:i.fxCanvas,transform:B}},this.original=t.original,this.onUpdate=t.onUpdate,this.textureSource=a.BB.canvas(1,1),this.ctx=a.BB.ctx(this.textureSource),this.fxCanvas=(0,h.throwIfNull)((0,l.getSharedFx)()),this.postMix=t.postMix,this.selection=t.selection,this.isMaskingWithEmptyOriginal=!!t.isMaskingWithEmptyOriginal}return(0,r._)(e,[{key:"setPostMix",value:function(e){this.postMix=e}},{key:"destroy",value:function(){var e;a.BB.freeCanvas(this.textureSource),this.maskCanvas&&a.BB.freeCanvas(this.maskCanvas),this.texture&&(this.texture=this.fxCanvas.texture(this.textureSource),this.fxCanvas.draw(this.texture).update(),this.texture&&this.texture.destroy()),null==(e=this.maskTexture)||e.destroy()}}]),e}()}),s("g6KQ0",function(t,i){e(t.exports,"applyFxFilter",function(){return u});var n=o("eWjiX"),r=o("eIcQa"),s=o("3Fob6"),a=o("4sWjZ"),l=o("eg83P"),h=o("g03EN"),c=o("a5EFw");function u(e,t,i,o){var u,p=(0,c.getSharedFx)();if(!p)return!1;if(t){var d=n.BB.canvas(e.canvas.width,e.canvas.height),g=n.BB.ctx(d);(0,r.drawSelectionMask)(t,g),u=p.texture(d),n.BB.freeCanvas(d)}var f=p.texture(e.canvas);return p.draw(f),i(p),u&&(p.multiplyAlpha().mask(u,f).unmultiplyAlpha(),u.destroy()),f.destroy(),p.update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(p,0,0),o.push((0,s.getPushableLayerChange)(o.getComposed(),(0,a.canvasToLayerTiles)(e.canvas,t?(0,l.integerBounds)((0,h.getMultiPolyBounds)(t)):void 0))),!0}}),s("lorQQ",function(t,i){e(t.exports,"filterCropExtend",function(){return d});var n=o("eWjiX"),r=o("dJPtW"),s=o("7bWhB"),a=o("43qNf"),l=o("32CBv"),h=o("1mH1z"),c=o("ChldL"),u=o("eg83P"),p=o("g03EN"),d={getDialog(e){var t=e.klCanvas;if(!t)return!1;var i=n.BB.canvas(),o=n.BB.fitInto(t.getWidth(),t.getHeight(),560,400,1),d=parseInt(""+o.width),g=parseInt(""+o.height),f=d/t.getWidth();i.width=d,i.height=g,i.style.display="block",n.BB.ctx(i).drawImage(t.getCompleteCanvas(f),0,0,d,g);var v=n.BB.el(),m={element:v},y=0,x=0,b=0,w=0,B=!1,k=!1,S=!1,C=!1,E=e.maxWidth,L=e.maxHeight,I=1,T=t.getSelection(),A=T?(0,u.intBoundsWithinArea)((0,p.getMultiPolyBounds)(T),t.getWidth(),t.getHeight()):void 0;if(A){var M=A.x2-A.x1,R=A.y2-A.y1;M<=E&&R<=L?(b=A.y1,x=A.x2-t.getWidth(),w=A.y2-t.getHeight(),y=A.x1):A=void 0}var _=(0,r.input)({init:y,type:"number",min:-t.getWidth(),max:E,css:{width:"75px"},callback:function(){B=!0,V()}}),P=(0,r.input)({init:x,type:"number",min:-t.getWidth(),max:E,css:{width:"75px"},callback:function(){k=!0,V()}}),D=(0,r.input)({init:b,type:"number",min:-t.getHeight(),max:L,css:{width:"75px"},callback:function(){S=!0,V()}}),N=(0,r.input)({init:w,type:"number",min:-t.getHeight(),max:L,css:{width:"75px"},callback:function(){C=!0,V()}}),O={display:"flex",flexDirection:"column",width:"calc(50% - 5px)",gap:"3px"},G=n.BB.el({content:[(0,h.LANG)("filter-crop-left")+":",_],css:O}),H=n.BB.el({content:[(0,h.LANG)("filter-crop-right")+":",P],css:O}),z=n.BB.el({content:[(0,h.LANG)("filter-crop-top")+":",D],css:O}),j=n.BB.el({content:[(0,h.LANG)("filter-crop-bottom")+":",N],css:O}),F=n.BB.el({css:{display:"flex",flexWrap:"wrap",gap:"10px"}});function V(){y=parseInt(_.value),x=parseInt(P.value),b=parseInt(D.value),w=parseInt(N.value);var e=t.getWidth()+y+x,i=t.getHeight()+b+w;e<=0&&(B&&(_.value=""+(y=-t.getWidth()-x+1)),k&&(P.value=""+(x=-t.getWidth()-y+1)),e=1),e>E&&(B&&(_.value=""+(y=-t.getWidth()-x+E)),k&&(P.value=""+(x=-t.getWidth()-y+E)),e=E),i<=0&&(S&&(D.value=""+(b=-t.getHeight()-w+1)),C&&(N.value=""+(w=-t.getHeight()-b+1)),i=1),i>L&&(S&&(D.value=""+(b=-t.getHeight()-w+L)),C&&(N.value=""+(w=-t.getHeight()-b+L)),i=L),et.setTransform({x:-y,y:-b,width:e,height:i}),B=!1,k=!1,S=!1,C=!1}F.append(G,H,z,j),v.append(F);var U=!0,W=new(0,s.Checkbox)({init:!0,label:(0,h.LANG)("filter-crop-rule-thirds"),allowTab:!0,callback:function(e){U=e,et.showThirds(U)},name:"rule-of-thirds"});v.append(n.BB.el({css:{clear:"both"}}));var X={r:0,g:0,b:0,a:0},K=[{r:0,g:0,b:0,a:0},{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1}];K.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),K.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1});var Y=new(0,a.ColorOptions)({label:(0,h.LANG)("filter-crop-fill"),colorArr:K,onChange:function(e){0===(X=e).a?(J.style.background="",i.style.background=""):(J.style.background=n.BB.ColorConverter.toRgbStr(X),i.style.background="var(--kl-checkerboard-background)",i.style.backgroundSize=100*I+"px")}}),Z=n.BB.el({css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"10px"}});function q(e){var r=n.BB.fitInto(e.width,e.height,260,180,1);I=r.width/e.width;var o=n.BB.centerWithin(c.SMALL_PREVIEW.width,$,r.width,r.height);i.style.width=t.getWidth()*I+"px",i.style.height=t.getHeight()*I+"px",ee.style.left=o.x-e.x*I+"px",ee.style.top=o.y-e.y*I+"px",y=parseInt(""+-e.x),b=parseInt(""+-e.y),x=parseInt(""+(e.x+e.width-t.getWidth())),w=parseInt(""+(e.y+e.height-t.getHeight())),_.value=""+y,D.value=""+b,P.value=""+x,N.value=""+w,0!==X.a&&(i.style.background="var(--kl-checkerboard-background)",i.style.backgroundSize=100*I+"px"),Q.style.backgroundPosition=o.x+"px "+o.y+"px",Q.style.backgroundSize=100*I+"px",et.setScale(I)}v.append(Z),Z.append(W.getElement(),Y.getElement());var $=c.SMALL_PREVIEW.height-2,Q=n.BB.el({className:"kl-edit-crop-preview",css:{width:c.SMALL_PREVIEW.width+"px",marginTop:"10px",marginLeft:"-20px",height:$+"px",backgroundColor:"#9e9e9e",position:"relative",borderTop:"1px solid rgb(144,144,144)",borderBottom:"1px solid rgb(144,144,144)",overflow:"hidden",userSelect:"none",touchAction:"none",background:"var(--kl-checkerboard-background)"}});Q.oncontextmenu=function(){return!1};var J=n.BB.el({css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"}});Q.append(J);var ee=n.BB.el({parent:Q,css:{position:"absolute",left:"0",top:"0"}});n.BB.el({parent:ee,content:i,css:{boxShadow:"0 0 0px 1px rgb(130,130,130)",position:"absolute",left:"0px",top:"0px"}}),v.append(Q);var et=new(0,l.Cropper)({x:0,y:0,width:t.getWidth(),height:t.getHeight(),scale:I,callback:q,maxW:E,maxH:L,init:A});return q(et.getTransform()),ee.append(et.getElement()),m.destroy=function(){et.destroy(),W.destroy(),Y.destroy()},m.getInput=function(){return m.destroy(),{left:y,right:x,top:b,bottom:w,fillColor:0===X.a?void 0:X}},m},apply(e){var t=e.klCanvas;return!(!t||isNaN(e.input.left)||isNaN(e.input.right)||isNaN(e.input.top)||isNaN(e.input.bottom))&&(t.resizeCanvas(e.input),!0)}}}),s("8Ri8I",function(t,i){e(t.exports,"filterCurves",function(){return p});var n=o("eWjiX"),r=o("hRvnE"),s=o("9tQ35"),a=o("jpkXO"),l=o("bh77f"),h=o("ChldL"),c=o("g6KQ0"),u=o("7jh4K"),p={getDialog(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var o=i.getLayers(),c=i.getLayerIndex(t.canvas),p=n.BB.el(),d={element:p},g=(0,l.testIsSmall)();g||(d.width=(0,h.getPreviewWidth)(g));for(var f=(0,r.getDefaultCurvesInput)(),v=new(0,s.FxPreviewRenderer)({original:t.canvas,onUpdate:function(e){return e.curves(f.r,f.g,f.b)},selection:i.getSelection()}),m=[],y=0;y<o.length;y++)m.push({image:y===c?v.render:o[y].context.canvas,isVisible:o[y].isVisible,opacity:o[y].opacity,mixModeStr:o[y].mixModeStr,hasClipping:!1});var x=new(0,a.Preview)({width:(0,h.getPreviewWidth)(g),height:(0,h.getPreviewHeight)(g),project:{width:t.canvas.width,height:t.canvas.height,layers:m},selection:i.getSelection()});(0,u.css)(x.getElement(),{marginLeft:"-20px",marginRight:"-20px"});var b=new(0,r.CurvesInput)({curves:f,callback:function(e){f=e,x.render()}}),w=b.getModeButtons();return p.append(b.getElement(),x.getElement()),d.destroy=function(){b.destroy(),w.destroy(),v.destroy(),x.destroy()},d.getInput=function(){return d.destroy(),{curves:f}},d},apply(e){var t=e.layer.context,i=e.input.curves,n=e.klHistory;return!!t&&(0,c.applyFxFilter)(t,e.klCanvas.getSelection(),function(e){e.curves(i.r,i.g,i.b)},n)}}}),s("hRvnE",function(t,i){e(t.exports,"getDefaultCurvesInput",function(){return c}),e(t.exports,"CurvesInput",function(){return u});var n=o("cx0mh"),r=o("7h4XF"),s=o("iFIyy"),a=o("1mH1z"),l=o("eWjiX"),h=o("7jh4K");function c(){return l.BB.copyObj({r:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],g:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],b:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]]})}var u=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.rootEl=l.BB.el({css:{position:"relative",marginBottom:"10px"}}),this.rootEl.oncontextmenu=function(){return!1};var r="All",o=t.curves;this.modeButtons=new(0,s.Options)({optionArr:[{id:"All",label:(0,a.LANG)("filter-curves-all")},{id:"Red",label:(0,a.LANG)("red")},{id:"Green",label:(0,a.LANG)("green")},{id:"Blue",label:(0,a.LANG)("blue")}],initId:"All",onChange:function(e){"All"===(r=e)&&(o=c());var t=o.r;"Green"===r&&(t=o.g),"Blue"===r&&(t=o.b),i.p0.setPos(0,d-t[0][1]*d),i.p1.setPos(t[1][0]*p,d-t[1][1]*d),i.p2.setPos(t[2][0]*p,d-t[2][1]*d),i.p3.setPos(p,d-t[3][1]*d),x()}}),this.rootEl.append(this.modeButtons.getElement());var u=l.BB.el({parent:this.rootEl,className:"kl-curves-graph",css:{position:"relative",marginTop:"10px"}}),p=300,d=100,g=l.BB.canvas(p,d),f=l.BB.ctx(g);u.append(g);var v=function(e){return Math.max(0,Math.min(1,e))},m=function(e,t,i,n){var r=t,o=e,s=l.BB.el({className:"kl-curves-graph__grip",css:{left:e-7+"px",top:t-7+"px",width:"14px",height:"14px",borderRadius:"14px"}}),a=function(){(0,h.css)(s,{left:e-7+"px",top:t-7+"px"})},c=new l.BB.PointerListener({target:s,onPointer:function(s){s.eventPreventDefault(),"pointerdown"===s.type&&(o=e,r=t),"left"===s.button&&"pointermove"===s.type&&(n||(o+=s.dX),e=Math.max(0,Math.min(p,o)),r+=s.dY,t=Math.max(0,Math.min(d,r)),a(),i({x:e,y:t}))}});return u.append(s),{el:s,setPos:function(i,n){e=i,r=t=n,o=e,(0,h.css)(s,{left:e-7+"px",top:t-7+"px"})},pointerListener:c}},y=function(e,t,i){"All"===r&&(o.r[e]=[v(t/p),v(1-i/d)],o.g[e]=[v(t/p),v(1-i/d)],o.b[e]=[v(t/p),v(1-i/d)]),"Red"===r&&(o.r[e]=[v(t/p),v(1-i/d)]),"Green"===r&&(o.g[e]=[v(t/p),v(1-i/d)]),"Blue"===r&&(o.b[e]=[v(t/p),v(1-i/d)])};this.p0=m(0,d,function(e){y(0,e.x,e.y),x()},!0),this.p1=m(p/3,d/3*2,function(e){y(1,e.x,e.y),x()}),this.p2=m(p/3*2,d/3,function(e){y(2,e.x,e.y),x()}),this.p3=m(p,0,function(e){y(3,e.x,e.y),x()},!0);var x=function(){(f=l.BB.ctx(g)).clearRect(0,0,g.width,g.height);for(var e={r:[],g:[],b:[]},i=0;i<o.r.length;i++)e.r.push(o.r[i]),e.g.push(o.g[i]),e.b.push(o.b[i]);var n=function(e){f.beginPath();for(var t=new l.BB.SplineInterpolator(e),i=0;i<100;i++){var n=t.interpolate(i/100);n=Math.max(0,Math.min(1,n)),0===i?f.moveTo(i/100*p,d-n*d):f.lineTo(i/100*p,d-n*d)}f.stroke()};f.save(),"All"===r?(f.strokeStyle="black",n(e.r)):(f.globalAlpha=.5,f.strokeStyle="red",n(e.r),f.strokeStyle="green",n(e.g),f.strokeStyle="blue",n(e.b)),f.restore(),t.callback(e)};x()}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getModeButtons",value:function(){return this.modeButtons}},{key:"destroy",value:function(){this.p0.pointerListener.destroy(),this.p1.pointerListener.destroy(),this.p2.pointerListener.destroy(),this.p3.pointerListener.destroy()}}]),e}()}),s("fADXF",function(t,i){e(t.exports,"filterFlip",function(){return u});var n=o("eWjiX"),r=o("7bWhB"),s=o("5UrL9"),a=o("1mH1z"),l=o("7jh4K"),h=o("iFIyy"),c=o("ChldL"),u={getDialog(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var o=i.getLayers(),l=i.getLayerIndex(t.canvas),u=n.BB.fitInto(t.canvas.width,t.canvas.height,280,200,1),p=parseInt(""+u.width),d=parseInt(""+u.height),g=n.BB.el(),f={element:g},v=!0,m=!1,y=!0,x=new(0,r.Checkbox)({init:v,label:(0,a.LANG)("filter-flip-horizontal")+" ⟷",allowTab:!0,callback:function(e){v=e,E()},css:{marginBottom:"10px"},name:"flip-horizontal"}),b=new(0,r.Checkbox)({init:m,label:(0,a.LANG)("filter-flip-vertical")+" ↕",allowTab:!0,callback:function(e){m=e,E()},css:{marginBottom:"10px"},name:"flip-vertical"});g.append(x.getElement()),g.append(b.getElement());var w=new(0,h.Options)({optionArr:[{id:!0,label:(0,a.LANG)("filter-flip-image")},{id:!1,label:(0,a.LANG)("filter-flip-layer")}],onChange:function(e){y=e,E()}});g.append(w.getElement());var B=n.BB.el({className:"kl-preview-wrapper",css:{width:c.SMALL_PREVIEW.width+"px",height:c.SMALL_PREVIEW.height+"px"}}),k={image:n.BB.canvas(Math.round(p),Math.round(d)),isVisible:!0,opacity:1,mixModeStr:"source-over"},S=new(0,s.KlCanvasPreview)({width:Math.round(p),height:Math.round(d),layers:[k]}),C=n.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+p)+"px",height:parseInt(""+d)+"px"}});function E(){var e=n.BB.ctx(k.image);e.save(),e.clearRect(0,0,k.image.width,k.image.height),y&&(v&&(e.translate(k.image.width,0),e.scale(-1,1)),m&&(e.translate(0,k.image.height),e.scale(1,-1)));for(var t=0;t<o.length;t++)o[t].isVisible&&(e.save(),!y&&l===t&&(v&&(e.translate(k.image.width,0),e.scale(-1,1)),m&&(e.translate(0,k.image.height),e.scale(1,-1))),e.canvas.width>o[t].context.canvas.width&&(e.imageSmoothingEnabled=!1),e.globalAlpha=o[t].opacity,e.globalCompositeOperation=o[t].mixModeStr,e.drawImage(o[t].context.canvas,0,0,k.image.width,k.image.height),e.restore());S.render(),e.restore()}return C.append(S.getElement()),B.append(C),setTimeout(E,0),g.append(B),f.destroy=function(){x.destroy(),b.destroy(),w.destroy(),S.destroy()},f.getInput=function(){return f.destroy(),{horizontal:v,vertical:m,flipCanvas:y}},f},apply(e){var t=e.layer.context,i=e.klCanvas,n=e.input.horizontal,r=e.input.vertical,o=e.input.flipCanvas;return!!t&&!!i&&(i.flip(n,r,o?void 0:(0,l.throwIfNull)(i.getLayerIndex(t.canvas))),!0)}}}),s("bIns5",function(t,i){e(t.exports,"filterHueSaturation",function(){return g});var n=o("cH2YE"),r=o("aP0jf"),s=o("1mH1z"),a=o("9tQ35"),l=o("jpkXO"),h=o("eWjiX"),c=o("bh77f"),u=o("ChldL"),p=o("g6KQ0"),d=o("7jh4K"),g={getDialog(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var o=i.getLayers(),p=i.getLayerIndex(t.canvas),g=h.BB.el(),f={element:g},v=(0,c.testIsSmall)();v||(f.width=(0,u.getPreviewWidth)(v));var m=0,y=0,x=new(0,a.FxPreviewRenderer)({original:t.canvas,onUpdate:function(e){return e.hueSaturation(m,y)},selection:i.getSelection()}),b=new(0,r.KlSlider)({label:(0,s.LANG)("filter-hue-sat-hue"),width:300,height:30,min:-100,max:100,value:100*m,eventResMs:n.EVENT_RES_MS,onChange:function(e){m=e/100,S.render()}}),w=new(0,r.KlSlider)({label:(0,s.LANG)("filter-hue-sat-saturation"),width:300,height:30,min:0,max:100,value:(y+1)*50,eventResMs:n.EVENT_RES_MS,onChange:function(e){y=e/50-1,S.render()}});b.getElement().style.marginBottom="10px",w.getElement().style.marginBottom="10px",g.append(b.getElement(),w.getElement());for(var B=[],k=0;k<o.length;k++)B.push({image:k===p?x.render:o[k].context.canvas,isVisible:o[k].isVisible,opacity:o[k].opacity,mixModeStr:o[k].mixModeStr,hasClipping:!1});var S=new(0,l.Preview)({width:(0,u.getPreviewWidth)(v),height:(0,u.getPreviewHeight)(v),project:{width:t.canvas.width,height:t.canvas.height,layers:B},selection:i.getSelection()});return S.render(),(0,d.css)(S.getElement(),{marginLeft:"-20px",marginRight:"-20px"}),g.append(S.getElement()),f.destroy=function(){b.destroy(),w.destroy(),x.destroy(),S.destroy()},f.getInput=function(){return f.destroy(),{hue:m,saturation:y}},f},apply(e){var t=e.layer.context,i=e.input.hue,n=e.klHistory,r=e.input.saturation;return!!t&&null!==i&&null!==r&&(0,p.applyFxFilter)(t,e.klCanvas.getSelection(),function(e){e.hueSaturation(i,r)},n)}}}),s("30jcG",function(t,i){e(t.exports,"filterInvert",function(){return r});var n=o("g6KQ0"),r={apply(e){var t=e.layer.context,i=e.klHistory;return!!t&&(0,n.applyFxFilter)(t,e.klCanvas.getSelection(),function(e){e.invert()},i)}}}),s("cCks8",function(t,i){e(t.exports,"filterPerspective",function(){return v});var n=o("bX4ja"),r=o("eWjiX"),s=o("a5EFw"),a=o("1mH1z"),l=o("5vheV");o("ciAU9");var h=o("cdZRx"),c=o("jpkXO"),u=o("7jh4K"),p=o("3xvcu"),d=o("bh77f"),g=o("ChldL"),f=o("4sWjZ"),v={getDialog(e){var t,i=e.context,o=e.klCanvas;if(!i||!o)return!1;var f=(0,d.testIsSmall)(),v=o.getLayers(),m=o.getLayerIndex(i.canvas),y=r.BB.el(),x={element:y};f||(x.width=g.MEDIUM_PREVIEW.width);var b=(0,u.throwIfNull)((0,s.getSharedFx)()),w=(0,u.throwIfUndefined)(null==b?void 0:b.texture(i.canvas));function B(){L?b.draw(w).update():b.draw(w).perspective(E(S),E(C)).update(),M.render()}var k=[{x:0,y:0},{x:i.canvas.width,y:0},{x:i.canvas.width,y:i.canvas.height},{x:0,y:i.canvas.height}],S=k.map(function(e){return new(0,p.DraggableInput)({value:e,onChange:function(){B()}})});S.forEach(function(e){return e.getElement().style.display="none"});var C=k.map(function(e){return new(0,p.DraggableInput)({value:e,onChange:function(){B()}})});function E(e,t){return e.flatMap(function(e){var i=e.getValue();return t&&(i=(0,h.applyToPoint)(t,i)),[i.x,i.y]})}var L=!1,I=new(0,l.TwoTabs)({left:(0,a.LANG)("compare-before"),right:(0,a.LANG)("compare-after"),init:1,onChange:function(e){(L=0===e)?(S.forEach(function(e){return e.getElement().style.display="block"}),C.forEach(function(e){return e.getElement().style.display="none"})):(S.forEach(function(e,t){C[t].setValue(e.getValue())}),S.forEach(function(e){return e.getElement().style.display="none"}),C.forEach(function(e){return e.getElement().style.display="block"})),B()}});y.append(I.getElement());for(var T=[],A=0;A<v.length;A++)T.push({image:A===m?b:v[A].context.canvas,isVisible:v[A].isVisible,opacity:v[A].opacity,mixModeStr:v[A].mixModeStr,hasClipping:!1});var M=new(0,c.Preview)({width:(0,g.getPreviewWidth)(f),height:(0,g.getPreviewHeight)(f),project:{width:i.canvas.width,height:i.canvas.height,layers:T},onTransformChange:function(e){S.forEach(function(t){return t.setTransform(e)}),C.forEach(function(t){return t.setTransform(e)})}});return(0,u.css)(M.getElement(),{overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"}),(t=M.getElement()).append.apply(t,(0,n._)(S.map(function(e){return e.getElement()})).concat((0,n._)(C.map(function(e){return e.getElement()})))),y.append(M.getElement()),B(),x.destroy=function(){M.destroy(),w.destroy(),S.forEach(function(e){return e.destroy()}),C.forEach(function(e){return e.destroy()})},x.getInput=function(){return x.destroy(),{before:E(S),after:E(C)}},x},apply(e){var t=e.layer.context,i=e.klHistory,n=e.input.before,r=e.input.after;if(!t||!n||!r)return!1;var o=(0,s.getSharedFx)();if(!o)return!1;var a=o.texture(t.canvas);o.draw(a).multiplyAlpha().perspective(n,r).unmultiplyAlpha().update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(o,0,0),a.destroy();var l=Object.fromEntries(e.klCanvas.getLayers().map(function(t){return t.id===e.layer.id?[t.id,{tiles:(0,f.canvasToLayerTiles)(e.layer.canvas)}]:[t.id,{}]}));return i.push({layerMap:l}),!0}}}),s("5vheV",function(t,i){e(t.exports,"TwoTabs",function(){return a});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.value=t.init,this.rootEl=s.BB.el({className:"kl-2-tabs"}),this.leftTab=s.BB.el({parent:this.rootEl,content:t.left,className:"kl-2-tabs__left"}),this.leftTab.onpointerdown=function(){return!1},this.rightTab=s.BB.el({parent:this.rootEl,content:t.right,className:"kl-2-tabs__right"}),this.rightTab.onpointerdown=function(){return!1},this.update(),this.leftTab.onclick=function(){0!==i.value&&(i.value=0,i.update(),t.onChange(i.value))},this.rightTab.onclick=function(){1!==i.value&&(i.value=1,i.update(),t.onChange(i.value))}}return(0,r._)(e,[{key:"update",value:function(){this.leftTab.classList.toggle("kl-2-tabs--active",0===this.value),this.rightTab.classList.toggle("kl-2-tabs--active",1===this.value)}},{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("3xvcu",function(t,i){e(t.exports,"DraggableInput",function(){return u});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("eWjiX");o("ciAU9");var l=o("cdZRx"),h=o("1GsyD"),c=o("7jh4K"),u=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.value=(0,s._)({},t.value),this.transform={x:0,y:0,scale:1,angleDeg:0},this.rootEl=a.BB.el({css:{width:"16px",height:"16px",backgroundColor:"#fff",border:"2px solid #000",borderRadius:"16px",position:"absolute",cursor:"move",userSelect:"none",touchAction:"none"}}),this.pointerListener=new a.BB.PointerListener({target:this.rootEl,onPointer:function(e){e.eventPreventDefault(),"left"===e.button&&"pointermove"===e.type&&(i.value.x+=e.dX/i.transform.scale,i.value.y+=e.dY/i.transform.scale,i.update(),t.onChange(i.value))}})}return(0,r._)(e,[{key:"update",value:function(){var e=(0,l.applyToPoint)((0,h.createMatrixFromTransform)(this.transform),this.value);(0,c.css)(this.rootEl,{left:e.x-8+"px",top:e.y-8+"px"})}},{key:"setTransform",value:function(e){JSON.stringify(this.transform)!==JSON.stringify(e)&&(this.transform=e,this.update())}},{key:"getValue",value:function(){return this.value}},{key:"setValue",value:function(e){this.value=(0,s._)({},e),this.update()}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.rootEl.remove(),this.pointerListener.destroy()}}]),e}()}),s("huXOx",function(i,n){e(i.exports,"filterResize",function(){return d});var r=o("eWjiX"),s=o("7bWhB"),a=o("eEL9N"),l=o("1qLb4"),h=o("1mH1z"),c=o("cNr8p"),u=o("ChldL"),p=o("7jh4K"),d={getDialog(e){var i=e.klCanvas;if(!i)return!1;var n=r.BB.fitInto(i.getWidth(),i.getHeight(),280,200,1),o=parseInt(""+n.width),d=parseInt(""+n.height),g=o/i.getWidth(),f=i.getCompleteCanvas(1),v=r.BB.el(),m={element:v},y=i.getWidth(),x=i.getHeight(),b=e.maxWidth,w=e.maxHeight,B=r.BB.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),k=r.BB.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),S=r.BB.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+b,value:""+i.getWidth()}}),C=r.BB.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+w,value:""+i.getHeight()}});S.onclick=function(){this.focus(),T=!0,N()},C.onclick=function(){this.focus(),I=!0,N()},S.onchange=function(){T=!0,N()},C.onchange=function(){I=!0,N()},B.append((0,h.LANG)("width")+": ",S),k.append((0,h.LANG)("height")+": ",C),r.BB.el({css:{background:"url("+t(l)+") no-repeat 140px 5px",backgroundSize:"50px 52px"}}).append(B,k);var E=new Image;E.src=t(l),E.height=40;var L=(0,c.table)([[(0,h.LANG)("width")+":&nbsp;",S,E],[r.BB.el({css:{height:"5px"}}),"",""],[(0,h.LANG)("height")+":&nbsp;",C]],{"0.2":{rowspan:3}});(0,p.css)(L,{marginBottom:"10px"}),v.append(L);var I=!1,T=!1,A=i.getWidth()/i.getHeight(),M=!0,R=new(0,s.Checkbox)({init:!0,label:(0,h.LANG)("constrain-proportions"),allowTab:!0,callback:function(e){M=e,E.style.display=M?"":"none",M&&(S.value=""+i.getWidth(),C.value=""+i.getHeight(),N())},name:"constrain-proportions"});v.append(r.BB.el({css:{clear:"both"}}));var _=new(0,a.Select)({isFocusable:!0,optionArr:[["smooth",(0,h.LANG)("algorithm-smooth")],["pixelated",(0,h.LANG)("algorithm-pixelated")]],title:(0,h.LANG)("scaling-algorithm"),initValue:"smooth",onChange:function(){N()},name:"interpolation-algorithm"});r.BB.el({parent:v,css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}).append(R.getElement(),_.getElement());var P=r.BB.canvas(o,d);P.style.imageRendering="pixelated";var D=r.BB.ctx(P);function N(){if(0===S.value.length&&T||0===C.value.length&&I){I=!1,T=!1;return}if(S.value=""+Math.max(1,parseInt(S.value)),C.value=""+Math.max(1,parseInt(C.value)),M&&(I&&(S.value=""+parseInt(""+parseInt(C.value)*A)),T&&(C.value=""+parseInt(""+parseInt(S.value)/A)),parseInt(S.value)>b||parseInt(C.value)>w)){var e=r.BB.fitInto(parseInt(S.value),parseInt(C.value),b,w,1);S.value=""+parseInt(""+e.width),C.value=""+parseInt(""+e.height)}parseInt(S.value)>b&&(S.value=""+b),parseInt(C.value)>w&&(C.value=""+w),I=!1,T=!1,y=parseInt(S.value),x=parseInt(C.value);var t=r.BB.fitInto(y,x,280,200,1),n=parseInt(""+t.width),o=parseInt(""+t.height);g=n/y;var s=r.BB.centerWithin(u.SMALL_PREVIEW.width,u.SMALL_PREVIEW.height,n,o);"smooth"===_.getValue()?(P.style.imageRendering=g>1?"pixelated":"",P.width=i.getWidth(),P.height=i.getHeight(),D.save(),D.imageSmoothingQuality="high",D.drawImage(f,0,0),r.BB.resizeCanvas(P,y,x)):(P.style.imageRendering="pixelated",P.width=y,P.height=x,D.save(),D.imageSmoothingEnabled=!1,D.drawImage(f,0,0,P.width,P.height)),D.restore(),P.style.width=Math.max(1,n)+"px",P.style.height=Math.max(1,o)+"px",G.style.left=s.x+"px",G.style.top=s.y+"px",G.style.width=Math.max(1,n)+"px",G.style.height=Math.max(1,o)+"px"}var O=r.BB.el({className:"kl-transparent-preview",css:{width:u.SMALL_PREVIEW.width+"px",height:u.SMALL_PREVIEW.height+"px",marginLeft:"-20px",display:"table",marginTop:"10px",position:"relative",userSelect:"none",background:"var(--kl-checkerboard-background)",backgroundSize:"16px"}}),G=r.BB.el({parent:O,content:P,className:"kl-transparent-preview__canvas",css:{width:o+"px",height:d+"px",position:"absolute",overflow:"hidden"}});return v.append(O),N(),m.destroy=function(){R.destroy()},m.getInput=function(){return m.destroy(),{width:y,height:x,algorithm:_.getValue()}},m},apply(e){var t=e.klCanvas,i=e.input.width,n=e.input.height,r=e.input.algorithm;return!!t&&(t.resize(i,n,r),!0)}}}),s("1qLb4",function(e,t){e.exports=i("2BZYe")}),s("dsRff",function(t,i){e(t.exports,"filterRotate",function(){return s});var n=o("eWjiX"),r=o("ChldL"),s={getDialog(e){var t=e.klCanvas;if(!t)return!1;var i=n.BB.fitInto(t.getWidth(),t.getHeight(),280,200,1),o=parseInt(""+i.width),s=parseInt(""+i.height),a=o/t.getWidth(),l=n.BB.canvas(o,s);l.style.display="block",n.BB.ctx(l).drawImage(t.getCompleteCanvas(a),0,0,o,s);var h=n.BB.el(),c={element:h},u=0;function p(){if(m.style.transform="rotate("+u+"deg)",90===Math.abs(u%180)){var e=parseInt(""+n.BB.fitInto(s,o,280,200,1).height)/o;m.style.transform="rotate("+u+"deg) scale("+e+")"}}var d=n.BB.el({tagName:"button",content:[n.BB.el({tagName:"span",content:"⟲",css:{fontSize:"1.3em"}})," 90°"],onClick:function(){u-=90,p()},noRef:!0}),g=n.BB.el({tagName:"button",content:[n.BB.el({tagName:"span",content:"⟳",css:{fontSize:"1.3em"}})," 90°"],onClick:function(){u+=90,p()},noRef:!0,css:{marginLeft:"5px"}});h.append(d,g);var f=n.BB.el({className:"kl-preview-wrapper",css:{width:r.SMALL_PREVIEW.width+"px",height:r.SMALL_PREVIEW.height+"px",display:"table"}}),v=n.BB.el({parent:f,css:{display:"table-cell",verticalAlign:"middle"}}),m=n.BB.el({parent:v,content:l,className:"kl-preview-wrapper__canvas",css:{width:o+"px",height:s+"px",marginLeft:"auto",marginRight:"auto",overflow:"hidden",background:"var(--kl-checkerboard-background)",backgroundSize:"16px"}});return m.style.transition="transform 0.2s ease-out",h.append(f),p(),c.destroy=function(){},c.getInput=function(){return c.destroy(),{deg:u}},c},apply(e){var t=e.klCanvas;return!!t&&(t.rotate(e.input.deg),!0)}}}),s("lhchB",function(t,i){e(t.exports,"filterTiltShift",function(){return m});var n=o("eWjiX"),r=o("cH2YE"),s=o("aP0jf"),a=o("1mH1z"),l=o("9tQ35"),h=o("jpkXO"),c=o("1GsyD");o("ciAU9");var u=o("cdZRx"),p=o("3xvcu"),d=o("bh77f"),g=o("ChldL"),f=o("g6KQ0"),v=o("7jh4K"),m={getDialog(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var o=i.getLayers(),f=i.getLayerIndex(t.canvas),m=n.BB.el(),y={element:m},x=(0,d.testIsSmall)();x||(y.width=(0,g.getPreviewWidth)(x));var b=20,w=200,B={destroy:function(){}};function k(){A.render()}B=new(0,l.FxPreviewRenderer)({original:t.canvas,onUpdate:function(e,t){S.setTransform(A.getTransform()),C.setTransform(A.getTransform());var i=(0,c.createMatrixFromTransform)(t),n=(0,u.applyToPoint)(i,S.getValue()),r=(0,u.applyToPoint)(i,C.getValue());return e.multiplyAlpha().tiltShift(n.x,n.y,r.x,r.y,b*t.scaleX,w*t.scaleX).unmultiplyAlpha()},selection:i.getSelection()});var S=new(0,p.DraggableInput)({value:{x:t.canvas.width/4,y:t.canvas.height/2},onChange:function(){k()}}),C=new(0,p.DraggableInput)({value:{x:3*t.canvas.width/4,y:t.canvas.height/2},onChange:function(){k()}}),E=new(0,s.KlSlider)({label:(0,a.LANG)("filter-tilt-shift-gradient"),width:300,height:30,min:0,max:1e3,value:w,eventResMs:r.EVENT_RES_MS,onChange:function(e){w=e,k()}});E.getElement().style.marginBottom="10px",m.append(E.getElement());var L=new(0,s.KlSlider)({label:(0,a.LANG)("filter-tilt-shift-blur"),width:300,height:30,min:0,max:200,value:b,eventResMs:r.EVENT_RES_MS,onChange:function(e){b=e,k()}});L.getElement().style.marginBottom="10px",m.append(L.getElement());for(var I=[],T=0;T<o.length;T++)I.push({image:T===f?B.render:o[T].context.canvas,isVisible:o[T].isVisible,opacity:o[T].opacity,mixModeStr:o[T].mixModeStr,hasClipping:!1});var A=new(0,h.Preview)({width:(0,g.getPreviewWidth)(x),height:(0,g.getPreviewHeight)(x),project:{width:t.canvas.width,height:t.canvas.height,layers:I},selection:i.getSelection()});return A.render(),(0,v.css)(A.getElement(),{overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"}),A.getElement().append(S.getElement(),C.getElement()),m.append(A.getElement()),y.destroy=function(){L.destroy(),E.destroy(),S.destroy(),C.destroy(),B.destroy(),A.destroy()},y.getInput=function(){return y.destroy(),{a:S.getValue(),b:C.getValue(),blur:b,gradient:w}},y},apply(e){var t=e.layer.context,i=e.klHistory,n=e.input.a,r=e.input.b,o=e.input.blur,s=e.input.gradient;return!!t&&(0,f.applyFxFilter)(t,e.klCanvas.getSelection(),function(e){e.multiplyAlpha().tiltShift(n.x,n.y,r.x,r.y,o,s).unmultiplyAlpha()},i)}}}),s("lXpcU",function(t,i){e(t.exports,"testComposedLayerHasTransparency",function(){return L}),e(t.exports,"filterTransform",function(){return T});var n,r=o("cL71g"),s=o("8N5YG"),a=o("bX4ja"),l=o("eWjiX"),h=o("7bWhB"),c=o("cNhNm"),u=o("eEL9N"),p=o("esGm2"),d=o("1mH1z"),g=o("7jh4K"),f=o("jpkXO"),v=o("bh77f"),m=o("ChldL"),y=o("4sWjZ"),x=o("6NxCO"),b=o("9b3eo");o("ciAU9");var w=o("dZ59l"),B=o("kr2fR"),k=o("1RMPr"),S=o("kFecW"),C=o("fzzhO"),E=o("bbA6w");function L(e){var t=!0,i=!1,n=void 0;try{for(var r,o=e.tiles[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;if((0,p.isLayerFill)(a)){var l=function(e){if(e.startsWith("#")){var t=e.slice(1);3===t.length&&(t=t.split("").map(function(e){return e+e}).join("")),6===t.length&&(t+="ff");var i=parseInt(t,16);return{r:i>>24&255,g:i>>16&255,b:i>>8&255,a:(255&i)/255}}var n=e.match(/rgba?\(([^)]+)\)/);if(n){var r=(0,s._)(n[1].split(",").map(function(e){return parseFloat(e.trim())}),4),o=r[0],a=r[1],l=r[2],h=r[3];return{r:o,g:a,b:l,a:void 0===h?1:h}}}(a.fill);if(l&&l.a<1)return!0}else for(var h=a.data.data,c=3;c<h.length;c+=4)if(h[c]<255)return!0}}catch(e){i=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(i)throw n}}return!1}function I(e,t,i,n,r,o,s,h){var c=e.canvas.width,u=e.canvas.height;if(e.save(),e.clearRect(0,0,c,u),e.save(),r){if(e.drawImage(t,0,0),!s){var p=(0,b.getSelectionPath2d)(r);e.clip(p),e.globalCompositeOperation=h?"destination-out":"source-atop",e.fillStyle="white",e.fillRect(0,0,c,u)}}else h?s&&e.drawImage(t,0,0):(e.drawImage(t,0,0),s||(e.fillStyle="white",e.globalCompositeOperation="source-atop",e.fillRect(0,0,c,u)));if(e.restore(),r){var d,g=null!=o?o:{x:0,y:0,width:e.canvas.width,height:e.canvas.height};i||l.BB.testShouldPixelate(n,n.width/g.width,n.height/g.height)?e.imageSmoothingEnabled=!1:(e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high"),d=(0,w.compose)((0,B.translate)(n.x,n.y),(0,k.rotate)(n.angleDeg/180*Math.PI),(0,S.scale)(n.width>0?1:-1,n.height>0?1:-1),(0,B.translate)(-Math.abs(n.width)/2,-Math.abs(n.height)/2),(0,S.scale)(Math.abs(n.width/g.width),Math.abs(n.height/g.height)),(0,B.translate)(-g.x,-g.y)),e.setTransform.apply(e,(0,a._)((0,C.matrixToTuple)(d)));var f=(0,b.getSelectionPath2d)(r);e.clip(f),e.drawImage(t,0,0)}else l.BB.drawTransformedImageWithBounds(e,t,n,o,i);return e.restore(),d}var T={getDialog(e){var t,i,r=e.context,o=e.klCanvas;if(!r||!o)return!1;var a=(0,v.testIsSmall)(),p=o.getLayers(),y=(0,g.throwIfNull)(o.getLayerIndex(r.canvas)),b=0===y,w=!1;b&&(w=L(Object.entries(e.composed.layerMap).find(function(e){var t=(0,s._)(e,2);return(t[0],t[1]).index===y})[1]));var B=o.getSelection(),k=B?(0,x.getSelectionBounds)(B,r):l.BB.canvasBounds(r);if(!k)return{error:(0,d.LANG)(B?"filter-transform-empty-selection":"filter-transform-empty")};var S={x:k.x+k.width/2,y:k.y+k.height/2,width:k.width,height:k.height,angleDeg:0},C=l.BB.el(),E={element:C};a||(E.width=m.MEDIUM_PREVIEW.width);var T=new l.BB.KeyListener({onDown:function(e){l.BB.isInputFocused(!0)||("left"===e&&(P.value=""+(parseFloat(P.value)-1),eh()),"right"===e&&(P.value=""+(parseFloat(P.value)+1),eh()),"up"===e&&(_.value=""+(parseFloat(_.value)-1),eh()),"down"===e&&(_.value=""+(parseFloat(_.value)+1),eh()))}}),A=l.BB.el({css:{width:"100px",height:"30px",display:"inline-block"}}),M=l.BB.el({css:{width:"100px",height:"30px",display:"inline-block"}}),R=l.BB.el({css:{width:"150px",height:"30px",display:"inline-block"}}),_=l.BB.el({tagName:"input"}),P=l.BB.el({tagName:"input"}),D=l.BB.el({tagName:"input"});_.type="number",P.type="number",D.type="number",P.style.width="70px",_.style.width="70px",D.style.width="70px",_.value="0",P.value="0",D.value="0",_.onclick=function(){_.focus(),eh()},P.onclick=function(){P.focus(),eh()},D.onclick=function(){D.focus(),eh()},_.onchange=function(){eh()},P.onchange=function(){eh()},D.onchange=function(){eh()},_.onkeyup=function(){eh()},P.onkeyup=function(){eh()},D.onkeyup=function(){eh()},A.append("X: ",P),M.append("Y: ",_),R.append((0,d.LANG)("filter-transform-rotation")+": ",D),a||l.BB.el({parent:C,css:{marginTop:"10px"}}).append(A,M,R);var N=l.BB.el({parent:C,css:{display:"flex",flexWrap:"wrap",alignItems:"center",gap:"10px",marginTop:"10px"}}),O=l.BB.el({parent:N,tagName:"button",content:(0,d.LANG)("filter-transform-flip")+" X",onClick:function(){var e=el.getValue();el.setSize(-e.width,e.height)}}),G=l.BB.el({parent:N,tagName:"button",content:(0,d.LANG)("filter-transform-flip")+" Y",onClick:function(){var e=el.getValue();el.setSize(e.width,-e.height)}}),H=l.BB.el({parent:N,tagName:"button",content:"-90°",onClick:function(){var e=el.getValue();e.angleDeg-=90,e.angleDeg%=360,el.setAngleDeg(e.angleDeg),D.value=""+Math.round(e.angleDeg),ea()}}),z=l.BB.el({parent:N,tagName:"button",content:"+90°",onClick:function(){var e=el.getValue();e.angleDeg+=90,e.angleDeg%=360,el.setAngleDeg(e.angleDeg),D.value=""+Math.round(e.angleDeg),ea()}}),j=l.BB.el({parent:N,tagName:"button",content:"2&times;",onClick:function(){var e=el.getValue();q.getValue()?el.setSize((e.width<0?-1:1)*el.getRatio()*Math.abs(e.height)*2,2*e.height):el.setSize(2*e.width,2*e.height)}}),F=l.BB.el({parent:N,tagName:"button",content:"&frac12;&times;",onClick:function(){var e=el.getValue();el.setSize(Math.round(e.width/2),Math.round(e.height/2))}}),V=l.BB.el({parent:N,tagName:"button",content:(0,d.LANG)("center"),onClick:function(){var e=el.getValue();el.setPos({x:r.canvas.width/2,y:r.canvas.height/2}),el.setAngleDeg(e.angleDeg),ea()}}),U=!1,W=new(0,h.Checkbox)({init:U,label:(0,d.LANG)("select-transform-clone"),allowTab:!0,callback:function(e){U=e,ea(!0)},css:{display:"inline-block"},name:"clone-before-transforming"}),X=(t=w,i=n,!b||(void 0!==i?i:t)),K=!1,Y=new(0,h.Checkbox)({init:X,label:(0,d.LANG)("brush-eraser-transparent-bg"),allowTab:!0,callback:function(e){K=!0,X=e,ea(!0)},css:{display:"inline-block"},name:"transparent-background"});N.append(W.getElement()),b&&N.append(Y.getElement());var Z=!0,q=new(0,h.Checkbox)({init:!0,label:(0,d.LANG)("filter-transform-constrain"),title:(0,d.LANG)("constrain-proportions"),allowTab:!0,callback:function(e){Z=e,el.setIsConstrained(Z)},css:{display:"inline-block"},name:"constrain-proportions"}),$=!1,Q=new(0,h.Checkbox)({init:!0,label:(0,d.LANG)("filter-transform-snap"),title:(0,d.LANG)("filter-transform-snap-title"),allowTab:!0,callback:function(e){$=e,el.setSnapping($)},css:{display:"inline-block",marginLeft:"10px"},name:"enable-snapping"}),J=l.BB.el();J.append(q.getElement(),Q.getElement()),C.append(l.BB.el({css:{clear:"both",height:"10px"}}));var ee=l.BB.el({parent:C,css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),et=new(0,u.Select)({isFocusable:!0,optionArr:[["smooth",(0,d.LANG)("algorithm-smooth")],["pixelated",(0,d.LANG)("algorithm-pixelated")]],initValue:"smooth",title:(0,d.LANG)("scaling-algorithm"),onChange:function(){ea(!0)},name:"interpolation-algorithm"});ee.append(J,et.getElement());for(var ei=l.BB.canvas(r.canvas.width,r.canvas.height),en=[],er=0;er<p.length;er++)en.push({image:er===y?ei:p[er].context.canvas,isVisible:p[er].isVisible,opacity:p[er].opacity,mixModeStr:p[er].mixModeStr,hasClipping:!1});var eo=new(0,f.Preview)({width:(0,m.getPreviewWidth)(a),height:(0,m.getPreviewHeight)(a),project:{width:r.canvas.width,height:r.canvas.height,layers:en},hasEditMode:!0,onModeChange:function(e){el.getElement().style.pointerEvents="edit"===e?"":"none",el.getElement().style.opacity="edit"===e?"":"0.5"},onTransformChange:function(e){el.setViewportTransform(e)},padding:30});eo.render(),(0,g.css)(eo.getElement(),{overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"}),C.append(eo.getElement());var es="";function ea(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(el){var t=el.getValue();(JSON.stringify(t)!==es||e)&&(es=JSON.stringify(t),I(l.BB.ctx(ei),p[y].context.canvas,"pixelated"===et.getValue(),t,B,k,U,X||y>0),eo.render())}}var el=new(0,c.FreeTransform)({x:S.x,y:S.y,width:S.width,height:S.height,angleDeg:S.angleDeg,isConstrained:!0,snapX:[0,r.canvas.width],snapY:[0,r.canvas.height],callback:function(e){P.value=""+Math.round(e.x-S.x),_.value=""+Math.round(e.y-S.y),D.value=""+Math.round(e.angleDeg),ea()},viewportTransform:eo.getTransform()});function eh(){el.setPos({x:parseInt(P.value)+S.x,y:parseInt(_.value)+S.y}),el.setAngleDeg(parseInt(D.value)),ea()}return(0,g.css)(el.getElement(),{position:"absolute",left:"0",top:"0"}),eo.getElement().append(el.getElement()),ea(),E.destroy=function(){T.destroy(),el.destroy(),q.destroy(),Q.destroy(),l.BB.destroyEl(O),l.BB.destroyEl(G),l.BB.destroyEl(H),l.BB.destroyEl(z),l.BB.destroyEl(j),l.BB.destroyEl(F),l.BB.destroyEl(V),eo.destroy(),l.BB.freeCanvas(ei)},E.getInput=function(){var e=el.getValue();K&&(n=X);var t={transform:e,bounds:k,isPixelated:"pixelated"===et.getValue(),doClone:U,isTransparentBg:X};return E.destroy(),l.BB.copyObj(t)},E},apply(e){var t=e.layer.context,i=e.klHistory;if(!t)return!1;i.pause(!0);var n=e.input,o=e.klCanvas.getLayerIndex(t.canvas),s=l.BB.copyCanvas(t.canvas),a=e.klCanvas.getSelection(),h=I(t,s,n.isPixelated,n.transform,a,n.bounds,n.doClone,n.isTransparentBg||o>0);a&&h&&(a=(0,E.transformMultiPolygon)(a,h),e.klCanvas.setSelection(a)),i.pause(!1);var c=Object.fromEntries(e.klCanvas.getLayers().map(function(t){return t.id===e.layer.id?[t.id,{tiles:(0,y.canvasToLayerTiles)(e.layer.canvas)}]:[t.id,{}]}));return i.push((0,r._)({layerMap:c},a?{selection:{value:a}}:void 0)),!0}}}),s("1CjeM",function(t,i){e(t.exports,"filterBlur",function(){return g});var n=o("aP0jf"),r=o("cH2YE"),s=o("1mH1z"),a=o("9tQ35"),l=o("jpkXO"),h=o("eWjiX"),c=o("bh77f"),u=o("ChldL"),p=o("g6KQ0"),d=o("7jh4K"),g={getDialog(e){var t=e.klCanvas,i=e.context;if(!t||!i)return!1;var o=t.getLayers(),p=t.getLayerIndex(i.canvas),g=h.BB.el(),f={element:g},v=(0,c.testIsSmall)();v||(f.width=(0,u.getPreviewWidth)(v));var m=10,y=new(0,a.FxPreviewRenderer)({original:i.canvas,onUpdate:function(e,t){return e.multiplyAlpha().triangleBlur(m*t.scaleX).unmultiplyAlpha()},selection:t.getSelection()}),x=new(0,n.KlSlider)({label:(0,s.LANG)("radius"),width:300,height:30,min:1,max:200,value:m,eventResMs:r.EVENT_RES_MS,onChange:function(e){m=e,B.render()}});x.getElement().style.marginBottom="10px",g.append(x.getElement());for(var b=[],w=0;w<o.length;w++)b.push({image:w===p?y.render:o[w].context.canvas,isVisible:o[w].isVisible,opacity:o[w].opacity,mixModeStr:o[w].mixModeStr,hasClipping:!1});var B=new(0,l.Preview)({width:(0,u.getPreviewWidth)(v),height:(0,u.getPreviewHeight)(v),project:{width:i.canvas.width,height:i.canvas.height,layers:b},selection:t.getSelection()});return B.render(),(0,d.css)(B.getElement(),{marginLeft:"-20px",marginRight:"-20px"}),g.append(B.getElement()),f.destroy=function(){x.destroy(),y.destroy(),B.destroy()},f.getInput=function(){return f.destroy(),{radius:m}},f},apply(e){var t=e.layer.context,i=e.klHistory,n=e.input.radius;return!!t&&!!n&&(0,p.applyFxFilter)(t,e.klCanvas.getSelection(),function(e){e.multiplyAlpha().triangleBlur(n).unmultiplyAlpha()},i)}}}),s("dNWKZ",function(t,i){e(t.exports,"filterUnsharpMask",function(){return d});var n=o("aP0jf"),r=o("1mH1z"),s=o("jpkXO"),a=o("9tQ35"),l=o("eWjiX"),h=o("bh77f"),c=o("ChldL"),u=o("g6KQ0"),p=o("7jh4K"),d={getDialog(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var o=i.getLayers(),u=i.getLayerIndex(t.canvas),d=l.BB.el(),g={element:d},f=(0,h.testIsSmall)();f||(g.width=(0,c.getPreviewWidth)(f));var v=2,m=.51,y=new(0,a.FxPreviewRenderer)({original:t.canvas,onUpdate:function(e,t){return e.unsharpMask(v*t.scaleX,m)},selection:i.getSelection()});function x(){S.render()}var b=new(0,n.KlSlider)({label:(0,r.LANG)("radius"),width:300,height:30,min:0,max:200,value:2,onChange:function(e){v=e,x()},curve:[[0,0],[.1,2],[.5,50],[1,200]]}),w=new(0,n.KlSlider)({label:(0,r.LANG)("filter-unsharp-mask-strength"),width:300,height:30,min:0,max:50,value:5.1,onChange:function(e){m=e/10,x()},curve:[[0,0],[.1,2],[.5,10],[1,50]]});b.getElement().style.marginBottom="10px",w.getElement().style.marginBottom="10px",d.append(b.getElement()),d.append(w.getElement());for(var B=[],k=0;k<o.length;k++)B.push({image:k===u?y.render:o[k].context.canvas,isVisible:o[k].isVisible,opacity:o[k].opacity,mixModeStr:o[k].mixModeStr,hasClipping:!1});var S=new(0,s.Preview)({width:(0,c.getPreviewWidth)(f),height:(0,c.getPreviewHeight)(f),project:{width:t.canvas.width,height:t.canvas.height,layers:B},selection:i.getSelection()});return x(),(0,p.css)(S.getElement(),{marginLeft:"-20px",marginRight:"-20px"}),d.append(S.getElement()),g.destroy=function(){b.destroy(),w.destroy(),y.destroy(),S.destroy()},g.getInput=function(){return g.destroy(),{radius:v,strength:m}},g},apply(e){var t=e.layer.context,i=e.klHistory,n=e.input.radius,r=e.input.strength;return!!t&&null!==n&&null!==r&&(0,u.applyFxFilter)(t,e.klCanvas.getSelection(),function(e){e.unsharpMask(n,r)},i)}}}),s("94Tq7",function(t,i){e(t.exports,"filterToAlpha",function(){return g});var n=o("iFIyy"),r=o("43qNf"),s=o("1mH1z"),a=o("9tQ35"),l=o("jpkXO"),h=o("eWjiX"),c=o("bh77f"),u=o("ChldL"),p=o("g6KQ0"),d=o("7jh4K"),g={getDialog(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var o=i.getLayers(),p=i.getLayerIndex(t.canvas),g=h.BB.el(),f={element:g},v=(0,c.testIsSmall)();v||(f.width=(0,u.getPreviewWidth)(v));var m=new(0,a.FxPreviewRenderer)({original:t.canvas,onUpdate:function(e){return e.toAlpha("inverted-luminance"===y,b)},selection:i.getSelection()}),y="inverted-luminance",x=new(0,n.Options)({optionArr:[{id:"inverted-luminance",label:(0,s.LANG)("filter-to-alpha-inverted-lum")},{id:"luminance",label:(0,s.LANG)("filter-to-alpha-lum")}],initId:y,onChange:function(e){y=e,C.render()}});g.append(x.getElement());var b={r:0,g:0,b:0,a:1},w=[null,{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1},{r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1},{r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1}],B=new(0,r.ColorOptions)({label:(0,s.LANG)("filter-to-alpha-replace"),colorArr:w,initialIndex:1,onChange:function(e){b=e,C.render()},css:{margin:"10px 0"}});g.append(B.getElement());for(var k=[],S=0;S<o.length;S++)k.push({image:S===p?m.render:o[S].context.canvas,isVisible:o[S].isVisible,opacity:o[S].opacity,mixModeStr:o[S].mixModeStr,hasClipping:!1});var C=new(0,l.Preview)({width:(0,u.getPreviewWidth)(v),height:(0,u.getPreviewHeight)(v),project:{width:t.canvas.width,height:t.canvas.height,layers:k},selection:i.getSelection()});return C.render(),(0,d.css)(C.getElement(),{marginLeft:"-20px",marginRight:"-20px"}),g.append(C.getElement()),f.destroy=function(){x.destroy(),B.destroy(),m.destroy(),C.destroy()},f.getInput=function(){return f.destroy(),{sourceId:y,selectedRgbaObj:b}},f},apply(e){var t=e.layer.context,i=e.klHistory,n=e.input.sourceId,r=e.input.selectedRgbaObj;return!!t&&!!n&&(0,p.applyFxFilter)(t,e.klCanvas.getSelection(),function(e){e.toAlpha("inverted-luminance"===n,r)},i)}}}),s("d8Fqy",function(t,i){e(t.exports,"filterGrid",function(){return g});var n=o("eWjiX"),r=o("1mH1z"),s=o("dJPtW"),a=o("43qNf"),l=o("1xi6g"),h=o("7jh4K"),c=o("jpkXO"),u=o("bh77f"),p=o("ChldL"),d=o("4sWjZ"),g={getDialog(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var o=i.getLayers(),d=(0,h.throwIfNull)(i.getLayerIndex(t.canvas)),g=n.BB.el(),f={element:g},v=(0,u.testIsSmall)();v||(f.width=(0,p.getPreviewWidth)(v));var m={x:2,y:2,thickness:8,color:"#000",opacity:1},y=n.BB.el({parent:g,css:{display:"flex",alignItems:"center"}}),x=n.BB.el({parent:g,css:{display:"flex",alignItems:"center",marginTop:"10px",marginBottom:"10px"}}),b=(0,s.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){m.x=parseFloat(e),M()}}),w=(0,s.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){m.y=parseFloat(e),M()}}),B=(0,s.input)({init:m.thickness,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){m.thickness=parseFloat(e),M()}}),k={r:0,g:0,b:0,a:1},S=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];S.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),S.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1}),m.color=n.BB.ColorConverter.toRgbStr(k);var C=new(0,a.ColorOptions)({label:(0,r.LANG)("shape-stroke"),colorArr:S,onChange:function(e){k=e,m.color=n.BB.ColorConverter.toRgbStr(k),M()}}),E={display:"inline-block",marginRight:"5px"};y.append(n.BB.el({content:"X:",css:E}),b,n.BB.el({content:"Y:",css:E}),w),x.append(n.BB.el({content:(0,r.LANG)("shape-line-width")+":",css:E}),B,n.BB.el({css:{flexGrow:"1"}}),C.getElement());var L=n.BB.canvas(t.canvas.width,t.canvas.height),I=n.BB.ctx(L),T=o.map(function(e,t){return{image:t===d?L:e.context.canvas,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,hasClipping:!1}}),A=new(0,c.Preview)({width:(0,p.getPreviewWidth)(v),height:(0,p.getPreviewHeight)(v),project:{width:t.canvas.width,height:t.canvas.height,layers:T}});function M(){I.save(),I.clearRect(0,0,L.width,L.height),I.drawImage(t.canvas,0,0),(0,l.drawGrid)(I,m.x,m.y,Math.max(m.thickness,1),m.color,m.opacity),I.restore(),A.render()}return(0,h.css)(A.getElement(),{marginLeft:"-20px",marginRight:"-20px"}),g.append(A.getElement()),M(),A.render(),f.destroy=function(){A.destroy(),n.BB.freeCanvas(L),C.destroy()},f.getInput=function(){return f.destroy(),n.BB.copyObj(m)},f},apply(e){var t=e.layer.context,i=e.klCanvas,n=e.klHistory;if(!t||!i)return!1;(0,l.drawGrid)(t,e.input.x,e.input.y,e.input.thickness,e.input.color,e.input.opacity);var r=Object.fromEntries(e.klCanvas.getLayers().map(function(t){return t.id===e.layer.id?[t.id,{tiles:(0,d.canvasToLayerTiles)(e.layer.canvas)}]:[t.id,{}]}));return n.push({layerMap:r}),!0}}}),s("1xi6g",function(t,i){e(t.exports,"drawGrid",function(){return n});function n(e,t,i,n,r,o){e.save();var s=e.canvas.width,a=e.canvas.height,l=(n=Math.round(n))%2==0;e.beginPath(),e.lineWidth=n,e.strokeStyle=r,e.globalAlpha=o;for(var h=0;h<t-1;h++){var c=s/t*(h+1);c=l?Math.round(c):Math.round(c+.5)-.5,e.moveTo(c,0),e.lineTo(c,a)}for(var u=0;u<i-1;u++){var p=a/i*(u+1);p=l?Math.round(p):Math.round(p+.5)-.5,e.moveTo(0,p),e.lineTo(s,p)}e.stroke(),e.restore()}}),s("gtdB1",function(t,i){e(t.exports,"filterNoise",function(){return T});var n=o("bX4ja"),r=o("eWjiX"),s=o("1mH1z"),a=o("aP0jf"),l=o("a5EFw"),h=o("iFIyy"),c=o("cH2YE"),u=o("eEL9N"),p=o("bBcC4"),d=o("hrnUX"),g=o("dJ1E2"),f=o("7bWhB"),v=o("7jh4K"),m=o("9tQ35"),y=o("jpkXO"),x=o("ChldL"),b=o("bh77f"),w=o("4sWjZ"),B=o("eIcQa"),k=o("3Fob6"),S=o("eg83P"),C=o("g03EN"),E=[{type:0,scaleX:1,scaleY:1,offsetX:0,offsetY:0,octaves:1,samples:1,peaks:0,brightness:0,contrast:0,isReversed:!0},{type:1,scaleX:166,scaleY:164,offsetX:105,offsetY:30,octaves:6,samples:1,peaks:0,brightness:.055,contrast:.23,isReversed:!0},{type:1,scaleX:235,scaleY:190,offsetX:3227,offsetY:2156,octaves:4,samples:16,peaks:22,brightness:-.375,contrast:1,isReversed:!1},{type:1,scaleX:40,scaleY:40,offsetX:0,offsetY:0,octaves:1,samples:1,peaks:0,brightness:0,contrast:0,isReversed:!1},{type:0,scaleX:26,scaleY:26,offsetX:557,offsetY:365,octaves:1,samples:1,peaks:0,brightness:.02,contrast:1,isReversed:!0},{type:1,scaleX:1500,scaleY:1500,offsetX:745,offsetY:2871,octaves:5,samples:16,peaks:156.02,brightness:.03,contrast:1,isReversed:!0},{type:1,scaleX:11,scaleY:11,offsetX:2940,offsetY:2045,octaves:1,samples:16,peaks:1,brightness:-.045,contrast:1,isReversed:!0},{type:2,scaleX:74,scaleY:74,offsetX:4816,offsetY:1304,octaves:3,samples:1,peaks:2.78,brightness:0,contrast:0,isReversed:!1}];function L(e){var t=r.BB.copyObj(E[e.presetIndex]);return t.seed=e.seed,t.scaleX=t.scaleX*e.scale/50,t.scaleY=t.scaleY*e.scale/50,t.colA=e.colA,t.colB=e.colB,t.isReversed=e.isReversed?!t.isReversed:t.isReversed,t.channels=e.channels,t}function I(e){return[e.seed,e.type,[e.scaleX,e.scaleY],[e.offsetX,e.offsetY],e.octaves,e.samples,e.peaks,e.brightness,e.contrast,e.isReversed,e.colA,e.colB,e.channels?e.channels:"rgb"]}var T={getDialog(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var o=i.getLayers(),w=(0,v.throwIfNull)(i.getLayerIndex(t.canvas)),B=[],k=(0,v.throwIfNull)((0,l.getSharedFx)()),S=r.BB.canvas(32,32),C=r.BB.ctx(S),T=k.texture(S);k.draw(T).update(),T.destroy(),E.forEach(function(e){var t=new Image,i=r.BB.copyObj(e);i.scaleX/=10,i.scaleY/=10,k.noise.apply(k,(0,n._)(I(i))).update(),C.drawImage(k,0,0),t.src=S.toDataURL("image/png"),B.push(t)}),T.destroy();var A=r.BB.el(),M={element:A},R=(0,b.testIsSmall)();R||(M.width=(0,x.getPreviewWidth)(R));var _={seed:300*Math.random(),presetIndex:0,scale:50,opacity:.5,isReversed:!1,channels:"rgb",mixModeStr:"source-over",colA:{r:0,g:0,b:0},colB:{r:255,g:255,b:255}},P=new(0,h.Options)({optionArr:B.map(function(e,t){return(0,v.css)(e,{margin:"1px",borderRadius:"3px",transition:"all 0.1s ease-in-out"}),{id:""+t,label:e}}),initId:"0",onChange:function(e){_.presetIndex=Number(e),q()},css:{marginBottom:"10px"}});A.append(P.getElement());var D=new(0,a.KlSlider)({label:(0,s.LANG)("filter-noise-scale"),width:300,height:30,min:1,max:1e3,value:_.scale,eventResMs:c.EVENT_RES_MS,curve:r.BB.powerSplineInput(1,1e3,.1),onChange:function(e){_.scale=e,q()}});D.getElement().style.marginBottom="10px";var N=new(0,a.KlSlider)({label:(0,s.LANG)("opacity"),width:300,height:30,min:.01,max:1,value:_.opacity,eventResMs:c.EVENT_RES_MS,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(e){_.opacity=e,q()}});N.getElement().style.marginBottom="10px";var O=r.BB.el({css:{display:"flex",alignItems:"center",marginBottom:"10px"}}),G=r.BB.el({css:{display:"flex",marginBottom:"10px"}}),H=new(0,h.Options)({optionArr:[{id:"rgb",label:"RGB"},{id:"alpha",label:(0,s.LANG)("filter-noise-alpha")}],initId:"rgb",onChange:function(e){_.channels=e,"rgb"===e?G.style.visibility="":G.style.visibility="hidden",q()}}),z=new(0,f.Checkbox)({label:(0,s.LANG)("reverse"),callback:function(e){_.isReversed=e,q()},allowTab:!0,name:"reverse-gradient"}),j=new(0,u.Select)({isFocusable:!0,optionArr:["source-over",void 0,"darken","multiply","color-burn",void 0,"lighten","screen","color-dodge",void 0,"overlay","soft-light","hard-light",void 0,"difference","exclusion",void 0,"hue","saturation","color","luminosity"].map(function(e){return e?[e,(0,p.translateBlending)(e)]:void 0}),initValue:_.mixModeStr,onChange:function(e){_.mixModeStr=e,q()},name:"blend-mode"});j.getElement().title=(0,s.LANG)("layers-blending");var F=r.BB.el({css:{display:"flex"}}),V={width:"34px",height:"34px",marginRight:"5px"},U=d.KL.input({type:"color",init:"#"+g.ColorConverter.toHexString(_.colA),callback:function(e){var t=g.ColorConverter.hexToRGB(e);t&&(_.colA=t,q())},css:V}),W=d.KL.input({type:"color",init:"#"+g.ColorConverter.toHexString(_.colB),callback:function(e){var t=g.ColorConverter.hexToRGB(e);t&&(_.colB=t,q())},css:V});F.append(U,W),O.append(H.getElement(),r.BB.el({css:{flexGrow:"1"}}),z.getElement()),G.append(j.getElement(),r.BB.el({css:{flexGrow:"1"}}),F),A.append(D.getElement(),N.getElement(),O,G);for(var X=new(0,m.FxPreviewRenderer)({original:t.canvas,onUpdate:function(e,i){var r=L(_);return r.scaleX*=i.scaleX,r.scaleY*=i.scaleY,r.offsetX=t.canvas.width/2*i.scaleX+i.x,r.offsetY=t.canvas.height/2*i.scaleY+i.y,e.noise.apply(e,(0,n._)(I(r)))},postMix:{opacity:_.opacity,operation:"alpha"===_.channels?"destination-out":_.mixModeStr},selection:i.getSelection(),isMaskingWithEmptyOriginal:!0}),K=[],Y=0;Y<o.length;Y++)K.push({image:Y===w?X.render:o[Y].context.canvas,isVisible:o[Y].isVisible,opacity:o[Y].opacity,mixModeStr:o[Y].mixModeStr,hasClipping:!1});var Z=new(0,y.Preview)({width:(0,x.getPreviewWidth)(R),height:(0,x.getPreviewHeight)(R),project:{width:t.canvas.width,height:t.canvas.height,layers:K},selection:i.getSelection()});function q(){X.setPostMix({opacity:_.opacity,operation:"alpha"===_.channels?"destination-out":_.mixModeStr}),Z.render()}return Z.render(),(0,v.css)(Z.getElement(),{marginLeft:"-20px",marginRight:"-20px"}),A.append(Z.getElement()),M.destroy=function(){P.destroy(),D.destroy(),N.destroy(),z.destroy(),H.destroy(),j.destroy(),Z.destroy(),X.destroy()},M.getInput=function(){return M.destroy(),r.BB.copyObj(_)},M},apply(e){var t=e.layer.context,i=e.klCanvas,o=e.klHistory;if(!t||!i)return!1;var s=(0,l.getSharedFx)();if(!s)return!1;var a=e.input,h=i.getSelection();if(h){var c=r.BB.canvas(t.canvas.width,t.canvas.height),u=r.BB.ctx(c);(0,B.drawSelectionMask)(h,u),p=s.texture(c),r.BB.freeCanvas(c)}s.initialize(t.canvas.width,t.canvas.height);var p,d=L(a);return d.offsetX=t.canvas.width/2,d.offsetY=t.canvas.height/2,s.noise.apply(s,(0,n._)(I(d))).update(),p&&(s.multiplyAlpha().mask(p).unmultiplyAlpha(),p.destroy()),s.update(),t.save(),t.globalAlpha=a.opacity,"alpha"===a.channels?t.globalCompositeOperation="destination-out":t.globalCompositeOperation=a.mixModeStr,t.drawImage(s,0,0),t.restore(),o.push((0,k.getPushableLayerChange)(o.getComposed(),(0,w.canvasToLayerTiles)(t.canvas,h?(0,S.integerBounds)((0,C.getMultiPolyBounds)(h)):void 0))),!0}}}),s("lQzx7",function(t,i){e(t.exports,"filterPattern",function(){return v});var n=o("eWjiX"),r=o("dJPtW"),s=o("aP0jf"),a=o("1mH1z"),l=o("cH2YE"),h=o("5UrL9"),c=o("5vheV"),u=o("7jh4K"),p=o("bh77f"),d=o("ChldL"),g=o("4sWjZ");function f(e,t){var i=t.blend?Math.round(t.blend*t.width/2):0,r=t.blend?Math.round(t.blend*t.height/2):0,o=n.BB.canvas(t.width,t.height);if(t.blend){var s=n.BB.canvas(2*t.width,2*t.height),a=n.BB.ctx(s),l="#0000",h="#000";a.drawImage(e.canvas,-t.x+i,-t.y+r),a.save();var c=a.createLinearGradient(0,t.height,0,2*t.height);c.addColorStop(0,h),c.addColorStop(t.blend,l),a.globalCompositeOperation="destination-in",a.fillStyle=c,a.fillRect(0,0,s.width,s.height),a.restore(),a.save(),(c=a.createLinearGradient(0,0,0,t.height)).addColorStop(0,l),c.addColorStop(t.blend,h),a.globalCompositeOperation="destination-in",a.fillStyle=c,a.fillRect(0,0,2*t.width,2*t.height),a.restore(),a.save(),a.globalCompositeOperation="lighter",a.drawImage(s,0,-t.height),a.restore(),a.save(),(c=a.createLinearGradient(t.width,0,2*t.width,0)).addColorStop(0,h),c.addColorStop(t.blend,l),a.globalCompositeOperation="destination-in",a.fillStyle=c,a.fillRect(0,0,s.width,s.height),a.restore(),a.save(),(c=a.createLinearGradient(0,0,t.width,0)).addColorStop(0,l),c.addColorStop(t.blend,h),a.globalCompositeOperation="destination-in",a.fillStyle=c,a.fillRect(0,0,2*t.width,2*t.height),a.restore(),a.save(),a.globalCompositeOperation="lighter",a.drawImage(s,-t.width,0),a.restore(),n.BB.ctx(o).drawImage(s,0,0)}else n.BB.ctx(o).drawImage(e.canvas,-t.x,-t.y);e.save(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.translate(t.offsetX-i,t.offsetY-r),e.fillStyle=(0,u.throwIfNull)(e.createPattern(o,"repeat")),e.fillRect(-t.offsetX+i,-t.offsetY+r,e.canvas.width,e.canvas.height),e.restore()}var v={getDialog(e){var t,i=(0,p.testIsSmall)(),o=n.BB.el(),g=e.context,v=g.canvas.width,m=g.canvas.height,y={x:0,y:0,width:v<=250?Math.round(v/4):200,height:m<=250?Math.round(m/4):200,blend:0,offsetX:0,offsetY:0},x=n.BB.canvasBounds(g);x&&x.width<=1024&&x.height<=1024&&(x.width<.75*v||x.height<.75*m)?(y.x=x.x,y.y=x.y,y.width=x.width,y.height=x.height):(y.x=Math.round(v/2-y.width/2),y.y=Math.round(m/2-y.height/2));var b=(0,r.input)({init:y.x,type:"number",min:0,max:v,css:{width:"100%"},callback:function(e){y.x=Number(e),q()}}),w=(0,r.input)({init:y.y,type:"number",min:0,max:m,css:{width:"100%"},callback:function(e){y.y=Number(e),q()}}),B=(0,r.input)({init:y.width,type:"number",min:1,max:Math.min(1024,v),css:{width:"100%"},callback:function(e){y.width=Number(e),q()}}),k=(0,r.input)({init:y.height,type:"number",min:1,max:Math.min(1024,m),css:{width:"100%"},callback:function(e){y.height=Number(e),q()}}),S={marginLeft:"5px",flex:"1"};o.append(n.BB.el({content:[n.BB.el({tagName:"label",content:["X:",b],css:S}),n.BB.el({tagName:"label",content:["Y:",w],css:S}),n.BB.el({tagName:"label",content:[(0,a.LANG)("width")+":",B],css:S}),n.BB.el({tagName:"label",content:[(0,a.LANG)("height")+":",k],css:S})],css:{display:"flex",marginLeft:"-5px"}}));var C=new(0,s.KlSlider)({label:(0,a.LANG)("brush-blending"),width:300,height:30,min:0,max:1,value:y.blend,eventResMs:l.EVENT_RES_MS,onChange:function(e){y.blend=e,q()},formatFunc:function(e){return n.BB.round(e,2)},manualInputRoundDigits:2});(0,u.css)(C.getElement(),{margin:"10px 0"}),o.append(C.getElement());var E=1,L=new(0,c.TwoTabs)({left:(0,a.LANG)("compare-before"),right:(0,a.LANG)("compare-after"),init:E,onChange:function(e){E=e,j.style.display=0===e?"block":"none",q(!0)}});o.append(L.getElement());var I=e.klCanvas,T=I.getLayers(),A=(0,u.throwIfNull)(I.getLayerIndex(g.canvas)),M=n.BB.fitInto(g.canvas.width,g.canvas.height,i?280:490,i?200:240,1),R=parseInt(""+M.width),_=parseInt(""+M.height),P=Math.min(R,g.canvas.width),D=Math.min(_,g.canvas.height),N=R/g.canvas.width,O=n.BB.el({className:"kl-preview-wrapper",css:{width:(0,d.getPreviewWidth)(i)+"px",height:(0,d.getPreviewHeight)(i)+"px",marginTop:"0"}}),G={image:n.BB.canvas(P,D),isVisible:T[A].isVisible,opacity:T[A].opacity,mixModeStr:T[A].mixModeStr},H=T.map(function(e,t){return t===A?G:{image:e.context.canvas,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr}}),z=new(0,h.KlCanvasPreview)({width:Math.round(R),height:Math.round(_),layers:H}),j=n.BB.canvas(R,_);(0,u.css)(j,{position:"absolute",left:"0",top:"0",mixBlendMode:"difference",imageRendering:"pixelated"});var F=n.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+R)+"px",height:parseInt(""+_)+"px"}});F.append(z.getElement(),j),O.append(F),o.append(O);var V={};function U(){b.value=""+y.x,w.value=""+y.y,B.value=""+y.width,k.value=""+y.height}var W=new n.BB.KeyListener({});O.oncontextmenu=function(){return!1},F.style.touchAction="none";var X=new n.BB.PointerListener({target:F,onPointer:function(e){if(0===E)if("pointerdown"===e.type){if(!V.state){V.oldSettings=n.BB.copyObj(y);var t=e.relX/N,i=e.relY/N;n.BB.isInsideRect({x:t,y:i},{x:y.x,y:y.y,width:y.width,height:y.height})?V.state="move":V.state="select",V.start={x:t,y:i}}}else if("pointermove"===e.type){var r=e.relX/N,o=e.relY/N;if("select"===V.state){V.end={x:r,y:o};var s=Math.max(0,Math.min(V.start.x,V.end.x)),a=Math.max(0,Math.min(V.start.y,V.end.y)),l=Math.min(v,Math.max(V.start.x,V.end.x)),h=Math.min(m,Math.max(V.start.y,V.end.y));y.x=Math.floor(s),y.y=Math.floor(a),y.width=Math.min(1024,Math.ceil(l-y.x)),y.height=Math.min(1024,Math.ceil(h-y.y)),W.isPressed("shift")&&(y.width=Math.min(y.width,y.height),y.height=Math.min(y.width,y.height)),(0===y.width||0===y.height)&&(y=n.BB.copyObj(V.oldSettings)),U(),q()}else if("move"===V.state){var c=Math.round(r-V.start.x),u=Math.round(o-V.start.y);y.x=n.BB.clamp(V.oldSettings.x+c,0,v-y.width),y.y=n.BB.clamp(V.oldSettings.y+u,0,m-y.height),U(),q()}}else"pointerup"===e.type&&V.state&&(V.state=null);else"pointerdown"===e.type?V.state||(V.state="move",V.oldSettings=n.BB.copyObj(y),V.start={x:e.relX/N,y:e.relY/N},V.end=null):"pointermove"===e.type?V.state&&(V.end={x:e.relX/N,y:e.relY/N},y.offsetX=Math.round(V.end.x-V.start.x)+V.oldSettings.offsetX,y.offsetY=Math.round(V.end.y-V.start.y)+V.oldSettings.offsetY,q()):"pointerup"===e.type&&V.state&&(V.end||(y.offsetX=0,y.offsetY=0,q()),V.state=null)}}),K=n.BB.canvas(v,m),Y=n.BB.ctx(K);function Z(e,t,i,n,r){var o=Math.round(t+.5)-.5,s=Math.round(i+.5)-.5,a=Math.round(t+n-o),l=Math.round(i+r-s);e.strokeRect(o,s,a,l)}function q(e){if(e||!t||JSON.stringify(t)!==JSON.stringify(y)){if(0===E){Y.clearRect(0,0,v,m),Y.drawImage(g.canvas,0,0);var i=G.image,r=n.BB.ctx(i);r.save(),r.clearRect(0,0,P,D),r.drawImage(K,0,0,P,D),r.restore();var o=y.width*N,s=y.height*N,a=n.BB.ctx(j);a.save(),a.clearRect(0,0,R,_),a.strokeStyle="#fff",Z(a,y.x*N,y.y*N,o,s),y.blend>.05&&(a.strokeStyle="#f0f",Z(a,y.x*N-o/2*y.blend,y.y*N-s/2*y.blend,o*(1+y.blend),s*(1+y.blend))),a.restore()}else{Y.clearRect(0,0,v,m),Y.drawImage(g.canvas,0,0),f(Y,y);var l=G.image,h=n.BB.ctx(l);h.clearRect(0,0,P,D),h.drawImage(K,0,0,P,D)}z.render(),t=n.BB.copyObj(y)}}q();var $=function(){C.destroy(),W.destroy(),X.destroy(),z.destroy()},Q={element:o,destroy:$,getInput:function(){return $(),n.BB.copyObj(y)}};return i||(Q.width=d.MEDIUM_PREVIEW.width),Q},apply(e){var t=e.klCanvas,i=e.layer.context,n=e.klHistory;if(!t)return!1;f(i,e.input);var r=Object.fromEntries(e.klCanvas.getLayers().map(function(t){return t.id===e.layer.id?[t.id,{tiles:(0,g.canvasToLayerTiles)(e.layer.canvas)}]:[t.id,{}]}));return n.push({layerMap:r}),!0}}}),s("10iZP",function(t,i){e(t.exports,"filterDistort",function(){return m});var n=o("eWjiX"),r=o("aP0jf"),s=o("1mH1z"),a=o("cH2YE"),l=o("a5EFw"),h=o("iFIyy"),c=o("7bWhB"),u=o("7jh4K"),p=o("9tQ35"),d=o("jpkXO"),g=o("bh77f"),f=o("ChldL"),v=o("g6KQ0"),m={getDialog(e){var t=(0,g.testIsSmall)(),i=n.BB.el(),o=e.context,v=!0,m={stepSize:1,distortType:0,scale:{x:100,y:100},strength:{x:20,y:20},phase:{x:0,y:0},offset:{x:0,y:0}},y=[],x=n.BB.canvas(32,32),b=n.BB.ctx(x);b.beginPath(),b.arc(16,16,12.8,0,2*Math.PI),b.fill();var w=b.createLinearGradient(0,0,32,32);w.addColorStop(0,"#00f"),w.addColorStop(.5,"#f00"),w.addColorStop(1,"#fff"),b.fillStyle=w,b.globalCompositeOperation="source-atop",b.fillRect(0,0,32,32),(w=b.createLinearGradient(32,0,0,32)).addColorStop(0,"#000"),w.addColorStop(1,"#000"),b.fillStyle=w,b.globalCompositeOperation="destination-atop",b.fillRect(0,0,32,32);var B=(0,u.throwIfNull)((0,l.getSharedFx)()),k=B.texture(x);B.draw(k).update(),[0,1,2].forEach(function(e){var t=new Image,i=n.BB.copyObj(m);i.distortType=e,i.scale.x/=20,i.scale.y/=20,i.strength.x/=20,i.strength.y/=20,B.draw(k).multiplyAlpha().distort(i).unmultiplyAlpha().update(),b.clearRect(0,0,32,32),b.drawImage(B,0,0),t.src=x.toDataURL("image/png"),y.push(t)}),k.destroy();var S=n.BB.el({parent:i,css:{display:"flex",alignItems:"center"}}),C=new(0,h.Options)({optionArr:y.map(function(e,t){return(0,u.css)(e,{margin:"1px",borderRadius:"3px",transition:"all 0.1s ease-in-out"}),{id:""+t,label:e}}),initId:"0",onChange:function(e){m.distortType=Number(e),H.render()}});function E(e){"x"===e?(m.scale.y=m.scale.x,m.strength.y=m.strength.x,m.phase.y=m.phase.x,R[3].setValue(m.scale.y),R[4].setValue(m.strength.y),R[5].setValue(m.phase.y)):(m.scale.x=m.scale.y,m.strength.x=m.strength.y,m.phase.x=m.phase.y,R[0].setValue(m.scale.x),R[1].setValue(m.strength.x),R[2].setValue(m.phase.x)),H.render()}var L=new(0,c.Checkbox)({init:!0,label:(0,s.LANG)("filter-distort-sync-xy"),callback:function(e){(v=e)&&E("x")},name:"sync-xy"});S.append(C.getElement(),n.BB.el({css:{flexGrow:"1"}}),L.getElement());var I=n.BB.el({parent:i,css:{display:"flex",flexWrap:"wrap"}}),T=n.BB.el({parent:I,css:{marginRight:"10px"}}),A=n.BB.el({parent:I}),M=t?300:245,R=[];["x","y"].forEach(function(e,t){var i=0===t?T:A,o=new(0,r.KlSlider)({label:(0,s.LANG)("filter-noise-scale")+" "+e.toUpperCase(),width:M,height:30,min:1,max:1e3,curve:"quadratic",value:m.scale[e],eventResMs:a.EVENT_RES_MS,onChange:function(t){m.scale[e]=t,v?E(e):H.render()}});o.getElement().style.marginTop="20px",i.append(o.getElement());var l=new(0,r.KlSlider)({label:(0,s.LANG)("filter-unsharp-mask-strength")+" "+e.toUpperCase(),width:M,height:30,min:0,max:200,curve:"quadratic",value:m.strength[e],eventResMs:a.EVENT_RES_MS,onChange:function(t){m.strength[e]=t,v?E(e):H.render()}});l.getElement().style.marginTop="10px",i.append(l.getElement());var h=new(0,r.KlSlider)({label:(0,s.LANG)("filter-distort-phase")+" "+e.toUpperCase(),width:M,height:30,min:0,max:1,value:m.phase[e],manualInputRoundDigits:2,eventResMs:a.EVENT_RES_MS,formatFunc:function(e){return n.BB.round(e,2)},onChange:function(t){m.phase[e]=t,v?E(e):H.render()}});h.getElement().style.marginTop="10px",i.append(h.getElement()),R.push(o),R.push(l),R.push(h)});var _=new(0,r.KlSlider)({label:(0,s.LANG)("filter-distort-stepsize"),width:300,height:30,min:1,max:300,curve:"quadratic",value:m.stepSize,eventResMs:a.EVENT_RES_MS,onChange:function(e){m.stepSize=Math.round(e),H.render()}});_.getElement().style.marginTop="20px",_.getElement().style.marginBottom="10px",i.append(_.getElement());var P=e.klCanvas,D=P.getLayers(),N=(0,u.throwIfNull)(P.getLayerIndex(o.canvas)),O=new(0,p.FxPreviewRenderer)({original:o.canvas,onUpdate:function(e,t){var i=n.BB.copyObj(m);return i.stepSize*=t.scaleX,i.strength.x*=t.scaleX,i.strength.y*=t.scaleY,2!==i.distortType&&(i.scale.x*=t.scaleX,i.scale.y*=t.scaleY),i.offset.x=-t.x,i.offset.y=-t.y,e.multiplyAlpha().distort(i).unmultiplyAlpha()},selection:P.getSelection()}),G=D.map(function(e,t){return{image:t===N?O.render:e.context.canvas,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,hasClipping:!1}}),H=new(0,d.Preview)({width:(0,f.getPreviewWidth)(t),height:(0,f.getPreviewHeight)(t),project:{width:o.canvas.width,height:o.canvas.height,layers:G},selection:P.getSelection()});H.render(),(0,u.css)(H.getElement(),{marginLeft:"-20px",marginRight:"-20px"}),i.append(H.getElement());var z=function(){C.destroy(),R.forEach(function(e){return e.destroy()}),_.destroy(),L.destroy(),O.destroy(),H.destroy()},j={element:i,destroy:z,getInput:function(){return z(),n.BB.copyObj(m)}};return t||(j.width=f.MEDIUM_PREVIEW.width),j},apply(e){var t=e.klCanvas,i=e.layer.context,n=e.klHistory;return!!t&&(0,v.applyFxFilter)(i,e.klCanvas.getSelection(),function(t){t.multiplyAlpha().distort(e.input).unmultiplyAlpha()},n)}}}),s("dteOZ",function(t,i){e(t.exports,"filterVanishPoint",function(){return m});var n=o("eWjiX"),r=o("1mH1z"),s=o("dJPtW"),a=o("43qNf"),l=o("jsIPR"),h=o("aP0jf"),c=o("cH2YE"),u=o("7jh4K"),p=o("jpkXO"),d=o("3xvcu"),g=o("bh77f"),f=o("ChldL"),v=o("4sWjZ"),m={getDialog(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var o=i.getLayers(),v=(0,u.throwIfNull)(i.getLayerIndex(t.canvas)),m=n.BB.canvas(t.canvas.width,t.canvas.height),y=n.BB.ctx(m),x=n.BB.el(),b={element:x},w=(0,g.testIsSmall)();w||(b.width=(0,f.getPreviewWidth)(w));var B={x:t.canvas.width/2,y:t.canvas.height/2,lines:8,thickness:2,color:{r:0,g:0,b:0},opacity:1},k=new(0,h.KlSlider)({label:(0,r.LANG)("filter-vanish-point-lines"),width:300,height:30,min:2,max:20,value:B.lines,curve:"quadratic",eventResMs:c.EVENT_RES_MS,onChange:function(e){B.lines=Math.round(e),_()}});k.getElement().style.marginBottom="10px",x.append(k.getElement());var S=n.BB.el({parent:x,css:{display:"flex",alignItems:"center"}}),C=n.BB.el({parent:x,css:{display:"flex",alignItems:"center",marginTop:"10px",marginBottom:"10px"}}),E=(0,s.input)({init:B.x,type:"number",css:{width:"75px",marginRight:"20px"},callback:function(e){B.x=parseFloat(e),G.setValue({x:B.x,y:B.y}),_()}}),L=(0,s.input)({init:B.y,type:"number",css:{width:"75px",marginRight:"20px"},callback:function(e){B.y=parseFloat(e),G.setValue({x:B.x,y:B.y}),_()}}),I=(0,s.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){B.thickness=parseFloat(e),_()}}),T={r:0,g:0,b:0,a:1},A=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];A.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),A.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1}),B.color=n.BB.copyObj(T);var M=new(0,a.ColorOptions)({label:(0,r.LANG)("shape-stroke"),colorArr:A,onChange:function(e){T=e,B.color=n.BB.copyObj(T),_()}}),R={display:"inline-block",marginRight:"5px"};function _(){var e=m.width,i=m.height;y.save(),y.clearRect(0,0,e,i),y.drawImage(t.canvas,0,0,e,i),(0,l.drawVanishPoint)(y,B.x,B.y,B.lines,Math.max(B.thickness,1),B.color,B.opacity),y.restore(),O.render()}S.append(n.BB.el({content:"X:",css:R}),E,n.BB.el({content:"Y:",css:R}),L),C.append(n.BB.el({content:(0,r.LANG)("shape-line-width")+":",css:R}),I,n.BB.el({css:{flexGrow:"1"}}),M.getElement());for(var P=function(){return G.setTransform(O.getTransform()),m},D=[],N=0;N<o.length;N++)D.push({image:N===v?P:o[N].context.canvas,isVisible:o[N].isVisible,opacity:o[N].opacity,mixModeStr:o[N].mixModeStr,hasClipping:!1});var O=new(0,p.Preview)({width:(0,f.getPreviewWidth)(w),height:(0,f.getPreviewHeight)(w),project:{width:t.canvas.width,height:t.canvas.height,layers:D}});(0,u.css)(O.getElement(),{marginLeft:"-20px",marginRight:"-20px",overflow:"hidden"});var G=new(0,d.DraggableInput)({value:{x:B.x,y:B.y},onChange:function(e){B.x=Math.round(e.x),B.y=Math.round(e.y),E.value=""+B.x,L.value=""+B.y,_()}});return _(),O.getElement().append(G.getElement()),x.append(O.getElement()),b.destroy=function(){k.destroy(),M.destroy(),O.destroy()},b.getInput=function(){return b.destroy(),n.BB.copyObj(B)},b},apply(e){var t=e.layer.context,i=e.klCanvas,n=e.klHistory;if(!t||!i)return!1;(0,l.drawVanishPoint)(t,e.input.x,e.input.y,e.input.lines,e.input.thickness,e.input.color,e.input.opacity);var r=Object.fromEntries(e.klCanvas.getLayers().map(function(t){return t.id===e.layer.id?[t.id,{tiles:(0,v.canvasToLayerTiles)(e.layer.canvas)}]:[t.id,{}]}));return n.push({layerMap:r}),!0}}}),s("jsIPR",function(t,i){e(t.exports,"drawVanishPoint",function(){return s});var n=o("3ujzu"),r=o("eWjiX");function s(e,t,i,o,s,a,l){e.save();for(var h=180/o,c=0;c<180;c+=h){var u=r.BB.rotateAround({x:t,y:i},{x:t+9999,y:i},c);(0,n.drawShape)(e,{type:"line",x1:t,y1:i,x2:u.x,y2:u.y,isOutwards:!0,opacity:l,strokeRgb:a,lineWidth:s})}e.restore()}}),s("3WOmu",function(t,i){e(t.exports,"klCanvasToPsdBlob",function(){return l});var n=o("1LaJZ"),r=o("2gUX3"),s=o("hrnUX"),a=o("iVf04");function l(e){return(0,n._)(function(){var t,i;return(0,r.__generator)(this,function(n){switch(n.label){case 0:return t=e.getLayersFast(),i={width:e.getWidth(),height:e.getHeight(),children:t.map(function(e){return{name:e.name,hidden:!e.isVisible,opacity:e.opacity,canvas:e.canvas,blendMode:s.KL.PSD.blendKlToPsd(e.mixModeStr),left:0,top:0}})},[4,(0,a.loadAgPsd)()];case 1:return[2,new Blob([n.sent().writePsdBuffer(i)],{type:"application/octet-stream"})]}})})()}}),s("iuTWx",function(t,i){e(t.exports,"LineSmoothing",function(){return a});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=function(){"use strict";function e(t){(0,n._)(this,e),this.smoothing=s.BB.clamp(t.smoothing,0,1)}return(0,r._)(e,[{key:"chainIn",value:function(e){var t=this;if(e=s.BB.copyObj(e),clearTimeout(this.timeout),clearInterval(this.interval),"down"===e.type&&(this.lastMixedInput={x:e.x,y:e.y,pressure:e.pressure}),"move"===e.type){var i=e.x,n=e.y,r=e.pressure;e.x=s.BB.mix(e.x,this.lastMixedInput.x,this.smoothing),e.y=s.BB.mix(e.y,this.lastMixedInput.y,this.smoothing),e.pressure=s.BB.mix(e.pressure,this.lastMixedInput.pressure,this.smoothing),this.lastMixedInput={x:e.x,y:e.y,pressure:e.pressure},this.smoothing>0&&(this.timeout=setTimeout(function(){t.interval=setInterval(function(){var o;(e=JSON.parse(JSON.stringify(e))).x=s.BB.mix(i,t.lastMixedInput.x,t.smoothing),e.y=s.BB.mix(n,t.lastMixedInput.y,t.smoothing),e.pressure=s.BB.mix(r,t.lastMixedInput.pressure,t.smoothing),t.lastMixedInput={x:e.x,y:e.y,pressure:e.pressure},null==(o=t.chainOut)||o.call(t,e)},35)},80))}return e}},{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"setSmoothing",value:function(e){this.smoothing=s.BB.clamp(e,0,1)}}]),e}()}),s("57YJz",function(t,i){e(t.exports,"LineSanitizer",function(){return s});var n=o("cx0mh"),r=o("7h4XF"),s=function(){"use strict";function e(){(0,n._)(this,e),this.isDrawing=!1}return(0,r._)(e,[{key:"chainIn",value:function(e){return("down"===e.type&&(this.isDrawing?this.chainOut&&this.chainOut({type:"up",scale:e.scale,shiftIsPressed:e.shiftIsPressed,isCoalesced:!1}):this.isDrawing=!0),this.isDrawing||"move"!==e.type&&"up"!==e.type)?("up"===e.type&&this.isDrawing&&(this.isDrawing=!1),e):null}},{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"getIsDrawing",value:function(){return this.isDrawing}}]),e}()}),s("aId1u",function(t,i){e(t.exports,"translateSmoothing",function(){return n});function n(e){return 1==e?.5:2==e?.84:3==e?.965:4==e?.9825:5==e?.99125:e}}),s("4hRms",function(t,i){e(t.exports,"KlAppImportHandler",function(){return v});var n=o("1LaJZ"),r=o("cx0mh"),s=o("7h4XF"),a=o("bX4ja"),l=o("8KHnw"),h=(o("2gUX3"),o("2gUX3")),c=o("hrnUX"),u=o("1mH1z"),p=o("eWjiX"),d=o("7jh4K"),g=o("dMsoA"),f=o("ivWfr"),v=function(){"use strict";function e(t,i){(0,r._)(this,e),this.klRootEl=t.klRootEl,this.klMaxCanvasSize=t.maxCanvasSize,this.layersUi=t.layersUi,this.setCurrentLayer=t.setCurrentLayer,this.klCanvas=t.klCanvas,this.onImportConfirm=t.onImportConfirm,this.applyUncommitted=t.applyUncommitted,this.onColor=i.onColor}return(0,s._)(e,[{key:"importFinishedLoading",value:function(e,t,i){var n=this;if(!e||isNaN(e.width)||isNaN(e.height)||e.width<=0||e.height<=0)return void c.KL.popup({target:this.klRootEl,type:"error",message:(0,u.LANG)("import-broken-file"),buttons:["Ok"]});var r=function(e,t){var i=parseInt(""+e),r=parseInt(""+t);return i>n.klMaxCanvasSize&&(r=n.klMaxCanvasSize/i*r,i=n.klMaxCanvasSize),r>n.klMaxCanvasSize&&(i=n.klMaxCanvasSize/r*i,r=n.klMaxCanvasSize),{width:i=parseInt(""+i),height:r=parseInt(""+r)}},o=function(e){n.applyUncommitted();var i=r(e.width,e.height),o=p.BB.canvas(e.width,e.height);p.BB.ctx(o).drawImage(e,0,0),p.BB.resizeCanvas(o,i.width,i.height),n.klCanvas.reset({width:i.width,height:i.height,image:o,layerName:t}),n.layersUi.update(0),n.setCurrentLayer(n.klCanvas.getLayer(0)),n.onImportConfirm()},s=function(e,t){n.applyUncommitted();var i,o=function(e,t,i){t.width=t.width,p.BB.ctx(t).drawImage(e,-i.x,-i.y),e.width=i.width,e.height=i.height,p.BB.ctx(e).drawImage(t,0,0)};if(t&&(t.width!==e.width||t.height!==e.height)){var s=p.BB.canvas(t.width,t.height);if(e.width=t.width,e.height=t.height,e.layers||o(e.canvas,s,t),e.layers)for(var a=0;a<e.layers.length;a++)o(e.layers[a].image,s,t)}var l=r(e.width,e.height);if(e.width=l.width,e.height=l.height,e.layers||p.BB.resizeCanvas(e.canvas,e.width,e.height),e.layers)for(var h=0;h<e.layers.length;h++){var c=e.layers[h];p.BB.resizeCanvas(c.image,e.width,e.height)}i=e.layers?n.klCanvas.reset({width:e.width,height:e.height,layers:e.layers.map(function(e){return{id:(0,g.getNextLayerId)(),name:e.name,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,image:e.image}})}):n.klCanvas.reset({width:e.width,height:e.height,image:e.canvas}),n.layersUi.update(i),n.setCurrentLayer(n.klCanvas.getLayer(i)),n.onImportConfirm()},a=function(e){n.applyUncommitted(),c.KL.showImportAsLayerDialog({target:n.klRootEl,klCanvas:n.klCanvas,importImage:e,callback:function(i,r){if(i){var o=function(t){p.BB.drawTransformedImageWithBounds(t,e,i,void 0,r)};n.klCanvas.addLayer(void 0,{name:t,isVisible:!0,opacity:1,image:o})||n.klCanvas.drawOperation(n.klCanvas.getLayers().length-1,o);var s=n.klCanvas.getLayers().length-1;n.setCurrentLayer(n.klCanvas.getLayer(s)),n.layersUi.update(s)}}})};"default"!==i&&i||c.KL.showImportImageDialog({image:e,target:this.klRootEl,maxSize:this.klMaxCanvasSize,callback:function(e){"as-image"===e.type?o(e.image):"as-image-psd"===e.type?s(e.image,e.cropObj):"as-layer"===e.type?a(e.image):e.type}}),"layer"===i&&a(e.canvas),"image"===i&&("psd"===e.type?s(e):o(e.canvas))}},{key:"readClipboard",value:function(){return(0,n._)(function(){var e,t,i,n,r,o,s,a,p,d,g,f,v,m,y,x,b;return(0,h.__generator)(this,function(w){switch(w.label){case 0:e=this,w.label=1;case 1:return w.trys.push([1,17,,18]),[4,navigator.clipboard.read()];case 2:t=w.sent(),i=!1,n=!0,r=!1,o=void 0,w.label=3;case 3:w.trys.push([3,14,15,16]),s=t[Symbol.iterator](),w.label=4;case 4:if(n=(a=s.next()).done)return[3,13];p=a.value,d=!0,g=!1,f=void 0,w.label=5;case 5:w.trys.push([5,10,11,12]),v=function(){var t,n,r;return(0,h.__generator)(this,function(o){switch(o.label){case 0:if(!(t=y.value).startsWith("image"))return[3,2];return i=!0,[4,p.getType(t)];case 1:return n=o.sent(),(r=new Image).onload=function(){URL.revokeObjectURL(r.src),e.importFinishedLoading({type:"image",width:r.width,height:r.height,canvas:r},void 0,"default")},r.src=URL.createObjectURL(n),[2,{v:void 0}];case 2:return[2]}})},m=p.types[Symbol.iterator](),w.label=6;case 6:if(d=(y=m.next()).done)return[3,9];return[5,(0,h.__values)(v())];case 7:if(x=w.sent(),"object"===(0,l._)(x))return[2,x.v];w.label=8;case 8:return d=!0,[3,6];case 9:return[3,12];case 10:return b=w.sent(),g=!0,f=b,[3,12];case 11:try{d||null==m.return||m.return()}finally{if(g)throw f}return[7];case 12:return n=!0,[3,4];case 13:return[3,16];case 14:return b=w.sent(),r=!0,o=b,[3,16];case 15:try{n||null==s.return||s.return()}finally{if(r)throw o}return[7];case 16:return i||c.KL.popup({target:this.klRootEl,type:"error",message:(0,u.LANG)("clipboard-no-image"),buttons:["Ok"]}),[3,18];case 17:return w.sent(),c.KL.popup({target:this.klRootEl,type:"error",message:(0,u.LANG)("clipboard-read-fail"),buttons:["Ok"]}),[3,18];case 18:return[2]}})}).call(this)}},{key:"onPaste",value:function(e){var t=this;!(c.KL.DIALOG_COUNTER.get()>0)&&(e.stopPropagation(),e.preventDefault(),e.clipboardData&&(e.clipboardData.files[0]?function(e,t){if(e){for(var i=0;i<e.length;i++)if(-1!=e[i].type.indexOf("image")){var n=e[i].getAsFile();n&&t(n)}}}(e.clipboardData.items,function(e){var i=new Image;i.onload=function(){URL.revokeObjectURL(i.src),t.importFinishedLoading({type:"image",width:i.width,height:i.height,canvas:i},void 0,"default")},i.src=(window.URL||window.webkitURL).createObjectURL(e)}):e.clipboardData.items[0]&&e.clipboardData.items[0].getAsString(function(e){if((e=e.trim()).match(/^https?/)){var i=new Image;i.onload=function(){t.importFinishedLoading({type:"image",width:i.width,height:i.height,canvas:i},void 0,"default")},i.onerror=function(e){console.log("error loading",e)},i.crossOrigin="Anonymous",i.src=e}else if(e.match(/^#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/)){var n=p.BB.ColorConverter.hexToRGB(e.replace("#",""));n&&t.onColor(n)}})))}},{key:"handleFileSelect",value:function(e,t){return(0,n._)(function(){var i,n,r,o,s,l,g;return(0,h.__generator)(this,function(h){switch(h.label){case 0:i=this,n=function(){c.KL.popup({target:i.klRootEl,type:"warning",message:(0,u.LANG)("import-psd-unsupported")+"<br /><br />",buttons:["Ok"]})},r=!1,o=(0,a._)(e),s=0,h.label=1;case 1:if(!(s<o.length))return[3,4];return l=o[s],[4,(0,f.detectFiletype)(l)];case 2:if("image"===(g=h.sent())){var v,m,y;v=l,window.URL=window.URL||window.webkitURL,m=window.URL.createObjectURL(v),(y=new Image).src=m,p.BB.loadImage(y,function(){URL.revokeObjectURL(m),i.importFinishedLoading({type:"image",width:y.width,height:y.height,canvas:y},v.name,t)})}else"psd"===g?function(e){if(e.size>=0x40000000)return c.KL.popup({target:i.klRootEl,type:"error",message:"File too big. Unable to import.<br /><br />",buttons:["Ok"]});var r,s=1===o.length&&e.size>=0x1900000,a=!0;s&&c.KL.popup({target:i.klRootEl,message:(0,u.LANG)("import-opening"),callback:function(e){a=!1,r=null},closeFunc:function(e){r=e}});var l=new FileReader;l.onload=function(o){var l=(0,d.throwIfNull)(o.target);c.KL.loadAgPsd().then(function(o){if(!s||a)try{var h;if((h=o.readPsd(l.result,{skipLayerImageData:!0,skipThumbnail:!0,skipCompositeImageData:!0})).width>4096||h.height>4096){r&&r(),c.KL.popup({target:i.klRootEl,type:"error",message:(0,u.LANG)("import-psd-too-large").replace(/{x}/g,"4096")+"<br /><br />"+(0,u.LANG)("import-psd-size")+": "+h.width+" x "+h.height+" pixels<br /><br />",buttons:["Ok"]});return}h=null;try{h=o.readPsd(l.result)}catch(e){}if(h){var p=c.KL.PSD.readPsd(h);"image"===t&&p.error&&n(),r&&r(),i.importFinishedLoading(p,e.name,t)}else h=o.readPsd(l.result,{skipLayerImageData:!0,skipThumbnail:!0}),"image"===t&&n(),r&&r(),i.importFinishedLoading({type:"psd",width:h.width,height:h.height,canvas:(0,d.throwIfUndefined)(h.canvas),error:!0},e.name,t)}catch(e){null==r||r(),c.KL.popup({target:i.klRootEl,type:"error",message:"Failed to load PSD.<br /><br />",buttons:["Ok"]}),console.log(e),setTimeout(function(){throw Error("psd load error")})}}).catch(function(e){null==r||r(),alert("Error: failed to load PSD library")})},l.readAsArrayBuffer(e)}(l):r=!0;h.label=3;case 3:return s++,[3,1];case 4:return r&&c.KL.popup({target:this.klRootEl,message:(0,u.LANG)("import-unsupported-file"),type:"error",buttons:["OK"]}),[2]}})}).call(this)}}]),e}()}),s("ivWfr",function(t,i){e(t.exports,"detectFiletype",function(){return a});var n=o("1LaJZ"),r=o("2gUX3");function s(e,t){return t.every(function(t,i){return void 0===t||e[i]===t})}function a(e){return(0,n._)(function(){var t,i,n;return(0,r.__generator)(this,function(r){switch(r.label){case 0:if(i=(t=e.name.split("."))[t.length-1].toLowerCase(),e.type.match("image/vnd.adobe.photoshop")||"psd"===i)return[2,"psd"];if(e.type.match("image.*"))return[2,"image"];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,new Promise(function(t,i){var n=new FileReader;n.onload=function(){if(null===n.result)return void i();t(new Uint8Array(n.result))},n.onerror=i,n.readAsArrayBuffer(e.slice(0,12))})];case 2:if(s(n=r.sent(),[56,66,80,83]))return[2,"psd"];if(s(n,[137,80,78,71,13,10,26,10])||s(n,[255,216])||s(n,[82,73,70,70,void 0,void 0,void 0,void 0,87,69,66,80]))return[2,"image"];return[3,4];case 3:return r.sent(),[3,4];case 4:return[2,void 0]}})})()}}),s("3yTCU",function(e,t){e.exports=i("k9Nks")}),s("4C8mG",function(e,t){e.exports=i("bBxqy")}),s("dvw1S",function(e,t){e.exports=i("3UXKl")}),s("qur3y",function(t,i){e(t.exports,"createConsoleApi",function(){return r});var n=o("bX4ja");function r(e){var t,i,r=["Draw via the console! Learn more: %cKL.help()","background: #000; color: #0f0;"];return"info"in console?(t=console).info.apply(t,(0,n._)(r)):(i=console).log.apply(i,(0,n._)(r)),Object.freeze({draw:function(t){e.onDraw(t)},help:function(){console.log(`KL.draw({x: number; y: number}[]) // draw a line
KL.help() // print help
`)}})}}),s("8I3X7",function(t,i){e(t.exports,"Easel",function(){return T});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("4EWN2"),l=o("8N5YG"),h=o("bX4ja"),c=o("amum4"),u=o("bMICc"),p=o("04lDo"),d=o("eWjiX"),g=o("lUrXo"),f=o("8G4G9"),v=o("1GsyD");o("ciAU9");var m=o("cdZRx"),y=o("kDVZW"),x=o("6wbw7"),b=o("idV3L"),w=o("63yUO"),B=o("b7Uwg"),k=o("hAS38"),S=o("eg83P"),C=o("7JyFK"),E=o("4GEIE"),L=o("ftFr7"),I=o("7jh4K"),T=function(){"use strict";function e(t){var i,r,o,a,k=this,E=this;(0,n._)(this,e),this.doRender=!1,this.isFrozen=!1,this.lastRenderedTransform={},this.targetTransform={},this.easelInterface={setCursor:function(e){return k.rootEl.style.cursor=e},getTransform:function(){return k.viewport.getTransform()},getTargetTransform:function(){return k.targetTransform},getSize:function(){return{width:k.width,height:k.height}},getProjectSize:function(){return{width:k.project.width,height:k.project.height}},setTransform:function(e,t){return k.setTargetTransform(e,t)},requestRender:function(){return k.requestRender()},isKeyPressed:function(e){return k.keyListener.isPressed(e)},minScale:C.EASEL_MIN_SCALE,maxScale:C.EASEL_MAX_SCALE,setAngleDeg:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return E.setAngleDeg.apply(E,(0,h._)(t))},keyListener:{},updateDoubleTapPointerTypes:function(){return k.updateDoubleTapPointerTypes()},setRenderedSelection:function(e){return k.selectionRenderer.setRenderedSelection(e)},clearRenderedSelection:function(e){return k.selectionRenderer.clearRenderedSelection(e)},onWheel:function(e){return k.onWheel(e)},getElement:function(){return k.rootEl}},this.lastFrameTimestamp=0,this.onWheel=function(e){null==(t=e.event)||t.preventDefault();var t,i=!1;if(.8>Math.abs(e.deltaY)&&(i=!0),e.event&&e.event.ctrlKey&&!k.keyListener.isPressed("ctrl")){i=!0;var n=1;0===e.event.deltaMode&&(n=6),e.deltaY*=n}k.keyListener.isPressed("shift")&&(e.deltaY/=4);var r=k.targetTransform,o={x:e.relX,y:e.relY},s=(0,v.createMatrixFromTransform)(r),a=(0,m.applyToPoint)((0,y.inverse)(s),o),l=d.BB.clamp(r.scale*Math.pow(1.4,-e.deltaY),C.EASEL_MIN_SCALE,C.EASEL_MAX_SCALE);k.setTargetTransform((0,f.createTransform)(o,a,l,r.angleDeg),i)},this.project=t.project,this.width=t.width,this.height=t.height,this.toolId=t.tool,this.toolsMap=(0,s._)({},t.tools),this.onChangeTool=t.onChangeTool,this.onTransformChange=t.onTransformChange,this.onUndo=t.onUndo,this.onRedo=t.onRedo,this.tempTools=Object.fromEntries(C.TEMP_TRIGGERS.map(function(e){return[e,Object.entries(k.toolsMap).filter(function(t){var i=(0,l._)(t,2),n=(i[0],i[1]);return n.tempTriggers&&n.tempTriggers.includes(e)}).map(function(e){return e[0]})[0]]})),this.viewport=new(0,u.ProjectViewport)({width:this.width,height:this.height,project:{width:this.project.width,height:this.project.height,layers:this.project.layers},transform:this.getResetTransform(),renderAfter:function(e,t){var i,n=k.getActiveTool();null==(i=n.renderAfterViewport)||i.call(n,e,t)}}),Object.values(this.toolsMap).forEach(function(e){var t,i;null==(t=e.setEaselInterface)||t.call(e,k.easelInterface),null==(i=e.onResize)||i.call(e,k.width,k.height)});var L=!1,T=!1,A=!1;this.pointerPreprocessor=new(0,x.EaselPointerPreprocessor)({onUndo:this.onUndo,onRedo:this.onRedo,onPinch:function(e){if("move"===e.type){var t=k.viewport.getTransform();k.pinchInitialTransform||(k.pinchInitialTransform=d.BB.copyObj(t),A=k.pinchInitialTransform.angleDeg%180==0);var i=k.pinchInitialTransform.angleDeg+e.angleRad/Math.PI*180;(i=(0,S.minimizeAngleDeg)((0,S.snapAngleDeg)(i,90,A?12:4)))%90!=0&&(A=!1);var n=(0,g.toMetaTransform)(k.pinchInitialTransform,{x:e.downRelX,y:e.downRelY});n.scale=d.BB.clamp(k.pinchInitialTransform.scale*e.scale,C.EASEL_MIN_SCALE,C.EASEL_MAX_SCALE),n.viewportP.x+=e.relX-e.downRelX,n.viewportP.y+=e.relY-e.downRelY,n.angleDeg=i,k.setTargetTransform((0,f.createTransform)(n.viewportP,n.canvasP,n.scale,n.angleDeg),!0),k.requestRender()}else"end"===e.type&&(k.pinchInitialTransform=void 0)},onDoubleTap:function(e){k.fitTransform()?k.requestRender():k.scale(2,e.relX,e.relY)},onChainOut:function(e){if(k.cursorPos={x:e.relX,y:e.relY},"pointerdown"===e.type)"middle"===e.button&&(L=!0,k.pushTempTool(k.tempTools["mouse-middle"])),"right"===e.button&&(T=!0,k.pushTempTool(k.tempTools["mouse-right"]));else if("pointermove"===e.type);else if("pointerup"===e.type){if(L){L=!1,k.getActiveTool().onPointer(e),k.popTempTool(k.tempTools["mouse-middle"]);return}if(T){T=!1,k.getActiveTool().onPointer(e),k.popTempTool(k.tempTools["mouse-right"]);return}}k.getActiveTool().onPointer(e)}}),this.pointerListener=new(0,p.PointerListener)({target:this.viewport.getElement(),onPointer:function(e){k.pointerPreprocessor.chainIn(e)},onWheel:this.onWheel,onEnterLeave:function(e){var t,i=k.getActiveTool();e||(k.cursorPos=void 0,null==(t=i.onPointerLeave)||t.call(i))},useDirtyWheel:!0,isWheelPassive:!1,maxPointers:3}),this.windowPointerListener=function(e){var t,i;!k.isFrozen&&(k.rootEl.contains(e.target)||null==(t=(i=k.getActiveTool()).onClickOutside)||t.call(i))},window.addEventListener("pointerdown",this.windowPointerListener),this.keyListener=new(0,b.KeyListener)({onDown:function(e,t,i,n){if(!k.isFrozen){if("plus"===i){var r,o=k.getTransform().scale,s=(0,w.zoomByStep)(o,k.keyListener.isPressed("shift")?1/8:.5);k.scale(s/o)}if("minus"===i){var a=k.getTransform().scale,l=(0,w.zoomByStep)(a,k.keyListener.isPressed("shift")?-1/8:-.5);k.scale(l/a)}if(k.keyListener.comboOnlyContains(["shift","left","right","up","down"])){var h,c,u=k.getActiveTool();(null==(c=u.onArrowKeys)?void 0:c.call(u,e))||("left"===e&&k.translate(40,0),"right"===e&&k.translate(-40,0),"up"===e&&k.translate(0,40),"down"===e&&k.translate(0,-40))}C.TEMP_TRIGGERS_KEYS.forEach(function(e){i===e&&k.toolsMap[k.toolId].blockTrigger!==e&&k.pushTempTool(k.tempTools[e])});var p=k.toolsMap[null!=(r=k.tempToolId)?r:k.toolId];null==(h=p.onKeyDown)||h.call(p,e,t,i,n)}},onUp:function(e,t,i){if(!k.isFrozen){C.TEMP_TRIGGERS_KEYS.forEach(function(t){e===t&&k.toolsMap[k.toolId].blockTrigger!==t&&k.popTempTool(k.tempTools[t])});var n,r,o=k.toolsMap[null!=(r=k.tempToolId)?r:k.toolId];null==(n=o.onKeyUp)||n.call(o,e,t,i)}},onBlur:function(){var e,t,i=k.toolsMap[null!=(t=k.tempToolId)?t:k.toolId];null==(e=i.onBlur)||e.call(i)}}),this.easelInterface.keyListener=this.keyListener,this.selectionRenderer=new(0,B.SelectionRenderer)({transform:this.viewport.getTransform(),selection:this.project.selection,width:this.width,height:this.height}),this.svgEl=d.BB.createSvg({elementType:"svg",width:""+this.width,height:""+this.height}),(0,I.css)(this.svgEl,{position:"absolute",left:"0",top:"0",pointerEvents:"none"}),(i=this.svgEl).append.apply(i,[this.selectionRenderer.getElement()].concat((0,h._)(Object.values(this.toolsMap).map(function(e){return e.getSvgElement()})))),this.htmlOverlayEl=d.BB.el({css:{position:"absolute",left:"0",top:"0"}}),(r=this.htmlOverlayEl).append.apply(r,(0,h._)(Object.values(this.toolsMap).map(function(e){var t;return(null==(t=e.getHtmlOverlayElement)?void 0:t.call(e))||void 0}).filter(function(e){return void 0!==e}))),this.updateToolSvgs(),this.rootEl=(0,c.c)({css:{userSelect:"none",touchAction:"none",overscrollBehaviorX:"none"}},[this.viewport.getElement(),this.svgEl,this.htmlOverlayEl]),this.rootEl.addEventListener("contextmenu",function(e){return e.preventDefault(),!1},{passive:!1}),this.rootEl.addEventListener("touchend",function(e){return e.preventDefault(),!1}),this.rootEl.addEventListener("dragstart",function(e){return e.preventDefault(),!1}),null==(o=(a=this.toolsMap[this.toolId]).activate)||o.call(a,this.cursorPos),Object.values(this.toolsMap).forEach(function(e){var t;return null==(t=e.onTool)?void 0:t.call(e,k.toolId)}),this.renderLoop()}return(0,r._)(e,[{key:"setTargetTransform",value:function(e,t){t&&this.viewport.setTransform(e),this.targetTransform=e,this.doRender=!0}},{key:"updateToolSvgs",value:function(){var e,t=this,i=null!=(e=this.tempToolId)?e:this.toolId;Object.keys(this.toolsMap).forEach(function(e){t.toolsMap[e].getSvgElement().style.display=e===i?"":"none"})}},{key:"updateDoubleTapPointerTypes",value:function(){var e,t,i=null!=(t=this.toolsMap[null!=(e=this.tempToolId)?e:this.toolId].doubleTapPointerTypes)?t:C.DEFAULT_DOUBLE_TAP_POINTER_TYPES;this.pointerPreprocessor.setDoubleTapPointerTypes(i)}},{key:"renderLoop",value:function(){var e,t=this,i=performance.now(),n=i-this.lastFrameTimestamp;if(this.lastFrameTimestamp=i,this.animationFrameId=requestAnimationFrame(function(){return t.renderLoop()}),this.doRender){var r=this.getActiveTool(),o=this.viewport.getTransform(),s=o;if((0,E.isTransformEqual)(o,this.targetTransform))this.doRender=!1;else{var a=1-Math.pow(.7,n/(1e3/60));s=(0,L.blendTransform)(o,this.targetTransform,{width:this.project.width,height:this.project.height},{x:this.width/2,y:this.height/2},a),this.viewport.setTransform(s)}var l=s.x!==this.lastRenderedTransform.x||s.y!==this.lastRenderedTransform.y,h=s.scale!==this.lastRenderedTransform.scale||s.angleDeg!==this.lastRenderedTransform.angleDeg;this.viewport.render(!(0,E.isTransformEqual)(o,s)),(l||h)&&(null==(e=r.onUpdateTransform)||e.call(r,s),this.selectionRenderer.setTransform(s),this.onTransformChange(this.targetTransform,h),this.lastRenderedTransform=s)}}},{key:"pushTempTool",value:function(e){if(void 0===this.tempToolId&&void 0!==e){var t,i,n,r=this.toolsMap[this.toolId];if(null==(t=r.getIsLocked)||!t.call(r)){this.tempToolId=e;var o=this.getActiveToolId();null==(i=(n=this.toolsMap[o]).activate)||i.call(n,this.cursorPos),Object.values(this.toolsMap).forEach(function(e){var t;return null==(t=e.onTool)?void 0:t.call(e,o)}),this.updateToolSvgs(),this.updateDoubleTapPointerTypes()}}}},{key:"popTempTool",value:function(e){if(this.tempToolId===e&&void 0!==e){this.tempToolId=void 0,null==(t=(i=this.getActiveTool()).activate)||t.call(i,this.cursorPos,!0);var t,i,n=this.getActiveToolId();Object.values(this.toolsMap).forEach(function(e){var t;return null==(t=e.onTool)?void 0:t.call(e,n)}),this.updateToolSvgs(),this.updateDoubleTapPointerTypes()}}},{key:"getActiveToolId",value:function(){var e;return null!=(e=this.tempToolId)?e:this.toolId}},{key:"getActiveTool",value:function(){return this.toolsMap[this.getActiveToolId()]}},{key:"getResetTransform",value:function(){return(0,f.createTransform)({x:this.width/2,y:this.height/2},{x:this.project.width/2,y:this.project.height/2},1,0)}},{key:"getFitTransform",value:function(){var e=this.viewport.getTransform().angleDeg;45===e&&(e=0),e=(0,S.snapAngleDeg)(e,90,90);var t=this.project.width,i=this.project.height,n=[[0,0],[t,0],[t,i],[0,i],[t/2,i/2]],r=d.BB.Matrix.getIdentity();r=d.BB.Matrix.multiplyMatrices(r,d.BB.Matrix.createRotationMatrix(e/180*Math.PI));for(var o=0;o<n.length;o++){var s=[n[o][0],n[o][1],0,1];s=d.BB.Matrix.multiplyMatrixAndPoint(r,s),n[o][0]=s[0],n[o][1]=s[1]}for(var a={},l=0;l<n.length;l++)(void 0===a.x1||n[l][0]<a.x1)&&(a.x1=n[l][0]),(void 0===a.y1||n[l][1]<a.y1)&&(a.y1=n[l][1]),(void 0===a.x2||n[l][0]>a.x2)&&(a.x2=n[l][0]),(void 0===a.y2||n[l][1]>a.y2)&&(a.y2=n[l][1]);var h=a.x2-a.x1,c=a.y2-a.y1,u=d.BB.fitInto(h,c,this.width-0,this.height-0,1).width,p=Math.min(C.EASEL_MAX_SCALE,u/h),g={width:this.width,height:this.height},v={x:g.width/2,y:g.height/2};return(0,f.createTransform)(v,{x:t/2,y:i/2},p,e)}},{key:"setProject",value:function(e){var t,i;this.project=e,this.viewport.setProject({width:this.project.width,height:this.project.height,layers:this.project.layers}),this.selectionRenderer.setSelection(this.project.selection),null==(t=(i=this.getActiveTool()).onUpdateSelection)||t.call(i,this.project.selection),this.requestRender()}},{key:"setSize",value:function(e,t){var i,n,r=(0,v.createMatrixFromTransform)(this.viewport.getTransform()),o=(0,m.applyToPoint)((0,y.inverse)(r),{x:this.width/2,y:this.height/2});this.width=e,this.height=t,d.BB.setAttributes(this.svgEl,{width:""+this.width,height:""+this.height}),this.selectionRenderer.setSize(e,t),null==(i=(n=this.getActiveTool()).onResize)||i.call(n,e,t),this.viewport.setSize(e,t);var s=this.viewport.getTransform();this.setTargetTransform((0,f.createTransform)({x:this.width/2,y:this.height/2},o,s.scale,s.angleDeg),!0),this.requestRender()}},{key:"requestRender",value:function(){this.doRender=!0}},{key:"getTransform",value:function(){return this.viewport.getTransform()}},{key:"setTransform",value:function(e){this.setTargetTransform(e,!0)}},{key:"setTool",value:function(e){var t,i,n=this;e!==this.toolId&&(this.toolId=e,null==(t=(i=this.toolsMap[this.toolId]).activate)||t.call(i,this.cursorPos),Object.values(this.toolsMap).forEach(function(e){var t;return null==(t=e.onTool)?void 0:t.call(e,n.toolId)}),this.onChangeTool(e),this.updateToolSvgs(),this.updateDoubleTapPointerTypes(),this.requestRender())}},{key:"getTool",value:function(){return this.toolId}},{key:"translate",value:function(e,t){var i=this.targetTransform;this.setTargetTransform((0,a._)((0,s._)({},i),{x:i.x+e,y:i.y+t}))}},{key:"scale",value:function(e,t,i){var n=this.targetTransform,r={width:this.width,height:this.height};t=null!=t?t:r.width/2,i=null!=i?i:r.height/2;var o=(0,g.toMetaTransform)(n,{x:t,y:i});o.scale=d.BB.clamp(o.scale*e,C.EASEL_MIN_SCALE,C.EASEL_MAX_SCALE),this.setTargetTransform((0,f.createTransform)(o.viewportP,o.canvasP,o.scale,o.angleDeg))}},{key:"resetTransform",value:function(e){var t=this.getResetTransform();this.setTargetTransform(t,e),this.requestRender()}},{key:"fitTransform",value:function(e){var t=this.viewport.getTransform(),i=this.getFitTransform(),n=i.x!==t.x||i.y!==t.y,r=i.scale!==t.scale||i.angleDeg!==t.angleDeg;return(!!n||!!r)&&(this.setTargetTransform(i,e),!0)}},{key:"resetOrFitTransform",value:function(e){!k.KL_CONFIG.disableAutoFit&&this.project.width<=this.width/4&&this.project.height<=this.height/4?this.fitTransform(e):this.resetTransform(e)}},{key:"setAngleDeg",value:function(e,t){var i=this.targetTransform,n=(0,v.createMatrixFromTransform)(i),r={width:this.width,height:this.height},o={x:r.width/2,y:r.height/2},s=(0,S.minimizeAngleDeg)(t?i.angleDeg+e:e),a=(0,f.createTransform)(o,(0,m.applyToPoint)((0,y.inverse)(n),o),i.scale,s);this.setTargetTransform(a)}},{key:"getIsLocked",value:function(){var e,t,i;return null!=(i=null==(e=(t=this.getActiveTool()).getIsLocked)?void 0:e.call(t))&&i}},{key:"setIsFrozen",value:function(e){this.isFrozen=e}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.viewport.destroy(),this.pointerListener.destroy(),this.keyListener.destroy(),void 0!==this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.selectionRenderer.destroy(),window.removeEventListener("pointerdown",this.windowPointerListener)}}]),e}()}),s("6wbw7",function(t,i){e(t.exports,"EaselPointerPreprocessor",function(){return h});var n=o("cx0mh"),r=o("7h4XF"),s=o("bX4ja"),a=o("eWjiX"),l=o("gCzYB"),h=function(){"use strict";function e(t){(0,n._)(this,e);var i=[];t.onUndo&&(this.twoFingerTap=new a.BB.NFingerTapper({fingers:2,onTap:t.onUndo}),i.push(this.twoFingerTap)),t.onRedo&&(this.threeFingerTap=new a.BB.NFingerTapper({fingers:3,onTap:t.onRedo}),i.push(this.threeFingerTap)),this.mainDoubleTapper=new a.BB.DoubleTapper({onDoubleTap:t.onDoubleTap}),this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"]),this.middleDoubleTapper=new a.BB.DoubleTapper({onDoubleTap:t.onDoubleTap}),this.middleDoubleTapper.setAllowedButtonArr(["middle"]),this.pinchZoomer=new a.BB.PinchZoomer({onPinch:t.onPinch}),this.pointerEventChain=new(0,l.EventChain)({chainArr:(0,s._)(i).concat([this.mainDoubleTapper,this.middleDoubleTapper,this.pinchZoomer,new a.BB.OnePointerLimiter])}),this.pointerEventChain.setChainOut(t.onChainOut)}return(0,r._)(e,[{key:"chainIn",value:function(e){this.pointerEventChain.chainIn(e)}},{key:"setDoubleTapPointerTypes",value:function(e){this.mainDoubleTapper.setAllowedPointerTypeArr(e)}},{key:"destroy",value:function(){}}]),e}()}),s("7JyFK",function(t,i){e(t.exports,"DEFAULT_DOUBLE_TAP_POINTER_TYPES",function(){return r}),e(t.exports,"TEMP_TRIGGERS_KEYS",function(){return s}),e(t.exports,"TEMP_TRIGGERS",function(){return a}),e(t.exports,"EASEL_MIN_SCALE",function(){return l}),e(t.exports,"EASEL_MAX_SCALE",function(){return h});var n=o("bX4ja"),r=["touch"],s=["space","alt","r","z"],a=["mouse-middle","mouse-right"].concat((0,n._)(s)),l=1/16,h=128}),s("4GEIE",function(t,i){e(t.exports,"isTransformEqual",function(){return n});function n(e,t){var i=e.x!==t.x||e.y!==t.y,n=e.scale!==t.scale||e.angleDeg!==t.angleDeg;return!i&&!n}}),s("ftFr7",function(t,i){e(t.exports,"blendTransform",function(){return u});var n=o("cL71g"),r=o("4GEIE"),s=o("eWjiX"),a=o("lUrXo"),l=o("8G4G9"),h=o("1GsyD");o("ciAU9");var c=o("cdZRx");function u(e,t,i,o,u){if((0,r.isTransformEqual)(e,t)||(e.x===t.x||2>Math.abs(e.x-t.x))&&(e.y===t.y||2>Math.abs(e.y-t.y))&&(e.scale===t.scale||Math.abs(e.scale-t.scale)<.08*t.scale))return(0,n._)({},t);if(e.angleDeg===t.angleDeg)return{x:s.BB.mix(e.x,t.x,u),y:s.BB.mix(e.y,t.y,u),angleDeg:t.angleDeg,scale:s.BB.mix(e.scale,t.scale,u)};var p=(0,a.toMetaTransform)(e,o),d=(0,a.toMetaTransform)(t,o);if(1>s.BB.Vec2.dist(p.canvasP,d.canvasP)){var g=p.angleDeg,f=d.angleDeg-p.angleDeg;f>180&&(g+=360),f<-180&&(g-=360);var v={viewportP:o,canvasP:d.canvasP,scale:s.BB.mix(e.scale,t.scale,u),angleDeg:s.BB.mix(g,t.angleDeg,u)};return(0,l.createTransform)(v.viewportP,v.canvasP,v.scale,v.angleDeg)}var m={x:i.width/2,y:i.height/2},y=(0,h.createMatrixFromTransform)(e),x=(0,h.createMatrixFromTransform)(t),b=(0,c.applyToPoint)(y,m),w=(0,c.applyToPoint)(x,m),B={x:s.BB.mix(b.x,w.x,u),y:s.BB.mix(b.y,w.y,u)},k=s.BB.mix(e.scale,t.scale,u),S=s.BB.mix(e.angleDeg,t.angleDeg,u),C=Math.PI/180*S,E=-m.x*k,L=-m.y*k,I=E*Math.cos(C)-L*Math.sin(C),T=E*Math.sin(C)+L*Math.cos(C),A={x:B.x+I,y:B.y+T};return{x:A.x,y:A.y,scale:k,angleDeg:S}}}),s("8TwnO",function(t,i){e(t.exports,"EaselHand",function(){return h});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("eWjiX"),l=o("aKHUG"),h=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.easel={},this.doubleTapPointerTypes=["touch","mouse","pen"],this.tempTriggers=["space","mouse-middle"],this.svgEl=a.BB.createSvg({elementType:"g"}),this.inertiaScrolling=new(0,l.InertiaScrolling)({getTransform:function(){return i.easel.getTransform()},setTransform:function(e){return i.easel.setTransform(e,!0)}})}return(0,r._)(e,[{key:"getSvgElement",value:function(){return this.svgEl}},{key:"onPointer",value:function(e){if(this.easel.setCursor("grab"),"pointerdown"===e.type&&["left","middle"].includes(e.button)&&(this.inertiaScrolling.dragStart(),this.easel.setCursor("grabbing")),"pointermove"===e.type&&["left","middle"].includes(e.button)){var t=(0,s._)({},this.easel.getTransform());t.x+=e.dX,t.y+=e.dY,this.easel.setTransform(t,!0),this.easel.requestRender(),this.easel.setCursor("grabbing"),this.inertiaScrolling.dragMove(e.dX,e.dY)}"pointerup"===e.type&&void 0===e.button&&this.inertiaScrolling.dragEnd()}},{key:"setEaselInterface",value:function(e){this.easel=e}},{key:"activate",value:function(e){this.easel.setCursor("grab")}},{key:"setUseInertiaScrolling",value:function(e){this.inertiaScrolling.setIsEnabled(e)}}]),e}()}),s("aKHUG",function(t,i){e(t.exports,"InertiaScrolling",function(){return a});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=function(){"use strict";function e(t){(0,n._)(this,e),this.defaultDeltaMs=1e3/60,this.momentum={x:0,y:0},this.isDragging=!1,this.lastDragTimestamp=0,this.lastTimestamp=0,this.isEnabled=!1,this.getTransform=t.getTransform,this.setTransform=t.setTransform}return(0,r._)(e,[{key:"stop",value:function(){void 0!==this.animationFrameHandle&&(cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=void 0)}},{key:"dampen",value:function(e){var t=s.BB.Vec2.len(this.momentum);t<.3?(this.momentum.x=0,this.momentum.y=0,this.stop()):t<5?(this.momentum.x*=Math.pow(.85,e),this.momentum.y*=Math.pow(.85,e)):(this.momentum.x*=Math.pow(.95,e),this.momentum.y*=Math.pow(.95,e))}},{key:"physicsLoop",value:function(){var e=this;this.animationFrameHandle=requestAnimationFrame(function(){return e.physicsLoop()});var t=performance.now(),i=(t-this.lastTimestamp)/this.defaultDeltaMs;if(this.lastTimestamp=t,0===this.momentum.x&&0===this.momentum.y||this.isDragging)return void(this.isDragging?this.dampen(i):this.stop());var n=this.getTransform();if(this.lastTransform&&(this.lastTransform.x!==n.x||this.lastTransform.y!==n.y||this.lastTransform.x!==n.x||this.lastTransform.x!==n.x)){this.momentum.x=0,this.momentum.y=0,this.lastTransform=void 0,this.stop();return}n.x+=this.momentum.x,n.y+=this.momentum.y,this.lastTransform=n,this.dampen(i),this.setTransform(n)}},{key:"dragStart",value:function(){this.isEnabled&&(this.isDragging=!0,this.momentum.x=0,this.momentum.y=0,this.stop())}},{key:"dragMove",value:function(e,t){this.isEnabled&&(this.momentum={x:s.BB.mix(this.momentum.x,e,.6),y:s.BB.mix(this.momentum.y,t,.6)},this.lastDragTimestamp=new Date().getTime())}},{key:"dragEnd",value:function(){var e=this;this.isEnabled&&(new Date().getTime()-this.lastDragTimestamp>80?(this.momentum.x=0,this.momentum.y=0):(this.lastTimestamp=performance.now(),this.animationFrameHandle=requestAnimationFrame(function(){return e.physicsLoop()})),this.lastTransform=void 0,this.lastDragTimestamp=0,this.isDragging=!1)}},{key:"setIsEnabled",value:function(e){this.isEnabled=e}}]),e}()}),s("8AUlO",function(t,i){e(t.exports,"EaselBrush",function(){return v});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("4EWN2"),l=o("eWjiX"),h=o("1GsyD");o("ciAU9");var c=o("cdZRx"),u=o("kDVZW"),p=o("jjWRi"),d=o("gCzYB"),g=o("giULT"),f=o("buFTd"),v=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.easel={},this.oldScale=1,this.isDragging=!1,this.lastPos={x:0,y:0},this.isOver=!1,this.radius=t.radius,this.onLineStart=t.onLineStart,this.onLineGo=t.onLineGo,this.onLineEnd=t.onLineEnd,this.onLine=t.onLine,this.svgEl=l.BB.createSvg({elementType:"g"}),this.brushCursorRound=new(0,f.BrushCursorRound),this.brushCursorPixelSquare=new(0,g.BrushCursorPixelSquare),this.currentCursor=this.brushCursorRound,this.svgEl.append(this.currentCursor.getElement()),this.eventChain=new(0,d.EventChain)({chainArr:[new(0,p.CoalescedExploder)]}),this.eventChain.setChainOut(function(e){i.onExplodedPointer(e)})}return(0,r._)(e,[{key:"onExplodedPointer",value:function(e){var t,i=this.easel.getTransform(),n=(0,h.createMatrixFromTransform)(i),r=(0,c.applyToPoint)((0,u.inverse)(n),{x:e.relX,y:e.relY}),o=r.x,l=r.y;i.scale!==this.oldScale&&(this.oldScale=i.scale),!e.isCoalesced&&(this.lastPos.x=e.relX,this.lastPos.y=e.relY,this.currentCursor.update(this.easel.getTransform(),{x:e.relX,y:e.relY},this.radius),this.isOver||"pointerup"===e.type||this._onPointerEnter());var p=null!=(t=e.pressure)?t:1,d=e.isCoalesced,g=this.easel.keyListener.isPressed("shift");if(g&&!this.firstShiftPos&&(this.firstShiftPos={x:e.relX,y:e.relY}),g||(this.firstShiftPos=void 0,this.lineToolDirection=void 0),"pointerdown"===e.type&&"left"===e.button){if(g){this.lastLineEnd&&this.onLine(this.lastLineEnd,{x:o,y:l});return}this.onLineStart({x:o,y:l,pressure:p,isCoalesced:d}),this.isDragging=!0}if("pointermove"===e.type&&"left"===e.button)if(g){if(!this.lineToolDirection){var f=Math.abs(e.relX-this.firstShiftPos.x),v=Math.abs(e.relY-this.firstShiftPos.y);(f>5||v>5)&&(this.lineToolDirection=f>v?"x":"y")}if(this.lineToolDirection){var m={x:"x"===this.lineToolDirection?e.relX:this.firstShiftPos.x,y:"y"===this.lineToolDirection?e.relY:this.firstShiftPos.y},y=(0,c.applyToPoint)((0,u.inverse)(n),m);this.onLineGo((0,a._)((0,s._)({},y),{pressure:p,isCoalesced:d}))}}else this.onLineGo({x:o,y:l,pressure:p,isCoalesced:d});"pointerup"===e.type&&void 0===e.button&&this.isDragging&&(this.onLineEnd(),this.isDragging=!1,"touch"===e.pointerType&&this.onPointerLeave())}},{key:"_onPointerEnter",value:function(){clearTimeout(this.hideCursorTimeout),this.svgEl.setAttribute("opacity","1"),this.isOver=!0}},{key:"getSvgElement",value:function(){return this.svgEl}},{key:"onPointer",value:function(e){this.eventChain.chainIn(e)}},{key:"onPointerLeave",value:function(){clearTimeout(this.hideCursorTimeout),this.svgEl.setAttribute("opacity","0"),this.isOver=!1}},{key:"setEaselInterface",value:function(e){this.easel=e}},{key:"onUpdateTransform",value:function(e){this.currentCursor.update(e,{x:this.lastPos.x,y:this.lastPos.y},this.radius)}},{key:"getIsLocked",value:function(){return this.isDragging}},{key:"setBrush",value:function(e){var t=this;if(void 0!==e.radius){this.radius=e.radius,this.isOver||(this.svgEl.setAttribute("opacity","1"),clearTimeout(this.hideCursorTimeout),this.hideCursorTimeout=setTimeout(function(){t.svgEl.setAttribute("opacity","0")},500));var i=this.easel.getSize(),n=i.width,r=i.height;this.currentCursor.update(this.easel.getTransform(),this.isOver?this.lastPos:{x:n/2,y:r/2},this.radius)}if(void 0!==e.type){var o="round"===e.type?this.brushCursorRound:this.brushCursorPixelSquare;o!==this.currentCursor&&(this.currentCursor.getElement().remove(),this.currentCursor=o,this.getSvgElement().append(this.currentCursor.getElement()))}}},{key:"setLastDrawEvent",value:function(e){this.lastLineEnd=e?(0,s._)({},e):void 0}},{key:"activate",value:function(e){this.easel.setCursor("crosshair"),this.isDragging=!1,e?(this.lastPos.x=e.x,this.lastPos.y=e.y,this.currentCursor.update(this.easel.getTransform(),{x:e.x,y:e.y},this.radius)):this.onPointerLeave()}}]),e}()}),s("giULT",function(t,i){e(t.exports,"BrushCursorPixelSquare",function(){return u});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K");o("ciAU9");var l=o("cdZRx"),h=o("kDVZW"),c=o("1GsyD"),u=function(){"use strict";function e(){(0,n._)(this,e),this.rootEl=s.BB.createSvg({elementType:"g",childrenArr:[{elementType:"path",fill:"none",stroke:"rgba(255,255,255,0.7)","stroke-width":"1"},{elementType:"path",fill:"none",stroke:"rgba(0,0,0,0.7)","stroke-width":"1"}]})}return(0,r._)(e,[{key:"update",value:function(e,t,i){var n=(0,c.createMatrixFromTransform)(e),r=Math.round(2*(i=Math.round(2*i)/2)),o=(0,l.applyToPoint)((0,h.inverse)(n),t);o.x=r%2==0?Math.round(o.x):Math.floor(o.x)+.5,o.y=r%2==0?Math.round(o.y):Math.floor(o.y)+.5;var s=[[o.x-i,o.y-i],[o.x+i,o.y-i],[o.x+i,o.y+i],[o.x-i,o.y+i],[o.x-i,o.y-i]].map(function(e){return(0,l.applyToPoint)(n,e)}),u="M ";s.forEach(function(e){u+=e.join(",")+" "}),(0,a.setAttributes)(this.rootEl.children[1],{d:u});var p=1/e.scale,d=[[o.x-i+p,o.y-i+p],[o.x+i-p,o.y-i+p],[o.x+i-p,o.y+i-p],[o.x-i+p,o.y+i-p],[o.x-i+p,o.y-i+p]].map(function(e){return(0,l.applyToPoint)(n,e)}),g="M ";d.forEach(function(e){g+=e.join(",")+" "}),(0,a.setAttributes)(this.rootEl.firstChild,{d:g})}},{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("buFTd",function(t,i){e(t.exports,"BrushCursorRound",function(){return a});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=function(){"use strict";function e(){(0,n._)(this,e),this.rootEl=s.BB.createSvg({elementType:"g",childrenArr:[{elementType:"circle",cx:"0",cy:"0",fill:"none",stroke:"rgba(255,255,255,0.7)","stroke-width":"1"},{elementType:"circle",cx:"0",cy:"0",fill:"none",stroke:"rgba(0,0,0,0.7)","stroke-width":"1"}]})}return(0,r._)(e,[{key:"update",value:function(e,t,i){s.BB.setAttributes(this.rootEl.children[0],{r:""+Math.max(0,i*e.scale-1)}),s.BB.setAttributes(this.rootEl.children[1],{r:""+i*e.scale}),s.BB.setAttributes(this.rootEl,{transform:`translate(${t.x} ${t.y})`})}},{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("iXbuc",function(t,i){e(t.exports,"EaselProjectUpdater",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("7jh4K"),l=function(){"use strict";function e(t){(0,n._)(this,e),this.compositeCanvas=s.BB.canvas(1,1),this.klCanvas=t.klCanvas,this.easel=t.easel,this.update()}return(0,r._)(e,[{key:"update",value:function(){var e=this,t=this.klCanvas.getWidth(),i=this.klCanvas.getHeight();this.easel.setProject({width:t,height:i,layers:this.klCanvas.getLayersFast().map(function(n){return{image:n.compositeObj?function(){(e.compositeCanvas.width!=t||e.compositeCanvas.height!=i)&&(e.compositeCanvas.width=t,e.compositeCanvas.height=i);var r,o=e.compositeCanvas.getContext("2d");return o.clearRect(0,0,t,i),o.drawImage(n.canvas,0,0),null==(r=n.compositeObj)||r.draw((0,a.throwIfNull)(e.compositeCanvas.getContext("2d"))),e.compositeCanvas}:n.canvas,isVisible:n.isVisible,opacity:n.opacity,mixModeStr:n.mixModeStr,hasClipping:!1}}),selection:this.klCanvas.getSelection()})}},{key:"freeCompositeCanvas",value:function(){this.compositeCanvas.width=1,this.compositeCanvas.height=1}}]),e}()}),s("4tNj6",function(i,n){e(i.exports,"EaselEyedropper",function(){return p});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("anRMs"),h=o("1GsyD");o("ciAU9");var c=o("cdZRx"),u=o("kDVZW"),p=function(){"use strict";function e(t){(0,r._)(this,e),this.easel={},this.isDragging=!1,this.tempTriggers=["mouse-right","alt"],this.svgEl=a.BB.createSvg({elementType:"g"}),this.onPick=t.onPick,this.onPickEnd=t.onPickEnd,this.previewBorder=a.BB.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"22",fill:"none"}),this.previewColor=a.BB.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"20",fill:"none"}),this.svgEl.append(this.previewBorder,this.previewColor)}return(0,s._)(e,[{key:"getSvgElement",value:function(){return this.svgEl}},{key:"onPointer",value:function(e){this.easel.setCursor("url('"+t(l)+"') 0 15, crosshair");var i=this.easel.getTransform(),n=(0,h.createMatrixFromTransform)(i),r=(0,c.applyToPoint)((0,u.inverse)(n),{x:e.relX,y:e.relY}),o=void 0,s=["left","right"].includes(e.button);if(s?(this.svgEl.setAttribute("transform",`translate(${e.relX},${e.relY})`),this.svgEl.style.opacity="1"):this.svgEl.style.opacity="0","pointerdown"===e.type&&s&&(o=this.onPick(r),this.isDragging=!0,s=!0),"pointermove"===e.type&&s&&(o=this.onPick(r),s=!0),"pointerup"===e.type&&void 0===e.button&&this.isDragging&&(this.onPickEnd(),this.isDragging=!1),o&&s){this.previewColor.setAttribute("stroke",a.BB.ColorConverter.toRgbStr(o));var p=a.BB.testIsWhiteBestContrast(o)?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)";this.previewBorder.setAttribute("stroke",p)}}},{key:"setEaselInterface",value:function(e){this.easel=e}},{key:"activate",value:function(e){this.easel.setCursor("url('"+t(l)+"') 0 15, crosshair"),this.isDragging=!1,this.svgEl.style.opacity="0"}},{key:"onPointerLeave",value:function(){this.isDragging||(this.svgEl.style.opacity="0")}}]),e}()}),s("anRMs",function(e,t){e.exports=i("1dLwT")}),s("gAXzN",function(i,n){e(i.exports,"EaselPaintBucket",function(){return p});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("6uZTS"),h=o("1GsyD");o("ciAU9");var c=o("cdZRx"),u=o("kDVZW"),p=function(){"use strict";function e(t){(0,r._)(this,e),this.easel={},this.svgEl=a.BB.createSvg({elementType:"g"}),this.onFill=t.onFill}return(0,s._)(e,[{key:"getSvgElement",value:function(){return this.svgEl}},{key:"onPointer",value:function(e){this.easel.setCursor("url('"+t(l)+"') 1 12, crosshair");var i=this.easel.getTransform(),n=(0,h.createMatrixFromTransform)(i),r=(0,c.applyToPoint)((0,u.inverse)(n),{x:e.relX,y:e.relY});"pointerdown"===e.type&&"left"===e.button&&this.onFill({x:Math.floor(r.x),y:Math.floor(r.y)})}},{key:"setEaselInterface",value:function(e){this.easel=e}},{key:"activate",value:function(e){this.easel.setCursor("url('"+t(l)+"') 1 12, crosshair")}}]),e}()}),s("6uZTS",function(e,t){e.exports=i("hQSEH")}),s("9Q2gk",function(t,i){e(t.exports,"EaselGradient",function(){return c});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("1GsyD");o("ciAU9");var l=o("cdZRx"),h=o("kDVZW"),c=function(){"use strict";function e(t){(0,n._)(this,e),this.easel={},this.isDragging=!1,this.svgEl=s.BB.createSvg({elementType:"g"}),this.onDown=t.onDown,this.onMove=t.onMove,this.onUp=t.onUp}return(0,r._)(e,[{key:"getSvgElement",value:function(){return this.svgEl}},{key:"onPointer",value:function(e){this.easel.setCursor("crosshair");var t=this.easel.getTransform(),i=(0,a.createMatrixFromTransform)(t),n=(0,l.applyToPoint)((0,h.inverse)(i),{x:e.relX,y:e.relY});"pointerdown"===e.type&&"left"===e.button&&(this.onDown(n,t.angleDeg/180*Math.PI),this.isDragging=!0),"pointermove"===e.type&&"left"===e.button&&this.onMove(n),"pointerup"===e.type&&void 0===e.button&&this.isDragging&&(this.onUp(n),this.isDragging=!1)}},{key:"setEaselInterface",value:function(e){this.easel=e}},{key:"getIsLocked",value:function(){return this.isDragging}},{key:"activate",value:function(e){this.easel.setCursor("crosshair"),this.isDragging=!1}}]),e}()}),s("15tXE",function(i,n){e(i.exports,"EaselText",function(){return p});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("1bzvj"),h=o("1GsyD");o("ciAU9");var c=o("cdZRx"),u=o("kDVZW"),p=function(){"use strict";function e(t){(0,r._)(this,e),this.easel={},this.svgEl=a.BB.createSvg({elementType:"g"}),this.onDown=t.onDown}return(0,s._)(e,[{key:"getSvgElement",value:function(){return this.svgEl}},{key:"onPointer",value:function(e){this.easel.setCursor("url('"+t(l)+"') 1 12, crosshair");var i=this.easel.getTransform(),n=(0,h.createMatrixFromTransform)(i),r=(0,c.applyToPoint)((0,u.inverse)(n),{x:e.relX,y:e.relY});"pointerdown"===e.type&&"left"===e.button&&this.onDown(r,i.angleDeg/180*Math.PI)}},{key:"setEaselInterface",value:function(e){this.easel=e}},{key:"activate",value:function(e){this.easel.setCursor("url('"+t(l)+"') 1 12, crosshair")}}]),e}()}),s("1bzvj",function(e,t){e.exports=i("916ZI")}),s("2jK1Y",function(t,i){e(t.exports,"EaselShape",function(){return u});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("1GsyD");o("ciAU9");var l=o("cdZRx"),h=o("kDVZW"),c=o("bwN8r"),u=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.easel={},this.isDragging=!1,this.doPan=!1,this.svgEl=s.BB.createSvg({elementType:"g"}),this.onDown=t.onDown,this.onMove=t.onMove,this.onUp=t.onUp,this.cornerPanning=new(0,c.CornerPanning)({getEaselSize:function(){return i.easel.getSize()},getTransform:function(){return i.easel.getTargetTransform()},setTransform:function(e){return i.easel.setTransform(e,!0)},testCanPan:function(e){return e},onRepeatEvent:function(e){i.onPointer(e,!0)}})}return(0,r._)(e,[{key:"getSvgElement",value:function(){return this.svgEl}},{key:"onPointer",value:function(e,t){this.doPan&&!t&&this.cornerPanning.onPointer(e),this.easel.setCursor("crosshair");var i=this.easel.getTransform(),n=(0,a.createMatrixFromTransform)(i),r=(0,l.applyToPoint)((0,h.inverse)(n),{x:e.relX,y:e.relY});"pointerdown"===e.type&&"left"===e.button&&(this.onDown(r,i.angleDeg/180*Math.PI),this.isDragging=!0),"pointermove"===e.type&&"left"===e.button&&this.onMove(r),"pointerup"===e.type&&void 0===e.button&&this.isDragging&&(this.onUp(r),this.isDragging=!1)}},{key:"setEaselInterface",value:function(e){this.easel=e}},{key:"getIsLocked",value:function(){return this.isDragging}},{key:"activate",value:function(e){this.easel.setCursor("crosshair"),this.isDragging=!1}},{key:"setPanning",value:function(e){this.doPan=e}}]),e}()}),s("bwN8r",function(t,i){e(t.exports,"CornerPanning",function(){return s});var n=o("cx0mh"),r=o("7h4XF"),s=function(){"use strict";function e(t){(0,n._)(this,e),this.thresholdPx=25,this.lastFrameTimestamp=0,this.repeatEvent={},this.getEaselSize=t.getEaselSize,this.getTransform=t.getTransform,this.setTransform=t.setTransform,this.testCanPan=t.testCanPan,this.onRepeatEvent=t.onRepeatEvent}return(0,r._)(e,[{key:"movementLoop",value:function(){var e=this;if(!this.cornerDirection){this.animationFrameHandle&&cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=void 0,this.lastFrameTimestamp=0;return}this.animationFrameHandle=requestAnimationFrame(function(){return e.movementLoop()});var t=performance.now(),i=Math.min((t-this.lastFrameTimestamp)/(1e3/60),10);this.lastFrameTimestamp=t;var n=this.getTransform();n.x+=this.cornerDirection.x*i,n.y+=this.cornerDirection.y*i,this.setTransform(n),this.onRepeatEvent(this.repeatEvent)}},{key:"getSpeed",value:function(e){return .4*Math.min(e,this.thresholdPx)}},{key:"onPointer",value:function(e){var t=this,i=!1;this.cornerDirection={x:0,y:0},this.testCanPan(void 0!==e.button)&&"pointermove"===e.type&&(e.relX>this.getEaselSize().width-this.thresholdPx&&(this.cornerDirection.x-=this.getSpeed(e.relX-(this.getEaselSize().width-this.thresholdPx)),i=!0),e.relX<this.thresholdPx&&(this.cornerDirection.x+=this.getSpeed(this.thresholdPx-e.relX),i=!0),e.relY>this.getEaselSize().height-this.thresholdPx&&(this.cornerDirection.y-=this.getSpeed(e.relY-(this.getEaselSize().height-this.thresholdPx)),i=!0),e.relY<this.thresholdPx&&(this.cornerDirection.y+=this.getSpeed(this.thresholdPx-e.relY),i=!0)),i?(0===this.lastFrameTimestamp&&(this.lastFrameTimestamp=performance.now()),this.repeatEvent=e,this.animationFrameHandle=requestAnimationFrame(function(){return t.movementLoop()})):this.cornerDirection=void 0}}]),e}()}),s("3hiBf",function(t,i){e(t.exports,"EaselRotate",function(){return d});var n=o("cx0mh"),r=o("7h4XF"),s=o("eWjiX"),a=o("1GsyD");o("ciAU9");var l=o("cdZRx"),h=o("kDVZW"),c=o("8G4G9"),u=o("eg83P"),p=o("7jh4K"),d=function(){"use strict";function e(t){(0,n._)(this,e),this.easel={},this.downPos=void 0,this.tempTriggers=["r"],this.svgEl=s.BB.createSvg({elementType:"g"}),this.compassSize=30,this.compass=s.BB.createSvg({elementType:"g"}),(0,p.css)(this.compass,{transition:"opacity 0.25s ease-in-out"}),this.compassInner=s.BB.createSvg({elementType:"g"}),this.compassBaseCircle=s.BB.createSvg({elementType:"circle",fill:"rgba(0,0,0,0.9)",stroke:"none",cx:"0",cy:"0",r:""+this.compassSize}),this.compassLineCircle=s.BB.createSvg({elementType:"circle",fill:"none",stroke:"rgba(255,255,255,0.75)","stroke-width":"1",cx:"0",cy:"0",r:""+.9*this.compassSize}),(0,p.css)(this.compassLineCircle,{transition:"opacity 0.1s ease-in-out"}),this.needleWrapper=s.BB.createSvg({elementType:"g","transform-origin":"0 0"}),this.compassUpperTriangle=s.BB.createSvg({elementType:"path",fill:"#f00",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,-"+.9*this.compassSize+" z"}),this.compassLowerTriangle=s.BB.createSvg({elementType:"path",fill:"#fff",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,"+.9*this.compassSize+" z"}),this.needleWrapper.append(this.compassUpperTriangle,this.compassLowerTriangle),this.compassInner.append(this.compassBaseCircle,this.compassLineCircle,this.needleWrapper),this.compass.append(this.compassInner),this.svgEl.append(this.compass)}return(0,r._)(e,[{key:"getSvgElement",value:function(){return this.svgEl}},{key:"onPointer",value:function(e){if(this.easel.setCursor("left"===e.button?"grabbing":"grab"),"pointerdown"===e.type&&"left"===e.button)this.downPos={x:e.relX,y:e.relY},this.downTransform=s.BB.copyObj(this.easel.getTargetTransform());else if("left"===e.button&&this.downPos&&this.downTransform){var t=this.easel.getSize(),i={x:t.width/2,y:t.height/2},n=s.BB.Vec2.angle(i,this.downPos),r=(s.BB.Vec2.angle(i,{x:e.relX,y:e.relY})-n)/Math.PI*180,o=this.downTransform.angleDeg+r;this.easel.isKeyPressed("shift")&&(o=45*Math.round(o/45)),o=(0,u.minimizeAngleDeg)(o);var p=(0,a.createMatrixFromTransform)(this.downTransform),d=(0,l.applyToPoint)((0,h.inverse)(p),i);this.easel.setTransform((0,c.createTransform)(i,d,this.downTransform.scale,o),!this.easel.isKeyPressed("shift")),this.easel.requestRender()}else"pointerup"===e.type&&this.downPos&&(this.downPos=void 0,this.downTransform=void 0)}},{key:"onUpdateTransform",value:function(e){var t=this.easel.getTargetTransform();this.needleWrapper.setAttribute("transform","rotate("+e.angleDeg+")"),this.compassLineCircle.style.opacity=t.angleDeg%90==0?"1":"0"}},{key:"setEaselInterface",value:function(e){this.easel=e}},{key:"activate",value:function(e){this.easel.setCursor("grab");var t=this.easel.getSize(),i=t.width,n=t.height;this.compass.setAttribute("transform","translate("+i/2+", "+n/2+")"),this.onUpdateTransform(this.easel.getTransform())}},{key:"onKeyDown",value:function(e,t,i){["r+left","r+right"].includes(i)&&("left"===e&&this.easel.setAngleDeg(-15,!0),"right"===e&&this.easel.setAngleDeg(15,!0)),["r+up"].includes(i)&&this.easel.setAngleDeg(0,!1)}},{key:"onResize",value:function(e,t){this.compass.setAttribute("transform","translate("+e/2+", "+t/2+")")}}]),e}()}),s("6dnxC",function(i,n){e(i.exports,"EaselZoom",function(){return d});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("lWiYi");o("ciAU9");var h=o("cdZRx"),c=o("kDVZW"),u=o("1GsyD"),p=o("8G4G9"),d=function(){"use strict";function e(t){(0,r._)(this,e),this.easel={},this.downPos=void 0,this.tempTriggers=["z"],this.svgEl=a.BB.createSvg({elementType:"g"})}return(0,s._)(e,[{key:"getSvgElement",value:function(){return this.svgEl}},{key:"onPointer",value:function(e){if(this.easel.setCursor("url('"+t(l)+"') 7 7, zoom-in"),"pointerdown"===e.type&&["left"].includes(e.button)&&(this.downPos={x:e.relX,y:e.relY},this.downTransform=a.BB.copyObj(this.easel.getTransform())),"pointermove"===e.type&&["left"].includes(e.button)&&this.downPos&&this.downTransform){var i=this.downPos,n=(0,u.createMatrixFromTransform)(this.downTransform),r=(0,h.applyToPoint)((0,c.inverse)(n),i),o=e.relX-this.downPos.x,s=a.BB.clamp(this.downTransform.scale*Math.pow(1+1/400,o),this.easel.minScale,this.easel.maxScale);this.easel.setTransform((0,p.createTransform)(i,r,s,this.downTransform.angleDeg),!0),this.easel.requestRender()}"pointerup"===e.type&&void 0===e.button&&(this.downPos=void 0,this.downTransform=void 0)}},{key:"setEaselInterface",value:function(e){this.easel=e}},{key:"activate",value:function(e){this.easel.setCursor("url('"+t(l)+"') 7 7, zoom-in")}}]),e}()}),s("lWiYi",function(e,t){e.exports=i("9wZxU")}),s("kwvlO",function(t,i){e(t.exports,"KlAppSelect",function(){return B});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("4EWN2"),l=o("8N5YG"),h=o("3JH7a"),c=o("fSpPw"),u=o("7jh4K"),p=o("eQPGJ"),d=o("k5Z00");o("ciAU9");var g=o("83Kse"),f=o("2MaaK"),v=o("1mH1z"),m=o("eg83P"),y=o("g03EN"),x=o("cTxiX"),b=o("eWjiX"),w=o("lXpcU"),B=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.selectMode="select",this.targetLayerIndex=0,this.initialTransform={transform:(0,g.identity)(),doClone:!1,targetLayerIndex:0,backgroundIsTransparent:!1,algorithm:"smooth"},this.backgroundIsTransparent=!1,this.selectionSample=void 0,this.klCanvas=t.klCanvas,this.onUpdateProject=t.onUpdateProject,this.getCurrentLayerCtx=t.getCurrentLayerCtx,this.klHistory=t.klHistory,this.tempHistory=t.tempHistory,this.statusOverlay=t.statusOverlay,this.onFill=t.onFill,this.onErase=t.onErase,this.klHistory.addListener(function(){i.selectUi.setHasSelection(!!i.klCanvas.getSelection()),"transform"===i.selectMode&&i.updateUiLayerList()}),this.selectTool=new(0,p.SelectTool)({klCanvas:this.klCanvas}),this.transformTool=new(0,d.SelectTransformTool),this.easelSelect=new(0,c.EaselSelect)({selectMode:this.selectMode,onStartSelect:function(e,t){return i.selectTool.startSelect(e,t)},onGoSelect:function(e){i.selectTool.goSelect(e),i.easelSelect.setRenderedSelection(i.selectTool.getSelection())},onEndSelect:function(){i.selectTool.endSelect();var e=i.selectTool.getSelection();i.easelSelect.clearRenderedSelection(),i.klCanvas.setSelection(e),i.selectUi.setHasSelection(!!e)},onStartMoveSelect:function(e){i.selectTool.startMoveSelect(e)},onGoMoveSelect:function(e){i.selectTool.goMoveSelect(e),i.easelSelect.setRenderedSelection(i.selectTool.getSelection())},onEndMoveSelect:function(){if(i.selectTool.endMoveSelect(),i.selectTool.getDidMove()){var e=i.selectTool.getSelection();i.easelSelect.clearRenderedSelection(),i.klCanvas.setSelection(e),i.selectUi.setHasSelection(!!e)}},onSelectAddPoly:function(e,t){i.selectTool.addPoly(e,t);var n=i.selectTool.getSelection();i.klCanvas.setSelection(n),i.selectUi.setHasSelection(!!n)},onResetSelection:function(){return i.resetSelection()},onFreeTransform:function(e){i.transformTool.setTransform(e),i.propagateTransformationChange()}}),this.selectUi=new(0,h.SelectUi)({onChangeMode:function(e){if(i.selectMode=e,"select"===i.selectMode){i.tempHistory.clear(),i.tempHistory.setIsActive(!1);var n=(0,u.throwIfNull)(i.klCanvas.getLayerIndex(i.getCurrentLayerCtx().canvas));(i.transformTool.isTransformationChanged()||i.transformTool.getDoClone()||n!==i.targetLayerIndex)&&(i.transformTool.getDoClone()?(0,x.klCanvasTransformCloneViaSelection)({klCanvas:i.klCanvas,selectionSample:i.selectionSample,sourceLayer:n,targetLayer:i.targetLayerIndex,transformation:i.transformTool.getTransform(),isPixelated:"pixelated"===i.transformTool.getAlgorithm()}):(0,x.klCanvasTransformViaSelection)({klCanvas:i.klCanvas,sourceLayer:n,targetLayer:i.targetLayerIndex,transformation:i.transformTool.getTransform(),backgroundIsTransparent:i.backgroundIsTransparent,isPixelated:"pixelated"===i.transformTool.getAlgorithm()}),t.statusOverlay.out((0,v.LANG)("select-transform-applied"),!0)),i.selectionSample=void 0,i.transformTool.setSelectionSample(i.selectionSample),i.klCanvas.setComposite(n,void 0),i.klCanvas.setComposite(i.targetLayerIndex,void 0),i.easelSelect.clearRenderedSelection(!0);var r=i.klCanvas.getSelection();i.selectTool.setSelection(r),i.selectUi.setHasSelection(!!r),i.onUpdateProject(),i.easelSelect.setMode(i.selectMode)}else{i.tempHistory.setIsActive(!0);var o=i.selectTool.getSelection()||[];if(0===o.length){var s=b.BB.canvasBounds(i.getCurrentLayerCtx());o=[[[[s.x,s.y],[s.x+s.width,s.y],[s.x+s.width,s.height+s.y],[s.x,s.height+s.y],[s.x,s.y]]]]}i.transformTool.setSelection(o),i.transformTool.setDoClone(!1),i.transformTool.setSelectionSample(i.selectionSample);var a=i.getCurrentLayerCtx().canvas,h=(0,u.throwIfNull)(i.klCanvas.getLayerIndex(a));i.initialTransform.targetLayerIndex=h,i.initialTransform.backgroundIsTransparent=i.backgroundIsTransparent,i.initialTransform.algorithm=i.transformTool.getAlgorithm(),i.targetLayerIndex=h;var c=0===h;i.selectUi.setShowTransparentBackgroundToggle(c);var p=!1;if(c){var d=Object.entries(i.klHistory.getComposed().layerMap).find(function(e){var t=(0,l._)(e,2);return(t[0],t[1]).index===h})[1];p=(0,w.testComposedLayerHasTransparency)(d),i.selectUi.setBackgroundIsTransparent(p)}i.backgroundIsTransparent=p,i.initialTransform.backgroundIsTransparent=p,i.transformTool.setBackgroundIsTransparent(i.isSourceLayerBackgroundTransparent()),i.updateComposites(),i.selectUi.setHasSelection(!!o),i.updateUiLayerList(),i.selectUi.setMoveToLayer(void 0),i.onUpdateProject(),i.easelSelect.setMode(i.selectMode);var g=i.transformTool.getTransformedSelection();i.easelSelect.setRenderedSelection(g),i.easelSelect.initialiseTransform((0,m.integerBounds)((0,y.getMultiPolyBounds)(o))),i.updateSelectUi()}},onChangeBooleanOperation:function(e){i.easelSelect.setBooleanOperation(e)},canTransform:function(){var e=(0,u.throwIfNull)(i.klCanvas.getLayerIndex(i.getCurrentLayerCtx().canvas)),t=!!i.klCanvas.getSelectionArea(e);return t||setTimeout(function(){(0,f.showModal)({target:document.body,message:(0,v.LANG)("select-transform-empty"),type:"error"})}),t},select:{shape:this.selectTool.getShape(),onChangeShape:function(e){i.selectTool.setShape(e),i.easelSelect.setSelectShape(e)},onReset:function(){return i.resetSelection()},onAll:function(){i.selectTool.selectAll();var e=i.selectTool.getSelection();i.klCanvas.setSelection(e),i.selectUi.setHasSelection(!!e)},onInvert:function(){i.selectTool.invertSelection();var e=i.selectTool.getSelection();i.klCanvas.setSelection(e),i.selectUi.setHasSelection(!!e)}},transform:{onFlipY:function(){i.transformTool.flip("y"),i.propagateTransformationChange(),i.easelSelect.setTransform(i.transformTool.getTransform())},onFlipX:function(){i.transformTool.flip("x"),i.propagateTransformationChange(),i.easelSelect.setTransform(i.transformTool.getTransform())},onRotateDeg:function(e){i.easelSelect.rotateFreeTransform(e)},onClone:function(){i.tempHistory.clear();var e=(0,u.throwIfNull)(i.klCanvas.getLayerIndex(i.getCurrentLayerCtx().canvas));i.transformTool.getDoClone()?i.selectionSample=(0,x.klCanvasTransformCloneViaSelection)({klCanvas:i.klCanvas,selectionSample:i.selectionSample,sourceLayer:e,targetLayer:i.targetLayerIndex,transformation:i.transformTool.getTransform(),isPixelated:"pixelated"===i.transformTool.getAlgorithm()}):i.transformTool.isTransformationChanged()&&(i.selectionSample=(0,x.klCanvasTransformViaSelection)({klCanvas:i.klCanvas,sourceLayer:e,targetLayer:i.targetLayerIndex,transformation:i.transformTool.getTransform(),backgroundIsTransparent:i.backgroundIsTransparent,isPixelated:"pixelated"===i.transformTool.getAlgorithm()}));var t=i.transformTool.getTransformedSelection(),n=i.klCanvas.getSelection()||t;i.initialTransform.backgroundIsTransparent=i.backgroundIsTransparent,i.transformTool.setSelection(n),i.transformTool.setDoClone(!0),i.transformTool.setSelectionSample(i.selectionSample),i.updateComposites(),i.easelSelect.setRenderedSelection(i.transformTool.getTransformedSelection()),i.easelSelect.updateInitialTransformMatrix(),i.selectUi.setHasSelection(!!n),i.onUpdateProject(),i.statusOverlay.out((0,v.LANG)("select-transform-clone-applied"),!0)},onScale:function(e){i.transformTool.scale(e),i.propagateTransformationChange(),i.easelSelect.setTransform(i.transformTool.getTransform())},onCenter:function(){i.transformTool.center(i.klCanvas.getWidth()/2,i.klCanvas.getHeight()/2),i.propagateTransformationChange(),i.easelSelect.setTransform(i.transformTool.getTransform())},onMoveToLayer:function(e){i.resetComposites(),i.targetLayerIndex=e,i.updateComposites(),i.onUpdateProject(),i.tempHistoryReplaceTop()},onChangeTransparentBackground:function(e){i.backgroundIsTransparent=e,i.transformTool.setBackgroundIsTransparent(i.isSourceLayerBackgroundTransparent()),i.updateComposites(),i.onUpdateProject(),i.tempHistoryReplaceTop()},onChangeAlgorithm:function(e){i.transformTool.setAlgorithm(e),i.updateComposites(),i.onUpdateProject(),i.tempHistoryReplaceTop()},onChangeConstrain:function(e){i.easelSelect.setIsConstrained(e)},onChangeSnapping:function(e){i.easelSelect.setIsSnapping(e)}},onErase:function(){i.onErase()},onFill:function(){i.onFill()}}),this.klHistory.addListener(function(){var e=i.klCanvas.getSelection();"select"===i.selectMode&&i.selectTool.setSelection(e)})}return(0,r._)(e,[{key:"isSourceLayerBackgroundTransparent",value:function(){var e=this.getCurrentLayerCtx();return(0,u.throwIfNull)(this.klCanvas.getLayerIndex(e.canvas))>0||this.backgroundIsTransparent}},{key:"resetComposites",value:function(){var e=this.getCurrentLayerCtx(),t=(0,u.throwIfNull)(this.klCanvas.getLayerIndex(e.canvas));this.klCanvas.setComposite(t,void 0),this.targetLayerIndex!==t&&this.klCanvas.setComposite(this.targetLayerIndex,void 0)}},{key:"updateComposites",value:function(){var e=this.getCurrentLayerCtx().canvas,t=(0,u.throwIfNull)(this.klCanvas.getLayerIndex(e));t===this.targetLayerIndex?this.klCanvas.setComposite(t,this.transformTool.createComposite(e)):(this.klCanvas.setComposite(t,this.transformTool.createSourceComposite(e)),this.klCanvas.setComposite(this.targetLayerIndex,this.transformTool.createTargetComposite(e)))}},{key:"updateUiLayerList",value:function(){this.selectUi.setLayers(this.klCanvas.getLayers().map(function(e){return e.name}))}},{key:"resetSelection",value:function(){this.selectTool.reset();var e=this.selectTool.getSelection();this.klCanvas.setSelection(e),this.selectUi.setHasSelection(!!e)}},{key:"tempHistoryReplaceTop",value:function(){this.tempHistory.replaceTop({type:"select-transform",data:{transform:this.transformTool.getTransform(),doClone:this.transformTool.getDoClone(),targetLayerIndex:this.targetLayerIndex,backgroundIsTransparent:this.backgroundIsTransparent,algorithm:this.transformTool.getAlgorithm()}})}},{key:"propagateTransformationChange",value:function(){var e=this.transformTool.getTransformedSelection();this.easelSelect.setRenderedSelection(e),this.updateComposites(),this.onUpdateProject(),this.updateSelectUi(),this.tempHistoryReplaceTop()}},{key:"updateSelectUi",value:function(){var e=this.easelSelect.getFreeTransformTransformation();e&&this.selectUi.setFreeTransformTransformation(e)}},{key:"getSelectUi",value:function(){return this.selectUi}},{key:"getEaselSelect",value:function(){return this.easelSelect}},{key:"commitTransform",value:function(){var e=!1;return"transform"===this.selectMode&&(this.selectUi.setMode("select"),e=!0),e}},{key:"discardTransform",value:function(){if("transform"===this.selectMode){this.transformTool.reset(),this.transformTool.setDoClone(!1);var e=this.getCurrentLayerCtx().canvas;return this.targetLayerIndex=(0,u.throwIfNull)(this.klCanvas.getLayerIndex(e)),this.selectUi.setMode("select"),!0}return!1}},{key:"onHistory",value:function(e){if("undo"===e)this.selectUi.setMode("select");else if("tempUndo"===e||"tempRedo"===e){this.resetComposites();var t,i=this.tempHistory.getEntries().at(-1),n=(0,a._)((0,s._)({},this.initialTransform),{doClone:this.transformTool.getDoClone()});i&&"select-transform"===(t=i).type&&t.data&&(n=i.data),this.transformTool.setTransform(n.transform),this.transformTool.setDoClone(n.doClone),this.targetLayerIndex=n.targetLayerIndex,this.backgroundIsTransparent=n.backgroundIsTransparent,this.selectUi.setBackgroundIsTransparent(n.backgroundIsTransparent),this.transformTool.setBackgroundIsTransparent(this.isSourceLayerBackgroundTransparent()),this.selectUi.setAlgorithm(n.algorithm),this.transformTool.setAlgorithm(n.algorithm);var r=this.transformTool.getTransformedSelection();this.easelSelect.setRenderedSelection(r),this.easelSelect.setTransform(this.transformTool.getTransform()),this.selectUi.setMoveToLayer(this.klCanvas.getLayerIndex(this.getCurrentLayerCtx().canvas)===n.targetLayerIndex?void 0:n.targetLayerIndex),this.updateComposites(),this.onUpdateProject()}}},{key:"destroy",value:function(){}}]),e}()}),s("3JH7a",function(i,n){e(i.exports,"SelectUi",function(){return L});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("iFIyy"),h=o("5k3Z3"),c=o("9pP9W"),u=o("amum4"),p=o("3NhAK"),d=o("kYajN"),g=o("6pFEI"),f=o("cN45T"),v=o("1uhRN"),m=o("3WNrz"),y=o("iv68G"),x=o("9N3Nv"),b=o("lVqup"),w=o("eEL9N"),B=o("1mH1z"),k=o("7bWhB"),S=o("72Jv0"),C=o("7jh4K"),E=o("4Ukiu"),L=function(){"use strict";function e(i){var n=this;(0,r._)(this,e),this.isVisible=!0,this.hasSelection=!1,this.onChangeMode=i.onChangeMode,this.modeOptions=new(0,l.Options)({optionArr:[{id:"select",label:(0,u.c)("",[(0,u.c)({content:"<img class='dark-invert' src='"+t(h)+"' height='20'/><span>"+(0,B.LANG)("select-select")+"</span>",css:{display:"flex",gap:"5px",alignItems:"center",height:"100%",margin:"10px 4px",justifyContent:"center"}})])},{id:"transform",label:(0,u.c)("",[(0,u.c)({content:"<img class='dark-invert' src='"+t(c)+"' height='20'/><span>"+(0,B.LANG)("select-transform")+"</span>",css:{display:"flex",gap:"5px",alignItems:"center",height:"100%",margin:"10px 4px",justifyContent:"center"}})])}],initId:"select",onChange:function(e){"select"===e&&n.operationOptions.setValue("new"),n.onChangeMode(e),Y()},onBeforeChange:function(e){return"transform"!==e||i.canTransform()},optionCss:{flexGrow:"1",flexBasis:"0"},css:{marginBottom:"10px"}});var o=a.BB.el(),s=new Image;s.src=t(p),s.classList.add("dark-invert");var L=new Image;L.src=t(d),L.classList.add("dark-invert");var I=new Image;I.src=t(g),I.classList.add("dark-invert"),this.operationOptions=new(0,l.Options)({optionArr:[{id:"new",label:s,title:(0,B.LANG)("select-boolean-replace")},{id:"union",label:L,title:(0,B.LANG)("select-boolean-add")},{id:"difference",label:I,title:(0,B.LANG)("select-boolean-subtract")}],initId:"new",onChange:function(e){i.onChangeBooleanOperation(e)},css:{marginBottom:"10px"}});var T={width:"32px",height:"32px"},A=new Image;A.src=t(f),A.classList.add("dark-invert"),(0,C.css)(A,T);var M=new Image;M.src=t(v),M.classList.add("dark-invert"),(0,C.css)(M,T);var R=new Image;R.src=t(m),R.classList.add("dark-invert"),(0,C.css)(R,T);var _=new Image;_.src=t(y),_.classList.add("dark-invert"),(0,C.css)(_,T);var P=new(0,l.Options)({optionArr:[{id:"rect",label:A,title:(0,B.LANG)("shape-rect")},{id:"ellipse",label:M,title:(0,B.LANG)("shape-ellipse")},{id:"lasso",label:R,title:(0,B.LANG)("select-lasso")},{id:"poly",label:_,title:(0,B.LANG)("select-polygon")}],initId:i.select.shape,onChange:function(e){i.select.onChangeShape(e)},css:{marginBottom:"10px"}});o.append(P.getElement(),this.operationOptions.getElement());var D=a.BB.el({parent:o,css:{display:"flex",gap:"5px",flexWrap:"wrap"}});a.BB.el({parent:D,tagName:"button",content:(0,B.LANG)("select-all"),onClick:function(){i.select.onAll()},custom:{tabindex:"-1"},css:{minHeight:"30px"}}),a.BB.el({parent:D,tagName:"button",content:(0,B.LANG)("select-invert"),onClick:function(){i.select.onInvert()},custom:{tabindex:"-1"},css:{minHeight:"30px"}}),this.selectResetBtn=a.BB.el({parent:D,tagName:"button",content:[(0,S.createImage)({src:t(x),alt:"icon",height:20,css:{marginRight:"3px",filter:"invert(1)"}}),(0,B.LANG)("select-reset")],className:"kl-button kl-button-primary",css:{paddingRight:"8px",display:"none"},onClick:function(){i.select.onReset()},custom:{tabindex:"-1"}}),a.BB.el({className:"grid-hr",parent:o,css:{margin:"10px 0"}});var N=a.BB.el({parent:o,css:{display:"flex",gap:"5px"}});a.BB.el({parent:N,tagName:"button",content:(0,B.LANG)("select-erase"),onClick:function(){i.onErase()},custom:{tabindex:"-1"}}),a.BB.el({parent:N,tagName:"button",content:(0,B.LANG)("select-fill"),onClick:function(){i.onFill()},custom:{tabindex:"-1"}});var O=a.BB.el({css:{display:"flex",flexDirection:"column",gap:"10px"}});this.positionOutput=a.BB.el({}),O.append(this.positionOutput);var G=a.BB.el({tagName:"button",content:(0,B.LANG)("filter-transform-flip")+" X",className:"kl-button",onClick:function(){i.transform.onFlipX()},custom:{tabindex:"-1"}}),H=a.BB.el({tagName:"button",content:(0,B.LANG)("filter-transform-flip")+" Y",onClick:function(){i.transform.onFlipY()},custom:{tabindex:"-1"}}),z=a.BB.el({tagName:"button",content:"-90°",onClick:function(){i.transform.onRotateDeg(-90)},custom:{tabindex:"-1"}}),j=a.BB.el({tagName:"button",content:"+90°",onClick:function(){i.transform.onRotateDeg(90)},custom:{tabindex:"-1"}}),F=new(0,E.Icon)({imageUrl:t(b),width:20,height:20,darkInvert:!0}),V=a.BB.el({tagName:"button",content:[F.getElement(),(0,B.LANG)("select-transform-clone")],onClick:function(){i.transform.onClone()},css:{display:"flex",gap:"5px"},custom:{tabindex:"-1"}}),U=a.BB.el({tagName:"button",content:"2&times;",onClick:function(){i.transform.onScale(2)},custom:{tabindex:"-1"}}),W=a.BB.el({tagName:"button",content:"&frac12;&times;",onClick:function(){i.transform.onScale(.5)},custom:{tabindex:"-1"}}),X=a.BB.el({tagName:"button",content:(0,B.LANG)("center"),onClick:function(){i.transform.onCenter()},custom:{tabindex:"-1"}});a.BB.el({parent:O,content:[V,G,H,z,j,U,W,X],css:{display:"flex",flexWrap:"wrap",gap:"5px"}}),this.constrainCheckbox=new(0,k.Checkbox)({init:!0,label:(0,B.LANG)("filter-transform-constrain"),title:(0,B.LANG)("constrain-proportions"),callback:function(e){i.transform.onChangeConstrain(e)},css:{display:"inline-block"},name:"constrain-proportions"}),this.snappingCheckbox=new(0,k.Checkbox)({init:!0,label:(0,B.LANG)("filter-transform-snap"),title:(0,B.LANG)("filter-transform-snap-title"),callback:function(e){i.transform.onChangeSnapping(e)},css:{display:"inline-block",marginLeft:"10px"},name:"enable-snapping"});var K=a.BB.el();K.append(this.constrainCheckbox.getElement(),this.snappingCheckbox.getElement()),O.append(K),this.algorithmSelect=new(0,w.Select)({optionArr:[["smooth",(0,B.LANG)("algorithm-smooth")],["pixelated",(0,B.LANG)("algorithm-pixelated")]],initValue:"smooth",onChange:function(e){i.transform.onChangeAlgorithm(e)},name:"interpolation-algorithm"}),O.append((0,u.c)(",flex,items-center,gap-5,flexWrap",[(0,B.LANG)("scaling-algorithm")+":",this.algorithmSelect.getElement()])),this.moveToLayerSelect=new(0,w.Select)({optionArr:[["1","Layer 2"],["0","Layer 1"]],onChange:function(e){i.transform.onMoveToLayer(+e)},name:"move-to-layer",css:{width:"100%"}}),O.append((0,u.c)(",flex,items-center,gap-5,flexWrap",[(0,B.LANG)("select-transform-move-to-layer"),this.moveToLayerSelect.getElement()])),this.transparentBackgroundToggle=new(0,k.Checkbox)({label:(0,B.LANG)("brush-eraser-transparent-bg"),callback:function(e){i.transform.onChangeTransparentBackground(e)},name:"enable-transparent-background"}),(0,C.css)(this.transparentBackgroundToggle.getElement(),{display:"inline-block"}),O.append(this.transparentBackgroundToggle.getElement());var Y=function(){"select"===n.modeOptions.getValue()?(n.rootEl.append(o),O.remove()):(o.remove(),n.rootEl.append(O))};this.rootEl=a.BB.el({content:[this.modeOptions.getElement()],css:{margin:"10px"}}),Y()}return(0,s._)(e,[{key:"update",value:function(){this.selectResetBtn.style.display=this.hasSelection?"block":"none"}},{key:"setIsVisible",value:function(e){this.isVisible=e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.operationOptions.setValue("new")}},{key:"setMode",value:function(e){this.modeOptions.setValue(e)}},{key:"setLayers",value:function(e){this.moveToLayerSelect.setOptionArr(e.map(function(e,t){return[""+t,e]}).reverse())}},{key:"setMoveToLayer",value:function(e){this.moveToLayerSelect.setValue(void 0===e?void 0:""+e)}},{key:"setHasSelection",value:function(e){this.hasSelection=e,this.update()}},{key:"setBackgroundIsTransparent",value:function(e){this.transparentBackgroundToggle.setValue(e)}},{key:"setAlgorithm",value:function(e){this.algorithmSelect.setValue(e)}},{key:"setFreeTransformTransformation",value:function(e){var t=a.BB.round(e.x,0),i=a.BB.round(e.y,0),n=a.BB.round(e.angleDeg,0);this.positionOutput.innerText=`X: ${t}; Y: ${i}; ${(0,B.LANG)("filter-transform-rotation")}: ${n}\xb0`}},{key:"setShowTransparentBackgroundToggle",value:function(e){this.transparentBackgroundToggle.getElement().style.display=e?"block":"none"}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){}}]),e}()}),s("5k3Z3",function(e,t){e.exports=i("kiEfz")}),s("9pP9W",function(e,t){e.exports=i("4uXfZ")}),s("3NhAK",function(e,t){e.exports=i("bjhUB")}),s("kYajN",function(e,t){e.exports=i("9MYhm")}),s("6pFEI",function(e,t){e.exports=i("fsl8L")}),s("cN45T",function(e,t){e.exports=i("3QHUd")}),s("1uhRN",function(e,t){e.exports=i("5GkZe")}),s("3WNrz",function(e,t){e.exports=i("2zM6R")}),s("iv68G",function(e,t){e.exports=i("5rTlv")}),s("4Ukiu",function(t,i){e(t.exports,"Icon",function(){return l});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("eWjiX"),l=function(){"use strict";function e(t){(0,n._)(this,e),this.rootEl=a.BB.el({className:t.darkInvert?"dark-invert":"",css:(0,s._)({backgroundImage:`url("${t.imageUrl}")`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",width:t.width+"px",height:t.height+"px"},t.css)})}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("fSpPw",function(t,i){e(t.exports,"EaselSelect",function(){return S});var n=o("cx0mh"),r=o("7h4XF"),s=o("cL71g"),a=o("4EWN2"),l=o("eWjiX"),h=o("1GsyD");o("ciAU9");var c=o("dZ59l"),u=o("kr2fR"),p=o("1RMPr"),d=o("cdZRx"),g=o("kDVZW"),f=o("eg83P"),v=o("9b3eo"),m=o("gCzYB"),y=o("c1lmK"),x=o("bwN8r"),b=o("cNhNm"),w=o("k5Z00"),B={select:"default",transform:"move"},k={new:"default",union:"copy",difference:"alias"},S=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.easel={},this.viewportTransform={},this.tempCtx=l.BB.ctx(l.BB.canvas(1,1)),this.canvasSelection=[],this.selectionPath=(0,v.getSelectionPath2d)([]),this.mode="select",this.isDragging=!1,this.selectSelectMode="select",this.didSelectionMove=!1,this.defaultBooleanOperation="new",this.selectShape="rect",this.polyShape=[],this.initialTransformMatrix={},this.initialFreeTransform={},this.freeTransformIsConstrained=!0,this.freeTransformIsSnapping=!0,this.doubleTapPointerTypes=["touch"],this.blockTrigger="alt",this.mode=t.selectMode,this.onStartSelect=t.onStartSelect,this.onGoSelect=t.onGoSelect,this.onEndSelect=t.onEndSelect,this.onStartMoveSelect=t.onStartMoveSelect,this.onGoMoveSelect=t.onGoMoveSelect,this.onEndMoveSelect=t.onEndMoveSelect,this.onSelectAddPoly=t.onSelectAddPoly,this.onResetSelection=t.onResetSelection,this.onFreeTransform=t.onFreeTransform,this.cornerPanning=new(0,x.CornerPanning)({getEaselSize:function(){return i.easel.getSize()},getTransform:function(){return i.easel.getTargetTransform()},setTransform:function(e){return i.easel.setTransform(e,!0)},testCanPan:function(e){return(e||i.polyShape.length>1)&&("lasso"!==i.selectShape||"select"!==i.selectSelectMode)},onRepeatEvent:function(e){"select"===i.mode?i.selectOnPointer(e):i.transformOnPointer(e)}}),this.pointerChain=new(0,m.EventChain)({chainArr:[new(0,y.DoubleTapper)({onDoubleTap:function(e){if(!(i.polyShape.length<3)){var n=i.polyShape.map(function(e){return{x:e.x,y:e.y}});i.resetPolyShape(),n.length>1&&(n.push((0,s._)({},n[0])),t.onSelectAddPoly(n,i.appliedBooleanOperation))}},isInstant:!0})]}),this.svgEl=l.BB.createSvg({elementType:"g"}),this.htmlEl=l.BB.el()}return(0,r._)(e,[{key:"viewportToCanvas",value:function(e){var t=(0,g.inverse)((0,h.createMatrixFromTransform)(this.easel.getTransform()));return(0,d.applyToPoint)(t,e)}},{key:"updateSelectionPath",value:function(){this.selectionPath=(0,v.getSelectionPath2d)(this.canvasSelection)}},{key:"resetPolyShape",value:function(){return 0!==this.polyShape.length&&(this.polyShape=[],this.doubleTapPointerTypes=["touch"],this.easel.updateDoubleTapPointerTypes(),this.easel.requestRender(),!0)}},{key:"getEffectiveBooleanOperation",value:function(){var e="new"===this.defaultBooleanOperation?this.easel.keyListener.isPressed("alt"):"difference"===this.defaultBooleanOperation,t="new"===this.defaultBooleanOperation?this.easel.keyListener.isPressed("shift"):"union"===this.defaultBooleanOperation;return e?"difference":t?"union":"new"}},{key:"getDoMoveSelection",value:function(e,t){var i=this.polyShape.length<2&&this.selectionPath&&this.tempCtx.isPointInPath(this.selectionPath,t.x,t.y);return"new"===e&&i}},{key:"selectOnPointer",value:function(e){var t,i=this.getEffectiveBooleanOperation(),n=this.isDragging,r=this.viewportToCanvas({x:e.relX,y:e.relY}),o=this.getDoMoveSelection(i,r);if("pointerdown"===e.type&&(this.isDragging=!0,o?this.selectSelectMode="move":this.selectSelectMode="select"),"pointerup"===e.type&&(this.isDragging=!1),"move"===this.selectSelectMode)"pointerdown"===e.type&&"left"===e.button&&(this.didSelectionMove=!1,this.onStartMoveSelect(r)),"pointermove"===e.type&&"left"===e.button&&(this.didSelectionMove=!0,this.onGoMoveSelect(r)),"pointerup"===e.type&&(this.onEndMoveSelect(),this.didSelectionMove||this.onResetSelection());else if("poly"===this.selectShape){if("pointermove"===e.type&&((null==(h=this.polyShape[this.polyShape.length-1])?void 0:h.temp)&&this.polyShape.pop(),this.polyShape.push((0,a._)((0,s._)({},r),{temp:!0})),this.easel.requestRender()),"pointerup"===e.type&&n){this.polyShape.length<2&&(this.appliedBooleanOperation=i),this.doubleTapPointerTypes=[],this.easel.updateDoubleTapPointerTypes(),(null==(c=this.polyShape[this.polyShape.length-1])?void 0:c.temp)&&this.polyShape.pop();var h,c,u=this.polyShape[this.polyShape.length-1];u&&r.x===u.x&&r.y===u.y||(this.polyShape.push(r),this.easel.requestRender());var p=this.polyShape[0],d=this.polyShape[this.polyShape.length-1];if(this.polyShape.length>2&&l.BB.dist(p.x,p.y,d.x,d.y)*this.viewportTransform.scale<4){this.polyShape.pop(),this.polyShape.push((0,s._)({},this.polyShape[0]));var g=this.polyShape;this.polyShape=[],this.onSelectAddPoly(g,this.appliedBooleanOperation),this.appliedBooleanOperation=void 0}}}else"pointerdown"===e.type&&"left"===e.button&&(this.appliedBooleanOperation=i,this.onStartSelect(r,this.appliedBooleanOperation)),"pointermove"===e.type&&"left"===e.button&&this.isDragging&&this.onGoSelect(r),"pointerup"===e.type&&n&&(this.onEndSelect(),this.appliedBooleanOperation=void 0);e.button||(o?this.selectSelectMode="move":this.selectSelectMode="select"),"move"===this.selectSelectMode?this.easel.setCursor("move"):this.easel.setCursor(k[null!=(t=this.appliedBooleanOperation)?t:i])}},{key:"transformOnPointer",value:function(e){this.easel.setCursor("default")}},{key:"onPointerChainOut",value:function(e){"select"===this.mode?(this.cornerPanning.onPointer(e),this.selectOnPointer(e)):this.transformOnPointer(e)}},{key:"createFreeTransform",value:function(){var e=this,t=!0;this.freeTransform=new(0,b.FreeTransform)({x:1,y:1,width:1,height:1,angleDeg:0,isConstrained:this.freeTransformIsConstrained,snapX:[],snapY:[],viewportTransform:{scale:1,x:0,y:0,angleDeg:0},callback:function(i){if(t){t=!1;return}if(e.selection&&"select"!==e.mode&&e.selectionBounds){var n=(0,w.freeTransformToMatrix)(i,e.selectionBounds),r=(0,c.compose)(n,(0,g.inverse)(e.initialTransformMatrix));e.onFreeTransform(r)}},onWheel:this.easel.onWheel,wheelParent:this.easel.getElement()}),this.freeTransform.setSnapping(this.freeTransformIsSnapping),this.htmlEl.append(this.freeTransform.getElement()),this.freeTransform.setViewportTransform(this.viewportTransform)}},{key:"destroyFreeTransform",value:function(){var e,t;null==(e=this.freeTransform)||e.getElement().remove(),null==(t=this.freeTransform)||t.destroy(),this.freeTransform=void 0}},{key:"getSvgElement",value:function(){return this.svgEl}},{key:"getHtmlOverlayElement",value:function(){return this.htmlEl}},{key:"onPointer",value:function(e){this.onPointerChainOut(e),this.pointerChain.chainIn(e)}},{key:"setEaselInterface",value:function(e){this.easel=e,this.viewportTransform=this.easel.getTransform()}},{key:"setMode",value:function(e){this.mode=e,this.resetPolyShape(),"transform"===this.mode?this.createFreeTransform():this.destroyFreeTransform()}},{key:"onTool",value:function(e){"select"===e?this.htmlEl.style.display="block":this.htmlEl.style.display="none"}},{key:"activate",value:function(e,t){this.easel.setCursor(B[this.mode]),this.isDragging=!1,this.onUpdateTransform(this.easel.getTransform()),t||this.resetPolyShape()}},{key:"onUpdateTransform",value:function(e){var t;this.viewportTransform=e,this.updateSelectionPath(),null==(t=this.freeTransform)||t.setViewportTransform(e)}},{key:"onUpdateSelection",value:function(e){this.canvasSelection=e||[],this.updateSelectionPath()}},{key:"setRenderedSelection",value:function(e){this.selection=e,this.easel.setRenderedSelection(e)}},{key:"updateInitialTransformMatrix",value:function(){if(this.freeTransform){var e=this.freeTransform.getValue();this.initialFreeTransform=e,this.initialTransformMatrix=(0,w.freeTransformToMatrix)(e,this.selectionBounds)}}},{key:"initialiseTransform",value:function(e){this.selectionBounds={x1:0,y1:0,x2:e.x2-e.x1,y2:e.y2-e.y1};var t,i,n=(0,f.boundsToRect)(e,!1);null==(t=this.freeTransform)||t.initialise({x:n.x+n.width/2,y:n.y+n.height/2,width:n.width,height:n.height,angleDeg:0});var r=this.easel.getProjectSize(),o=r.width,s=r.height;null==(i=this.freeTransform)||i.setSnappingPoints([0,o],[0,s]),this.updateInitialTransformMatrix()}},{key:"setTransform",value:function(e){var t,i,n,r,o,s,a,l,h,g,v,m,y,x,b,w,B,k,S=(t=this.initialFreeTransform,i=t.width,n=t.height,r=(0,c.compose)((0,u.translate)(t.x,t.y),(0,p.rotate)(t.angleDeg/180*Math.PI)),o=(0,d.applyToPoint)(e,t),s=(0,d.applyToPoint)(r,{x:0,y:1}),a=(0,d.applyToPoint)(e,s),l=(0,f.pointsToAngleDeg)(o,a)-90,h=(0,d.applyToPoint)(r,{x:-i/2,y:-n/2}),g=(0,d.applyToPoint)(r,{x:i/2,y:-n/2}),v=(0,d.applyToPoint)(r,{x:-i/2,y:n/2}),m=(0,c.compose)((0,p.rotate)(-l/180*Math.PI,o.x,o.y),e),y=(0,d.applyToPoint)(m,h),x=(0,d.applyToPoint)(m,g),b=(0,d.applyToPoint)(m,v),w=x.x-y.x,B=b.y-y.y,{x:o.x,y:o.y,width:Math.round(w),height:Math.round(B),angleDeg:l});null==(k=this.freeTransform)||k.initialise(S)}},{key:"clearRenderedSelection",value:function(e){this.easel.clearRenderedSelection(e)}},{key:"setBooleanOperation",value:function(e){this.defaultBooleanOperation=e}},{key:"setSelectShape",value:function(e){this.resetPolyShape(),this.selectShape=e}},{key:"getIsLocked",value:function(){return this.isDragging}},{key:"renderAfterViewport",value:function(e,t){if(!(this.polyShape.length<2)){e.save(),e.globalCompositeOperation="difference",e.beginPath();var i=this.polyShape;e.moveTo(i[0].x,i[0].y);for(var n=1;n<i.length;n++)e.lineTo(i[n].x,i[n].y);e.lineWidth=1/t.scaleX,e.strokeStyle="white",e.lineCap="round",e.lineJoin="round",e.stroke(),e.restore()}}},{key:"onKeyDown",value:function(e,t){"esc"===e&&this.resetPolyShape()&&t.preventDefault()}},{key:"onClickOutside",value:function(){this.resetPolyShape()}},{key:"onBlur",value:function(){this.resetPolyShape()}},{key:"onArrowKeys",value:function(e){if(!this.freeTransform)return!1;var t={x:0,y:0};return"left"===e&&(t={x:-1,y:0}),"right"===e&&(t={x:1,y:0}),"up"===e&&(t={x:0,y:-1}),"down"===e&&(t={x:0,y:1}),this.easel.isKeyPressed("shift")&&(t.x*=5,t.y*=5),this.freeTransform.move(t.x,t.y),!0}},{key:"setIsConstrained",value:function(e){var t;this.freeTransformIsConstrained=e,null==(t=this.freeTransform)||t.setIsConstrained(e)}},{key:"setIsSnapping",value:function(e){var t;this.freeTransformIsSnapping=e,null==(t=this.freeTransform)||t.setSnapping(e)}},{key:"getFreeTransformTransformation",value:function(){var e;return null==(e=this.freeTransform)?void 0:e.getValue()}},{key:"rotateFreeTransform",value:function(e){if(this.freeTransform&&this.selectionBounds){var t=(this.freeTransform.getValue().angleDeg+e)%360;this.freeTransform.setAngleDeg(t);var i=(0,w.freeTransformToMatrix)(this.freeTransform.getValue(),this.selectionBounds),n=(0,c.compose)(i,(0,g.inverse)(this.initialTransformMatrix));this.onFreeTransform(n)}}}]),e}()}),s("k5Z00",function(t,i){e(t.exports,"freeTransformToMatrix",function(){return x}),e(t.exports,"SelectTransformTool",function(){return b});var n=o("cx0mh"),r=o("7h4XF"),s=o("bX4ja"),a=o("9b3eo");o("ciAU9");var l=o("dZ59l"),h=o("kr2fR"),c=o("1RMPr"),u=o("kFecW"),p=o("83Kse"),d=o("cdZRx"),g=o("bbA6w"),f=o("g03EN"),v=o("eg83P"),m=o("fzzhO"),y=o("2CwSs");function x(e,t){var i={x:t.x1+(t.x2-t.x1)/2,y:t.y1+(t.y2-t.y1)/2},n=t.x2-t.x1,r=t.y2-t.y1,o=e.width/n,s=e.height/r,a=e.angleDeg/180*Math.PI;return(0,l.compose)((0,h.translate)(e.x,e.y),(0,c.rotate)(a),(0,u.scale)(o,s),(0,h.translate)(-i.x,-i.y))}var b=function(){"use strict";function e(){(0,n._)(this,e),this.selection=[],this.selectionBounds={},this.transform={},this.doClone=!1,this.backgroundIsTransparent=!1,this.algorithm="smooth"}return(0,r._)(e,[{key:"setBackgroundIsTransparent",value:function(e){this.backgroundIsTransparent=e}},{key:"setSelection",value:function(e){this.selection=e,this.selectionBounds=(0,v.integerBounds)((0,f.getMultiPolyBounds)(this.selection)),this.transform=(0,p.identity)()}},{key:"isTransformationChanged",value:function(){for(var e=(0,p.identity)(),t=Object.keys(e),i=0;i<t.length;i++){var n=t[i];if(e[n]!==this.transform[n])return!0}return!1}},{key:"reset",value:function(){this.transform=(0,p.identity)(),this.selection=[],this.selectionBounds={x1:0,y1:0,x2:0,y2:0}}},{key:"translate",value:function(e){this.transform=(0,l.compose)((0,h.translate)(e.x,e.y),this.transform)}},{key:"center",value:function(e,t){var i={x:(this.selectionBounds.x1+this.selectionBounds.x2)/2,y:(this.selectionBounds.y1+this.selectionBounds.y2)/2},n=(0,d.applyToPoint)(this.transform,i);this.transform=(0,l.compose)((0,h.translate)(e-n.x,t-n.y),this.transform)}},{key:"flip",value:function(e){var t={x:(this.selectionBounds.x1+this.selectionBounds.x2)/2,y:(this.selectionBounds.y1+this.selectionBounds.y2)/2},i=(0,d.applyToPoint)(this.transform,t);this.transform=(0,l.compose)((0,h.translate)(i.x,i.y),(0,u.scale)("x"===e?-1:1,"y"===e?-1:1),(0,h.translate)(-i.x,-i.y),this.transform)}},{key:"scale",value:function(e){var t={x:(this.selectionBounds.x1+this.selectionBounds.x2)/2,y:(this.selectionBounds.y1+this.selectionBounds.y2)/2},i=(0,d.applyToPoint)(this.transform,t);this.transform=(0,l.compose)((0,h.translate)(i.x,i.y),(0,u.scale)(e),(0,h.translate)(-i.x,-i.y),this.transform)}},{key:"setDoClone",value:function(e){this.doClone=e}},{key:"getDoClone",value:function(){return this.doClone}},{key:"getTransform",value:function(){return this.transform}},{key:"setTransform",value:function(e){this.transform=e}},{key:"getTransformedSelection",value:function(){return(0,g.transformMultiPolygon)(this.selection,this.getTransform())}},{key:"setSelectionSample",value:function(e){this.selectionSample=e}},{key:"setAlgorithm",value:function(e){this.algorithm=e}},{key:"getAlgorithm",value:function(){return this.algorithm}},{key:"createComposite",value:function(e){var t=this,i=(0,a.getSelectionPath2d)(this.selection),n=this.getTransform();return{draw:function(r){if(r.save(),(0,y.setContextAlgorithm)(r,t.algorithm),t.selectionSample&&t.doClone){if(t.selectionSample.image){r.setTransform.apply(r,(0,s._)((0,m.matrixToTuple)(n))),r.clip(i);var o=(0,l.compose)(n,t.selectionSample.transformation);r.setTransform.apply(r,(0,s._)((0,m.matrixToTuple)(o))),r.drawImage(t.selectionSample.image,0,0)}}else t.doClone||(r.save(),r.clip(i),t.backgroundIsTransparent?r.clearRect(0,0,e.width,e.height):(r.globalCompositeOperation="source-in",r.fillStyle="#fff",r.fillRect(0,0,e.width,e.height)),r.restore()),r.setTransform.apply(r,(0,s._)((0,m.matrixToTuple)(n))),r.clip(i),r.drawImage(e,0,0);r.restore()}}}},{key:"createSourceComposite",value:function(e){var t=this,i=(0,a.getSelectionPath2d)(this.selection);if(!this.doClone)return{draw:function(n){n.save(),(0,y.setContextAlgorithm)(n,t.algorithm),n.clip(i),t.backgroundIsTransparent?n.clearRect(0,0,e.width,e.height):(n.globalCompositeOperation="source-in",n.fillStyle="#fff",n.fillRect(0,0,e.width,e.height)),n.restore()}}}},{key:"createTargetComposite",value:function(e){var t=this,i=(0,a.getSelectionPath2d)(this.selection),n=this.getTransform();return{draw:function(r){if(r.save(),(0,y.setContextAlgorithm)(r,t.algorithm),t.selectionSample&&t.doClone){if(t.selectionSample.image){r.setTransform.apply(r,(0,s._)((0,m.matrixToTuple)(n))),r.clip(i);var o=(0,l.compose)(n,t.selectionSample.transformation);r.setTransform.apply(r,(0,s._)((0,m.matrixToTuple)(o))),r.drawImage(t.selectionSample.image,0,0)}}else r.setTransform.apply(r,(0,s._)((0,m.matrixToTuple)(n))),r.clip(i),r.drawImage(e,0,0);r.restore()}}}}]),e}()}),s("2CwSs",function(t,i){e(t.exports,"setContextAlgorithm",function(){return n});function n(e,t){e.imageSmoothingEnabled="smooth"===t,"smooth"===t&&(e.imageSmoothingQuality="high")}}),s("eQPGJ",function(t,i){e(t.exports,"SelectTool",function(){return d});var n=o("cx0mh"),r=o("7h4XF"),s=o("8N5YG"),a=o("lDHUl"),l=o("1uHkt"),h=o("eWjiX"),c=o("e4nYk");function u(e){return parseFloat(e.toFixed(2))}function p(e){return e.map(function(e){return e.map(function(e){var t=(0,s._)(e,2),i=t[0],n=t[1];return[u(i),u(n)]})})}var d=function(){"use strict";function e(t){(0,n._)(this,e),this.shape="rect",this.selectOperation="new",this.selectDragInputs=[],this.didMove=!1,this.klCanvas=t.klCanvas}return(0,r._)(e,[{key:"reset",value:function(){this.selection=void 0}},{key:"combineSelection",value:function(e){var t,i=null!=(t=this.selection)?t:[];if("new"===this.selectOperation)i=[e];else if(this.selection&&this.selection.length>0){var n="difference"===this.selectOperation?"difference":"union";i=(0,c.applyPolygonClipping)(n,this.selection,e)}else"union"===this.selectOperation&&(i=[e]);return i}},{key:"getSelection",value:function(){var e=this.selection||[];if(this.selectDragInputs.length>1)if(this.selectOperation,"rect"===this.shape){var t=this.selectDragInputs[0],i=this.selectDragInputs[this.selectDragInputs.length-1],n=Math.floor(Math.min(t.x,i.x)),r=Math.floor(Math.min(t.y,i.y)),o=Math.ceil(Math.max(t.x,i.x)),s=Math.ceil(Math.max(t.y,i.y));e=this.combineSelection([[[n,r],[o,r],[o,s],[n,s]]])}else if("ellipse"===this.shape){var a=this.selectDragInputs[0],h=this.selectDragInputs[this.selectDragInputs.length-1],c=(a.x+h.x)/2,d=(a.y+h.y)/2,g=Math.abs(h.x-a.x)/2,f=Math.abs(h.y-a.y)/2;e=this.combineSelection(p((0,l.getEllipsePath)(c,d,g,f,50)))}else"lasso"===this.shape&&(e=this.combineSelection([this.selectDragInputs.map(function(e){return[u(e.x),u(e.y)]})]));return 0===e.length?void 0:e}},{key:"startSelect",value:function(e,t){this.selectOperation=t,"new"===this.selectOperation&&this.reset(),this.selectDragInputs=[e]}},{key:"goSelect",value:function(e){this.selectDragInputs.push({x:e.x,y:e.y})}},{key:"endSelect",value:function(){this.selectDragInputs.length>1?this.selection=this.getSelection():this.reset(),this.selectDragInputs=[]}},{key:"addPoly",value:function(e,t){this.selectOperation=t,this.selection=this.combineSelection([e.map(function(e){return[u(e.x),u(e.y)]})])}},{key:"startMoveSelect",value:function(e){this.moveLastPos=e,this.didMove=!1}},{key:"goMoveSelect",value:function(e){if(this.moveLastPos){this.didMove=!0;var t=Math.round(e.x-this.moveLastPos.x),i=Math.round(e.y-this.moveLastPos.y);this.selection&&(this.selection=(0,a.translateMultiPolygon)(this.selection,t,i)),this.moveLastPos={x:this.moveLastPos.x+t,y:this.moveLastPos.y+i}}}},{key:"endMoveSelect",value:function(){this.moveLastPos=void 0}},{key:"getDidMove",value:function(){return this.didMove}},{key:"selectAll",value:function(){this.reset();var e=this.klCanvas.getWidth(),t=this.klCanvas.getHeight();this.selection=[[[[0,0],[e,0],[e,t],[0,t],[0,0]]]]}},{key:"invertSelection",value:function(){var e,t=null!=(e=this.selection)?e:[],i=this.klCanvas.getWidth(),n=this.klCanvas.getHeight();this.selection=(0,c.applyPolygonClipping)("difference",[[[0,0],[i,0],[i,n],[0,n]]],t)}},{key:"setShape",value:function(e){this.shape=e}},{key:"getShape",value:function(){return this.shape}},{key:"setSelection",value:function(e){this.selection=e?h.BB.copyObj(e).map(p):void 0}}]),e}()}),s("1uHkt",function(t,i){e(t.exports,"getEllipsePath",function(){return n});function n(e,t,i,n,r){for(var o=[],s=2*Math.PI/r,a=0;a<2*Math.PI;a+=s)o.push([Math.cos(a)*i+e,Math.sin(a)*n+t]);return[o]}}),s("cTxiX",function(t,i){e(t.exports,"klCanvasTransformViaSelection",function(){return w}),e(t.exports,"klCanvasTransformCloneViaSelection",function(){return B});var n=o("cL71g"),r=o("4EWN2"),s=o("bX4ja");o("ciAU9");var a=o("83Kse"),l=o("kr2fR"),h=o("dZ59l"),c=o("6NG6k"),u=o("leY4D"),p=o("eWjiX"),d=o("6NxCO"),g=o("bbA6w"),f=o("9b3eo"),v=o("fzzhO"),m=o("2CwSs");function y(e,t){var i=t.getLayersRaw()[e],n=t.getSelectionOrFallback(),r=(0,d.getSelectionBounds)(n,i.context);if(!r)return{image:void 0,transformation:(0,a.identity)()};var o=p.BB.canvas(r.width,r.height),s=p.BB.ctx(o);return s.save(),s.translate(-r.x,-r.y),s.drawImage(i.canvas,0,0),s.restore(),{image:o,transformation:(0,l.translate)(r.x,r.y)}}function x(e,t,i){return{selection:i?(0,g.transformMultiPolygon)(i,e):void 0,selectionSample:(0,r._)((0,n._)({},t),{transformation:(0,h.compose)([e,t.transformation])})}}function b(e,t,i,n){if(i.image){var r=n.getLayersRaw()[e],o=p.BB.ctx(r.canvas),a=n.getSelectionOrFallback(),l=(0,f.getSelectionPath2d)(a);o.save(),o.clip(l),o.setTransform.apply(o,(0,s._)((0,v.matrixToTuple)(i.transformation))),(0,m.setContextAlgorithm)(o,t?"pixelated":"smooth"),o.drawImage(i.image,0,0),o.restore()}}function w(e){var t,i,n=e.klCanvas.getKlHistory(),r=e.klCanvas.getLayersRaw();n.pause(!0);var o=y(e.sourceLayer,e.klCanvas),s=(0,c.getSelectionSampleBounds)(o);e.klCanvas.eraseLayer({layerIndex:e.sourceLayer,useSelection:!0,useAlphaLock:0===e.sourceLayer&&!e.backgroundIsTransparent});var a=x(e.transformation,o,e.klCanvas.getSelection());o=a.selectionSample,e.klCanvas.setSelection(a.selection);var l=(0,c.getSelectionSampleBounds)(o);b(null!=(t=e.targetLayer)?t:e.sourceLayer,null!=(i=e.isPixelated)&&i,o,e.klCanvas),n.pause(!1);var h=!e.targetLayer||e.sourceLayer===e.targetLayer;if(!n.isPaused()){var d=r[e.sourceLayer],g=void 0!==e.targetLayer&&e.targetLayer!==e.sourceLayer?r[e.targetLayer]:void 0;n.push({selection:{value:e.klCanvas.getSelection()},layerMap:(0,u.createLayerMap)(r,{layerId:d.id,attributes:["tiles"],bounds:h?p.BB.updateBounds(s,l):s},g?{layerId:g.id,attributes:["tiles"],bounds:l}:void 0)})}return o}function B(e){var t,i=e.klCanvas.getKlHistory(),n=e.klCanvas.getLayersRaw(),r=e.selectionSample;if(i.pause(!0),!r){if(void 0===e.sourceLayer)throw Error("no source layer");r=y(e.sourceLayer,e.klCanvas)}var o=x(e.transformation,r,e.klCanvas.getSelection());r=o.selectionSample,e.klCanvas.setSelection(o.selection),b(e.targetLayer,null!=(t=e.isPixelated)&&t,r,e.klCanvas);var s=(0,c.getSelectionSampleBounds)(r);if(i.pause(!1),!i.isPaused()&&s){var a=n[e.targetLayer];i.push({selection:{value:e.klCanvas.getSelection()},layerMap:(0,u.createLayerMap)(n,{layerId:a.id,attributes:["tiles"],bounds:s})})}return r}}),s("6NG6k",function(t,i){e(t.exports,"getSelectionSampleBounds",function(){return s});var n=o("8Cx6U"),r=o("eg83P");function s(e){if(e.image)return(0,r.integerBounds)((0,n.transformBounds)({x1:0,y1:0,x2:e.image.width,y2:e.image.height},e.transformation))}}),s("age0w",function(t,i){e(t.exports,"KlTempHistory",function(){return s});var n=o("cx0mh"),r=o("7h4XF"),s=function(){"use strict";function e(){(0,n._)(this,e),this.entries=[],this.currentIndex=-1,this.listeners=[],this.isActive=!1}return(0,r._)(e,[{key:"emit",value:function(e){this.listeners.forEach(function(t){return t(e)})}},{key:"push",value:function(e){var t=this;this.currentIndex<this.entries.length-1&&this.entries.splice(this.currentIndex+1),this.entries.push(e),this.currentIndex=this.entries.length-1,setTimeout(function(){return t.emit("push")})}},{key:"replaceTop",value:function(e){var t=this;this.entries.splice(this.currentIndex),this.entries.push(e),this.currentIndex=this.entries.length-1,setTimeout(function(){return t.emit("push")})}},{key:"canDecreaseIndex",value:function(){return this.currentIndex>-1}},{key:"canIncreaseIndex",value:function(){return this.currentIndex<this.entries.length-1}},{key:"decreaseIndex",value:function(){var e=this;this.canDecreaseIndex()&&(this.currentIndex--,setTimeout(function(){return e.emit("decrease")}))}},{key:"increaseIndex",value:function(){var e=this;this.canIncreaseIndex()&&(this.currentIndex++,setTimeout(function(){return e.emit("increase")}))}},{key:"getEntries",value:function(){return this.entries.slice(0,this.currentIndex+1)}},{key:"clear",value:function(){var e=this;this.entries=[],this.currentIndex=-1,setTimeout(function(){return e.emit("clear")})}},{key:"addListener",value:function(e){this.listeners.includes(e)||this.listeners.push(e)}},{key:"removeListener",value:function(e){var t=this;this.listeners.map(function(i,n){i===e&&t.listeners.splice(n,1)})}},{key:"setIsActive",value:function(e){this.isActive!==e&&(this.isActive=e,this.emit("active"))}},{key:"getIsActive",value:function(){return this.isActive}}]),e}()}),s("bB2ML",function(t,i){e(t.exports,"PinchZoomWatcher",function(){return l});var n=o("cx0mh"),r=o("eWjiX"),s=o("1mH1z"),a=o("7jh4K"),l=function e(){"use strict";(0,n._)(this,e);var t=function(){if(!o){var e=r.BB.el({parent:document.body,css:{position:"fixed",inset:"0",zIndex:"-1"}}),t=e.getBoundingClientRect();e.remove();var n=(i.width!==Math.round(t.width)||i.height!==Math.round(t.height))&&i.scale>1;n?((0,a.css)(l,{left:i.offsetLeft+"px",top:i.offsetTop+"px",width:i.width+"px",height:i.height+"px"}),c||(document.body.append(h),document.body.append(l))):c&&(h.remove(),l.remove()),c=n}};if("visualViewport"in window&&null!==visualViewport){var i=visualViewport,o=!1,l=r.BB.el({content:(0,s.LANG)("browser-zoom-help"),className:"kl-pinch-overlay",css:{position:"fixed",pointerEvents:"none",display:"flex",justifyContent:"center",alignItems:"center",zIndex:"100",flexDirection:"column",gap:"10px",padding:"10px",backdropFilter:"blur(3px)"}});r.BB.el({parent:l,tagName:"button",content:(0,s.LANG)("dismiss"),onClick:function(){o=!0,h.remove(),l.remove()},css:{pointerEvents:"initial"}});var h=r.BB.el({tagName:"iframe",css:{position:"fixed",width:"100vw",height:"100vh",zIndex:"99",opacity:"0"}}),c=!1;i.addEventListener("resize",t),i.addEventListener("scroll",t),setTimeout(t)}}}),s("c3rQS",function(t,i){e(t.exports,"KlHistoryExecutor",function(){return s});var n=o("cx0mh"),r=o("7h4XF"),s=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.doIgnore=!1,this.lastCanUndo=!1,this.lastCanRedo=!1,this.klHistory=t.klHistory,this.tempHistory=t.tempHistory,this.onCanUndoRedoChange=t.onCanUndoRedoChange;var r=function(){var e=i.canUndo(),t=i.canRedo();(i.lastCanUndo!==e||i.lastCanRedo!==t)&&(i.lastCanUndo=e,i.lastCanRedo=t,i.onCanUndoRedoChange(e,t))};this.klHistory.addListener(r),this.tempHistory.addListener(r)}return(0,r._)(e,[{key:"testShouldSkip",value:function(){var e=this;return!!this.doIgnore||(this.doIgnore=!0,setTimeout(function(){e.doIgnore=!1},0),!1)}},{key:"canUndo",value:function(){return this.tempHistory.getIsActive()&&this.tempHistory.canDecreaseIndex()||this.klHistory.canUndo()}},{key:"canRedo",value:function(){return this.tempHistory.getIsActive()?this.tempHistory.canIncreaseIndex():this.klHistory.canRedo()}},{key:"undo",value:function(){return this.testShouldSkip()?void 0:this.tempHistory.getIsActive()&&this.tempHistory.canDecreaseIndex()?(this.tempHistory.decreaseIndex(),{type:"tempUndo"}):this.klHistory.canUndo()?(this.klHistory.decreaseIndex(),{type:"undo"}):void 0}},{key:"redo",value:function(){return this.testShouldSkip()?void 0:this.tempHistory.getIsActive()&&this.tempHistory.canIncreaseIndex()?(this.tempHistory.increaseIndex(),{type:"tempRedo"}):this.klHistory.canRedo()?(this.klHistory.increaseIndex(),{type:"redo"}):void 0}}]),e}()}),s("kuhHU",function(t,i){e(t.exports,"isHistoryEntryActiveLayerChange",function(){return n});function n(e){var t=Object.keys(e);return 1===t.length&&"activeLayerId"===t[0]}}),s("92HSb",function(t,i){e(t.exports,"MobileUi",function(){return u});var n=o("cx0mh"),r=o("7h4XF"),s=o("bX4ja"),a=o("eWjiX"),l=o("hrnUX"),h=o("6l0gQ"),c=o("7jh4K"),u=function(){"use strict";function e(t){var i,r=this;(0,n._)(this,e),this.toolspaceIsOpen=!0,this.orientation="right",this.isVisible=!1,this.onShowToolspace=t.onShowToolspace,this.toolspaceCollapser=new l.KL.ToolspaceCollapser({onChange:function(){r.toolspaceIsOpen=r.toolspaceCollapser.isOpen(),r.onShowToolspace(r.toolspaceIsOpen),r.toolspaceIsOpen?h.LocalStorage.removeItem("uiShowMobile"):h.LocalStorage.setItem("uiShowMobile","true")}}),this.mobileWrapperEl=a.BB.el({css:{marginTop:"4px",display:"flex",flexDirection:"column",gap:"4px"}}),(i=this.mobileWrapperEl).append.apply(i,(0,s._)(t.toolUis)),this.rootEl=a.BB.el({css:{position:"absolute",top:"0",userSelect:"none"}}),this.rootEl.append(this.toolspaceCollapser.getElement(),this.mobileWrapperEl),this.update()}return(0,r._)(e,[{key:"update",value:function(){this.isVisible?(this.toolspaceIsOpen?(this.mobileWrapperEl.style.display="none","left"===this.orientation?(0,c.css)(this.rootEl,{left:"271px",right:""}):(0,c.css)(this.rootEl,{left:"",right:"271px"})):(this.mobileWrapperEl.style.display="flex","left"===this.orientation?(0,c.css)(this.rootEl,{left:"0",right:""}):(0,c.css)(this.rootEl,{left:"",right:"0"})),this.rootEl.style.display="block"):this.rootEl.style.display="none"}},{key:"setOrientation",value:function(e){this.orientation=e,this.toolspaceCollapser.setOrientation(e)}},{key:"setIsVisible",value:function(e){this.isVisible=e}},{key:"getToolspaceIsOpen",value:function(){return this.toolspaceIsOpen}},{key:"setToolspaceIsOpen",value:function(e){this.toolspaceIsOpen=e,this.toolspaceCollapser.setIsOpen(e),this.onShowToolspace(e)}},{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("iYSxo",function(i,n){e(i.exports,"MobileBrushUi",function(){return d});var r=o("cx0mh"),s=o("7h4XF"),a=o("eWjiX"),l=o("iFIyy"),h=o("1mH1z"),c=o("249G2"),u=o("a0L4S"),p=o("4Ukiu"),d=function(){"use strict";function e(i){(0,r._)(this,e);var n=new(0,p.Icon)({imageUrl:t(c),width:28,height:28,darkInvert:!0,css:{margin:"4px"}}),o=new(0,p.Icon)({imageUrl:t(u),width:28,height:28,darkInvert:!0,css:{margin:"4px"}});this.brushOptions=new(0,l.Options)({optionArr:[{id:"brush",label:n.getElement(),title:(0,h.LANG)("tool-brush")},{id:"eraser",label:o.getElement(),title:(0,h.LANG)("eraser")}],initId:"brush",onChange:function(e){"brush"===e?i.onBrush():i.onEraser()},isColumn:!0}),this.rootEl=a.BB.el({css:{}}),this.rootEl.append(this.brushOptions.getElement())}return(0,s._)(e,[{key:"setIsVisible",value:function(e){this.rootEl.style.display=e?"block":"none"}},{key:"setType",value:function(e){this.brushOptions.setValue(e,!0)}},{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("dFQnh",function(t,i){e(t.exports,"projectToComposed",function(){return h});var n=o("bX4ja"),r=o("esGm2"),s=o("4sWjZ"),a=o("dMsoA"),l=o("eWjiX");function h(e){var t="",i=Object.fromEntries(e.layers.map(function(i,o){t=(0,a.getNextLayerId)();var h,c=[];if(i.image instanceof Array)c=(0,n._)(i.image);else{var u=function(){if(i.image instanceof HTMLCanvasElement)return i.image;var t=l.BB.canvas(e.width,e.height),n=l.BB.ctx(t);return(0,r.isLayerFill)(i.image)?(n.fillStyle=i.image.fill,n.fillRect(0,0,e.width,e.height)):n.drawImage(i.image,0,0),t}();c=(0,s.canvasToLayerTiles)(u)}return[t,{name:i.name,opacity:i.opacity,isVisible:i.isVisible,mixModeStr:null!=(h=i.mixModeStr)?h:"source-over",index:o,tiles:c}]}));return{projectId:{value:e.projectId},size:{width:e.width,height:e.height},selection:{},activeLayerId:t,layerMap:i}}}),s("49CPm",function(t,i){e(t.exports,"UnloadWarningTrigger",function(){return s});var n=o("cx0mh"),r=o("7h4XF"),s=function(){"use strict";function e(t){var i=this;(0,n._)(this,e),this.onBeforeUnload=function(e){e.preventDefault(),e.returnValue=""},this.klHistory=t.klHistory,this.getLastSavedHistoryIndex=t.getLastSavedHistoryIndex,t.klHistory.addListener(function(){return i.update()})}return(0,r._)(e,[{key:"update",value:function(){var e=this.klHistory.getTotalIndex();this.getLastSavedHistoryIndex()!==e?window.addEventListener("beforeunload",this.onBeforeUnload):window.removeEventListener("beforeunload",this.onBeforeUnload)}},{key:"destroy",value:function(){}}]),e}()}),s("eM5pt",function(i,n){e(i.exports,"runBrowserStorageBanner",function(){return d});var r=o("1LaJZ"),s=o("2gUX3"),a=o("eWjiX"),l=o("f9p4C"),h=o("1mH1z"),c=o("7jh4K"),u=o("3uJxV"),p=o("jvBcx");function d(e){return(0,r._)(function(){var i,n,r,o,d,g,f,v,m,y,x,b,w,B,k,S,C,E;function L(){clearTimeout(C),document.removeEventListener("pointerdown",E),(0,c.css)(S,{opacity:"0"}),(0,c.css)(k,{pointerEvents:"none"}),setTimeout(function(){S.remove()},200)}return(0,s.__generator)(this,function(s){switch(s.label){case 0:if(!e.projectStore)return[2];return n=[],(r=new(0,u.CrossTabChannel)("kl-tab-communication")).subscribe(function(t){"request-project-ids"===t.type&&r.postMessage({type:"response-project-id",id:e.klHistory.getComposed().projectId.value})}),o=function(e){"response-project-id"===e.type&&n.push(e.id)},r.subscribe(o),r.postMessage({type:"request-project-ids"}),[4,(0,c.sleep)(100)];case 1:if(s.sent(),r.unsubscribe(o),(null==(i=e.klRecoveryManager)?void 0:i.getTabId())!==void 0)return[2];return[4,e.projectStore.readMeta()];case 2:if(!(d=s.sent())||n.includes(d.projectId))return[2];return g=(0,c.fitInto)(d.thumbnail.width,d.thumbnail.height,100,100),(0,c.css)(d.thumbnail,{width:g.width+"px",height:g.height+"px"}),(f=a.BB.el({tagName:"button",className:l.closeButton+" popup-x",content:`<img alt="${(0,h.LANG)("modal-close")}" height="20" src="${t(p)}">`,title:(0,h.LANG)("modal-close"),custom:{tabindex:"0"}})).onclick=L,(v=a.BB.el({className:l.preview,content:d.thumbnail,title:(0,h.LANG)("file-storage-open")})).onclick=function(){L(),e.onOpenBrowserStorage()},m=a.BB.el({content:(0,h.LANG)("file-storage")}),y=l.btn,(x=a.BB.el({tagName:"button",className:["kl-button-primary",y].join(" "),content:(0,h.LANG)("file-storage-open"),custom:{tabIndex:"-1"}})).onclick=function(){L(),e.onOpenBrowserStorage()},b=a.BB.el({className:l.rightCol,content:[m,x]}),w=a.BB.el({className:l.mainContent,content:[v,b]}),(B=a.BB.el({className:l.closeArea})).onclick=L,(k=a.BB.el({className:l.banner,content:[B,w,f]})).onclick=a.BB.handleClick,S=a.BB.el({content:[k],className:l.root}),document.body.append(S),C=setTimeout(L,4500),E=function(e){var t=e.target;k.contains(t)||k.contains(t)||L()},document.addEventListener("pointerdown",E,{passive:!1}),[2]}})})()}}),s("f9p4C",function(t,i){var n,r,o,s,a,l,h,c,u;e(t.exports,"banner",function(){return n},function(e){return n=e}),e(t.exports,"btn",function(){return r},function(e){return r=e}),e(t.exports,"closeArea",function(){return o},function(e){return o=e}),e(t.exports,"closeButton",function(){return s},function(e){return s=e}),e(t.exports,"mainContent",function(){return a},function(e){return a=e}),e(t.exports,"preview",function(){return l},function(e){return l=e}),e(t.exports,"rightCol",function(){return h},function(e){return h=e}),e(t.exports,"root",function(){return c},function(e){return c=e}),e(t.exports,"rootAnim",function(){return u},function(e){return u=e}),n="RP219q_banner",r="RP219q_btn",o="RP219q_closeArea",s="RP219q_closeButton",a="RP219q_mainContent",l="RP219q_preview",h="RP219q_rightCol",c="RP219q_root",u="RP219q_rootAnim"}),s("cFF2R",function(i,n){e(i.exports,"MobileColorUi",function(){return f});var r=o("cx0mh"),s=o("7h4XF"),a=o("cL71g"),l=o("eWjiX"),h=o("1mH1z"),c=o("h37GB"),u=o("cmnov"),p=o("4Ukiu"),d=o("8B0nk"),g=o("gmji4"),f=function(){"use strict";function e(i){var n=this;(0,r._)(this,e),this.colorPickerPosition={x:100,y:100},this.color={r:0,g:0,b:0},this.color=(0,a._)({},i.color),this.colorCircle=l.BB.el({css:{width:"30px",height:"30px",background:l.BB.ColorConverter.toRgbStr(i.color),borderRadius:"100%",boxShadow:"0 0 0 1px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.5)",alignSelf:"center",cursor:"pointer"},noRef:!0,onClick:function(){if(n.colorPicker)return void n.closeColorPicker();n.colorPicker=new(0,g.KlColorSliderSmall)({width:200,heightSV:200,heightH:30,color:n.color,callback:i.onColorChange}),n.colorWindow=new(0,d.MobileFloatingWindow)({content:l.BB.el({content:n.colorPicker.getElement()}),onClose:function(){n.closeColorPicker()},position:n.colorPickerPosition}),document.body.append(n.colorWindow.getElement())}});var o=new(0,p.Icon)({imageUrl:t(c),width:1,height:1,css:{width:"100%",height:"100%"},darkInvert:!0});this.eyedropperToggle=new(0,u.BoxToggle)({init:!1,title:(0,h.LANG)("eyedropper"),onChange:function(e){i.onEyedropper(e)},label:l.BB.el({content:o.getElement(),css:{padding:"6px",height:"36px"}})}),this.rootEl=l.BB.el({css:{display:"flex",flexDirection:"column",gap:"4px"}}),this.rootEl.append(this.colorCircle,this.eyedropperToggle.getElement())}return(0,s._)(e,[{key:"getIsEyedropping",value:function(){return this.eyedropperToggle.getValue()}},{key:"setIsEyedropping",value:function(e){this.eyedropperToggle.setValue(e)}},{key:"setColor",value:function(e){var t;this.color=(0,a._)({},e),this.colorCircle.style.backgroundColor=l.BB.ColorConverter.toRgbStr(e),null==(t=this.colorPicker)||t.setColor(e)}},{key:"closeColorPicker",value:function(){var e,t,i;this.colorWindow&&(this.colorPickerPosition=this.colorWindow.getPosition(),null==(t=this.colorWindow)||t.destroy(),null==(i=this.colorWindow)||i.getElement().remove(),this.colorWindow=void 0),null==(e=this.colorPicker)||e.destroy(),this.colorPicker=void 0}},{key:"setIsVisible",value:function(e){this.rootEl.style.display=e?"flex":"none",e||this.closeColorPicker()}},{key:"getElement",value:function(){return this.rootEl}}]),e}()}),s("8B0nk",function(i,n){e(i.exports,"MobileFloatingWindow",function(){return d});var r=o("cx0mh"),s=o("7h4XF"),a=o("cL71g"),l=o("eWjiX"),h=o("eg83P"),c=o("1mH1z"),u=o("jvBcx"),p=o("7jh4K"),d=function(){"use strict";function e(i){var n=this;(0,r._)(this,e),this.position=(0,a._)({},i.position),this.xButton=l.BB.el({tagName:"button",className:"popup-x",content:`<img alt="${(0,c.LANG)("modal-close")}" height="20" src="${t(u)}">`,title:(0,c.LANG)("modal-close"),noRef:!0,onClick:function(){i.onClose()},css:{width:"32px",height:"32px",lineHeight:"32px",background:"none",boxShadow:"none"},custom:{tabindex:"0"}});var o=l.BB.el({className:"kl-floating-window-header"});o.append(this.xButton);var s=l.BB.el({content:i.content}),h={x:0,y:0};this.pointerListener=new l.BB.PointerListener({target:o,onPointer:function(e){e.eventPreventDefault(),"left"===e.button&&"pointerdown"===e.type&&(h=(0,a._)({},n.position)),"left"===e.button&&"pointermove"===e.type&&(n.position.x=h.x+e.pageX-e.downPageX,n.position.y=h.y+e.pageY-e.downPageY,n.applyPosition())}}),this.rootEl=l.BB.el({css:{position:"fixed",display:"flex",flexDirection:"column",left:this.position.x+"px",top:this.position.y+"px"}}),this.rootEl.append(o,s),setTimeout(function(){return n.applyPosition()})}return(0,s._)(e,[{key:"applyPosition",value:function(){var e=this.rootEl.getBoundingClientRect();this.position.x=(0,h.clamp)(this.position.x,0,window.innerWidth-e.width),this.position.y=(0,h.clamp)(this.position.y,0,window.innerHeight-e.height),(0,p.css)(this.rootEl,{left:this.position.x+"px",top:this.position.y+"px"})}},{key:"getElement",value:function(){return this.rootEl}},{key:"getPosition",value:function(){return(0,a._)({},this.position)}},{key:"destroy",value:function(){this.pointerListener.destroy()}}]),e}()})}();
//# sourceMappingURL=main-embed.d35806a2.js.map
